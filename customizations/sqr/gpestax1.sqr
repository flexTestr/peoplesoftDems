!***********************************************************************
!  GPESTAX1.SQR  Tax Deduction Report                                  *
!***********************************************************************
!----------------------------------------------------------------------
!                                                                      *
!                                                                      *
!                                                                      *
!                                                                      *
! This software and related documentation are provided under a         *
! license agreement containing restrictions on use and                 *
! disclosure and are protected by intellectual property                *
! laws. Except as expressly permitted in your license agreement        *
! or allowed by law, you may not use, copy, reproduce,                 *
! translate, broadcast, modify, license, transmit, distribute,         *
! exhibit, perform, publish or display any part, in any form or        *
! by any means. Reverse engineering, disassembly, or                   *
! decompilation of this software, unless required by law for           *
! interoperability, is prohibited.                                     *
! The information contained herein is subject to change without        *
! notice and is not warranted to be error-free. If you find any        *
! errors, please report them to us in writing.                         *
!                                                                      *
!                                                                      *
! Copyright (C) 1988, 2020, Oracle and/or its affiliates.              *
! All Rights Reserved.                                                 *
!-----------------------------------------------------------------------
!                                                                      *
!       $Release:  HR92                                                *
!           $Bug:  31025069                                            *
!                                                                      *
!***********************************************************************

#include 'setenv.sqc'    !Set environment

!************************************************************************
!  Report Setup
!************************************************************************
begin-setup
!#include 'ptset01.sqc'
!***********************************************************************
!  PTSET01:  Printer and Page-Size Initialization (Portrait)           *
!     Orientation: Portrait                                           *
!     Max Columns: 125                                                *
!     Max Lines:   79                                                 *
!***********************************************************************
! SourceSafe Information:                                              *
!                                                                      *
! $Header:: /PT81/SQR/ptset01.sqc 4     7/26/00 5:10p Jmacnaug        $*
!                                                                      *
!***********************************************************************
#include 'setupdb.sqc'               !Database specific setup

#define PTSETxx-Included

declare-printer DEFAULT-HP
!#ifdef PRINT_JAPANESE
!     init-string=<27>&t31P
!     font=28825
!     symbol-set=19K
!#endif

    point-size=7.2           !Original setting at ptset01.sqc 7.2
    pitch=17                 !Original setting at ptset01.sqc 17
end-declare

declare-printer DEFAULT-PD
    point-size=7.2
    pitch=17
end-declare

#ifndef EBCDIC
declare-printer DEFAULT-LP
!#ifdef PRINT_JAPANESE
!   init-string=<27>E<27>(19K<27>&l0O<27>&l6C<27>&l0E<27>&I95F<27>(s16.66H<27>&k2G<27>&t31P<27>(s0p7.25v0s0b28825T
!!
!!    <27>(19K : Command to print out single-byte Katakana
!!    <27>&t31P : 2byte mode
!!    <27>(s0p7.25v0s0b28825T : Kanji font
!!
!#else
    init-string=<27>E<27>(0N<27>&l0O<27>&l6C<27>&l0E<27>&l95F<27>(s16.66H<27>&k2G
!               |    |      |       |       |       |        |           |
!               |    |      |       |       |       |        |            --> CR
!               |    |      |       |       |       |         --> Line Prntr font
!               |    |      |       |       |        --> Number of Lines
!               |    |      |       |        --> Top Margin
!               |    |      |        --> Vertical Motion Index (1/48" increments)
!               |    |       --> Portrait orientation
!               |     --> ISO 8859-1 symbol set
!                --> Reset
!#endif
    before-bold=<27>(s3B
    after-bold=<27>(s0B
end-declare

#else

declare-printer DEFAULT-LP
end-declare
#endif

declare-printer DEFAULT-PS
    point-size=7.2
!
! add STARTUP-FILE=dir\filename to change the symbol set
!
end-declare


#define PAGE_ORIENTATION PORTRAIT


#Define ColR 129 !Column # referenced by Standard Headings. Original value: 108

! Define Parameters
#define PAPER_SIZE  'LETTER'
#if {PAPER_SIZE} = 'LETTER'
    #define PAGE_PAPER_SIZE (LETTER)
    #define LINE_HEIGHT 6.75
    #define CHAR_WIDTH  4.32

#End-if

#if {PAPER_SIZE} = 'A4'

    #define PAGE_PAPER_SIZE (A4)
    #define LINE_HEIGHT 7         !Original setting at ptset01.sqc: 9
    #define CHAR_WIDTH  4.30       !Original setting at ptset01.sqc: 4.32

#endif

declare-layout DEFAULT
    paper-size={PAGE_PAPER_SIZE}
    orientation={PAGE_ORIENTATION}
    line-height={LINE_HEIGHT}              ! 72/printer_point-size
    char-width={CHAR_WIDTH}                ! points, to handle max cols
    left-margin= .000001
    top-margin=.4
    bottom-margin= .000001
end-declare

declare-report DEFAULT
    layout=DEFAULT
    printer-type=HP
end-declare

!** Allow for 23.3 big decimals
!** To turn on: add "#define DECIMAL26" to your code before calling this sqc.
#ifdef DECIMAL26
    declare-variable
        Default-Numeric=DECIMAL(26)
    end-declare
#end-if

#define RETRO_ARRAY_SIZE   7
create-array Name=Arr_Year Size={RETRO_ARRAY_SIZE}
        field=Arr_Year1:char
create-array Name=Arr_WithHolding Size={RETRO_ARRAY_SIZE}
        field=Arr_WithHolding1:decimal
create-array Name=Arr_Amount Size={RETRO_ARRAY_SIZE}
        field=Arr_Amount1:decimal
create-array Name=Arr_Soc_Security Size={RETRO_ARRAY_SIZE}
        field=Arr_Soc_Security1:decimal
create-array Name=Arr_Reduction Size={RETRO_ARRAY_SIZE}
        field=Arr_Reduction1:decimal

end-setup


#include 'sqrtrans.sqc'


!************************************************************************
! Report Section
!************************************************************************
begin-report
#debug do Fin-Debug-Msg('begin-report')

  do Init-Report
  do Process-Main
  do Stdapi-Term

end-report


!************************************************************************
! Procedure Init-Report
!************************************************************************
begin-procedure Init-Report
#debug do Fin-Debug-Msg('init-report')

  move 'GPESTAX1' to $ReportID
  move 'Certificado de Habers' to $ReportTitle

 !Better to change setenv.sqc to acomplish this.
 !alter-locale
 !  thousand-separator = '.'
 !  decimal-separator  = ','
 !Better to change setenv.sqc to acomplish this.

  do Init-DateTime
  do Init-Number
  do Get-Current-DateTime

  do Stdapi-Init

end-procedure


!************************************************************************
! Procedure Main
!************************************************************************
begin-procedure Process-Main
#debug do Fin-Debug-Msg('Process-Main')

  #debugd show 'Operator Id:     ' $prcs_oprid
  #debugd show 'Run Control Id:  ' $prcs_run_cntl_id

  let $Company = ''
  let $Fiscal-Year = ''
  let $Tax-Location = ''
  let $Sign-City = ''
  let $PayeeOptn = ''
  let $Signature-Dt = ''
  let $Empl-Info = ''

let $sql-statement = 'GPESTAX1.SQR,Process-Main,Select,PS_GPES_RC_TAX'
Begin-SELECT on-error=SQL-Error
GPRCT.COMPANY                &GPRCT.COMPANY
GPRCT.GPES_TAX_LOCATION      &GPRCT.GPES_TAX_LOCATION
GPRCT.YEARCD                 &GPRCT.YEARCD
GPRCT.SIGNATURE_CITY         &GPRCT.SIGNATURE_CITY
GPRCT.SIGNATURE_DT           &GPRCT.SIGNATURE_DT
GPRCT.RESPONSIBLE_ID         &GPRCT.RESPONSIBLE_ID
GPRCT.GPES_PYE_SELCT_OPT     &GPRCT.GPES_PYE_SELCT_OPT
GPRCT.GPES_EMPL_INFO         &GPRCT.GPES_EMPL_INFO

      let $Company = &GPRCT.COMPANY
      let $Tax-Location = &GPRCT.GPES_TAX_LOCATION
      let $Fiscal-Year = &GPRCT.YEARCD
      Let #fiscal-year = TO_NUMBER($Fiscal-Year)
      let $Sign-City = &GPRCT.SIGNATURE_CITY
      let $PayeeOptn = &GPRCT.GPES_PYE_SELCT_OPT
      let $Signature-Dt = &GPRCT.SIGNATURE_DT
      let $Empl-Info = LTRIM(RTRIM(&GPRCT.GPES_EMPL_INFO, ' '), ' ')

      DO GET-COMPANY-RLTD-DATA

FROM PS_GPES_RC_TAX GPRCT

WHERE GPRCT.OPRID = $prcs_oprid
AND  GPRCT.RUN_CNTL_ID = $prcs_run_cntl_id

End-SELECT

  Do STDAPI-TERM

end-procedure


!************************************************************************
! Procedure GET-COMPANY-RLTD-DATA
!************************************************************************
begin-procedure GET-COMPANY-RLTD-DATA
#debug do Fin-Debug-Msg('GET-COMPANY-RLTD-DATA')

LET $Year_End_Dt = $Fiscal-Year || '1231'
do Format-DateTime($Year_End_Dt, $Year_End_Dt, {DEFCMP}, '', 'native')

Let $Prev_Emplid = ''   !Do not move this initialization from here
                        !nor do not initialize anywhere else.
                        !It is also used for new-page control.

#debugd show 'Employee type: ' $Empl-Info
Evaluate $Empl-Info
When = 'R'
When = 'P'
When = 'B'
   DO PROCESS-RESIDENTS

When = 'N'
When = 'P'
When = 'B'
   DO PROCESS-NON-RESIDENTS

End-Evaluate

end-procedure


!************************************************************************
! Procedure PROCESS-RESIDENTS
!************************************************************************
begin-procedure PROCESS-RESIDENTS
#debug do Fin-Debug-Msg('PROCESS-RESIDENTS')

#debugd show 'Company:                    ' $Company
#debugd show 'Tax Location:               ' $Tax-Location
#debugd show 'Year end Dt:                ' $Year_End_Dt
#debugd show 'Employee population option: ' $PayeeOptn

!27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
! Let $Prev_PER_ORG = ''

Begin-SELECT DISTINCT on-error=SQL-Error
 !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
 !Comenting the code that manages printing either employee or profesisonal certificate (only one of both)
 !Now both certificates are printed always
 !Keeping the code in case the tax agency returns to print only the necessary page(s)
 !(CASE WHEN TAX190.GPES_FISCAL_KEY = 'G' THEN 'PROF'
 !      WHEN TAX190.GPES_FISCAL_KEY = 'H' THEN 'PROF'
 !      WHEN TAX190.GPES_FISCAL_KEY = 'I' THEN 'PROF'
 !      ELSE 'EMP'
 ! END)  &SCRTYR.PER_ORG
TAX190.EMPLID    &TAX190.EMPLID
   !SCRTYR.PER_ORG

  Let $Emplid = &TAX190.EMPLID
  #debugd show 'Emplid: ' $Emplid

  DO GET-RESIDENT-EMPLID
 !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
 !  IF &SCRTYR.PER_ORG = 'EMP'
    DO PRINT_RES_HEADER         !Intentionally here to avoid printing blank pag for POIs.
    Do PRINT-CERTIFICATE-EMP

 !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
  new-page

 !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
 !  Else
 !   !IF &SCRTYR.PER_ORG = 'CWR' or &SCRTYR.PER_ORG = 'POI'
 !   IF &SCRTYR.PER_ORG = 'PROF'
      DO PRINT_RES_HEADER       !Intentionally here to avoid printing blank pag for POIs.
      Do PRINT-CERTIFICATE-CWR
 !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
 !    End-if
 !  End-if

FROM PS_GPES_TAX190 TAX190
   , PS_GPES_PER_SEC_VW SCRTYR

WHERE TAX190.COMPANY = $Company
 AND TAX190.GPES_TAX_LOCATION = $Tax-Location
 AND TAX190.PAY_END_DT = $Year_End_Dt
 AND SCRTYR.EMPLID = TAX190.EMPLID
 AND SCRTYR.OPRID =  $prcs_oprid
 AND (($Empl-Info = 'P' AND (TAX190.GPES_FISCAL_KEY IN ('G','H','I')))               !'CWR' or 'POI'
   OR ($Empl-Info IN ('R', 'N') AND (TAX190.GPES_FISCAL_KEY NOT IN ('G','H','I')))   !'EMP'
   OR ($Empl-Info = 'B')
     )
 AND (('A' = $PayeeOptn)              !All employees option
   OR ('L' = $PayeeOptn               !Listed employees option
   AND TAX190.EMPLID IN (SELECT EMPLID FROM PS_GPES_RC_TAX_10T
                         WHERE OPRID = $prcs_oprid AND RUN_CNTL_ID = $prcs_run_cntl_id))
     )
ORDER BY TAX190.EMPLID, 1

End-SELECT


end-procedure


!************************************************************************
! Procedure GET-RESIDENT-EMPLID
!************************************************************************
begin-procedure GET-RESIDENT-EMPLID
#debug do Fin-Debug-Msg('GET-RESIDENT-EMPLID')

!Initializing the Variables

Let #KeyA_Sal_Income = 0
Let #KeyA_Sal_Withhld = 0
Let #KeyA_Ink_Income = 0
Let #KeyA_Ink_Withhld = 0
Let #KeyA_Ink_Withhld2 = 0
Let #KeyA_Subsd_Income = 0
Let #KeyA_Subsd_Withhld = 0
Let #KeyA_SubsInkIncome = 0
Let #KeyA_SubsInkWithld = 0
Let #KeyA_SubsInkWithld2 = 0
Let #Amount_Pension = 0
Let #KeyA_Reduction = 0
Let #KeyA_SS_Ct = 0
Let #KeyL_Sal_Income = 0
Let #KeyL5_Sal_Income = 0

Let #KeyK1_Sal_Income = 0
Let #KeyK1_Sal_Withhld = 0
Let #KeyK1_Ink_Income = 0
Let #KeyK1_Ink_Withhld = 0
Let #KeyK1_Ink_Withhld2 = 0
Let #KeyK2_Sal_Income = 0
Let #KeyK2_Sal_Withhld = 0
Let #KeyK2_Ink_Income = 0
Let #KeyK2_Ink_Withhld = 0
Let #KeyK2_Ink_Withhld2 = 0
Let #KeyK3_Sal_Income = 0
Let #KeyK3_Sal_Withhld = 0
Let #KeyK3_Ink_Income = 0
Let #KeyK3_Ink_Withhld = 0
Let #KeyK3_Ink_Withhld2 = 0
Let #KeyG_Sal_Income = 0
Let #KeyG_Sal_Withhld = 0
Let #KeyG_Ink_Income = 0
Let #KeyG_Ink_Withhld = 0
Let #KeyG_Ink_Withhld2 = 0
Let #Arr_Soc_Security1_tmp = 0
Let #Arr_Reduction1_tmp = 0
LET $Year-Cd-Tmp = 0

Let #Arr_idx = 0

While #Arr_idx < {RETRO_ARRAY_SIZE}
        PUT '' INTO Arr_Year(#Arr_idx)
        PUT 0  INTO Arr_WithHolding(#Arr_idx)
        PUT 0  INTO Arr_Amount(#Arr_idx)
        PUT 0  INTO Arr_Soc_Security(#Arr_idx)
        PUT 0  INTO Arr_Reduction(#Arr_idx)

        Let #Arr_idx = #Arr_idx + 1
End-While
Let #Arr_idx = 0
Let #Arr_idx_tmp = 0

Begin-SELECT on-error=SQL-Error
GPTAX190.GPES_FISCAL_KEY
GPTAX190.GPES_FISCAL_SUBKEY
GPTAX190.YEARCD
GPTAX190.GPES_SALARY_INCOME
GPTAX190.GPES_SALARY_WITHLD
GPTAX190.GPES_INKIND_INCOME
GPTAX190.GPES_INKIND_WITHLD
GPTAX190.GPES_INK_WITHLD_EE
GPTAX190.GPES_SUBSD_INCOME
GPTAX190.GPES_SUBSD_WITHLD
GPTAX190.GPES_SUBSD_INK_INC
GPTAX190.GPES_SUBSD_INK_WTH
GPTAX190.GPES_SUBSD_INK_WEE
GPTAX190.GPES_REDUCTIONS
GPTAX190.GPES_GARN_SPOUSE
GPTAX190.GPES_GARN_CHILDREN
GPTAX190.GPES_SS_CT_EE

        LET $FiscalKey = LTRIM(RTRIM(&GPTAX190.GPES_FISCAL_KEY , ' '), ' ')
        LET $FiscalSubKey = LTRIM(RTRIM(&GPTAX190.GPES_FISCAL_SUBKEY, ' '), ' ')

        LET $Year-Cd = &GPTAX190.YEARCD


        Do GET-COMPANY-TBL
        Do GET-SIGNATURE-DT-COMP
        If (($Empl-Info = 'R' Or $Empl-Info = 'N')
                AND (&GPTAX190.GPES_FISCAL_KEY <> 'G' And &GPTAX190.GPES_FISCAL_KEY <> 'H' And &GPTAX190.GPES_FISCAL_KEY <> 'I'))   !EMP
             Or ($Empl-Info = 'B')   !EMP/POI/CWR
          Do GET-AMOUNT-PENSION
        End-if

        If $Prev_Emplid = ''
          Let $Prev_Emplid = $Emplid
        Else
          !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
          ! If $Prev_PER_ORG = ''
          !  Let $Prev_PER_ORG = &SCRTYR.PER_ORG
          ! End-if

          IF $Prev_Emplid <> $Emplid
          !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
          !   Or $Prev_PER_ORG <> &SCRTYR.PER_ORG
            new-page
            Let #Arr_idx = 0
          End-IF
          Let $Prev_Emplid = $Emplid
          !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
          ! Let $Prev_PER_ORG = &SCRTYR.PER_ORG
        End-if

        DO GET-EMPL-RLTD-DATA

        If $FiscalKey = 'L'
          If $FiscalSubKey = '01'
            Let #KeyL_Sal_Income = &GPTAX190.GPES_SALARY_INCOME          !Dietas
          End-If
          If $FiscalSubKey = '05' OR $FiscalSubKey = '10' OR $FiscalSubKey = '16' OR $FiscalSubKey = '15' OR $FiscalSubKey = '18' OR $FiscalSubKey = '20' OR $FiscalSubKey = '21'
            Let #KeyL5_Sal_Income = #KeyL5_Sal_Income + &GPTAX190.GPES_SALARY_INCOME
          End-If
          If $FiscalSubKey = '24' OR $FiscalSubKey = '25' OR $FiscalSubKey = '26' OR $FiscalSubKey = '27' OR $FiscalSubKey = '28'
            Let #KeyL5_Sal_Income = #KeyL5_Sal_Income + &GPTAX190.GPES_SALARY_INCOME + &GPTAX190.GPES_INKIND_INCOME
          End-If
        End-If

        If $FiscalKey = 'K'  !Premios
          If $FiscalSubKey = '01'
            Let #KeyK1_Sal_Income   = &GPTAX190.GPES_SALARY_INCOME
            Let #KeyK1_Sal_Withhld  = &GPTAX190.GPES_SALARY_WITHLD
            Let #KeyK1_Ink_Income   = &GPTAX190.GPES_INKIND_INCOME
            Let #KeyK1_Ink_Withhld  = &GPTAX190.GPES_INKIND_WITHLD
            Let #KeyK1_Ink_Withhld2 = &GPTAX190.GPES_INK_WITHLD_EE
          End-If
          If $FiscalSubKey = '02'
            Let #KeyK2_Sal_Income   = &GPTAX190.GPES_SALARY_INCOME
            Let #KeyK2_Sal_Withhld  = &GPTAX190.GPES_SALARY_WITHLD
            Let #KeyK2_Ink_Income   = &GPTAX190.GPES_INKIND_INCOME
            Let #KeyK2_Ink_Withhld  = &GPTAX190.GPES_INKIND_WITHLD
            Let #KeyK2_Ink_Withhld2 = &GPTAX190.GPES_INK_WITHLD_EE
          End-If
          If $FiscalSubKey = '03'
            Let #KeyK3_Sal_Income   = &GPTAX190.GPES_SALARY_INCOME
            Let #KeyK3_Sal_Withhld  = &GPTAX190.GPES_SALARY_WITHLD
            Let #KeyK3_Ink_Income   = &GPTAX190.GPES_INKIND_INCOME
            Let #KeyK3_Ink_Withhld  = &GPTAX190.GPES_INKIND_WITHLD
            Let #KeyK3_Ink_Withhld2 = &GPTAX190.GPES_INK_WITHLD_EE
          End-If
        End-If

        If $FiscalKey = 'A' OR $FiscalKey = 'F'  OR $FiscalKey = 'G'
         IF $Year-Cd = $Fiscal-Year
           If $FiscalKey = 'A'
             If $FiscalSubKey = '00' !--OR $FiscalSubKey = '01'
               Let #KeyA_Sal_Income    = #KeyA_Sal_Income + &GPTAX190.GPES_SALARY_INCOME           !Dietas
               LET #KeyA_Sal_Withhld   = #KeyA_Sal_Withhld + &GPTAX190.GPES_SALARY_WITHLD           !Retencion
               LET #KeyA_Ink_Income    = #KeyA_Ink_Income + &GPTAX190.GPES_INKIND_INCOME           !Valoración
               LET #KeyA_Ink_Withhld   = #KeyA_Ink_Withhld + &GPTAX190.GPES_INKIND_WITHLD           !Ing-Cta Efect
               LET #KeyA_Ink_Withhld2  = #KeyA_Ink_Withhld2 + &GPTAX190.GPES_INK_WITHLD_EE           !Ing-Cta Reperc
               LET #KeyA_Subsd_Income  = &GPTAX190.GPES_SUBSD_INCOME            !Social Security Subsidy
               LET #KeyA_Subsd_Withhld = &GPTAX190.GPES_SUBSD_WITHLD            !Social Security Subsidy Withholding
               Let #KeyA_SubsInkIncome = &GPTAX190.GPES_SUBSD_INK_INC           !Social Security InKind Subsidy
               Let #KeyA_SubsInkWithld = &GPTAX190.GPES_SUBSD_INK_WTH           !Social Security InKind Subsidy Withholding
               Let #KeyA_SubsInkWithld2 = &GPTAX190.GPES_SUBSD_INK_WEE          !Social Security InKind Subsidy Withholding Reperc
               LET #KeyA_Reduction     = #KeyA_Reduction + &GPTAX190.GPES_REDUCTIONS              !Reduccion
               LET #KeyA_SS_Ct         = #KeyA_SS_Ct + &GPTAX190.GPES_SS_CT_EE                !Seg Social
             End-If
             !--If $FiscalSubKey = '02'
             !--  Let #KeyA_Sal_Income    =    #KeyA_Sal_Income + &GPTAX190.GPES_SALARY_INCOME
             !--  LET #KeyA_Sal_Withhld  =     #KeyA_Sal_Withhld + &GPTAX190.GPES_SALARY_WITHLD           !Retencion
             !--  LET #KeyA_Ink_Income   =     #KeyA_Ink_Income + &GPTAX190.GPES_INKIND_INCOME            !Valoración
             !--  LET #KeyA_Ink_Withhld  =   #KeyA_Ink_Withhld + &GPTAX190.GPES_INKIND_WITHLD             !Ing-Cta Efect
             !--  LET #KeyA_Ink_Withhld2 =   #KeyA_Ink_Withhld2 + &GPTAX190.GPES_INK_WITHLD_EE            !Ing-Cta Reperc

             !--  If $Tax-Location = 'HFV' OR $Tax-Location = 'HFN'
             !--    LET #KeyA_SS_Ct        =  #KeyA_SS_Ct  + &GPTAX190.GPES_SS_CT_EE           !Seg Social
             !--    LET #KeyA_Reduction    = #KeyA_Reduction  + &GPTAX190.GPES_REDUCTIONS
             !--  End-If
             !--ELSE
             !--  If $Tax-Location = 'HE' OR $Tax-Location = 'HFA'  OR $Tax-Location = 'HFG'
             !--    LET #KeyA_Reduction    = &GPTAX190.GPES_REDUCTIONS
             !--    LET #KeyA_SS_Ct        = &GPTAX190.GPES_SS_CT_EE                !Seg Social
             !--  End-If

             !--End-If
           END-If

           If $FiscalKey = 'F'

             LET #KeyA_Sal_Income   = #KeyA_Sal_Income + &GPTAX190.GPES_SALARY_INCOME     !Integro
             LET #KeyA_Sal_Withhld  = #KeyA_Sal_Withhld + &GPTAX190.GPES_SALARY_WITHLD     !Retencion
             LET #KeyA_Ink_Income   = #KeyA_Ink_Income + &GPTAX190.GPES_INKIND_INCOME     !Valoración
             LET #KeyA_Ink_Withhld  = #KeyA_Ink_Withhld + &GPTAX190.GPES_INKIND_WITHLD     !Ing-Cta Efect
             LET #KeyA_Ink_Withhld2 = #KeyA_Ink_Withhld2 + &GPTAX190.GPES_INK_WITHLD_EE     !Ing-Cta Reperc
             LET #KeyA_Reduction    = #KeyA_Reduction + &GPTAX190.GPES_REDUCTIONS        !Reduccion
             LET #KeyA_SS_Ct        = #KeyA_SS_Ct + &GPTAX190.GPES_SS_CT_EE          !Seg Social

           Else

             If $FiscalKey = 'G'   !Regular income CWR or POI (PROF)

               LET #KeyG_Sal_Income   = &GPTAX190.GPES_SALARY_INCOME     !Integro
               LET #KeyG_Sal_Withhld  = &GPTAX190.GPES_SALARY_WITHLD     !Retencion
               LET #KeyG_Ink_Income   = &GPTAX190.GPES_INKIND_INCOME     !Valoración
               LET #KeyG_Ink_Withhld  = &GPTAX190.GPES_INKIND_WITHLD     !Ing-Cta Efect
               LET #KeyG_Ink_Withhld2 = &GPTAX190.GPES_INK_WITHLD_EE     !Ing-Cta Reperc

             End-If

           End-If


            #Debugd show 'Fiscal Key:     ' $FiscalKey
            #Debugd show 'Fiscal SubKey:  ' $FiscalSubKey
            #Debugd show 'Integro:        ' #KeyA_Sal_Income
            #Debugd show 'Retencion:      ' #KeyA_Sal_Withhld
            #Debugd show 'Valoración:     ' #KeyA_Ink_Income
            #Debugd show 'Ing-Cta Efect:  ' #KeyA_Ink_Withhld
            #Debugd show 'Ing-Cta Reperc: ' #KeyA_Ink_Withhld2
            #Debugd show 'Pension:        ' #Amount_Pension
            #Debugd show 'Reduccion:      ' #KeyA_Reduction
            #Debugd show 'Seg Social:     ' #KeyA_SS_Ct
            #Debugd show 'Integro PROF:        ' #KeyG_Sal_Income
            #Debugd show 'Retencion PROF:      ' #KeyG_Sal_Withhld
            #Debugd show 'Valoración PROF:     ' #KeyG_Ink_Income
            #Debugd show 'Ing-Cta Efect PROF:  ' #KeyG_Ink_Withhld
            #Debugd show 'Ing-Cta Reperc PROF: ' #KeyG_Ink_Withhld2

        Else
            If #Arr_idx < {RETRO_ARRAY_SIZE}

                If $Year-Cd-Tmp <> $Year-Cd

                    Let #Arr_WithHolding1 = 0
                    Let #Arr_Amount1 = 0
                    Let #Arr_Reduction1 = 0
                    Let #Arr_Soc_Security1 = 0

                    IF #Arr_idx = 0 and #Arr_idx_tmp = 0
                        Let #Arr_idx_tmp = 1
                    ELSE
                        LET #Arr_idx = #Arr_idx + 1
                    END-IF

                    PUT $Year-Cd INTO Arr_Year(#Arr_idx)
                End-IF

                IF $FiscalKey = 'A'

                    If $FiscalSubKey = '00' !--OR $FiscalSubKey = '01'
                        Let #Arr_Amount1       = #Arr_Amount1 + &GPTAX190.GPES_SALARY_INCOME + &GPTAX190.GPES_INKIND_INCOME       !Dietas
                        Let #Arr_Amount1       = #Arr_Amount1 + &GPTAX190.GPES_SUBSD_INCOME
                        LET #Arr_WithHolding1  = #Arr_WithHolding1 + &GPTAX190.GPES_SALARY_WITHLD + &GPTAX190.GPES_INKIND_WITHLD  !Retencion
                        LET #Arr_WithHolding1  = #Arr_WithHolding1 + &GPTAX190.GPES_SUBSD_WITHLD
                        LET #Arr_Reduction1    = &GPTAX190.GPES_REDUCTIONS                                                        !Reduccion
                        LET #Arr_Soc_Security1 = &GPTAX190.GPES_SS_CT_EE                                                          !Seg Social
                    End-If
                    !--If $FiscalSubKey = '02'
                    !--    LET #Arr_Amount1 =  #Arr_Amount1 + &GPTAX190.GPES_SALARY_INCOME + &GPTAX190.GPES_INKIND_INCOME
                    !--    LET #Arr_WithHolding1  = #Arr_WithHolding1 + &GPTAX190.GPES_SALARY_WITHLD + &GPTAX190.GPES_INKIND_WITHLD  !Retencion
                    !--    If $Tax-Location = 'HFV' OR $Tax-Location = 'HFN'
                    !--        LET #Arr_Reduction1    = #Arr_Reduction1 + &GPTAX190.GPES_REDUCTIONS
                    !--        LET #Arr_Soc_Security1 = #Arr_Soc_Security1  + &GPTAX190.GPES_SS_CT_EE  !Seg Social
                    !--    End-If
                    !--ELSE
                    !--    If $Tax-Location = 'HE' OR $Tax-Location = 'HFA'  OR $Tax-Location = 'HFG'
                    !--        LET #Arr_Reduction1 = &GPTAX190.GPES_REDUCTIONS
                    !--        LET #Arr_Soc_Security1 = &GPTAX190.GPES_SS_CT_EE  !Seg Social
                    !--    End-If
                    !--End-If

                End-If

                If $FiscalKey = 'F' OR $FiscalKey = 'G'

                    LET #Arr_Amount1       = #Arr_Amount1 + &GPTAX190.GPES_SALARY_INCOME + &GPTAX190.GPES_INKIND_INCOME  !Integro
                    LET #Arr_WithHolding1  = #Arr_Amount1 + &GPTAX190.GPES_SALARY_WITHLD + &GPTAX190.GPES_INKIND_WITHLD  !Ing-Cta Efect
                    !LET #Arr_Reduction1    = &GPTAX190.GPES_REDUCTIONS                                                   !Reduccion
                    !LET #Arr_Soc_Security1 = &GPTAX190.GPES_SS_CT_EE                                                     !Seg Social

                End-If

                PUT #Arr_WithHolding1 INTO Arr_WithHolding(#Arr_idx)
                PUT #Arr_Amount1 INTO Arr_Amount(#Arr_idx)
                PUT #Arr_Soc_Security1 INTO Arr_Soc_Security(#Arr_idx)
                PUT #Arr_Reduction1 INTO Arr_Reduction(#Arr_idx)

                LET $Year-Cd-Tmp = &GPTAX190.YEARCD

            End-If
        End-If
    End-If

FROM PS_GPES_TAX190 GPTAX190

WHERE GPTAX190.COMPANY = $Company
AND GPTAX190.GPES_TAX_LOCATION = $Tax-Location
AND GPTAX190.PAY_END_DT = $Year_End_Dt
AND GPTAX190.EMPLID = $Emplid
 !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
 !AND ((&SCRTYR.PER_ORG = 'PROF' AND (GPTAX190.GPES_FISCAL_KEY IN ('G','H','I')
 !                                    OR (GPTAX190.GPES_FISCAL_KEY = 'K' AND GPTAX190.GPES_FISCAL_SUBKEY IN ('01','03'))))
 !  OR (&SCRTYR.PER_ORG = 'EMP' AND NOT (GPTAX190.GPES_FISCAL_KEY IN ('G','H','I')
 !                                       OR (GPTAX190.GPES_FISCAL_KEY = 'K' AND GPTAX190.GPES_FISCAL_SUBKEY IN ('01','03')))))
AND (($Empl-Info = 'P' AND (GPTAX190.GPES_FISCAL_KEY IN ('G','H','I')))               !'CWR' or 'POI'
  OR ($Empl-Info IN ('R', 'N') AND (GPTAX190.GPES_FISCAL_KEY NOT IN ('G','H','I')))   !'EMP'
  OR ($Empl-Info = 'B')
    )

ORDER BY YEARCD ASC, GPES_FISCAL_SUBKEY ASC

End-SELECT


end-procedure


!************************************************************************
! Procedure GET-AMOUNT-PENSION
!************************************************************************
begin-procedure GET-AMOUNT-PENSION
#debug do Fin-Debug-Msg('GET-AMOUNT-PENSION')

Begin-SELECT on-error=SQL-Error
GPRSLT.EMPLID
GPRSLT.GPES_TAX_LOCATION
GPRSLT.COMPANY
GPRSLT.GPES_YEAR
GPRSLT.GPES_PP_ID
GPRSLT.GPES_FISCAL_KEY
GPRSLT.GPES_FISCAL_SUBKEY
SUM(GPRSLT.GPES_SALARY_INCOME) &GPRSLT.GPES_SALARY_INCOME

       Let #Amount_Pension = &GPRSLT.GPES_SALARY_INCOME


FROM PS_GPES_PP_RSLT_VW GPRSLT

WHERE GPRSLT.EMPLID = $Emplid
AND GPRSLT.COMPANY = $Company
AND GPRSLT.GPES_YEAR = #Fiscal-Year
AND GPRSLT.GPES_TAX_LOCATION = $Tax-Location

GROUP BY GPRSLT.EMPLID,GPRSLT.GPES_TAX_LOCATION,GPRSLT.COMPANY,GPRSLT.GPES_YEAR,
GPRSLT.GPES_PP_ID,GPRSLT.GPES_FISCAL_KEY,GPRSLT.GPES_FISCAL_SUBKEY

ORDER BY GPRSLT.EMPLID,GPRSLT.GPES_TAX_LOCATION,GPRSLT.COMPANY,GPRSLT.GPES_YEAR,
GPRSLT.GPES_PP_ID,GPRSLT.GPES_FISCAL_KEY,GPRSLT.GPES_FISCAL_SUBKEY

End-SELECT

end-procedure


!************************************************************************
! Procedure GET-EMPL-RLTD-DATA
!************************************************************************
begin-procedure GET-EMPL-RLTD-DATA
#debug do Fin-Debug-Msg('GET-EMPL-RLTD-DATA')

!READING THIS DATA IN THE SAME WAS AS IT DOES THE 190 MODEL APPLICATION ENGINE
!READING THIS DATA IN THE SAME WAS AS IT DOES THE 190 MODEL APPLICATION ENGINE
!READING THIS DATA IN THE SAME WAS AS IT DOES THE 190 MODEL APPLICATION ENGINE

Let $National-Id = ' '
Let $Emp-Name = ' '

Begin-SELECT on-error=SQL-Error
GPES_NID_TYPE

FROM PS_GPES_PAYEE_DATA
WHERE EMPLID = $Emplid
End-SELECT

Begin-SELECT on-error=SQL-Error
NATIONAL_ID
  Let $National-Id = &NATIONAL_ID

FROM PS_PERS_NID
WHERE EMPLID = $Emplid
 AND NATIONAL_ID_TYPE = &GPES_NID_TYPE
End-SELECT

If $National-Id = ' '

Begin-SELECT on-error=SQL-Error
!PERSDAT.EMPLID
!PERSDAT.NAME           &PERSDAT.NAME
!        LET $Emp-Name  = &PERSDAT.NAME
!PERSDAT.STATE
!PERSDAT.BIRTHDATE
PERSDAT.NATIONAL_ID    &PERSDAT.NATIONAL_ID
        LET $National-Id = &PERSDAT.NATIONAL_ID

FROM PS_GPES_PERSDAT_VW PERSDAT
WHERE PERSDAT.EMPLID = $Emplid
End-SELECT

End-If


Begin-SELECT on-error=SQL-Error
NAME
  Let $Emp-Name = &NAME

FROM PS_PERSON_NAME
WHERE EMPLID = $Emplid
End-SELECT


end-procedure


!************************************************************************
! Procedure PROCESS-NON-RESIDENTS
!************************************************************************
begin-procedure PROCESS-NON-RESIDENTS
#debug do Fin-Debug-Msg('PROCESS-NON-RESIDENTS')


Begin-SELECT DISTINCT on-error=SQL-Error
EXPT190.EMPLID
!27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
!SCRTYNR.PER_ORG

  Let $Emplid = &EXPT190.EMPLID
  #Debugd show 'Employee ID: ' $Emplid

  DO GET-NONRES-EMPLID
  !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
  !IF &SCRTYNR.PER_ORG = 'EMP'
    Do PRINT_NONRES_HEADER      !Intentionally here to avoid printing blank pag for POIs.
    Do PRINT-CERTIFICATE-EMP
  
  !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
  new-page

  !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
  !Else
  !  IF &SCRTYNR.PER_ORG = 'CWR' OR &SCRTYNR.PER_ORG = 'POI'
      Do PRINT_NONRES_HEADER    !Intentionally here to avoid printing blank pag for POIs.
      Do PRINT-CERTIFICATE-CWR
  !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
  !  End-if
  !End-if

FROM PS_GPES_EXPT_AC_VW EXPT190
   , PS_GPES_PER_SEC_VW SCRTYNR

WHERE EXPT190.COMPANY = $Company
 AND EXPT190.GPES_TAX_LOCATION = $Tax-Location
 AND EXPT190.GPES_YEAR = #fiscal-year
 AND SCRTYNR.EMPLID = EXPT190.EMPLID
 AND SCRTYNR.OPRID =  $prcs_oprid
 !27281852 - TAX UPD.-TAX DEDUCTION RPT (MODEL 10T) F-2017
 ! AND (($Empl-Info = 'P' AND (SCRTYNR.PER_ORG = 'CWR' OR SCRTYNR.PER_ORG = 'POI'))
 !   OR ($Empl-Info IN ('R', 'N') AND SCRTYNR.PER_ORG = 'EMP')
 !   OR ($Empl-Info = 'B')
 !     )
 AND (($Empl-Info = 'P' AND EXPT190.GPES_FISCAL_KEY IN ('19'))               !'CWR' or 'POI'
   OR ($Empl-Info IN ('R', 'N') AND NOT EXPT190.GPES_FISCAL_KEY IN ('19'))   !'EMP'
   OR ($Empl-Info = 'B')
     )
 AND (('A' = $PayeeOptn)               !All employees option
   OR ('L' = $PayeeOptn                !Listed employees option
   AND EXPT190.EMPLID IN (SELECT EMPLID FROM PS_GPES_RC_TAX_10T
                         WHERE OPRID = $prcs_oprid AND RUN_CNTL_ID = $prcs_run_cntl_id))
     )


End-SELECT


end-procedure


!************************************************************************
! Procedure GET-NONRES-EMPLID
!************************************************************************
begin-procedure GET-NONRES-EMPLID
#debug do Fin-Debug-Msg('GET-NONRES-EMPLID')

Let #KeyA_Sal_Income = 0
Let #KeyA_Sal_Withhld = 0
Let #KeyA_Ink_Income = 0
Let #KeyA_Ink_Withhld = 0
Let #KeyA_Ink_Withhld2 = 0
Let #KeyA_Subsd_Income = 0
Let #KeyA_Subsd_Withhld = 0
Let #KeyA_SubsInkIncome = 0
Let #KeyA_SubsInkWithld = 0
Let #KeyA_SubsInkWithld2 = 0
Let #Amount_Pension = 0
Let #KeyA_Reduction = 0
Let #KeyA_SS_Ct = 0
Let #KeyL_Sal_Income = 0
Let #KeyL5_Sal_Income = 0

Let #KeyK1_Sal_Income = 0
Let #KeyK1_Sal_Withhld = 0
Let #KeyK1_Ink_Income = 0
Let #KeyK1_Ink_Withhld = 0
Let #KeyK1_Ink_Withhld2 = 0
Let #KeyK2_Sal_Income = 0
Let #KeyK2_Sal_Withhld = 0
Let #KeyK2_Ink_Income = 0
Let #KeyK2_Ink_Withhld = 0
Let #KeyK2_Ink_Withhld2 = 0
Let #KeyK3_Sal_Income = 0
Let #KeyK3_Sal_Withhld = 0
Let #KeyK3_Ink_Income = 0
Let #KeyK3_Ink_Withhld = 0
Let #KeyK3_Ink_Withhld2 = 0
Let #KeyG_Sal_Income = 0
Let #KeyG_Sal_Withhld = 0
Let #KeyG_Ink_Income = 0
Let #KeyG_Ink_Withhld = 0
Let #KeyG_Ink_Withhld2 = 0

Do GET-COMPANY-TBL
Do GET-SIGNATURE-DT-COMP
Do GET-AMOUNT-PENSION
#Debugd show 'Pension:                               ' #Amount_Pension

Begin-SELECT on-error=SQL-Error
GPESP1.GPES_FISCAL_KEY
GPESP1.GPES_FISCAL_SUBKEY
GPESP1.GPES_EARNING_TYPE
GPESP1.GPES_SALARY_INCOME + GPESP1.GPES_SAL_INC_ADJ   &GPESP1.GPES_SALARY_INCOME
GPESP1.GPES_SALARY_WITHLD + GPESP1.GPES_SAL_WITH_ADJ  &GPESP1.GPES_SALARY_WITHLD
GPESP1.GPES_SSTC_CT_EE + GPESP1.GPES_SS_CT_EE_ADJ     &GPESP1.GPES_SSTC_CT_EE

        LET $FiscalKey = LTRIM(RTRIM(&GPESP1.GPES_FISCAL_KEY, ' '), ' ')
        LET $FiscalSubKey = LTRIM(RTRIM(&GPESP1.GPES_FISCAL_SUBKEY, ' '), ' ')

        If $Prev_Emplid = ''
          Let $Prev_Emplid = $Emplid
          !If #page-count > 1 !Residents were printed, so first non-resident needs a new page
          !  new-page
          !end-if
        Else
          IF $Prev_Emplid <> $Emplid !In case it printed employees in PROCESS-RESIDENTS the
                                     !new non-resident employee ID will be different from the
                                     !previous resident one and it will create a new-page
            new-page
            !Let #Arr_idx = 0     Not using retro data from non-residents
          End-IF
          Let $Prev_Emplid = $Emplid
        End-if

        DO GET-EMPL-RLTD-DATA
        #Debugd show 'Fiscal Key:                    ' $FiscalKey
        #Debugd show 'Fiscal SubKey:                 ' $FiscalSubKey
        If &GPESP1.GPES_EARNING_TYPE = 'D'    !Monetary/Dinerario
          If $FiscalKey = 'T' Or $FiscalKey = '20'   !EMP (Employee)
            If $FiscalSubKey = '01'
              LET #KeyA_Sal_Income = #KeyA_Sal_Income + &GPESP1.GPES_SALARY_INCOME         !Integro
              LET #KeyA_Sal_Withhld = #KeyA_Sal_Withhld + &GPESP1.GPES_SALARY_WITHLD        !Retencion
              let #KeyA_SS_Ct = #KeyA_SS_Ct + &GPESP1.GPES_SSTC_CT_EE                      !Social Security cost
              #debugd show 'Salary Income (Key A):   ' #KeyA_Sal_Income
              #debugd show 'Salary Withhold (Key A): ' #KeyA_Sal_Withhld
              #debugd show 'Social Secutiry cost: ' #KeyA_SS_Ct
            End-If
            If $FiscalSubKey = '03'
              Let #KeyL_Sal_Income = #KeyL_Sal_Income + &GPESP1.GPES_SALARY_INCOME       !Dietas
              #debugd show 'Salary Income (Key L):   ' #KeyL_Sal_Income
            End-If
          End-If
          If $FiscalKey = '19'    !CRW/POI (Professional)
            If $FiscalSubKey = '01'
              LET #KeyG_Sal_Income = #KeyG_Sal_Income + &GPESP1.GPES_SALARY_INCOME         !Integro
              LET #KeyG_Sal_Withhld = #KeyG_Sal_Withhld + &GPESP1.GPES_SALARY_WITHLD        !Retencion
              #debugd show 'Salary Income (Key G):   ' #KeyG_Sal_Income
              #debugd show 'Salary Withhold (Key G): ' #KeyG_Sal_Withhld
            end-if
          end-if
        Else    ! In Kind Income/Especie
          If $FiscalKey = 'T' Or $FiscalKey = '20'   !EMP (Employee)
            If $FiscalSubKey = '01'
              Let #KeyA_Ink_Income = #KeyA_Ink_Income + &GPESP1.GPES_SALARY_INCOME         !Integro
              Let #KeyA_Ink_Withhld = #KeyA_Ink_Withhld + &GPESP1.GPES_SALARY_WITHLD        !Retencion
              #Debugd show 'Valoración:              ' #KeyA_Ink_Income
              #Debugd show 'Ing-Cta Efect:           ' #KeyA_Ink_Withhld
            End-If
          End-If
          If $FiscalKey = '19'    !CRW/POI (Professional)
            If $FiscalSubKey = '01'
              Let #KeyG_Ink_Income = #KeyG_Ink_Income + &GPESP1.GPES_SALARY_INCOME         !Integro
              Let #KeyG_Ink_Withhld = #KeyG_Ink_Withhld + &GPESP1.GPES_SALARY_WITHLD        !Retencion
              #Debugd show 'Valoración:              ' #KeyG_Ink_Income
              #Debugd show 'Ing-Cta Efect:           ' #KeyG_Ink_Withhld
            end-if
          end-if
        End-If


FROM PS_GPES_EXPT_RSLT GPESP1

WHERE GPESP1.COMPANY = $Company
AND GPESP1.GPES_TAX_LOCATION = $Tax-Location
AND GPESP1.GPES_YEAR = #fiscal-year
AND GPESP1.EMPLID = $Emplid
AND (($Empl-Info = 'P' AND GPESP1.GPES_FISCAL_KEY IN ('19'))               !'CWR' or 'POI'
  OR ($Empl-Info IN ('R', 'N') AND NOT GPESP1.GPES_FISCAL_KEY IN ('19'))   !'EMP'
  OR ($Empl-Info = 'B')
    )
AND GPESP1.RSLT_VER_NUM = (
 SELECT MAX(RSLT_VER_NUM)
  FROM  PS_GPES_EXPT_RSLT
 WHERE EMPLID =  GPESP1.EMPLID
   AND CAL_RUN_ID = CAL_RUN_ID
   AND EMPL_RCD =  GPESP1.EMPL_RCD
   AND GP_PAYGROUP =  GPESP1.GP_PAYGROUP
   AND CAL_ID =  GPESP1.CAL_ID
   AND ORIG_CAL_RUN_ID =  GPESP1.ORIG_CAL_RUN_ID
   AND GPES_YEAR =  GPESP1.GPES_YEAR
   AND GPES_MONTH =  GPESP1.GPES_MONTH)
AND GPESP1.RSLT_REV_NUM = (
 SELECT MAX(RSLT_REV_NUM)
  FROM  PS_GPES_EXPT_RSLT
 WHERE EMPLID =  GPESP1.EMPLID
   AND CAL_RUN_ID = CAL_RUN_ID
   AND EMPL_RCD =  GPESP1.EMPL_RCD
   AND GP_PAYGROUP =  GPESP1.GP_PAYGROUP
   AND CAL_ID =  GPESP1.CAL_ID
   AND ORIG_CAL_RUN_ID =  GPESP1.ORIG_CAL_RUN_ID
   AND GPES_YEAR =  GPESP1.GPES_YEAR
   AND GPES_MONTH =  GPESP1.GPES_MONTH)

End-SELECT


end-procedure


!************************************************************************
! Procedure GET-SIGNATURE-DT-COMP
!************************************************************************
begin-procedure GET-SIGNATURE-DT-COMP
#debug do Fin-Debug-Msg('GET-SIGNATURE-DT-COMP')

Let  #wkYears = 0
Let  #wkMonths = 0
Let  #wkDays = 0

do Format-DateTime($Signature-Dt, $OUT, {DEFCMP}, '', '')

DO Get-DateComponents ($OUT,#wkYears,#wkMonths,#wkDays)

end-procedure


!************************************************************************
! Procedure GET-COMPANY-TBL
!************************************************************************
begin-procedure GET-COMPANY-TBL
#debug do Fin-Debug-Msg('GET-COMPANY-TBL')

Let $Cmpny-ADDLINE1 = ''
Let $Cmpny-ADDLINE2 = ''
Let $Cmpny-ADDLINE3 = ''
Let $Cmpny-ADDLINE4 = ''
Let $Cmpny-ADDLINE5 = ''
Let $Cmpny-ADDLINE6 = ''
Let $Cmpny-ADDLINE7 = ''
Let $Cmpny-ADDLINE8 = ''

Begin-SELECT on-error=SQL-Error
CMPNY.COMPANY
CMPNY.EFFDT
CMPNY.DESCR        &CMPNY.DESCR
CMPNY.COUNTRY
CMPNY.ADDRESS1
CMPNY.ADDRESS2
CMPNY.ADDRESS3
CMPNY.ADDRESS4
CMPNY.CITY
CMPNY.NUM1
CMPNY.NUM2
CMPNY.HOUSE_TYPE
CMPNY.ADDR_FIELD1
CMPNY.ADDR_FIELD2
CMPNY.ADDR_FIELD3
CMPNY.COUNTY
ST.DESCR
CMPNY.POSTAL
CMPNY.GEO_CODE
CMPNY.IN_CITY_LIMIT
CMPNY.FISCAL_ID_CD   &CMPNY.FISCAL_ID_CD

     Let $Fiscal-id-code = &CMPNY.FISCAL_ID_CD
     Let $Descr = &CMPNY.DESCR
     Let $Cmpny-ADDLINE1 =  LTRIM(RTRIM(&CMPNY.ADDR_FIELD1,' ')||' ',' ')||LTRIM(RTRIM(&CMPNY.ADDRESS1,' ')||' ',' ')    !Via pública
     Let $Cmpny-ADDLINE2 =  LTRIM(RTRIM(&CMPNY.ADDR_FIELD2,' ')||' ',' ')           !Núm.
     Let $Cmpny-ADDLINE3 =  LTRIM(RTRIM(&CMPNY.ADDR_FIELD3,' ')||' ',' ')           !Escalera

     Let $Cmpny-ADDLINE4 =  LTRIM(RTRIM(&CMPNY.NUM1,' ')||' ',' ')                  !Piso
     Let $Cmpny-ADDLINE5 =  LTRIM(RTRIM(&CMPNY.NUM2,' ')||' ',' ')                  !Puerta
     Let $Cmpny-ADDLINE6 =  LTRIM(RTRIM(&CMPNY.CITY,' ')||' ',' ')                  !Municipio
     Let $Cmpny-ADDLINE7 =  LTRIM(RTRIM(&ST.DESCR,' ')||' ',' ')                 !Provincia
     Let $Cmpny-ADDLINE8 =  LTRIM(RTRIM(&CMPNY.POSTAL,' ')||' ',' ')                !Postal

FROM PS_COMPANY_TBL CMPNY,
PS_STATE_TBL ST

WHERE CMPNY.COMPANY = $Company
  AND CMPNY.EFFDT = (SELECT MAX(EFFDT) FROM PS_COMPANY_TBL CMPNY2
                     WHERE CMPNY2.COMPANY = CMPNY.COMPANY)
  AND CMPNY.EFF_STATUS <> 'I'
  AND ST.COUNTRY = CMPNY.COUNTRY
  AND ST.STATE = CMPNY.STATE

End-SELECT

end-procedure


!************************************************************************
! Procedure PRINT_RES_HEADER
!************************************************************************
begin-procedure PRINT_RES_HEADER
#debug do Fin-Debug-Msg('PRINT_RES_HEADER')

  #define DFLT_COL1                04
  #define DFLT_COL2                14
  #define DFLT_COL3                22


  #define ARIAL               4
  #define ARIAL_BOLD        400
  #define COURIER_NEW         3
  #define HELVETICA_NARROW   38
  #define TIMES_ITALIC       32
  #define MAIN_BOX_WIDTH    {ColR}



  !---- HEADER PART----!

   alter-printer point-size=12 font={ARIAL}
   print 'Certificado de retenciones e ingresos a cuenta del Impuesto sobre la Renta de las Personas Físicas' (1 , 3)  Bold

end-procedure


!************************************************************************
! Procedure PRINT_NONRES_HEADER
!************************************************************************
begin-procedure PRINT_NONRES_HEADER
#debug do Fin-Debug-Msg('PRINT_NONRES_HEADER')

#define DFLT_COL1                04
  #define DFLT_COL2                14
  #define DFLT_COL3                22


  #define ARIAL               4
  #define ARIAL_BOLD        400
  #define COURIER_NEW         3
  #define HELVETICA_NARROW   38
  #define TIMES_ITALIC       32
  #define MAIN_BOX_WIDTH    {ColR}


  !---- HEADER PART----!

   alter-printer point-size=12 font={ARIAL}
   print 'Certificado de retenciones e ingresos a cuenta del Impuesto sobre la Renta de No Residentes' (1 , 6)  Bold

end-procedure


!************************************************************************
! Procedure PRINT-CERTIFICATE-EMP
!************************************************************************
begin-procedure PRINT-CERTIFICATE-EMP
#debug do Fin-Debug-Msg('PRINT-CERTIFICATE-EMP')

  #define DFLT_COL1                04
  #define DFLT_COL2                14
  #define DFLT_COL3                22


  #define ARIAL               4
  #define ARIAL_BOLD        400
  #define COURIER_NEW         3
  #define HELVETICA_NARROW   38
  #define TIMES_ITALIC       32
  #define MAIN_BOX_WIDTH    {ColR}

  let #LINE_NoP = 0
  let #LINE_NoN = 0

  !---- PART 1  Datos del perceptor ----!

    alter-printer point-size=30 font={ARIAL}
    graphic (+2,5,26) box 2 5
    alter-printer point-size=10 font={ARIAL}
    print 'Datos del Perceptor'                      ( +1, 6)  Bold

    alter-printer point-size=30 font={ARIAL}
    graphic (+1,5,129) box 3 5
    alter-printer point-size=9 font={ARIAL}
    print 'N.I.F.'                     ( +1, 8)
    print 'Apellidos y Nombre'         (  , 30)

    alter-printer point-size=9 font={ARIAL}
    graphic (+1,7,17) BOX 1 0 18
    print  $National-Id                                                 ( ,9)

    alter-printer point-size=9 font={ARIAL}
    graphic ( ,29,103) BOX 1 0 18
    print  $Emp-Name                                                     ( ,31)


  !---- PART 2  Datos de la persona o entidad pagadora ----!

     graphic (+2,5,48) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Datos de la persona o entidad pagadora'                      ( +1, 6)  Bold

     graphic (+1,5,129) box 3 5
     alter-printer point-size=9 font={ARIAL}
     print 'N.I.F.'                     ( +1, 8)
     print 'Apellidos y nombre, denominación o razón social'         (  , 30)

     graphic (+1,7,16) BOX 1 0 18
     alter-printer point-size=9 font={ARIAL}
     print $Fiscal-id-code                                ( ,9)

     graphic ( ,29,103) BOX 1 0 18
     alter-printer point-size=9 font={ARIAL}
     print $Descr                                         ( ,31)


  !---- PART 3 HEADER  Rendimientos del trabajo, dietas exceptuadas de gravamen ----!

    alter-printer point-size=10 font={ARIAL}
    print 'Rendimientos del trabajo, dietas exceptuadas de gravamen y rentas exentas.' (+2 , 3)  Bold

    alter-printer point-size=10 font={ARIAL}
    !set-color print-text-foreground = ('black')
    print 'Datos correspondientes al ejercicio'                (, 89)  Bold

    alter-printer point-size=10 font={ARIAL}
    graphic (,129,5) box 1 0 18
    print $Fiscal-Year                                         ( ,129) Bold


  !---- PART 3  Rendimientos del trabajo: detalle de las percepciones y de las retenciones e ingresos a cuenta ----!

  !---- PART 3 (a)----!

     graphic (+2,5,108) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Rendimientos del trabajo: detalle de las percepciones y de las retenciones e ingresos a cuenta' ( +1, 6)  Bold

     graphic (+1,5,129) box 76 5
     alter-printer point-size=8 font={ARIAL}
     print 'Rendimientos correspondientes al ejercicio.'        ( +1, 6)  Bold
     !graphic (,6,39) horz-line

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                         (+1,85)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                            (   ,111)

     alter-printer point-size=7 font={ARIAL}
     print 'Dinerarias..............................................................' ( +1, 46)

     graphic (-1,83,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Sal_Income, $Out, 'B99,999,999.99')
     print $Out                                                 ( +1,90)

     graphic (-1,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Sal_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                 ( +1,116)


     alter-printer point-size=7 font={ARIAL}
     graphic (-1,44,5) vert-line 10
     print 'Retribuciones NO derivadas de incapacidad laboral:'  (+3,6)
     print 'Valoración '                                         ( ,64)
     print 'Ingresos a cuenta efectuados '                       ( ,84)
     print 'Ingresos a cuenta repercutidos '                     (,109)

     alter-printer point-size=7 font={ARIAL}
     print 'En especie...'                                       (+1, 46)

     graphic (-1,57,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Ink_Income, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,64)

     graphic (-1,83,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Ink_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,90)

     graphic (-1,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Ink_Withhld2, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,116)


     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                           (+2 ,85)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                              (   ,111)

     alter-printer point-size=7 font={ARIAL}
     print 'Dinerarias..............................................................' ( +1, 46)

     graphic (-1,83,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Subsd_Income, $Out, 'B99,999,999.99')
     print $Out                                                   ( +1,90)

     graphic (-1,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Subsd_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                   ( +1,116)


     alter-printer point-size=7 font={ARIAL}
     graphic (-1,44,5) vert-line 10
     print 'Retribuciones derivadas de incapacidad laboral:'      (+3,6)
     print 'Valoración '                                          ( ,64)
     print 'Ingresos a cuenta efectuados '                        ( ,84)
     print 'Ingresos a cuenta repercutidos '                      (,109)

     alter-printer point-size=7 font={ARIAL}
     print 'En especie...'                                        (+1, 46)

     graphic (-1,57,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_SubsInkIncome, $Out, 'B99,999,999.99')
     print $Out                                                   (+1,64)

     graphic (-1,83,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_SubsInkWithld, $Out, 'B99,999,999.99')
     print $Out                                                   (+1,90)

     graphic (-1,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_SubsInkWithld2, $Out, 'B99,999,999.99')
     print $Out                                                   (+1,116)


!***************************************************************************

     alter-printer point-size=7 font={ARIAL}
     print 'Importe imputado al perceptor                      '         (+2,109)
     print 'Contribuciones empresariales a Planes de Pensiones, planes de previsión social empresarial y mutualidades de previsión social' (, 6)
     print '                                                   '         (,107)
     let $Out = '(excepto a seguros colectivos de dependencia).........................................................'
     let $Out = $Out || '.............................................................................................'
     print $Out                                                  (, 6)

     graphic (-2,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#Amount_Pension, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,116)


 !***************************************************************************

     alter-printer point-size=7 font={ARIAL}
     print 'Importe imputado al perceptor'                       (+2,109)
     let $Out = 'Contribuciones empresariales a seguros colectivos de dependencia..........................'
     let $Out = $Out || '...........................................................................................'
     print $Out                                                  (+1, 6)

     graphic (-2,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     !Do Format-Number(xxxxxxxxxxxxxx, $Out, 'B99,999,999.99')
     !print $Out                                                 (+1,116)
     print ' '                                                   (+1,116)


 !*************************************************************************

     alter-printer point-size=7 font={ARIAL}
     print 'Importe de las reducciones'                          (+2,111)


     alter-printer point-size=7 font={ARIAL}
     let $Out = 'Reducciones a que se refieren el artículo 18, apartados 2 y 3, y/o las disposiciones transitorias 11.ª'
     let $Out = $Out || ' y 12.ª de la Ley del Impuesto...................'
     print $Out                                                  (+1 , 6)

     graphic (-2,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_Reduction, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,116)

 !*************************************************************************


     alter-printer point-size=7 font={ARIAL}
     print 'Importe de los gastos'                               (+2,112)


     alter-printer point-size=7 font={ARIAL}
     let $Out = 'Gastos fiscalmente deducibles a que se refiere el artículo 19.2 (letras a), b) y c)) de la Ley del Impuesto'
     let $Out = $Out || '............................................................'
     print $Out                                                  (+2 , 6)

     graphic (-2,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyA_SS_Ct, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,116)

     alter-printer point-size=6 font={ARIAL}
     Let $Out = '(Cotizaciones a la Seguridad Social o a mutualidades generales obligatorias de funcionarios,'
     Let $Out = $Out || 'detracciones por derechos pasivos y cotizaciones a Colegios de Huérfanos o entidades similares)'
     print $Out                                                  (+1 , 6)


   !---- PART 3 (b) Rendimientos satisfechos en el ejercicio correspondientes a ejercicios anteriores (atrasos). ----!

     alter-printer point-size=8 font={ARIAL}
     print 'Rendimientos satisfechos en el ejercicio correspondientes a ejercicios anteriores (atrasos).'                     (+1, 6)  Bold
     !graphic (,6,81) horz-line

     alter-printer point-size=6 font={ARIAL}
     print 'Se hace constar asimismo que, con independencia de las retribuciones anteriormente detalladas,'                   (+2, 6)
     print 'en el ejercicio a que este certificado se refefiere le han sido satisfechas al perceptor que figura en el'        (  ,-34)
     print 'encabeczamiento otras cantidades en concepto de atrasos correspondientes a ejercicios anteriores cuyos datos, '   (, 6)
     print 'a efectos de lo dispuesto en el artículo 14.2.b) de la Ley del Impuesto, se desglosan como'                       (  ,-40)
     print 'sigue:'                                                                                                           (, 6)

     print 'Reducciones (art.º 18, 2 y 3, y'                     (+1,84)
     print 'Gastos deducibles(art.º 19.2 (letras            '    ( , 109)
     print 'Ejercicio de devengo'                                ( ,14)
     print 'Importe íntegro satisfecho'                          ( , 35)
     print 'Retenciones practicadas'                             ( , 60)
     print 'DT 11.ª y 12.ª de la Ley del Impuesto)'              ( , 82)
     print 'a), b) y c)) de la Ley del Impuesto'                 ( , 110)

     !let #LINE_Bkp = #current-line
     !
     let #LINE_NoP  = #current-line + 1
     !Do PRINT-RETRO-DATA

     graphic (,12,17) box 2 10
     graphic (,32,22) box 2 10
     graphic (,57,22) box 2 10
     graphic (,82,23) box 2 10
     graphic (,108,24) box 2 10

     graphic ( +2,12,17) box 2 10
     graphic (,32,22) box 2 10
     graphic (,57,22) box 2 10
     graphic (,82,23) box 2 10
     graphic (,108,24) box 2 10

     graphic ( +2,12,17) box 2 10
     graphic (,32,22) box 2 10
     graphic (,57,22) box 2 10
     graphic (,82,23) box 2 10
     graphic (,108,24) box 2 10

     graphic ( +2,12,17) box 2 10
     graphic (,32,22) box 2 10
     graphic (,57,22) box 2 10
     graphic (,82,23) box 2 10
     graphic (,108,24) box 2 10

     alter-printer point-size=6 font={ARIAL}
     print 'Información de interés para el perceptor.'      ( +2,6)  Bold

     alter-printer point-size=6 font={ARIAL}
     Let $LitWk = 'La percepción de cantidades en concepto de atrasos de rendimientos '
     Let $LitWk = $LitWk || 'del trabajo dará lugar a la presentación de una declaración '
     Let $LitWk = $LitWk || 'complementaria del I.R.P.F. por'
     print $LitWk      ( ,34)


     alter-printer point-size=6 font={ARIAL}
     Let $LitWk = 'cada uno de los ejercicios a los que dichas cantidades se '
     Let $LitWk = $LitWk || 'refieran, sin que dichas declaraciones complementarias comporten '
     Let $LitWk = $LitWk || 'la exigencia de intereses de demora ni recargo alguno.'
     print $LitWk      ( ,6)

    ! Line Count 72

   !---- PART 3 (c) Cantidades reintegradas por el perceptor en el ejercicio ----!

     alter-printer point-size=8 font={ARIAL}
     Let $LitWk = 'Cantidades reintegradas por el perceptor en el ejercicio por haber '
     Let $LitWk = $LitWk || 'sido indebida o excesivamente percibidas en ejercicio anteriores'
     Let $LitWk = $LitWk || ' (reintegros).'
     print $LitWk          ( +1, 6)  Bold
     !graphic (-1,6,126) horz-line

     alter-printer point-size=6 font={ARIAL}
     Let $LitWk = 'Se hace constar también que, con independencia de los rendimientos anteriormente '
     Let $LitWk = $LitWk || 'detallados, el perceptor que figura en el encabezamiento ha '
     Let $LitWk = $LitWk || 'reintegrado en el ejercicio a que este certificado se refiere las'
     print $LitWk      (+1,6)
     Let $LitWk = 'cantidades que a continuación se detallan, que fueron indebida o excesivamente '
     Let $LitWk = $LitWk || 'percibidas en cada uno de los ejercicios que se indican. '
     Let $LitWk = $LitWk || 'Asimismo, se hace constar el importe de las reducciones que, en su'
     print $LitWk      ( ,6)
     Let $LitWk = 'caso correspondieron a dichas cantidades a efectos de determinar el tipo de '
     Let $LitWk = $LitWk || 'retención en los respectivos ejercicios.'
     print $LitWk      ( ,6)

     print 'Ejercicio de percepción'                                (+2,13)
     print 'Importe íntegro reintegrado'                            ( , 34)
     print 'Reducciones que correspondieron'                        ( , 57)

     let #LINE_Bkp = #current-line + 1

     let #LINE_NoN = #current-line + 2
     Do PRINT-RETRO-DATA

      graphic (#LINE_Bkp,12,17) box 2 10
     graphic (,32,22) box 2 10
     graphic (,57,22) box 2 10

     graphic (+2,12,17) box 2 10
     graphic (,32,22) box 2 10
     graphic (,57,22) box 2 10

     graphic (+2,12,17) box 2 10
     graphic (,32,22) box 2 10
     graphic (,57,22) box 2 10


     alter-printer point-size=6 font={ARIAL}
     print 'Información de interés para el perceptor.'           ( +2,6)  Bold
     Let $LitWk = 'El reintegro de las cantidades incluidas en declaraciones del IRPF '
     Let $LitWk = $LitWk || 'ya presentadas por el contribuyente, dará derecho a éste a solicitar '
     Let $LitWk = $LitWk || 'de la Administración'
     print $LitWk      ( ,34)
     Let $LitWk = 'tributaria la rectificación de dichas declaraciones y, en su caso, la '
     Let $LitWk = $LitWk || 'devolución de los ingresos indebidamente realizados en el '
     Let $LitWk = $LitWk || 'Tesoro por esta causa, con arreglo a lo dispuesto en '
     Let $LitWk = $LitWk || 'los artículos 120.3 y 221.4'
     print $LitWk      ( ,6)
     print 'de la Ley 58/2003, de 17 de Diciembre, General Tributaria.'      ( ,6)

  !---- PART 4 Dietas exceptuadas de gravamen y rentas exentas del impuesto ----!

     !graphic (+2,5,74) box 2 5
     alter-printer point-size=8 font={ARIAL}
     print 'Dietas exceptuadas de gravamen y rentas exentas del impuesto'    ( +2, 6)  Bold


     !graphic (+1,5,129) box 6 5
     alter-printer point-size=6 font={ARIAL}
     print 'Importe satisfecho'                      ( , 114)

     alter-printer point-size=6 font={ARIAL}
     Let $LitWk = 'Dietas y asignaciones para gastos de viaje, en las cuantías exceptuadas de gravamen del IRPF '
     Let $LitWk = $LitWk || '......................................................................'
     Let $LitWk = $LitWk || '.......................................'
     print $LitWk      (+2 , 6)


     graphic (-2,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     !Do Format-Number(#KeyA_Reduction, $Out, 'B99,999,999.99')
     Do Format-Number(#KeyL_Sal_Income, $Out, 'B99,999,999.99')
     print $Out                                                               (+1,116)

     alter-printer point-size=6 font={ARIAL}
     Let $LitWk = 'Rentas exentas del IRPF incluidas por la empresa o entidad pagadora '
     Let $LitWk = $LitWk || 'en el resumen anual de retenciones e ingresos a cuenta (mod.190)....'
     Let $LitWk = $LitWk || '.......................................'
     print $LitWk      ( +2,6)

     graphic (-2,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyL5_Sal_Income, $Out, 'B99,999,999.99')
     print $Out                                                               (+1,116)


  !---- PART 5 ----!

     alter-printer point-size=10 font={ARIAL}
     print 'Ganancias patrimoniales de los vecinos derivadas de los aprovechamientos'    ( +3, 3)  Bold
     print 'forestales en montes públicos'                                               ( +1, 3)  Bold

     print 'Datos correspondientes al ejercicio'                (, 89)  Bold
     alter-printer point-size=10 font={ARIAL}
     graphic (,129,5) box 1 0 18
     print $Fiscal-Year                                         ( ,129) Bold

     graphic (+2,5,79) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Detalle de las percepciones y de las retenciones e ingresos a cuenta'        ( +1, 6)  Bold

     graphic (+1,5,129) box 9 5
     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                         (+1,85)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                            (   ,111)

     alter-printer point-size=7 font={ARIAL}
     Let $Out = 'Contraprestaciones dinerarias.............................................................'
     Let $Out = $Out || '..........................................................'
     print $Out                                                 ( +1, 6)

     graphic (-2,83,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK2_Sal_Income, $Out, 'B99,999,999.99')
     print $Out                                                 ( +1,90)

     graphic (-1,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK2_Sal_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                 ( +1,116)

     alter-printer point-size=7 font={ARIAL}
     print 'Valoración '                                         (+2,64)
     print 'Ingresos a cuenta efectuados '                       ( ,83)
     print 'Ingresos a cuenta repercutidos '                     (,109)

     alter-printer point-size=7 font={ARIAL}
     Let $Out = 'Contraprestaciones en especie...........................................................'
     print $Out                                                  ( +1, 6)

     graphic (-1,57,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK2_Ink_Income, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,64)

     graphic (-1,83,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK2_Ink_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,90)

     graphic (-1,109,23) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK2_Ink_Withhld2, $Out, 'B99,999,999.99')
     print $Out                                                  (+1,116)

end-procedure


!************************************************************************
! Procedure PRINT-CERTIFICATE-CWR
!************************************************************************
begin-procedure PRINT-CERTIFICATE-CWR
#debug do Fin-Debug-Msg('PRINT-CERTIFICATE-CWR')

  #define DFLT_COL1                04
  #define DFLT_COL2                14
  #define DFLT_COL3                22


  #define ARIAL               4
  #define ARIAL_BOLD        400
  #define COURIER_NEW         3
  #define HELVETICA_NARROW   38
  #define TIMES_ITALIC       32
  #define MAIN_BOX_WIDTH    {ColR}

  let #LINE_NoP = 0
  let #LINE_NoN = 0

  !---- PART 1  Datos del perceptor ----!

    alter-printer point-size=30 font={ARIAL}
    graphic (+2,5,26) box 2 5
    alter-printer point-size=10 font={ARIAL}
    print 'Datos del perceptor'                                      (+1, 6)  Bold

    alter-printer point-size=30 font={ARIAL}
    graphic (+1,5,129) box 3 5
    alter-printer point-size=9 font={ARIAL}
    print 'N.I.F.'                                                   (+1, 8)
    print 'Apellidos y Nombre o denominación'                        (  ,30)

    alter-printer point-size=9 font={ARIAL}
    graphic (+1,7,17) BOX 1 0 18
    print  $National-Id                                              (  , 9)

    alter-printer point-size=9 font={ARIAL}
    graphic ( ,29,103) BOX 1 0 18
    print  $Emp-Name                                                 (  ,31)


  !---- PART 2  Datos de la persona o entidad pagadora ----!

     graphic (+2,5,48) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Datos de la persona o entidad pagadora'                  (+1, 6)  Bold

     graphic (+1,5,129) box 3 5
     alter-printer point-size=9 font={ARIAL}
     print 'N.I.F.'                     ( +1, 8)
     print 'Apellidos y nombre, denominación o razón social'         (  ,30)

     graphic (+1,7,16) BOX 1 0 18
     alter-printer point-size=9 font={ARIAL}
     print $Fiscal-id-code                                           (  , 9)

     graphic ( ,29,103) BOX 1 0 18
     alter-printer point-size=9 font={ARIAL}
     print $Descr                                                    (  ,31)


  !---- HEADER PART 3 HEADER Rendimientos de actividades económicas ----!

    alter-printer point-size=10 font={ARIAL}
    print 'Rendimientos de actividades económicas.'                  (+3, 3)  Bold

    alter-printer point-size=10 font={ARIAL}
    print 'Datos correspondientes al ejercicio'                      ( , 89)  Bold

    alter-printer point-size=10 font={ARIAL}
    graphic (,129,5) box 1 0 18
    print $Fiscal-Year                                               ( ,129)  Bold


  !---- PART 3  Detalle de las percepciones y de las retenciones e ingresos a cuenta ----!

     graphic (+1,5,80) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Detalle de las percepciones y de las retenciones e ingresos a cuenta'  (+1, 6)  Bold

  !---- PART 3 (a)  Rendimientos de actividades profesionnales ----!

     graphic (+1,5,129) box 38 5
     alter-printer point-size=8 font={ARIAL}
     print 'Rendimientos de actividades profesionales'                             (+1, 6)  Bold
     !graphic (,6,38) horz-line

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                                            (,80)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                               (  ,110)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones dinerarias .............................................................................................' ( +2, 10)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyG_Sal_Income, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyG_Sal_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,116)


     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                            (+1,57)
     print 'Ingresos a cuenta efectuados'                                          (  ,78)
     print 'Ingresos a cuenta repercutidos'                                        (  ,107)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones en especie.................................'        (+1, 10)

     graphic (-1,49,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyG_Ink_Income, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,58)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyG_Ink_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyG_Ink_Withhld2, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,116)


  !---- PART 3 (b)  Rendimientos de actividades agricolas o ganaderas ----!

     alter-printer point-size=8 font={ARIAL}
     print 'Rendimientos de actividades agrícolas o ganaderas'                     (+2, 6)  Bold
     !graphic (,6,46) horz-line

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                                            (,80)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                               (  ,110)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones dinerarias .............................................................................................' ( +2, 10)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                           (+1,57)
     print 'Ingresos a cuenta efectuados'                                         (  ,78)
     print 'Ingresos a cuenta repercutidos'                                       (  ,107)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones en especie.................................'       (+1, 10)

     graphic (-1,49,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,58)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


  !---- PART 3 (c)  Rendimientos de actividades forestales ----!

     alter-printer point-size=8 font={ARIAL}
     print 'Rendimientos de actividades forestales'                               (+2, 6)  Bold
     !graphic (,6,35) horz-line

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                                           (  ,80)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                              (  ,110)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones dinerarias .............................................................................................' ( +2, 10)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                           (+1,57)
     print 'Ingresos a cuenta efectuados'                                         (  ,78)
     print 'Ingresos a cuenta repercutidos'                                       (  ,107)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones en especie.................................'       (+1, 10)

     graphic (-1,49,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,58)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


  !---- PART 3 (d)  Rendimientos de las actividades empresariales en estimación... ----!

     alter-printer point-size=8 font={ARIAL}
     let $Out = 'Rendimientos de las actividades empresariales en estimación objetiva previstas en el '
     let $Out = $Out || 'art.º 95.6 del Reglamento del IRPF'
     print $Out                                                                    (+2, 6)  Bold
     !graphic (,6,106) horz-line

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                                            (+1,80)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                               (  ,110)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones dinerarias .............................................................................................' ( +2, 10)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                           (+1,57)
     print 'Ingresos a cuenta efectuados'                                         (  ,78)
     print 'Ingresos a cuenta repercutidos'                                       (  ,107)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones en especie.................................'       (+1, 10)

     graphic (-1,49,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,58)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


  !---- PART 3 (e)  Rendimientos a que se refiere el articulo 75.2.b) del Reglamento del IRPF... ----!

     alter-printer point-size=8 font={ARIAL}
     let $Out = 'Rendimientos a que se refiere el artículo 75.2.b) del Reglamento del IRPF, que deban '
     let $Out = $Out || 'calificarse como rendimientos de actividades económicas'
     print $Out                                                                   (+2, 6)  Bold
     !graphic (-1,6,126) horz-line

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                                           (  ,80)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                              (  ,110)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones dinerarias .............................................................................................' ( +2, 10)
     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                           (+1,57)
     print 'Ingresos a cuenta efectuados'                                         (  ,78)
     print 'Ingresos a cuenta repercutidos'                                       (  ,107)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones en especie.................................'       (+1, 10)

     graphic (-1,49,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,58)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


  !---- PART 4  Premios por la participación en juegos, concursos, rifas o combinaciones ----!

    alter-printer point-size=10 font={ARIAL}
    print 'Premios por la participación en juegos, concursos, rifas o combinaciones' (+3, 3)  Bold
    !print 'aleatorias'                                                              (+1, 3)  Bold

    alter-printer point-size=10 font={ARIAL}
    print 'Datos correspondientes al ejercicio'                                    ( , 89)  Bold

    alter-printer point-size=10 font={ARIAL}
    graphic (,129,5) box 1 0 18
    print $Fiscal-Year                                                             ( ,129)  Bold


     graphic (+1,5,80) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Detalle de las percepciones y de las retenciones e ingresos a cuenta'  (+1, 6)  Bold


  !---- PART 4 (a)  Detalle de las percepciones y de las retenciones e ingresos a cuenta ----!

     graphic (+1,5,129) box 21 5
     alter-printer point-size=8 font={ARIAL}
     Let $Out = 'Premios por la participación en juegos, rifas o combinaciones aleatorias sin'
     Let $Out = $Out || 'fines publicitarios (enmarcables en la definición del concepto de'
     print $Out                                                                    (+1, 6)  Bold
     Let $Out = 'juego" que se contiene en el artículo 3.a) de la Ley 13/2011,'
     Let $Out = $Out || ' de 27 de mayo, de Regulación del juego).'
     print $Out                                                                    (  , 6)  Bold

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                                            (+1,80)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                               (  ,110)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones dinerarias(*) .........................................................................................' ( +2, 10)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK1_Sal_Income, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK1_Sal_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,116)

     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                           (+1,57)
     print 'Ingresos a cuenta efectuados'                                         (  ,78)
     print 'Ingresos a cuenta repercutidos'                                       (  ,107)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones en especie(*).............................'        (+1, 10)

     graphic (-1,49,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK1_Ink_Income, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,58)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK1_Ink_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK1_Ink_Withhld2, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,116)

     let $Out = '(*) Estos premios se consignarán por su importe íntegro, sin perjuicio'
     let $Out = $Out || ' del derecho del perceptor a minorar su importe en las pérdidas en el'
     Let $Out = $Out || ' juego obtenidas en el mismo período impositivo, en los'
     alter-printer point-size=6 font={ARIAL}
     print $Out                                                                   (+1, 10)
     let $Out = ' términos establecidos en el artículo 33.5.d) de la Ley 35/2006 de 28 de noviembre, del IRPF.'
     print $Out                                                                   (  , 10)


  !---- PART 4 (b)  Premios por la participación en concursos o combinaciones aleatorias ----!

     let $Out = 'Premios por la participación en concursos o combinaciones aleatorias con fines'
     let $Out = $Out || ' publicitarios (no enmarcables en la definición del concepto de'
     alter-printer point-size=8 font={ARIAL}
     print $Out                                                                   (+2, 6)  Bold
     let $Out = '"juego" que se contiene en el artículo 3.a) de la Ley 13/2011, de 27 de mayo, de Regulación del juego)'
     print $Out                                                                   (  , 6)  Bold

     alter-printer point-size=7 font={ARIAL}
     print 'Importe íntegro satisfecho'                                           (+1,80)

     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                              (  ,110)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones dinerarias .............................................................................................' ( +2, 10)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK3_Sal_Income, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK3_Sal_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,116)

     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                           (+1,57)
     print 'Ingresos a cuenta efectuados'                                         (  ,78)
     print 'Ingresos a cuenta repercutidos'                                       (  ,107)

     alter-printer point-size=7 font={ARIAL}
     print 'Contraprestaciones en especie.................................'       (+1, 10)

     graphic (-1,49,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK3_Ink_Income, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,58)

     graphic (-1,76,25) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK3_Ink_Withhld, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,85)

     graphic (-1,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     Do Format-Number(#KeyK3_Ink_Withhld2, $Out, 'B99,999,999.99')
     print $Out                                                                    (+1,116)


  !---- PART 5  Imputación de rentas por la cesión de derechos de imagen ----!

    alter-printer point-size=10 font={ARIAL}
    print 'Imputación de rentas por la cesión de derechos de imagen: contraprestaciones' (+3, 3)  Bold
    print 'a que se refiere el artículo 92.8 de la Ley del IRPF'                         (+1, 3)  Bold

    alter-printer point-size=10 font={ARIAL}
    print 'Datos correspondientes al ejercicio'                                   ( , 89)  Bold

    alter-printer point-size=10 font={ARIAL}
    graphic (,129,5) box 1 0 18
    print $Fiscal-Year                                                            ( ,129)  Bold


  !---- PART 5 (a) Contraprestaciones satisfechas e ingresos a cuenta efectuados  ----!

     graphic (+1,5,80) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Contraprestaciones satisfechas e ingresos a cuenta efectuados'        (+1, 6)  Bold

     graphic (+1,5,129) box 10 5
     alter-printer point-size=7 font={ARIAL}
     print 'Retenciones Practicadas'                                              (  ,110)

     alter-printer point-size=7 font={ARIAL}
     Let $Out = 'Contraprestaciones dinerarias ............................................................'
     Let $Out = $Out || '................................................................................................'
     print $Out                                                                   ( +2, 10)

     graphic (-2,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)

     alter-printer point-size=7 font={ARIAL}
     print 'Valoración'                                                           (+1,115)

     alter-printer point-size=7 font={ARIAL}
     Let $Out = 'Contraprestaciones en especie ............................................................'
     Let $Out = $Out || '..............................................................................................'
     print $Out                                                                   ( +2, 10)

     graphic (-2,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)

     alter-printer point-size=7 font={ARIAL}
     print 'Importe'                                                              (+1,116)

     alter-printer point-size=7 font={ARIAL}
     Let $Out = 'Ingresos a cuenta efectuados ............................................................'
     Let $Out = $Out || '................................................................................................'
     print $Out                                                                   ( +2, 10)

     graphic (-2,104,28) box 2 10
     alter-printer point-size=10 font={ARIAL}
     print ' '                                                                    (+1,116)


  !---- PART 6  Fecha y Firma ----!

     graphic (+3,5,19) box 2 5
     alter-printer point-size=10 font={ARIAL}
     print 'Fecha y firma'                                                        (+1, 6)  Bold


     graphic (+1,5,129) box 9 5
     alter-printer point-size=6 font={ARIAL}
     Let $LitWk = 'Para que conste y sirva de justificante al interesado, en cumplimiento '
     Let $LitWk = $LitWk || 'de lo dispuesto en el reglamento del Impuesto sobre la Renta de '
     Let $LitWk = $LitWk || 'las Personas Físicas, se expide la presente.'
     print $LitWk       ( , 6)

     graphic (  ,10 ,51) box 2 10
     graphic (  ,68 ,9) box 2 10
     graphic (  ,86 ,23) box 2 10
     graphic (  ,117,12) box 2 10

     print 'En '         (+1,   6)
     print 'A '          (  ,  65)
     print 'De '         (  ,  81)
     print 'De '         (  , 112)

     alter-printer point-size=10 font={ARIAL}
     print $Sign-City                                              ( ,12)

     alter-printer point-size=10 font={ARIAL}
     print #wkDays                                                 ( ,70)  EDIT 'b99'

     alter-printer point-size=10 font={ARIAL}
     evaluate #wkMonths
        when = 01
          move 'Enero'    to $MonthName
        when = 02
          move 'Febrero'  to $MonthName
        when = 03
          move 'Marzo'    to $MonthName
        when = 04
          move 'Abril'    to $MonthName
        when = 05
          move 'Mayo'     to $MonthName
        when = 06
          move 'Junio'    to $MonthName
        when = 07
          move 'Julio'    to $MonthName
        when = 08
          move 'Agosto'    to $MonthName
        when = 09
          move 'Septiembre'    to $MonthName
        when = 10
          move 'Octubre'    to $MonthName
        when = 11
          move 'Noviembre'    to $MonthName
        when = 12
          move 'Diciembre'    to $MonthName
     end-evaluate
     print $MonthName                                              ( ,88)

     alter-printer point-size=10 font={ARIAL}
     print #wkYears                                               ( ,119)  EDIT 'b9999'


     graphic (+1,8,68) box 5 10
     alter-printer point-size=7 font={ARIAL}
     print ' '                                                    ( ,106)

     print 'Firma y sello de la empresa o entidad pagadora '                                (  ,10)
     print 'Fdo: D/Dña  '                                                                   (+3,10)
     graphic (,19,55) horz-line
     print 'La presente certificación debera ser firmada por el retenedor, su apoderado'    (  ,78)
     print 'o su representante.'                                                            (  ,78)


end-procedure


!************************************************************************
! Procedure PRINT-RETRO-DATA
!************************************************************************
begin-procedure PRINT-RETRO-DATA
#debug do Fin-Debug-Msg('PRINT-RETRO-DATA')

#define RETROP_TABLE  4
#define RETRON_TABLE  3

alter-printer point-size=10 font={ARIAL}
Let #Arr_idx  = 0
Let #Arr_idxP = 0
Let #Arr_idxN = 0
While #Arr_idx < {RETRO_ARRAY_SIZE}

     GET $Year-Cd           FROM Arr_Year(#Arr_idx)
     GET #Arr_Amount1       FROM Arr_Amount(#Arr_idx)
     GET #Arr_WithHolding1  FROM Arr_WithHolding(#Arr_idx)
     GET #Arr_Reduction1    FROM Arr_Reduction(#Arr_idx)
     GET #Arr_Soc_Security1 FROM Arr_Soc_Security(#Arr_idx)

     If #Arr_Amount1 >= 0
       If #Arr_idxP < {RETROP_TABLE}
         print $Year-Cd                                              (#LINE_NoP,19) EDIT 'b9999'
         Do Format-Number(#Arr_Amount1, $Out, 'B99,999,999.99')
         print $Out                                                  ( ,38)
         Do Format-Number(#Arr_WithHolding1, $Out, 'B99,999,999.99')
         print $Out                                                  ( ,63)
         Do Format-Number(#Arr_Reduction1, $Out, 'B9,999,999.99')
         print $Out                                                  ( ,90)
         Do Format-Number(#Arr_Soc_Security1, $Out, 'B9,999,999.99')
         print $Out                                                  ( ,117)

         let #LINE_NoP = #LINE_NoP + 2
         Let #Arr_idxP = #Arr_idxP + 1
       End-if
     Else
       If #Arr_idxN < {RETRON_TABLE}
         print $Year-Cd                                              (#LINE_NoN,19) EDIT 'b9999'
         Do Format-Number(#Arr_Amount1, $Out, 'B99,999,999.99')
         print $Out                                                  ( ,38)
         Do Format-Number(#Arr_Reduction1, $Out, 'B9,999,999.99')
         print $Out                                                  ( ,63)

         let #LINE_NoN = #LINE_NoN + 2
         Let #Arr_idxN = #Arr_idxN + 1
       End-If
     End-if

     Let #Arr_idx = #Arr_idx + 1

End-While

end-procedure


!--------------------------------------------------------------------!
! Debug Msg                                                          !
!--------------------------------------------------------------------!
begin-procedure Fin-Debug-Msg($procedure_name)
   display ' '
   display '----------------------------------'
   display $procedure_name
   #debugt date-time () {Native-DateTime} &SysDateTime
   #debugt move &SysDateTime to $SysDateTime
   #debugt show 'TIMING, ' $procedure_name ', ' $SysDateTime
   display ' '
end-procedure ! Fin-Debug-Msg


!***************************************************************
!Include SQCs
!***************************************************************
#Include 'getsetid.sqc'
#Include 'readxlat.sqc'
#Include 'sqlerr.sqc'
#Include 'stdapi.sqc'    !Update Process API
#Include 'reset.sqc'     !Reset printer procedure
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#include 'datemath.sqc'  !Routines for date calculation
