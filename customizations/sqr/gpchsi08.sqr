!***********************************************************************
! GPCHSI08.SQR  :AHV YEAR (AHV-Lohnbescheinigung)                      *
!***********************************************************************
!                                                                      *
!                                                                      *
!                                                                      *
! This software and related documentation are provided under a         *
! license agreement containing restrictions on use and                 *
! disclosure and are protected by intellectual property                *
! laws. Except as expressly permitted in your license agreement        *
! or allowed by law, you may not use, copy, reproduce,                 *
! translate, broadcast, modify, license, transmit, distribute,         *
! exhibit, perform, publish or display any part, in any form or        *
! by any means. Reverse engineering, disassembly, or                   *
! decompilation of this software, unless required by law for           *
! interoperability, is prohibited.                                     *
! The information contained herein is subject to change without        *
! notice and is not warranted to be error-free. If you find any        *
! errors, please report them to us in writing.                         *
!                                                                      *
!
! Copyright (C) 1988, 2020, Oracle and/or its affiliates.              *
! All Rights Reserved.                                                 *
!----------------------------------------------------------------------
!
!       $Release:  HR92                                                !
!           $Bug:  31397357                                            !
!                                                                      *
!***********************************************************************

#include 'setenv.sqc'    ! set Default environment
#include 'gpchut10.sqc'  ! setenv override for Swiss Default.
#include 'gpchut12.sqc'  ! Substitution Variables Defined.
#include 'setup31.sqc'

#define col1   10            !Versichertennummer
#define col2   29            !Name/Vorname
#define col3   51            !Beschaeftigungszeit von
#define col4   63            !Beschaeftigungszeit bis
#define col4_1 74
#define col5   76            !AHV-Lohn
#define col6   94            !ALV1-Lohn
#define col7   112           !ALV2-Lohn

begin-setup


declare-layout report1
orientation = PORTRAIT
line-height=9
char-width=4.32
left-margin=.05
right-margin=.25
end-declare

declare-layout report2
orientation = PORTRAIT
line-height=9
char-width=4.32
left-margin=.05
right-margin=.25
end-declare

declare-report report1
layout = report1
end-declare

declare-report report2
layout = report2
end-declare
end-setup

!**********************************************************************************************
begin-PROGRAM
  do Init-DateTime
  do Init-Number
  do Get-Current-DateTime
  do Init-Report
show ' $GPCH_EG_YEP_FLG = ' $GPCH_EG_YEP_FLG ' $Run_Option = ' $Run_Option ' $Rpt_Type = ' $Rpt_Type
show ' $ptot_domaind = ' $ptot_domaind ' #ptot_domaind = ' #ptot_domaind 
   
If $GPCH_EG_YEP_FLG = 'Y' 
   
   If $Run_Option = 'Y'
     do Init_Statustbl
    do Get-Output-Directory('GPCHSI08',$Output_Directory,$prcs_no)
    do Process-Main
    do Process-Main1
    do Stdapi-Term
    do Get-Log
    Do Update_Status($Ctl_Year,#ptot_domainid,$Comp,$providertype,$Run_Option,$SysDateTime,$Cancel_option)
   else
 
      If $Cancel_Option = 'Y'
          do Cancle_YEA($ptot_requestid,$Ctl_Year,$comp,$providertype,#ptot_domainid)
          Do Update_Status($Ctl_Year,#ptot_domainid,$Comp,$providertype,$Run_Option,'',$Cancel_option)
      End-If
      ! ST Do Update_Status($Ctl_Year,$GPCH_EG_TRNS_SEQ,$Comp,$Type,$Run_Option,'')
      !Do Update_Status($Ctl_Year,#ptot_domainid,$Comp,$providertype,$Run_Option,'',$Cancel_option)
      do Stdapi-Term
      do Get-Log
   End-if
 Else
  
  do Get-Output-Directory('GPCHSI08',$Output_Directory,$prcs_no)
  do Process-Main
  do Process-Main1
  do Delete-Rec-tx011
  do Stdapi-Term
  do Get-Log
  end-if
end-PROGRAM
!**********************************************************************************************
begin-procedure Signature
use-report report1

let $Finish_Report = 'Y'
if #Zaehler_Zeilen <= 46

DO Format-Number(#Seiten_Total_AHV_Lohn, $Seiten_Total_AHV_Lohn,   '9,999,999,999.00')
DO Format-Number(#Gesamt_Total_AHV_Lohn, $Gesamt_Total_AHV_Lohn,   '9,999,999,999.00')
DO Format-Number(#Seiten_Total_ALV1_Lohn, $Seiten_Total_ALV1_Lohn, '9,999,999,999.00')
DO Format-Number(#Gesamt_Total_ALV1_Lohn, $Gesamt_Total_ALV1_Lohn, '9,999,999,999.00')

if $Error_List = 'N'
  DO Format-Number(#Seiten_Total_ALV2_Lohn, $Seiten_Total_ALV2_Lohn, '9,999,999,999.00')
  DO Format-Number(#Gesamt_Total_ALV2_Lohn, $Gesamt_Total_ALV2_Lohn, '9,999,999,999.00')
end-if

print $PAGE_TOTAL        (+2, {col2})  BOLD
print $Seiten_Total_AHV_Lohn     (,{col5})     BOLD
print $Seiten_Total_ALV1_Lohn     (,{col6})     BOLD

if $Error_List = 'N'
  print $Seiten_Total_ALV2_Lohn    (,{col7})     BOLD
end-if

print $TOTAL         (+2, {col2})  BOLD
print $Gesamt_Total_AHV_Lohn     (, {col5})    BOLD
print $Gesamt_Total_ALV1_Lohn     (, {col6})    BOLD
if $Error_List = 'N'
  print $Gesamt_Total_ALV2_Lohn    (, {col7})    BOLD
end-if

let #Seiten_Total_AHV_Lohn  = 0
let #Seiten_Total_ALV1_Lohn = 0

if $Error_List = 'N'
  let #Seiten_Total_ALV2_Lohn = 0
end-if
let #_LineCount = 0
end-if
end-procedure
!**********************************************************************************************
begin-procedure Init-Report
#debug show 'In Init-Report'
  let $Finish_Report = 'N'
  let $Error_List    = 'N'
  let $Error_Value   = 'N'
  let $company    = ''
  let $Ct_Year       = ''
  let $providertype ='7'   !SYED
  ! ST Let $Type = 'AHV Yearly'
  do Stdapi-Init
  if $prcs_process_instance = ''
     do ask-input
  else
     do Get-Report-Parameters
   
 if $GPCH_EG_YEP_FLG = 'Y'
     let $Provider_crit=' '
    do Get-PTotals-Data($Provider_crit,$providertype,#Domainid,$ptot_company,$ptot_year,#ptot_domainid,$ptot_providercd,$ptot_provtype,$ptot_requestid,$ptot_userkey) 
    do Check_Run_Report(#ptot_domainid,$Ctl_Year,$comp,$providertype,$Run_Option,$Cancel_option,$Rpt_Type)
   
 
       
    Let $LST_Interface = '1'
  
   end-if 
  end-if

  move 'GPCHSI08' to $ReportID
  do Init_Report_Translation($ReportID, $language_cd)
  do Append_Report_Translation('GPCHGLOB')
  do Append_Report_Translation('GPCHSI09')
  do Append_Report_Translation('GPCHAL01')

  do Gpce_Init_Report_Translation($ReportID, $language_cd)
  do Gpce_Append_Report_Translation('GPCHGLOB', $language_cd)
  do Gpce_Append_Report_Translation('GPCHSI09', $language_cd)
  do Gpce_Append_Report_Translation('GPCHAL01', $language_cd)

  do Report-Translation
  let $ReportTitle = $TITLE1 || ' '
  let $RepTit1     = ''
  let $RepTit1     = $ReportTitle || $Ct_Year
  let $RepTitList  = $ReportTitle || $Ct_Year
  let $ReportTitle = $RepTit1

  #debug show ' Report ID : ' $ReportID  ' ReportTitle : '  $ReportTitle
  if rtrim($Ct_Year,' ') <> ''
     let $CMP_Start_Dt = $Ct_Year || '01' || '01'
     let $CMP_End_Dt   = $Ct_Year || '12' || '31'

     do Format-DateTime($CMP_start_Dt, $ctl_start_dt, {DEFCMP}, '', 'native')
     do Format-DateTime($CMP_end_Dt, $ctl_end_dt, {DEFCMP}, '', 'native')
     do Format-DateTime($ctl_start_dt, $start_dt, {DEFCMP}, '', '')
     do Format-DateTime($ctl_end_dt, $end_dt, {DEFCMP}, '', '')
  end-if

  display ' From : '             noline
  display $ctl_start_dt          noline
  display ' To : '               noline
  display $ctl_end_dt


  move 0 to #Vol_Number
  move 0 to #RecordCount

  let $FileExtension = '.' || $OUTDESTFORM

  if $Ctl_Canton <> ''
           let $Ctl_Canton_Crit1          = ' AND SI08.STATE   = ''' || $Ctl_Canton || ''' '
           let $Ctl_Canton_Crit2          = ' AND SI081.STATE  = ''' || $Ctl_Canton || ''' '
           let $Ctl_Canton_Crit3          = ' AND SI08E.STATE  = ''' || $Ctl_Canton || ''' '
           let $Ctl_Canton_Crit4          = ' AND SI081E.STATE = ''' || $Ctl_Canton || ''' '
           let $Ctl_Canton_Crit5          = ' AND R.GPCH_TX_CANTON = ''' || $Ctl_Canton || ''' '
   else
           let $Ctl_Canton_Crit1          = ' '
           let $Ctl_Canton_Crit2          = ' '
           let $Ctl_Canton_Crit3          = ' '
           let $Ctl_Canton_Crit4         = ' '
           let $Ctl_Canton_Crit5          = ' '
    end-if
#debug show 'Out Init-Report'
end-procedure
!********************************************************************************************
begin-procedure Get_Canton_Name
let $Canton_NameR = ''

begin-select
STATENM.DESCR
  let $Canton_NameR = rtrim(&STATENM.DESCR,' ')
from PS_STATE_NAMES_TBL STATENM

where  STATENM.STATE = $Ctl_Canton and
       STATENM.COUNTRY = 'CHE'
end-select

end-procedure
!****************************************************************************
begin-procedure Open-File
  let $reportdir1 = $Output_Directory || 'GPCHSI08_' || $prcs_no

      #ifdef MVS
      let #pos  = instr($sqr-report,'GPCHSI08',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdir1 = $path || 'GPCHSI08(GPCHSI08)'
      #end-if

      #ifdef OS390
      let #pos  = instr($sqr-report,'GPCHSI08',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdir1 = $path || 'GPCHSI08(GPCHSI08)'

      #end-if

      #ifdef OS400
      let #pos  = instr($sqr-report,'GPCHSI08',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdir1 = $path || 'GPCHSI08(GPCHSI08)'
      #end-if


   Use-Report report1
   New-report $reportdir1

  alter-printer
    point-size=7.2
  !-----------------------------------------------------------------------
  let $reportdir2 = $Output_Directory || 'DATAAHVT_' || $prcs_no

      #ifdef MVS
      let #pos  = instr($sqr-report,'GPCHSI08',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdir2 = $path || 'GPCHSI08(DATAAHVT)'
      #end-if

      #ifdef OS390
      let #pos  = instr($sqr-report,'GPCHSI08',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdir2 = $path || 'GPCHSI08(DATAAHVT)'

      #end-if

      #ifdef OS400
      let #pos  = instr($sqr-report,'GPCHSI08',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdir2 = $path || 'GPCHSI08(DATAAHVT)'
      #end-if


   Use-Report report2
   New-report $reportdir2
   !----------------------------------------------------------------------
   !let $reportdir3 = $Output_Directory || 'DATAAHV.DAT' ! oracle / Mss
   let $reportdir3 = $Output_Directory || 'DATAAHV_' || $prcs_process_instance || '.DAT'

   #ifdef MVS
   let $reportdir3 =  'DATAAHV'                            ! MVS/ OS390 etc...
   #end-if

   #ifdef OS390
   let $reportdir3 =  'DATAAHV'                            ! MVS/ OS390 etc...
   #end-if

   #ifdef OS400
   let $reportdir3 =  'DATAAHV'                            ! MVS/ OS390 etc...
   #end-if

   open $reportdir3 as 10 for-writing record=128:FIXED

end-procedure
!********************************************************************************************
begin-procedure Write-File

  do DTA-Detail-Record
  add 1 to #RecordCount

end-procedure
!********************************************************************************************
begin-procedure dTA-Detail-Record
#debug show 'In dTA-Detail-Record'

let $X6   = $mmY2B
let $X7   = $mmY2E

let $X1   = 'Y2'

if rtrim($Nation_ID, ' ') = ''
  let $E_Name1 = ltrim(rtrim($E_Name,' '), ' ')
  let $E_Name2 = translate($E_Name1, ',',' ')

  let $E_Name2 = rtrim(ltrim($E_Name2,' '), ' ')
  let $X2   = $E_Name2
else
  let $X2   = $Nation_ID
end-if

let $X3   =  '    '

!FMB 20060314 Initialise values with default here to allow override
let $X4   = '00'
!Reset $Char_05 if it was set due to $Char_04
If $Char_04 = '01'
  let $X5   = '01'
Else 
let $X5   = $Char_05
End-If
let $X15   = $Char_07

let $X8   = $BJ
!
let #AHV_Lohn_F  = #AHV_Lohn
let #ALV1_Lohn_F = #ALV1_Lohn
let #ALV2_Lohn_F = #ALV2_Lohn
let #Amount_7_F  = #Amount_7
let #Amount_8_F  = #Amount_8

!FMB20070605 new temps for XML
let #AHV_Lohn_xml  = #AHV_Lohn
let #AHV_Free_xml = #Amount_7
let #ALV_Lohn_xml = #ALV1_Lohn
let #ALVZ_Lohn_xml = #ALV2_Lohn
let #ALV_Free_xml = #Amount_8


!FMB20070817 new temps for XML Totals

let #AHV_Lohn_xml_Tot  = #AHV_Lohn_xml_Tot + #AHV_Lohn
let #AHV_Free_xml_Tot = #AHV_Free_xml_Tot  + #Amount_7
let #ALV_Lohn_xml_Tot = #ALV_Lohn_xml_Tot + #ALV1_Lohn
let #ALVZ_Lohn_xml_Tot = #ALVZ_Lohn_xml_Tot + #ALV2_Lohn
let #ALV_Free_xml_Tot = #ALV_Free_xml_Tot + #Amount_8

!#debug show ' FMB free amounts $E_ID = ' $E_ID '#AHV_Free_xml = ' #AHV_Free_xml ' #ALV_Free_xml = ' #ALV_Free_xml

if #AHV_Lohn < 0
  let #AHV_Lohn_F = -1 * #AHV_Lohn
  !FMB 20060314 – Sedebug show ' $ddY2Et Keys in case of negative payment. As we have the keys only ones per row, 
  !they need to follow the     !AHV-payment (#AHV_Lohn)
  let $X4   = '01'
  let $X5   = '06'
  let $X15  = '99'

end-if

if #ALV1_Lohn < 0
   let #ALV1_Lohn_F = -1 * #ALV1_Lohn
end-if

if #ALV2_Lohn < 0
   let #ALV2_Lohn_F = -1 * #ALV2_Lohn
end-if

if #Amount_8 < 0
   let #Amount_8_F = -1 * #Amount_8
end-if

LET #AHV_free_Amount = 0
 LET #ALV1_free_Amount = 0

 #debug show ' $ddY2E 4  $E_ID = ' $E_ID '$ddY2E = ' $ddY2E  ' $E_Date = ' $E_Date  ' $yyt1 = '  $yyt1 ' $mmt1 = ' $mmt1 ' $ddt1 = ' $ddt1

 #debug show ' FMB 20100922 $X8 = ' $X8 '$B_Date = ' $B_Date
 
!FMB 20100922
! we need to prepare this: Let $From_Date = $X8 ||'-' || $x6 || '-' || $ddY2B
      
  If $X8 < $Ct_Year
     do ConvertToComponents($B_Date, $yyP, $mmP, $ddY2B)
     if $yyP < $X8
       let $X6    = '01'
       let $ddY2B = '01'
     else
       let $X6 = $mmP
     End-If 
  End-If
 
  if $GPCH_EG_YEP_FLG = 'Y'  
    Do Employee_Data_XML
  end-if

let  #AHV_Lohn_F  = #AHV_Lohn_F * 100
let  #ALV1_Lohn_F = #ALV1_Lohn_F * 100
let  #ALV2_Lohn_F = #ALV2_Lohn_F * 100
let  #Amount_8_F  = #Amount_8_F * 100

move #AHV_Lohn_F  to $X9  00000000000
move #ALV1_Lohn_F to $X10 00000000000
move #ALV2_Lohn_F to $X11 00000000000
move #Amount_8_F  to $X12 00000000000

let $X13   = $EndDateInterf
let $X14   = $Char_06
!FMB 20060314 - $X15 get's now populated earlier with default, to allow override
if rtrim($Nation_ID, ' ') = ''
  let $X15   = '99'
end-if
let $X16a   = LPAD($AHV_MBR_ID,6,'0')
let $X16b   = $Ct_Year
move #Serial_NBR to $X16c 00
let $X17   = ' '
if $GPCH_EG_YEP_FLG = 'N'
write 10 from $X1:2 $X2:11 $X3:4 $X4:2 $X5:2 $X6:2 $X7:2 $X8:4 $X9:11 $X10:11 $X11:11 $X12:11
              $X13:8 $X14:1 $X15:2 $X16a:6 $X16b:4 $X16c:2 $X17:32
end-if
end-procedure
!**********************************************************************************************
begin-procedure Employee_Data_XML
#debug show 'in Employee_Data_XML'

  ! NOTE $ct_year and $ptot_year will be same 

    DO Format-Number(#AHV_Lohn_xml,$AHV_Lohn_F,'888888888888.00')
    DO Format-Number(#AHV_Free_XML,$AHV_Free_F,'888888888888.00')
    DO Format-Number(#ALV_Lohn_xml,$ALV_Lohn_F,'888888888888.00')
    DO Format-Number(#ALVZ_Lohn_xml,$ALVZ_Lohn_F,'888888888888.00')
    DO Format-Number(#ALV_Free_XML, $ALV_Free_F,'888888888888.00')

   ! ST DO Format-Number(#GPCH_EG_TRNS_SEQ, $GPCH_EG_TRNS_SEQ, '88')

!   do ConvertToComponents($E_Date, $yyt1, $mmt1, $ddt1)
   
!     IF $yyt1 <> $Ct_Year and $yyt1 <> ' ' and $yyt1 <> ''
!       Let $XML_Year = $yyt1
!    Else 
!       Let $XML_Year = $Ct_Year
!    End-if

    
    
    
!    Let $From_Date = $XML_Year  ||'-' || $X6 || '-01'
!    Let $To_Date = $XML_Year  ||'-' || $X7 || '-31'
!    if $X7='02'
!      if $XML_Year ='2000' or $XML_Year ='2004'or $XML_Year ='2008' or $XML_Year ='2012'
!    Let $To_Date = $XML_Year  ||'-' || $X7 || '-29'
!   else 
!    Let $To_Date = $XML_Year  ||'-' || $X7 || '-28'
!     end-if
!end-if
!   if $X7='04' or $X7='06' or $X7='09' or $X7='11'
!    Let $To_Date = $XML_Year  ||'-' || $X7 || '-30'
!   end-if

 #debug show ' $ddY2E 0  $E_ID = ' $E_ID '$ddY2E = ' $ddY2E  ' $E_Date = ' $E_Date '$B_Date = ' $B_Date
 !FMB 20120615
    let $x6    = substr($x6,1,2)
    let $x7    = substr($x7,1,2)
    let $x8    = substr($x8,1,4)
    let $ddY2B = substr($ddY2B,1,2)
    let $ddY2E = substr($ddY2E,1,2)

!FMB 20070212
    Let $From_Date = $X8 ||'-' || $x6 || '-' || $ddY2B

! 31397357 If To_Date < From_Date THEN To_Date = 'XXXX-12-31'  (Please adjust the month as well and consider last dayOfMonth)
  if $x7 < $x6
     Let $To_Date = $X8 ||'-' || $x6 || '-' || edit(dateadd(dateadd(strtodate($X8 ||'/' || $x6 || '/' || '01', 'YYYY/MM/DD'), 'month', 1), 'day', -1), 'DD')
  else
     Let $To_Date = $X8 ||'-' || $x7 || '-' || $ddY2E
  end-if
 Let $AccountingTime_Tag = '<AccountingTime>' || '<from>' || $From_Date || '</from>' || '<until>' 
 || $To_Date || '</until>' || '</AccountingTime>'

 Let $AHV-AVS-Income_Tag = '<AHV-AVS-Income>' || $AHV_Lohn_F || '</AHV-AVS-Income>'
 If substr($AHV_Free_F, 1,4) <> '0.00'
  Let $AHV-AVS-Open = '<AHV-AVS-Open>' || $AHV_Free_F || '</AHV-AVS-Open>'
 Else 
  Let $AHV-AVS-Open = ''
 End-IF
 Let $ALV-AC-Income_tag = '<ALV-AC-Income>' || $ALV_Lohn_F || '</ALV-AC-Income>'
 If substr($ALVZ_Lohn_F, 1,4) <> '0.00'
 Let $ALVZ-ACS-Income_tag = '<ALVZ-ACS-Income>' || $ALVZ_Lohn_F || '</ALVZ-ACS-Income>'
 Else 
  Let $ALVZ-ACS-Income_tag = ''
 End-IF
 If substr($ALV_Free_F,1,4) <> '0.00' 
 Let $ALV-AC-Open = '<ALV-AC-Open>' || $ALV_Free_F || '</ALV-AC-Open>'
 Else 
  Let $ALV-AC-Open = ''
 End-IF

!FMB 20070124 - Begin

 If substr($AHV_Lohn_F, 1,4)  <> '0.00' or substr($AHV_free_Amount, 1,4) <> '0.00' 
 or substr($ALV1_Lohn_F, 1,4) <> '0.00' or substr($ALV2_Lohn_F, 1,4) <> '0.00' 
 or substr($ALV1_free_Amount, 1,4) <> '0.00' 
   let #counter=#counter+1

!FMB 20070124 - End

 If $E_ID <> $E_ID_Processed
  Let $AHV-AVS-Salary_Tag = ''
 End-If
 
!FMB 20120530
 If $Rpt_Type = 'Y'
   Let $AHV-AVS-Salary_Tag = $AHV-AVS-Salary_Tag || '<AHV-AVS-Salary institutionIDRef='||'"'||$ptot_providercd||'">'
   ||$AccountingTime_Tag || $AHV-AVS-Income_Tag ||$AHV-AVS-Open || $ALV-AC-Income_tag || $ALVZ-ACS-Income_tag 
   || $ALV-AC-Open ||'</AHV-AVS-Salary>'

 Else
   Let $AHV-AVS-Income_Tag  = '<AHV-AVS-Income>0.00</AHV-AVS-Income>'
   let $ALV-AC-Income_tag   = '<ALV-AC-Income>0.00</ALV-AC-Income>'
   
   If $MutationE = 'Entry'
     Let $DeclarationCategoryE = '<DeclarationCategory>' || '<Entry><ValidAsOf>' || $ValidAsOfE || '</ValidAsOf></Entry>' || '</DeclarationCategory>'
     Let $AccountingTime_Tag   = '<AccountingTime>'      || '<from>'             || $ValidAsOfE || '</from>'              || '<until>' || $ValidAsOfE || '</until>' || '</AccountingTime>' 
   End-If
 
   If $MutationW = 'Withdrawal'
     Let $DeclarationCategoryW = '<DeclarationCategory>' ||'<Withdrawal><ValidAsOf>' || $ValidAsOfW || '</ValidAsOf></Withdrawal>' || '</DeclarationCategory>'
     Let $AccountingTime_Tag   = '<AccountingTime>'      || '<from>'                 || $From_Date  || '</from>'                   || '<until>' || $To_Date || '</until>' || '</AccountingTime>' 
   End-If 
        
   Let $AHV-AVS-Salary_Tag = $AHV-AVS-Salary_Tag || '<AHV-AVS-Salary institutionIDRef='||'"'||$ptot_providercd||'">'
   || $DeclarationCategoryW || $DeclarationCategoryE 
   || $AccountingTime_Tag   || $AHV-AVS-Income_Tag || $ALV-AC-Income_tag || '</AHV-AVS-Salary>'
   
 End-If

 Let $AHV-AVS-Salaries_Tag = '<AHV-AVS-Salaries>' || $AHV-AVS-Salary_Tag || '</AHV-AVS-Salaries>'
 
 Let $MutationE            = ' '
 Let $MutationW            = ' '
 Let $DeclarationCategoryE = ' '
 Let $DeclarationCategoryW = ' '
 Let $ValidAsOfE           = ' '
 Let $ValidAsOfW           = ' ' 

 Do Insert_Employee_Data_XML
 
!  Let $E_ID_Processed = $E_ID

!FMB 20070124 - Begin

 End-if
!FMB 20070124 - End  
  

end-procedure

!**********************************************************************************************
Begin-Procedure Insert_Employee_Data_XML
#debug show 'in Insert_Employee_Data_XML'
 
 !FMB 20090103
 let #ptot_year = $ptot_year 


Begin-Sql on-error=give_warning

 DELETE FROM PS_GPCH_EG_PERSON WHERE  GPCH_EG_DOMAINID= #ptot_domainid AND GPCH_SI_PROV_CD=$ptot_providercd 
 AND GPCH_RC_PAY_YEAR = #ptot_year AND COMPANY = $ptot_company AND  EMPLID = $E_ID 
 AND GPCH_SI_PROV_TYPE=$providertype

End-SQL

#debug Show ' $E_ID = ' $E_ID '$AHV_Lohn_F = ' $AHV_Lohn_F ' $ALV1_Lohn_F = ' $ALV1_Lohn_F   
 
  Let $E_ID_Processed = $E_ID
  Let #E_RCD_Processed = #E_RCD

  Begin-Sql on-error=give_warning

 Insert into PS_GPCH_EG_PERSON (GPCH_EG_DOMAINID,GPCH_RC_PAY_YEAR,COMPANY,GPCH_SI_PROV_TYPE,
 GPCH_SI_PROV_CD,EMPLID,EMPL_RCD,BEGIN_DT,END_DT,GPCH_IF_VER,GPCH_EG_PRSN_XML) 
 values (#ptot_domainid,#ptot_year,$ptot_company,$ptot_provtype,$ptot_providercd,$E_ID,#E_RCD,
 $PAY_BGN_DT,$Ctl_End_Dt,1,$AHV-AVS-Salaries_Tag)

End-SQL

End-procedure
!**********************************************************************************************

begin-procedure DTA-End-Record
let $HeadingType      = '0'
let $X1        = 'Y1'
let $X2a        = LPAD($AHV_MBR_ID,6,'0')

!FMB 20090103
let #Ct_Year = $Ct_Year
!let $X2b        = $Ct_Year
let $X2b        = #Ct_Year

move #Serial_NBR    to $X2c   00
!
let #Total_Amount4_xml= #Total_Amount4
let #Total_Amount5_xml=#Total_Amount5
if #Total_Amount4 < 0
  let #Total_Amount4_F = -1 * #Total_Amount4
else
  let #Total_Amount4_F = #Total_Amount4
end-if

if #Total_Amount5 < 0
  let #Total_Amount5_F = -1 * #Total_Amount5
else
  let #Total_Amount5_F = #Total_Amount5
end-if

if #Total_Amount6 < 0
  let #Total_Amount6_F = -1 * #Total_Amount6
else
  let #Total_Amount6_F = #Total_Amount6
end-if

if #Total_Amount8 < 0
  let #Total_Amount8_F = -1 * #Total_Amount8
else
  let #Total_Amount8_F = #Total_Amount8
end-if
Let #SI09_AHV_FreeAmount = 0
 Let #SI09_ALV1_FreeAmount =0

 
  If $GPCH_EG_YEP_FLG = 'Y'

    do Create-Company-total
   
  End-If

let #Total_Amount4_F = #Total_Amount4_F * 100
let #Total_Amount5_F = #Total_Amount5_F * 100
let #Total_Amount6_F = #Total_Amount6_F * 100
let #Total_Amount8_F = #Total_Amount8_F * 100

move #Total_Amount4_F to $X3    0000000000000
move #Total_Amount5_F to $X4    0000000000000
move #Total_Amount6_F to $X5    0000000000000
move #Total_Amount8_F to $X6    0000000000000

!let #Total_Amount10_F  = #Total_Amount4_F  * #SI_TOT_AHV_PC / 100
!let #Total_Amount11_F  = #Total_Amount5_F  * #SI_TOT_ALV1PC / 100
!let #Total_Amount12_F  = #Total_Amount6_F  * #SI_TOT_ALV2PC / 100

!let #AHV_Assignm = #Total_Amount4  * #SI_TOT_AHV_PC / 100

move #Total_Amount10_F   to $X7 00000000000
move #Total_Amount11_F   to $X8 00000000000
move #Total_Amount12_F   to $X9 00000000000


move #RecordCount to $X10 000000

if $Adjusting_DT <> ''
  do ConvertToComponents($Adjusting_DT,$yyt0,$mmt0,$ddt0)
  let $Adjus = $yyt0 || $mmt0 || $ddt0
  move $Adjus to $X11
else
  do ConvertToComponents($AsOfToday,$yyt0,$mmt0,$ddt0)
  let $Adjus = $yyt0 || $mmt0 || $ddt0
  move $Adjus to $X11
end-if

let $X12 =  '              '
let $X13 = ' '
if $GPCH_EG_YEP_FLG = 'N'
write 10 from $X1:2 $X2a:6 $X2b:4 $X2c:2 $X3:13 $X4:13 $X5:13 $X6:13 $X7:11 $X8:11 $X9:11 $X10:6
              $X11:8 $X12:14 $X13:1

do Write-Diskette-Statement
end-if
let $HeadingType = '1'

end-procedure
!*********************************************************************************************
begin-procedure Create-Company-total

!FMB20070817 new temps for XML Totals

!#debug show ' FMB free amounts $E_ID = ' $E_ID '#AHV_Free_xml = ' #AHV_Free_xml ' #ALV_Free_xml = ' #ALV_Free_xml

! FMB 20120530
 If $Rpt_Type <> 'Y'
   let #AHV_Lohn_xml_Tot  = 0.00
   let #AHV_Free_xml_Tot  = 0.00
   let #ALV_Lohn_xml_Tot  = 0.00
   let #ALVZ_Lohn_xml_Tot = 0.00
   let #ALV_Free_xml_Tot  = 0.00
 End-If

    DO Format-Number(#AHV_Lohn_xml_Tot, $AHV_Lohn_xml_Tot, '888888888888.00')
    DO Format-Number(#AHV_Free_xml_Tot, $AHV_Free_xml_Tot, '888888888888.00')
    DO Format-Number(#ALV_Lohn_xml_Tot, $ALV_Lohn_xml_Tot, '888888888888.00')
    DO Format-Number(#ALVZ_Lohn_xml_Tot, $ALVZ_Lohn_xml_Tot, '888888888888.00')
    DO Format-Number(#ALV_Free_xml_Tot, $ALV_Free_xml_Tot, '888888888888.00')

    DO Format-Number(#ptot_domainid, $ptot_domainid, '888')   
   
   lET $AHV-AVS-Incomes = '<Total-AHV-AVS-Incomes>' || $AHV_Lohn_xml_Tot || '</Total-AHV-AVS-Incomes>'
   lET $AHV-AVS-Open = '<Total-AHV-AVS-Open>' || $AHV_Free_xml_Tot || '</Total-AHV-AVS-Open>'
   let $ALV-AC-Incomes = '<Total-ALV-AC-Incomes>' || $ALV_Lohn_xml_Tot || '</Total-ALV-AC-Incomes>'
   let $ALVZ-ACS-Incomes = '<Total-ALVZ-ACS-Incomes>' || $ALVZ_Lohn_xml_Tot ||'</Total-ALVZ-ACS-Incomes>'
   let $ALV-AC-Open = '<Total-ALV-AC-Open>' || $ALV_Free_xml_Tot || '</Total-ALV-AC-Open>'

   let $AHV-AVS-Totals = '<AHV-AVS-Totals institutionIDRef='||'"'||$ptot_providercd||'" >'|| $AHV-AVS-Incomes || $AHV-AVS-Open || $ALV-AC-Incomes 
   || $ALVZ-ACS-Incomes  || $ALV-AC-Open || '</AHV-AVS-Totals>'


!    DO Format-Number(#Gesamt_Total_AHV_Lohn, $SI09_AHV_FreeAmount, '888888888888.00')
!    DO Format-Number(#Gesamt_Total_ALV1_Lohn, $SI09_ALV1_FreeAmount, '888888888888.00')
!    DO Format-Number(#ptot_domainid, $ptot_domainid, '88')

!   DO Format-Number(#Total_Amount4_xml, $Total_Amount4_F, '888888888888.00')
!   DO Format-Number(#Total_Amount5_xml, $Total_Amount5_F, '888888888888.00')

    
   
!   lET $AHV-AVS-Incomes = '<Total-AHV-AVS-Incomes>' || $Total_Amount4_F || '</Total-AHV-AVS-Incomes>'
!   lET $AHV-AVS-Open = '<Total-AHV-AVS-Open>' || $SI09_AHV_FreeAmount || '</Total-AHV-AVS-Open>'
!   let $ALV-AC-Incomes = '<Total-ALV-AC-Incomes>' || $Total_Amount5_F || '</Total-ALV-AC-Incomes>'
!   let $ALVZ-ACS-Incomes = '<Total-ALVZ-ACS-Incomes>' ||'0.00' ||'</Total-ALVZ-ACS-Incomes>'
!   let $ALV-AC-Open = '<Total-ALV-AC-Open>' || $SI09_ALV1_FreeAmount || '</Total-ALV-AC-Open>'

!   let $AHV-AVS-Totals = '<AHV-AVS-Totals institutionIDRef='||'"'||$ptot_providercd||'" >'|| $AHV-AVS-Incomes || 
!$AHV-AVS-Open || $ALV-AC-Incomes || $ALVZ-ACS-Incomes  || $ALV-AC-Open || '</AHV-AVS-Totals>'
!FMB 20090103
 #debug show ' $ptot_year = ' $ptot_year
let #ptot_year = $ptot_year 
 

 Begin-Sql on-error=give_warning

DELETE FROM PS_GPCH_EG_PTOTALS WHERE GPCH_SI_PROV_TYPE = '7' AND GPCH_SI_PROV_CD=$ptot_providercd  AND GPCH_RC_PAY_YEAR = #ptot_year AND COMPANY = $ptot_company  
AND GPCH_EG_REQUEST_ID=$ptot_requestid AND GPCH_EG_DOMAINID = #ptot_domainid

End-SQL


!FMB 20090103 #ptot_year and #ptot_domainid

Begin-Sql on-error=give_warning

 Insert into PS_GPCH_EG_PTOTALS (COMPANY,GPCH_RC_PAY_YEAR,GPCH_EG_DOMAINID,GPCH_EG_REQUEST_ID,GPCH_SI_PROV_TYPE,GPCH_SI_PROV_CD,GPCH_EG_USERKEY,GPCH_EG_CMP_XML) 
 values ($ptot_company,#ptot_year,#ptot_domainid,$ptot_requestid,'7',$ptot_providercd,'X',$AHV-AVS-Totals)

End-SQL


end-procedure
!**********************************************************************************************
begin-procedure Write-Diskette-Statement
 use-report report2
 let #Total_Amount_ALV = #Total_Amount5 + #Total_Amount6
 DO Format-Number(#AHV_Assignm, $AHV_Assignm1, '888,888,888,888.00')
 DO Format-Number(#Total_Amount4, $Total_Amount4, '888,888,888,888.00')
 DO Format-Number(#Total_Amount_ALV, $Total_Amount_ALV1, '888,888,888,888.00')

 if $Adjusting_DT <> ''
  do Format-DateTime($Adjusting_DT, $AsOfToday1, {DEFDATE}, '', '')
 else
  do Format-DateTime($AsOfToday, $AsOfToday1, {DEFDATE}, '', '')
 end-if

 print '_'             (,10,118) fill
 print $FOR_YEAR_STR   (+1,10)
 print $Ct_Year        (,{col3})
 print $BILLING_NR     (+2,10)
 print $AHV_MBR_ID     (,{col3})
 print $AHV_Ass_Str    (+2,10)
 !print $AHV_Assignm1   (,{col3})

 print $AHV_Str        (+2,10)
 print $Total_Amount4  (,{col3})

 print $ALV_Ass_Str       (+2,10)
 print $Total_Amount_ALV1     (,{col3})

 print $COUNT_DATASET_STR     (+2,10)
 print #RecordCount      (,{col3}) edit 888888
 print $CREATION_DATE_STR     (+2,10)
 print $AsOfToday1            (,{col3})
 print '_'             (+1,10,118) fill
end-procedure
!**********************************************************************************************
begin-procedure Process-Main
#debug show ' Process-Main In '
do Get_Canton_Name
do Get_Type_Options($Name_Type,$Addr_Type,$Phone_Type,$Email_Type,$BirthName_Type,$Security_Type)
let $HeadingType    = '0'
let $Exist_Data    = 'N'
let #Total_Amount4    = 0
let #Total_Amount5    = 0
let #Total_Amount6    = 0
let #Total_Amount7    = 0
let #Total_Amount8    = 0
let #Total_Amount10   = 0
let #Total_Amount11   = 0
let #Total_Amount12   = 0

If $GPCH_EG_YEP_FLG = 'N'
   do Open-File
 end-if

   do Get-Company-Address($comp,$ctl_end_dt,$language_cd,$Cpline1,$Cpline2,$Cpline3,$Cpline31,
                          $Cpline4,$Cpline5,$Cpline6,$Cpdescr,$Cpdescrshrt,$Cpcity,$Cpstate,$Cppostal,$CpBusn_Phone,$CpFax_Phone,$CpOtr_Phone)

   do Get_Fak_Tax_Data('NA',$Ctl_Com,$ctl_end_dt,
                       $Fak_Language,$Employer_Fak_Nbr,#Employer_Fak_Pct,
                       $Tax_Language,$Employer_StaxNr,#Staxb_PCTR,
                       #Employer_SI_Pct,$AHV_MBR_ID,$SI_AHV_PROVCD,
                       $KK,#COM_AHV_ADM_COST,#SI_TOT_AHV_PC,
                       #SI_TOT_ALV1PC,#SI_TOT_ALV2PC)

 let $SPRV_TYPE = '7'
 let $SPRV_CD   = '#AHV'
 let $SPRV_CANTON = ' '
 let $SPRV_ALL = ' '

 do Get-MBR-ID

 let $AHV_MBR_ID = $MBR_ID


let #LineCount         = 0
let #MerkLine          = 1
let $Mess_Number       = ''
let $ItExistedErr       = 'N'
let #Seiten_Total_AHV_Lohn  = 0
let #Gesamt_Total_AHV_Lohn  = 0
let #Seiten_Total_ALV1_Lohn = 0
let #Gesamt_Total_ALV1_Lohn = 0
let #Seiten_Total_ALV2_Lohn = 0
let #Gesamt_Total_ALV2_Lohn = 0
let #Merk_Birthday_National = 1
let $Nat_Id_Null = 'Y'
!--------------------------------!
let #firstRow = 0
let $E_ID = ''
let #E_RCD = 0
let $B_Date = ''
let $E_Date = ''
let #Amount_4_Old        = 0
let #Amount_5_Old        = 0
let #Amount_6_Old        = 0
let #Amount_8_Old        = 0
let #Amount_10_Old       = 0
let #Amount_11_Old       = 0
let #Amount_12_Old       = 0

let #Amount_4x        = 0
let #Amount_5x        = 0
let #Amount_6x        = 0
let #Amount_8x        = 0
let #Amount_10x       = 0
let #Amount_11x       = 0
let #Amount_12x       = 0
!--------------------------------!
Let #Count = 0


#debug show ' FMB before insert GPCHTX011_TMP'

 ! Reading Employees from Grid + Group List
 let #count_Emplid = 0
 do Get-Emplid-Count
  if #count_Emplid or #GrpLst <> 0
     let $AND_Emplid_SubSelection = ' AND R.EMPLID IN ( ' || $Emplid-String || ')'
  else
     let $AND_Emplid_SubSelection = ' '
  end-if
  


! FMB 20120530
#debug show ' FMB $ctl_start_dt = ' $ctl_start_dt ' $ctl_end_dt = ' $ctl_end_dt ' $Ctl_Curr_Pay_End_Dt = ' $Ctl_Curr_Pay_End_Dt ' #Domainid  = ' #Domainid 

If $Rpt_Type = 'Y'

Begin-Sql on-error=give_warning
INSERT INTO PS_GPCHTX011_TMP(PROCESS_INSTANCE,GPCH_TX_CANTON,EMPLID,CAL_RUN_ID,EMPL_RCD,GP_PAYGROUP,CAL_ID,
RSLT_SEG_NUM,GPCH_TX_VILLAGE_CD,GPCH_TX_TRF_TYPE,GPCH_TX_TRF_CD,PRD_END_DT,GPCH_AL_CPAY_ENDDT,SEG_BGN_DT,
SEG_END_DT,SLICE_END_DT,BEGIN_DT,END_DT,BIRTHDATE,HIRE_DT,TERMINATION_DT,PAY_ENTITY,COMPANY,CITY,POSTAL,
ACTION,MAR_STATUS,NATIONAL_ID,GPCH_AH_NNSS,GPCH_TX_CHRCH,SEX,COUNTRY_FROM,SPOUSE_NAME,GPCH_TX_SPOUSE_WL,GPCH_RP_AMOUNT1,
GPCH_RP_AMOUNT2,GPCH_RP_AMOUNT3,GPCH_RP_AMOUNT9,GPCH_RP_AMOUNT11,GPCH_RP_AMOUNT14,GPCH_RP_AMOUNT15,GPCH_RP_AMOUNT19,
GPCH_RP_AMOUNT20,GPCH_RP_AMOUNT21,GPCH_RP_AMOUNT22,GPCH_RP_AMOUNT26,GPCH_RP_AMOUNT27,VISA_PERMIT_TYPE,CONTRACT_TYPE,REG_TEMP,
GPCH_RP_CHAR03,GPCH_RP_FROMDT1)
#ifdef ORACLE
SELECT /*+ INDEX(R PS_GPCH_RP_0001)*/
#else
SELECT
#endif

[$prcs_process_instance],R.GPCH_TX_CANTON,R.EMPLID,R.CAL_RUN_ID,R.EMPL_RCD,R.GP_PAYGROUP,R.CAL_ID
,R.RSLT_SEG_NUM,R.GPCH_TX_VILLAGE_CD,R.GPCH_TX_TRF_TYPE,R.GPCH_TX_TRF_CD,R.PRD_END_DT
,R.GPCH_AL_CPAY_ENDDT,R.SEG_BGN_DT,R.SEG_END_DT,R.SLICE_END_DT,R.BEGIN_DT,R.END_DT,R.BIRTHDATE
,R.HIRE_DT,R.TERMINATION_DT,R.PAY_ENTITY,R.COMPANY,R.CITY,R.POSTAL,R.ACTION,R.MAR_STATUS
,R.NATIONAL_ID,R.GPCH_AH_NNSS,R.GPCH_TX_CHRCH,R.SEX,R.COUNTRY_FROM,R.SPOUSE_NAME,R.GPCH_TX_SPOUSE_WL
,R.GPCH_RP_AMOUNT1,R.GPCH_RP_AMOUNT2,R.GPCH_RP_AMOUNT3,R.GPCH_RP_AMOUNT9,R.GPCH_RP_AMOUNT11,R.GPCH_RP_AMOUNT14
,R.GPCH_RP_AMOUNT15,R.GPCH_RP_AMOUNT19,R.GPCH_RP_AMOUNT20,R.GPCH_RP_AMOUNT21,R.GPCH_RP_AMOUNT22
,R.GPCH_RP_AMOUNT26,R.GPCH_RP_AMOUNT27,R.VISA_PERMIT_TYPE,R.CONTRACT_TYPE,R.REG_TEMP,R.GPCH_RP_CHAR03,R.GPCH_RP_FROMDT1
FROM PS_GPCH_RP_0001 R
                             WHERE R.PAY_ENTITY         = $comp
                             and   R.PRD_END_DT between $ctl_start_dt and $ctl_end_dt
                             and   R.EMPL_RCD = R.GPCH_MC_LEGAL_RCD
                             and  R.SLICE_END_DT = (select max(R1.SLICE_END_DT) from PS_GPCH_RP_0001 R1
                                                    where R.EMPLID = R1.EMPLID
                                                    and R.EMPL_RCD = R1.EMPL_RCD                                                    
                                                    and R.COMPANY = R1.COMPANY 
                                                    and R1.SLICE_END_DT <= $ctl_end_dt
                                                    and   R1.GPCH_AL_CPAY_ENDDT = (select max(R2.GPCH_AL_CPAY_ENDDT) 
                                                        from PS_GPCH_RP_0001 R2
                                                        where R1.EMPLID = R2.EMPLID 
                                                        and R2.EMPL_RCD = R2.GPCH_MC_LEGAL_RCD 
                                                        and R1.GP_PAYGROUP = R2.GP_PAYGROUP
                                                        and  R1.CAL_ID = R2.CAL_ID
                                                        and R1.RSLT_SEG_NUM = R2.RSLT_SEG_NUM ))
[$Ctl_Canton_Crit5]
[$AND_Emplid_SubSelection]

end-sql

Else

Begin-Sql on-error=give_warning
INSERT INTO PS_GPCHTX011_TMP(PROCESS_INSTANCE,GPCH_TX_CANTON,EMPLID,CAL_RUN_ID,EMPL_RCD,GP_PAYGROUP,CAL_ID,
RSLT_SEG_NUM,GPCH_TX_VILLAGE_CD,GPCH_TX_TRF_TYPE,GPCH_TX_TRF_CD,PRD_END_DT,GPCH_AL_CPAY_ENDDT,SEG_BGN_DT,
SEG_END_DT,SLICE_END_DT,BEGIN_DT,END_DT,BIRTHDATE,HIRE_DT,TERMINATION_DT,PAY_ENTITY,COMPANY,CITY,POSTAL,
ACTION,MAR_STATUS,NATIONAL_ID,GPCH_AH_NNSS,GPCH_TX_CHRCH,SEX,COUNTRY_FROM,SPOUSE_NAME,GPCH_TX_SPOUSE_WL,GPCH_RP_AMOUNT1,
GPCH_RP_AMOUNT2,GPCH_RP_AMOUNT3,GPCH_RP_AMOUNT9,GPCH_RP_AMOUNT11,GPCH_RP_AMOUNT14,GPCH_RP_AMOUNT15,GPCH_RP_AMOUNT19,
GPCH_RP_AMOUNT20,GPCH_RP_AMOUNT21,GPCH_RP_AMOUNT22,GPCH_RP_AMOUNT26,GPCH_RP_AMOUNT27,VISA_PERMIT_TYPE,CONTRACT_TYPE,REG_TEMP,
GPCH_RP_CHAR03,GPCH_RP_FROMDT1)
#ifdef ORACLE
SELECT /*+ INDEX(R PS_GPCH_RP_0001)*/
#else
SELECT
#endif

[$prcs_process_instance],R.GPCH_TX_CANTON,R.EMPLID,R.CAL_RUN_ID,R.EMPL_RCD,R.GP_PAYGROUP,R.CAL_ID
,R.RSLT_SEG_NUM,R.GPCH_TX_VILLAGE_CD,R.GPCH_TX_TRF_TYPE,R.GPCH_TX_TRF_CD,R.PRD_END_DT
,R.GPCH_AL_CPAY_ENDDT,R.SEG_BGN_DT,R.SEG_END_DT,R.SLICE_END_DT,R.BEGIN_DT,R.END_DT,R.BIRTHDATE
,R.HIRE_DT,R.TERMINATION_DT,R.PAY_ENTITY,R.COMPANY,R.CITY,R.POSTAL,R.ACTION,R.MAR_STATUS
,R.NATIONAL_ID,R.GPCH_AH_NNSS,R.GPCH_TX_CHRCH,R.SEX,R.COUNTRY_FROM,R.SPOUSE_NAME,R.GPCH_TX_SPOUSE_WL
,R.GPCH_RP_AMOUNT1,R.GPCH_RP_AMOUNT2,R.GPCH_RP_AMOUNT3,R.GPCH_RP_AMOUNT9,R.GPCH_RP_AMOUNT11,R.GPCH_RP_AMOUNT14
,R.GPCH_RP_AMOUNT15,R.GPCH_RP_AMOUNT19,R.GPCH_RP_AMOUNT20,R.GPCH_RP_AMOUNT21,R.GPCH_RP_AMOUNT22
,R.GPCH_RP_AMOUNT26,R.GPCH_RP_AMOUNT27,R.VISA_PERMIT_TYPE,R.CONTRACT_TYPE,R.REG_TEMP,R.GPCH_RP_CHAR03,R.GPCH_RP_FROMDT1
FROM PS_GPCH_RP_0001 R
  WHERE R.PAY_ENTITY = $comp
    AND R.PRD_END_DT = $Ctl_Curr_Pay_End_Dt 
    AND (   R.HIRE_DT        between R.SEG_BGN_DT and R.SEG_END_DT
         OR R.TERMINATION_DT between R.SEG_BGN_DT and R.SEG_END_DT )
    and R.GPCH_AL_CPAY_ENDDT = (select max(R2.GPCH_AL_CPAY_ENDDT) from PS_GPCH_RP_0001 R2
     where R.EMPLID          = R2.EMPLID 
       and R.EMPL_RCD        = R2.EMPL_RCD 
       and R.GP_PAYGROUP     = R2.GP_PAYGROUP
       and R.CAL_ID          = R2.CAL_ID
       and R.RSLT_SEG_NUM    = R2.RSLT_SEG_NUM )
[$Ctl_Canton_Crit5]
[$AND_Emplid_SubSelection]
end-sql

End-If

#debug show ' FMB before select GPCHTX011_TMP'

begin-select  on-error=give_warning

R.BIRTHDATE
PD.NAME
SI08.EMPLID
SI08.EMPL_RCD
#ifdef MICROSOFT
CONVERT(VARCHAR, SI08.BEGIN_DT, 21) &SI08.BEGIN_DT
CONVERT(VARCHAR, SI08.END_DT, 21) &SI08.END_DT
#else
SI08.BEGIN_DT
SI08.END_DT
#endif
SI08.GPCH_RP_AMOUNT4
SI08.GPCH_RP_AMOUNT5
SI08.GPCH_RP_AMOUNT6
SI08.GPCH_RP_AMOUNT7
SI08.GPCH_RP_AMOUNT8
SI08.GPCH_RP_AMOUNT10
SI08.GPCH_RP_AMOUNT11
SI08.GPCH_RP_AMOUNT12
#ifdef MICROSOFT
CONVERT(VARCHAR, SI08.GPCH_AL_CPAY_ENDDT, 21) &SI08.GPCH_AL_CPAY_ENDDT
CONVERT(VARCHAR, SI08.PRD_END_DT, 21) &SI08.PRD_END_DT
#else
SI08.GPCH_AL_CPAY_ENDDT
SI08.PRD_END_DT
#endif
SI08.GPCH_RP_CHAR01
SI08.GPCH_RP_CHAR03
SI08.GPCH_RP_CHAR04
SI08.GPCH_RP_CHAR05
SI08.GPCH_RP_CHAR06
SI08.GPCH_RP_CHAR07
SI08.GPCH_RP_CHAR08
SI08.GP_PAYGROUP
R.NATIONAL_ID
R.GPCH_AH_NNSS
! FMB 20120530
#ifdef MICROSOFT
CONVERT(VARCHAR, R.SEG_BGN_DT, 21) &R.SEG_BGN_DT
CONVERT(VARCHAR, R.SEG_END_DT, 21) &R.SEG_END_DT
CONVERT(VARCHAR,R.HIRE_DT, 21) &R.HIRE_DT
CONVERT(VARCHAR, R.TERMINATION_DT, 21) &R.TERMINATION_DT
#else
R.SEG_BGN_DT
R.SEG_END_DT
R.HIRE_DT
R.TERMINATION_DT
#endif
#debug show '$NNSS_Id = ' $NNSS_Id ' R.GPCH_AH_NNSS =' &R.GPCH_AH_NNSS  ' emplid = '  $E_ID  '    SI08.EMPLID===' &SI08.EMPLID
!FMB 20070817           
#debug show ' $ddY2E PP Main all  $E_ID = ' $E_ID '$ddY2E = ' $ddY2E ' $E_Date = ' $E_Date
 let $B_Date_Actual = rtrim(&SI08.BEGIN_DT, ' ')
 let $E_Date_Actual = rtrim(&SI08.END_DT, ' ')
   
 if #firstRow = 0
   let $B_Date       = &SI08.BEGIN_DT
 end-if
 if #firstRow <> 0
   if rtrim($E_ID, ' ') = rtrim(&SI08.EMPLID, ' ') and
     #E_RCD            = &SI08.EMPL_RCD
       if rtrim($B_Date_save, ' ') <> rtrim(&SI08.BEGIN_DT, ' ')
         if $B_Date = ''
            let $B_Date = $B_Date_save
         end-if
        
         let $E_Date = $E_Date_save
        
         if rtrim($E_Date, ' ') = ''
           let $E_Date = $Period_End_Date 
         end-if
         
        
        
        let #Amount_4     = #Amount_4x - #Amount_4_Old
        let #Amount_5     = #Amount_5x - #Amount_5_Old
        let #Amount_6     = #Amount_6x - #Amount_6_Old
        let #Amount_7     = #Amount_7x - #Amount_7_Old 
        let #Amount_8     = #Amount_8x - #Amount_8_Old
        let #Amount_10    = #Amount_10x - #Amount_10_Old
        let #Amount_11    = #Amount_11x - #Amount_11_Old
        let #Amount_12    = #Amount_12x - #Amount_12_Old
        let #AHV_Lohn     = #Amount_4
        let #ALV1_Lohn    = #Amount_5
        let #ALV2_Lohn    = #Amount_6      
        
        
         
         do Prepare_print

         do initialVars
       else
         if    rtrim($Char_01, ' ') <> rtrim(&SI08.GPCH_RP_CHAR01, ' ')

           let #Amount_4     = #Amount_4x - #Amount_4_Old
           let #Amount_5     = #Amount_5x - #Amount_5_Old
           let #Amount_6     = #Amount_6x - #Amount_6_Old
           let #Amount_7     = #Amount_7x - #Amount_7_Old 
           let #Amount_8     = #Amount_8x - #Amount_8_Old
           let #Amount_10    = #Amount_10x - #Amount_10_Old
           let #Amount_11    = #Amount_11x - #Amount_11_Old
           let #Amount_12    = #Amount_12x - #Amount_12_Old   
           let #AHV_Lohn     = #Amount_4
           let #ALV1_Lohn    = #Amount_5
           let #ALV2_Lohn    = #Amount_6   
           let $E_Date       = $Period_End_Date

           let $Period_Begin_Date = $Period_End_Date 

           if rtrim($B_Date, ' ') = ''
              do dtu-add-months($Period_End_Date, -1, $Period_Begin_Date) 
              do dtu-add-days($Period_Begin_Date, 1, $Period_Begin_Date)                                            
              let $B_Date = $Period_Begin_Date
           end-if

           do Prepare_print
           
           
           If $Period_Begin_Date = ''
           
           let $B_Date_Tmp =  &SI08.PRD_END_DT
           do Convert-To-DTU-Date($B_Date_Tmp, $B_Date_Tmp) 
           do dtu-add-months($B_Date_Tmp, -1, $Period_Begin_Date) 
           do dtu-add-days($Period_Begin_Date, 1, $Period_Begin_Date)                                            
           let $B_Date = $Period_Begin_Date
           do Convert-From-DTU-Date($Period_Begin_Date, $Period_Begin_Date)
           let $B_Date = $Period_Begin_Date
           
           else
           
           let $B_Date_Tmp =  $Period_End_Date
           do Convert-To-DTU-Date($B_Date_Tmp, $B_Date_Tmp) 
           do dtu-add-days($B_Date_Tmp, 1, $B_Date_Tmp)                                            
           do Convert-From-DTU-Date($B_Date_Tmp, $B_Date_Tmp)
           let $B_Date = $B_Date_Tmp
           
           end-if
           

           let #Amount_4_Old = #Amount_4x
           let #Amount_5_Old = #Amount_5x
           let #Amount_6_Old = #Amount_6x
           let #Amount_7_Old = #Amount_7x
           let #Amount_8_Old = #Amount_8x
           let #Amount_10_Old = #Amount_10x
           let #Amount_11_Old = #Amount_11x
           let #Amount_12_Old = #Amount_12x
   
       end-if
    end-if
 else
    let #Amount_4        = #Amount_4x - #Amount_4_Old
    let #Amount_5        = #Amount_5x - #Amount_5_Old
    let #Amount_6        = #Amount_6x - #Amount_6_Old
    let #Amount_7        = #Amount_7x - #Amount_7_Old
    let #Amount_8        = #Amount_8x - #Amount_8_Old
    let #Amount_10       = #Amount_10x - #Amount_10_Old
    let #Amount_11       = #Amount_11x - #Amount_11_Old
    let #Amount_12       = #Amount_12x - #Amount_12_Old
   
    let #AHV_Lohn      = #Amount_4
    let #ALV1_Lohn     = #Amount_5
    let #ALV2_Lohn     = #Amount_6
    
#debug show ' $Char_08 = ' $Char_08 ' $E_Date = ' $E_Date ' $E_Date_save = ' $E_Date_save ' $B_Date = ' $B_Date ' $B_Date_save = ' $B_Date_save
    if rtrim($Char_08, ' ') <> ''
      let $E_Date = $E_Date_save
      
      do Prepare_print
   
      let $B_Date = &SI08.PRD_END_DT
    else
       let $E_Date = $E_Date_save
       let $B_Date = $B_Date_save

        do Prepare_print
     end-if
   
     do initialVars
   end-if  
 end-if
   
   
 let $B_Date_save2    = $B_Date_save
 let $Char_08_save2   = $Char_08
   
 let $N_Id            = rtrim(ltrim(&R.NATIONAL_ID,' '),' ')
 let $NNSS_Id         = rtrim(ltrim(&R.GPCH_AH_NNSS,' '),' ')
 let $Birth_Date      = &R.BIRTHDATE
 let $E_Name          = rtrim(ltrim(&PD.NAME,' '),' ')
 let $E_ID            = rtrim(ltrim(&SI08.EMPLID,' '),' ')
 let #E_RCD            = &SI08.EMPL_RCD
 let $B_Date_save     = &SI08.BEGIN_DT
 let $E_Date_save     = &SI08.END_DT
 let #AHV_Lohn        = &SI08.GPCH_RP_AMOUNT4
 let #ALV1_Lohn       = &SI08.GPCH_RP_AMOUNT5
 let #ALV2_Lohn       = &SI08.GPCH_RP_AMOUNT6
 let $Period_End_Date = &SI08.PRD_END_DT
 let $Mess_Number     = rtrim(&SI08.GPCH_RP_CHAR03,' ')
 let #Mess_Number     = to_number($Mess_Number)

 let $Char_01         = rtrim(&SI08.GPCH_RP_CHAR01,' ')   
 let $Char_04         = rtrim(&SI08.GPCH_RP_CHAR04,' ')     
 let $Char_05         = rtrim(&SI08.GPCH_RP_CHAR05,' ')
 let $Char_06         = rtrim(&SI08.GPCH_RP_CHAR06,' ')
 let $Char_07         = rtrim(&SI08.GPCH_RP_CHAR07,' ')
 let $Char_08         = rtrim(&SI08.GPCH_RP_CHAR08,' ')
 let #Amount_4        = &SI08.GPCH_RP_AMOUNT4
 let #Amount_5        = &SI08.GPCH_RP_AMOUNT5
 let #Amount_6        = &SI08.GPCH_RP_AMOUNT6
 let #Amount_7        = &SI08.GPCH_RP_AMOUNT7
 let #Amount_8        = &SI08.GPCH_RP_AMOUNT8
 let #Amount_10       = &SI08.GPCH_RP_AMOUNT10
 let #Amount_11       = &SI08.GPCH_RP_AMOUNT11
 let #Amount_12       = &SI08.GPCH_RP_AMOUNT12
 let $Nation_ID       = rtrim(ltrim(&R.NATIONAL_ID,' '),' ')
 let $N_Id = edit($N_Id,'XXX.XX.XXX.XXX')     
 let $NNSS_Id     = rtrim(ltrim(&R.GPCH_AH_NNSS,' '),' ')
          
 if $NNSS_Id <> ''
   let $NNSS_Id= substr($NNSS_Id,1,3)||'.'||  substr($NNSS_Id,4,4)||'.'||  substr($NNSS_Id,8,4)||'.'|| substr($NNSS_Id,12,2)
 end-if
          
 let #firstRow = #firstRow + 1
 let #Merk_Birthday_National = 1
 
 if rtrim($Nation_ID,' ') <> ''
   let #Merk_Birthday_National = 2
   let $Mess_Number    = ''
   let $Nat_Id_Null = 'N'
 end-if
    
 let #Amount_4x        = &SI08.GPCH_RP_AMOUNT4
 let #Amount_5x        = &SI08.GPCH_RP_AMOUNT5
 let #Amount_6x        = &SI08.GPCH_RP_AMOUNT6
 let #Amount_7x        = &SI08.GPCH_RP_AMOUNT7
 let #Amount_8x        = &SI08.GPCH_RP_AMOUNT8
 let #Amount_10x       = &SI08.GPCH_RP_AMOUNT10
 let #Amount_11x       = &SI08.GPCH_RP_AMOUNT11
 let #Amount_12x       = &SI08.GPCH_RP_AMOUNT12
 
! FMB 20120530 
#debug show ' &PD.NAME = ' &PD.NAME ' &R.HIRE_DT = ' &R.HIRE_DT  ' &R.SEG_BGN_DT = ' &R.SEG_BGN_DT ' &R.SEG_END_DT = ' &R.SEG_END_DT ' &R.TERMINATION_DT = ' &R.TERMINATION_DT '  &R.SEG_END_DT = ' &R.SEG_END_DT
 If &R.HIRE_DT     = &R.SEG_BGN_DT
#debug show ' inside $E_Name = ' $E_Name ' &R.HIRE_DT = ' &R.HIRE_DT  ' &R.SEG_BGN_DT = ' &R.SEG_BGN_DT ' &R.SEG_END_DT = ' &R.SEG_END_DT
   let $MutationE  = 'Entry'
   do ConvertToComponents(&R.HIRE_DT, $yy, $mm, $dd)
   let $ValidAsOfE = $yy || '-' || $mm || '-' || $dd
 End-If
    
 If &R.TERMINATION_DT = &R.SEG_END_DT
   let $MutationW     = 'Withdrawal'
   do ConvertToComponents(&R.TERMINATION_DT, $yy, $mm, $dd)
   let $ValidAsOfW = $yy || '-' || $mm || '-' || $dd
 End-If
   
from  PS_GPCH_RP_SI08 SI08,{Record_Names} PD , PS_GPCHTX011_TMP R, PS_GP_PYE_SEG_STAT SSS
where SI08.EMPLID      = PD.EMPLID 
AND R.PROCESS_INSTANCE = #prcs_process_instance
AND SI08.PAY_ENTITY    = $comp
AND SI08.PRD_END_DT    between $ctl_start_dt and $ctl_end_dt
and R.EMPLID           = SI08.EMPLID
and R.EMPL_RCD         = SI08.EMPL_RCD
and R.COMPANY          = SI08.COMPANY

and SI08.EMPLID        = SSS.EMPLID 
and SI08.EMPL_RCD      = SSS.EMPL_RCD 
and SI08.CAL_RUN_ID    = SSS.CAL_RUN_ID 
and SI08.CAL_ID        = SSS.CAL_ID
and SI08.GP_PAYGROUP   = SSS.GP_PAYGROUP 
and SI08.ORIG_CAL_RUN_ID = SSS.ORIG_CAL_RUN_ID
and SI08.RSLT_SEG_NUM  = SSS.RSLT_SEG_NUM    
and SSS.RSLT_VER_NUM = ( select max(S1.RSLT_VER_NUM) from PS_GP_PYE_SEG_STAT S1 where SSS.EMPLID = S1.EMPLID and SSS.EMPL_RCD = S1.EMPL_RCD and
    SSS.GP_PAYGROUP = S1.GP_PAYGROUP and SSS.CAL_ID = S1.CAL_ID and SSS.RSLT_SEG_NUM = S1.RSLT_SEG_NUM )
    
{Record_Names_Sub}
[$Ctl_Canton_Crit1]
[$AND_Emplid_SubSelection]
order by PD.NAME,R.BIRTHDATE,R.NATIONAL_ID,SI08.EMPLID,SI08.EMPL_RCD,SI08.BEGIN_DT,SI08.PRD_END_DT,SI08.GPCH_AL_CPAY_ENDDT

end-select

#debug show ' FMB after select GPCHTX011_TMP'

if #firstRow <> 0
  if  $B_Date_save2 = $B_Date_save

             let #Amount_4        = &SI08.GPCH_RP_AMOUNT4  - #Amount_4_Old
             let #Amount_5        = &SI08.GPCH_RP_AMOUNT5  - #Amount_5_Old
             let #Amount_6        = &SI08.GPCH_RP_AMOUNT6  - #Amount_6_Old
             let #Amount_7        = &SI08.GPCH_RP_AMOUNT7  - #Amount_7_Old
             let #Amount_8        = &SI08.GPCH_RP_AMOUNT8  - #Amount_8_Old
             let #Amount_10       = &SI08.GPCH_RP_AMOUNT10 - #Amount_10_Old
             let #Amount_11       = &SI08.GPCH_RP_AMOUNT11 - #Amount_11_Old
             let #Amount_12       = &SI08.GPCH_RP_AMOUNT12 - #Amount_12_Old

             let #AHV_Lohn      = #Amount_4
             let #ALV1_Lohn     = #Amount_5
             let #ALV2_Lohn     = #Amount_6

             let $E_Date       = $E_Date_save
             if rtrim($E_Date, ' ') = ''
                   let $E_Date       = $Period_End_Date
              end-if

             let $B_Date = $E_Date_save
             if rtrim($B_Date, ' ') = ''
                   let $B_Date = $Period_End_Date      
             end-if
 #debug show ' $ddY2E PP Main 3rd  $E_ID = ' $E_ID '$ddY2E = ' $ddY2E ' $E_Date = ' $E_Date
             do Prepare_print
  else
     let $B_Date = $B_Date_save
     let $E_Date = $E_Date_save
 #debug show ' $ddY2E PP Main 5th $E_ID = ' $E_ID '$ddY2E = ' $ddY2E ' $E_Date = ' $E_Date
     do Prepare_print
  end-if
end-if

if $LST_Interface <> '1'
  do Signature
end-if

#debug show ' Process-Main Out '
end-procedure
!**********************************************************************************************
begin-procedure Delete-Rec-tx011
#Debug show '<- Delete-Rec-tx011'


Begin-Sql on-error=give_warning

  DELETE FROM PS_GPCHTX011_TMP WHERE PROCESS_INSTANCE = #prcs_process_instance

End-Sql


#ifdef ORACLE
Begin-Sql on-error=give_warning
commit
End-Sql
#endif

#Debug show '-> Delete-Rec-tx011'
end-procedure Delete-Rec-tx011
!******************************************************************

begin-procedure initialVars
 let #Amount_4_Old = 0
 let #Amount_5_Old = 0
 let #Amount_6_Old = 0
 let #Amount_7_Old = 0
 let #Amount_8_Old = 0
 let #Amount_9_Old = 0
 let #Amount_10_Old = 0
 let #Amount_11_Old = 0
 let #Amount_12_Old = 0
  let $B_Date       = $B_Date_Actual
 let $E_Date       = $E_Date_Actual
end-procedure
!**********************************************************************************************
begin-procedure Prepare_print
#debug show 'In Prepare_print'
             do Format-DateTime($B_Date, $B_Date1, {DEFCMP}, '', '')

      
             do Format-DateTime($E_Date, $E_Date1, {DEFCMP}, '', '')

             do ConvertToComponents($B_Date, $yyt, $mmt, $ddt)
                         let $mmY2B = $mmt
!FMB 20070212
                         let $ddY2B = $ddt
             if ($B_Date1 >= $start_dt) and ($B_Date1 <= $end_dt)
!FMB 20070914B
                let $H_D    = $ddt|| '.' || $mmt
             else
                if ($B_Date1 < $start_dt)
                   let $H_D = '01.01'
                                   let $mmY2B = '01'
!FMB 20070914E
!FMB 20070212
                         let $ddY2B = '01'
                end-if
             end-if

!FMB 20090103
#debug show ' $Ct_Year = ' $Ct_Year
             let #Ct_Year = $Ct_Year
!            let $BJ = $Ct_Year
             let $BJ = #Ct_Year
             
             let #Merk_Date2=1

             do ConvertToComponents($E_Date, $yyt, $mmt, $ddt)
                         let $mmY2E = $mmt
                         let $EndDateInterf = $yyt || $mmt || $ddt
!FMB 20070212
                         let $ddY2E = $ddt
 #debug show ' $ddY2E 2  $E_ID = ' $E_ID '$ddY2E = ' $ddY2E ' $E_Date = ' $E_Date
             if ($E_Date1 >= $start_dt) and ($E_Date1 <= $end_dt)
!FMB 20070914B
                let $T_D    = $ddt|| '.' || $mmt 
             else
                if ($E_Date1 > $end_dt) or ($E_Date1='')
                   let $T_D = '31.12'
!FMB 20070914E
!FMB 20090103
!                   let $mmY2E = '12'
                   let $mmY2E = 12
                   let $EndDateInterf = ''
!FMB 20070212
 #debug show ' $ddY2E 3  $E_ID = ' $E_ID '$ddY2E = ' $ddY2E ' $E_Date = ' $E_Date
                         let $ddY2E = '31'
                else
                   let #Merk_Date2=2
                   let $BJ = $yyt
                end-if
            end-if

             if $Mess_Number <> ''
                let $ItExistedErr = 'Y'
                do Get_Message_Descr(17055,#Mess_Number,$language_cd,$Mess_Descr,$Mess_Descr_Long)
                let $Error_Value = 'Y'
             end-if

             if ($Error_List = 'N') and (#AHV_Lohn = 0) and (#ALV1_Lohn = 0) and
                 (#ALV2_Lohn = 0) and #Amount_7 =0 And #Amount_8 = 0 And ($Error_Value = 'N') and $Rpt_Type = 'Y'
             else
                let $Exist_Data = 'Y'

                let #Total_Amount4 = #Total_Amount4 + #Amount_4
                let #Total_Amount5 = #Total_Amount5 + #Amount_5
                let #Total_Amount6 = #Total_Amount6 + #Amount_6
                let #Total_Amount7 = #Total_Amount7 + #Amount_7
                let #Total_Amount8 = #Total_Amount8 + #Amount_8
                let #Total_Amount10 = #Total_Amount10 + #Amount_10
                let #Total_Amount11 = #Total_Amount11 + #Amount_11
                let #Total_Amount12 = #Total_Amount12 + #Amount_12

                                if $LST_Interface <> '0'
                   do Write-File
                end-if
             end-if

             if $LST_Interface <> '1'

                do Print_Data
             end-if
end-procedure
!**********************************************************************************************
begin-heading   11  For-Reports=(report1)

#include 'gpchut08.sqc'
position         (-1,1)
print $Canton_NameR         (, 10)
position         (+1,1)
print $PYENT               (0, 10)
print $Cpline1            (0, +2)
print $Cpdescr     (+1, 10)
print $Cpline2            (+1, 10)
print $Cpline3            (+1, 10)
print $Cpline31           (+1, 10)

print $BILLING_NR           (,{col3})
print $AHV_MBR_ID           (,78)
print '_'      (+2,10,118) fill
print $COVERED     (+1,{col1},15)
print $NAME_STR     (,{col2},24)
print $EMPL_OLD    (,{col3})

if $Error_List = 'N'
  print $AHV_ASS1  (,{col5})
  print $ALV1_ASS1 (,{col6})
  print $ALV2_ASS1 (,{col7})
else
  print $AHV_AMT1  (,{col5})
  print $ALV1_AMT1 (,{col6})
end-if

print $NUMBER_STR      (+1,{col1},15)

print $BIRTH_LABEL      (,21,15)

print $FROM_STR     (,{col3})
print $TO_STR      (,{col4})

if $LST_Interface = '2'
   print 'SL' (,{col4_1})
end-if

print '_'      (+1,10,118) fill

end-heading
!**********************************************************************************************
begin-heading   11  For-Reports=(report2)
let $ReportTitle = $RepTitList
#include 'gpchut08.sqc'
position         (-1,1)
print $Canton_NameR         (, 10)
position         (+1,1)
print $PYENT               (0, 10)
print $Cpline1            (0, +2)
print $Cpdescr     (+1, 10)
print $Cpline2            (+1, 10)
print $Cpline3            (+1, 10)
print $Cpline31           (+1, 10)

position (-3,1)
print $TITLE2_STR (,) center
position (+5,1)

end-heading
!**********************************************************************************************
begin-footing 9 For-reports = (report1)
if $HeadingType = '0'
if #Zaehler_Zeilen > 46
DO Format-Number(#Seiten_Total_AHV_Lohn, $Seiten_Total_AHV_Lohn,   '9,999,999,999.00')
DO Format-Number(#Gesamt_Total_AHV_Lohn, $Gesamt_Total_AHV_Lohn,   '9,999,999,999.00')
DO Format-Number(#Seiten_Total_ALV1_Lohn, $Seiten_Total_ALV1_Lohn, '9,999,999,999.00')
DO Format-Number(#Gesamt_Total_ALV1_Lohn, $Gesamt_Total_ALV1_Lohn, '9,999,999,999.00')

if $Error_List = 'N'
  DO Format-Number(#Seiten_Total_ALV2_Lohn , $Seiten_Total_ALV2_Lohn , '9,999,999,999.00')
  DO Format-Number(#Gesamt_Total_ALV2_Lohn, $Gesamt_Total_ALV2_Lohn,   '9,999,999,999.00')
end-if
print $PAGE_TOTAL        (+1, {col2})     BOLD
print $Seiten_Total_AHV_Lohn     (,{col5})        BOLD
print $Seiten_Total_ALV1_Lohn     (,{col6})      BOLD

if $Error_List = 'N'
  print $Seiten_Total_ALV2_Lohn (,{col7})    BOLD
end-if

if $Finish_Report = 'N'
  print $SUB_TOTAL (+2, {col2})            BOLD
else
  print $TOTAL     (+2, {col2})            BOLD
end-if
print $Gesamt_Total_AHV_Lohn  (,{col5})    BOLD
print $Gesamt_Total_ALV1_Lohn (,{col6})    BOLD

if $Error_List = 'N'
  print $Gesamt_Total_ALV2_Lohn (,{col7})    BOLD
end-if

let #Seiten_Total_AHV_Lohn  = 0
let #Seiten_Total_ALV1_Lohn = 0

if $Error_List = 'N'
  let #Seiten_Total_ALV2_Lohn = 0
end-if
let #_LineCount = 0
end-if

if ($Finish_Report = 'Y') and  ($Error_List = 'N')
  print $RUN_DATE (+2,{col2})
  print $SIGNAT (+2,{col2})
  PRINT '_'                   (+1,10,118) FILL
end-if
let #Zaehler_Zeilen = 0
let $Finish_Report  = 'N'
end-if
end-footing
!**********************************************************************************************
begin-procedure Print_Data

use-report report1
if $Error_List = 'N'
  if (#AHV_Lohn = 0) and (#ALV1_Lohn = 0) and (#ALV2_Lohn = 0) and ($Error_Value = 'N')
    goto Ext
  end-if
end-if

DO Format-Number(#AHV_Lohn, $AHV_Lohn,  '9,999,999,999.00')
DO Format-Number(#ALV1_Lohn, $ALV1_Lohn,'9,999,999,999.00')

if $Error_List = 'N'
  DO Format-Number(#ALV2_Lohn, $ALV2_Lohn,'9,999,999,999.00')
end-if

let #_LineCount = #_LineCount + 2
if rtrim(ltrim($NNSS_ID, ' '), ' ') <> ''
print $NNSS_ID (+2,{col1})
else
print $N_Id  (+2,{col1}) !$N_Id
end-if

if #Merk_Birthday_National = 1

  do Format-DateTime($Birth_Date, $Birth_Date1, {DEFDATE}, '', '')
  do Format-Number(#E_RCD,$EmplRcd,'888')

  let $EmplID_Rcd = $Birth_Date1 !|| '-' || $EmplRcd
  let $EmplID_Rcd1 = $Birth_Date1 !|| '-' || $EmplRcd

else
  do Format-DateTime($Birth_Date, $Birth_Date1, {DEFDATE}, '', '')
  do Format-Number(#E_RCD,$EmplRcd,'888')
  let $EmplID_Rcd = $N_Id !|| '-' || $EmplRcd
    
 


  let $EmplID_Rcd1 = $Birth_Date1 !|| '-' || $EmplRcd

end-if
print  $E_Name  (,{col2},24)

let $E_Date2 = $T_D
if #Merk_Date2 = 1
   print $H_D (,54)
   print $T_D (,{col4})
else
   do Format-DateTime($E_Date, $E_Date2, {DEFDATE}, '', '')
   do ConvertToComponents($E_Date, $yyt1, $mmt1, $ddt1)
   let $H_D = ''
   let $T_D = $mmt1
   print $H_D (,54)
   print $E_Date2 (,{col4})
end-if
if $LST_Interface = '2'
   print $Char_05 (,{col4_1})
end-if

let $ErrorStr    = '' !$ERROR_STR  || $Mess_Number || ' ' || $Mess_Descr
let $ErrorStr1   = '' !$ERROR_STR  || $Mess_Number || ' ' || $Mess_Descr_Long
let $ErrorStr_1  = '' !ltrim(rtrim(substr($ErrorStr,1,50),' '),' ')
let $ErrorStr_2  = '' !ltrim(rtrim(substr($ErrorStr,51,50),' '),' ')
let $ErrorStr1_1 = '' !ltrim(rtrim(substr($ErrorStr1,1,100),' '),' ')
let $ErrorStr1_2 = '' !ltrim(rtrim(substr($ErrorStr1,101,100),' '),' ')

if ($Error_List = 'N')
  if ($Error_Value = 'N')
     print $AHV_Lohn   (,{col5})
     print $ALV1_Lohn  (,{col6})
     print $ALV2_Lohn  (,{col7})
  else
     if $Mess_Number <> ''
    if $ErrorStr_2 = ''
         print $ErrorStr_1   (,77)
    else
       print $ErrorStr_1   (,77)
    let #Zaehler_Zeilen = #Zaehler_Zeilen + 1
    print $ErrorStr_2   (+1,77)
    end-if
     end-if
  end-if
else
  print $AHV_Lohn  (,{col5})
  print $ALV1_Lohn (,{col6})
end-if

 If $EmplID_Rcd1 <> ''
    if ($Error_List = 'N')
!      print $EmplID_Rcd1 (+1,21)
!      position         (-1,1)
  !else 
  !    print $EmplID_Rcd1 (-2,14)
    end-if
 end-if

!if ($Error_List = 'Y')
!  if $Mess_Number <> ''
!    if $ErrorStr1_2 = ''
!       print $ErrorStr1_1   (+1,{col2})
!       let #Zaehler_Zeilen = #Zaehler_Zeilen + 1
!    else
!       print $ErrorStr1_1   (+1,{col2})
!       print $ErrorStr1_2   (+1,{col2})
!       let #Zaehler_Zeilen = #Zaehler_Zeilen + 2
!  end-if
!  end-if
!end-if

!if $Nat_Id_Null = 'Y' and $Error_List = 'Y'
   !do Get_Message_Descr(17055,1102,$language_cd,$Mess_Descr,$Mess_Descr_Long)
   !print $ERROR_STR (+1,{col2})
   !print ' --> '    (,)
   !if rtrim($Mess_Descr_Long, ' ') <> ''
   !   print $Mess_Descr_Long (,)
   !else
   !   if rtrim($Mess_Descr, ' ') <> ''
   !          print $Mess_Descr (,)
   !       end-if
   !end-if
!end-if

let #Zaehler_Zeilen = #Zaehler_Zeilen + 2

if  ($Error_Value = 'N')
 let #Seiten_Total_AHV_Lohn  = #Seiten_Total_AHV_Lohn   + #AHV_Lohn
 let #Gesamt_Total_AHV_Lohn  =  #Gesamt_Total_AHV_Lohn  + #AHV_Lohn
 let #Seiten_Total_ALV1_Lohn = #Seiten_Total_ALV1_Lohn  + #ALV1_Lohn
 let #Gesamt_Total_ALV1_Lohn =  #Gesamt_Total_ALV1_Lohn + #ALV1_Lohn
end-if

if ($Error_List = 'N') and ($Error_Value = 'N')
  let #Seiten_Total_ALV2_Lohn = #Seiten_Total_ALV2_Lohn  + #ALV2_Lohn
  let #Gesamt_Total_ALV2_Lohn =  #Gesamt_Total_ALV2_Lohn + #ALV2_Lohn
end-if

do Format-DateTime($Birth_Date, $Birth_Date1, {DEFDATE}, '', '')
print $Birth_Date1 (+1,25)

Ext:
let #AHV_Lohn     = 0
let #ALV1_Lohn   = 0
let #ALV2_Lohn    = 0
let $Mess_Number  = ''
let $Error_Value  = 'N'
let $Mess_Number  = ''
let $Mess_Descr   = '' 
end-procedure
!**********************************************************************************************
Begin-Procedure Report-Translation
  do Get_Field_Information ('GPCHSI08', 'TITLE1',                        $TITLE1,#CW)
  do Get_Field_Information ('GPCHSI08', 'TITLE2',                     $TITLE2,#CW)
  do Get_Field_Information ('GPCHSI08', 'ERROR_STR',                $ERROR_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'NAME',                             $NAME_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'EMPL_OLD',                     $EMPL_OLD,#CW)
  do Get_Field_Information ('GPCHSI08', 'FROM',                             $FROM_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'TO',                                 $TO_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'AHV_ASS',                       $AHV_ASS,#CW)
  do Get_Field_Information ('GPCHSI08', 'ALV1_ASS',                     $ALV1_ASS,#CW)
  do Get_Field_Information ('GPCHSI08', 'ALV2_ASS',                     $ALV2_ASS,#CW)
  do Get_Field_Information ('GPCHSI08', 'BILLING_NR',                 $BILLING_NR,#CW)
  do Get_Field_Information ('GPCHSI08', 'PAGE',                             $PAGE,#CW)
  do Get_Field_Information ('GPCHSI08', 'RUN_DATE',                     $Run_Date,#CW)
  do Get_Field_Information ('GPCHSI08', 'PAGE_TOTAL',                 $PAGE_TOTAL,#CW)
  do Get_Field_Information ('GPCHSI08', 'TOTAL',                           $TOTAL,#CW)
  do Get_Field_Information ('GPCHSI08', 'SIGNAT',                         $SIGNAT,#CW)
  do Get_Field_Information ('GPCHSI08', 'COVERED',                       $COVERED,#CW)
  do Get_Field_Information ('GPCHSI08', 'NUMBER',                     $NUMBER_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'NNSS_NUMBER',           $NNSS_NUMBER_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'BIRTH',           $BIRTH_LABEL,#CW)
  do Get_Field_Information ('GPCHSI09', 'AHV_AMT',                       $AHV_AMT,#CW)
  do Get_Field_Information ('GPCHSI09', 'ALV1_AMT',                     $ALV1_AMT,#CW)
  do Get_Field_Information ('GPCHGLOB', 'SUB_TOTAL',                   $SUB_TOTAL,#CW)
  do Get_Field_Information ('GPCHSI08', 'TITLE2_STR',                 $TITLE2_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'FOR_YEAR_STR',             $FOR_YEAR_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'CREATION_DATE_STR',   $CREATION_DATE_STR,#CW)
  do Get_Field_Information ('GPCHSI08', 'COUNT_DATASET_STR',   $COUNT_DATASET_STR,#CW)
  do Get_Field_Information ('GPCHAL01', 'AHVBEITRAG',                $AHV_Ass_Str,#CW)
  do Get_Field_Information ('GPCHSI08', 'ALV_ASS',                   $ALV_Ass_Str,#CW)
  do Get_Field_Information ('GPCHGLOB', 'PYENT',                     $PYENT     , #CW)


  let $AHV_Str  = $AHV_ASS

  uppercase $TITLE2_STR
  do Strings_Pads($AHV_ASS, $AHV_ASS1,   16)
  do Strings_Pads($ALV1_ASS, $ALV1_ASS1, 16)
  do Strings_Pads($ALV2_ASS, $ALV2_ASS1, 16)
  do Strings_Pads($AHV_AMT, $AHV_AMT1,   16)
  do Strings_Pads($ALV1_AMT, $ALV1_AMT1, 16)

  do Get_Field_Information ('GPCHGLOB', 'LG_BDTTIME',      $LG_BDTTIME,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_DBNAME',       $LG_DBNAME,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_DBTYPE',       $LG_DBTYPE,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_EDTTIME',      $LG_EDTTIME,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OPERID',       $LG_OPERID,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OPERSYS',      $LG_OPERSYS,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OUTDESTFOR',   $LG_OUTDESTFOR,   #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OUTDESTTYPE',  $LG_OUTDESTTYPE,  #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PRCINSTNUM',   $LG_PRCINSTNUM,   #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PRCNM',        $LG_PRCNM,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PRCTYPE',      $LG_PRCTYPE,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_REPLNG',       $LG_REPLNG,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_REPNM',        $LG_REPNM,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNCTLID',     $LG_RUNCTLID,     #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNLOC',       $LG_RUNLOC,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNSTAT',      $LG_RUNSTAT,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_TOTDURA',      $LG_TOTDURA,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_CURRDT',       $LG_CURRDT,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_SRTORD',       $LG_SRTORD,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PAYENT',       $LG_PAYENT,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PSTYPE',       $LG_PSTYPE,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_FORYR',        $LG_FORYR,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNCTLPA',  $LG_RUNCTLPA,  #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_VALUE',     $LG_VALUE,     #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_REPLOG',    $LG_REPLOG,    #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_LOGITEM',   $LG_LOGITEM,   #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PINNM',     $LG_PINNM,     #CW)

  do Get_Field_Information ('GPCHGLOB', 'LG_SERIAL_NUM', $LG_SERIAL_NUM, #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_AHV_CONTR',  $LG_AHV_CONTR,  #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_ALV1_CONTR', $LG_ALV1_CONTR, #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_ALV2_CONTR', $LG_ALV2_CONTR, #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_ADJ_DATE',   $LG_ADJ_DATE,   #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PRINT_OPT',  $LG_PRINT_OPT,  #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_CANTON',  $LG_CANTON,  #CW)
end-Procedure Report-Translation
!**********************************************************************************************
begin-procedure Get-Values
  let $language_cd        = $PRCS_LANGUAGE_CD
  let $comp               = &GPCH_RUN_CNTL.PAY_ENTITY
  let $Ct_Year            = RTRIM(to_char(&GPCH_RUN_CNTL.GPCH_RC_PAY_YEAR), ' ')
  let #Serial_NBR         = &GPCH_RUN_CNTL.GPCH_RC_SERIALNR
  let $Adjusting_DT       = rtrim(&GPCH_RUN_CNTL.GPCH_RC_ADJUST_DT,' ')
  let $LST_Interface      = rtrim(&GPCH_RUN_CNTL.GPCH_RC_LST_OPTION,' ')
  let #Cntl_AHV_Amount    = &GPCH_RUN_CNTL.GPCH_RC_AHV_AMNT
  let #Cntl_ALV1_Amount   = &GPCH_RUN_CNTL.GPCH_RC_ALV1_AMNT
  let #Cntl_ALV2_Amount   = &GPCH_RUN_CNTL.GPCH_RC_ALV2_AMNT
  let $Ctl_Canton         = RTRIM(&GPCH_RUN_CNTL.GPCH_TX_CANTON,' ')
  let $GPCH_EG_YEP_FLG    = RTRIM(&GPCH_RUN_CNTL.GPCH_EG_YEP_FLG,' ')
  let #Domainid           = &GPCH_RUN_CNTL.GPCH_EG_DOMAINID
!FMB 20120530
  let $Ctl_Curr_Pay_End_Dt = RTRIM(&GPCH_RUN_CNTL.GPCH_AL_CPAY_ENDDT, ' ')

  
  
  Let $PAY_BGN_DT = $Ct_Year || '0101'
  do Format-DateTime($PAY_BGN_DT, $PAY_BGN_DT, {DEFCMP},'','native')
 

   If $GPCH_EG_YEP_FLG = 'Y'
    
     Let $comp = &GPCH_RUN_CNTL.COMPANY
     ! SYED Let #GPCH_EG_TRNS_SEQ = &GPCH_RUN_CNTL.GPCH_EG_TRNS_SEQ
     ! SYED  do Format-Number(#GPCH_EG_TRNS_SEQ,$GPCH_EG_TRNS_SEQ,'99')
   End-If

  if $comp <> ''
    let $Ctl_Com = rtrim($comp, ' ')
    uppercase $Ctl_Com
  end-if
!FMB 20120530
#debug show 'FMB before AHV EA $Ctl_Curr_Pay_End_Dt = ' $Ctl_Curr_Pay_End_Dt
 If $Rpt_Type <> 'Y'
  let $Ctl_Curr_Pay_End_Dt = $Ctl_End_Dt
 End-If
#debug show 'FMB After AHV EA $Ctl_Curr_Pay_End_Dt = ' $Ctl_Curr_Pay_End_Dt
end-procedure
!**********************************************************************************************
begin-procedure Ask-Input
input $comp  'PAY EENTITY '           type=char        maxlen=3
input $Ct_Year 'YEAR EXEMPLE: 1996 ' type=number      maxlen=4
if $comp <> ''
    let $Ctl_Com = rtrim($comp, ' ')
    uppercase $Ctl_Com
        let $comp=$Ctl_Com
end-if
input $Ctl_Diskette_Type    'DISK TYPE '
input #Serial_NBR   'SERIAL NUMBER '  type=number
input $Adjusting_DT  'ADJUSTING DATE ' type=date
input $LST_Interface    'PRINT TYPE 0->LIST, 1->INTERFACE, 2->LIST & INTERFACE ' type=char
input #Cntl_AHV_Amount  'AHV - CONTRIBUTION '      type=number
input #Cntl_ALV1_Amount 'ALV1 - CONTRIBUTION '       type=number
input #Cntl_ALV2_Amount 'ALV1 - CONTRIBUTION '       type=number
input $Ctl_Canton  'Canton' type=char
end-procedure
!**********************************************************************************************
begin-procedure Get-Translate-Value

  move 'MONTHCD' to $FieldName
  move $mm to $FieldValue

  do Read-Translate-Table
  let $Month_Name = $XlatShortName

end-procedure Get-Translate-Value
!**********************************************************************************************
begin-procedure Process-Main1
#debug show 'In Process-Main1'

if $ItExistedErr = 'N' or $LST_Interface = '1'
  goto NoError
end-if

new-page

let $Error_List    = 'Y'
let $ReportTitle   = $TITLE2 || ' '
let $RepTit1     = ''
let $RepTit1     = $ReportTitle || $Ct_Year
let $ReportTitle   = $RepTit1
do Get-Company-Address($comp,$ctl_end_dt,$language_cd,$Cpline1,$Cpline2,$Cpline3,$Cpline31,
                       $Cpline4,$Cpline5,$Cpline6,$Cpdescr,$Cpdescrshrt,$Cpcity,$Cpstate,$Cppostal,$CpBusn_Phone,$CpFax_Phone,$CpOtr_Phone)
do Get_Fak_Tax_Data('NA',$Ctl_Com,$ctl_end_dt,
                       $Fak_Language,$Employer_Fak_Nbr,#Employer_Fak_Pct,
                       $Tax_Language,$Employer_StaxNr,#Staxb_PCTR,
                       #Employer_SI_Pct,$AHV_MBR_ID,$SI_AHV_PROVCD,
                       $KK,#COM_AHV_ADM_COST,#SI_TOT_AHV_PC,
                       #SI_TOT_ALV1PC,#SI_TOT_ALV2PC)
 let $SPRV_TYPE = '7'
 let $SPRV_CD   = '#AHV'
 let $SPRV_CANTON = ' '
 let $SPRV_ALL = ' '

 do Get-MBR-ID

  let $AHV_MBR_ID = $MBR_ID

let #LineCount      = 0
let #MerkLine      = 1
let #Seiten_Total_AHV_Lohn   = 0
let #Gesamt_Total_AHV_Lohn   = 0
let #Seiten_Total_ALV1_Lohn  = 0
let #Gesamt_Total_ALV1_Lohn  = 0
let #Merk_Birthday_National  = 1
let $Nat_Id_Null = 'Y'
!--------------------------------!
let #firstRow = 0
let $E_ID = ''
let #E_RCD = 0
let $B_Date = ''
let $E_Date = ''
let #Amount_7_Old        = 0
let #Amount_8_Old        = 0

let #Amount_7x        = 0
let #Amount_8x        = 0
!--------------------------------!
begin-select
RE.BIRTHDATE

PD1E.NAME
SI081E.EMPLID
SI081E.EMPL_RCD
SI081E.BEGIN_DT
SI081E.END_DT
SI081E.GPCH_RP_AMOUNT7
SI081E.GPCH_RP_AMOUNT8
SI081E.PRD_END_DT
SI081E.GPCH_AL_CPAY_ENDDT
RE.NATIONAL_ID
RE.GPCH_AH_NNSS
SI081E.GPCH_RP_CHAR01
SI081E.GPCH_RP_CHAR03
SI081E.GPCH_RP_CHAR05
SI081E.GPCH_RP_CHAR08
   show 'SI081E.EMPLID = ' &SI081E.EMPLID  ' RE.GPCH_AH_NNSS = ' &RE.GPCH_AH_NNSS
   Let #count = #Count + 1
   if #firstRow = 0
     let $B_Date       = &SI081E.BEGIN_DT
   end-if

   let $B_Date_Actual = rtrim(&SI081E.BEGIN_DT, ' ')
   let $E_Date_Actual = rtrim(&SI081E.END_DT, ' ')
    if #firstRow <> 0
     if rtrim($E_ID, ' ') = rtrim(&SI081E.EMPLID, ' ') and
        #E_RCD = &SI081E.EMPL_RCD
                if rtrim($B_Date_save, ' ') <> rtrim(&SI081E.BEGIN_DT, ' ')
                  if $B_Date = ''
                   let $B_Date = $B_Date_save
                  end-if
                   let $E_Date = $E_Date_save
           if rtrim($E_Date, ' ') = ''
                                                      let $E_Date = $Period_End_Date 
                                               end-if
                                               if rtrim($Char_08, ' ') <> '0'
 !FMB 20070817           
 #debug show ' $ddY2E PP Main1 0  $E_ID = ' $E_ID '$ddY2E = ' $ddY2E ' $E_Date = ' $E_Date
                                                      do Prepare_print
                                               end-if
                         do initialVars
                else
!FMB 20070817                  if rtrim($Char_08, ' ') <> rtrim(&SI081E.GPCH_RP_CHAR08, ' ')  or 
                 if     rtrim($Char_01, ' ') <> rtrim(&SI081E.GPCH_RP_CHAR01, ' ')
              let #Amount_7        = #Amount_7x - #Amount_7_Old
              let #Amount_8        = #Amount_8x - #Amount_8_Old

              let #AHV_Lohn      = #Amount_7
              let #ALV1_Lohn     = #Amount_8

                          let $E_Date       = $Period_End_Date

                          if rtrim($B_Date, ' ') = ''
                             let $B_Date = $Period_End_Date
                          end-if

                          do Prepare_print_Error

                          let $B_Date       = &SI081E.PRD_END_DT
                          let #Amount_7_Old = #Amount_7x
                          let #Amount_8_Old = #Amount_8x

            end-if
                 end-if
          else
                    let #Amount_7        = #Amount_7x - #Amount_7_Old
            let #Amount_8        = #Amount_8x - #Amount_8_Old

            let #AHV_Lohn      = #Amount_7
            let #ALV1_Lohn     = #Amount_8

                    if rtrim($Char_08, ' ') <> ''
                         let $E_Date = $E_Date_save
                             do Prepare_print_Error
                             let $B_Date = &SI081E.PRD_END_DT
                        else
                                 let $E_Date = $E_Date_save
                                 let $B_Date = $B_Date_save
                             do Prepare_print_Error
                        end-if
                 do initialVars
          end-if
        end-if

  let $B_Date_save2 = $B_Date_save
  let $Char_08_save2 = $Char_08

  let $N_Id       = rtrim(ltrim(&RE.NATIONAL_ID,' '),' ')
  let $NNSS_Id    = rtrim(ltrim(&RE.GPCH_AH_NNSS,' '),' ')
  let $Birth_Date     = &RE.BIRTHDATE
  let $E_Name      = rtrim(ltrim(&PD1E.NAME,' '),' ')
  let $E_ID      = rtrim(ltrim(&SI081E.EMPLID,' '),' ')
  let #E_RCD      = &SI081E.EMPL_RCD
  let #AHV_Lohn     = &SI081E.GPCH_RP_AMOUNT7
  let #ALV1_Lohn     = &SI081E.GPCH_RP_AMOUNT8
  let $Period_End_Date   = &SI081E.PRD_END_DT
  let $Mess_Number    = rtrim(&SI081E.GPCH_RP_CHAR03,' ')
  let #Mess_Number    = to_number($Mess_Number)
  let $Char_01         = rtrim(&SI081E.GPCH_RP_CHAR01,' ')
  let $Char_05         = rtrim(&SI081E.GPCH_RP_CHAR05,' ')
  let $Char_08         = rtrim(&SI081E.GPCH_RP_CHAR08,' ')

  let $B_Date_save       = &SI081E.BEGIN_DT
  let $E_Date_save       = &SI081E.END_DT

  !if rtrim($N_Id,' ') = '' and rtrim($NNSS_Id,' ') = ''
  !   if $Char_05 = '01'
  !       let $Char_05 = '06'
  !   end-if
  !end-if
  let #firstRow = #firstRow + 1
  let #Merk_Birthday_National = 1
  if rtrim($N_Id,' ') <> ''
         let #Merk_Birthday_National = 2
         let $Nat_Id_Null = 'N'
         LET $N_Id = edit($N_Id,'XXX.XX.XXX.XXX')
  end-if
  if rtrim($NNSS_Id, ' ') <> ''

         let $NNSS_Id= substr($NNSS_Id,1,3)||'.'||
                       substr($NNSS_Id,4,4)||'.'||
                       substr($NNSS_Id,8,4)||'.'||
                       substr($NNSS_Id,12,2)
  end-if

  let #Amount_7x     = &SI081E.GPCH_RP_AMOUNT7
  let #Amount_8x     = &SI081E.GPCH_RP_AMOUNT8
from  PS_GPCH_RP_SI08 SI081E, {Record_Names} PD1E, PS_GPCHTX011_TMP RE, PS_GP_PYE_SEG_STAT SSS
where SI081E.EMPLID             = PD1E.EMPLID
AND   SI081E.EMPLID             = RE.EMPLID

AND   SI081E.PAY_ENTITY         = $comp
!FMB 20081203 only if both empty and (guess) the 2nd or-conditon is redundant
AND   ((RE.NATIONAL_ID = ' ' and RE.GPCH_AH_NNSS = ' ')  or      SI081E.GPCH_RP_CHAR03 <> ' ' )


AND   SI081E.PRD_END_DT between $ctl_start_dt and $ctl_end_dt
and   SI081E.COMPANY = RE.COMPANY

and SI081E.EMPLID        = SSS.EMPLID 
and SI081E.EMPL_RCD      = SSS.EMPL_RCD 
and SI081E.CAL_RUN_ID    = SSS.CAL_RUN_ID 
and SI081E.CAL_ID        = SSS.CAL_ID
and SI081E.GP_PAYGROUP   = SSS.GP_PAYGROUP 
and SI081E.ORIG_CAL_RUN_ID = SSS.ORIG_CAL_RUN_ID
and SI081E.RSLT_SEG_NUM  = SSS.RSLT_SEG_NUM    
and SSS.RSLT_VER_NUM = ( select max(S1.RSLT_VER_NUM) from PS_GP_PYE_SEG_STAT S1 where SSS.EMPLID = S1.EMPLID and SSS.EMPL_RCD = S1.EMPL_RCD and
    SSS.GP_PAYGROUP = S1.GP_PAYGROUP and SSS.CAL_ID = S1.CAL_ID and SSS.RSLT_SEG_NUM = S1.RSLT_SEG_NUM )

{Record_Names_Sub}
[$Ctl_Canton_Crit4]
order by PD1E.NAME,RE.BIRTHDATE,RE.NATIONAL_ID,SI081E.EMPLID,SI081E.EMPL_RCD,SI081E.BEGIN_DT,SI081E.PRD_END_DT,SI081E.GPCH_AL_CPAY_ENDDT
end-select

!
if #firstRow <> 0
  if  $B_Date_save2 = $B_Date_save
     if $Char_08_save2 <> $Char_08
                  let #Amount_7        = &SI081E.GPCH_RP_AMOUNT7 - #Amount_7_Old
              let #Amount_8        = &SI081E.GPCH_RP_AMOUNT8 - #Amount_8_Old

              let #AHV_Lohn      = #Amount_7
              let #ALV1_Lohn     = #Amount_8

                          let $E_Date       = $Period_End_Date

                          if rtrim($B_Date, ' ') = ''
                             let $B_Date = $Period_End_Date
                          end-if

                          do Prepare_print_Error
         else
            let #Amount_7        = &SI081E.GPCH_RP_AMOUNT7 - #Amount_7_Old
        let #Amount_8        = &SI081E.GPCH_RP_AMOUNT8 - #Amount_8_Old

        let #AHV_Lohn      = #Amount_7
        let #ALV1_Lohn     = #Amount_8

        let $E_Date = $E_Date_save
        do Prepare_print_Error
         end-if
  else
     let $B_Date = $B_Date_save
     let $E_Date = $E_Date_save
     do Prepare_print_Error
  end-if
end-if
!

do Signature

NoError:

if $Exist_Data = 'Y' and $LST_Interface <> '0'
  do DTA-End-Record
  close 10
else
 close 10
 let #success = delete($reportdir3)
end-if
end-procedure
!**********************************************************************************************
begin-procedure Strings_Pads($Str1, :$Str2, #Len1)
   let $Str1 = rtrim(ltrim($Str1, ' '), ' ')
   let $Str1 = rtrim(substr($Str1, 1, #Len1), ' ')
   let $Str2 = lpad($Str1, #Len1, ' ')
end-procedure
!**********************************************************************************
begin-procedure Prepare_print_Error
use-report report1
  do Format-DateTime($B_Date, $B_Date1, {DEFCMP}, '', '')
  do Format-DateTime($E_Date, $E_Date1, {DEFCMP}, '', '')

  if ($B_Date1 >= $start_dt) and ($B_Date1 <= $end_dt)
   do ConvertToComponents($B_Date,$yyt,$mmt,$ddt)
   let $H_D    = $mmt
  else
   if ($B_Date1 < $start_dt)
    let $H_D = '01'
   end-if
 end-if
 let #Merk_Date2 = 1
 if ($E_Date1 >= $start_dt) and ($E_Date1 <= $end_dt)
   do ConvertToComponents($E_Date,$yyt,$mmt,$ddt)
   let $T_D    = $mmt
 else
  if ($E_Date1 > $end_dt) or ($E_Date1='')
    let $T_D = '12'
  else
    let #Merk_Date2 = 2
  end-if
 end-if
 do Get_Message_Descr(17055,#Mess_Number,$language_cd,$Mess_Descr,$Mess_Descr_Long)

 do Print_Data
end-procedure
!************************************************************************************
Begin-procedure Get_English_Strings($ReportID)
#Debug show 'Get_English_Strings -> '  $ReportID

evaluate $ReportID
          when = 'GPCHSI08'
               do Get_Eng_GPCHSI08
               break
          when = 'GPCHGLOB'
               do Get_Eng_GPCHGLOB
               break
          when = 'GPCHSI09'
               do Get_Eng_GPCHSI09
               break
          when = 'GPCHAl01'
               do Get_Eng_GPCHAL01
               break
          when = 'ALL'
               do Get_Eng_GPCHSI08
               do Get_Eng_GPCHGLOB
               do Get_Eng_GPCHSI09
               do Get_Eng_GPCHAL01
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_English_Strings <- ' #_str_cnt
End-procedure Get_English_Strings
!****************************************************************************
Begin-procedure Get_German_Strings($ReportID)
#Debug show 'Get_German_Strings -> '  $ReportID

evaluate $ReportID
          when = 'GPCHSI08'
               do Get_Ger_GPCHSI08
               break
          when = 'GPCHGLOB'
               do Get_Ger_GPCHGLOB
               break
          when = 'GPCHSI09'
               do Get_Ger_GPCHSI09
               break
          when = 'GPCHAl01'
               do Get_Ger_GPCHAL01
               break
          when = 'ALL'
               do Get_Ger_GPCHSI08
               do Get_Ger_GPCHGLOB
               do Get_Ger_GPCHSI09
               do Get_Ger_GPCHAL01
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_German_Strings <- ' #_str_cnt
End-procedure Get_German_Strings
!****************************************************************************
Begin-procedure Get_Italian_Strings($ReportID)
#Debug show 'Get_Italian_Strings -> '  $ReportID

 evaluate $ReportID
          when = 'GPCHSI08'
               do Get_Ita_GPCHSI08
               break
          when = 'GPCHGLOB'
               do Get_Ita_GPCHGLOB
               break
          when = 'GPCHSI09'
               do Get_Ita_GPCHSI09
               break
          when = 'GPCHAl01'
               do Get_Ita_GPCHAL01
               break
          when = 'ALL'
               do Get_Ita_GPCHSI08
               do Get_Ita_GPCHGLOB
               do Get_Ita_GPCHSI09
               do Get_Ita_GPCHAL01
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_Italian_Strings <- ' #_str_cnt
End-procedure Get_Italian_Strings
!****************************************************************************
Begin-procedure Get_French_Strings($ReportID)
#Debug show 'Get_French_Strings -> '  $ReportID

evaluate $ReportID
          when = 'GPCHSI08'
               do Get_Fra_GPCHSI08
               break
          when = 'GPCHGLOB'
               do Get_Fra_GPCHGLOB
               break
          when = 'GPCHSI09'
               do Get_Fra_GPCHSI09
               break
          when = 'GPCHAl01'
               do Get_Fra_GPCHAL01
               break
          when = 'ALL'
               do Get_Fra_GPCHSI08
               do Get_Fra_GPCHGLOB
               do Get_Fra_GPCHSI09
               do Get_Fra_GPCHAL01
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_French_Strings <- ' #_str_cnt
End-procedure Get_French_Strings
!***********************************************************************
begin-procedure Get-MBR-ID
#DEBUG show '<- Get-MBR-ID  '

 
 Let $MBR_ID = ' '

Begin-Select
MBR.GPCH_SI_UV_MBR_ID     &MBR_ID

 Let $MBR_ID =  &MBR_ID

FROM PS_GPCH_SI_ACC_INS MBR
WHERE MBR.COMPANY = $Ctl_Com
AND   MBR.EFFDT = (SELECT MAX(MBR2.EFFDT) FROM PS_GPCH_SI_ACC_INS MBR2
                                     WHERE MBR2.EFFDT <= $ctl_end_dt)
AND   MBR.GPCH_SI_PROV_TYPE = $SPRV_TYPE
AND  (
       ( MBR.GPCH_SI_PROV_TYPE = '5' AND 
       ( MBR.GPCH_TX_CANTON = $SPRV_CANTON or MBR.GPCH_ALL_CANTONFLG = $SPRV_ALL ) )
    OR ( MBR.GPCH_SI_PROV_TYPE <> '5' AND  MBR.GPCH_TX_UV_PROV_CD = $SPRV_CD ) )
End-select



#DEBUG show '<- Get-MBR-ID  '
end-procedure Get-MBR-ID

!****************************************************************************
#include 'gpchut01.sqc'
#include 'gpchut04.sqc'  ! get company informations
#include 'gpchut06.sqc'  ! get run control parameter values
#include 'gpchut07.sqc'  ! get Log
#include 'gpchut11.sqc'  ! get Tax and Fak Values
#include 'curdttim.sqc'  ! get-current-datetime procedure
#include 'readxlat.sqc'  ! read-translate-table procedure
#include 'datetime.sqc'  ! routines for date and time formatting
#include 'validdt.sqc'   ! validate date routine
#include 'number.sqc'    ! routines to format numbers
#include 'stdapi.sqc'    ! routines to update run status
#include 'sqrtrans.sqc'  ! sqr strings table procedures
#include 'datemath.sqc'  ! function for date-calculation
#include 'gpchsi8s.sqc'  ! Get Strings Values for GPCHSI08
#include 'gpchglbs.sqc'  ! Get Strings Values for GPCHGLOB
#include 'gpchsi9s.sqc'  ! Get Strings Values for GPCHSI09
#include 'gpchal1s.sqc'  ! Get Strings Values for GPCHAL01
