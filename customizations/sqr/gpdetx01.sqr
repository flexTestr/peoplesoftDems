!***********************************************************************
!  GPDETX01:  Tax-Card - Lohnsteuerbescheinigung                       *
!***********************************************************************
!                                                                      *
!                                                                      *
!                                                                      *
! This software and related documentation are provided under a         *
! license agreement containing restrictions on use and                 *
! disclosure and are protected by intellectual property                *
! laws. Except as expressly permitted in your license agreement        *
! or allowed by law, you may not use, copy, reproduce,                 *
! translate, broadcast, modify, license, transmit, distribute,         *
! exhibit, perform, publish or display any part, in any form or        *
! by any means. Reverse engineering, disassembly, or                   *
! decompilation of this software, unless required by law for           *
! interoperability, is prohibited.                                     *
! The information contained herein is subject to change without        *
! notice and is not warranted to be error-free. If you find any        *
! errors, please report them to us in writing.                         *
!                                                                      *
!
! Copyright (C) 1988, 2013, Oracle and/or its affiliates.              *
! All Rights Reserved.                                                 *
!----------------------------------------------------------------------
!
!          $Date:  2013/01/18:03:36:52                                 !
!       $Release:  HR92                                                !
!      $Revision:  106                                                 !
!                                                                      *
!***********************************************************************

!
! jjj08-taxupd08 : Fix for duplicate print of a line in tax statement
!                  ( reported by LHCL ) !
!

!
! jjj08-1717018000 : TaxUpdates 2008 - Elster Library changes.
! adj08-1599392000 : XML differs from SQR
! adj09-1868035000 : Align address.
! bhy10-1970391001 : Print appropriate effective dated Address.
! Prav12-13395876  :  Tax Update 2012.


#include 'setenv.sqc'   !set environment
#include 'adformat.sqc' ! jjj07 89b11 1651346000 - hr ADDRess format sqc

#include 'setenv.sqc' !set environment

!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2006-10-30, GPDE test e-pay ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2006-12-06, GPDE TaxUpdate 2007 ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2008-01-16, GPDE TaxUpdate 2008 ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2008-03-26, 89 Bundle 13 ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2009-07-13, 89 Bundle 18 ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2010-01-15, 89 Bundle 2010-update B ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2010-04-26, 90 Bundle UPD D ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2011-01-26, 90 Bundle UPD A ==='
!#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2011-07-15, 90 Bundle UPD E ==='
#define gpdeversionstamp '=== FUNCTIONAL UPDATE STAMP: 2012-03-08, 90 Bundle UPD B ==='

#define LANGUAGE_REPORT 'GER'
#define MaxNumberVBEZ 12
#define TagVBEZ_2006 'BMGVersFreibetrag'
#define TagSterbegeld_2006 'EinmversBezug'

! rh - TaxUpdate 2007 2006-12-06
#define TagVBEZ_2007 'StBegVBez'
!Tax update 2010
#define TagVBEZ_2010 'VBez'

#define TagSterbegeld_2007 'einmversbezug'
#define TagFreibetrag_2007 'bmgfreibetrag'

#define TimespanSeparator ' - '
#define MonthYearSeparator '.'
#define Error_EndTagNotFound 1
#define Error_TooManyItems 2

#define line27size 2
#define line28size 2
#define line29size 2
#define line30size 3
#define line31size 2
!tax update 2010
#define line8size_2010 2
#define line9size_2010 1
#define line29size_2010 2
#define line30size_2010 2
#define line31size_2010 2
#define line32size_2010 3
!
#define versorgungsbezuege_start_page 2
#define maxLinesOnPage 80
#define maxLinesInBox 79
#define FirstLineInTable 2 ! Must be > 1, Line 1 is needed for the border of the box

BEGIN-PROGRAM
   do Init-DateTime
   do Init-Number
   do Init-Report

   do Process-Main
   do Stdapi-Term

END-PROGRAM

begin-setup

   declare-layout Default2
      paper-size  = (a4)
      max-lines   = 180
      max-columns = 110
      line-height = 10
   end-declare

   declare-report Default2
      layout = Default2
   end-declare

   create-array
      name=versorgungsbezuege
      size={MaxNumberVBEZ}
      field=bemessungsgrundlage:char
      field=jahr:char
      field=beginn:char
      field=ende:char
      field=posline27:integer
      field=pageline27:integer
      field=posline28:integer
      field=pageline28:integer
      field=posline29:integer
      field=pageline29:integer

   declare-variable
      integer #_versorgungsbezuege_size
   end-declare

   create-array
      name=sterbegeld
      size={MaxNumberVBEZ}
      field=auszahlung:char
      field=jahr:char
      field=posline30:integer
      field=pageline30:integer
      field=posline31:integer
      field=pageline31:integer

   declare-variable
      integer #_sterbegeld_size
   end-declare


! rh - TaxUpdate 2007 20061206 create a new array for StBegVbez
create-array
      name=StBegVbez
      size={MaxNumberVBEZ}
      field=zeile8:char
      field=bmgfreibetrag:char
      field=jahr:char
      field=beginn:char
      field=ende:char
      field=einmversbezug:char
      field=posline27:integer
      field=pageline27:integer
      field=posline28:integer
      field=pageline28:integer
      field=posline29:integer
      field=pageline29:integer
      field=posline30:integer
      field=pageline30:integer

   declare-variable
      integer #_StBegVbez_size
   end-declare

!Tax Update 2010 create a new array for Vbez
create-array
      name=Vbez
      size={MaxNumberVBEZ}
      field=zeile8:char
      field=zeile9:char
      field=bmgfreibetrag:char
      field=jahr:char
      field=beginn:char
      field=ende:char
      field=einmversbezug:char
      field=posline8:integer
      field=pageline8:integer
      field=posline9:integer
      field=pageline9:integer
      field=posline29:integer
      field=pageline29:integer
      field=posline30:integer
      field=pageline30:integer
      field=posline31:integer
      field=pageline31:integer
      field=posline32:integer
      field=pageline32:integer

   declare-variable
      integer #_Vbez_size
   end-declare

end-setup

!************************************************
!
!printer & page-size initialization for the various taxcard layouts
!
!************************************************
#include 'setup31.sqc'       ! printer setup for layout type 2b

begin-procedure InitializeArray_Versorgungsbezuege

#debug show 'begin procedure InitializeArray_Versorgungsbezuege'

   let #i = 0
   while #i < {MaxNumberVBEZ}
      put ' ' ' ' ' ' ' ' 0 0 0 0 0 0 into versorgungsbezuege(#i)
      add 1 to #i
   end-while

   do SetArraySize_Versorgungsbezuege(-1)

#debug show 'Number of cleared elements:'
#debug show #i

#debug show 'end procedure InitializeArray_Versorgungsbezuege'


end-procedure InitializeArray_Versorgungsbezuege
!************************************************



!************************************************
!
begin-procedure InitializeArray_Sterbegeld
!
!************************************************
#debug show 'begin procedure InitializeArray_Sterbegeld'


   let #i = 0
   while #i < {MaxNumberVBEZ}
      put ' ' ' ' 0 0 0 0 into sterbegeld(#i)
      add 1 to #i
   end-while

   do SetArraySize_Sterbegeld(-1)

#debug show 'Number of cleared elements:'
#debug show #i

#debug show 'end procedure InitializeArray_Sterbegeld'

end-procedure InitializeArray_Sterbegeld
!************************************************


! rh - TaxUpdate 2007 20061206 create a new array for StBegVbez
!************************************************
begin-procedure InitializeArray_StBegVbez

#debug show 'begin procedure InitializeArray_StBegVbez'

   let #i = 0
   while #i < {MaxNumberVBEZ}
      put ' ' ' ' ' ' ' ' ' ' ' ' 0 0 0 0 0 0 into StBegVbez(#i)
      add 1 to #i
   end-while

   do SetArraySize_StBegVbez(-1)

#debug show 'Number of cleared elements:'
#debug show #i

#debug show 'end procedure InitializeArray_StBegVBez'
end-procedure InitializeArray_StBegVbez
!************************************************

! rh - TaxUpdate 2007 20061206 create a new array for StBegVbez
!************************************************
!TaxUpdate 2010
begin-procedure InitializeArray_Vbez

   let #i = 0
   while #i < {MaxNumberVBEZ}
      put ' ' ' ' ' ' ' ' ' ' ' ' ' ' 0 0 0 0 0 0 0 0  into Vbez(#i)
      add 1 to #i
   end-while

   do SetArraySize_Vbez(-1)

#debug show 'Number of cleared elements:'
#debug show #i

#debug show 'end procedure InitializeArray_VBez'
end-procedure InitializeArray_Vbez


!************************************************
!
begin-procedure GetArraySize_Sterbegeld(:#NrElements)
!
!************************************************
   #debug show 'begin procedure GetArraySize_Sterbegeld'
   #debug show '#NrElements'
   #debug show #NrElements

   let #NrElements = #_sterbegeld_size

   #debug show '#NrElements'
   #debug show #NrElements
   #debug show 'end procedure GetArraySize_Sterbegeld'
end-procedure GetArraySize_Sterbegeld
!************************************************



!************************************************
!
begin-procedure GetArraySize_Versorgungsbezuege(:#NrElements)
!
!************************************************
   #debug show 'begin procedure GetArraySize_Versorgungsbezuege'
   #debug show '#NrElements'
   #debug show #NrElements

   let #NrElements = #_versorgungsbezuege_size

   #debug show '#NrElements'
   #debug show #NrElements
   #debug show 'end procedure GetArraySize_Versorgungsbezuege'
end-procedure GetArraySize_Versorgungsbezuege
!************************************************



! rh - TaxUpdate 2007 20061206 new array for StBegVbez
!************************************************
!
begin-procedure GetArraySize_StBegVbez(:#NrElements)
!
!************************************************
   #debug show 'begin procedure GetArraySize_StBegVbez'
   #debug show '#NrElements'
   #debug show #NrElements

   let #NrElements = #_StBegVbez_size

   #debug show '#NrElements'
   #debug show #NrElements
   #debug show 'end procedure GetArraySize_StBegVbez'
end-procedure GetArraySize_StBegVbez
!************************************************

!TaxUpdate 2010
begin-procedure GetArraySize_Vbez(:#NrElements)
!
!************************************************
   #debug show 'begin procedure GetArraySize_Vbez'
   #debug show '#NrElements'
   #debug show #NrElements

   let #NrElements = #_Vbez_size

   #debug show '#NrElements'
   #debug show #NrElements
   #debug show 'end procedure GetArraySize_Vbez'
end-procedure GetArraySize_Vbez
!************************************************

!************************************************
!
begin-procedure SetArraySize_Sterbegeld(#NrElements)
!
!************************************************
   #debug show 'begin procedure SetArraySize_Sterbegeld'
   #debug show '#NrElements'
   #debug show #NrElements

   let #_sterbegeld_size = #NrElements

   #debug show '#NrElements'
   #debug show #NrElements
   #debug show 'end procedure SetArraySize_Sterbegeld'
end-procedure SetArraySize_Sterbegeld
!************************************************



!************************************************
!
begin-procedure SetArraySize_Versorgungsbezuege(#NrElements)
!
!************************************************
   #debug show 'begin procedure SetArraySize_Versorgungsbezuege'
   #debug show '#NrElements'
   #debug show #NrElements

   let #_versorgungsbezuege_size = #NrElements

   #debug show '#NrElements'
   #debug show #NrElements
   #debug show 'end procedure SetArraySize_Versorgungsbezuege'
end-procedure SetArraySize_Versorgungsbezuege
!************************************************



! rh - TaxUpdate 2007 20061206 new array StBegVbez
!************************************************
!
begin-procedure SetArraySize_StBegVbez(#NrElements)
!
!************************************************
   #debug show 'begin procedure SetArraySize_StBegVbez'
   #debug show '#NrElements'
   #debug show #NrElements

   let #_StBegVbez_size = #NrElements

   #debug show '#NrElements'
   #debug show #NrElements
   #debug show 'end procedure SetArraySize_StBegVbez'
end-procedure SetArraySize_StBegVbez
!************************************************

!TaxUpdate 2010 new array Vbez
begin-procedure SetArraySize_Vbez(#NrElements)
!
!************************************************
   #debug show 'begin procedure SetArraySize_Vbez'
   #debug show '#NrElements'
   #debug show #NrElements

   let #_Vbez_size = #NrElements

   #debug show 'end procedure SetArraySize_Vbez'
end-procedure SetArraySize_Vbez



!************************************************
!
begin-procedure GetArrayElement_Versorgungsbezuege(#Index, :$Bemessungsgrundlage, :$Jahr, :$Beginn, :$Ende,
:#line27, :#page27, :#line28, :#page28, :#line29, :#page29)
!
!************************************************
   #debug show 'begin procedure GetArrayElement_Versorgungsbezuege'
   #debug show '#Index'
   #debug show #Index

   if #Index < 0 or #Index >= {MaxNumberVBEZ}
      ! Parameter out of range
      !...
   else

      let $Bemessungsgrundlage = versorgungsbezuege.bemessungsgrundlage(#Index)
      let $Jahr = versorgungsbezuege.jahr(#Index)
      let $Beginn = versorgungsbezuege.beginn(#Index)
      let $Ende = versorgungsbezuege.ende(#Index)
      let #line27 = versorgungsbezuege.posline27(#Index)
      let #page27 = versorgungsbezuege.pageline27(#Index)
      let #line28 = versorgungsbezuege.posline28(#Index)
      let #page28 = versorgungsbezuege.pageline28(#Index)
      let #line29 = versorgungsbezuege.posline29(#Index)
      let #page29 = versorgungsbezuege.pageline29(#Index)

   end-if

   #debug show '$Bemessungsgrundlage'
   #debug show $Bemessungsgrundlage
   #debug show '$Jahr'
   #debug show $Jahr
   #debug show '$Beginn'
   #debug show $Beginn
   #debug show '$Ende'
   #debug show $Ende
   #debug show '#line27'
   #debug show #line27
   #debug show '#page27'
   #debug show #page27
   #debug show '#line28'
   #debug show #line28
   #debug show '#page28'
   #debug show #page28
   #debug show '#line29'
   #debug show #line29
   #debug show '#page29'
   #debug show #page29
   #debug show 'end procedure GetArrayElement_Versorgungsbezuege'

end-procedure GetArrayElement_Versorgungsbezuege
!************************************************



!************************************************
!
begin-procedure GetArrayElement_Sterbegeld(#Index, :$Auszahlung, :$Jahr, :#line30, :#page30, :#line31, :#page31)
!
!************************************************
   #debug show 'begin procedure GetArrayElement_Sterbegeld'
   #debug show '#Index'
   #debug show #Index

   if #Index < 0 or #Index >= {MaxNumberVBEZ}
      ! Parameter out of range
      !...
   else

      let $auszahlung = sterbegeld.auszahlung(#Index)
      let $Jahr = sterbegeld.jahr(#Index)
      let #line30 = sterbegeld.posline30(#Index)
      let #page30 = sterbegeld.pageline30(#Index)
      let #line31 = sterbegeld.posline31(#Index)
      let #page31 = sterbegeld.pageline31(#Index)

   end-if
   #debug show 'end procedure GetArrayElement_Sterbegeld'
end-procedure GetArrayElement_Sterbegeld

!************************************************




! rh - TaxUpdate 2007 20061206 create a new array for StBegVbez
!************************************************
!
begin-procedure GetArrayElement_StBegVbez(#Index, :$StBegVbez, :$bmgfreibetrag, :$Jahr, :$Beginn, :$Ende, :$einmversbezug, :#line27, :#page27, :#line28, :#page28, :#line29, :#page29, :#line30, :#page30)

   #debug show 'begin procedure GetArrayElement_StBegVbez'
   #debug show '#Index'
   #debug show #Index

   if #Index < 0 or #Index >= {MaxNumberVBEZ}
      ! Parameter out of range
      !...
   else

      let $StBegVbez = StBegVbez.zeile8(#Index)
      let $bmgfreibetrag = StBegVbez.bmgfreibetrag(#Index)
      let $Jahr = StBegVbez.jahr(#Index)
      let $Beginn = StBegVbez.beginn(#Index)
      let $Ende = StBegVbez.ende(#Index)
      let $einmversbezug = StBegVbez.einmversbezug(#Index)
      let #line27 = StBegVbez.posline27(#Index)
      let #page27 = StBegVbez.pageline27(#Index)
      let #line28 = StBegVbez.posline28(#Index)
      let #page28 = StBegVbez.pageline28(#Index)
      let #line29 = StBegVbez.posline29(#Index)
      let #page29 = StBegVbez.pageline29(#Index)
      let #line30 = StBegVbez.posline30(#Index)
      let #page30 = StBegVbez.pageline30(#Index)

   end-if

   #debug show '$StBegVbez'
   #debug show $StBegVbez
   #debug show '$bmgfreibetrag'
   #debug show $bmgfreibetrag
   #debug show '$Jahr'
   #debug show $Jahr
   #debug show '$Beginn'
   #debug show $Beginn
   #debug show '$Ende'
   #debug show $Ende
   #debug show '$einmbezug'
   #debug show $einmversbezug




   #debug show 'end procedure GetArrayElement_StBegVbez'
end-procedure GetArrayElement_StBegVbez
!************************************************

! TaxUpdate 2010 Vbez
begin-procedure GetArrayElement_Vbez(#Index, :$Vbez, :$ErmStVBezMKalJahr , :$bmgfreibetrag, :$Jahr, :$Beginn, :$Ende, :$einmversbezug, :#line8, :#page8, :#line9, :#page9, :#line29, :#page29,
:#line30, :#page30, :#line31, :#page31, :#line32, :#page32)

  #DEBUG show 'begin procedure GetArrayElement_Vbez'
  #DEBUG show '#Index ' #Index

   if #Index < 0 or #Index >= {MaxNumberVBEZ}
      ! Parameter out of range
      !...
   else

      let $Vbez = Vbez.zeile8(#Index)
      let $ErmStVBezMKalJahr = Vbez.zeile9(#Index)
      let $bmgfreibetrag = Vbez.bmgfreibetrag(#Index)
      let $Jahr = Vbez.jahr(#Index)
      let $Beginn = Vbez.beginn(#Index)
      let $Ende = Vbez.ende(#Index)
      let $einmversbezug = Vbez.einmversbezug(#Index)
      let #line8 = Vbez.posline8(#Index)
      let #page8 = Vbez.pageline8(#Index)
      let #line9 = Vbez.posline9(#Index)
      let #page9 = Vbez.pageline9(#Index)
      let #line29 = Vbez.posline29(#Index)
      let #page29 = Vbez.pageline29(#Index)
      let #line30 = Vbez.posline30(#Index)
      let #page30 = Vbez.pageline30(#Index)
!NEW
      let #line31 = Vbez.posline31(#Index)
      let #page31 = Vbez.pageline31(#Index)
      let #line32 = Vbez.posline32(#Index)
      let #page32 = Vbez.pageline32(#Index)

   end-if

   #debug show '$bmgfreibetrag = '$bmgfreibetrag
   #debug show '$Jahr'
   #debug show $Jahr
   #debug show '$Beginn'
   #debug show $Beginn
   #debug show '$Ende'
   #debug show $Ende
   #debug show '$einmbezug = ' $einmversbezug

    !show 'end procedure GetArrayElement_Vbez'
end-procedure GetArrayElement_Vbez
!************************************************


!************************************************
!
begin-procedure GetNumberPages(:#NrPages)
!
!************************************************

#debug show 'begin procedure GetNumberPages'
! rh - TaxUpdate 2007 - 20061206 - add logig to trigger different year versions

#debug show 'YEAR ' $_PrcYear

  evaluate $_PrcYear
       !add newer years in here
     when = '2012'
     when = '2011'
     when = '2010'
       do GetPages_2010(#NrPages)
     when = '2008'    ! jjj08-1717018000 -Tax Updates 2008 (Elster)
     when = '2007'

      do GetPages_2007(#NrPages)
     break
     when-other
       !for 2006 and earlier
       do GetPages_2006(#NrPages)
  end-evaluate

#debug show 'nr of pages ' #NrPages
#debug show 'end procedure GetNumberPages'
end-procedure GetNumberPages
!************************************************



!************************************************
begin-procedure GetPages_2006(:#Nr)
!************************************************
#debug show 'begin procedure GetPages_2006'
 let #LastPage = 1
   let #LastEntry = 0
   do GetArraySize_Sterbegeld(#LastEntry)

   if #LastEntry < 0
      ! Sterbegeld array is empty, page number remains on 1
   else
      let #LastEntry = #LastEntry - 1
      do GetArrayElement_Sterbegeld(#LastEntry, $Auszahlung, $Jahr, #line30, #page30, #line31, #page31)
      if #LastPage < #page31
         let #LastPage = #page31
      end-if
   end-if


   let #LastEntry = 0
   do GetArraySize_Versorgungsbezuege(#LastEntry)

   if #LastEntry < 0
      ! Versorgungsbezuege array is empty, page number remains unchanged
   else
      let #LastEntry = #LastEntry - 1
      do GetArrayElement_Versorgungsbezuege(#LastEntry, $Bemessungsgrundlage, $Jahr, $Beginn, $Ende, #line27, #page27, #line28, #page28, #line29, #page29)
      if #LastPage < #page29
         let #LastPage = #page29
      end-if
   end-if

   let #nr = #LastPage
#debug show 'end procedure GetPages_2006'
end-procedure GetPages_2006


!************************************************
begin-procedure GetPages_2007(:#nr)
!************************************************
#debug show 'begin procedure GetPages_2007'

   let #LastPage = 1
   let #LastEntry = 0
   do GetArraySize_StBegVbez(#LastEntry)
   if #LastEntry < 0
      ! Steuerbeguenstige Versorgungsbezuege array is empty, page number remains on 1
   else
      let #LastEntry = #LastEntry - 1
      do GetArrayElement_StBegVbez(#LastEntry, $StBegVbez, $bmgfreibetrag, $Jahr, $Beginn, $Ende, $einmversbezug,  #line27, #page27, #line28, #page28, #line29, #page29, #line30, #page30)

      if #LastPage < #page30
         let #LastPage = #page30
      end-if
   end-if
   let #nr = #LastPage
#debug show 'end procedure GetPages_2007'
end-procedure GetPages_2007
!************************************************
begin-procedure GetPages_2010(:#nr)
#debug show 'begin procedure GetPages_2010'

   let #LastPage = 1
   let #LastEntry = 0
   do GetArraySize_Vbez(#LastEntry)
   if #LastEntry < 0
      ! Steuerbeguenstige Versorgungsbezuege array is empty, page number remains on 1
   else
      let #LastEntry = #LastEntry - 1
      do GetArrayElement_Vbez(#LastEntry, $Vbez, $ErmStVBezMKalJahr, $bmgfreibetrag, $Jahr, $Beginn, $Ende, $einmversbezug,  #line8, #page8, #line9, #page9, #line29, #page29, #line30, #page30, #line31, #page31,#line32,#page32)
      if #LastPage < #page30
         let #LastPage = #page30
      end-if
   end-if
   let #nr = #LastPage
end-procedure GetPages_2010

!************************************************
!
begin-procedure PopulateArray_Versorgungsbezuege($XMLstring, :#NrElements)
!
!************************************************

   #debug show 'begin procedure PopulateArray_Versorgungsbezuege'

   do InitializeArray_Versorgungsbezuege
   do Get-Multiple-Tag-Values($XMLstring, {TagVBEZ_2006}, #NrElements)
   do UpdateArray_PrintPositions_2006

   #debug show 'Number of elements read:'
   #debug show #NrElements

   #debug show 'end procedure PopulateArray_Versorgungsbezuege'
end-procedure PopulateArray_Versorgungsbezuege

!************************************************



!************************************************
!
begin-procedure PopulateArray_Sterbegeld($XMLstring, :#NrElements)
!
!************************************************


   #debug show 'begin procedure PopulateArray_Sterbegeld'

   do InitializeArray_Sterbegeld
   do Get-Multiple-Tag-Values($XMLstring, {TagSterbegeld_2006}, #NrElements)
   do UpdateArray_PrintPositions_2006

   #debug show 'Number of elements read:'
   #debug show #NrElements

   #debug show 'end procedure PopulateArray_Sterbegeld'
end-procedure PopulateArray_Sterbegeld

!************************************************



! rh - TaxUpdate 2007 - 20061206 - populate new array
!************************************************
!
begin-procedure PopulateArray_StBegVbez($XMLstring, :#NrElements)
!
!************************************************

#DEBUG show 'begin procedure PopulateArray_StBegVbez'

   do InitializeArray_StBegVbez
   do InitializeArray_Vbez
!adj Tax update 2010
    if to_number($_PrcYear) > 2009
     do Get-Multiple-Tag-Values($XMLstring, {TagVBEZ_2010}, #NrElements)
     do UpdateArray_PrintPositions_2010
    else
     do Get-Multiple-Tag-Values($XMLstring, {TagVBEZ_2007}, #NrElements)
     do UpdateArray_PrintPositions_2007
    end-if


#debug show 'Number of elements read:'
#debug show #NrElements

#debug show 'end procedure PopulateArray_StBegVbez   #NrElements=' #NrElements
end-procedure PopulateArray_StBegVbez

!************************************************



!************************************************
!
begin-procedure IsXML($XMLString, :#IsXML)
!
!************************************************

   if substr($XMLString, 1, 5) = '<?xml'
      let #IsXML = 1
   else
      let #IsXML = 0
   end-if
end-procedure
!************************************************




!************************************************
!
begin-procedure Get-Multiple-Tag-Values($XMLstring, $Tag, :#NrElements)

#debug show 'begin procedure Get-Multiple-Tag-Values'

   let #Error = 0
   let #ElementCounter = 0
   let $Finished = 'N'
   let $RemainingXML = $XMLstring
   let $TagValue = ''
   while $Finished = 'N'

       #debug show '$remainingxml'

      do Get-Tag-Values($remainingXML, $Tag, $TagValue)

      #debug show '$Tag'
      #debug show $Tag
      #debug show '$TagValue'
      #debug show $TagValue

      if $TagValue = ''
         ! No more values found, break loop
         let $Finished = 'Y'
      else
         ! Increment element counter
         ! Array index must be one lower (starting with 0)
         add 1 to #ElementCounter
         let #ElementIndex = #ElementCounter - 1

         ! Check for array overflow before assigning the array elements
         if #ElementCounter > {MaxNumberVBEZ}
            let #Error = {Error_TooManyItems}
            let $Finished = 'Y'
         end-if

         ! Read the attributes and assign values to array element
         evaluate $Tag
            when = {TagVBEZ_2006}
               do Get-Tag-Attrib($remainingXML, $Tag, 'beginn', $Beginn)
               do Get-Tag-Attrib($remainingXML, $Tag, 'ende', $Ende)
               do Get-Tag-Attrib($remainingXML, $Tag, 'jahr', $Jahr)
             put $TagValue $Jahr $Beginn $Ende 0 0 0 0 0 0 into versorgungsbezuege(#ElementIndex)
               do SetArraySize_Versorgungsbezuege(#ElementCounter)
               break
            when = {TagSterbegeld_2006}
               do Get-Tag-Attrib($remainingXML, $Tag, 'jahr', $Jahr)
               put $TagValue $Jahr 0 0 0 0 into sterbegeld(#ElementIndex)
               do SetArraySize_Sterbegeld(#ElementCounter)
               break

           ! rh - TaxUpdate 2007 - 20061207 - read tag attributes for StBegVBez
            when = {TagVBEZ_2007}
               do Get-Tag-Attrib($remainingXML, $Tag, 'bmgfreibetrag', $bmgfreibetrag)
               do Get-Tag-Attrib($remainingXML, $Tag, 'jahr', $Jahr)
               do Get-Tag-Attrib($remainingXML, $Tag, 'beginn', $Beginn)
               do Get-Tag-Attrib($remainingXML, $Tag, 'ende', $Ende)
               do Get-Tag-Attrib($remainingXML, $Tag, 'einmversbezug', $einmversbezug)
               put $TagValue $bmgfreibetrag $Jahr $Beginn $Ende $einmversbezug 0 0 0 0 0 0 0 0 into StBegVBez(#ElementIndex)
               do SetArraySize_StBegVBez(#ElementCounter)
               break
            !adj10- Tax update 2010
            when = {TagVBEZ_2010}
               !do Get-Tag-Attrib($remainingXML, $Tag, 'ErmStVBezMKalJahr', $ErmStVBezMKalJahr)
               do Get-Tag-Attrib($remainingXML, $Tag, 'VBez', $VBez)                              ! nr 8
               do Get-Tag-Attrib($remainingXML, $Tag, 'ErmStVBezMKalJahr', $ErmStVBezMKalJahr)    ! nr 9
               do Get-Tag-Attrib($remainingXML, $Tag, 'bmgfreibetrag', $bmgfreibetrag)            ! nr 29
               do Get-Tag-Attrib($remainingXML, $Tag, 'jahr', $Jahr)                              ! nr 30
               do Get-Tag-Attrib($remainingXML, $Tag, 'beginn', $Beginn)                          ! nr 31
               do Get-Tag-Attrib($remainingXML, $Tag, 'ende', $Ende)                              ! nr 31
               do Get-Tag-Attrib($remainingXML, $Tag, 'einmversbezug', $einmversbezug)            ! nr 32
               put $TagValue $ErmStVBezMKalJahr $bmgfreibetrag $Jahr $Beginn $Ende $einmversbezug 0 0 0 0 0 0 0 0 0 0 into VBez(#ElementIndex)
               do SetArraySize_VBez(#ElementCounter)
               break

         end-evaluate
#debug show 'getMultipleTagValues XML passed'
#debug show $remainingXML

         ! Truncate XML
         ! search for end tag
         let $EndTag = '</' || $Tag || '>'
         let #EndTagPos = instr($remainingXML, $EndTag, 1)
         if #EndTagPos = 0
            !error handling
            let #Error = {Error_EndTagNotFound}
            let $Finished = 'Y'
         else
            ! truncate XML
            let #NextStartPos = #EndTagPos + length($EndTag)
            let #RemainingLength = length($remainingXML) - #EndTagPos
            let $remainingXML = substrp($remainingXML, #NextStartPos, #RemainingLength)
         end-if
      end-if !if $TagValue = ''
   end-while

   if #Error = 0
      let #NrElements = #ElementCounter
   else
      let #NrElements = -1
   end-if

   #debug show 'Number of elements read:'
   #debug show #NrElements
   #debug show 'Error Code:'
   #debug show #Error

   #debug show 'end procedure Get-Multiple-Tag-Values'
end-procedure Get-Multiple-Tag-Values
!************************************************



!************************************************
!
begin-procedure UpdateArray_PrintPositions_2006
!
!************************************************
   #debug show 'begin procedure UpdateArray_PrintPositions_2006'

   let #NrVBEZ = 0
   let #NrDTHB = 0


   do GetArraySize_Versorgungsbezuege(#NrVBEZ)
   do GetArraySize_Sterbegeld(#NrDTHB)

   ! Do we need to spread VBEZ and DTHB across 2 pages?
   if #NrVBEZ > 1 or #NrDTHB > 1
      ! Multiple pages are required
      ! Start on page 2 with topmost line
      let #PageIndex = {versorgungsbezuege_start_page} !What page are we currently writing the elements to
      ! Add one to first line in table for EUR line
      let #first_line = {FirstLineInTable} + 1
   else
      !Only one page is required
      let #PageIndex = 1
      let #first_line = 0
   end-if
   let #posline29 = 0

   !Initialize loop index
   let #ElementIndex = 0 !Which element in the array are we looking at

   while #ElementIndex < #NrVBEZ
      !27
      if #ElementIndex = 0
         let #posline27 = #first_line
      else
         let #posline27 = #posline29 + {line29size}
         if #posline27 > {maxLinesInBox}
            let #posline27 = #first_line
            add 1 to #PageIndex
         end-if
      end-if
      let versorgungsbezuege.posline27(#ElementIndex) = #posline27
      let versorgungsbezuege.pageline27(#ElementIndex) = #PageIndex
      !28
      let #posline28 = #posline27 + {line27size}
      if #posline28 > {maxLinesInBox}
         let #posline28 = #first_line
         add 1 to #PageIndex
      end-if
      let versorgungsbezuege.posline28(#ElementIndex) = #posline28
      let versorgungsbezuege.pageline28(#ElementIndex) = #PageIndex
      !29
      let #posline29 = #posline28 + {line28size}
      if #posline29 > {maxLinesInBox}
         let #posline29 = #first_line
         add 1 to #PageIndex
      end-if
      let versorgungsbezuege.posline29(#ElementIndex) = #posline29
      let versorgungsbezuege.pageline29(#ElementIndex) = #PageIndex

      add 1 to #ElementIndex
   end-while

   let #ElementIndex = 0
   while #ElementIndex < #NrDTHB
      !30
      if #ElementIndex = 0
         if #posline29 = 0
            let #posline30 = #first_line
         else
            let #posline30 = #posline29 + {line29size}
         end-if
      else
         let #posline30 = #posline31 + {line31size}
      end-if
      if #posline30 > {maxLinesInBox}
         let #posline30 = #first_line
         add 1 to #PageIndex
      end-if
      let sterbegeld.posline30(#ElementIndex) = #posline30
      let sterbegeld.pageline30(#ElementIndex) = #PageIndex
      !31
      let #posline31 = #posline30 + {line30size}
      if #posline31 > {maxLinesInBox}
         let #posline31 = #first_line
         add 1 to #PageIndex
      end-if
      let sterbegeld.posline31(#ElementIndex) = #posline31
      let sterbegeld.pageline31(#ElementIndex) = #PageIndex

      add 1 to #ElementIndex
   end-while

   #debug show 'end procedure UpdateArray_PrintPositions_2006'

end-procedure UpdateArray_PrintPositions_2006
!************************************************


!************************************************
!
begin-procedure UpdateArray_PrintPositions_2007
!
!************************************************
   #debug show 'begin procedure UpdateArray_PrintPositions_2007'

   let #NrStBegVBez = 0
   do GetArraySize_StBegVBez(#NrStBegVBez)
  SHOW ' UpdateArray_PrintPositions_2007 NrStBegVBez = ' #NrStBegVBez
   ! Do we need to spread StBegVBez across 2 pages?
   if #NrStBegVBez > 1
      ! Multiple pages are required
      ! Start on page 2 with topmost line
      let #PageIndex = {versorgungsbezuege_start_page} !What page are we currently writing the elements to
      ! Add one to first line in table for EUR line
      let #first_line = {FirstLineInTable} + 1
   else
      !Only one page is required
      let #PageIndex = 1
      let #first_line = 0
   end-if
   let #posline30 = 0

   !Initialize loop index
   let #ElementIndex = 0 !Which element in the array are we looking at

   while #ElementIndex < #NrStBegVBez
      !27 bmgfreibetrag
      if #ElementIndex = 0
         let #posline27 = #first_line
      else
         let #posline27 = #posline30 + {line30size}
         if #posline27 > {maxLinesInBox}
            let #posline27 = #first_line
            add 1 to #PageIndex
         end-if
      end-if
      let StBegVBez.posline27(#ElementIndex) = #posline27
      let StBegVBez.pageline27(#ElementIndex) = #PageIndex
      !28
      let #posline28 = #posline27 + {line27size}
      if #posline28 > {maxLinesInBox}
         let #posline28 = #first_line
         add 1 to #PageIndex
      end-if
      let StBegVBez.posline28(#ElementIndex) = #posline28
      let StBegVBez.pageline28(#ElementIndex) = #PageIndex
      !29
      let #posline29 = #posline28 + {line28size}
      if #posline29 > {maxLinesInBox}
         let #posline29 = #first_line
         add 1 to #PageIndex
      end-if
      let StBegVbez.posline29(#ElementIndex) = #posline29
      let StBegVBez.pageline29(#ElementIndex) = #PageIndex

      !30
      let #posline30 = #posline29 + {line29size}
      if #posline30 > {maxLinesInBox}
         let #posline30 = #first_line
         add 1 to #PageIndex
      end-if
      let StBegVbez.posline30(#ElementIndex) = #posline30
      let StBegVBez.pageline30(#ElementIndex) = #PageIndex

      !31
      let #posline30 = #posline29 + {line29size}
      if #posline30 > {maxLinesInBox}
         let #posline30 = #first_line
         add 1 to #PageIndex
      end-if
      let StBegVbez.posline30(#ElementIndex) = #posline30
      let StBegVBez.pageline30(#ElementIndex) = #PageIndex


   #debug show #ElementIndex
   #debug show 'pageindex pageline30 after loop'
   #debug show #PageIndex

      add 1 to #ElementIndex
   end-while


   #debug show 'end procedure UpdateArray_PrintPositions_2007'

end-procedure UpdateArray_PrintPositions_2007
!************************************************
!Tax update 2010
!************************************************
!
begin-procedure UpdateArray_PrintPositions_2010

   #debug show 'begin procedure UpdateArray_PrintPositions_2010'

   let #NrStBegVBez = 0
   do GetArraySize_VBez(#NrStBegVBez)
   ! Do we need to spread StBegVBez across 2 pages?
   if #NrStBegVBez > 1
      ! Multiple pages are required
      ! Start on page 2 with topmost line
      let #PageIndex = {versorgungsbezuege_start_page} !What page are we currently writing the elements to
      ! Add one to first line in table for EUR line
      let #first_line = {FirstLineInTable} + 1
   else
      !Only one page is required
      let #PageIndex = 1
      let #first_line = 0
   end-if
   let #posline32 = 0

   !Initialize loop index
   let #ElementIndex = 0 !Which element in the array are we looking at

   while #ElementIndex < #NrStBegVBez
      !27 bmgfreibetrag ! new nr 8
      if #ElementIndex = 0
         let #posline8 = #first_line
      else
         let #posline8 = #posline32 + {line8size_2010} + #ElementIndex
         if #posline8 > {maxLinesInBox}
            let #posline8 = #first_line
            add 1 to #PageIndex
         end-if
      end-if
      let VBez.posline8(#ElementIndex) = #posline8
      let VBez.pageline8(#ElementIndex) = #PageIndex

      !28 new nr 9
      let #posline9 = #posline8 + {line9size_2010}
      if #posline9 > {maxLinesInBox}
         let #posline9 = #first_line
         add 1 to #PageIndex
      end-if
      let VBez.posline9(#ElementIndex) = #posline9
      let VBez.pageline9(#ElementIndex) = #PageIndex
      !29
      let #posline29 = #posline9 + {line29size_2010}
      if #posline29 > {maxLinesInBox}
         let #posline29 = #first_line
         add 1 to #PageIndex
      end-if
      let VBez.posline29(#ElementIndex) = #posline29
      let VBez.pageline29(#ElementIndex) = #PageIndex

      !30
      let #posline30 = #posline29 + {line30size_2010}
      if #posline30 > {maxLinesInBox}
         let #posline30 = #first_line
         add 1 to #PageIndex
      end-if
      let VBez.posline30(#ElementIndex) = #posline30
      let VBez.pageline30(#ElementIndex) = #PageIndex

      !31
      let #posline31 = #posline30 + {line31size_2010}
      if #posline31 > {maxLinesInBox}
         let #posline31 = #first_line
         add 1 to #PageIndex
      end-if
      let VBez.posline31(#ElementIndex) = #posline31
      let VBez.pageline31(#ElementIndex) = #PageIndex

      !32
      let #posline32 = #posline31 + {line31size_2010}
      if #posline32 > {maxLinesInBox}
         let #posline32 = #first_line
         add 1 to #PageIndex
      end-if
      let VBez.posline32(#ElementIndex) = #posline32
      let VBez.pageline32(#ElementIndex) = #PageIndex

   #debug show #ElementIndex
   #debug show 'pageindex pageline30 after loop'
   #debug show #PageIndex

      add 1 to #ElementIndex
   end-while


   #debug show 'end procedure UpdateArray_PrintPositions_2010'

end-procedure UpdateArray_PrintPositions_2010

!************************************************
!
begin-procedure Init-Report
!
!************************************************

   move 'GPDETX01' to $ReportID
   move 'Lohnsteuerbescheinigung' to $ReportTitle

   do Stdapi-Init
   do Get_Type_Options
   do Get-Current-DateTime

   if $prcs_process_instance = ''
      do Ask-Report-Parameters
   else
      do Get-Report-Parameters                    !in GPDEUT06.SQC
      do Get-Values
      !rh SelfService
      do GP-ePay-Init
  end-if

  ! RH2007 R890B09 -- initialize variales contactname and phone
    let $contactName = ''
    let $contactPhone = ''


end-procedure Init-Report
!************************************************




!**************************************************
!
begin-procedure Process-Main
!
!************************************************
#debug show 'begin procedure Process-Main'

   show {gpdeversionstamp}

  show '******* Hotfix folder ******'

!rh - TaxUpdate 2007- 20061206 get running year.  It is needed yearly in the process

!   if  $Ctl_Curr_Pay_End_Dt <> ''
!      do ConvertToComponents($Ctl_Curr_Pay_End_Dt, $PrcYear, $PrcMth, $PrcDay)
!  else
!      let $PrcYear = $Ctl_Year

!  end-if
   
 
   if  $Ctl_Year <> '0'
      let $PrcYear = $Ctl_Year
   else
      do ConvertToComponents($Ctl_Curr_Pay_End_Dt, $PrcYear, $PrcMth, $PrcDay)
       
   end-if


  #debug show 'YEAR '
  #debug show $PrcYear


   let #PROCESSED = 0

   do CX_YearOrMonthCheck
   let $PeriodEndDate = $RefMonthEnd

   let $Gen_EMPLID = substr($prcs_run_cntl_id, 1, 11)

   if $Gen_EMPLID = 'Gen_EMPLID_'
     do RePrintEMPLID
   end-if
!tax update 2010
 let $wert_2010 = ''

   do CheckXMLTestRunOnly
   do CheckTestEnvironment
   do CheckTicketClosed

begin-select
TAX.EMPLID
TAX.EMPL_RCD
TAX.GPDE_TX_YR_CLS_DT
TAX.GPDE_XML_TAX_INFO
P.NAME
T.HIRE_DT
T.TERMINATION_DT
T.GPDE_AL_CPAY_ENDDT                  &T.GPDE_AL_CPAY_ENDDT
T.PRD_BGN_DT         &T.PRD_BGN_DT
!jlj 200505 add new
T.PRD_END_DT
!rh 200611 need paygroup for selfservice
T.GP_PAYGROUP                         &T.GP_PAYGROUP
T.CAL_ID                              &T.CAL_ID
TAX.GPDE_AL_FINANCE_CD
! ADDR.ADDRESS1                         !In case original is cropped
! ADDR.ADDRESS2                         !In case original is cropped
! adj08-1599392000 : XML differs from SQR
!DSV1.DESCR                            !wdu05b6: report distribution

! jjj07 89b11 1651346000 - additional columns fetched for adformat.sqc
! ADDR.ADDRESS3
! ADDR.NUM1
! ADDR.HOUSE_TYPE
! ADDR.POSTAL
! ADDR.CITY
! ADDR.STATE
! ADDR.COUNTY
! ADDR.COUNTRY
! ADDR.GEO_CODE
! ADDR.ADDR_FIELD1
! ADDR.ADDR_FIELD2
! ADDR.ADDR_FIELD3
! ADDR.IN_CITY_LIMIT
#debug show 'Iteration in Process-Main...'

!rh - TaxUpdate 2007- 20061206 SelfService
        let $gpdealcpayenddt = &T.GPDE_AL_CPAY_ENDDT
        let $gpdprdbgndt = &T.PRD_BGN_DT
        let $Pygrp = rtrim(&T.GP_PAYGROUP,' ')
        let $CAL_ID = rtrim(&T.CAL_ID,' ')


        do InitializeArray_Sterbegeld
        do InitializeArray_Versorgungsbezuege
!rh - TaxUpdate 2007- 20061207
 do InitializeArray_StBegVBez
!tax update 2010
  do InitializeArray_VBez

        let #PROCESSED  =  #PROCESSED  + 1
        let $Emplid = &TAX.EMPLID
        let #Empl_Rcd_Num = &TAX.EMPL_RCD

#debug show '$Emplid'
#debug show $Emplid
#debug show '#Empl_Rcd_Num'
#debug show #Empl_Rcd_Num
            
        do Get-Finanzamt-Data(&TAX.GPDE_AL_FINANCE_CD, &T.PRD_END_DT, $FinOfficeIssuer)

        ! jjj07 89b11 1651346000 - populate variables for adformat.sqc
        ! let $ADDRESS1      =        &ADDR.ADDRESS1
        ! let $ADDRESS2      =        &ADDR.ADDRESS2
        let $NAME          =        &P.NAME
        ! let $ADDRESS3      =        &ADDR.ADDRESS3
        ! let $NUM1          =        &ADDR.NUM1
        ! let $HOUSE_TYPE    =        &ADDR.HOUSE_TYPE
        ! let $POSTAL        =        &ADDR.POSTAL
        ! let $CITY          =        &ADDR.CITY
        ! let $STATE         =        &ADDR.STATE
        ! let $COUNTY        =        &ADDR.COUNTY
        ! let $COUNTRY       =        &ADDR.COUNTRY
        ! let $GEO_CODE      =        &ADDR.GEO_CODE
        ! let $ADDR_FIELD1   =        &ADDR.ADDR_FIELD1
        ! let $ADDR_FIELD2   =        &ADDR.ADDR_FIELD2
        ! let $ADDR_FIELD3   =        &ADDR.ADDR_FIELD3
        ! let $IN_CITY_LIMIT =        &ADDR.IN_CITY_LIMIT

        ! bhy10 9UPDD 1970391001 - Print appropriate effective dated Address
        ! SM10-concatinated with 1231 to print adress for emp hired in 2010
        let $PrcYear1 = $PrcYear
        CONCAT '1231' WITH $PrcYear1
        do Format-DateTime($PrcYear1, $AsOfDate, {DEFCMP}, '', 'native')
        do GetAddress($Emplid, $AsOfDate, $ADDRESS1, $ADDRESS2, $NAME, $ADDRESS3, $NUM1, $HOUSE_TYPE, $POSTAL, $CITY, $STATE, $COUNTY, $COUNTRY, $GEO_CODE, $ADDR_FIELD1, $ADDR_FIELD2, $ADDR_FIELD3, $IN_CITY_LIMIT)

        ! jjj07 89b11 1651346000 - format the ADDRess.
        do ADFORMAT
  
        let $Str = $ADDLINE1
        let $Anschriftenzusatz = $ADDLINE2

! adj08-1599392000 : XML differs from SQR
!        let $DistributionText = rtrim(&DSV1.DESCR,' ')  ! wdu05b6: report distribution

        if #PROCESSED > 1
           NEW-PAGE
        end-if

        ! Retrieve XML
        let $origXMLData = &TAX.GPDE_XML_TAX_INFO
        ! fix values such as &, ', >, <. and " in ReplaceSpecialChar
        do ReplaceSpecialChar($origXMLData, $XMLData)

        ! verify basic syntax of XML string
        do IsXML($XMLData, #IsXML)
        if #IsXML <> 0
           ! Determine Year
           do Get-Tag-Attrib($origXMLData ,'Dauer', 'jahr', $Year)

#debug show '$XMLData'
!  show $XMLData

!rh - TaxUpdate 2007- 20061206 get running year.  It is needed yearly in the process
 evaluate $PrcYear
       !add newer years in here
!TU 2010
      when = '2012'
      when = '2011'
     when = '2010'
!     when = '2009' !22-01 adj : let it work for 2006
!end TU
     when = '2008'  ! jjj08-1717018000 -Tax Updates 2008 (Elster)
     when = '2007'
#debug show '2007 - populate array'
           let #NrStBegVBezelements = 0
           do PopulateArray_StBegVBez($XMLData, #NrStBegVBezelements)
     break
     when-other
       !for 2006 and earlier
#debug show 'other years - populate array'
           let #NrVBEZelements = 0
           do PopulateArray_Versorgungsbezuege($XMLData, #NrVBEZelements)
           let #NrDTHBENelements = 0
           do PopulateArray_Sterbegeld($XMLData, #NrDTHBENelements)
  end-evaluate


  ! Find out if multiple pages are needed for Versorgungsbezuege
           do GetNumberPages(#NrPages)

           let #PageNumber = 1
           do Layout
           do Parse-Vals
!Tax update 2010: from 2010, wert values are reported only on page 2
  if to_number($PrcYear) >= 2010
    do Get-Extra-Line-Values($origXMLData, 'Wert', 'Text1', $Wert1)
    do Get-Extra-Line-Values($origXMLData, 'Text', 'Text1', $Text1)
     if rtrim($Wert1, ' ') <> ''
        let #NrPages = 2
        let $wert_2010 = 'Y'
     end-if
  end-if
           while #PageNumber < #NrPages
              new-page
                add 1 to #PageNumber
              do Layout
              do Parse-Vals
           end-while

           ! $start_date  and $Termdt are initially set in Parse-vals
           do Format-DateTime(&T.HIRE_DT,$cmp_Hiredt,{DEFCMP},'','')
           do Format-DateTime(&T.TERMINATION_DT,$cmp_Termdt,{DEFCMP},'','')
           do Format-DateTime($start_date,$cmp_start_date,{DEFCMP},'','')
           do Format-DateTime($Termdt,$cmp_last_date,{DEFCMP},'','')
           if $cmp_Hiredt > $cmp_start_date
             let $start_date = &T.HIRE_DT
           end-if

           if $cmp_Termdt < $cmp_last_date and rtrim(&T.TERMINATION_DT, ' ') <> ''
             let $Termdt = &T.TERMINATION_DT
           end-if

           if $Tax_Card_Close = 'Y'
              do Update_TaxCard
           else
              ! this branch used to update the ticket number on the run control record
              ! this has been moved to the runcontrol component, RowInit PCode
           end-if
        end-if

        !rh SelfService
         do GP-ePay-Guide
 !reset
 let $wert_2010 = ''

FROM PS_GPDE_TX_DATA TAX,
     PS_GPDE_RP_0001 T ,
     PS_NAMES P
     ! PS_ADDRESSES ADDR,
! adj08-1599392000 : XML differs from SQR ( UNCOMMENTED)
!     PS_GPDE_RP_DIST_VW DSV1              ! wdu05b6: report distribution
WHERE
! RP 0001
    T.PRD_END_DT = $PeriodEndDate
AND T.GPDE_AL_CPAY_ENDDT = (select max(PBD0.GPDE_AL_CPAY_ENDDT)
         from PS_GPDE_RP_0001 PBD0
         where PBD0.EMPLID = T.EMPLID
         AND PBD0.EMPL_RCD = T.EMPL_RCD
         AND PBD0.PRD_END_DT = T.PRD_END_DT)
! remove
!AND T.SEG_END_DT =  (select max(PBD3.SEG_END_DT)
!         from PS_GPDE_RP_0001 PBD3
!         where PBD3.EMPLID = T.EMPLID
!         AND PBD3.GPDE_AL_CPAY_ENDDT = T.GPDE_AL_CPAY_ENDDT
!         AND PBD3.PRD_END_DT = T.PRD_END_DT
!         AND PBD3.EMPL_RCD = T.EMPL_RCD )
! Tax Data
AND TAX.GPDE_XML_TAX_INFO is not NULL
AND TAX.GPDE_ELSTER_TKT  = $ELSTER_Ticket
AND TAX.EMPLID = T.EMPLID
AND TAX.EMPL_RCD = T.EMPL_RCD
AND TAX.EFFDT = (SELECT MAX(EFFDT) FROM PS_GPDE_TX_DATA TAX1
                   WHERE TAX1.EMPLID   = TAX.EMPLID
                   AND   TAX1.EMPL_RCD = TAX.EMPL_RCD
                   ! AND TAX1.EFFDT   <= T.PRD_END_DT
                   AND   TAX1.EFFDT   <= T.SEG_END_DT
                   )
! Names
AND P.EMPLID = T.EMPLID
AND P.NAME_TYPE = (select NMTVW.NAME_TYPE from PS_GPDE_NMTYPE1_VW NMTVW where NMTVW.EMPLID = P.EMPLID AND NMTVW.EFFDT =
                                ( select MAX(NMTVW2.EFFDT) from  PS_GPDE_NMTYPE1_VW NMTVW2
                                       where NMTVW2.EMPLID = NMTVW.EMPLID
                                         AND NMTVW2.EFFDT <= T.GPDE_AL_CPAY_ENDDT) )   ! jjj
AND P.EFFDT =(select max(PERN1.EFFDT)
                 from PS_NAMES PERN1
                 WHERE PERN1.EMPLID = P.EMPLID
                 AND PERN1.NAME_TYPE = P.NAME_TYPE ! jjj
                 AND PERN1.EFFDT <= T.GPDE_AL_CPAY_ENDDT)
! ADDRESSES
! AND ADDR.ADDRESS_TYPE = $Addr_Type
! AND ADDR.EMPLID = T.EMPLID
! AND ADDR.EFFDT =(SELECT MAX(AD2.EFFDT)
!                  FROM PS_ADDRESSES AD2
!                  WHERE AD2.EMPLID      = ADDR.EMPLID
!                  AND AD2.ADDRESS_TYPE  = ADDR.ADDRESS_TYPE
!                  AND AD2.EFFDT        <= $AsofToday)
! GPDE_RP_DIST_VW
! wdu05b6: report distribution
!adj08-1599392000 : XML differs from SQR
!AND T.EMPLID=DSV1.EMPLID
!AND T.EMPL_RCD=DSV1.EMPL_RCD
[$emplid_clause]
[$Sort_Order]

end-select

   do Update_XMLRec
   if #PROCESSED = 0
      display 'No employees have this Ticket Number: ' NoLine
      display $ELSTER_Ticket
   end-if


end-procedure Process-Main

!***************************************************

begin-procedure Parse-Vals
#debug show 'begin procedure Parse-Vals'
#debug show '$Year'
#debug show $Year
#debug show '#PageNumber'
#debug show #PageNumber

   alter-printer
      font = 4
      point-size = #PointSizeAddressNormal

!Name and Address information
   do Get-Tag-Values($XMLData ,'Person', $Person)
   do Get-Tag-Values($XMLData ,'Adresse', $Adresse)

   do Get-Tag-Values($Person ,'Titel', $Titel)
   do Get-Tag-Values($Person ,'Vorname',$Vorname)
   do Get-Tag-Values($Person ,'Namensvorsatz', $Namensvorsatz)
   do Get-Tag-Values($Person ,'Name',$Name1)
   do Get-Tag-Values($Person ,'Namezusatz', $Namezusatz)

   do Get-Tag-Values($Adresse ,'PLZ',$PLZ)
   if rtrim($PLZ, ' ') = ''
      do Get-Tag-Values($Adresse ,'AuslandsPLZ',$PLZ)
   end-if
   do Get-Tag-Values($Adresse ,'Ort',$Ort)

   !wdu05b6: print internal distribution code above title, right adjusted
   !jlj05B7: lowered the Address a 6 lines and added return address information
   let #DistPos = 25 - length($DistributionText) + #col1
   print $DistributionText                         (16,#DistPos) bold

!hardcode Herrn or Frau

      do Get-Tag-Attrib($XMLData, 'Person', 'geschlecht', $Sex)
      if $Sex = 'M'
         print 'Herrn'                               (17, #col1) bold
      else
         print 'Frau'                                (17, #col1) bold
      end-if

   if rtrim($Titel, ' ') <> ''
      let $Titel = rtrim($Titel, ' ') || ' '
   end-if

   let $Name1 = $Titel || rtrim($Vorname, ' ')  || ' ' || rtrim($Namensvorsatz, ' ')  ||' ' || rtrim($Name1, ' ')  ||' ' ||  $Namezusatz
   print $Name1                                     (18, #col1) bold

   ! jjj07 89b11 1651346000
!adj09-1868035000: Print address from column 2
     let #addressline = 19
     if $ADDLINE2 <> ''
        print $ADDLINE2  (#addressline, 2)
        let #addressline = #addressline + 1
     end-if
     if $ADDLINE3 <> ''
        print $ADDLINE3  (#addressline,2)
        let #addressline = #addressline + 1
     end-if
     if $ADDLINE31 <> ''
        print $ADDLINE31 (#addressline,2)
        let #addressline = #addressline + 1
     end-if
     if $ADDLINE4 <> ''
        print $ADDLINE4  (#addressline,2)
        let #addressline = #addressline + 1
     end-if
     if $ADDLINE5 <> ''
        print $ADDLINE5  (#addressline,2)
        let #addressline = #addressline + 1
     end-if
     if $ADDLINE6 <> ''
        print $ADDLINE6  (#addressline,2)
        let #addressline = #addressline + 1
     end-if


! commented jjj07 89b11 1651346000
! print $Str                                       (19, #col1) bold
! print $Anschriftenzusatz                         (20, #col1) bold

! let $Zip = rtrim($PLZ, ' ') ||' ' || $Ort
! print $Zip                                       (21, #col1) bold

   alter-printer
      font = 4
      point-size = #PointSizeTextNormal

   !Personal Info, all pages
   !- eTin
   !- Emplid
   do Get-Tag-Values($XMLData ,'ETIN',$ETIN)
   print $ETIN                                      (25, #col3)
!adj09: taxupdate 2010 - Print Tax id.
   if to_number($PrcYear) > 2009
     do Get-Tag-Values($XMLData ,'IdNr',$IdNr)
     print $IdNr                                    (26, #col3)
   end-if

   do Get-Tag-Values($XMLData ,'Ordnungsmerkmal', $Ordnungsmerkmal)
   if to_number($PrcYear) > 2009
     print $Ordnungsmerkmal                           (27,  #col3)
   else
     print $Ordnungsmerkmal                           (26,  #col3)
   end-if
   if #PageNumber = 1
      !Personal Info, first page only

      do Get-Tag-Values($XMLData ,'Geburtsdatum', $Geburtsdatum)
      let $Birthdate = substr($Geburtsdatum, 7, 2) || {MonthYearSeparator} || substr($Geburtsdatum, 5, 2) || {MonthYearSeparator} || substr($Geburtsdatum, 1, 4)
      if to_number($PrcYear) > 2009
        print $Birthdate                                 (28,  #col3)

        print $ELSTER_Ticket                             (29, #col3)
      else
        print $Birthdate                                 (27,  #col3)

        print $ELSTER_Ticket                             (28, #col3)
      end-if

      !Start and End Days
      do Get-Tag-Values($XMLData ,'Anfang', $Anfang)
      do Get-Tag-Values($XMLData ,'Ende', $Ende)

      let $startDay = substr($Anfang, 1, 2)
      let $startMonth = substr($Anfang, 3, 2)
      let $endDay = substr($Ende, 1, 2)
      let $endMonth = substr($Ende, 3, 2)

      let $start_date = $Year || $startMonth || $startDay || '0000'
      let $Termdt  = $Year || $endMonth || $endDay || '0000'

      do Format-DateTime($start_date , $out, {DEFCMP},'','native')
      do Format-DateTime($Termdt   , $out2, {DEFCMP},'','native')
      let $start_date = rtrim($out, ' ')
      let $Termdt  = rtrim($out2, ' ')
      let $FromDt =  $startDay  || {MonthYearSeparator} || $startMonth || {MonthYearSeparator}
      let $ToDt   =  $endDay    || {MonthYearSeparator} || $endMonth || {MonthYearSeparator}

      !Info direct from the Tax Card

      do TaxCardValues($Emplid, #Empl_Rcd_Num, #col1, #col3, $ToDt, $start_date, $Termdt, $PeriodEndDate)

!      do Get-Tag-Values($XMLData , 'AGS', $AGS)
!      print $AGS                                       (63,  #col2)
!      print $FinOfficeIssuer                           (65,  #col3)

      !Employer Information
      do Get-Tag-Values($XMLData ,'Arbeitgeber', $Arbeitgeber)
      do Get-Tag-Values($Arbeitgeber ,'ArbGName', $ArbGName)
      do Get-Tag-Values($Arbeitgeber ,'Adresse', $AdresseER)
      do Get-Tag-Values($AdresseER ,'Str',$StrER)
      do Get-Tag-Values($AdresseER ,'Hausnummer',$HausnummerER)
      do Get-Tag-Values($AdresseER ,'HNrZusatz',$HNrZusatzER)
      do Get-Tag-Values($AdresseER ,'Anschriftenzusatz', $AnschriftenzusatzER)
      do Get-Tag-Values($AdresseER ,'PLZ',$PLZER)
      if rtrim($PLZER, ' ') = ''
          do Get-Tag-Values($AdresseER ,'AuslandsPLZ',$PLZER)
      end-if

      do Get-Tag-Values($AdresseER ,'Ort',$OrtER)

      print $ArbGName                                  (68, #col1) bold
      let $StrER = rtrim($StrER, ' ') ||' ' || rtrim($HausnummerER, ' ') ||' ' || rtrim($HNrZusatzER, ' ')
      print $StrER                                     (69, #col1) bold
      print $AnschriftenzusatzER                       (70, #col1) bold

      let $ZipER = rtrim($PLZER, ' ') ||' ' || $OrtER
      print $ZipER                                     (71, #col1) bold

   end-if !#PageNumber = 1

   !jlj05B7: adding Employer as return address

   let $LineBreak = ', '

   alter-printer
      font = 4
      point-size = #PointSizeAddressSmall

   if rtrim($AnschriftenzusatzER, ' ') <> ''
       let $additionalER = $AnschriftenzusatzER || $LineBreak
   else
       let $additionalER = ''
   end-if

   let $RetAddress = $ArbGName || $LineBreak || $StrER || $LineBreak || $additionalER || $ZipER
   print $RetAddress                                (14, #col1)

   alter-printer
      font = 4
      point-size = #PointSizeTextNormal

   if #PageNumber = 1

      !Tax items
      !1
      let $FromTo =  '    ' || $FromDt || ' - ' || $ToDt
      let #currline = #posline1 + 1
      print $FromTo                                    (#currline,#dates)

      !2
      do Get-Tag-Values($XMLData ,'AnzahlU', $AnzahlU)
      let #currline = #posline2 + 1
      print $AnzahlU (#currline, #col10)

      !2005 Grossbuchstaben
      do Get-Tag-Values($XMLData ,'Grossbuchstaben', $Grossbuchstaben)
      do getGrossbuchstaben($Grossbuchstaben,$GrossbuchstabenNew)
      !let $GrossbuchstabenNew = '  '|| $GrossbuchstabenNew
      let #currline = #poslinegrossbuchstaben
      print $GrossbuchstabenNew                        (#currline,  #col8center)

      alter-printer
         font = 3
         point-size = #PointSizeAmounts

      !3
      do Get-Tag-Values($XMLData ,'BruttoArbLohn', $BruttoArbLohn)
      let #BruttoArbLohn = to_number($BruttoArbLohn)
      do Get_Before_After_Comma(#BruttoArbLohn ,$Num1,$Num2)
#debug show 'BruttoArbLohn'
#debug show #BruttoArbLohn
#debug show '$Num1'
#debug show $Num1
#debug show '$Num2'
#debug show $Num2

      let #currline = #posline3
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !4
      do Get-Tag-Values($XMLData ,'LSteuer', $LSteuer)
      let #LSteuer = to_number($LSteuer)
      do Get_Before_After_Comma(#LSteuer ,$Num1,$Num2)
      let #currline = #posline4
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !5
      do Get-Tag-Values($XMLData ,'Soli', $Soli)
      let #Soli = to_number($Soli)
      do Get_Before_After_Comma(#Soli ,$Num1,$Num2)
      let #currline = #posline5
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !6
      do Get-Tag-Values($XMLData ,'ArbnKiSteuer', $ArbnKiSteuer)
      let #ArbnKiSteuer = to_number($ArbnKiSteuer)
      do Get_Before_After_Comma(#ArbnKiSteuer ,$Num1,$Num2)
      let #currline = #posline6
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !7
      do Get-Tag-Values($XMLData ,'EhegKiSteuer', $EhegKiSteuer)
      let #EhegKiSteuer = to_number($EhegKiSteuer)
      do Get_Before_After_Comma(#EhegKiSteuer ,$Num1,$Num2)
      let #currline = #posline7
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !8

      !rh - TaxUpdate 2007 - 10061207 need to get StBegVBez from array for 2007
      evaluate $PrcYear
          !add newer years in here
      when >= '2010'
         do getarraysize_vbez(#NrElements)
        if #NrElements = 1
          do Get-Tag-Values($XMLData ,'VBez', $StBegVbez)
          let #StBegVbez = to_number($StBegVbez)
          !let #StBegVbez =  Vbez.zeile8(0)
        else ! vbez is printed on 2nd page
           let $StBegVbez = ''
           let #StBegVbez = to_number($StBegVbez)
        end-if
      when = '2008'   ! jjj08-1717018000 -Tax Updates 2008 (Elster)
      when = '2007'
         let #StBegVbez = StBegVbez.zeile8(0)
      when-other
         do Get-Tag-Values($XMLData ,'StBegVBez', $StBegVbez)
         let #StBegVbez = to_number($StBegVbez)
      end-evaluate

      do Get_Before_After_Comma(#StBegVbez ,$Num1,$Num2)
      let #currline = #posline8
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !9
!Tax update: 2010
    if to_number($PrcYear) > 2009
      do Get-Tag-Values($XMLData ,'ErmStVBezMKalJahr', $ErmStVBezMKalJahr)
      let #ErmStVBezMKalJahr = to_number($ErmStVBezMKalJahr)
      do Get_Before_After_Comma(#ErmStVBezMKalJahr ,$Num1,$Num2)
      let #currline = #posline9
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
    else
      do Get-Tag-Values($XMLData ,'StBegVBezMKalJahr', $StBegVBezMKalJahr)
      let #StBegVBezMKalJahr = to_number($StBegVBezMKalJahr)
      do Get_Before_After_Comma(#StBegVBezMKalJahr ,$Num1,$Num2)
      let #currline = #posline9
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
    end-if
      !10
      do Get-Tag-Values($XMLData ,'ErmStBetrMKalJahr', $ErmStBetrMKalJahr)
      let #ErmStBetrMKalJahr = to_number($ErmStBetrMKalJahr)
      do Get_Before_After_Comma(#ErmStBetrMKalJahr ,$Num1,$Num2)
      let #currline = #posline10
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !11
      do Get-Tag-Values($XMLData ,'LSteuerMKalJahr', $LSteuerMKalJahr)
      let #LSteuerMKalJahr = to_number($LSteuerMKalJahr)
      do Get_Before_After_Comma(#LSteuerMKalJahr ,$Num1,$Num2)
      let #currline = #posline11
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !12
      do Get-Tag-Values($XMLData ,'SoliMKalJahr', $SoliMKalJahr)
      let #SoliMKalJahr = to_number($SoliMKalJahr)
      do Get_Before_After_Comma(#SoliMKalJahr ,$Num1,$Num2)
      let #currline = #posline12
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !13
      do Get-Tag-Values($XMLData ,'KiSteuerArbnMKalJahr', $KiSteuerArbnMKalJahr)
      let #KiSteuerArbnMKalJahr = to_number($KiSteuerArbnMKalJahr)
      do Get_Before_After_Comma(#KiSteuerArbnMKalJahr ,$Num1,$Num2)
      let #currline = #posline13
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !14
      do Get-Tag-Values($XMLData ,'KiSteuerEhegMKalJahr', $KiSteuerEhegMKalJahr)
      let #KiSteuerEhegMKalJahr = to_number($KiSteuerEhegMKalJahr)
      do Get_Before_After_Comma(#KiSteuerEhegMKalJahr ,$Num1,$Num2)
      let #currline = #posline14
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !15
      do Get-Tag-Values($XMLData ,'KurzArbGeld', $KurzArbGeld)
      let #KurzArbGeld = to_number($KurzArbGeld)
      do Get_Before_After_Comma(#KurzArbGeld  ,$Num1,$Num2)
      let #currline = #posline15
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !16a
      do Get-Tag-Values($XMLData ,'StFreiArbLohnDBA', $StFreiArbLohnDBA)
      let #StFreiArbLohnDBA = to_number($StFreiArbLohnDBA)
      do Get_Before_After_Comma(#StFreiArbLohnDBA ,$Num1,$Num2)
      let #currline = #posline16a
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !16b
      do Get-Tag-Values($XMLData ,'StFreiArbLohnATE', $StFreiArbLohnATE)
      let #StFreiArbLohnATE = to_number($StFreiArbLohnATE)
      do Get_Before_After_Comma(#StFreiArbLohnATE ,$Num1,$Num2)
      let #currline = #posline16b
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !17
      do Get-Tag-Values($XMLData ,'StFreiArbgLeistg', $StFreiArbgLeistg)
      let #StFreiArbgLeistg = to_number($StFreiArbgLeistg)
      do Get_Before_After_Comma(#StFreiArbgLeistg ,$Num1,$Num2)
      let #currline = #posline17
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !18
      do Get-Tag-Values($XMLData ,'PauschArbgLeistg', $PauschArbgLeistg)
      let #PauschArbgLeistg = to_number($PauschArbgLeistg)
      do Get_Before_After_Comma(#PauschArbgLeistg ,$Num1,$Num2)
      let #currline = #posline18
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !19
      do Get-Tag-Values($XMLData ,'StPflichtArbLohnMKalJahr', $StPflichtArbLohnMKalJahr)
      let #StPflichtArbLohnMKalJahr = to_number($StPflichtArbLohnMKalJahr)
      do Get_Before_After_Comma(#StPflichtArbLohnMKalJahr ,$Num1,$Num2)
      let #currline = #posline19
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !20
      do Get-Tag-Values($XMLData ,'StFreiVerpfleg', $StFreiVerpfleg)
      let #StFreiVerpfleg = to_number($StFreiVerpfleg)
      do Get_Before_After_Comma(#StFreiVerpfleg ,$Num1,$Num2)
      let #currline = #posline20
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !21
      do Get-Tag-Values($XMLData ,'StFreiDopHaushalt', $StFreiDopHaushalt)
      let #StFreiDopHaushalt = to_number($StFreiDopHaushalt)
      do Get_Before_After_Comma(#StFreiDopHaushalt ,$Num1,$Num2)
      let #currline = #posline21
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
  
! do Format-DateTime($PrcYear, $Prcyear1, {DEFCMP}, '', 'native')
! do ConvertToComponents($PrcYear1,$yr,$mm09,$dd09)
 
  if to_number($PrcYear) >= 2011
      
      !22a
      do Get-Tag-Values($XMLData ,'ArbgAnteilRenVers', $ArbgAnteilRenVers)
      let #ArbgAnteilRenVers = to_number($ArbgAnteilRenVers)
      do Get_Before_After_Comma(#ArbgAnteilRenVers ,$Num1,$Num2)
      let #currline = #posline22a
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !22b
      do Get-Tag-Values($XMLData ,'ArbgAnteilBerufsVers', $ArbgAnteilBerufsVers)
      let #ArbgAnteilBerufsVers = to_number($ArbgAnteilBerufsVers)
      do Get_Before_After_Comma(#ArbgAnteilBerufsVers ,$Num1,$Num2)
      let #currline = #posline22b
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !23a
      do Get-Tag-Values($XMLData ,'ArbnAnteilRenVers', $ArbnAnteilRenVers)
      let #ArbnAnteilRenVers = to_number($ArbnAnteilRenVers)
      do Get_Before_After_Comma(#ArbnAnteilRenVers ,$Num1,$Num2)
      let #currline = #posline23a
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !23b
      do Get-Tag-Values($XMLData ,'ArbnAnteilBerufsVers', $ArbnAnteilBerufsVers)
      let #ArbnAnteilBerufsVers = to_number($ArbnAnteilBerufsVers)
      do Get_Before_After_Comma(#ArbnAnteilBerufsVers ,$Num1,$Num2)
      let #currline = #posline23b
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
   else
      
      !22
      do Get-Tag-Values($XMLData ,'ArbgAnteilRenVers', $ArbgAnteilRenVers)
      let #ArbgAnteilRenVers = to_number($ArbgAnteilRenVers)
      do Get_Before_After_Comma(#ArbgAnteilRenVers ,$Num1,$Num2)
      let #currline = #posline22
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !23
      do Get-Tag-Values($XMLData ,'ArbnAnteilRenVers', $ArbnAnteilRenVers)
      let #ArbnAnteilRenVers = to_number($ArbnAnteilRenVers)
      do Get_Before_After_Comma(#ArbnAnteilRenVers ,$Num1,$Num2)
      let #currline = #posline23
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
  end-if
      if to_number($PrcYear) > 2011
!24a
      do Get-Tag-Values($XMLData ,'StFreiGeKrankVers', $StFreiGeKrankVers)
      let #StFreiGeKrankVers = to_number($StFreiGeKrankVers)
      do Get_Before_After_Comma(#StFreiGeKrankVers ,$Num1,$Num2)
      let #currline = #posline24a + 1
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
!24b
      do Get-Tag-Values($XMLData ,'StFreiPrKrankVers', $StFreiPrKrankVers)
      let #StFreiPrKrankVers = to_number($StFreiPrKrankVers)
      do Get_Before_After_Comma(#StFreiPrKrankVers ,$Num1,$Num2)
      let #currline = #posline24b + 1
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
!24c
      do Get-Tag-Values($XMLData ,'StFreiGePflegeVers', $StFreiGePflegeVers)
      let #StFreiGePflegeVers = to_number($StFreiGePflegeVers)
      do Get_Before_After_Comma(#StFreiGePflegeVers ,$Num1,$Num2)
      let #currline = #posline24c + 1
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
 else
     !24
      do Get-Tag-Values($XMLData ,'StFreiArbgZuschKrankVers', $StFreiArbgZuschKrankVers)
      let #StFreiArbgZuschKrankVers = to_number($StFreiArbgZuschKrankVers)
      do Get_Before_After_Comma(#StFreiArbgZuschKrankVers ,$Num1,$Num2)
      let #currline = #posline24
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
 end-if

!tax udpate 2010
!25
    if to_number($PrcYear) > 2009
      do Get-Tag-Values($XMLData ,'ArbnAnteilKrankVers', $ArbnAnteilKrankVers)
      let #ArbnAnteilKrankVers = to_number($ArbnAnteilKrankVers)
      do Get_Before_After_Comma(#ArbnAnteilKrankVers ,$Num1,$Num2)
      let #currline = #posline25
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !26
      do Get-Tag-Values($XMLData ,'ArbnAnteilPflegVers', $ArbnAnteilPflegVers)
      let #ArbnAnteilPflegVers = to_number($ArbnAnteilPflegVers)
      do Get_Before_After_Comma(#ArbnAnteilPflegVers ,$Num1,$Num2)
      let #currline = #posline26
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !27
      do Get-Tag-Values($XMLData ,'ArbnAnteilArblVers', $ArbnAnteilArblVers)
      let #ArbnAnteilArblVers = to_number($ArbnAnteilArblVers)
      do Get_Before_After_Comma(#ArbnAnteilArblVers ,$Num1,$Num2)
      let #currline = #posline27
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !28
      do Get-Tag-Values($XMLData ,'BeitrPrKrankVers', $BeitrPrKrankVers)
      let #BeitrPrKrankVers = to_number($BeitrPrKrankVers)
      do Get_Before_After_Comma(#BeitrPrKrankVers ,$Num1,$Num2)
      let #currline = #posline28 ! #posline33
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

    Else
     !25
      do Get-Tag-Values($XMLData ,'ArbnAnteilSozVers', $ArbnAnteilSozVers)
      let #ArbnAnteilSozVers = to_number($ArbnAnteilSozVers)
      do Get_Before_After_Comma(#ArbnAnteilSozVers ,$Num1,$Num2)
      let #currline = #posline25
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !26
      do Get-Tag-Values($XMLData ,'AusgezKinderGeld', $AusgezKinderGeld)
      let #AusgezKinderGeld = to_number($AusgezKinderGeld)
      do Get_Before_After_Comma(#AusgezKinderGeld ,$Num1,$Num2)
      let #currline = #posline26
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)
    end-if

   end-if !if #PageNumber = 1

   do YearlyCode

   if #PageNumber = 1
      ! Finanzamt at bottom of right hand box
      do Get-Tag-Values($XMLData ,'ArbGFANr', $ArbGFANr)

      do Get-Tag-Values($XMLData ,'ArbGFAName', $ArbGFAName)
      let #currline = #poslinefinanzamt + 2
      print $ArbGFAName                            (#currline, #col5)

      let $Comp1 = substr($ArbGFANr, 1, 1)
      let $Comp2 = substr($ArbGFANr, 2, 1)
      let $Comp3 = substr($ArbGFANr, 3, 1)
      let $Comp4 = substr($ArbGFANr, 4, 1)
      print $Comp1                                 (#currline, 65)
      print $Comp2                                 (#currline, 68)
      print $Comp3                                 (#currline, 71)
      print $Comp4                                 (#currline, 74)
   end-if

   #debug show 'end procedure Parse-Vals'
end-procedure Parse-Vals

!**************************************************

begin-procedure Layout
#debug show 'begin procedure Layout'
#debug show '$Year'
#debug show $Year
#debug show '#PageNumber'
#debug show #PageNumber

   !afi
   ! This parameter indicates the first line of the table
   let #firstline = 1
   let #pageLine = 78

   let #PointSizeAlarm = 50
   let #PointSizeAlarmSmall = 30
   let #PointSizeHeader1 = 13
   let #PointSizeHeader2 = 10
   let #PointSizeAddressNormal = 10
   let #PointSizeAddressSmall = 8
   let #PointSizeTextNormal = 8.4
   let #PointSizeTextSmall = 7.4
   let #PointSizeAmounts = 8
   let #PointSizeTextSmall_2010 = 7

   let #col1  =    2
   let #col2  =    9
   let #col3  =   19
   let #col4  =   26
   let #col5  =   40
   let #col6  =   42
   let #col7  =   55
   let #col7a =  53 
   let #col8  =   68
   let #col9  =   67  !EUROS
   let #col10 =   74  !CENTS
   let #col11 =   77

   let #col5line = #col5 - 1
   let #col7line = #col7 - 1
   let #col8line = #col8

   let #col8center = #col8 + (#col10-#col8)/2

   let #dates = #col9
   let #labelwidth = 29
   let #euroswidth =  6
   let #centwidth =   2
   let #boxwidth = #labelwidth + #euroswidth + #centwidth

   alter-printer
      font = 4
      point-size = #PointSizeHeader1

   let $title = 'Lohnsteuerbescheinigung fr ' || $Year
   print $title                                 (2, #col1)

   alter-printer
      font = 4
      point-size = #PointSizeHeader2

   print 'Nachstehende Daten wurden maschinell bertragen.' (3, #col1)

   if $Tax_Card_Close <> 'Y' OR ($XMLTestRun = 'Y' and $TestEnvironment <> 'Y')
      let $Entwurf = 'Y'
   else
      let $Entwurf = 'N'
   end-if
 
   if $Entwurf = 'Y'
      !afi: Entwurf moves to the left only
      alter-printer
         font = 4
         point-size = #PointSizeAlarm
      if $Tax_Card_Close <> 'T'
      let $PreliminPrint = '- Entwurf -'
      end-if
      if $TestEnvironment = 'Y'
         let #posEntwurf = 8
      else
         let #posEntwurf = 10
      end-if

      print $PreliminPrint                      (#posEntwurf, #col1)

   end-if

   if $TestEnvironment = 'Y'
      alter-printer
         font = 4
         point-size = #PointSizeAlarmSmall
      if $Entwurf = 'Y'
         let #posTestEnv = 12
      else
         let #posTestEnv = 10
      end-if
      print '- Testumgebung -'    (#posTestEnv, #col1)
   end-if

   if rtrim($ContactName, ' ') = ''
      do Get-Tag-Values($XMLData ,'ContactName', $ContactName)
   end-if

   if rtrim($ContactPhone, ' ') = ''
      do Get-Tag-Values($XMLData ,'ContactPhone', $ContactPhone)
   end-if

   alter-printer
      font = 4
      point-size = #PointSizeTextNormal

   print 'eTIN:'                                (25, #col1)
!adj09:taxupdate 2010- print Tax id
  if to_number($PrcYear) > 2009
   print 'Identifikationsnummer'                     (26, #col1)
   print 'Personalnummer:'            (27, #col1)
  else
     print 'Personalnummer:'          (26, #col1)
  end-if


   if #PageNumber = 1
      if to_number($PrcYear) > 2009
        print 'Geburtsdatum:'                               (28, #col1)
        print 'Transferticket:'                             (29, #col1)
        print 'Dem Lohnsteuerabzug wurden zugrunde gelegt:' (31, #col1)          Bold
      else
        print 'Geburtsdatum:'                        (27, #col1)
        print 'Transferticket:'                      (28, #col1)
        print 'Dem Lohnsteuerabzug wurden zugrunde gelegt:' (30, #col1)          Bold
      end-if

      print 'Steuerklasse'                         (32, #col1)
!adj09:taxupdate 2010- Print Faktor
     if to_number($PrcYear) > 2009
      print '                      /Faktor'          (32, #col1)
     end-if
      print '    vom - bis'                        (32, #col3)

      print 'Zahl der'                             (37, #col1)
      print 'Kinderfreibetrge'                    (38, #col1)   !
      print '    vom - bis'                         (38, #col3)

      print 'Steuerfreier Jahresbetrag'            (42, #col1)
      print '    vom - bis'                        (42, #col3)

      print 'Hinzurechnungsbetrag'                 (47, #col1)
      print '    vom - bis'                        (47, #col3)

      print 'Kirchensteuermerkmale'                (52, #col1)
      print '    vom - bis'                        (52, #col3)

      print 'Vorgelegen hat: '                     (60, #col1) bold

      let $subtitle = 'Lohnsteuerkarte ' || $Year || ', ausgestellt von der Gemeinde'
      print $subtitle                              (62, #col1)
!      print 'AGS:'                                 (63, #col1)
      print 'im Bezirk des Finanzamts:'            (65, #col1)

      print 'Arbeitgeber'                          (67, #col1)

      print 'Sachbearbeiter'                       (73, #col1)
      print 'Telefon'                              (73, #col3)

      let $PrintContact = substr($ContactName,1,30)
      print $PrintContact                          (74, #col1)
      print $ContactPhone                          (74, 22)
   end-if !if #PageNumber = 1

   if #NrPages > 1
      ! indicate page number at bottom of page
      alter-printer
         font = 4
         point-size = #PointSizeTextNormal
      let $pagelabel = 'Seite ' || to_char(#PageNumber) || '/' || to_char(#NrPages)
      print $pagelabel (#pageline, #col1)
   end-if

   alter-printer
      font = 4
!Tax update: 2010
     if to_number($PrcYear) > 2009
        alter-printer
      font = 4
         point-size = #PointSizeTextSmall
     else
        alter-printer
      font = 4
         point-size = #PointSizeTextNormal
     end-if

   ! print box
   if #PageNumber = 1

      !1.
      let #posline1 = #firstline + 1
      let #currline=#posline1
      print '1.'                                   ( #currline, #col5)
      print 'Dauer des Dienstverhltnisses'        ( #currline, #col6)
      print '     vom - bis'                       (#currline, #col8)
      let #currline=#currline+1
      graphic                                      (#currline,#col5line, #boxwidth)    horz-line 14

      !2.
      let #posline2 = #posline1+2
      let #currline=#posline2
      print '2.'                                   (#currline, #col5)
      print 'Zeitrume ohne Anspruch auf'          (#currline, #col6)
      let #currline=#currline+1
      print 'Arbeitslohn'                          (#currline, #col6)

      let #currline=#posline2
      print 'Anzahl "U":'                          (#currline, #col8)

      let #currline=#currline+1
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 14

      let #poslinegrossbuchstaben = #posline2 + 2

      !Grossbuchstaben
      let #currline = #poslinegrossbuchstaben
! tax update 2010:
     if to_number($PrcYear) > 2009
      print '"Grobuchstaben" (S, F)'           (#currline, #col6)
     else
      print '"Grobuchstaben" (S, B, V, F)'        (#currline, #col6)
     end-if
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

      let #poslineEUR = #poslinegrossbuchstaben + 1
   else
      let #poslineEUR = #firstline + 1
   end-if !if #PageNumber = 1

   let #currline = #poslineEUR
   print 'EUR'                                  (#currline, 69)                    Bold
   print 'Ct.'                                  (#currline, 74)                    Bold

   let #currline= #poslineEUR
   let #linelength = #euroswidth + #centwidth
   graphic                                      (#currline, #col8line, #linelength) horz-line 8

   let #currline = #poslineEUR - 1
   let #linelength = 1
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #posline3 = #poslineEUR + 1

   if #PageNumber = 1
      let #currline = #posline3
      print '3.'                                   (#currline, #col5)
      print 'Bruttoarbeitslohn einschl.'           (#currline, #col6)
      let #currline = #currline + 1
      print 'Sachbezge ohne 9. und 10.'           (#currline, #col6)
      graphic                                      (#currline,#col5line, #boxwidth)  horz-line 8
      let #currline = #posline3 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline4 = #posline3 + 2
      let #currline = #posline4
      print '4.'                                   (#currline, #col5)
      print 'Einbehaltene Lohnsteuer von 3.'              (#currline, #col6)
      graphic                                      (#currline,#col5line, #boxwidth)  horz-line 8
      let #currline = #posline4 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline5 = #posline4 + 1
      let #currline = #posline5
      print '5.'                                   (#currline, #col5)
      print 'Einbehaltener Solidarittszuschlag von 3.'   (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline5 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline6 = #posline5 + 1
      let #currline = #posline6
      print '6.'                                   (#currline, #col5)
      print 'Einbehaltene Kirchensteuer des'       (#currline, #col6)
      let #currline = #currline + 1
      print 'Arbeitnehmers von 3.'                 (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline6 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline7 = #posline6 + 2
      let #currline = #posline7
      print '7.'                                   (#currline, #col5)
      print 'Einbehaltene Kirchensteuer des Ehegatten'      (#currline, #col6)
      let #currline = #currline + 1
      print 'von 3. (nur bei konfessionsverschiedener Ehe)' (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline7 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline8 = #posline7 + 2
      let #currline = #posline8
      print '8.'                                   (#currline, #col5)
!Tax update: 2010
      if to_number($PrcYear) > 2009
       print 'In 3. enthaltene Versorgungsbezge'                   (#currline, #col6)
      ! let #currline = #currline + 1
      ! print 'Versorgungsbezge'                   (#currline, #col6)
      else
       print 'In 3. enthaltene steuerbegnstigte'   (#currline, #col6)
       let #currline = #currline + 1
       print 'Versorgungsbezge'                    (#currline, #col6)
      end-if
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline8 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14
!tu10:reduce 1 row
      if to_number($PrcYear) > 2009
       let #posline9 = #posline8 + 1
      else
       let #posline9 = #posline8 + 2
      end-if
      let #currline = #posline9
      print '9.'                                   (#currline, #col5)
      !Tax update: 2010
      if to_number($PrcYear) > 2009
       print 'Ermigt besteuerte Versorgungsbezge'    (#currline, #col6)
      let #currline = #currline + 1
      print 'fr mehrere Kalenderjahre'            (#currline, #col6)
      else
      print 'Steuerbegnstigte Versorgungsbezge'  (#currline, #col6)
      let #currline = #currline + 1
      print 'fr mehrere Kalenderjahre'            (#currline, #col6)
      end-if
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline9 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline10 = #posline9 + 2
      let #currline = #posline10
      print '10.'                                  (#currline, #col5)
      print 'Ermigt besteuerter Arbeitslohn fr' (#currline, #col6)
      let #currline = #currline + 1
      print 'mehrere Kalenderjahre (ohne 9.) und'  (#currline, #col6)
      let #currline = #currline + 1
      print 'ermigt besteuerte Entschdigungen'  (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline10 - 1
      let #linelength = 3
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline11 = #posline10 + 3
      let #currline = #posline11
      print '11.'                                  (#currline, #col5)
      print 'Einbehaltene Lohnsteuer von 9. und 10.'              (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline11 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline12 = #posline11 + 1
      let #currline = #posline12
      print '12.'                                  (#currline, #col5)
      !Tax update: 2010 - Print in one line
      if to_number($PrcYear) > 2009
        print 'Einbehaltener Solidarittszuschlag von 9. und 10.'   (#currline, #col6)
      else
        print 'Einbehaltener Solidarittszuschlag'   (#currline, #col6)
        let #currline = #currline + 1
        print 'von 9. und 10.'                       (#currline, #col6)
      end-if
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline12 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14
!tu10: reduce 1 row
    if to_number($PrcYear) > 2009
      let #posline13 = #posline12 + 1
    else
      let #posline13 = #posline12 + 2
    end-if
      let #currline = #posline13
      print '13.'                                  (#currline, #col5)
      print 'Einbehaltene Kirchensteuer des'       (#currline, #col6)
      let #currline = #currline + 1
      print 'Arbeitnehmers von 9. und 10.'         (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline13 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline14 = #posline13 + 2
      let #currline = #posline14
      print '14.'                                  (#currline, #col5)
      print 'Einbehaltene Kirchensteuer des Ehegatten von 9.'  (#currline, #col6)
      let #currline = #currline + 1
      print 'und 10. (nur bei konfessionsverschiedener Ehe)'   (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline14 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline15 = #posline14 + 2
      let #currline = #posline15
      print '15.'                                  (#currline, #col5)
      alter-printer
         font = 4
         point-size = #PointSizeTextSmall
!Tax update: 2010 - removed 'Winterausfallgeld' it is not valid in 2010
     if to_number($PrcYear) > 2009
       print 'Kurzarbeitergeld, Zuschuss zum Mutterschaftsgeld' (#currline, #col6)
       let #currline = #currline + 1
       print 'Verdienstausfallentschdigung (Infektionsschutzgesetz),'  (#currline, #col6)
       let #currline = #currline + 1
       print 'Aufstockungsbetrag und Altersteilzeitzuschlag'  (#currline, #col6)
       graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
       let #currline = #posline15 - 1
       let #linelength = 4
       graphic                                      (#currline, #col10 , #linelength)   vert-line 14
     else
        print 'Kurzarbeitergeld, Winterausfallgeld, Zuschuss zum' (#currline, #col6)
        let #currline = #currline + 1
        print 'Mutterschaftsgeld, Verdienstausfallentschdigung'  (#currline, #col6)
        let #currline = #currline + 1
        print '(Infektionsschutzgesetz), Aufstockungsbetrag und'  (#currline, #col6)
        let #currline = #currline + 1
        print 'Altersteilzeitzuschlag'                            (#currline, #col6)
        graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
        let #currline = #posline15 - 1
        let #linelength = 4
        graphic                                      (#currline, #col10 , #linelength)   vert-line 14
    end-if
!end TU -nr 15
      alter-printer
         font = 4
!Tax update: 2010
     if to_number($PrcYear) > 2009
        alter-printer
      font = 4
         point-size = #PointSizeTextSmall
     else
        alter-printer
      font = 4
         point-size = #PointSizeTextNormal
     end-if
!tu reduce 1 row
   if to_number($PrcYear) > 2009
      let #posline16a = #posline15 + 4
   else
      let #posline16a = #posline15 + 4
   end-if
      let #posline16a = #posline15 + 3
      let #posline16b = #posline16a + 2
      let #posline16 = #posline16a + 1
      let #currline = #posline16
      print '16.'                                  (#currline, #col5)
      print 'Steuerfreier'                         (#currline, #col6)
      let #currline = #currline + 1
      print 'Arbeitslohn nach'                     (#currline, #col6)

      let #currline = #posline16a + 1
      graphic                                      (#currline, 52, 24) horz-line 8

      let #currline = #posline16a - 1
      graphic                                      (#currline, 52, 4)  vert-line 8

      let #currline = #posline16a
      print 'Doppelbesteue-'                       (#currline, #col7)
      let #currline = #currline + 1
      print 'rungsabkommen'                        (#currline, #col7)

      let #currline = #posline16b
      print 'Auslands-'                            (#currline, #col7)
      let #currline = #currline + 1
      print 'ttigkeitserlass'                     (#currline, #col7)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline16a - 1
      let #linelength = 4
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline17 = #posline16a + 4
      let #currline = #posline17
      print '17.'                                  (#currline, #col5)
      print 'Steuerfreie Arbeitgeberleistungen fr Fahrten'      (#currline, #col6)
      let #currline = #currline + 1
      print 'zwischen Wohnung und Arbeitssttte'                  (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline17 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline18 = #posline17 + 2
      let #currline = #posline18
      print '18.'                                  (#currline, #col5)
      print 'Pauschalbesteuerte Arbeitgeberleistungen fr'       (#currline, #col6)
      let #currline = #currline + 1
      print 'Fahrten zwischen Wohnung und Arbeitssttte'          (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline18 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      alter-printer
         font = 4
         point-size = #PointSizeTextSmall

      let #posline19 = #posline18 + 2
      let #currline = #posline19
      print '19.'                                  (#currline, #col5)
      print 'Steuerpflichtige Entschdigungen und Arbeitslohn fr'   (#currline, #col6)
      let #currline = #currline + 1
      print 'mehrere Kalenderjahre, die nicht ermigt besteuert'    (#currline, #col6)
      let #currline = #currline + 1
      print 'wurden - in 3. enthalten'                               (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline19 - 1
      let #linelength = 3
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      alter-printer
         font = 4
!Tax update: 2010
     if to_number($PrcYear) > 2009
        alter-printer
      font = 4
         point-size = #PointSizeTextSmall
     else
        alter-printer
      font = 4
         point-size = #PointSizeTextNormal
     end-if

      let #posline20 = #posline19 + 3
      let #currline = #posline20
      print '20.'                                  (#currline, #col5)
      print 'Steuerfreie Verpflegungszuschsse bei'        (#currline, #col6)
      let #currline = #currline + 1
      print 'Auswrtsttigkeit'                            (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline20 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline21 = #posline20 + 2
      let #currline = #posline21
      print '21.'                                  (#currline, #col5)
      print 'Steuerfreie Arbeitgeberleistungen bei'(#currline, #col6)
      let #currline = #currline + 1
      print 'doppelter Haushaltsfhrung'           (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline21 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      alter-printer
         font = 4
         point-size = #PointSizeTextSmall
  
 !do Format-DateTime($PrcYear, $Prcyear1, {DEFCMP}, '', 'native')
 !do ConvertToComponents($PrcYear1,$yr,$mm09,$dd09)
  
   if to_number($PrcYear) >= 2011
       
      let #posline22a = #posline21 + 2
      let #posline22b = #posline22a + 2
      let #posline22 = #posline22a + 1
      let #currline = #posline22
      print '22.'                                  (#currline, #col5)
      print 'Arbeitgeber-'                         (#currline, #col6)
      let #currline = #currline + 1
      print 'anteil'                               (#currline, #col6)

      let #currline = #posline22a + 1
      graphic                                      (#currline, 52, 24) horz-line 8

      let #currline = #posline22a - 1
      graphic                                      (#currline, 52, 4)  vert-line 8

      let #currline = #posline22a
      print 'a) zur gesetzlichen'                     (#currline, #col7)
      let #currline = #currline + 1
      print 'Rentenversicherung'                   (#currline, #col7)

      let #currline = #posline22b
      print 'b) an berufsstndische'                     (#currline, #col7)
      let #currline = #currline + 1
      print 'Versorgungseinrichtungen'             (#currline, #col7)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline22a - 1
      let #linelength = 4
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline23a = #posline22 + 3
      let #posline23b = #posline23a + 2
      let #posline23 = #posline23a + 1
      let #currline = #posline23
      print '23.'                                  (#currline, #col5)
      print 'Arbeitnehmer-'                         (#currline, #col6)
      let #currline = #currline + 1
      print 'anteil'                               (#currline, #col6)

      let #currline = #posline23a + 1
      graphic                                      (#currline, 52, 24) horz-line 8

      let #currline = #posline23a - 1
      graphic                                      (#currline, 52, 4)  vert-line 8

      let #currline = #posline23a
      print 'a) zur gesetzlichen'                     (#currline, #col7)
      let #currline = #currline + 1
      print 'Rentenversicherung'                   (#currline, #col7)

      let #currline = #posline23b
      print 'b) an berufsstndische'                  (#currline, #col7)
      let #currline = #currline + 1
      print 'Versorgungseinrichtungen'             (#currline, #col7)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline23a - 1
      let #linelength = 4
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14
     alter-printer
         font = 4
  else
      
       
      let #posline22 = #posline21 + 2
      let #currline = #posline22
      print '22.'                                  (#currline, #col5)
      print 'Arbeitgeberanteil zur gesetzlichen'   (#currline, #col6)
      let #currline = #currline + 1
      print 'Rentenversicherung und an berufsstndische' (#currline, #col6)
      let #currline = #currline + 1
      print 'Versorgungseinrichtungen'             (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline22 - 1
      let #linelength = 3
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline23 = #posline22 + 3
      let #currline = #posline23
      print '23.'                                  (#currline, #col5)
      print 'Arbeitnehmeranteil zur gesetzlichen'  (#currline, #col6)
      let #currline = #currline + 1
      print 'Rentenversicherung und an berufsstndische'      (#currline, #col6)
      let #currline = #currline + 1
      print 'Versorgungseinrichtungen'            (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline23 - 1
      let #linelength = 3
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14 
  
     ! let #posline23 = #posline22 + 3
     ! let #currline = #posline23
     ! print '23.'                                  (#currline, #col5)
     ! print 'Arbeitnehmeranteil zur gesetzlichen'  (#currline, #col6)
     !let #currline = #currline + 1
     ! print 'Rentenversicherung und an berufsstndische'      (#currline, #col6)
     ! let #currline = #currline + 1
     ! print 'Versorgungseinrichtungen'            (#currline, #col6)
     ! graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
     ! let #currline = #posline23 - 1
     ! let #linelength = 3
     ! graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      alter-printer
         font = 4
 end-if

!Tax update: 2010
     if to_number($PrcYear) > 2009
        alter-printer
      font = 4
         point-size = #PointSizeTextSmall
     else
        alter-printer
      font = 4
         point-size = #PointSizeTextNormal
     end-if

! let #posline24 = #posline23 + 3
!     let #currline = #posline24
!      print '24.'                                  (#currline, #col5)
!      print 'Steuerfreie Arbeitgeberzuschsse zur' (#currline, #col6)
!      let #currline = #currline + 1
!      print 'Krankenversicherung und zur Pflegeversicherung' (#currline, #col6)
!      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
!      let #currline = #posline24 - 1
!      let #linelength = 2
!      graphic                                      (#currline, #col10 , #linelength)   vert-line 14


let #posline24a = #posline23 + 2
      let #posline24b = #posline24a + 2
      let #posline24c = #posline24b + 2
      let #posline24 = #posline24a + 1
      let #currline = #posline24 + 1
      print '24.'                                  (#currline, #col5)
      print 'Steuerfreie'                          (#currline, #col6)
      let #currline = #currline + 1
      print 'Arbeitgeber-'                         (#currline, #col6)
      let #currline = #currline + 1
      print 'zuschsse'                             (#currline, #col6)
      
      let #currline = #posline24a + 2
      graphic                                       (#currline, 52, 24) horz-line 8

      let #currline = #posline24a
      graphic                                       (#currline, 52, 4)  vert-line 8

      let #currline = #posline24a + 1
      print 'a) zur gesetzlichen Krankenver-'       (#currline, #col7a)
      let #currline = #currline + 1
      print 'sicherung'                             (#currline, #col7a)

      let #currline = #posline24b + 2
      graphic                                       (#currline, 52, 24) horz-line 8

      let #currline = #posline24b
      graphic                                       (#currline, 52, 4)  vert-line 8
      
      let #currline = #posline24b+1
      print 'b) zur privaten Krankenver-'           (#currline, #col7a)
      let #currline = #currline + 1
      print 'sicherung'                             (#currline, #col7a)

      let #currline = #posline24c +1
      print 'c) zur gesetzlichen Pflegever-'        (#currline, #col7a)
     let #currline = #currline + 1
     print 'sicherung'                              (#currline, #col7a)
      graphic                                       (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline24a - 1
      let #linelength = 7
      graphic                                       (#currline, #col10 , #linelength)   vert-line 14

      






      let #posline25 = #posline24 + 6
      let #currline = #posline25
      print '25.'                                  (#currline, #col5)
!tax update 2010: change descr of nr 25
      if to_number($PrcYear) > 2009
         print 'Arbeitnehmerbeitrge zur gesetzlichen'        (#currline, #col6)
         let #currline = #currline + 1
         print 'Krankenversicherung'                          (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline25 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         alter-printer
         font = 4 !5
!Tax update: 2010
     if to_number($PrcYear) > 2009
        alter-printer
      font = 4
         point-size = #PointSizeTextSmall
     else
        alter-printer
      font = 4
         point-size = #PointSizeTextNormal
     end-if
         let #posline26 = #posline25 + 2
         let #currline = #posline26
         print '26.'                                          (#currline, #col5)
         print 'Arbeitnehmerbeitrge zur sozialen Pflegeversicherung'              (#currline, #col6)
         alter-printer
         font = 4
         point-size = #PointSizeTextNormal
      else
         print 'Arbeitnehmeranteil am Gesamt-'        (#currline, #col6)
         let #currline = #currline + 1
         print 'sozialversicherungsbeitrag (ohne 23. und 24.)'   (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline25 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14

         let #posline26 = #posline25 + 2
         let #currline = #posline26
         print '26.'                                  (#currline, #col5)
         print 'Ausgezahltes Kindergeld'              (#currline, #col6)
      end-if ! end tu2010

      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline26 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #firstLineYearly = #posline26 + 1
   else
      let #firstLineYearly = #poslineEUR + 1
   end-if

#debug show 'Calling YearlyCodeLabels'
#debug show #firstLineYearly
#debug show #col5
   do YearlyCodeLabels


   alter-printer
      font = 4
      point-size = #PointSizeTextSmall


   if #PageNumber = 1
      let #poslinefinanzamt = #lastLineYearly + 1
      let #currline = #poslinefinanzamt - 1

      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #poslinefinanzamt
      print 'Finanzamt, '                          (#currline,#col5) bold
      print 'an das die Lohnsteuer abgefhrt wurde (Name und dessen' (,-5)
      let #currline = #poslinefinanzamt + 1
      print 'vierstellige Nr.)'                    (#currline,#col5)

      ! Vertical lines that separate the Finanzamt digits.
      let #currline = #poslinefinanzamt + 1
      graphic                                      (#currline, 64, 1)  vert-line 14
      graphic                                      (#currline, 67, 1)  vert-line 8
      graphic                                      (#currline, 70, 1)  vert-line 8
      graphic                                      (#currline, 73, 1)  vert-line 8
   end-if

   let #firstLineBox = #posline1
   if #PageNumber = 1
      let #lastLineBox = #poslinefinanzamt + 2
   else
      ! #lastLineBox was assigned in procedures PrintLabelsForVBEZelements and PrintLabelsForDTHBelements
   end-if
   do LayoutBox

end-procedure Layout

!*******************************************************************
begin-procedure LayoutBox

   #debug show '#PageNumber'
   #debug show #PageNumber
   #debug show '#firstLineBox'
   #debug show #firstLineBox
   #debug show '#lastLineBox'
   #debug show #lastLineBox

   let #currline = #firstLineBox
   let #boxheight = #lastLineBox + 1 - #firstLineBox
   graphic                                      (#firstLineBox, #col5line, #boxwidth)  box #boxheight 14

   let #currline= #firstLineBox - 1
   if #PageNumber = 1
      let #linelength = #poslinefinanzamt - #firstLineBox
   else
      let #linelength = #lastLineBox - #firstLineBox + 1
   end-if
   graphic                                      (#currline, #col8line, #linelength) vert-line 14

   #debug show 'end procedure LayoutBox'
end-procedure LayoutBox

!**************************************************

begin-procedure Get_Before_After_Comma(#Num_In,:$Num1_Out,:$Num2_Out)
#debug show 'begin procedure Get_Before_After_Comma'
#debug show '#Num_In'
#debug show #Num_In

   do format-number(#Num_In,$Num_In,'B9,999,999.99')
!#debug show '$Num_In'
!#debug show $Num_In
!#debug show '$_SDecimal'
!#debug show $_SDecimal

   let #Del_Loc  = instr($Num_In,$_SDecimal,1)
!#debug show '#Del_Loc'
!#debug show #Del_Loc
   let $Num1_Out = substr($Num_In,1,-1 + #Del_Loc)
   let $Num2_Out = substr($Num_In,1 + #Del_Loc,2)

#debug show '$Num1_Out'
#debug show $Num1_Out
#debug show '$Num2_Out'
#debug show $Num2_Out
end-procedure

!***************************************************

begin-procedure Get-Values

if rtrim($ELSTER_Ticket, ' ') <> ''
   let $Sort1 = ' '
   let $Sort2 = ' '
   let $Sort3 = ' '


   evaluate &GPDE_RUN_CNTL.GPDE_RC_AL01_S1
   when = 'E'
      let $Sort1 = 'T.EMPLID'
      break
   when = 'P'
      let $Sort1 = 'T.PAY_ENTITY'
      break
   when = 'L'
      let $Sort1 = 'T.LOCATION'
      break
   when = 'D'
      let $Sort1 = 'T.DEPTID'
      break
   when = 'G'
      let $Sort1 = 'T.GP_PAYGROUP'
      break
   when = 'N'
      let $Sort1 = 'P.NAME'
      break
   when = 'V'        !wdu05b6: report distribution
! adj08-1599392000 : XML differs from SQR
!      let $Sort1 = 'DSV1.DESCR'
      break
   when-other
      let $Sort1 = ' '
!
! specify a default sorting
!    let $Sort1 = 'T.PAY_ENTITY'
   break
   end-evaluate

   evaluate &GPDE_RUN_CNTL.GPDE_RC_AL01_S2
      when = 'E'
         let $Sort2 = ' T.EMPLID'
      break
      when = 'P'
         let $Sort2 = ' T.PAY_ENTITY'
         break
      when = 'L'
         let $Sort2 = ' T.LOCATION'
         break
      when = 'D'
         let $Sort2 = ' T.DEPTID'
         break
      when = 'G'
         let $Sort2 = ' T.GP_PAYGROUP'
         break
      when = 'N'
         let $Sort2 = ' P.NAME'
         break
      when = 'V'        !wdu05b6: report distribution
! adj08-1599392000 : XML differs from SQR
!         let $Sort2 = ' DSV1.DESCR'
         break
      when-other
         let $Sort2 = ' '
!
!specify a default sorting
!       let $Sort2 = 'T.GP_PAYGROUP'
      break
      end-evaluate

      evaluate &GPDE_RUN_CNTL.GPDE_RC_AL01_S3
      when = 'E'
         let $Sort3 = ' T.EMPLID'
         break
      when = 'P'
         let $Sort3 = ' T.PAY_ENTITY'
         break
      when = 'L'
         let $Sort3 = ' T.LOCATION'
         break
      when = 'D'
         let $Sort3 = ' T.DEPTID'
         break
      when = 'G'
         let $Sort3 = ' T.GP_PAYGROUP'
         break
      when = 'N'
         let $Sort3 = ' P.NAME'
         break
      when = 'V'        !wdu05b6: report distribution
! adj08-1599392000 : XML differs from SQR
!         let $Sort3 = ' DSV1.DESCR'
         break
      when-other
         let $Sort3 = ' '
!
!    specify a default sorting
!       let $Sort3 = 'T.EMPLID'
      break
     end-evaluate

   !jlj05b6: always sort by name: start
   !
   if &GPDE_RUN_CNTL.GPDE_RC_AL01_S1 <> 'N'
        and &GPDE_RUN_CNTL.GPDE_RC_AL01_S2 <> 'N'
        and &GPDE_RUN_CNTL.GPDE_RC_AL01_S3 <> 'N'
           let $Sort4 = ' P.NAME'
   end-if

   let $Sort_Order = 'ORDER BY '

   if rtrim ($Sort1, ' ') <> ''
      concat $Sort1 with $Sort_Order
   end-if

   if (rtrim ($Sort2, ' ') <> '' and rtrim($Sort1, ' ') <>'')
      concat ',' with $Sort_Order
      concat $Sort2 with $Sort_Order
   else
      concat $Sort2 with $Sort_Order
   end-if

   if (rtrim ($Sort3, ' ') <> '' and (rtrim($Sort1, ' ') <>'' or rtrim($Sort2, ' ') <>''))
      concat ',' with $Sort_Order
      concat $Sort3 with $Sort_Order
   else
      concat $Sort3 with $Sort_Order
   end-if

   if (rtrim ($Sort4, ' ') <> '' and (rtrim($Sort1, ' ') <>'' or rtrim($Sort2, ' ') <>'' or rtrim($Sort3, ' ') <>''))
      concat ',' with $Sort_Order
      concat $Sort4 with $Sort_Order
   else
      concat $Sort4 with $Sort_Order
   end-if

end-if

end-procedure Get-Values

!**************************************************

begin-procedure Ask-Report-Parameters
   input $Ctl_Curr_Pay_End_Dt 'Current Pay End Date'
   input $Tax_Card_Close 'Tax Year Close (Y/N)'
   input $Ctl_PayEntity 'Pay Entity'
   input $Tax_Card_Close 'Pay Group'
   input $Ctl_Deptid  'Department'
   input $Ctl_Location 'Location'
end-procedure

!*************************************************
begin-procedure Get-Finanzamt-Data($Finance_Cd, $EndDate, :$Finance_Descr)

begin-SELECT

F.DESCR

FROM PS_GPDE_TX_FINOFC F
WHERE F.GPDE_AL_FINANCE_CD = $Finance_Cd
AND   F.EFFDT = (SELECT MAX(EFFDT)
          FROM PS_GPDE_TX_FINOFC F2
          WHERE F.GPDE_AL_FINANCE_CD=F2.GPDE_AL_FINANCE_CD
          AND F2.EFFDT <= $EndDate)
end-SELECT

let $Finance_Descr = rtrim(&F.DESCR, ' ')

end-procedure Get-Finanzamt-Data

!*******************************************************************
begin-procedure Update_TaxCard

IF $XMLTestRun = 'N'
    OR $TestEnvironment = 'Y'

      begin-SQL

      UPDATE PS_GPDE_TX_DATA
      SET GPDE_TX_YR_CLS_DT = $AsofToday

      WHERE EMPLID = $Emplid
      ! wdu 04b4: added empl_rcd
      AND   EMPL_RCD = #Empl_Rcd_Num
      AND   GPDE_BL_START_DT = $start_date
      end-SQL

ELSE
   if $PrintXMLTestRunOnly = 'N'
      DISPLAY 'Tax Cards are not actually being closed because Pararmeter "XMLTestRunOnly" must be set to "N" '
      let $PrintXMLTestRunOnly = 'Y'
   END-IF
END-IF

end-procedure Update_TaxCard

!*******************************************************************
begin-procedure Update_XMLRec

if $Closed = 'N'

#ifdef ORACLE

begin-SQL
UPDATE PS_GPDE_TX_XMLRSLT

SET GPDE_RC_YR_CLOSE = $Tax_Card_Close
    , LAST_UPDATE_DTTM = SYSDATE

WHERE GPDE_ELSTER_TKT= $ELSTER_Ticket

End-Sql

#else

begin-SQL
UPDATE PS_GPDE_TX_XMLRSLT

SET GPDE_RC_YR_CLOSE = $Tax_Card_Close
   , LAST_UPDATE_DTTM = $SysDateTime

WHERE GPDE_ELSTER_TKT= $ELSTER_Ticket

end-SQL
#endif

end-if

end-procedure Update_XMLRec

!*******************************************************************
begin-procedure Get-Tag-Values($Source_String,$Tag,:$Tag_Val)

   let $Source_String = ltrim($Source_String,' ')

   let #ValFound = instr($Source_String,$Tag ,1)

   if #ValFound = 0
      let $Tag_Val = ''
   else
      let $Empty_Tag = '<'  || $Tag || '/>'
      let #EmptyVal = instr($Source_String,$Empty_Tag ,1)

      if #EmptyVal <> 0
         let $Tag_Val = ''
      else
         ! Closing brackets may not be appended.
         ! Else tags with attributes would not be matched.
         ! Should there be a trailing space?
         ! What if we have tags with common prefixes?

         let $Bgn_Tag_Des = '<'  || $Tag

         ! rh - TaxUpdate 2007 - common prefixes are an issue! Need trailing space

         let $End_Tag_Des = '</' || $Tag || '>'
         let #Bgn_Cont = instr($Source_String,$Bgn_Tag_Des,1)


         let #End_Cont = instr($Source_String,$End_Tag_Des,1)
         let #SStr_Len = length($End_Tag_Des)

         let #Len_Cont = #End_Cont - #Bgn_Cont - #SStr_Len + 2
         let #Bgn_Cont = #Bgn_Cont + #SStr_Len - 2

         let $Tag_Val  = substr($Source_String,#Bgn_Cont,#Len_Cont)

         let #SStr_Len = length($Tag_Val)
         let #Bgn_Cont = instr($Tag_Val ,'>',1) + 1
         let #Len_Cont = #SStr_Len - #Bgn_Cont + 1

         let $Tag_Val  = substr($Tag_Val,#Bgn_Cont,#Len_Cont)

      end-if
   end-if
end-procedure Get-Tag-Values

!**********************************************************************

begin-procedure Get-Tag-Attrib($Source_String,$Tag,$Attrib, :$Attrib_Val)
   let $Source_String = ltrim($Source_String,' ')
   let #ValFound = instr($Source_String,$Tag ,1)

   if #ValFound = 0
      let $Tag_Val = ''
   else
      let $Empty_Tag = '<'  || $Tag || '/>'
      let #EmptyVal = instr($Source_String,$Empty_Tag ,1)

      if #EmptyVal <> 0
          let $Tag_Val = ''
      else
         let $Bgn_Tag_Des = '<'  || $Tag
         let $End_Tag_Des = '</' || $Tag || '>'

         let #Bgn_Cont = instr($Source_String,$Bgn_Tag_Des,1)
         let #End_Cont = instr($Source_String,$End_Tag_Des,1)
         let #SStr_Len = length($End_Tag_Des)

         let #Len_Cont = #End_Cont - #Bgn_Cont - #SStr_Len + 2
         let #Bgn_Cont = #Bgn_Cont + #SStr_Len - 2

         let $Attrib_Val = substr($Source_String,#Bgn_Cont,#Len_Cont)

         !find attrib and crop from there

         let $Attrib = $Attrib || '="'
         let #Bgn_Cont = instr($Attrib_Val,$Attrib ,1)
         if #Bgn_Cont = 0
           ! Attribute not found, return empty value
           let $Attrib_val = ''
         else
            ! Attribute found, retrieve value
               let #Len_Cont = length($Attrib_Val)
            let #Bgn_Cont = #Bgn_Cont + length($Attrib)

            let $Attrib_Val = substr($Attrib_Val,#Bgn_Cont,#Len_Cont)

            let $Quote = '"'
            let #End_Cont = instr($Attrib_Val,$Quote,1)
            let #End_Cont = #End_Cont - 1
            let $Attrib_Val = substr($Attrib_Val,1,#End_Cont)
         end-if
      end-if
   end-if

end-procedure Get-Tag-Attrib

!****************************************************************************************
begin-procedure Get-Extra-Line-Values($Source_String, $Tag, $Attrib, :$Attrib_Val)

   let $Attrib_Val = ''
   let $Source_String = ltrim($Source_String,' ')

   let $Bgn_Tag_Des = '<' || $Tag || ' name="' || $Attrib || '"'
   let $End_Tag_Des = '</'|| $Tag ||'>'

   let #Bgn_Cont = instr($Source_String, $Bgn_Tag_Des, 1)

   if #Bgn_Cont > 0
      let #Len_Cont = length($Source_String)
      let $Source_String = substr($Source_String, #Bgn_Cont, #Len_Cont)

      let #Bgn_Cont = instr($Source_String, $Bgn_Tag_Des, 1)
      let #End_Cont = instr($Source_String, $End_Tag_Des, 1)
      let #SStr_Len = length($Bgn_Tag_Des)

      let #Len_Cont = #End_Cont - #Bgn_Cont - #SStr_Len - 1
      let #Bgn_Cont = #Bgn_Cont + #SStr_Len + 1

      let $Attrib_Val = substr($Source_String,#Bgn_Cont,#Len_Cont)
   end-if

end-procedure Get-Extra-Line-Values

!****************************************************************************************
begin-procedure Get_Type_Options

   let $Name_Type       = ''
   let $Addr_Type       = ''
   let $Phone_Type      = ''
   let $Email_Type      = ''
   let $BirthName_Type  = ''

begin-select distinct
INST.NAME_TYPE
INST.ADDRESS_TYPE
INST.PHONE_TYPE
INST.E_ADDR_TYPE
INST.GPDE_BIRTH_NM_TYPE

   let $Name_Type      = &INST.NAME_TYPE
   let $Addr_Type      = &INST.ADDRESS_TYPE
   let $Phone_Type     = &INST.PHONE_TYPE
   let $Email_Type     = &INST.E_ADDR_TYPE
   let $BirthName_Type = &INST.GPDE_BIRTH_NM_TYPE

from PS_GPDE_AL_INSTALL INST

end-select

end-procedure

!****************************************************************************************
begin-procedure TaxCardValues($Emplid, #Empl_Rcd_Num, #col1, #col3, $ToDt, $start_date, $Termdt, $PeriodEndDate)

   let #SteuerklasseRow = 32
   let #KinderRow = 38
   let #SteuerfreibetragRow = 42
   let #HinzurechnungsbetragRow = 47
   let #ReligRow = 52
   let #col3a = #col3 + 4

   let $firstrow = 'Y'
   let $PrevSteuerklasse = ''
   let $PrevKinder = ''
   let $PrevSteuerfreibetrag = ''
   let $PrevHinzurechnungsbetrag = ''
   let $Prevkonfession = ''
   let $PrevkonfessionE = ''
   let $FromTaxDate = ''
   let $ToTaxDate = ''

   let $TaxCardFound = 'N'

! jlj adding post term stuff
      if $Termdt < $DTU_EFFDT
         do ConvertToComponents($PeriodEndDate, $PrdEndYear, $PrdEndMth, $PrdEndDay)
          let $FromTaxDate = '01' || {MonthYearSeparator} || $PrdEndMth || {MonthYearSeparator}
      else

      end-if

begin-select

EFFDT
GPDE_TX_INC_TX_CLS !Steuerklasse
GPDE_TX_NUM_CHILD  !Kinder
GPDE_TX_EXEMPT_ANN !Steuerfreibetrag
GPDE_TX_ADDGRS_ANN !Hinzurechnungsbetrag
GPDE_TX_RELIGION
GPDE_TX_SPOUSE_REL
GPDE_TX_HOME_CD
!tax update 2010
GPDE_TX_FACTOR

      let $TaxCardFound = 'Y'
      if rtrim($Termdt, ' ') = ''
         let $Termdt =  $PeriodEndDate
      end-if

      do Convert-to-DTU-DATE(&EFFDT,$DTU_EFFDT)
      do ConvertToComponents(&EFFDT, $EffYear, $EffMth, $EffDay)
      let $FromTaxDate = $EffDay || {MonthYearSeparator} || $EffMth || {MonthYearSeparator}

      do dtu-add-days($DTU_EFFDT,-1,$Prev_ToReligDTU)
      do Convert-from-DTU-DATE($Prev_ToReligDTU, $Prev_ToRelig)

      do ConvertToComponents($Prev_ToRelig, $PrevYear, $PrevMth, $PrevDay)
      let $ToTaxDate = $PrevDay || {MonthYearSeparator} || $PrevMth || {MonthYearSeparator}

      if $PrevSteuerklasse <> &GPDE_TX_INC_TX_CLS or $firstrow = 'Y'
         if $firstrow = 'N'
                 print $ToTaxDate                                         (#SteuerklasseRow, #col3a)
         end-if
         let #SteuerklasseRow = #SteuerklasseRow + 1
         do PrintLine(&GPDE_TX_INC_TX_CLS, 'N', $FromTaxDate, #SteuerklasseRow, #col1, #col3)
         let $PrevSteuerklasse = &GPDE_TX_INC_TX_CLS
!adj09: tax update 2010
               print &GPDE_TX_FACTOR (#SteuerklasseRow ,10)  edit  B9.999
       end-if

      do format-number(&GPDE_TX_NUM_CHILD, $Kinder, 'B9.99')
      if LTRIM(rtrim($Kinder , ' '), ' ')  = ''
          let $Kinder = '0'
      end-if
      if $PrevKinder <> $Kinder or $firstrow = 'Y'
         if $firstrow = 'N'
            print $ToTaxDate                                         (#KinderRow, #col3a)
         end-if
         let #KinderRow = #KinderRow + 1
         do PrintLine($Kinder, 'N', $FromTaxDate, #KinderRow, #col1, #col3)
         let $PrevKinder = $Kinder
      end-if

      do format-number(&GPDE_TX_EXEMPT_ANN, $Steuerfreibetrag, 'BB,BBB,BBB.99')
      let $Steuerfreibetrag = ltrim($Steuerfreibetrag, ' ')
      if rtrim($Steuerfreibetrag, ' ')  <> ''
          let $Steuerfreibetrag = $Steuerfreibetrag || '  EUR'
      else
          let $Steuerfreibetrag = '0'
      end-if
      if $PrevSteuerfreibetrag  <> $Steuerfreibetrag or $firstrow = 'Y'
         if $firstrow = 'N'
                 print $ToTaxDate                                         (#SteuerfreibetragRow, #col3a)
         end-if
           let #SteuerfreibetragRow = #SteuerfreibetragRow + 1
         do PrintLine($Steuerfreibetrag, 'Y', $FromTaxDate, #SteuerfreibetragRow, #col1, #col3)
         let $PrevSteuerfreibetrag  = $Steuerfreibetrag
      end-if

      do format-number(&GPDE_TX_ADDGRS_ANN, $Hinzurechnungsbetrag, 'BB,BBB,BBB.99')
      LET $Hinzurechnungsbetrag =  ltrim($Hinzurechnungsbetrag, ' ')
      if rtrim($Hinzurechnungsbetrag, ' ')  <> ''
          let $Hinzurechnungsbetrag = $Hinzurechnungsbetrag || '  EUR'
      else
          let $Hinzurechnungsbetrag = '0'
      end-if
      if $PrevHinzurechnungsbetrag <> $Hinzurechnungsbetrag or $firstrow = 'Y'
         if $firstrow = 'N'
                 print $ToTaxDate                                         (#HinzurechnungsbetragRow, #col3a)
         end-if
         let #HinzurechnungsbetragRow = #HinzurechnungsbetragRow + 1
         do PrintLine($Hinzurechnungsbetrag, 'Y', $FromTaxDate, #HinzurechnungsbetragRow, #col1, #col3)
         let $PrevHinzurechnungsbetrag = $Hinzurechnungsbetrag
      end-if

      do FindReligCode(&GPDE_TX_RELIGION, $konfession)
      do FindReligCode(&GPDE_TX_SPOUSE_REL , $konfessionE)

      if $Prevkonfession <> $konfession or $PrevkonfessionE <> $konfessionE or $firstrow = 'Y'
        if $firstrow = 'N'
                 print $ToTaxDate                                         (#ReligRow, #col3a)
         end-if
!Tax update: 2010
         if to_number($_PrcYear) > 2009
                let $konfession  = lower($konfession)
                let $konfessionE = lower($konfessionE)
         end-if

        let $ReligValue = $konfession || ' / ' || $konfessionE
        let #ReligRow = #ReligRow + 1
        do PrintLine($ReligValue, 'N', $FromTaxDate, #ReligRow, #col1, #col3)
        let  $Prevkonfession = $konfession
        let  $PrevkonfessionE = $konfessionE
      end-if

      let $AGS_City = &GPDE_TX_HOME_CD
      let $firstrow = 'N'

from PS_GPDE_TX_DATA
where EMPLID = $Emplid
AND EMPL_RCD = #Empl_Rcd_Num
AND EFFDT >= $start_date
AND EFFDT <= $PeriodEndDate
ORDER BY EFFDT ASC

end-select

   if $TaxCardFound = 'Y'
      print $AGS_City                                          (63, #col3)
      print $ToDt                                              (#ReligRow, #col3a)
      print $ToDt                                              (#SteuerklasseRow, #col3a)
      print $ToDt                                              (#KinderRow, #col3a)
      print $ToDt                                              (#SteuerfreibetragRow, #col3a)
      print $ToDt                                              (#HinzurechnungsbetragRow, #col3a)
   else
      display 'No Tax Card row found for employee ' NoLine
      display $Emplid NoLine
      display ', record number ' NoLine
      do format-number(#Empl_Rcd_Num , $Empl_Rcd_Num , '9')
      display $Empl_Rcd_Num NoLine
      display ' for the Year ' NoLine
      display $Year
   end-if

end-procedure TaxCardValues

!****************************************************************************************

begin-procedure FindReligCode($NumericCode, :$CharCode)

   let $NumericCode = rtrim($NumericCode, ' ')

   Evaluate $NumericCode
   When = '01'
      let $CharCode =  'RK'
      Break
   When = '02'
      let $CharCode = 'AK'
      Break
   When = '03'
      let $CharCode = 'LT'
      Break
   When = '04'
      let $CharCode = 'RF'
      Break
   When = '05'
      let $CharCode = 'FR'
      Break
   When = '06'
      let $CharCode = 'FB'
      Break
   When = '07'
   !Tax update: 2010
         if to_number($_PrcYear) > 2009
            let $CharCode = 'IS'
         else
            let $CharCode = 'JD'
         end-if
      Break
   When = '08'
      let $CharCode = 'FG'
      Break
   When = '09'
      let $CharCode = 'FS'
      Break
   When = '10'
      let $CharCode = 'FM'
      Break
   When = '11'
      let $CharCode = 'IB'
      Break
   When = '12'
      let $CharCode = 'IW'
      Break
   When = '13'
      let $CharCode = 'IS'
      Break
   When = '14'
      let $CharCode = 'IL'
      Break
   When = '15'
      let $CharCode = 'FG'
      Break
   When = '16'
      let $CharCode = 'FA'
      Break
   When = '17'
      let $CharCode = 'JH'
      Break
   When = '18'
      let $CharCode = 'IH'
      Break

   When-Other
      let $CharCode = '--'
   End-Evaluate

end-procedure FindReligCode;


!****************************************************************************************

begin-procedure PrintLine($LineVal, $EURsymbol, $From, #line, #col1, #col3)

   let $SecondHalf = $From || ' - '

   print $LineVal                             (#line, #col1)
   print $SecondHalf                          (#line, #col3)

end-procedure PrintLine

!****************************************************************************************

begin-procedure updateTktNumber

! This procedure used to clear the ticket number for preliminary runs.
! The functionality has been moved to the runcontrol component, RowInit
! The procedure is not called any more.

   let #Count = instr($ELSTER_Ticket, '.', 1)
   if #Count > 0

      begin-SQL

      UPDATE PS_GPDE_RC_PAYROLL
      SET GPDE_ELSTER_TKT = ' '
      WHERE OPRID = $prcs_oprid
      AND RUN_CNTL_ID = $prcs_run_cntl_id

      end-SQL

   end-if

end-procedure updateTktNumber

!*******************************************************************

begin-procedure ReplaceSpecialChar($Original,:$Replaced)

  let $Replaced = replace($Original, '&amp;', '&')
  let $Replaced = replace($Replaced, '&apos;', '''')
  let $Replaced = replace($Replaced, '&gt;',   '>')
  let $Replaced = replace($Replaced, '&lt;',   '<')
  let $Replaced = replace($Replaced, '&quot;',  '"')

end-procedure ReplaceSpecialChar

!*******************************************************************

begin-procedure CX_YearOrMonthCheck

!------------------------------
!2004Bundle3: BEGIN init


 let $YearEndProcessing = rtrim(&GPDE_RUN_CNTL.GPDE_RC_MONTH_YEAR,' ')
 if $YearEndProcessing = 'Y'
       !--------------------------------------------------------------------
       ! yearly run
       !
       ! note: $TerminationLimit is the first day of the next year (yearend+1day)
       !
       ! we wan all emplids which are active
       !  cond:
       !     term = null
       !  or
       !     hire <= yearend   ( hire < $TerminationLimit )
       !     term <= hire
       !  or
       !
       !     hire <= yearend   ( hire < $TerminationLimit )
       !     term > yearend+1  ( term > $TerminationLimit )
       !
       !note: rp_0001 does not have hire in the future
       #debug show 'debug-01'
       !--------------------------------------------------------------------

       let #YearNum = $Ctl_Year

       #debug show 'debug-02'
       do dtu-format-date(#YearNum,12,31,$DTU_monthend)
       do dtu-add-days($DTU_monthend,1,$DTU_TermLimit)
       do Convert-From-DTU-DATE($DTU_TermLimit,$TerminationLimit)
       do Convert-From-DTU-DATE($DTU_monthend,$RefMonthEnd)
       #debug show 'debug-03'

 else
       ! wdu 04b4: find year number for the report title
       do ConvertToComponents($Ctl_Curr_Pay_End_Dt,$Ytax,$Mtax,$Dtax)

       do Convert-to-DTU-DATE($Ctl_Curr_Pay_End_Dt,$DTU_end_dt)
       do dtu-month-end($DTU_end_dt,$DTU_monthend)
       do dtu-add-days($DTU_monthend,1,$DTU_TermLimit)
       do Convert-From-DTU-DATE($DTU_TermLimit,$TerminationLimit)
       do Convert-From-DTU-DATE($DTU_monthend,$RefMonthEnd)

       !--------------------------------------------------------------------
       ! monthly run
       !
       ! we want the terminated people in the current period
       !
       ! case 1 : normal termination,       ==> we want him
       !          bonus after termination   ==> we want him
       !          cond: ter > hir            // status=terminated
       !                ter <= seg_end       // terminated before or at this seg_end_dt
       !                ter is not null      // has at least 1 term
       !
       ! ----  no print wanted for these cases: ----
       !
       ! case 2 : termination and rehire same day in _our_ payroll run
       !          ==> a formal thing         ==> we want no printout
       !          cond: NOT (
       !                ter=hir              // same day rehire = switch
       !                ter <= seg_end       // terminated before or at this seg_end_dt
       !                ter is not null      // has at least 1 term
       !                )
       !
       ! case 3 : hired after some termination earlier
       !          ter <= hir ==> he is still employed ==> we want no printout
       !          covers also case 2
       !
       !          this is true, when the termination_dt is > hire_dt
       !               and  the termination_dt is <= seg_end_dt+1
       !
       ! case 4 : hired without any term
       !          ter = null    ==> he is still employed ==> we want no printout
       !
       !--------------------------------------------------------------------

 end-if

end-procedure
!*******************************************************************


!*******************************************************************
begin-procedure RePrintEMPLID

   LET $Ctl_Empl_Rcd =  #Ctl_Empl_Rcd
   let $emplid_clause = 'and TAX.EMPLID =  ''' || $Ctl_Emplid  || ''' ' || 'and TAX.EMPL_RCD =  ' || $Ctl_Empl_Rcd

end-procedure RePrintEMPLID
!*******************************************************************


!*******************************************************************
begin-procedure CheckXMLTestRunOnly

! Only close tax card if online Parameter 'XMLTestRunOnly' = 'N'

begin-SELECT
A.GPDE_AL_PROP_VAL       &ValueTestRun

from PS_GPDE_AL_VAL_PRS A
WHERE GPDE_AL_PROCESS_NM = 'ELSTER Lohn' AND GPDE_AL_PROP_NAME = 'XMLTestRunOnly'
end-select

  let $XMLTestRun = RTRIM(&ValueTestRun , ' ')
  if RTRIM(&ValueTestRun , ' ') = ''
     let $XMLTestRun = 'N'
  end-if
  let $PrintXMLTestRunOnly = 'N'

END-procedure CheckXMLTestRunOnly
!*******************************************************************


!*******************************************************************
begin-procedure CheckTestEnvironment


! If customers/Testers would like to do end-to-end testing, including closing of the tax card,
! they must create a variable called 'TestEnvironment', and set the value = 'Y'


begin-SELECT
A.GPDE_AL_PROP_VAL &ValueTestEnvir

from PS_GPDE_AL_VAL_PRS A
WHERE GPDE_AL_PROCESS_NM = 'System Setting' AND GPDE_AL_PROP_NAME = 'TestEnvironment'
end-select

  let $TestEnvironment = RTRIM(&ValueTestEnvir , ' ')
  if RTRIM(&ValueTestEnvir , ' ') = ''
     let $TestEnvironment = 'N'
  end-if


END-procedure CheckTestEnvironment
!*******************************************************************


!*******************************************************************
BEGIN-procedure getGrossbuchstaben($Grossbuchstaben,:$GrossbuchstabenALL)

   let $GrossbuchstabenALL = $Grossbuchstaben
   let #CapitalLetters =  length($GrossbuchstabenALL)
   if #CapitalLetters > 1
      let $Grossbuchstaben = substr($GrossbuchstabenALL, 1, 1) || ', ' || substr($GrossbuchstabenALL, 2, 1)
      if #CapitalLetters > 2
         let $Grossbuchstaben = $Grossbuchstaben || ', ' || substr($GrossbuchstabenALL, 3, 1)
         if #CapitalLetters > 3
            let $Grossbuchstaben = $Grossbuchstaben || ', ' || substr($GrossbuchstabenALL, 4, 1)
         end-if
      end-if
   end-if
   let $GrossbuchstabenALL = $Grossbuchstaben

end-procedure getGrossbuchstaben
!*******************************************************************


!*******************************************************************
begin-procedure YearlyCode
   #debug show 'begin procedure YearlyCode'
   #debug show '#PageNumber'
   #debug show #PageNumber
   #debug show '$Year'
   #debug show $Year

   evaluate $Year
       !add newer years in here
!Tax update 2010
     when >= '2010'
       do YearlyCode_2010
     when = '2008'    ! jjj08-1717018000 -Tax Updates 2008 (Elster)
     when = '2007'
       do YearlyCode_2007
     break

     when = '2006'
       do YearlyCode_2006
     break
     when-other
       !for 2005 and earlier
       do YearlyCode_2005
   end-evaluate

   #debug show 'end procedure YearlyCode'
end-procedure YearlyCode
!*******************************************************************


!*******************************************************************
begin-procedure YearlyCodeLabels
#debug show 'begin procedure YearlyCodeLabels'
   #debug show '#PageNumber'
   #debug show #PageNumber
   #debug show '$Year'
   #debug show $Year
   #debug show '#firstLineYearly'
   #debug show #firstLineYearly

evaluate $Year
    !add newer years in here
  when >= '2010'
    do YearlyCodeLabels_2010
  when = '2008'   ! jjj08-1717018000 -Tax Updates 2008 (Elster)
  when = '2007'
    do YearlyCodeLabels_2007
  break
    when = '2006'
    do YearlyCodeLabels_2006
  break
  when-other
    !for 2005 and earlier
    do YearlyCodeLabels_2005
end-evaluate

   #debug show 'end procedure YearlyCodeLabels'
end-procedure YearlyCodeLabels
!*******************************************************************

!*******************************************************************
begin-procedure YearlyCode_2005
   #debug show 'begin procedure YearlyCode_2005'
   #debug show '#PageNumber'
   #debug show #PageNumber
   #debug show '$Year'
   #debug show $Year

   !27 - 28: versorgungsbezuege
   if #PageNumber = 1
      do PrintValuesVersorgungsbezuege_2005
   end-if

   !29 - 34: additional lines
   if #PageNumber = 1
      do PrintValuesAdditionalLines_2005
   end-if

   #debug show 'end procedure YearlyCode_2005'
end-procedure YearlyCode_2005
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesVersorgungsbezuege_2005
   #debug show 'begin procedure PrintValuesVersorgungsbezuege_2005'

   !27 - 28: versorgungsbezuege

      !27
      do Get-Tag-Values($XMLData ,'VersFreiBetrBMG', $VersFreiBetrBMG)
      let #VersFreiBetrBMG = to_number($VersFreiBetrBMG)
      do Get_Before_After_Comma(#VersFreiBetrBMG ,$Num1,$Num2)
      let #currline = #posline27
      print $Num1                                      (#currline,#col9)
      print $Num2                                      (#currline,#col10)

      !28
      do Get-Tag-Values($XMLData ,'VersBezBeginn', $VersBezBeginn)
      if rtrim($VersBezBeginn, ' ') <> ''
         let $VersBezBeginn = '  '|| substr($VersBezBeginn ,1,2) ||{MonthYearSeparator}|| substr($VersBezBeginn ,3,4)
      end-if
      let #currline = #posline28
      print $VersBezBeginn                             (#currline,#col9)

   #debug show 'end procedure PrintValuesVersorgungsbezuege_2005'
end-procedure PrintValuesVersorgungsbezuege_2005
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesAdditionalLines_2005
   #debug show 'begin procedure PrintValuesAdditionalLines_2005'

      !29 - 34: additional lines
      !29
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text1', $Wert1)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text1', $Text1)
      if rtrim($Wert1, ' ') <> ''
         let #currline = #posline29
         alter-printer
            font = 4
            point-size = #PointSizeTextSmall
         print $Text1                              (#currline, #col6)
         let #Wert1 = to_number($Wert1)
         do Get_Before_After_Comma(#Wert1, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

      !30
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text2', $Wert2)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text2', $Text2)
      if rtrim($Wert2, ' ') <> ''
         let #currline = #posline30
         alter-printer
            font = 4
            point-size = #PointSizeTextSmall
         print $Text2                              (#currline, #col6)
         let #Wert2 = to_number($Wert2)
         do Get_Before_After_Comma(#Wert2, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

      !31
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text3', $Wert3)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text3', $Text3)
      if rtrim($Wert3, ' ') <> ''
         let #currline = #posline31
         alter-printer
            font = 4
            point-size = #PointSizeTextSmall
         print $Text3                              (#currline, #col6)
         let #Wert3 = to_number($Wert3)
         do Get_Before_After_Comma(#Wert3, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

      !32
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text4', $Wert4)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text4', $Text4)
      if rtrim($Wert4, ' ') <> ''
         let #currline = #posline32
         alter-printer
            font = 4
            point-size = #PointSizeTextSmall
         print $Text4                              (#currline, #col6)
         let #Wert4 = to_number($Wert4)
         do Get_Before_After_Comma(#Wert4, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

      !33
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text5', $Wert5)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text5', $Text5)
      if rtrim($Wert5, ' ') <> ''
         let #currline = #posline33
         alter-printer
            font = 4
            point-size = #PointSizeTextSmall
         print $Text5                              (#currline, #col6)
         let #Wert5 = to_number($Wert5)
         do Get_Before_After_Comma(#Wert5, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

      !34
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text6', $Wert6)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text6', $Text6)
      if rtrim($Wert6, ' ') <> ''
         let #currline = #posline34
         alter-printer
            font = 4
            point-size = #PointSizeTextSmall
         print $Text6                              (#currline, #col6)
         let #Wert6 = to_number($Wert6)
         do Get_Before_After_Comma(#Wert6, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

   #debug show 'end procedure PrintValuesAdditionalLines_2005'
end-procedure PrintValuesAdditionalLines_2005
!*******************************************************************


!*******************************************************************
begin-procedure YearlyCode_2006
   #debug show 'begin procedure YearlyCode_2006'
   #debug show '#PageNumber'
   #debug show #PageNumber
   #debug show '$Year'
   #debug show $Year

   ! Page 1
   if #PageNumber = 1

      !27 - 31: versorungsbezuege
      if #NrPages = 1
         do PrintValuesVersorgungsbezuege_2006_Page1
      end-if

      !32 - 37, additional lines
      do PrintValuesAdditionalLines_2006
   else !if #PageNumber = 1
      do PrintValuesVersorgungsbezuege_2006_Page2ff
   end-if !if #PageNumber = 1

   #debug show 'end procedure YearlyCode_2006'
end-procedure YearlyCode_2006
!*******************************************************************


!*******************************************************************
begin-procedure YearlyCode_2007
   #debug show 'begin procedure YearlyCode_2007'

   ! Page 1
   if #PageNumber = 1

      !27 - 30: StBegVBez
      if #NrPages = 1
         do PrintValuesVersorgungsbezuege_2007_Page1
      end-if
      !32 - 37, additional lines
      do PrintValuesAdditionalLines_2006
   else !if #PageNumber = 1
      do PrintValuesVersorgungsbezuege_2007_Page2ff
   end-if !if #PageNumber = 1

   #debug show 'end procedure YearlyCode_2007'
end-procedure YearlyCode_2007
!*******************************************************************
begin-procedure YearlyCode_2010
   #debug show 'begin procedure YearlyCode_2010'
   ! Page 1
   if #PageNumber = 1
      !27 - 30: StBegVBez
      if #NrPages = 1
          do PrintValuesVersorgungsbezuege_2010_Page1
      end-if
      !32 - 37, additional lines
     !aditya temp do not call....    do PrintValuesAdditionalLines_2010
   else !if #PageNumber = 1
      do PrintValuesVersorgungsbezuege_2010_Page2ff
      !call when we have wert2010
       if $wert_2010 = 'Y'
        #DEBUG show ' PrintValuesAdditionalLines_2010'
         do PrintValuesAdditionalLines_2010
       end-if
   end-if !if #PageNumber = 1

   #debug show 'end procedure YearlyCode_2010'
end-procedure YearlyCode_2010
!*******************************************************************

!*******************************************************************
begin-procedure PrintValuesVersorgungsbezuege_2006_Page1
   #debug show 'begin procedure PrintValuesVersorgungsbezuege_2006_Page1'

   let #NrElements = 0
   let $CurrentBG = ''
   let #CurrentBG = ''
   let $CurrentJahr = ''
   let $CurrentBeginn = ''
   let $CurrentEnde = ''
   let $tmpTimespan = ''
   let #CurrentLine27 = 0
   let #CurrentPage27 = 0
   let #CurrentLine28 = 0
   let #CurrentPage28 = 0
   let #CurrentLine29 = 0
   let #CurrentPage29 = 0

   let $CurrentAuszahlung = ''
   let #CurrentAuszahlung = 0
   let #CurrentLine30 = 0
   let #CurrentPage30 = 0
   let #CurrentLine31 = 0
   let #CurrentPage31 = 0

   !27 - 29: Versorgungsbezuege
   do GetArraySize_Versorgungsbezuege(#NrElements)
   if #NrElements > 0
      !retrieve first element from VBEZ array

      do GetArrayElement_Versorgungsbezuege(0, $CurrentBG, $CurrentJahr, $CurrentBeginn, $CurrentEnde, #CurrentLine27, #CurrentPage27, #CurrentLine28, #CurrentPage28, #CurrentLine29, #CurrentPage29)

      !27. Bemessungsgrundlage
      let #currline = #posline27
      let #CurrentBG = to_number($CurrentBG)
      do Get_Before_After_Comma(#CurrentBG ,$Num1,$Num2)
      print $Num1 (#currline,#col9)
      print $Num2 (#currline,#col10)

      ! 28. Jahr des Versorgungsbeginns
      let #currline = #posline28
      print $CurrentJahr (#currline,#col8center)

      ! 29. Erster und letzter Monat
      let #currline=#posline29
      if $CurrentBeginn <> '' or $CurrentEnde <> ''
         if $CurrentBeginn = ''
            let $tmpTimespan = '01'
         else
            let $tmpTimespan = $CurrentBeginn
         end-if
         if $CurrentEnde = ''
            let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || '12'
         else
            let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || $CurrentEnde
         end-if
      else
         let $tmpTimespan = ''
      end-if
      print $tmpTimespan (#currline,#col8center)
   end-if

   !30 - 31: Sterbegeld
   do GetArraySize_Sterbegeld(#NrElements)
   if #NrElements > 0
      !retrieve first element from sterbegeld array

      do GetArrayElement_Sterbegeld(0, $CurrentAuszahlung, $CurrentJahr, #CurrentLine30, #CurrentPage30, #CurrentLine31, #CurrentPage31)

      !30. Auszahlung Sterbegeld
      let #currline = #posline30
      let #CurrentAuszahlung = to_number($CurrentAuszahlung)
      do Get_Before_After_Comma(#CurrentAuszahlung, $Num1, $Num2)
      print $Num1 (#currline,#col9)
      print $Num2 (#currline,#col10)

      ! 31. Kalenderjahr des Versorgungsbeginns
      let #currline = #posline31
      print $CurrentJahr (#currline,#col8center)
   end-if
   #debug show 'end procedure PrintValuesVersorgungsbezuege_2006_Page1'
end-procedure PrintValuesVersorgungsbezuege_2006_Page1
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesVersorgungsbezuege_2007_Page1
   #debug show 'begin procedure PrintValuesVersorgungsbezuege_2007_Page1'

   let #NrElements = 0
   let $zeile8 = ''
   let $CurBMG = ''
   let $CurJahr = ''
   let $CurBeginn = ''
   let $CurEnde = ''
   let $tmpTimespan = ''
   Let $CurEinm = ''

   let #CurLine27 = 0
   let #CurPage27 = 0
   let #CurLine28 = 0
   let #CurPage28 = 0
   let #CurLine29 = 0
   let #CurPage29 = 0
   let #CurLine30 = 0
   let #CurPage30 = 0


   !27 - 30: StBegVBez
   do GetArraySize_StBegVBez(#NrElements)
   if #NrElements > 0
      !retrieve first element from VBEZ array

      do GetArrayElement_StBegVBez(0, $zeile8, $CurBMG, $CurJahr, $CurBeginn, $CurEnde, $CurEinm, #CurLine27, #CurPage27, #CurLine28, #CurPage28, #CurLine29, #CurPage29,  #CurLine30, #CurPage30)

      !27. Bemessungsgrundlage
      let #currline = #posline27
      let #CurBMG = to_number($CurBMG)
      do Get_Before_After_Comma(#CurBMG ,$Num1,$Num2)
      print $Num1 (#currline,#col9)
      print $Num2 (#currline,#col10)

      ! 28. Jahr des Versorgungsbeginns
      let #currline = #posline28
      print $CurJahr (#currline,#col8center)

      ! 29. Erster und letzter Monat
      let #currline=#posline29
      if $CurBeginn <> '' or $CurEnde <> ''
         if $CurBeginn = ''
            let $tmpTimespan = '01'
         else
            let $tmpTimespan = $CurBeginn
         end-if
         if $CurEnde = ''
            let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || '12'
         else
            let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || $CurEnde
         end-if
      else
         let $tmpTimespan = ''
      end-if
      print $tmpTimespan (#currline,#col8center)
   end-if

   !30. Auszahlung Einmalbezug
      let #currline = #posline30
      let #CurEinm = to_number($CurEinm)
      do Get_Before_After_Comma(#CurEinm, $Num1, $Num2)
      print $Num1 (#currline,#col9)
      print $Num2 (#currline,#col10)

   #debug show 'end procedure PrintValuesVersorgungsbezuege_2007_Page1'
end-procedure PrintValuesVersorgungsbezuege_2007_Page1
!*******************************************************************
!tax update 2010
!*******************************************************************
begin-procedure PrintValuesVersorgungsbezuege_2010_Page1
 #debug show 'begin procedure PrintValuesVersorgungsbezuege_2010_Page1'

   let #NrElements = 0
   let $zeile8 = ''
   let $CurBMG = ''
   let $CurJahr = ''
   let $CurBeginn = ''
   let $CurEnde = ''
   let $tmpTimespan = ''
   Let $CurEinm = ''

   let #CurLine27 = 0
   let #CurPage27 = 0
   let #CurLine28 = 0
   let #CurPage28 = 0
   let #CurLine29 = 0
   let #CurPage29 = 0
   let #CurLine30 = 0
   let #CurPage30 = 0


   !29 - 32: StBegVBez
   do GetArraySize_VBez(#NrElements)
   if #NrElements > 0
      !retrieve first element from VBEZ array

       do GetArrayElement_VBez(0, $zeile8, $zeile9, $CurBMG, $CurJahr, $CurBeginn, $CurEnde, $CurEinm, #CurLine8, #CurPage8, #CurLine9, #CurPage9, 
       #CurLine29, #CurPage29, #CurLine30, #CurPage30, #CurLine31, #CurPage31, #CurLine32, #CurPage32)
      !29.
      let #currline = #posline29
      let #CurBMG = to_number($CurBMG)
      do Get_Before_After_Comma(#CurBMG ,$Num1,$Num2)
      print $Num1 (#currline,#col9)
      print $Num2 (#currline,#col10)

      !30.
      let #currline = #posline30
      print $CurJahr (#currline,#col8center)

      !31.
      let #currline= #posline30 + 2
      if $CurBeginn <> '' or $CurEnde <> ''
         if $CurBeginn = ''
            let $tmpTimespan = '01'
         else
            let $tmpTimespan = $CurBeginn
         end-if
         if $CurEnde = ''
            let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || '12'
         else
            let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || $CurEnde
         end-if
      else
         let $tmpTimespan = ''
      end-if
      print $tmpTimespan (#currline,#col8center)
   end-if

   !32.
      let #currline = #posline30 + 4
      let #CurEinm = to_number($CurEinm)
      do Get_Before_After_Comma(#CurEinm, $Num1, $Num2)
      print $Num1 (#currline,#col9)
      print $Num2 (#currline,#col10)

   #debug show 'end procedure PrintValuesVersorgungsbezuege_2010_Page1'
end-procedure PrintValuesVersorgungsbezuege_2010_Page1


!*******************************************************************
begin-procedure PrintValuesVersorgungsbezuege_2006_Page2ff
   #debug show 'begin procedure PrintValuesVersorgungsbezuege_2006_Page2ff'

   !27 - 29: Versorgungsbezuege
   do PrintValuesForVBEZelements2006

   !30 - 31: Sterbegeld
   do PrintValuesForDTHBelements2006

   #debug show 'end procedure PrintValuesVersorgungsbezuege_2006_Page2ff'
end-procedure PrintValuesVersorgungsbezuege_2006_Page2ff
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesVersorgungsbezuege_2007_Page2ff
   #debug show 'begin procedure PrintValuesVersorgungsbezuege_2007_Page2ff'

   !27 - 30: StBegVBez
   do PrintValuesForVBEZelements2007

   #debug show 'end procedure PrintValuesVersorgungsbezuege_2007_Page2ff'
end-procedure PrintValuesVersorgungsbezuege_2007_Page2ff

!*******************************************************************
!Tax update 2010
begin-procedure PrintValuesVersorgungsbezuege_2010_Page2ff
   #debug show 'begin procedure PrintValuesVersorgungsbezuege_2010_Page2ff'

   !27 - 30:  VBez
   do PrintValuesForVBEZelements2010

   #debug show 'end procedure PrintValuesVersorgungsbezuege_2010_Page2ff'
end-procedure PrintValuesVersorgungsbezuege_2010_Page2ff
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesForVBEZelements2006
   #debug show 'begin procedure PrintValuesForVBEZelements2006'

   let #NrElements = 0
   let #CurrentElement = 0
   let $CurrentBG = ''
   let #CurrentBG = 0
   let $CurrentJahr = ''
   let $CurrentBeginn = ''
   let $CurrentEnde = ''
   let $tmpTimespan = ''
   let #CurrentLine27 = 0
   let #CurrentPage27 = 0
   let #CurrentLine28 = 0
   let #CurrentPage28 = 0
   let #CurrentLine29 = 0
   let #CurrentPage29 = 0

   alter-printer
      font = 3
      point-size = #PointSizeAmounts

   do GetArraySize_Versorgungsbezuege(#NrElements)

   while #CurrentElement < #NrElements

      do GetArrayElement_Versorgungsbezuege(#CurrentElement, $CurrentBG, $CurrentJahr, $CurrentBeginn, $CurrentEnde, #CurrentLine27, #CurrentPage27, #CurrentLine28, #CurrentPage28, #CurrentLine29, #CurrentPage29)
      if #CurrentPage27 = #PageNumber
         !27. Bemessungsgrundlage
         let #currline = #CurrentLine27
         let #CurrentBG = to_number($CurrentBG)
         do Get_Before_After_Comma(#CurrentBG ,$Num1,$Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)
      end-if
      if #CurrentPage28 = #PageNumber
         ! 28. Jahr des Versorgungsbeginns
         let #currline = #CurrentLine28
         print $CurrentJahr (#currline,#col8center)
      end-if
      if #CurrentPage29 = #PageNumber
         ! 29. Erster und letzter Monat
         let #currline=#CurrentLine29
         if $CurrentBeginn <> '' or $CurrentEnde <> ''
            if $CurrentBeginn = ''
               let $tmpTimespan = '01'
            else
               let $tmpTimespan = $CurrentBeginn
            end-if
            if $CurrentEnde = ''
               let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || '12'
            else
               let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || $CurrentEnde
            end-if
         else
            let $tmpTimespan = ''
         end-if
         print $tmpTimespan (#currline,#col8center)
      end-if

      add 1 to #CurrentElement
   end-while

   #debug show 'end procedure PrintValuesForVBEZelements2006'
end-procedure PrintValuesForVBEZelements2006
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesForVBEZelements2007
   #debug show 'begin procedure PrintValuesForVBEZelements'

   let #NrElements = 0
   let #curElement = 0
   let $CurStBegVBez = ''
   let $CurBMG = ''
   let #CurBMG = 0
   let $CurJahr = ''
   let $CurBeginn = ''
   let $CurEnde = ''
   let $tmpTimespan = ''
   let $CurEinm = ''
   let #CurLine27 = 0
   let #CurPage27 = 0
   let #CurLine28 = 0
   let #CurPage28 = 0
   let #CurLine29 = 0
   let #CurPage29 = 0
   let #CurLine30 = 0
   let #CurPage30 = 0

   alter-printer
      font = 3
      point-size = #PointSizeAmounts

   do GetArraySize_StBegVBez(#NrElements)

   while #CurElement < #NrElements

      do GetArrayElement_StBegVBez(#CurElement, $CurStBegVBez, $CurBMG, $CurJahr, $CurBeginn, $CurEnde, $CurEinm, #CurLine27, #CurPage27, #CurLine28, #CurPage28, #CurLine29, #CurPage29, #CurLine30, #CurPage30)
      if #CurPage27 = #PageNumber
         !27. Bemessungsgrundlage

         let #currline = #CurLine27
         let #CurBMG = to_number($CurBMG)
         do Get_Before_After_Comma(#CurBMG ,$Num1,$Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)

      end-if
      if #CurPage28 = #PageNumber
         ! 28. Jahr des Versorgungsbeginns
         let #currline = #CurLine28
         print $CurJahr (#currline,#col8center)
      end-if
      if #CurPage29 = #PageNumber
         ! 29. Erster und letzter Monat
         let #currline=#CurLine29
         if $CurBeginn <> '' or $CurEnde <> ''
            if $CurBeginn = ''
               let $tmpTimespan = '01'
            else
               let $tmpTimespan = $CurBeginn
            end-if
            if $CurEnde = ''
               let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || '12'
            else
               let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || $CurEnde
            end-if
         else
            let $tmpTimespan = ''
         end-if
         print $tmpTimespan (#currline,#col8center)
      end-if
      if #CurPage30 = #PageNumber
      !30. Einmalbezuege
         let #currline = #CurLine30
         let #CurEinm = to_number($CurEinm)
         do Get_Before_After_Comma(#CurEinm ,$Num1,$Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)
      end-if

      add 1 to #CurElement
   end-while

   #debug show 'end procedure PrintValuesForVBEZelements2007'
end-procedure PrintValuesForVBEZelements2007
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesForVBEZelements2010
  #DEBUG show 'begin procedure PrintVALUESForVBEZelements2010'

   let #NrElements = 0
   let #curElement = 0
   let $BegVBez = ''
   let $ErmStVBezMKalJahr = ''
   let $CurBMG = ''
   let #CurBMG = 0
   let $CurJahr = ''
   let $CurBeginn = ''
   let $CurEnde = ''
   let $tmpTimespan = ''
   let $CurEinm = ''
   let #CurLine8 = 0
   let #CurPage8 = 0
   let #CurLine9 = 0
   let #CurPage9 = 0
   let #CurLine29 = 0
   let #CurPage29 = 0
   let #CurLine30 = 0
   let #CurPage30 = 0
   let #CurLine31 = 0
   let #CurPage31 = 0
   let #CurLine32 = 0
   let #CurPage32 = 0

   alter-printer
      font = 3
      point-size = #PointSizeAmounts

   do GetArraySize_VBez(#NrElements)
   while #CurElement < #NrElements

      do GetArrayElement_VBez(#CurElement, $VBez, $ErmStVBezMKalJahr, $CurBMG, $CurJahr, $CurBeginn, $CurEnde, $CurEinm, #CurLine8, #CurPage8, #CurLine9, #CurPage9, #CurLine29, #CurPage29, 
      #CurLine30, #CurPage30, #CurLine31, #CurPage31, #CurLine32, #CurPage32)

      if #CurPage8 = #PageNumber
         !nr 8
         let #currline = #CurLine8
         let #VBez = to_number($VBez)
         do Get_Before_After_Comma(#VBez ,$Num1,$Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)
       end-if

      if #CurPage9 = #PageNumber
         ! nr 9
         let #currline = #CurLine9
         let #ErmStVBezMKalJahr = to_number($ErmStVBezMKalJahr)
         do Get_Before_After_Comma(#ErmStVBezMKalJahr ,$Num1,$Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)
      end-if

       if #CurPage29 = #PageNumber
         !29 bmgfreibetrag
         let #currline = #CurLine29
         let #CurBMG = to_number($CurBMG)
         do Get_Before_After_Comma(#CurBMG ,$Num1,$Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)
      end-if

      if #CurPage30 = #PageNumber
         ! 30. Jahr des Versorgungsbeginns
         let #currline = #CurLine30
         print $CurJahr (#currline,#col8center)
      end-if

      if #CurPage31 = #PageNumber
         ! 29. Erster und letzter Monat / new nr 31
         let #currline = #CurLine31
         if $CurBeginn <> '' or $CurEnde <> ''
            if $CurBeginn = ''
               let $tmpTimespan = '01'
            else
               let $tmpTimespan = $CurBeginn
            end-if
            if $CurEnde = ''
               let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || '12'
            else
               let $tmpTimespan = $tmpTimespan || {TimespanSeparator} || $CurEnde
            end-if
         else
            let $tmpTimespan = ''
         end-if
         print $tmpTimespan (#currline,#col8center)
      end-if
      if #CurPage32 = #PageNumber
      !30. einmversbezug / new 32
         let #currline = #CurLine32
         let #CurEinm = to_number($CurEinm)
         do Get_Before_After_Comma(#CurEinm ,$Num1,$Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)
      end-if

      add 1 to #CurElement
   end-while

   #debug show 'end procedure PrintValuesForVBEZelements2010'
end-procedure PrintValuesForVBEZelements2010
!*******************************************************************


!*******************************************************************
begin-procedure PrintValuesForDTHBelements2006
   #debug show 'begin procedure PrintValuesForDTHBelements2006'
   let #NrElements = 0
   let #CurrentElement = 0

   let $CurrentAuszahlung = ''
   let #CurrentAuszahlung = 0
   let $CurrentJahr = ''
   let #CurrentLine30 = 0
   let #CurrentPage30 = 0
   let #CurrentLine31 = 0
   let #CurrentPage31 = 0

   alter-printer
      font = 3
      point-size = #PointSizeAmounts

   do GetArraySize_Sterbegeld(#NrElements)

   while #CurrentElement < #NrElements

      do GetArrayElement_Sterbegeld(#CurrentElement, $CurrentAuszahlung, $CurrentJahr, #CurrentLine30, #CurrentPage30, #CurrentLine31, #CurrentPage31)
      if #CurrentPage30 = #PageNumber
         !30. Auszahlung
         let #currline = #CurrentLine30
         let #CurrentAuszahlung = to_number($CurrentAuszahlung)
         do Get_Before_After_Comma(#CurrentAuszahlung, $Num1, $Num2)
         print $Num1 (#currline,#col9)
         print $Num2 (#currline,#col10)
      end-if
      if #CurrentPage31 = #PageNumber
         ! 31. Kalenderjahr des Versorgungsbeginns
         let #currline = #CurrentLine31
         print $CurrentJahr (#currline,#col8center)
      end-if
      add 1 to #CurrentElement
   end-while
   #debug show 'end procedure PrintValuesForDTHBelements2006'
end-procedure PrintValuesForDTHBelements2006
!*******************************************************************

begin-procedure PrintValuesAdditionalLines_2010
 let #CurLine32 = 0
 let #i = 0
 let #line32_off = 7
   let #first_line = {FirstLineInTable} + 1
      !Print 3 wert
! print wert from top when there is one row in array
     if #CurLine30 <= 0 or #CurElement <= 1
         let #CurLine30 = #first_line
         let #line32_off = 0
     end-if
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text1', $Wert1)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text1', $Text1)
!ADJ : these values are to be printed on new page
      if rtrim($Wert1, ' ') <> ''
         let #currline = #CurLine30 + #line32_off
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
          graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         print $Text1                              (#currline, #col6)
         let #Wert1 = to_number($Wert1)
         do Get_Before_After_Comma(#Wert1, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
          print $Num1                               (#currline,#col9)
          print $Num2                               (#currline,#col10)
          let #currline = #CurLine30 +  #line32_off - 1
          let #linelength = 1
          graphic                                      (#currline, #col10 , #linelength)   vert-line 14
      end-if

      !2
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text2', $Wert2)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text2', $Text2)
      if rtrim($Wert2, ' ') <> ''
         let #currline =  #CurLine30 + #line32_off + 1 ! #posline32
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
         print $Text2                              (#currline, #col6)
         let #Wert2 = to_number($Wert2)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         do Get_Before_After_Comma(#Wert2, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
          let #currline = #CurLine30 + #line32_off ! + 1
          let #linelength = 1
          graphic                                      (#currline, #col10 , #linelength)   vert-line 14
      end-if

      !3
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text3', $Wert3)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text3', $Text3)
      if rtrim($Wert3, ' ') <> ''
         let #currline = #CurLine30 + #line32_off + 2 !#posline34
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
         print $Text3                              (#currline, #col6)
         let #Wert3 = to_number($Wert3)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         do Get_Before_After_Comma(#Wert3, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
           print $Num1                               (#currline,#col9)
           print $Num2                               (#currline,#col10)
          let #currline = #CurLine30 + #line32_off + 1
          let #linelength = 1
          graphic                                      (#currline, #col10 , #linelength)   vert-line 14
      end-if

      let #lastLineBox = #currline
! end-if ! wert <> ''
   #debug show 'end procedure PrintValuesAdditionalLines_2010'
end-procedure PrintValuesAdditionalLines_2010
!**********************************************************************************************************************************


!*******************************************************************
begin-procedure PrintValuesAdditionalLines_2006
   #debug show 'begin procedure PrintValuesAdditionalLines_2006'
   SHOW ' PrintValuesAdditionalLines_2006'

      !32 - 37, additional lines
      !32
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text1', $Wert1)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text1', $Text1)
      if rtrim($Wert1, ' ') <> ''
         let #currline = #posline32
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
         print $Text1                              (#currline, #col6)
         let #Wert1 = to_number($Wert1)
         do Get_Before_After_Comma(#Wert1, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

      !33
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text2', $Wert2)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text2', $Text2)
      if rtrim($Wert2, ' ') <> ''
         let #currline = #posline33
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
         print $Text2                              (#currline, #col6)
         let #Wert2 = to_number($Wert2)
         do Get_Before_After_Comma(#Wert2, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
         print $Num1                               (#currline,#col9)
         print $Num2                               (#currline,#col10)
      end-if

      !34
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text3', $Wert3)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text3', $Text3)
      if rtrim($Wert3, ' ') <> ''
         let #currline = #posline34
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
   !aditya comment      print $Text3                              (#currline, #col6)
         let #Wert3 = to_number($Wert3)
         do Get_Before_After_Comma(#Wert3, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
 !        print $Num1                               (#currline,#col9)
  !       print $Num2                               (#currline,#col10)
      end-if

      !35
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text4', $Wert4)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text4', $Text4)
      if rtrim($Wert4, ' ') <> ''
         let #currline = #posline35
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
         print $Text4                              (#currline, #col6)
         let #Wert4 = to_number($Wert4)
         do Get_Before_After_Comma(#Wert4, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
!         print $Num1                               (#currline,#col9)
!         print $Num2                               (#currline,#col10)
      end-if

      !36
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text5', $Wert5)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text5', $Text5)
      if rtrim($Wert5, ' ') <> ''
         let #currline = #posline36
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
         print $Text5                              (#currline, #col6)
         let #Wert5 = to_number($Wert5)
         do Get_Before_After_Comma(#Wert5, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
!         print $Num1                               (#currline,#col9)
!         print $Num2                               (#currline,#col10)
      end-if

      !37
      do Get-Extra-Line-Values($XMLData, 'Wert', 'Text6', $Wert6)
      do Get-Extra-Line-Values($XMLData, 'Text', 'Text6', $Text6)
      if rtrim($Wert6, ' ') <> ''
         let #currline = #posline37
         alter-printer
            font = 4
            point-size = #PointSizeTextNormal
         print $Text6                              (#currline, #col6)
         let #Wert6 = to_number($Wert6)
         do Get_Before_After_Comma(#Wert6, $Num1,$Num2)
         alter-printer
            font = 3
            point-size = #PointSizeAmounts
!         print $Num1                               (#currline,#col9)
!         print $Num2                               (#currline,#col10)
      end-if

   #debug show 'end procedure PrintValuesAdditionalLines_2006'
end-procedure PrintValuesAdditionalLines_2006
!*******************************************************************




!*******************************************************************
begin-procedure YearlyCodeLabels_2005
   #debug show 'begin procedure YearlyCodeLabels_2005'
   alter-printer
      font = 4
      point-size = #PointSizeTextSmall

   let #posline27 = #firstLineYearly
   let #currline = #posline27
   print '27.'                                  (#currline, #col5)
   print 'Bemessungsgrundlage fr den'          (#currline, #col6)
   let #currline = #currline + 1
   print 'Versorgungsfreibetrag'                (#currline, #col6)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
   let #currline = #posline27 - 1
   let #linelength = 2
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #posline28 = #posline27 + 2
   let #currline = #posline28
   print '28.'                                  (#currline, #col5)
   print 'Bei Versorgungsbezgen: Monat und'    (#currline, #col6)
   let #currline = #currline + 1
   print 'Kalenderjahr des Versorgungsbeginns'  (#currline, #col6)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

   let #posline29 = #posline28 + 2
   let #currline = #posline29
   print '29.'                                  (#currline, #col5)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
   let #currline = #posline29 - 1
   let #linelength = 1
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #posline30 = #posline29 + 1
   let #currline = #posline30
   print '30.'                                  (#currline, #col5)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
   let #currline = #posline30 - 1
   let #linelength = 1
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #posline31 = #posline30 + 1
   let #currline = #posline31
   print '31.'                                  (#currline, #col5)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
   let #currline = #posline31 - 1
   let #linelength = 1
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #posline32 = #posline31 + 1
   let #currline = #posline32
   print '32.'                                  (#currline, #col5)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
   let #currline = #posline32 - 1
   let #linelength = 1
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #posline33 = #posline32 + 1
   let #currline = #posline33
   print '33.'                                  (#currline, #col5)
   ! print 'Ausgezahltes Kindergeld'             (#currline, #col6)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
   let #currline = #posline33 - 1
   let #linelength = 1
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #posline34 = #posline33 + 1
   let #currline = #posline34
   print '34.'                                  (#currline, #col5)
   graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
   let #currline = #posline34 - 1
   let #linelength = 1
   graphic                                      (#currline, #col10 , #linelength)   vert-line 14

   let #lastLineYearly = #posline34

   #debug show 'end procedure YearlyCodeLabels_2005'
end-procedure YearlyCodeLabels_2005
!*******************************************************************


!*******************************************************************
begin-procedure YearlyCodeLabels_2006
   #debug show 'begin procedure YearlyCodeLabels_2006'

   ! Page 1
   if #PageNumber = 1
      !Versorgungsbezuege
      if #NrPages = 1
         do PrintLabelsVersorgungsbezuege_2006_Page1
      else !if #NrPages = 1
         do PrintSeeNextPageVersorgungsbezuege_2006
      end-if !if #NrPages = 1
      ! Additional Lines
      do PrintLabelsAdditionalLines
   else !if #PageNumber = 1
      !Pages 2 ff
      do PrintLabelsVersorgungsbezuege_2006_Page2ff
   end-if !if #PageNumber = 1

   #debug show 'end procedure YearlyCodeLabels_2006'
end-procedure YearlyCodeLabels_2006
!*******************************************************************


!*******************************************************************
begin-procedure YearlyCodeLabels_2007
   #debug show 'begin procedure YearlyCodeLabels_2007'

   ! Page 1
   if #PageNumber = 1
      !Versorgungsbezuege
      if #NrPages = 1
         do PrintLabelsVersorgungsbezuege_2007_Page1
      else !if #NrPages = 1
         do PrintSeeNextPageVersorgungsbezuege_2007
      end-if !if #NrPages = 1
      ! Additional Lines
      do PrintLabelsAdditionalLines
   else !if #PageNumber = 1
      !Pages 2 ff
      do PrintLabelsVersorgungsbezuege_2007_Page2ff
   end-if !if #PageNumber = 1

   #debug show 'end procedure YearlyCodeLabels_2007'
end-procedure YearlyCodeLabels_2007
!*******************************************************************


!*******************************************************************
begin-procedure YearlyCodeLabels_2010
   #debug show 'begin procedure YearlyCodeLabels_2010'
   ! Page 1
   if #PageNumber = 1
      !Versorgungsbezuege
      if #NrPages = 1
         do PrintLabelsVersorgungsbezuege_2010_Page1
       else !if #NrPages = 1
       !   do PrintSeeNextPageVersorgungsbezuege_2010  !adj - THERE ARE space for this.
          do PrintLabelsVersorgungsbezuege_2010_Page1
        !  show ' PrintSeeNextPageVersorgungsbezuege_2010 -- see next page ---- '
      end-if !if #NrPages = 1
      ! Additional Lines
      do PrintLabelsAdditionalLines_2010
   else !if #PageNumber = 1
      !Pages 2 ff
   #debug SHOW ' ------------------------------------------------- '
        do PrintLabelsVersorgungsbezuege_2010_Page2ff
   end-if !if #PageNumber = 1

   #debug show 'end procedure YearlyCodeLabels_2010'
end-procedure YearlyCodeLabels_2010



!*******************************************************************
begin-procedure PrintLabelsVersorgungsbezuege_2006_Page2ff
   #debug show 'begin procedure PrintLabelsVersorgungsbezuege_2006_Page2ff'

   do PrintLabelsForVBEZelements2006

   do PrintLabelsForDTHBelements

   #debug show 'end procedure PrintLabelsVersorgungsbezuege_2006_Page2ff'
end-procedure PrintLabelsVersorgungsbezuege_2006_Page2ff
!*******************************************************************


!*******************************************************************
begin-procedure PrintLabelsVersorgungsbezuege_2007_Page2ff
   #debug show 'begin procedure PrintLabelsVersorgungsbezuege_2007_Page2ff'

   do PrintLabelsForVBEZelements2007

   #debug show 'end procedure PrintLabelsVersorgungsbezuege_2006_Page2ff'
end-procedure PrintLabelsVersorgungsbezuege_2007_Page2ff
!*******************************************************************
!*******************************************************************
begin-procedure PrintLabelsVersorgungsbezuege_2010_Page2ff
  #debug  show 'begin procedure PrintLabelsVersorgungsbezuege_2010_Page2ff'

    do PrintLabelsForVBEZelements2010

   #debug show 'end procedure PrintLabelsVersorgungsbezuege_2010_Page2ff'
end-procedure PrintLabelsVersorgungsbezuege_2010_Page2ff


!*******************************************************************
begin-procedure PrintLabelsForVBEZelements2006
   #debug show 'begin procedure PrintLabelsForVBEZelements2006'
   #debug show '#PageNumber'
   #debug show #PageNumber

   let #NrElements = 0
   let #CurrentElement = 0
   let $CurrentBG = ''
   let $CurrentJahr = ''
   let $CurrentBeginn = ''
   let $CurrentEnde = ''
   let #CurrentLine27 = 0
   let #CurrentPage27 = 0
   let #CurrentLine28 = 0
   let #CurrentPage28 = 0
   let #CurrentLine29 = 0
   let #CurrentPage29 = 0

   alter-printer
      font = 4
      point-size = #PointSizeTextSmall

   do GetArraySize_Versorgungsbezuege(#NrElements)

   while #CurrentElement < #NrElements

      do GetArrayElement_Versorgungsbezuege(#CurrentElement, $CurrentBG, $CurrentJahr, $CurrentBeginn, $CurrentEnde, #CurrentLine27, #CurrentPage27, #CurrentLine28, #CurrentPage28, #CurrentLine29, #CurrentPage29)
      if #CurrentPage27 = #PageNumber
         let #currline = #CurrentLine27
         print '27.'                                  (#currline, #col5)
         print 'Bemessungsgrundlage fr den'          (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsfreibetrag'                (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurrentLine27 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurrentLine27 + {line27size} - 1
      end-if
      if #CurrentPage28 = #PageNumber
         let #currline = #CurrentLine28
         print '28.'                                  (#currline, #col5)
         print 'Bei Versorgungsbezgen: Kalenderjahr '    (#currline, #col6)
         let #currline = #currline + 1
         print 'des Versorgungsbeginns'  (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #lastLineBox =  #CurrentLine28 + {line28size} - 1
      end-if
      if #CurrentPage29 = #PageNumber
         let #currline=#CurrentLine29
         print '29.'                                                  (#currline, #col5)
         print 'Bei unterjhriger Zahlung: Erster und letzter Monat,' (#currline, #col6)
         let #currline = #currline + 1
         print 'fr den Versorgungsbezge gezahlt wurden'             (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #lastLineBox =  #CurrentLine29 + {line29size} - 1
      end-if

      add 1 to #CurrentElement
   end-while

   #debug show 'end procedure PrintLabelsForVBEZelements2006'
end-procedure PrintLabelsForVBEZelements2006
!*******************************************************************


!*******************************************************************
begin-procedure PrintLabelsForVBEZelements2007
   #debug show 'begin procedure PrintLabelsForVBEZelements2007'
   #debug show '#PageNumber'
   #debug show #PageNumber

   let #NrElements = 0
   let #CurElement = 0
   let $CurStBegVBez = ''
   let $CurBMG = ''
   let $CurJahr = ''
   let $CurBeginn = ''
   let $CurEnde = ''
   let $CurEinm = ''
   let #CurLine27 = 0
   let #CurPage27 = 0
   let #CurLine28 = 0
   let #CurPage28 = 0
   let #CurLine29 = 0
   let #CurPage29 = 0
   let #CurLine30 = 0
   let #CurPage30 = 0


   alter-printer
      font = 4
      point-size = #PointSizeTextSmall

   do getarraysize_stbegvbez(#NrElements)

   while #CurElement < #NrElements

      do GetArrayElement_StBegVBez(#CurElement, $CurStBegVBez, $CurBMG, $CurJahr, $CurBeginn, $CurEnde, $CurEinm, #CurLine27, #CurPage27, #CurLine28, #CurPage28, #CurLine29, #CurPage29, #CurLine30, #CurPage30)
      if #CurPage27 = #PageNumber
         let #currline = #CurLine27
         print '27.'                                  (#currline, #col5)
         print 'Bemessungsgrundlage fr den'          (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsfreibetrag zu 8.'                (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurLine27 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurLine27 + {line27size} - 1
      end-if
      if #CurPage28 = #PageNumber
         let #currline = #CurLine28
         print '28.'                                  (#currline, #col5)
         print 'Magebendes Kalenderjahr des'    (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsbeginns zu 8. und/oder 9.'  (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #lastLineBox =  #CurLine28 + {line28size} - 1
      end-if
      if #CurPage29 = #PageNumber
         let #currline=#CurLine29
         print '29.'                                                  (#currline, #col5)
         print 'Zu 8. Bei unterjhriger Zahlung: Erster und letzter' (#currline, #col6)
         let #currline = #currline + 1
         print 'Monat, fr den Versorgungsbezge gezahlt wurden'             (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #lastLineBox =  #CurLine29 + {line29size} - 1
      end-if


     if #CurPage30 = #PageNumber
         let #currline = #CurLine30
         print '30.'                                                  (#currline, #col5)
         print 'Sterbegeld; Kapitalauszahlungen/Abfindungen und'      (#currline, #col6)
         let #currline = #currline + 1
         print 'Nachzahlungen von Versorgungsbezgen - in 3.'         (#currline, #col6)
         let #currline = #currline + 1
         print 'und 8. enthalten'                                     (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurLine30 - 1
         let #linelength = 3
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurLine30 + {line30size} - 1
      end-if

      add 1 to #CurElement
   end-while

   #debug show 'end procedure PrintLabelsForVBEZelements2007'
end-procedure PrintLabelsForVBEZelements2007
!*******************************************************************

!*******************************************************************
begin-procedure PrintLabelsForVBEZelements2010
    #debug show 'begin procedure PrintLabelsForVBEZelements2010'

   let #NrElements = 0
   let #CurElement = 0
   let $CurStBegVBez = ''
   let $CurBMG = ''
   let $CurJahr = ''
   let $CurBeginn = ''
   let $CurEnde = ''
   let $CurEinm = ''
   let #CurLine8 = 0
   let #CurPage8 = 0
   let #CurLine9 = 0
   let #CurPage9 = 0
   let #CurLine29 = 0
   let #CurPage29 = 0
   let #CurLine30 = 0
   let #CurPage30 = 0
!new
   let #CurLine31 = 0
   let #CurPage31 = 0
   let #CurLine32 = 0
   let #CurPage32 = 0

! tax update 2010 :  set #lastLineBox for wert here
 let #lastLineBox = 2
      alter-printer
      font = 4
      point-size = #PointSizeTextSmall

      do getarraysize_vbez(#NrElements)

  while #CurElement < #NrElements
      do GetArrayElement_VBez(#CurElement, $VBez, $ErmStVBezMKalJahr, $CurBMG, $CurJahr, $CurBeginn, $CurEnde, $CurEinm, #CurLine8, #CurPage8, #CurLine9, #CurPage9, #CurLine29, #CurPage29, #CurLine30, 
      #CurPage30, #CurLine31, #CurPage31, #CurLine32, #CurPage32)

       if #CurPage8 = #PageNumber
         let #currline = #CurLine8

         print '8.'                                  (#currline, #col5)
         print 'In 3. enthaltene Versorgungsbezge'          (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurLine8 - 1
         let #linelength = 1
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurLine8 + {line8size_2010} - 1
      end-if

       if #CurPage9 = #PageNumber
         let #currline = #CurLine9 !- 1
         print '9.'                                  (#currline, #col5)
         print 'Ermigt besteuerte Versorgungsbezge fr'    (#currline, #col6)
         let #currline = #currline + 1
         print 'mehrere Kalenderjahre'  (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurLine9 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurLine9 + {line9size_2010} - 1
      end-if

      if #CurPage29 = #PageNumber
         let #currline= #CurLine29 ! - 1
         print '29.'                                                  (#currline, #col5)
         print 'Bemessungsgrundlage fr den' (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsfreibetrag zu 8.'             (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurLine29 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurLine29 + {line29size_2010} - 1
      end-if


     if #CurPage30 = #PageNumber
         let #currline = #CurLine30! -1
         print '30.'                                                  (#currline, #col5)
         print 'Magebendes Kalenderjahr des'      (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsbeginns zu 8. und/oder 9.'         (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #lastLineBox =  #CurLine30 + {line30size_2010} - 1
      end-if
!new rows
     if #CurPage31 = #PageNumber
         let #currline = #CurLine31 !- 1
         print '31.'                                                  (#currline, #col5)
         print 'Zu 8. bei unterjhriger Zahlung: Erster und letzter'      (#currline, #col6)
         let #currline = #currline + 1
         print 'Monat, fr den Versorgungsbezge gezahlt wurden'         (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #lastLineBox =  #CurLine31 + {line31size_2010} - 1
      end-if

     if #CurPage32 = #PageNumber
         let #currline = #CurLine32 !- 1
         print '32.'                                                  (#currline, #col5)
         print 'Sterbegeld; Kapitalauszahlungen/Abfindungen'      (#currline, #col6)
         let #currline = #currline + 1
         print 'und Nachzahlungen von Versorgungsbezgen'         (#currline, #col6)
         let #currline = #currline + 1
         print 'in 3. und 8. enthalten'                           (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurLine32 - 1
         let #linelength = 3
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurLine32 + {line32size_2010}  - 1
      end-if
      add 1 to #CurElement
   end-while
! check if wert are reported, update lastlinebox
     if $wert_2010 = 'Y'
       let #lastLineBox = #lastLineBox + 3
     end-if
   #debug show 'end procedure PrintLabelsForVBEZelements2010'
end-procedure PrintLabelsForVBEZelements2010



!*******************************************************************
begin-procedure PrintLabelsForDTHBelements
   #debug show 'begin procedure PrintLabelsForDTHBelements'
   #debug show '#PageNumber'
   #debug show #PageNumber

   let #NrElements = 0
   let $CurrentAuszahlung = ''
   let $CurrentJahr = ''
   let #CurrentElement = 0
   let #CurrentLine30 = 0
   let #CurrentPage30 = 0
   let #CurrentLine31 = 0
   let #CurrentPage31 = 0

   alter-printer
      font = 4
      point-size = #PointSizeTextSmall

   do GetArraySize_Sterbegeld(#NrElements)

   while #CurrentElement < #NrElements

      do GetArrayElement_Sterbegeld(#CurrentElement, $CurrentAuszahlung, $CurrentJahr, #CurrentLine30, #CurrentPage30, #CurrentLine31, #CurrentPage31)
      if #CurrentPage30 = #PageNumber
         let #currline = #CurrentLine30
         print '30.'                                                  (#currline, #col5)
         print 'Sterbegeld; Kapitalauszahlungen/Abfindungen und'      (#currline, #col6)
         let #currline = #currline + 1
         print 'Nachzahlungen von Versorgungsbezgen - in 3.'         (#currline, #col6)
         let #currline = #currline + 1
         print 'und 8. enthalten'                                     (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #CurrentLine30 - 1
         let #linelength = 3
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #lastLineBox =  #CurrentLine30 + {line30size} - 1
      end-if
      if #CurrentPage31 = #PageNumber
         let #currline = #CurrentLine31
         print '31.'                                                  (#currline, #col5)
         print 'Zu 30. und/oder 9.: magebendes Kalenderjahr'         (#currline, #col6)
         let #currline = #currline + 1
         print 'des Versorgungsbeginns'                               (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #lastLineBox =  #CurrentLine31 + {line31size} - 1
      end-if

      add 1 to #CurrentElement
   end-while

   #debug show 'end procedure PrintLabelsForDTHBelements'
end-procedure PrintLabelsForDTHBelements
!*******************************************************************

!*******************************************************************
begin-procedure PrintLabelsVersorgungsbezuege_2006_Page1
   #debug show 'begin procedure PrintLabelsVersorgungsbezuege_2006_Page1'

         alter-printer
         font = 4
         point-size = #PointSizeTextSmall

         let #posline27 = #firstLineYearly
         let #currline = #posline27
         print '27.'                                  (#currline, #col5)
         print 'Bemessungsgrundlage fr den'          (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsfreibetrag'                (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline27 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14

         let #posline28 = #posline27 + 2
         let #currline = #posline28
         print '28.'                                  (#currline, #col5)
         print 'Bei Versorgungsbezgen: Kalenderjahr'    (#currline, #col6)
         let #currline = #currline + 1
         print 'des Versorgungsbeginns'               (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline29 = #posline28 + 2
         let #currline=#posline29
         print '29.'                                                  (#currline, #col5)
         print 'Bei unterjhriger Zahlung: Erster und letzter Monat,' (#currline, #col6)
         let #currline = #currline + 1
         print 'fr den Versorgungsbezge gezahlt wurden'             (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #posline30 = #posline29 + 2
         let #currline = #posline30
         print '30.'                                                  (#currline, #col5)
         print 'Sterbegeld; Kapitalauszahlungen/Abfindungen und'      (#currline, #col6)
         let #currline = #currline + 1
         print 'Nachzahlungen von Versorgungsbezgen - in 3.'         (#currline, #col6)
         let #currline = #currline + 1
         print 'und 8. enthalten'                                     (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline30 - 1
         let #linelength = 3
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14

         let #posline31 = #posline30 + 3
         let #currline = #posline31
         print '31.'                                                  (#currline, #col5)
         print 'Zu 30. und/oder 9.: magebendes Kalenderjahr'         (#currline, #col6)
         let #currline = #currline + 1
         print 'des Versorgungsbeginns'                               (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #posline32 = #posline31 + 2

   #debug show 'end procedure PrintLabelsVersorgungsbezuege_2006_Page1'
end-procedure PrintLabelsVersorgungsbezuege_2006_Page1
!*******************************************************************

!*******************************************************************
begin-procedure PrintLabelsVersorgungsbezuege_2007_Page1
   #debug show 'begin procedure PrintLabelsVersorgungsbezuege_2007_Page1'

         alter-printer
         font = 4
         point-size = #PointSizeTextSmall

         let #posline27 = #firstLineYearly
         let #currline = #posline27
         print '27.'                                  (#currline, #col5)
         print 'Bemessungsgrundlage fr den'          (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsfreibetrag zu 8.'                (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline27 - 1
         let #linelength = 2
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14

         let #posline28 = #posline27 + 2
         let #currline = #posline28
         print '28.'                                  (#currline, #col5)
         print 'Magebendes Kalenderjahr'    (#currline, #col6)
         let #currline = #currline + 1
         print 'des Versorgungsbeginns'               (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline29 = #posline28 + 2
         let #currline=#posline29
         print '29.'                                                  (#currline, #col5)
         print 'Zu 8. Bei unterjhriger Zahlung: Erster und letzter' (#currline, #col6)
         let #currline = #currline + 1
         print 'Monat, fr den Versorgungsbezge gezahlt wurden'             (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline30 = #posline29 + 2
         let #currline = #posline30
         print '30.'                                                  (#currline, #col5)
         print 'Sterbegeld; Kapitalauszahlungen/Abfindungen und'      (#currline, #col6)
         let #currline = #currline + 1
         print 'Nachzahlungen von Versorgungsbezgen - in 3.'         (#currline, #col6)
         let #currline = #currline + 1
         print 'und 8. enthalten'                                     (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline30 - 1
         let #linelength = 3
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
  let #posline31 = #posline30 + 3

   #debug show 'end procedure PrintLabelsVersorgungsbezuege_2007_Page1'
end-procedure PrintLabelsVersorgungsbezuege_2007_Page1
!*******************************************************************

!*******************************************************************
begin-procedure PrintSeeNextPageVersorgungsbezuege_2006
   #debug show 'begin procedure PrintSeeNextPageVersorgungsbezuege_2006'

         alter-printer
         font = 4
         point-size = #PointSizeTextNormal

         let #posline27 = #firstLineYearly
         let #currline=#posline27
         print '27.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite' (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline28 = #posline27 + 1
         let #currline=#posline28
         print '28.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite' (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline29 = #posline28 + 1
         let #currline=#posline29
         print '29.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite' (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline30 = #posline29 + 1
         let #currline = #posline30
         print '30.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite'      (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline31 = #posline30 + 1
         let #currline = #posline31
         print '31.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite'         (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #posline32 = #posline31 + 1

   #debug show 'end procedure  PrintSeeNextPageVersorgungsbezuege_2006'
end-procedure  PrintSeeNextPageVersorgungsbezuege_2006
!*******************************************************************

!*******************************************************************
begin-procedure PrintSeeNextPageVersorgungsbezuege_2007
   #debug show 'begin procedure PrintSeeNextPageVersorgungsbezuege_2007'

         alter-printer
         font = 4
         point-size = #PointSizeTextNormal

         let #posline27 = #firstLineYearly
         let #currline=#posline27
         print '27.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite' (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline28 = #posline27 + 1
         let #currline=#posline28
         print '28.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite' (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline29 = #posline28 + 1
         let #currline=#posline29
         print '29.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite' (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline30 = #posline29 + 1
         let #currline = #posline30
         print '30.'                                                  (#currline, #col5)
         print 'Siehe nchste Seite'      (#currline, #col6)
         graphic                          (#currline, #col5line, #boxwidth)  horz-line 8
  let #posline31 = #posline30 + 1


   #debug show 'end procedure  PrintSeeNextPageVersorgungsbezuege_2007'
end-procedure  PrintSeeNextPageVersorgungsbezuege_2007
!*******************************************************************

!*******************************************************************
begin-procedure PrintLabelsVersorgungsbezuege_2010_Page1
 #debug show 'begin procedure PrintLabelsVersorgungsbezuege_2010_Page1'

         alter-printer
         font = 4
         point-size = #PointSizeTextSmall

         let #posline27 = #firstLineYearly
         let #currline = #posline27
         print '27.'                                  (#currline, #col5)
         print 'Arbeitnehmerbeitrge zur Arbeitslosenversicherung'             (#currline, #col6)
        ! let #currline = #currline + 1
        ! print 'Arbeitslosenversicherung'             (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline27 - 1
         let #linelength = 5  !2 draw vertical line
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14

         let #posline28 = #posline27 + 1
         let #currline = #posline28
         print '28.'                                  (#currline, #col5)
         print 'Nachgewiesene Beitrge zur privaten Kranken-'    (#currline, #col6)
         let #currline = #currline + 1
         print 'versicherung und Pflege-Pflichtversicherung'     (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline29 = #posline28 + 2
         let #currline=#posline29
         print '29.'                                 (#currline, #col5)
         print 'Bemessungsgrundlage fr den'         (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsfreibetrag zu 8.'          (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline30 = #posline29 + 2
         let #currline = #posline30
         print '30.'                                         (#currline, #col5)
         print 'Magebendes Kalenderjahr des'                (#currline, #col6)
         let #currline = #currline + 1
         print 'Versorgungsbeginns zu 8. und/oder 9.'        (#currline, #col6)
!         let #currline = #currline + 1
!         print 'und 8. enthalten'                                     (#currline, #col6)

         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline30 + 3
         let #linelength = 3
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
  let #posline31 = #posline30 + 3

   #debug show 'end procedure PrintLabelsVersorgungsbezuege_2010_Page1'
end-procedure PrintLabelsVersorgungsbezuege_2010_Page1


!*******************************************************************
begin-procedure PrintSeeNextPageVersorgungsbezuege_2010
   #debug show 'begin procedure PrintSeeNextPageVersorgungsbezuege_2010'

         alter-printer
         font = 4
         point-size = #PointSizeTextSmall

         let #posline27 = #firstLineYearly
         let #currline=#posline27
!         print '27.'                                                  (#currline, #col5)
!         print 'Siehe nchste Seite' (#currline, #col6)
!         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline28 = #posline27 + 1
         let #currline=#posline28
!         print '28.'                                                  (#currline, #col5)
!         print 'Siehe nchste Seite' (#currline, #col6)
!         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline29 = #posline28 + 1
         let #currline=#posline29
!         print '29.'                                                  (#currline, #col5)
!         print 'Siehe nchste Seite' (#currline, #col6)
!         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8

         let #posline30 = #posline29 + 1
         let #currline = #posline30
!         print '30.'                                                  (#currline, #col5)
!         print 'Siehe nchste Seite'      (#currline, #col6)
!         graphic                          (#currline, #col5line, #boxwidth)  horz-line 8
  let #posline31 = #posline30 + 1


 show 'end procedure  PrintSeeNextPageVersorgungsbezuege_2010  #posline31 ' #posline31
end-procedure  PrintSeeNextPageVersorgungsbezuege_2010
!******************************************************************
!*******************************************************************
begin-procedure PrintLabelsAdditionalLines
   #debug show 'begin procedure PrintLabelsAdditionalLines'

      ! Additional lines
      alter-printer
         font = 4
         point-size = #PointSizeTextNormal

      if $PrcYear = '2007' or $PrcYear = '2008'   ! jjj08-1717018000 -Tax Updates 2008 (Elster)
         let #currline = #posline31
         print '31.'                                  (#currline, #col5)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline31 - 1
         let #linelength = 1
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #posline32 = #posline31 + 1

      end-if

      let #currline = #posline32
      print '32.'                                  (#currline, #col5)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline32 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline33 = #posline32 + 1
      let #currline = #posline33
      print '33.'                                  (#currline, #col5)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline33 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline34 = #posline33 + 1
      let #currline = #posline34
      print '34.'                                  (#currline, #col5)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline34 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline35 = #posline34 + 1
      let #currline = #posline35
      print '35.'                                  (#currline, #col5)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline35 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline36 = #posline35 + 1
      let #currline = #posline36
      print '36.'                                  (#currline, #col5)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline36 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline37 = #posline36 + 1
      let #currline = #posline37
      print '37.'                                  (#currline, #col5)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline37 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #lastLineYearly = #posline37

   #debug show 'end procedure PrintLabelsAdditionalLines'
end-procedure PrintLabelsAdditionalLines

!*******************************************************************
begin-procedure PrintLabelsAdditionalLines_2010
   #debug show 'begin procedure PrintLabelsAdditionalLines'

      ! Additional lines
      alter-printer
         font = 4
         !point-size = #PointSizeTextSmall_2010
         point-size = #PointSizeTextSmall
         let #currline = #posline31 - 1
         print '31.'                                                             (#currline, #col5)
         print 'Zu 8. bei unterjhriger Zahlung: Erster und letzter'             (#currline, #col6)
         let #currline = #currline + 1
         print 'Monat, fr den Versorgungsbezge gezahlt wurden'                 (#currline, #col6)
         graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
         let #currline = #posline31
         let #linelength = 1
         graphic                                      (#currline, #col10 , #linelength)   vert-line 14
         let #posline32 = #posline31 + 1


      let #currline = #posline32
      print '32.'                                  (#currline, #col5)
      print 'Sterbegeld; Kapitalauszahlungen/Abfindungen'            (#currline, #col6)
      let #currline = #currline + 1
      print 'und Nachzahlungen von Versorgungsbezgen'          (#currline, #col6)
      let #currline = #currline + 1
      print '- in 3. und 8. enthalten'                  (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline32 - 1
      let #linelength = 2
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #posline33 = #posline32 + 3
      let #currline = #posline33
      print '33.'                                  (#currline, #col5)
      print 'Ausgezahltes Kindergeld'              (#currline, #col6)
      graphic                                      (#currline, #col5line, #boxwidth)  horz-line 8
      let #currline = #posline33 - 1
      let #linelength = 1
      graphic                                      (#currline, #col10 , #linelength)   vert-line 14

      let #lastLineYearly = #posline33

   #debug show 'end procedure PrintLabelsAdditionalLines'
end-procedure PrintLabelsAdditionalLines_2010



!*******************************************************************
begin-procedure CheckTicketClosed

begin-select
GPDE_RC_YR_CLOSE

        let $Closed = &GPDE_RC_YR_CLOSE

from PS_GPDE_TX_XMLRSLT
WHERE GPDE_ELSTER_TKT  =  $ELSTER_Ticket
end-select

if rtrim($Closed, ' ') = ''
  let $Closed = 'N'
end-if

end-procedure CheckTicketClosed
!*******************************************************************

!***********************************************************************
! For SelfService Purposes: Online Payslip                                    *
! Procedure : GP-ePay-Init                                             *
! Initialize variables that well use for SelfService processing              *
!***********************************************************************
begin-procedure GP-ePay-Init

! check process was running from within PSJob GPDE_TX1.  Otherwise SelfService
! tables should not be written

  let $ePay_Installed = 'Y'
  let $RunsInEpayJob = 'Y'
  let #pagecount = 1

  do JobCheck
  display $RunsInEpayJob

  if $RunsInEpayJob='Y'
     let $sql-statement = 'GPDETX01.sqr, GP-ePay-Init '

!    get urlid from setup table GPDE_AL_VAL_PRS
     let $ePay_Installed = 'N'
     do Get-SelfService-URLid ($eV18)

     If $ePay_Installed = 'Y'
        let #eV4 =  To_number($prcs_process_instance)

       !* have the Output Working Directory from the Process parameters table
       do Get-Output-Wrk-Directory(#eV4, $PRCSOUTPUTDIR, $PRCSNAME)

       !* Global SelfService variable settings used in GP-SelfService procedures in this SQR
       show 'run control id'
       show $prcs_run_cntl_id

       let $eV1 = $prcs_oprid
       let $eV2 = $prcs_run_cntl_id
       let $eV3 = $ReportID
       let #page-total = 1

    End-If
 end-if

end-procedure !GP-ePay-Init

!***********************************************************************
! For SelfService Purposes: Online Payslip                                    *
! Procedure : GP-ePay-Guide                                            *
! Insert one row per payslip into the temporary guide table for SelfService   *
!***********************************************************************

begin-procedure GP-ePay-Guide

 let $sql-statement = 'GPDETX01.sqr,GP-ePay-Guide'
 If $ePay_Installed = 'Y' and  $RunsInEpayJob='Y'
   do Get-RUN-TYPE

   If $RUN_TYPE = ''
    let $RUN_TYPE = 'KDGPAYRUN'
   End-if

   let $eV5  = rtrim($Emplid, ' ')
   let $eV5  = ltrim($eV5, ' ')

   if $Ctl_cal_run_id = ''
      let $Ctl_cal_run_id = rtrim($Year,' ')

   end-if

   let $eV6 = rtrim($Ctl_cal_run_id,' ')
   let $eV6 = ltrim($eV6,' ')

   let $eV7  = 'GPDEU'
   let $eV8  = 'TX01' || ltrim(rtrim($CAL_ID,' '),' ')|| $Pygrp || $eV5
   Let $eV8 = replace($eV8,'-','_')
   Let $eV8 = replace($eV8,' ','')

   let $eV8 = $eV8 || '-' || to_char(#Empl_Rcd_Num)
   let $eV8  = rtrim($eV8, ' ')

   let $eV9  =  $Termdt
   let $eV10  = $Termdt
   let $eV11 = $start_date

   let #eV12 = #EARN_DED
   let $eV13 = 'Steuerkarte fuer Jahr ' || rtrim($Year,' ')

   let $eV14 = rtrim($RUN_TYPE, ' ')
   let $eV15 = 'ORIG'

   !sysfilename of the payslip pdf since
   let $eV16 = $eV6 || '_' ||$eV7 || '_' ||$eV8 || '.pdf'

   !userfilename  - what the payee sees
   let $eV17 = $eV16

   !begin/end page number of payslip in output report
   let #eV19 = #pagecount
   let #eV20 = (#pagecount + #NrPages) - 1
   let #pagecount = #eV20 + 1


   !Input:OPRID, RUN_CNTL_ID, PROCNAME, DATAINST, EMPLID, CAL_RUN_ID, SRCPRODUCT,
   !GP_PSLP_ID,PYMT_DT,PRD_END_DT,PRD_BGN_DT,#NET_PAY,Payslip DESCR,RUN_TYPE,
   !PSLP_STATUS,ATTACHSYSFILENAME, ATTACHUSERFILE,FILEURLID, BGNPGNBR,ENDPGNBR

    do Insert-ePay-Guide-Data($eV1,$eV2,$eV3,#eV4,$eV5,$eV6,$eV7,$eV8,$eV9,$eV10,$eV11,#eV12,$eV13,$eV14,$eV15,$eV16,$eV17,$eV18,#eV19,#eV20)

 End-If


end-procedure ! GP-ePay-Guide

!***********************************************************************
! For SelfService Purposes: Online Payslip                                    *
! Procedure : GP-ePay-Control                                          *
! Insert one row per report into the epay run control table            *
!***********************************************************************
begin-procedure GP-ePay-Control

  let $sql-statement = 'GPDETX01.sqr,GP-ePay-Control '
  If $ePay_Installed = 'Y'  and  $RunsInEpayJob='Y'

   !Do Copy-Report-For-SelfService
   let $rptid = lower($ReportID)
   let $eCV7  = $rptid|| '_' || $prcs_process_instance || '.PDF'
   let $eCV8  = rtrim($PRCSOUTPUTDIR, ' ')

   ! Input:OPRID,RUN_CNTL_ID,PROCNAME,SPLIT_IND,ATCH_IND,CTLFILE,SOURCEFILE,
   ! SOURCELOC,WORKINGLOC,FILELAYOUT,DATAINST,FILEURLID,CLEANUP

  do Insert-ePay-RunControl($eV1,$eV2,$eV3,'Y', 'Y', ' ', $eCV7,$eCV8,' ',' ',#eV4,$eV18,'N')

 End-If

end-procedure !GP-ePay-Control

!***********************************************************************
! Get-RUN-TYPE                                                         *
!***********************************************************************
begin-procedure Get-RUN-TYPE

let $RUN_TYPE           =  ''
let $sql-statement = 'GPDETX01.sqr,Select , Get-RUN-TYPE'

BEGIN-SELECT ON-ERROR=SQL-Error
CAL.RUN_TYPE               &CAL_RUN_TYPE
   let $RUN_TYPE = substr(&CAL_RUN_TYPE, 1,9)
FROM   PS_GP_CALENDAR CAL
WHERE   CAL.GP_PAYGROUP       = $Pygrp
    AND CAL.CAL_ID            = $CAL_ID
END-SELECT


end-procedure

!***********************************************************************

!***********************************************************************
! WhoAmI - is process run as part of epay prep or standalone?
!***********************************************************************
begin-procedure JobCheck

let $RunsInEpayJob = 'N'
let #prcs_inst = To_number($prcs_process_instance)

BEGIN-SELECT
JOBINSTANCE  &INST
  let #inst = &INST
  if  #inst  > 0
        let $RunsInEpayJob='Y'
  end-if

FROM PSPRCSRQST WHERE JOBINSTANCE =
(SELECT JOBINSTANCE FROM PSPRCSRQST WHERE PRCSINSTANCE = #prcs_inst )
AND PRCSNAME = 'GPDE_TX1'
END-SELECT

#debug show 'result: '  $RunsInEpayJob
#debug show 'instance: '  #prcs_inst

end-procedure
!***********************************************************************************



!***********************************************************************************
! For SelfService Purposes: Online - the URL id for SelfService from GPDE_AL_VAL_PRS*
!***********************************************************************************

begin-procedure Get-SelfService-URLid (:$XFILEURLID)

!* get the URL id from the Payslip option table

BEGIN-SELECT
FM.URL_ID  &URLID

  let $XFILEURLID = rtrim(&URLID,' ')

FROM PS_GPDE_FM_FORM FM WHERE FM.GPDE_FM_FORM_ID = 'GPDETX01'
AND FM.EFFDT =
  (SELECT MAX(DEF.EFFDT) from PS_GPDE_FM_DEF DEF WHERE
DEF.GPDE_FM_FORM_ID = 'GPDETX01')
END-SELECT


  if  $XFILEURLID  > ' '
        let $_ePay_Installed = 'Y'
  else
      display ' '
      display 'Form-ID does not seem to be defined.  Pls check the setup. PDF Splitt will be skipped.'
  end-if

end-procedure !Get-SelfService-URLid


begin-procedure GetAddress($EMPLID, $ASOFDATE, :$ADDRESS1, :$ADDRESS2, :$NAME, :$ADDRESS3, :$NUM1, :$HOUSE_TYPE, :$POSTAL, :$CITY, :$STATE,
    :$COUNTY, :$COUNTRY, :$GEO_CODE, :$ADDR_FIELD1, :$ADDR_FIELD2, :$ADDR_FIELD3, :$IN_CITY_LIMIT)

let #found = 0

let $ADDRESS1 = ''
let $ADDRESS2 = ''
let $NAME = ''
let $ADDRESS3 = ''
let $NUM1 = ''
let $HOUSE_TYPE = ''
let $POSTAL = ''
let $CITY = ''
let $STATE = ''
let $COUNTY = ''
let $COUNTRY = ''
let $GEO_CODE = ''
let $ADDR_FIELD1 = ''
let $ADDR_FIELD2 = ''
let $ADDR_FIELD3  = ''
let $IN_CITY_LIMIT = ''


begin-select
ADDR.ADDRESS1                         !In case original is cropped
ADDR.ADDRESS2                         !In case original is cropped
ADDR.ADDRESS3
ADDR.NUM1
ADDR.HOUSE_TYPE
ADDR.POSTAL
ADDR.CITY
ADDR.STATE
ADDR.COUNTY
ADDR.COUNTRY
ADDR.GEO_CODE
ADDR.ADDR_FIELD1
ADDR.ADDR_FIELD2
ADDR.ADDR_FIELD3
ADDR.IN_CITY_LIMIT
ADDR.ADDRESS_TYPE

        let $ADDRESS1      =        &ADDR.ADDRESS1
        let $ADDRESS2      =        &ADDR.ADDRESS2
        ! let $NAME          =        &P.NAME
        let $ADDRESS3      =        &ADDR.ADDRESS3
        let $NUM1          =        &ADDR.NUM1
        let $HOUSE_TYPE    =        &ADDR.HOUSE_TYPE
        let $POSTAL        =        &ADDR.POSTAL
        let $CITY          =        &ADDR.CITY
        let $STATE         =        &ADDR.STATE
        let $COUNTY        =        &ADDR.COUNTY
        let $COUNTRY       =        &ADDR.COUNTRY
        let $GEO_CODE      =        &ADDR.GEO_CODE
        let $ADDR_FIELD1   =        &ADDR.ADDR_FIELD1
        let $ADDR_FIELD2   =        &ADDR.ADDR_FIELD2
        let $ADDR_FIELD3   =        &ADDR.ADDR_FIELD3
        let $IN_CITY_LIMIT =        &ADDR.IN_CITY_LIMIT
        let #found = 1
        let $ADDRESS_TYPE = &ADDR.ADDRESS_TYPE
from PS_ADDRESSES ADDR
where
ADDR.EMPLID = $EMPLID AND
ADDR.ADDRESS_TYPE in (select ADDRESS_TYPE from PS_GPDE_AL_INSTALL) AND
ADDR.EFFDT =(SELECT MAX(AD2.EFFDT)
                FROM PS_ADDRESSES AD2
                  WHERE AD2.EMPLID      = ADDR.EMPLID AND
                    AD2.ADDRESS_TYPE  = ADDR.ADDRESS_TYPE AND
                    AD2.EFFDT        < $ASOFDATE)
end-select

if #found = 0
begin-select
ADDR2.ADDRESS1                         !In case original is cropped
ADDR2.ADDRESS2                         !In case original is cropped
ADDR2.ADDRESS3
ADDR2.NUM1
ADDR2.HOUSE_TYPE
ADDR2.POSTAL
ADDR2.CITY
ADDR2.STATE
ADDR2.COUNTY
ADDR2.COUNTRY
ADDR2.GEO_CODE
ADDR2.ADDR_FIELD1
ADDR2.ADDR_FIELD2
ADDR2.ADDR_FIELD3
ADDR2.IN_CITY_LIMIT

        let $ADDRESS1      =        &ADDR2.ADDRESS1
        let $ADDRESS2      =        &ADDR2.ADDRESS2
        ! let $NAME          =        &P.NAME
        let $ADDRESS3      =        &ADDR2.ADDRESS3
        let $NUM1          =        &ADDR2.NUM1
        let $HOUSE_TYPE    =        &ADDR2.HOUSE_TYPE
        let $POSTAL        =        &ADDR2.POSTAL
        let $CITY          =        &ADDR2.CITY
        let $STATE         =        &ADDR2.STATE
        let $COUNTY        =        &ADDR2.COUNTY
        let $COUNTRY       =        &ADDR2.COUNTRY
        let $GEO_CODE      =        &ADDR2.GEO_CODE
        let $ADDR_FIELD1   =        &ADDR2.ADDR_FIELD1
        let $ADDR_FIELD2   =        &ADDR2.ADDR_FIELD2
        let $ADDR_FIELD3   =        &ADDR2.ADDR_FIELD3
        let $IN_CITY_LIMIT =        &ADDR2.IN_CITY_LIMIT

         let #found = 1
from PS_ADDRESSES ADDR2
where
ADDR2.EMPLID = $EMPLID AND
ADDR2.ADDRESS_TYPE = 'HOME' AND
ADDR2.EFFDT =(SELECT MAX(AD2.EFFDT)
                FROM PS_ADDRESSES AD2
                  WHERE AD2.EMPLID      = ADDR2.EMPLID AND
                    AD2.ADDRESS_TYPE  = ADDR2.ADDRESS_TYPE AND
                    AD2.EFFDT        <= $ASOFDATE)
end-select
end-if

if #found = 0
    show 'Address not found for ' $Emplid
end-if
end-procedure


!*******************************************************************
#include 'gpdeut06.sqc'  !get run control parameter values
#include 'datemath.sqc'  !get datemath-function
#include 'datetime.sqc'  !routines for date and time formatting
#include 'validdt.sqc'   !validate date routine
#include 'curdttim.sqc'  !get-current-datetime procedure
#include 'readxlat.sqc'  !read-translate-table procedure
#include 'number.sqc'    !routines to format numbers
#include 'stdapi.sqc'    !routines to update run status
!rh PDF splitt
#Include 'gpsspslp.sqc'  ! On-line PDF splitting stuff