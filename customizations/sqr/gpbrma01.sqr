!***********************************************************************
!  GPBRMA01: MANAD                                                     *
!***********************************************************************
!***********************************************************************
!                                                                      *
!                                                                      *
! This software and related documentation are provided under a         *
! license agreement containing restrictions on use and                 *
! disclosure and are protected by intellectual property                *
! laws. Except as expressly permitted in your license agreement        *
! or allowed by law, you may not use, copy, reproduce,                 *
! translate, broadcast, modify, license, transmit, distribute,         *
! exhibit, perform, publish or display any part, in any form or        *
! by any means. Reverse engineering, disassembly, or                   *
! decompilation of this software, unless required by law for           *
! interoperability, is prohibited.                                     *
! The information contained herein is subject to change without        *
! notice and is not warranted to be error-free. If you find any        *
! errors, please report them to us in writing.                         *
!                                                                      *
!                                                                      *
! Copyright (C) 1988, 2019, Oracle and/or its affiliates.              *
! All Rights Reserved.                                                 *
!***********************************************************************
!                                                                      *
!       $Release:  HR92                                                *
!           $Bug:  29476192                                            *
!                                                                      *
!***********************************************************************
#include 'setenv.sqc'   ! set enviroment

Begin-Setup
#include 'setupdb.sqc'

 Declare-variable
   Text $xFieldname 
 end-declare
end-Setup

!**************************************
begin-report
#debug show '* begin-report'
!**************************************     

  Do Init-Report
  Do Process-Main
  Do Delete-Temporal-Records
  Do Stdapi-Term
  Do Reset
  
end-report

!**************************************
begin-procedure Init-Report
#debug show '*Init-Report'
!**************************************

  move '2' to $ReportDateType   ! Set for date to format as DMY
  move '1' to $ReportYear4      ! Set for year to be formatted YYYY
  do Init-DateTime
  do Init-Number
  do Stdapi-Init
  do Get-Current-DateTime 
  move 'GPBRMA01'                      to $ReportID
  move 'MANAD'                         to $ReportTitle

  move 'Ver. 2017-22'                  to $ReportVersion
  
  move '.'                             To $ReportSThousand 
  move ','                             To $ReportSDecimal
  
  display $ReportID
  display $ReportTitle
  display $ReportVersion
  date-time () hh:mi:ss &timeBegan
  display 'Report Began: ' noline
  display $AsOfToday noline
  display ' ' noline
  display &timeBegan
  Do Get-Current-DateTime
end-procedure Init-Report

!**************************************
begin-procedure Process-Main
#debug show '* Process-Main'
#debug show '* $AsOfToday: ' $AsOfToday
!**************************************

  Do Select-Parameters
  
  if $RC_estabID <> ''
      #debug show '#prcs_process_instance: '  #prcs_process_instance 
     #debug show '$RC_DateFrom ' $RC_DateFrom
     #debug show '$RC_DateTo ' $RC_DateTo
     #debug show '$RC_Estabid ' $RC_Estabid
               
     Let $K_IND_MOV = '1'
     Let $K250Where = ''
     Let $BaseITWhere = ''

     Do Get-Manad-Parm

     if #CountParam = 0
        show ' ****** No Manad Setup exists for Establishment: ' $RC_estabID
     else
        Do LoadCentralTbl
        Do Isolate-Termin

        Do Prepare-Data
        Do Elements-Setup
        Do OtherElem-Setup
      
        Do Get-Taker-Data     
        Do Get-Payee-Parm
        Do Job-Codes-Lang
      
        Do Extract-Data-0000 
        Do Create-I000       
        Do Extract-Data-K000
        Do Adjust-Data-0000
        Do Write-0000
        Do Write-I000
        Do Write-K000
        Do Write-9000
     
        #ifdef UNIX
           let $command='sed -i ''s/$/\r/'' ' || $FileName
           show $command
           call system using $command #file_status
           show #file_status
        #endif

        close 1
        #ifdef UNIX
           do ConvertUnixToDOSWin($FileName)
        #endif
     end-if

  end-if

end-procedure Process-Main

!**************************************
begin-procedure Select-Parameters
#debug show '* Select-Parameters'
#debug show '$prcs_oprid:       ' $prcs_oprid
#debug show '$prcs_run_cntl_id: ' $prcs_run_cntl_id
!**************************************

begin-select
RC.ESTABID 
RC2.DATE_TO 
RC.GPBR_MAN_PURPOSE 
RC.GPBR_FILE_NAME 
RC.GPBR_MAN_FILE_TYPE
RC2.DATE_FROM
RC2.GP_RGST_POPUL_TYPE

   Let $RC_estabID = Rtrim(&RC.ESTABID, ' ')
   Let $RC_DateTo = &RC2.DATE_TO 
   Let $RC_DateFrom = &RC2.DATE_FROM 
   Let $IND_ED = &RC.GPBR_MAN_FILE_TYPE
   Let $COD_FIN = &RC.GPBR_MAN_PURPOSE
   Let $file = rtrim(&RC.GPBR_FILE_NAME, ' ')
   Let $RC_Popul_Type = &RC2.GP_RGST_POPUL_TYPE
   
   Do convert-to-dtu-date(&RC2.DATE_FROM, $DT_INI)
   Do convert-to-dtu-date(&RC2.DATE_TO, $DT_FIN)
   
   Do Format-MANAD-Date($DT_INI, $DT_INI)
   Do Format-MANAD-Date($DT_FIN, $DT_FIN)
      
   Do Open-File

FROM PS_GP_RGST_RC RC2
    ,PS_GPBR_RC_MANAD RC
WHERE RC.OPRID = RC2.OPRID 
AND   RC.RUN_CNTL_ID = RC2.RUN_CNTL_ID
AND   RC.OPRID  = $prcs_oprid
AND   RC.RUN_CNTL_ID = $prcs_run_cntl_id
end-select

Let $RCPayeeFrom = ' '
Let $RCPayeeWhereG = ' '
Let $RCPayeeWhereD = ' '

If $RC_Popul_Type = '40'

begin-sql
Insert into PS_GPBR_RCEMPL_TMP
(  PROCESS_INSTANCE
  ,OPRID
  ,RUN_CNTL_ID
  ,EMPLID
)
SELECT
  #prcs_process_instance
 ,$prcs_oprid
 ,$prcs_run_cntl_id
 ,EMPLID
FROM PS_GP_RGST_RC_EMPL
WHERE OPRID  = $prcs_oprid
AND   RUN_CNTL_ID = $prcs_run_cntl_id

end-sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RCEMPL_TMP COMPUTE STATISTICS
    end-sql

#endif

Let $RCPayeeFrom = ' , PS_GPBR_RCEMPL_TMP RCEMPL '

Let $RCPayeeWhereG = '  AND RCEMPL.PROCESS_INSTANCE = ' || '''' || to_char(#prcs_process_instance) || '''' || ' AND RCEMPL.OPRID = ' || '''' || $prcs_oprid || '''' 
Let $RCPayeeWhereG = $RCPayeeWhereG || ' AND RCEMPL.RUN_CNTL_ID = ' || '''' || $prcs_run_cntl_id || '''' || ' AND RCEMPL.EMPLID = RG.EMPLID '
Let $RCPayeeWhereD = '  AND RCEMPL.PROCESS_INSTANCE = ' || '''' || to_char(#prcs_process_instance) || '''' || ' AND RCEMPL.OPRID = ' || '''' || $prcs_oprid || ''''
Let $RCPayeeWhereD = $RCPayeeWhereD || ' AND RCEMPL.RUN_CNTL_ID = ' || '''' || $prcs_run_cntl_id || '''' || ' AND RCEMPL.EMPLID = RG0.EMPLID '

End-if

end-procedure Select-Parameters

!**************************************
Begin-Procedure Open-File
#debug show '** Open-File **'
!**************************************

if $File = ''
   Let $FileName = 'MANAD' || '.TXT'
else
   unstring $File  by '.' into $fname $ext
   if $ext = ''
      Let $ext = 'TXT'
   end-if
   Let $FileName = $fname ||  '.' || $ext
end-if
 Let $FileName =  '{FILEPREFIX}' || $FileName || '{FILESUFFIX}'
 

OPEN $FileName AS 1 FOR-WRITING RECORD=250:fixed STATUS=#FILESTAT

 show 'Nome do Arquivo: ' $FileName
 show ' '
End-Procedure Open-File

!**************************************
begin-procedure Format-MANAD-Date($in, :$out)
#debug show '* Format-MANAD-Date'
!**************************************

If (length($in) - 1) > 0  
   let $year = substr($in,1,4) 
   let $month = substr($in,6,2) 
   let $day = substr($in,9,2) 
   let $out = $day || $month || $year    
end-if 

end-procedure Format-MANAD-Date

!**************************************
begin-procedure Delete-Temporal-Records
#debug show '* Delete-Temporal-Records'
!**************************************

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GP_RGST_GDE_TMP WHERE PROCESS_INSTANCE = (#prcs_process_instance - 1) 
end-Sql
  
begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GP_RGST_DTL_TMP WHERE PROCESS_INSTANCE = (#prcs_process_instance - 1) 
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_RGST_GDE_T WHERE PROCESS_INSTANCE = (#prcs_process_instance)
end-Sql
  
begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_RGST_DTL_T WHERE PROCESS_INSTANCE = (#prcs_process_instance)
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_MANAD_TMP1 WHERE PROCESS_INSTANCE = #prcs_process_instance
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_MANAD_TMP2 WHERE PROCESS_INSTANCE = #prcs_process_instance 
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_MANAD_TMP3 WHERE PROCESS_INSTANCE = #prcs_process_instance 
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_MANAD_TMP4 WHERE PROCESS_INSTANCE = #prcs_process_instance 
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_MANAD_TMP5 WHERE PROCESS_INSTANCE = #prcs_process_instance 
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_MANAD_TMP6 WHERE PROCESS_INSTANCE = #prcs_process_instance 
end-Sql

begin-Sql ON-ERROR=SQL-Error
  DELETE FROM PS_GPBR_MANAD_TMP7 WHERE PROCESS_INSTANCE = #prcs_process_instance 
end-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_CENT_ESTAB WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_ACM_INSS_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_ACM_IT_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_DEPEN_TMP WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_JOBCODE_TM WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_JOBDAT_TMP WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_K300_INS_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_K300_IT_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_MAN_PARM_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_MANAD_DELT WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_PAYEE_PA_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_RSLT_DTL_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_RSLT_INS_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_RSLT_IT_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_SER_TAK_TM WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_MN_GLMAP_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_MN_K200_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_GLMAP300_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_MN_K300_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_RCEMPL_TMP WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_MND_ELEM_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

Begin-Sql ON-ERROR=SQL-Error
 DELETE FROM PS_GPBR_MND_OTH_T WHERE PROCESS_INSTANCE = #prcs_process_instance 
End-Sql

end-procedure Delete-Temporal-Records

!**************************************
begin-procedure Prepare-Data
#debug show '* Prepare-Data'
!**************************************

!*** Insert Temporary Guide Table
Begin-Sql
INSERT INTO PS_GPBR_RGST_GDE_T
(PROCESS_INSTANCE  
,EMPLID           
,CAL_RUN_ID       
,EMPL_RCD         
,GP_PAYGROUP      
,CAL_ID           
,ORIG_CAL_RUN_ID  
,RSLT_SEG_NUM     
,GP_RPT_KEY       
,SEQ_NUM          
,BUSINESS_UNIT    
,CAL_PRD_ID       
,COMPANY          
,COUNTRY          
,CALC_ACTION      
,CALC_TYPE        
,CUR_RT_TYPE      
,CURRENCY_CD      
,DEPTID           
,ESTABID          
,LOCATION         
,NAME             
,PAY_ENTITY       
,PRD_BGN_DT       
,PRD_END_DT       
,PIN_GROSS_VAL    
,PIN_NET_VAL      
,PYE_CALC_STAT    
,PYE_PRC_IND      
,PYMT_DT          
,PYMT_KEY1        
,PYMT_KEY2        
,PYMT_KEY3        
,PYMT_KEY4        
,RSLT_REV_NUM     
,RSLT_VER_NUM     
,RUN_TYPE         
,SEG_BGN_DT       
,SEG_END_DT       
,SEG_STATUS       
,SEL_ACTION       
,SEL_STAT         
,SETID_DEPT       
,SETID_LOCATION)
select Distinct
 #prcs_process_instance
,RG.EMPLID
,RG.CAL_RUN_ID 
,RG.EMPL_RCD
,RG.GP_PAYGROUP 
,RG.CAL_ID 
,RG.ORIG_CAL_RUN_ID 
,RG.RSLT_SEG_NUM 
,RG.GP_RPT_KEY 
,RG.SEQ_NUM 
,RG.BUSINESS_UNIT  
,RG.CAL_PRD_ID      
,RG.COMPANY        
,RG.COUNTRY          
,RG.CALC_ACTION     
,RG.CALC_TYPE        
,RG.CUR_RT_TYPE      
,RG.CURRENCY_CD      
,JOB.DEPTID          
,RG.ESTABID          
,RG.LOCATION         
,RG.NAME             
,RG.PAY_ENTITY       
,RG.PRD_BGN_DT       
,RG.PRD_END_DT       
,RG.PIN_GROSS_VAL    
,RG.PIN_NET_VAL      
,RG.PYE_CALC_STAT    
,RG.PYE_PRC_IND      
,RG.PYMT_DT          
,RG.PYMT_KEY1        
,RG.PYMT_KEY2        
,RG.PYMT_KEY3        
,RG.PYMT_KEY4        
,RG.RSLT_REV_NUM     
,RG.RSLT_VER_NUM     
,RG.RUN_TYPE         
,RG.SEG_BGN_DT       
,RG.SEG_END_DT       
,RG.SEG_STATUS       
,RG.SEL_ACTION       
,RG.SEL_STAT         
,JOB.SETID_DEPT    
,JOB.SETID_LOCATION  
FROM PS_JOB JOB 
   , PS_GP_RGST_GDE_TMP RG
   , PS_GP_CAL_RUN G
   [$RCPayeeFrom]
WHERE JOB.EMPLID = RG.EMPLID 
AND   JOB.EMPL_RCD = RG.EMPL_RCD 
and   JOB.GP_PAYGROUP = RG.GP_PAYGROUP 
and   JOB.EFFDT =
       (select  MAX(J1.EFFDT) 
            FROM PS_JOB J1 
           WHERE J1.EMPLID   = JOB.EMPLID 
             AND J1.EMPL_RCD = JOB.EMPL_RCD 
             AND J1.EFFDT   <= RG.SEG_END_DT) 
and   JOB.EFFSEQ = (select MAX(J2.EFFSEQ) 
            FROM PS_JOB J2 
           WHERE J2.EMPLID   = JOB.EMPLID 
             AND J2.EMPL_RCD = JOB.EMPL_RCD 
             AND J2.EFFDT    = JOB.EFFDT)
AND RG.PROCESS_INSTANCE = (#prcs_process_instance - 1)
AND RG.PRD_BGN_DT >= $RC_DateFrom
AND RG.PRD_END_DT <= $RC_DateTo
AND G.CAL_RUN_ID = RG.CAL_RUN_ID
AND G.RUN_FINALIZED_IND = 'Y'
AND G.GL_SENT_IND = 'Y' 
[$RCPayeeWhereG]
end-sql

!*** Insert Temporary Detail Table
Begin-Sql
INSERT INTO PS_GPBR_RGST_DTL_T
(PROCESS_INSTANCE                                                                                                                                                                        
,EMPLID                                                                                                                                                                                  
,CAL_RUN_ID                                                                                                                                                                              
,EMPL_RCD                                                                                                                                                                                
,GP_PAYGROUP                                                                                                                                                                             
,CAL_ID                                                                                                                                                                                  
,ORIG_CAL_RUN_ID                                                                                                                                                                         
,RSLT_SEG_NUM                                                                                                                                                                            
,GP_RPT_KEY                                                                                                                                                                              
,SEQ_NUM                                                                                                                                                                                 
,GP_RGST_SECT_TYPE                                                                                                                                                                       
,PIN_NUM                                                                                                                                                                                 
,INSTANCE                                                                                                                                                                                
,ACM_FROM_DT                                                                                                                                                                             
,ACM_THRU_DT                                                                                                                                                                             
,ACM_PRD_OPTN                                                                                                                                                                            
,BASE_ADJ_VAL                                                                                                                                                                            
,BASE_RSLT_VAL                                                                                                                                                                           
,CALC_ADJ_VAL                                                                                                                                                                            
,CALC_RSLT_VAL                                                                                                                                                                           
,GP_RPT_RETRO                                                                                                                                                                            
,PCT_RSLT_VAL                                                                                                                                                                            
,PIN_NM                                                                                                                                                                                  
,PIN_TYPE                                                                                                                                                                                
,RATE_RSLT_VAL                                                                                                                                                                           
,RSLT_ADD_ARR                                                                                                                                                                            
,RSLT_NOT_TKN                                                                                                                                                                            
,RSLT_XFER_VAL                                                                                                                                                                           
,RSLT_PAYBK                                                                                                                                                                              
,SLICE_BGN_DT                                                                                                                                                                            
,SLICE_END_DT                                                                                                                                                                            
,UNIT_RSLT_VAL                                                                                                                                                                           
,UNIT_ADJ_VAL                                                                                                                                                                            
,USER_ADJ_VAL                                                                                                                                                                            
,USER_KEY1                                                                                                                                                                               
,USER_KEY2                                                                                                                                                                               
,USER_KEY3                                                                                                                                                                               
,USER_KEY4                                                                                                                                                                               
,USER_KEY5                                                                                                                                                                               
,USER_KEY6                                                                                                                                                                               
,PAY_ENTITY                                                                                                                                                                              
,COMPANY                                                                                                                                                                                 
,DEPTID                                                                                                                                                                                  
,ESTABID                                                                                                                                                                                 
,LOCATION                                                                                                                                                                                
,CURRENCY_CD                                                                                                                                                                             
,RUN_TYPE)
SELECT distinct
 #prcs_process_instance                                                                                                                                                                       
,RG0.EMPLID                                                                                                                                                                                  
,RG0.CAL_RUN_ID                                                                                                                                                                              
,RG0.EMPL_RCD                                                                                                                                                                                
,RG0.GP_PAYGROUP                                                                                                                                                                             
,RG0.CAL_ID                                                                                                                                                                                  
,RG0.ORIG_CAL_RUN_ID                                                                                                                                                                         
,RG0.RSLT_SEG_NUM                                                                                                                                                                            
,RG0.GP_RPT_KEY                                                                                                                                                                              
,RG0.SEQ_NUM                                                                                                                                                                                 
,RG0.GP_RGST_SECT_TYPE                                                                                                                                                                       
,RG0.PIN_NUM                                                                                                                                                                                 
,RG0.INSTANCE                                                                                                                                                                                
,RG0.ACM_FROM_DT                                                                                                                                                                             
,RG0.ACM_THRU_DT                                                                                                                                                                             
,RG0.ACM_PRD_OPTN                                                                                                                                                                            
,RG0.BASE_ADJ_VAL                                                                                                                                                                            
,RG0.BASE_RSLT_VAL                                                                                                                                                                           
,RG0.CALC_ADJ_VAL                                                                                                                                                                            
,RG0.CALC_RSLT_VAL                                                                                                                                                                           
,RG0.GP_RPT_RETRO                                                                                                                                                                            
,RG0.PCT_RSLT_VAL                                                                                                                                                                            
,RG0.PIN_NM                                                                                                                                                                                  
,RG0.PIN_TYPE                                                                                                                                                                                
,RG0.RATE_RSLT_VAL                                                                                                                                                                           
,RG0.RSLT_ADD_ARR                                                                                                                                                                            
,RG0.RSLT_NOT_TKN                                                                                                                                                                            
,RG0.RSLT_XFER_VAL                                                                                                                                                                           
,RG0.RSLT_PAYBK                                                                                                                                                                              
,RG0.SLICE_BGN_DT                                                                                                                                                                            
,RG0.SLICE_END_DT                                                                                                                                                                            
,RG0.UNIT_RSLT_VAL                                                                                                                                                                           
,RG0.UNIT_ADJ_VAL                                                                                                                                                                            
,RG0.USER_ADJ_VAL                                                                                                                                                                            
,RG0.USER_KEY1                                                                                                                                                                               
,RG0.USER_KEY2                                                                                                                                                                               
,RG0.USER_KEY3                                                                                                                                                                               
,RG0.USER_KEY4                                                                                                                                                                               
,RG0.USER_KEY5                                                                                                                                                                               
,RG0.USER_KEY6                                                                                                                                                                               
,RG0.PAY_ENTITY                                                                                                                                                                              
,RG0.COMPANY                                                                                                                                                                                 
,J0B.DEPTID                                                                                                                                                                                  
,J0B.ESTABID                                                                                                                                                                                 
,RG0.LOCATION                                                                                                                                                                                
,RG0.CURRENCY_CD                                                                                                                                                                             
,RG0.RUN_TYPE                                                                                                                                                                                

FROM PS_JOB J0B 
   , PS_GP_RGST_DTL_TMP RG0
   , PS_GP_CAL_RUN G
   [$RCPayeeFrom]

WHERE J0B.EMPLID = RG0.EMPLID 
AND   J0B.EMPL_RCD = RG0.EMPL_RCD 
AND   J0B.GP_PAYGROUP = RG0.GP_PAYGROUP 
AND   J0B.EFFDT =(SELECT MAX(J1.EFFDT) 
                  FROM PS_JOB J1 
                  WHERE J1.EMPLID = J0B.EMPLID 
                  and J1.EMPL_RCD = J0B.EMPL_RCD
                  and J1.EFFDT <= RG0.SLICE_END_DT) 
and J0B.EFFSEQ = (select MAX(J2.EFFSEQ) 
                  from PS_JOB J2 
                  where J2.EMPLID = J0B.EMPLID 
                  and J2.EMPL_RCD = J0B.EMPL_RCD 
                  and J2.EFFDT = J0B.EFFDT)
AND RG0.PROCESS_INSTANCE = (#prcs_process_instance - 1)
AND RG0.SLICE_BGN_DT >= $RC_DateFrom
AND RG0.SLICE_END_DT <= $RC_DateTo
AND G.CAL_RUN_ID = RG0.CAL_RUN_ID
AND G.RUN_FINALIZED_IND = 'Y'
AND G.GL_SENT_IND = 'Y' 
[$RCPayeeWhereD]
end-sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RGST_GDE_T COMPUTE STATISTICS
    end-sql
    begin-sql
        ANALYZE table PS_GPBR_RGST_DTL_T COMPUTE STATISTICS
     end-sql
#endif

begin-select
COUNT(*) &countins
 
  If &countins = 0
    show 'Sem dados da Folha de Pagamento'
  End-If
 
FROM PS_GPBR_RGST_GDE_T 
WHERE PROCESS_INSTANCE = #prcs_process_instance

end-select

end-procedure Prepare-Data

!**************************************
begin-procedure Elements-Setup
#debug show '* Elements-Setup'
!**************************************

! Insert IT Elements - Non Acummulators
Begin-Sql
INSERT INTO PS_GPBR_MND_ELEM_T
(PROCESS_INSTANCE 
,ESTABID
,GPBR_PIN_MAN_NUM
,ENTRY_TYPE_ELEM
,GPBR_ELEM_MBR
,BGN_DT
,END_DT
)
SELECT DISTINCT
 #prcs_process_instance
,MIT.ESTABID
,MIT.GPBR_PIN_MAN_NUM
,GPIN.PIN_TYPE
,' '
,NULL
,NULL
FROM PS_GPBR_MANAD_IT MIT
    ,PS_GP_PIN GPIN
WHERE MIT.ESTABID = $RC_Estabid
  AND MIT.EFFDT =  (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = MIT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A' ) 
  AND GPIN.PIN_NUM = MIT.GPBR_PIN_MAN_NUM
  AND GPIN.PIN_TYPE <> 'AC'
end-sql

! Insert IT Elements - Acummulators
Begin-Sql
INSERT INTO PS_GPBR_MND_ELEM_T
(PROCESS_INSTANCE 
,ESTABID
,GPBR_PIN_MAN_NUM
,ENTRY_TYPE_ELEM
,GPBR_ELEM_MBR
,BGN_DT
,END_DT
)
SELECT DISTINCT
 #prcs_process_instance
,MIT.ESTABID
,M.PIN_MBR_NUM
,GPIN.PIN_TYPE
,'M'
,M.BGN_DT
,M.END_DT
FROM PS_GPBR_MANAD_IT MIT
    ,PS_GP_PIN GPIN
    ,PS_GP_ACM_MBR M 
WHERE MIT.ESTABID = $RC_Estabid
  AND MIT.EFFDT =  (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = MIT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A' ) 
  AND M.PIN_NUM = MIT.GPBR_PIN_MAN_NUM
  AND GPIN.PIN_NUM = M.PIN_MBR_NUM
  AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_MND_ELEM_T II 
                   WHERE II.PROCESS_INSTANCE = #prcs_process_instance
                     AND II.ESTABID = MIT.ESTABID
                     AND II.GPBR_PIN_MAN_NUM = M.PIN_MBR_NUM
                     AND II.ENTRY_TYPE_ELEM = GPIN.PIN_TYPE )
end-sql

! Insert INSS Elements - Non Acummulators
Begin-Sql
INSERT INTO PS_GPBR_MND_ELEM_T
(PROCESS_INSTANCE 
,ESTABID
,GPBR_PIN_MAN_NUM
,ENTRY_TYPE_ELEM
,GPBR_ELEM_MBR
,BGN_DT
,END_DT
)
SELECT DISTINCT 
 #prcs_process_instance
,MIT.ESTABID
,MIT.GPBR_PIN_MAN_NUM
,GPIN.PIN_TYPE
,' '
,NULL
,NULL
FROM PS_GPBR_MANAD_INSS MIT
    ,PS_GP_PIN GPIN
WHERE MIT.ESTABID = $RC_Estabid
  AND MIT.EFFDT =  (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                      WHERE IT2.ESTABID = MIT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A' ) 
  AND GPIN.PIN_NUM = MIT.GPBR_PIN_MAN_NUM
  AND GPIN.PIN_TYPE <> 'AC'
  AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_MND_ELEM_T II 
                   WHERE II.PROCESS_INSTANCE = #prcs_process_instance
                     AND II.ESTABID = MIT.ESTABID
                     AND II.GPBR_PIN_MAN_NUM = MIT.GPBR_PIN_MAN_NUM
                     AND II.ENTRY_TYPE_ELEM = GPIN.PIN_TYPE )  
end-sql

! Insert INSS Elements - Acummulators
Begin-Sql
INSERT INTO PS_GPBR_MND_ELEM_T
(PROCESS_INSTANCE 
,ESTABID
,GPBR_PIN_MAN_NUM
,ENTRY_TYPE_ELEM
,GPBR_ELEM_MBR
,BGN_DT
,END_DT
)
SELECT DISTINCT
 #prcs_process_instance
,MIT.ESTABID
,M.PIN_MBR_NUM
,GPIN.PIN_TYPE
,'M'
,M.BGN_DT
,M.END_DT
FROM PS_GPBR_MANAD_INSS MIT
    ,PS_GP_PIN GPIN
    ,PS_GP_ACM_MBR M 
WHERE MIT.ESTABID = $RC_Estabid
  AND MIT.EFFDT =  (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                      WHERE IT2.ESTABID = MIT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A' ) 
    AND M.PIN_NUM = MIT.GPBR_PIN_MAN_NUM
    AND GPIN.PIN_NUM = M.PIN_MBR_NUM
    AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_MND_ELEM_T II 
                   WHERE II.PROCESS_INSTANCE = #prcs_process_instance
                     AND II.ESTABID = MIT.ESTABID
                     AND II.GPBR_PIN_MAN_NUM = M.PIN_MBR_NUM
                     AND II.ENTRY_TYPE_ELEM = GPIN.PIN_TYPE )
end-sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MND_ELEM_T COMPUTE STATISTICS
    end-sql
#endif

end-procedure Elements-Setup

!**************************************
begin-procedure OtherElem-Setup
#debug show '* OtherElem-Setup'
!**************************************

Begin-Sql
INSERT INTO PS_GPBR_MND_OTH_T
(PROCESS_INSTANCE
,ESTABID
,GPBR_PIN_MAN_NUM
,ENTRY_TYPE_ELEM
,BGN_DT
,END_DT
,GPBR_ELEM_MBR
)
SELECT 
 #prcs_process_instance
,OOTH.ESTABID
,OOTH.GPBR_PIN_MAN_NUM
,OOTH.ENTRY_TYPE_ELEM
,NULL
,NULL
,' '
FROM PS_GPBR_MANAD_OTH OOTH
WHERE OOTH.ESTABID = $RC_EstabID
  AND OOTH.EFFDT = (SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = OOTH.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A')
  AND OOTH.ENTRY_TYPE_ELEM <> 'AC0'                             
End-Sql


Begin-Sql
INSERT INTO PS_GPBR_MND_OTH_T
(PROCESS_INSTANCE
,ESTABID
,GPBR_PIN_MAN_NUM
,ENTRY_TYPE_ELEM
,BGN_DT
,END_DT
,GPBR_ELEM_MBR
)
SELECT 
 #prcs_process_instance
,OOTH.ESTABID
,MBR.PIN_MBR_NUM
,OOTH.ENTRY_TYPE_ELEM
,MBR.BGN_DT
,MBR.END_DT
,'M'
FROM PS_GPBR_MANAD_OTH OOTH
    ,PS_GP_ACM_MBR MBR
WHERE OOTH.ESTABID = $RC_EstabID
  AND OOTH.EFFDT = (SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = OOTH.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A')
  AND OOTH.ENTRY_TYPE_ELEM = 'AC0'   
  AND MBR.PIN_NUM = OOTH.GPBR_PIN_MAN_NUM
  AND NOT EXISTS (SELECT 'X' FROM PS_GPBR_MND_OTH_T INNOT
                    WHERE INNOT.PROCESS_INSTANCE = #prcs_process_instance 
                      AND INNOT.ESTABID = OOTH.ESTABID
                      AND INNOT.GPBR_PIN_MAN_NUM = MBR.PIN_MBR_NUM 
                      AND INNOT.BGN_DT = MBR.BGN_DT)
End-Sql

end-procedure OtherElem-Setup

!**************************************
begin-procedure Bld-K300-Map
#debug show '* Bld-K300-Map'
!**************************************

Begin-Sql
INSERT INTO PS_GPBR_GLMAP300_T
(
PROCESS_INSTANCE  
,GPBR_MAN_ROW_TYPE 
,GP_RPT_KEY        
,ESTABID           
,EMPLID            
,EMPL_RCD          
,PIN_NUM           
,PIN_CHART1_VAL    
,PIN_CHART2_VAL    
,PIN_CHART3_VAL    
,PIN_CHART4_VAL    
,PIN_CHART5_VAL    
,PIN_CHART6_VAL    
,PIN_CHART7_VAL    
,PIN_CHART8_VAL    
,PIN_CHART9_VAL    
,PIN_CHART10_VAL    
,PIN_CHART11_VAL    
,PIN_CHART12_VAL    
,PIN_CHART13_VAL    
,PIN_CHART14_VAL    
,PIN_CHART15_VAL    
,PIN_CHART16_VAL    
,PIN_CHART17_VAL    
,PIN_CHART18_VAL    
,PIN_CHART19_VAL    
,PIN_CHART20_VAL    
,PIN_CHART21_VAL    
,ACCOUNT  
,RUN_TYPE
,EFFDT             
,PAY_ENTITY        
,BUSINESS_UNIT     
,SETID_DEPT        
,DEPTID            
,GPBR_SERVICE_TAKER
,ESTAB_ID_BRA      
,GPBR_TAKER_INSCR
,GPBR_REVERSE_SIGN
,SLICE_BGN_DT
,SLICE_END_DT
,PYMNT_DT
)

SELECT DISTINCT #prcs_process_instance
  , 'K300'
  , TD.GP_RPT_KEY
  , TD.ESTABID 
  , TD.EMPLID 
  , TD.EMPL_RCD 
  , TD.PIN_NUM
  , GL2.PIN_CHART1_VAL 
  , GL2.PIN_CHART2_VAL 
  , GL2.PIN_CHART3_VAL 
  , GL2.PIN_CHART4_VAL 
  , GL2.PIN_CHART5_VAL 
  , GL2.PIN_CHART6_VAL 
  , GL2.PIN_CHART7_VAL 
  , GL2.PIN_CHART8_VAL 
  , GL2.PIN_CHART9_VAL    
  , GL2.PIN_CHART10_VAL    
  , GL2.PIN_CHART11_VAL    
  , GL2.PIN_CHART12_VAL    
  , GL2.PIN_CHART13_VAL    
  , GL2.PIN_CHART14_VAL    
  , GL2.PIN_CHART15_VAL    
  , GL2.PIN_CHART16_VAL    
  , GL2.PIN_CHART17_VAL    
  , GL2.PIN_CHART18_VAL    
  , GL2.PIN_CHART19_VAL    
  , GL2.PIN_CHART20_VAL    
  , GL2.PIN_CHART21_VAL    
    , GL2.ACCOUNT
  , TD.RUN_TYPE
  , TG.PRD_END_DT
  , TD.PAY_ENTITY
  , TG.BUSINESS_UNIT
  , TG.SETID_DEPT
  , TD.DEPTID 
  , ' '
  , TMP1.ESTAB_ID_BRA  
  , ' '
  ,(CASE WHEN GL2.REVERSE_SIGN = 'Y' THEN -1 ELSE 1 END )
  ,TD.SLICE_BGN_DT
  ,TD.SLICE_END_DT
  ,TG.PYMT_DT
FROM PS_GPBR_RGST_DTL_T TD 
    ,PS_GPBR_RGST_GDE_T TG 
    ,PS_GPBR_MANAD_TMP1 TMP1
    ,PS_GP_GL_GROUP_DTL GL
    ,PS_GP_GL_MAP_DTL GL2
     
WHERE TD.PROCESS_INSTANCE = #prcs_process_instance
  AND TG.PROCESS_INSTANCE = #prcs_process_instance
  AND TD.EMPLID = TG.EMPLID 
  AND TD.EMPL_RCD = TG.EMPL_RCD 
  AND TD.CAL_RUN_ID = TG.CAL_RUN_ID 
  AND TD.GP_PAYGROUP = TG.GP_PAYGROUP 
  AND TD.CAL_ID = TG.CAL_ID 
  AND TD.ORIG_CAL_RUN_ID = TG.ORIG_CAL_RUN_ID 
  AND TD.RSLT_SEG_NUM = TG.RSLT_SEG_NUM 
  AND TD.GP_RPT_KEY = TG.GP_RPT_KEY 
  AND TMP1.PROCESS_INSTANCE = #prcs_process_instance
  AND TMP1.GPBR_MAN_ROW_TYPE = '0000'
  AND TMP1.ESTABID = TD.ESTABID
  AND GL.PAY_ENTITY = TD.PAY_ENTITY 
  AND GL.BUSINESS_UNIT = TG.BUSINESS_UNIT
  AND GL.PIN_NUM = TD.PIN_NUM
  AND GL2.PAY_ENTITY = GL.PAY_ENTITY 
  AND GL2.BUSINESS_UNIT = GL.BUSINESS_UNIT
  AND GL2.EFFDT = (SELECT MAX(G.EFFDT) 
                     FROM PS_GP_GL_MAP_DTL G 
                    WHERE G.PAY_ENTITY = GL2.PAY_ENTITY 
                      AND G.BUSINESS_UNIT = GL2.BUSINESS_UNIT 
                      AND G.EFFDT <= $RC_DateTo)
  AND GL2.GROUPING_CODE = GL.GROUPING_CODE 
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_GLMAP300_T COMPUTE STATISTICS
    end-sql

#endif

end-procedure Bld-K300-Map

!**************************************
begin-procedure Bld-K300-Filter
#debug show '* Bld-K300-Filter'
!**************************************

Let $WhrNotEx = ' '

Begin-Select
GP_CHFLD_IND   &GP_CHFLD_IND300

   Let $gpchlfldMAX = rtrim(&GP_CHFLD_IND300, ' ')
   Let #gpchlfldMAX = to_number($gpchlfldMAX)
   Let #gpchlfldCURR = #gpchlfldMAX
   
FROM PS_GPBR_MAN_PARM_T
WHERE PROCESS_INSTANCE = #prcs_process_instance
  AND ESTABID = $RC_estabID
End-Select

while #gpchlfldCURR >= 0

      If #gpchlfldMAX > #gpchlfldCURR
      
         Let $WhrNotEx = ' AND NOT EXISTS (SELECT ''X'' FROM PS_GPBR_MN_K300_T XX WHERE XX.PROCESS_INSTANCE = ' || to_char(#prcs_process_instance)
         Let $WhrNotEx = $WhrNotEx || ' AND XX.GPBR_MAN_ROW_TYPE = ''K300'' '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.GP_RPT_KEY = GLMAP.GP_RPT_KEY '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.ESTABID = GLMAP.ESTABID '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.EMPLID = GLMAP.EMPLID '    
         Let $WhrNotEx = $WhrNotEx || ' AND XX.EMPL_RCD = GLMAP.EMPL_RCD '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_NUM = GLMAP.PIN_NUM '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART1_VAL = GLD.PIN_CHART1_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART2_VAL = GLD.PIN_CHART2_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART3_VAL = GLD.PIN_CHART3_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART4_VAL = GLD.PIN_CHART4_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART5_VAL = GLD.PIN_CHART5_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART6_VAL = GLD.PIN_CHART6_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART7_VAL = GLD.PIN_CHART7_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART8_VAL = GLD.PIN_CHART8_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART9_VAL = GLD.PIN_CHART9_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART10_VAL = GLD.PIN_CHART10_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART11_VAL = GLD.PIN_CHART11_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART12_VAL = GLD.PIN_CHART12_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART13_VAL = GLD.PIN_CHART13_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART14_VAL = GLD.PIN_CHART14_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART15_VAL = GLD.PIN_CHART15_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART16_VAL = GLD.PIN_CHART16_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART17_VAL = GLD.PIN_CHART17_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART18_VAL = GLD.PIN_CHART18_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART19_VAL = GLD.PIN_CHART19_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART20_VAL = GLD.PIN_CHART20_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART21_VAL = GLD.PIN_CHART21_VAL )'

      End-If

      Let #chlfldCONT = 1
      Let $FromVAL = ' '
      Let $WhrCrit = ' ' 
      
      while #chlfldCONT <= 21
  
         If #chlfldCONT <= #gpchlfldCURR
         
            If #gpchlfldCURR > 0
            
               Let $chlfldCONT = edit(#chlfldCONT,'9') 
                  
               Let $FromVAL = $FromVAL || ' , GLD.PIN_CHART' || $chlfldCONT || '_VAL'
               Let $WhrCrit = $WhrCrit || ' AND GLMAP.PIN_CHART' || $chlfldCONT || '_VAL = GLD.PIN_CHART' || $chlfldCONT || '_VAL'

            Else
            
               Let $FromVAL = $FromVAL || ' , '' '' '

            End-If 
            
         Else
              
            Let $FromVAL = $FromVAL || ' , '' '' '

         End-If
            
         Let #chlfldCONT = #chlfldCONT + 1
                     
      end-while
      
#ifdef MICROSOFT ! Microsoft Block
 begin-sql
 insert into PS_GPBR_MN_K300_T
 (PROCESS_INSTANCE  
 ,GPBR_MAN_ROW_TYPE 
 ,GP_RPT_KEY        
 ,ESTABID           
 ,EMPLID            
 ,EMPL_RCD          
 ,PIN_NUM           
 ,PIN_CHART1_VAL    
 ,PIN_CHART2_VAL    
 ,PIN_CHART3_VAL    
 ,PIN_CHART4_VAL    
 ,PIN_CHART5_VAL    
 ,PIN_CHART6_VAL    
 ,PIN_CHART7_VAL    
 ,PIN_CHART8_VAL    
 ,PIN_CHART9_VAL    
 ,PIN_CHART10_VAL    
 ,PIN_CHART11_VAL    
 ,PIN_CHART12_VAL    
 ,PIN_CHART13_VAL    
 ,PIN_CHART14_VAL    
 ,PIN_CHART15_VAL
 ,PIN_CHART16_VAL    
 ,PIN_CHART17_VAL    
 ,PIN_CHART18_VAL    
 ,PIN_CHART19_VAL    
 ,PIN_CHART20_VAL    
 ,PIN_CHART21_VAL    
 ,ACCOUNT      
 ,RUN_TYPE
 ,GPBR_REVERSE_SIGN
 ,CALC_RSLT_VAL
 ,EFFDT             
 ,PAY_ENTITY        
 ,BUSINESS_UNIT     
 ,SETID_DEPT        
 ,DEPTID            
 ,GPBR_SERVICE_TAKER     
 ,GPBR_TAKER_INSCR
 ,SLICE_BGN_DT
 ,SLICE_END_DT
 ,PYMNT_DT)
   
 SELECT DISTINCT 
    #prcs_process_instance
    , GLMAP.GPBR_MAN_ROW_TYPE
    , GLMAP.GP_RPT_KEY
    , GLMAP.ESTABID
    , GLMAP.EMPLID
    , GLMAP.EMPL_RCD
    , GLMAP.PIN_NUM
    [$FromVAL]
    , ' '
    , GLMAP.RUN_TYPE
    , GLMAP.GPBR_REVERSE_SIGN
    , GLD.CALC_RSLT_VAL
    , GLMAP.EFFDT  
    , GLD.PAY_ENTITY
    , GLD.BUSINESS_UNIT
    , GLMAP.SETID_DEPT 
    , GLMAP.DEPTID     
    , GLMAP.GPBR_SERVICE_TAKER
    , GLMAP.GPBR_TAKER_INSCR
    , GLMAP.SLICE_BGN_DT
    , GLMAP.SLICE_END_DT
    , GLMAP.PYMNT_DT
 FROM PS_GP_GL_DATA GLD 
       , PS_GPBR_GLMAP300_T GLMAP
       , PS_GPBR_MANAD_TMP3 TMP3
 WHERE GLMAP.PROCESS_INSTANCE = #prcs_process_instance
     AND GLD.EMPLID   = GLMAP.EMPLID
     AND GLD.EMPL_RCD = GLMAP.EMPL_RCD     
     AND GLD.PIN_NUM  = GLMAP.PIN_NUM
     AND TMP3.PROCESS_INSTANCE = #prcs_process_instance
     AND TMP3.GPBR_MAN_ROW_TYPE = GLMAP.GPBR_MAN_ROW_TYPE
     AND TMP3.GP_RPT_KEY = GLMAP.GP_RPT_KEY
     AND TMP3.CAL_RUN_ID = GLD.CAL_RUN_ID
     AND GLD.CAL_ID = RTRIM(SUBSTRING(GLMAP.GP_RPT_KEY,5,18))
     [$WhrCrit]
     [$WhrNotEx] 
 end-sql
#endif

#ifndef MICROSOFT ! non Microsoft Block
 begin-sql
 insert into PS_GPBR_MN_K300_T
 (PROCESS_INSTANCE  
 ,GPBR_MAN_ROW_TYPE 
 ,GP_RPT_KEY        
 ,ESTABID           
 ,EMPLID            
 ,EMPL_RCD          
 ,PIN_NUM           
 ,PIN_CHART1_VAL    
 ,PIN_CHART2_VAL    
 ,PIN_CHART3_VAL    
 ,PIN_CHART4_VAL    
 ,PIN_CHART5_VAL    
 ,PIN_CHART6_VAL    
 ,PIN_CHART7_VAL    
 ,PIN_CHART8_VAL       
 ,PIN_CHART9_VAL    
 ,PIN_CHART10_VAL    
 ,PIN_CHART11_VAL    
 ,PIN_CHART12_VAL    
 ,PIN_CHART13_VAL    
 ,PIN_CHART14_VAL    
 ,PIN_CHART15_VAL
 ,PIN_CHART16_VAL    
 ,PIN_CHART17_VAL    
 ,PIN_CHART18_VAL    
 ,PIN_CHART19_VAL    
 ,PIN_CHART20_VAL    
 ,PIN_CHART21_VAL    
 ,ACCOUNT      
 ,RUN_TYPE
 ,GPBR_REVERSE_SIGN
 ,CALC_RSLT_VAL
 ,EFFDT             
 ,PAY_ENTITY        
 ,BUSINESS_UNIT     
 ,SETID_DEPT        
 ,DEPTID            
 ,GPBR_SERVICE_TAKER     
 ,GPBR_TAKER_INSCR
 ,SLICE_BGN_DT
 ,SLICE_END_DT
 ,PYMNT_DT)
   
 SELECT DISTINCT 
    #prcs_process_instance
    , GLMAP.GPBR_MAN_ROW_TYPE
    , GLMAP.GP_RPT_KEY
    , GLMAP.ESTABID
    , GLMAP.EMPLID
    , GLMAP.EMPL_RCD
    , GLMAP.PIN_NUM
    [$FromVAL]
    , ' '
    , GLMAP.RUN_TYPE
    , GLMAP.GPBR_REVERSE_SIGN
    , GLD.CALC_RSLT_VAL
    , GLMAP.EFFDT  
    , GLD.PAY_ENTITY
    , GLD.BUSINESS_UNIT
    , GLMAP.SETID_DEPT 
    , GLMAP.DEPTID     
    , GLMAP.GPBR_SERVICE_TAKER
    , GLMAP.GPBR_TAKER_INSCR
    , GLMAP.SLICE_BGN_DT
    , GLMAP.SLICE_END_DT
    , GLMAP.PYMNT_DT
 FROM PS_GP_GL_DATA GLD 
       , PS_GPBR_GLMAP300_T GLMAP
       , PS_GPBR_MANAD_TMP3 TMP3
 WHERE GLMAP.PROCESS_INSTANCE = #prcs_process_instance
     AND GLD.EMPLID   = GLMAP.EMPLID
     AND GLD.EMPL_RCD = GLMAP.EMPL_RCD     
     AND GLD.PIN_NUM  = GLMAP.PIN_NUM
     AND TMP3.PROCESS_INSTANCE = #prcs_process_instance
     AND TMP3.GPBR_MAN_ROW_TYPE = GLMAP.GPBR_MAN_ROW_TYPE
     AND TMP3.GP_RPT_KEY = GLMAP.GP_RPT_KEY
     AND TMP3.CAL_RUN_ID = GLD.CAL_RUN_ID
     AND GLD.CAL_ID = TRIM(SUBSTR(GLMAP.GP_RPT_KEY,5,18))
     [$WhrCrit]
     [$WhrNotEx]  

 end-sql
#endif

      Let #gpchlfldCURR = #gpchlfldCURR - 1
      
end-while

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MN_K300_T COMPUTE STATISTICS
    end-sql

#endif

end-procedure Bld-K300-Filter

!**************************************
begin-procedure Bld-K200-Map
#debug show '* Bld-K200-Map'
!**************************************

Begin-Sql
insert into PS_GPBR_MN_GLMAP_T
  (PROCESS_INSTANCE
  ,PAY_ENTITY
  ,BUSINESS_UNIT
  ,ESTABID
  ,PIN_NUM
  ,SETID_DEPT
  ,DEPTID 
  ,EFFDT
  ,PIN_CHART1_VAL 
  ,PIN_CHART2_VAL 
  ,PIN_CHART3_VAL 
  ,PIN_CHART4_VAL 
  ,PIN_CHART5_VAL 
  ,PIN_CHART6_VAL 
  ,PIN_CHART7_VAL 
  ,PIN_CHART8_VAL 
  ,PIN_CHART9_VAL    
  ,PIN_CHART10_VAL    
  ,PIN_CHART11_VAL    
  ,PIN_CHART12_VAL    
  ,PIN_CHART13_VAL    
  ,PIN_CHART14_VAL    
  ,PIN_CHART15_VAL
  ,PIN_CHART16_VAL    
  ,PIN_CHART17_VAL    
  ,PIN_CHART18_VAL    
  ,PIN_CHART19_VAL    
  ,PIN_CHART20_VAL    
  ,PIN_CHART21_VAL     
  ,GPBR_SERVICE_TAKER
  ,ACCOUNT
  ,ESTAB_ID_BRA
  ,GPBR_TAKER_INSCR)
SELECT DISTINCT #prcs_process_instance
  , MAP200.PAY_ENTITY
  , MAP200.BUSINESS_UNIT
  , MAP200.ESTABID
  , MAP200.PIN_NUM
  , MAP200.SETID_DEPT
  , MAP200.DEPTID 
  , MAP200.EFFDT
  , MAP200.PIN_CHART1_VAL 
  , MAP200.PIN_CHART2_VAL 
  , MAP200.PIN_CHART3_VAL 
  , MAP200.PIN_CHART4_VAL 
  , MAP200.PIN_CHART5_VAL 
  , MAP200.PIN_CHART6_VAL 
  , MAP200.PIN_CHART7_VAL 
  , MAP200.PIN_CHART8_VAL 
  , MAP200.PIN_CHART9_VAL    
  , MAP200.PIN_CHART10_VAL    
  , MAP200.PIN_CHART11_VAL    
  , MAP200.PIN_CHART12_VAL    
  , MAP200.PIN_CHART13_VAL    
  , MAP200.PIN_CHART14_VAL    
  , MAP200.PIN_CHART15_VAL
  , MAP200.PIN_CHART16_VAL    
  , MAP200.PIN_CHART17_VAL    
  , MAP200.PIN_CHART18_VAL    
  , MAP200.PIN_CHART19_VAL    
  , MAP200.PIN_CHART20_VAL    
  , MAP200.PIN_CHART21_VAL  
  , MAP200.GPBR_SERVICE_TAKER
  , MAP200.ACCOUNT
  , MAP200.ESTAB_ID_BRA  
  , MAP200.GPBR_TAKER_INSCR
FROM PS_GPBR_GLMAP300_T MAP200
WHERE MAP200.PROCESS_INSTANCE = #prcs_process_instance
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MN_GLMAP_T COMPUTE STATISTICS
    end-sql

#endif


end-procedure Bld-K200-Map

!**************************************
begin-procedure Bld-K200-Filter
#debug show '* Bld-K200-Filter'
!**************************************

Let $WhrNotEx = ' '

Begin-Select
GP_CHFLD_IND   &GP_CHFLD_IND200

   Let $gpchlfldMAX = rtrim(&GP_CHFLD_IND200, ' ')
   Let #gpchlfldMAX = to_number($gpchlfldMAX)
   Let #gpchlfldCURR = #gpchlfldMAX
   
FROM PS_GPBR_MAN_PARM_T
WHERE PROCESS_INSTANCE = #prcs_process_instance
  AND ESTABID = $RC_estabID
End-Select

while #gpchlfldCURR >= 0

      If #gpchlfldMAX > #gpchlfldCURR
      
         Let $WhrNotEx = ' AND NOT EXISTS (SELECT ''X'' FROM PS_GPBR_MN_K200_T XX WHERE XX.PROCESS_INSTANCE = ' || to_char(#prcs_process_instance)
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PAY_ENTITY = GLD.PAY_ENTITY '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.BUSINESS_UNIT = GLD.BUSINESS_UNIT '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.ESTABID = TMP2.ESTABID '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_NUM = TMP2.PIN_NUM '    
         Let $WhrNotEx = $WhrNotEx || ' AND XX.SETID_DEPT = TMP2.SETID_DEPT '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.DEPTID = TMP2.DEPTID '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART1_VAL  = GLD.PIN_CHART1_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART2_VAL  = GLD.PIN_CHART2_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART3_VAL  = GLD.PIN_CHART3_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART4_VAL  = GLD.PIN_CHART4_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART5_VAL  = GLD.PIN_CHART5_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART6_VAL  = GLD.PIN_CHART6_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART7_VAL  = GLD.PIN_CHART7_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART8_VAL  = GLD.PIN_CHART8_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART9_VAL  = GLD.PIN_CHART9_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART10_VAL  = GLD.PIN_CHART10_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART11_VAL = GLD.PIN_CHART11_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART12_VAL = GLD.PIN_CHART12_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART13_VAL = GLD.PIN_CHART13_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART14_VAL = GLD.PIN_CHART14_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART15_VAL = GLD.PIN_CHART15_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART16_VAL = GLD.PIN_CHART16_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART17_VAL = GLD.PIN_CHART17_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART18_VAL = GLD.PIN_CHART18_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART19_VAL = GLD.PIN_CHART19_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART20_VAL = GLD.PIN_CHART20_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.PIN_CHART21_VAL = GLD.PIN_CHART21_VAL '
         Let $WhrNotEx = $WhrNotEx || ' AND XX.GPBR_SERVICE_TAKER = TMP2.GPBR_SERVICE_TAKER )'
         
      End-If

      Let #chlfldCONT = 1
      Let $FromVAL = ' '
      Let $WhrCrit = ' ' 
      
      while #chlfldCONT <= 21
  
         If #chlfldCONT <= #gpchlfldCURR
         
            If #gpchlfldCURR > 0
            
               Let $chlfldCONT = edit(#chlfldCONT,'9') 
                  
               Let $FromVAL = $FromVAL || ' , GLD.PIN_CHART' || $chlfldCONT || '_VAL'
               Let $WhrCrit = $WhrCrit || ' AND GLMAP.PIN_CHART' || $chlfldCONT || '_VAL = GLD.PIN_CHART' || $chlfldCONT || '_VAL'

            Else
            
               Let $FromVAL = $FromVAL || ' , '' '' '

            End-If 
            
         Else
              
            Let $FromVAL = $FromVAL || ' , '' '' '

         End-If
            
         Let #chlfldCONT = #chlfldCONT + 1
                     
      end-while
#ifdef MICROSOFT ! Microsoft Block
 begin-sql 

 insert into PS_GPBR_MN_K200_T
   (PROCESS_INSTANCE
   ,PAY_ENTITY
   ,BUSINESS_UNIT
   ,ESTABID
   ,PIN_NUM
   ,SETID_DEPT
   ,DEPTID 
   ,EFFDT
   ,PIN_CHART1_VAL 
   ,PIN_CHART2_VAL 
   ,PIN_CHART3_VAL 
   ,PIN_CHART4_VAL 
   ,PIN_CHART5_VAL 
   ,PIN_CHART6_VAL 
   ,PIN_CHART7_VAL 
   ,PIN_CHART8_VAL 
   ,PIN_CHART9_VAL 
   ,PIN_CHART10_VAL 
   ,PIN_CHART11_VAL 
   ,PIN_CHART12_VAL 
   ,PIN_CHART13_VAL 
   ,PIN_CHART14_VAL 
   ,PIN_CHART15_VAL 
   ,PIN_CHART16_VAL 
   ,PIN_CHART17_VAL 
   ,PIN_CHART18_VAL 
   ,PIN_CHART19_VAL 
   ,PIN_CHART20_VAL 
   ,PIN_CHART21_VAL 
   ,GPBR_SERVICE_TAKER
   ,ACCOUNT
   ,GPBR_TAKER_INSCR)
   
 SELECT DISTINCT 
    #prcs_process_instance
    ,GLD.PAY_ENTITY
    ,GLD.BUSINESS_UNIT
    ,TMP2.ESTABID      
    ,TMP2.PIN_NUM                
    ,TMP2.SETID_DEPT 
    ,TMP2.DEPTID     
    ,GLMAP.EFFDT   
    [$FromVAL]
    ,GLMAP.GPBR_SERVICE_TAKER
    ,' '
    ,GLMAP.GPBR_TAKER_INSCR
    FROM PS_GP_GL_DATA GLD 
       ,PS_GPBR_MANAD_TMP2 TMP2
       ,PS_GPBR_MN_GLMAP_T GLMAP
       ,PS_GPBR_MANAD_TMP3 TMP3
 WHERE TMP2.PROCESS_INSTANCE = #prcs_process_instance
     AND TMP2.GPBR_MAN_ROW_TYPE = 'K300'
     AND GLD.EMPLID   = TMP2.EMPLID
     AND GLD.EMPL_RCD = TMP2.EMPL_RCD     
     AND GLD.PIN_NUM  = TMP2.PIN_NUM
     AND GLMAP.PROCESS_INSTANCE = #prcs_process_instance
     AND GLMAP.PAY_ENTITY = GLD.PAY_ENTITY
     AND GLMAP.BUSINESS_UNIT = GLD.BUSINESS_UNIT 
     AND GLMAP.ESTABID = TMP2.ESTABID
     AND GLMAP.PIN_NUM = TMP2.PIN_NUM
     AND GLMAP.SETID_DEPT = TMP2.SETID_DEPT
     AND GLMAP.DEPTID = TMP2.DEPTID
     AND GLMAP.GPBR_SERVICE_TAKER = TMP2.GPBR_SERVICE_TAKER
     AND TMP3.PROCESS_INSTANCE = TMP2.PROCESS_INSTANCE
     AND TMP3.GPBR_MAN_ROW_TYPE = TMP2.GPBR_MAN_ROW_TYPE
     AND TMP2.GP_RPT_KEY = TMP3.GP_RPT_KEY
     AND TMP3.CAL_RUN_ID = GLD.CAL_RUN_ID
     AND GLD.CAL_ID = RTRIM(SUBSTRING(TMP2.GP_RPT_KEY,5,18))
     [$WhrCrit]
     [$WhrNotEx] 

 end-sql
#endif

#ifndef MICROSOFT ! non - Microsoft Block
 begin-sql

 insert into PS_GPBR_MN_K200_T
   (PROCESS_INSTANCE
   ,PAY_ENTITY
   ,BUSINESS_UNIT
   ,ESTABID
   ,PIN_NUM
   ,SETID_DEPT
   ,DEPTID 
   ,EFFDT
   ,PIN_CHART1_VAL 
   ,PIN_CHART2_VAL 
   ,PIN_CHART3_VAL 
   ,PIN_CHART4_VAL 
   ,PIN_CHART5_VAL 
   ,PIN_CHART6_VAL 
   ,PIN_CHART7_VAL 
   ,PIN_CHART8_VAL 
   ,PIN_CHART9_VAL 
   ,PIN_CHART10_VAL 
   ,PIN_CHART11_VAL 
   ,PIN_CHART12_VAL 
   ,PIN_CHART13_VAL 
   ,PIN_CHART14_VAL 
   ,PIN_CHART15_VAL 
   ,PIN_CHART16_VAL 
   ,PIN_CHART17_VAL 
   ,PIN_CHART18_VAL 
   ,PIN_CHART19_VAL 
   ,PIN_CHART20_VAL 
   ,PIN_CHART21_VAL    
   ,GPBR_SERVICE_TAKER
   ,ACCOUNT
   ,GPBR_TAKER_INSCR)
   
 SELECT DISTINCT 
    #prcs_process_instance
    , GLD.PAY_ENTITY
    , GLD.BUSINESS_UNIT
    , TMP2.ESTABID      
    , TMP2.PIN_NUM                
    , TMP2.SETID_DEPT 
    , TMP2.DEPTID     
    , GLMAP.EFFDT   
    [$FromVAL]
    , GLMAP.GPBR_SERVICE_TAKER
    , ' '
    , GLMAP.GPBR_TAKER_INSCR
    FROM PS_GP_GL_DATA GLD 
       , PS_GPBR_MANAD_TMP2 TMP2
       , PS_GPBR_MN_GLMAP_T GLMAP
       , PS_GPBR_MANAD_TMP3 TMP3
 WHERE TMP2.PROCESS_INSTANCE = #prcs_process_instance
     AND TMP2.GPBR_MAN_ROW_TYPE = 'K300'
     AND GLD.EMPLID   = TMP2.EMPLID
     AND GLD.EMPL_RCD = TMP2.EMPL_RCD     
     AND GLD.PIN_NUM  = TMP2.PIN_NUM
     AND GLMAP.PROCESS_INSTANCE = #prcs_process_instance
     AND GLMAP.PAY_ENTITY = GLD.PAY_ENTITY
     AND GLMAP.BUSINESS_UNIT = GLD.BUSINESS_UNIT 
     AND GLMAP.ESTABID = TMP2.ESTABID
     AND GLMAP.PIN_NUM = TMP2.PIN_NUM
     AND GLMAP.SETID_DEPT = TMP2.SETID_DEPT
     AND GLMAP.DEPTID = TMP2.DEPTID
     AND GLMAP.GPBR_SERVICE_TAKER = TMP2.GPBR_SERVICE_TAKER
     AND TMP3.PROCESS_INSTANCE = TMP2.PROCESS_INSTANCE
     AND TMP3.GPBR_MAN_ROW_TYPE = TMP2.GPBR_MAN_ROW_TYPE
     AND TMP2.GP_RPT_KEY = TMP3.GP_RPT_KEY
     AND TMP3.CAL_RUN_ID = GLD.CAL_RUN_ID
     AND GLD.CAL_ID = TRIM(SUBSTR(TMP2.GP_RPT_KEY,5,18))
     [$WhrCrit]
     [$WhrNotEx] 
 end-sql
#endif

      Let #gpchlfldCURR = #gpchlfldCURR - 1
      
end-while

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MN_K200_T COMPUTE STATISTICS
    end-sql

#endif

end-procedure Bld-K200-Filter

!**************************************
begin-procedure Bld-K200-TMP1
#debug show '* Bld-K200-TMP1'
!**************************************

Let $MANADRowType = 'K200'
Let #rowCount = 1


#ifdef MICROSOFT ! Microsoft Block
 begin-sql
 insert into PS_GPBR_MANAD_TMP1
 ( PROCESS_INSTANCE 
 ,GPBR_MAN_ROW_TYPE 
 ,COMPANY           
 ,ESTABID           
 ,GP_RPT_KEY        
 ,CENTR_ESTABID_BRA 
 ,GPBR_MAN_CENTR_IND
 ,ESTAB_ID_BRA      
 ,GPBR_CNPJ         
 ,DEPTID            
 ,GPBR_MAN_TEXT     
 ,PIN_NUM           
 ,GPBR_MAN_EMP_FORM 
 ,ROW_COUNT         
 ,EFFDT             
 ,GL_EXPENSE        
 ,ACCOUNT           
 ,PIN_NM            
 ,GPBR_SERVICE_TAKER
 )
 Select DISTINCT
 #prcs_process_instance
 ,$MANADRowType
 ,' '                     
 ,K2.ESTABID
 ,SUBSTRING(CONCAT(K2.PIN_NUM ,K2.DEPTID , K2.GPBR_SERVICE_TAKER),1,22)
 ,$RC_Estabid          
 ,' '      
 ,M2.ESTAB_ID_BRA       
 ,' '                     
 ,K2.DEPTID             
 ,' '                     
 ,K2.PIN_NUM            
 ,' '                     
 ,#rowCount                       
 ,K2.EFFDT              
 ,' '
 ,M2.ACCOUNT            
 ,GPPIN.PIN_NM              
 ,K2.GPBR_SERVICE_TAKER
 FROM PS_GPBR_MN_K200_T K2
    , PS_GPBR_MN_GLMAP_T M2
    , PS_GP_PIN GPPIN
    , PS_GPBR_MND_ELEM_T ET
 WHERE  K2.PROCESS_INSTANCE = #prcs_process_instance
   AND M2.PROCESS_INSTANCE = #prcs_process_instance
   AND ET.PROCESS_INSTANCE = #prcs_process_instance
   AND M2.PAY_ENTITY = K2.PAY_ENTITY
   AND M2.BUSINESS_UNIT = K2.BUSINESS_UNIT 
   AND M2.ESTABID = K2.ESTABID
   AND M2.PIN_NUM = K2.PIN_NUM
   AND M2.SETID_DEPT = K2.SETID_DEPT
   AND M2.DEPTID = K2.DEPTID
   AND M2.PIN_CHART1_VAL  = K2.PIN_CHART1_VAL
   AND M2.PIN_CHART2_VAL  = K2.PIN_CHART2_VAL
   AND M2.PIN_CHART3_VAL  = K2.PIN_CHART3_VAL
   AND M2.PIN_CHART4_VAL  = K2.PIN_CHART4_VAL
   AND M2.PIN_CHART5_VAL  = K2.PIN_CHART5_VAL
   AND M2.PIN_CHART6_VAL  = K2.PIN_CHART6_VAL
   AND M2.PIN_CHART7_VAL  = K2.PIN_CHART7_VAL
   AND M2.PIN_CHART8_VAL  = K2.PIN_CHART8_VAL
   AND M2.PIN_CHART9_VAL  = K2.PIN_CHART9_VAL
   AND M2.PIN_CHART10_VAL = K2.PIN_CHART10_VAL
   AND M2.PIN_CHART11_VAL = K2.PIN_CHART11_VAL
   AND M2.PIN_CHART12_VAL = K2.PIN_CHART12_VAL
   AND M2.PIN_CHART13_VAL = K2.PIN_CHART13_VAL
   AND M2.PIN_CHART14_VAL = K2.PIN_CHART14_VAL
   AND M2.PIN_CHART15_VAL = K2.PIN_CHART15_VAL
   AND M2.PIN_CHART16_VAL = K2.PIN_CHART16_VAL
   AND M2.PIN_CHART17_VAL = K2.PIN_CHART17_VAL
   AND M2.PIN_CHART18_VAL = K2.PIN_CHART18_VAL
   AND M2.PIN_CHART19_VAL = K2.PIN_CHART19_VAL
   AND M2.PIN_CHART20_VAL = K2.PIN_CHART20_VAL
   AND M2.PIN_CHART21_VAL = K2.PIN_CHART21_VAL
   AND M2.GPBR_SERVICE_TAKER = K2.GPBR_SERVICE_TAKER
   AND GPPIN.PIN_NUM = K2.PIN_NUM
   AND ET.ESTABID = $RC_Estabid
   AND ET.GPBR_PIN_MAN_NUM = K2.PIN_NUM
 end-sql
#endif

#ifndef MICROSOFT ! non - Microsoft Block
 begin-sql
  insert into PS_GPBR_MANAD_TMP1
  ( PROCESS_INSTANCE 
  ,GPBR_MAN_ROW_TYPE 
  ,COMPANY           
  ,ESTABID           
  ,GP_RPT_KEY        
  ,CENTR_ESTABID_BRA 
  ,GPBR_MAN_CENTR_IND
  ,ESTAB_ID_BRA      
  ,GPBR_CNPJ         
  ,DEPTID            
  ,GPBR_MAN_TEXT     
   ,PIN_NUM           
  ,GPBR_MAN_EMP_FORM 
 ,ROW_COUNT         
 ,EFFDT             
 ,GL_EXPENSE        
 ,ACCOUNT           
 ,PIN_NM            
 ,GPBR_SERVICE_TAKER
 )
 Select DISTINCT
 #prcs_process_instance
 ,$MANADRowType
 ,' '                     
 ,K2.ESTABID
 ,SUBSTR(K2.PIN_NUM || K2.DEPTID || K2.GPBR_SERVICE_TAKER,1,22)
 ,$RC_Estabid          
 ,' '      
 ,M2.ESTAB_ID_BRA       
 ,' '                     
 ,K2.DEPTID             
 ,' '                     
 ,K2.PIN_NUM            
 ,' '                     
 ,#rowCount                       
 ,K2.EFFDT              
 ,' '
 ,M2.ACCOUNT            
 ,GPPIN.PIN_NM              
 ,K2.GPBR_SERVICE_TAKER
 FROM PS_GPBR_MN_K200_T K2
    , PS_GPBR_MN_GLMAP_T M2
    , PS_GP_PIN GPPIN
    , PS_GPBR_MND_ELEM_T ET
 WHERE  K2.PROCESS_INSTANCE = #prcs_process_instance
   AND M2.PROCESS_INSTANCE = #prcs_process_instance
   AND ET.PROCESS_INSTANCE = #prcs_process_instance
   AND M2.PAY_ENTITY = K2.PAY_ENTITY
   AND M2.BUSINESS_UNIT = K2.BUSINESS_UNIT 
   AND M2.ESTABID = K2.ESTABID
   AND M2.PIN_NUM = K2.PIN_NUM
   AND M2.SETID_DEPT = K2.SETID_DEPT
   AND M2.DEPTID = K2.DEPTID
   AND M2.PIN_CHART1_VAL = K2.PIN_CHART1_VAL
   AND M2.PIN_CHART2_VAL = K2.PIN_CHART2_VAL
   AND M2.PIN_CHART3_VAL = K2.PIN_CHART3_VAL
   AND M2.PIN_CHART4_VAL = K2.PIN_CHART4_VAL
   AND M2.PIN_CHART5_VAL = K2.PIN_CHART5_VAL
   AND M2.PIN_CHART6_VAL = K2.PIN_CHART6_VAL
   AND M2.PIN_CHART7_VAL = K2.PIN_CHART7_VAL
   AND M2.PIN_CHART8_VAL = K2.PIN_CHART8_VAL
   AND M2.PIN_CHART8_VAL  = K2.PIN_CHART8_VAL
   AND M2.PIN_CHART9_VAL  = K2.PIN_CHART9_VAL
   AND M2.PIN_CHART10_VAL = K2.PIN_CHART10_VAL
   AND M2.PIN_CHART11_VAL = K2.PIN_CHART11_VAL
   AND M2.PIN_CHART12_VAL = K2.PIN_CHART12_VAL
   AND M2.PIN_CHART13_VAL = K2.PIN_CHART13_VAL
   AND M2.PIN_CHART14_VAL = K2.PIN_CHART14_VAL
   AND M2.PIN_CHART15_VAL = K2.PIN_CHART15_VAL
   AND M2.PIN_CHART16_VAL = K2.PIN_CHART16_VAL
   AND M2.PIN_CHART17_VAL = K2.PIN_CHART17_VAL
   AND M2.PIN_CHART18_VAL = K2.PIN_CHART18_VAL
   AND M2.PIN_CHART19_VAL = K2.PIN_CHART19_VAL
   AND M2.PIN_CHART20_VAL = K2.PIN_CHART20_VAL
   AND M2.PIN_CHART21_VAL = K2.PIN_CHART21_VAL   
   AND M2.GPBR_SERVICE_TAKER = K2.GPBR_SERVICE_TAKER
   AND GPPIN.PIN_NUM = K2.PIN_NUM
   AND ET.ESTABID = $RC_Estabid
   AND ET.GPBR_PIN_MAN_NUM = K2.PIN_NUM
 end-sql
#endif

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP1 COMPUTE STATISTICS
    end-sql

#endif

end-procedure Bld-K200-TMP1

!**************************************
begin-procedure Get-Parameters
#debug show '* Get-Parameters'
!**************************************

Let $emplFormat = 'N'
Let $parmFlag = 'N'

begin-SELECT  
PA.GPBR_MAN_EMP_FORM

   Let $emplFormat = RTRIM(&PA.GPBR_MAN_EMP_FORM, ' ') 
   Let $parmFlag = 'Y'

FROM PS_GPBR_MAN_PARM_T PA 
WHERE PA.ESTABID = $Parm_estabID

end-select 

end-procedure Get-Parameters 

!**************************************
begin-procedure Extract-Data-0000
#debug show '* Extract-Data-0000'
!**************************************

Let $IND_MOV = '1'

Do Row-0000  
Do Row-0050
Do Row-0100

Let $deptID = ' '
Let #pinNum = 0
Let $MANADRowType = '0001'
Let $MANADtext = $IND_MOV
Let $GPRptKey = $MANADRowType
Do Insert-MANAD-TMP


Let $MANADRowType = '0990'

BEGIN-SELECT
COUNT(*) &Count990

  Let $MANADtext = to_char(&Count990 + 1)
  Let $GPRptKey = $MANADRowType
  Do Insert-MANAD-TMP

FROM PS_GPBR_MANAD_TMP1 
WHERE GPBR_MAN_ROW_TYPE LIKE '0%' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

!************ LOG

BEGIN-SELECT
COUNT(*) &CountLog1
  
  if &CountLog1 > 1
    show $RC_EstabID ' Mais de um registro de centralizao'
  end-if
  
FROM PS_CENTR_DATA_BRA C 
WHERE C.PROCESS_TYPE_BRA = '50' 
AND C.CENTR_ESTABID_BRA = $RC_EstabID 
AND C.EFFDT BETWEEN $RC_DateFrom AND $RC_DateTo
   AND EXISTS ( 
 SELECT 'X' 
  FROM PS_CENTR_DTL_BRA CD 
 WHERE CD.PROCESS_TYPE_BRA = C.PROCESS_TYPE_BRA 
   AND CD.CENTR_ESTABID_BRA = C.CENTR_ESTABID_BRA 
   AND CD.EFFDT = C.EFFDT 
   AND CD.ESTABID <> C.CENTR_ESTABID_BRA )
END-SELECT

End-Procedure Extract-Data-0000

!**************************************
begin-procedure Extract-Data-K000
#debug show '* Extract-Data-K000'
!**************************************

Let $MANADRowType = 'K150'
Let #rowCount = 1
Let $WhereElm_K150 = ' AND R2.PIN_NUM IN ('   
Let $estabID = ' '
Let $company = ' '

Begin-Sql
insert into PS_GPBR_MANAD_TMP1
( PROCESS_INSTANCE 
,GPBR_MAN_ROW_TYPE 
,COMPANY
,ESTABID 
,GP_RPT_KEY 
,CENTR_ESTABID_BRA 
,GPBR_MAN_CENTR_IND 
,ESTAB_ID_BRA 
,GPBR_CNPJ
,DEPTID
,GPBR_MAN_TEXT
,PIN_NUM
,GPBR_MAN_EMP_FORM
,ROW_COUNT
,EFFDT
,GL_EXPENSE
,ACCOUNT
,PIN_NM
,GPBR_SERVICE_TAKER
) 
Select DISTINCT
#prcs_process_instance
,$MANADRowType
,$company
,$estabID
,R15.PIN_NUM
,$centrEstabID                  
,$IND_CENTR 
,TM15.ESTAB_ID_BRA
,$CNPJAsoc
,$deptID
,' '
,R15.PIN_NUM
,$emplFormat
,#rowCount
,null
,' '
,' '
,' '
,' '
FROM  PS_GP_PIN PN 
   ,PS_GPBR_RGST_DTL_T R15
  , PS_GPBR_MANAD_TMP1 TM15
  ,PS_GPBR_RGST_GDE_T RG15 
  ,PS_GPBR_MND_ELEM_T ET
WHERE R15.PROCESS_INSTANCE = #prcs_process_instance
AND TM15.PROCESS_INSTANCE = #prcs_process_instance 
AND RG15.PROCESS_INSTANCE = #prcs_process_instance 
AND ET.PROCESS_INSTANCE = #prcs_process_instance 
AND RG15.ESTABID = TM15.ESTABID
AND TM15.GPBR_MAN_ROW_TYPE = '0000'    
AND RG15.EMPLID = R15.EMPLID 
AND RG15.EMPL_RCD = R15.EMPL_RCD 
AND RG15.CAL_RUN_ID = R15.CAL_RUN_ID 
AND RG15.GP_PAYGROUP = R15.GP_PAYGROUP 
AND RG15.CAL_ID = R15.CAL_ID 
AND RG15.ORIG_CAL_RUN_ID = R15.ORIG_CAL_RUN_ID 
AND RG15.RSLT_SEG_NUM = R15.RSLT_SEG_NUM 
AND RG15.GP_RPT_KEY = R15.GP_RPT_KEY 
AND PN.PIN_NUM= R15.PIN_NUM
AND PN.PIN_TYPE IN ('ER','DD')
AND ET.ESTABID = $RC_Estabid
AND ET.GPBR_PIN_MAN_NUM = PN.PIN_NUM
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP1 COMPUTE STATISTICS
    end-sql

#endif

!  Begin ***************** K250

Let $MANADRowType = 'K250'
Let $IND_CENTR = ' '
Let $MANADtext = ' '
Let #rowCount = 1
Let $CNPJ = ' '
Let $CEI = ' '
Let $estabInscription = ' '
Let #pinNum = 0

Do Row-K250
Do Get-Employee-Data
Do Get-Dependent-Data
Do Create-Base-IT-K250

BEGIN-SELECT
SUM(ROW_COUNT) &Count250

  Let $estabid = ' '
  Let $MANADtext = $MANADRowType
  Let $GPRptKey = $MANADRowType  
  Let #rowCount = &Count250

FROM PS_GPBR_MANAD_TMP2 
WHERE GPBR_MAN_ROW_TYPE = 'K250' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

Let #rowCount = 0

! End ***************** K250

Let $MANADRowType = 'K050'
Let $IND_CENTR = ' '
Let $MANADtext = ' '
Let #rowCount = 1
Let #pinNum = 0
Let $estabInscription = ' '
Let $CEI = ' '
Let $CNPJ = ' '
Let $deptID = ' '   
Let $setid = ' '

Do Row-K050

BEGIN-SELECT
SUM(ROW_COUNT) &Count050

  Let $estabid = ' '
  Let $MANADtext = $MANADRowType
  Let $GPRptKey = $MANADRowType  
  Let #rowCount = &Count050
  Do Insert-MANAD-TMP

FROM PS_GPBR_MANAD_TMP2 
WHERE GPBR_MAN_ROW_TYPE = 'K050' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

Let $MANADRowType = 'K100'
Let $IND_CENTR = ' '
Let $MANADtext = ' '
Let #rowCount = 1
Let $deptID = ' '
Let $setID = ' '
Let $estabInscription = ' '
Let #sequence = 0
let $Existe = 'N'

Let $MANADRowType = 'K100'
Let $IND_CENTR = ' '
Let $MANADtext = ' '
Let #rowCount = 1
Let $deptID = ' '
Let $setID = ' '
Let $estabInscription = ' '
Let #sequence = 0
Let $estabid = ' '
let $company = ' '

#ifdef MICROSOFT !Block for MS SQL Databases
begin-sql
insert into PS_GPBR_MANAD_TMP1
( 
 PROCESS_INSTANCE              
,GPBR_MAN_ROW_TYPE                 
,COMPANY                           
,ESTABID                           
,GP_RPT_KEY                        
,CENTR_ESTABID_BRA                 
,GPBR_MAN_CENTR_IND                
,ESTAB_ID_BRA                      
,GPBR_CNPJ                         
,DEPTID                            
,GPBR_MAN_TEXT                     
,PIN_NUM                           
,GPBR_MAN_EMP_FORM                 
,ROW_COUNT
,EFFDT
,GL_EXPENSE
,ACCOUNT
,PIN_NM
,GPBR_SERVICE_TAKER
)                        
Select DISTINCT
#prcs_process_instance
,$MANADRowType
,$company
,$estabid
,SUBSTRING(concat(CASE WHEN PAYE100.GPBR_SERVICE_TAKER = ' ' THEN ' ' WHEN PAYE100.GPBR_SERVICE_TAKER IS NULL THEN ' ' ELSE PAYE100.GPBR_SERVICE_TAKER END , T10.DEPTID, TM10.ESTAB_ID_BRA),1,22)
,$centrEstabID
,$IND_CENTR
,TM10.ESTAB_ID_BRA
,TM10.GPBR_CNPJ
,T10.DEPTID 
,D.DESCR 
,0
,'Y'
,#rowCount
,D.EFFDT
,' '
,' '
,' '
,COALESCE(PAYE100.GPBR_SERVICE_TAKER,' ')
from PS_GPBR_MANAD_TMP2 T10 LEFT OUTER JOIN PS_GPBR_PAYEE_PA_T PAYE100 ON PAYE100.PROCESS_INSTANCE = #prcs_process_instance 
                                                  AND T10.EMPLID = PAYE100.EMPLID AND T10.EMPL_RCD = PAYE100.EMPL_RCD
    ,PS_GPBR_MANAD_TMP1 TM10 
    ,PS_DEPT_TBL D 
WHERE T10.PROCESS_INSTANCE = #prcs_process_instance
   AND T10.GPBR_MAN_ROW_TYPE = 'K250'      
   AND TM10.PROCESS_INSTANCE = #prcs_process_instance 
   AND TM10.GPBR_MAN_ROW_TYPE = '0000'     
   AND T10.ESTABID = TM10.ESTABID
   AND T10.DEPTID = D.DEPTID 
   AND T10.SETID_DEPT = D.SETID 
   AND D.EFFDT = ( SELECT MAX(D1.EFFDT) 
                   FROM PS_DEPT_TBL D1 
                  WHERE D1.DEPTID = D.DEPTID 
                    AND D1.SETID = D.SETID 
                    AND D1.EFFDT <= $RC_DateTo) 
   
 End-Sql
#endif 
#ifndef MICROSOFT !Block for non - MS SQL Databases
 begin-sql
 insert into PS_GPBR_MANAD_TMP1
 ( 
  PROCESS_INSTANCE              
 ,GPBR_MAN_ROW_TYPE                 
 ,COMPANY                           
 ,ESTABID                           
 ,GP_RPT_KEY                        
 ,CENTR_ESTABID_BRA                 
 ,GPBR_MAN_CENTR_IND                
 ,ESTAB_ID_BRA                      
 ,GPBR_CNPJ                         
 ,DEPTID                            
 ,GPBR_MAN_TEXT                     
 ,PIN_NUM                           
 ,GPBR_MAN_EMP_FORM                 
 ,ROW_COUNT
 ,EFFDT
 ,GL_EXPENSE
 ,ACCOUNT
 ,PIN_NM
 ,GPBR_SERVICE_TAKER
 )                        
 Select DISTINCT
 #prcs_process_instance
 ,$MANADRowType
 ,$company
 ,$estabid
 ,SUBSTR(CASE WHEN PAYE100.GPBR_SERVICE_TAKER = ' ' THEN ' ' WHEN PAYE100.GPBR_SERVICE_TAKER IS NULL THEN ' ' ELSE  PAYE100.GPBR_SERVICE_TAKER END  || T10.DEPTID || TM10.ESTAB_ID_BRA,1,22)
 ,$centrEstabID
 ,$IND_CENTR
 ,TM10.ESTAB_ID_BRA
 ,TM10.GPBR_CNPJ
 ,T10.DEPTID 
 ,D.DESCR 
 ,0
 ,'Y'
 ,#rowCount
 ,D.EFFDT
 ,' '
 ,' '
 ,' '
 ,COALESCE(PAYE100.GPBR_SERVICE_TAKER,' ')
 from PS_GPBR_MANAD_TMP2 T10 LEFT OUTER JOIN PS_GPBR_PAYEE_PA_T PAYE100 ON PAYE100.PROCESS_INSTANCE = #prcs_process_instance 
                                                   AND T10.EMPLID = PAYE100.EMPLID AND T10.EMPL_RCD = PAYE100.EMPL_RCD
     ,PS_GPBR_MANAD_TMP1 TM10 
     ,PS_DEPT_TBL D 
 WHERE T10.PROCESS_INSTANCE = #prcs_process_instance
    AND T10.GPBR_MAN_ROW_TYPE = 'K250'      
    AND TM10.PROCESS_INSTANCE = #prcs_process_instance 
    AND TM10.GPBR_MAN_ROW_TYPE = '0000'     
    AND T10.ESTABID = TM10.ESTABID
    AND T10.DEPTID = D.DEPTID 
    AND T10.SETID_DEPT = D.SETID 
    AND D.EFFDT = ( SELECT MAX(D1.EFFDT) 
                     FROM PS_DEPT_TBL D1 
                    WHERE D1.DEPTID = D.DEPTID  
                      AND D1.SETID = D.SETID 
                      AND D1.EFFDT <= $RC_DateTo) 
   
 End-Sql
#endif
do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP1 COMPUTE STATISTICS
    end-sql

#endif

#debug show '***************** K300'

Let $MANADRowType = 'K300'
Let $IND_CENTR = ' '
Let $MANADtext = ' '
Let #rowCount = 1
Let $deptID = ' '
Let $setID = ' '
Let $CNPJ = ' '
Let $estabInscription = ' '

Do SumCalend

Do Bld-K300-Map
Do Bld-K300-Filter
Do Row-K300

Do Get-Acum-type-INSS
Do Get-Acum-type-IT
Do Get-K300-Base-IT
Do Get-K300-Base-INSS

BEGIN-SELECT
SUM(ROW_COUNT) &Count300

  Let $estabid = ' '
  Let $MANADtext = $MANADRowType
  Let $GPRptKey = $MANADRowType  
  Let #rowCount = &Count300
  
  if &Count300 > 0 
     Let $K_IND_MOV = '0' 
  End-If

FROM PS_GPBR_MANAD_TMP2 
WHERE GPBR_MAN_ROW_TYPE = 'K300' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

#debug show 'Begin ***************** K200'

Do Bld-K200-Map
Do Bld-K200-Filter
Do Bld-K200-TMP1

#debug show 'End   ***************** K200'

Let $MANADRowType = 'K001'
Let $MANADtext = $K_IND_MOV
Let $GPRptKey = $MANADRowType
Let #rowCount = 1
Do Insert-MANAD-TMP

Let $MANADRowType = 'K990'

BEGIN-SELECT
SUM(ROW_COUNT) &Countk990

  Let $MANADtext = to_char(&Countk990 + 1)
  Let $GPRptKey = $MANADRowType
  Do Insert-MANAD-TMP

FROM PS_GPBR_MANAD_TMP1 
WHERE GPBR_MAN_ROW_TYPE LIKE 'K%' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

Let #rowCount = 1

End-Procedure Extract-Data-K000

!**************************************
begin-procedure Adjust-Data-0000
#debug show '* Adjust-Data-0000'
!**************************************

begin-SQL
DELETE FROM PS_GPBR_MANAD_TMP1
 WHERE GPBR_MAN_ROW_TYPE = '0000'
   AND PROCESS_INSTANCE = #prcs_process_instance
   AND NOT EXISTS(SELECT 'X' 
                    FROM PS_GPBR_MANAD_TMP2 T2
                   WHERE T2.PROCESS_INSTANCE = PS_GPBR_MANAD_TMP1.PROCESS_INSTANCE
                     AND T2.GPBR_MAN_ROW_TYPE = 'K250'
                     AND T2.ESTABID = PS_GPBR_MANAD_TMP1.ESTABID)
end-sql

begin-SQL
DELETE FROM PS_GPBR_MANAD_TMP1
 WHERE GPBR_MAN_ROW_TYPE = '0990'
   AND PROCESS_INSTANCE = #prcs_process_instance
end-sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP1 COMPUTE STATISTICS
    end-sql

#endif

Let $MANADRowType = '0990' 

BEGIN-SELECT
COUNT(*) &Count0990

  Let $MANADtext = to_char(&Count0990 + 1)
  Let $GPRptKey = $MANADRowType
  Do Insert-MANAD-TMP

FROM PS_GPBR_MANAD_TMP1 
WHERE GPBR_MAN_ROW_TYPE LIKE '0%' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

End-Procedure Adjust-Data-0000

!**************************************
begin-procedure Row-K300
#debug show '* Row-K300'
!**************************************

Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP2 ( 
 PROCESS_INSTANCE                        
,GPBR_MAN_ROW_TYPE                       
,GP_RPT_KEY                              
,ESTABID                                 
,DEPTID                                  
,SETID_DEPT                              
,EMPLID                                  
,EMPL_RCD                                
,EFFDT                                   
,HIRE_DT                                 
,TERMINATION_DT                          
,GPBR_MAN_TEXT                           
,ROW_COUNT                               
,PIN_NUM                                 
,BIRTHDATE                               
,EMPL_CLASS                              
,SEFIP_CATEGORY_BRA                      
,RUN_TYPE                                
,CALC_RSLT_VAL                           
,GPBR_SEFIP_RIS_LVL                                     
,GPBR_SERVICE_TAKER                                                   
,PYMNT_DT                                
,BUSINESS_UNIT                           
,PAY_ENTITY                              
,GPBR_RUN_TYPE_ID   
,SLICE_BGN_DT
,SLICE_END_DT
) 
Select DISTINCT
#prcs_process_instance
,'K300'
,MNK30.GP_RPT_KEY                          
,MNK30.ESTABID                              
,MNK30.DEPTID                               
,MNK30.SETID_DEPT                               
,MNK30.EMPLID                               
,MNK30.EMPL_RCD                             
,MNK30.EFFDT                         
,Null                                     
,Null                                    
,' '
,1
,MNK30.PIN_NUM                              
,Null
,' '                                      
,' '                                      
,MNK30.RUN_TYPE                            
,abs(MNK30.CALC_RSLT_VAL)
,' '  
,' '  
,MNK30.PYMNT_DT                             
,MNK30.BUSINESS_UNIT
,MNK30.PAY_ENTITY                          
,PAR.GPBR_RUN_TYPE_ID 
,MNK30.SLICE_BGN_DT
,MNK30.SLICE_END_DT
FROM PS_GPBR_MN_K300_T MNK30
    ,PS_GPBR_GLMAP300_T M3 
    ,PS_GPBR_MANAD_RUNT PAR
    ,PS_GPBR_MND_ELEM_T ET
where MNK30.PROCESS_INSTANCE = #prcs_process_instance
  AND M3.PROCESS_INSTANCE = #prcs_process_instance
  AND ET.PROCESS_INSTANCE = #prcs_process_instance
  AND M3.GPBR_MAN_ROW_TYPE = 'K300'
  AND M3.GP_RPT_KEY = MNK30.GP_RPT_KEY
  AND M3.ESTABID = MNK30.ESTABID
  AND M3.EMPLID = MNK30.EMPLID
  AND M3.EMPL_RCD = MNK30.EMPL_RCD
  AND M3.PIN_NUM = MNK30.PIN_NUM
  AND M3.PIN_CHART1_VAL  = MNK30.PIN_CHART1_VAL
  AND M3.PIN_CHART2_VAL  = MNK30.PIN_CHART2_VAL
  AND M3.PIN_CHART3_VAL  = MNK30.PIN_CHART3_VAL
  AND M3.PIN_CHART4_VAL  = MNK30.PIN_CHART4_VAL
  AND M3.PIN_CHART5_VAL  = MNK30.PIN_CHART5_VAL
  AND M3.PIN_CHART6_VAL  = MNK30.PIN_CHART6_VAL
  AND M3.PIN_CHART7_VAL  = MNK30.PIN_CHART7_VAL
  AND M3.PIN_CHART8_VAL  = MNK30.PIN_CHART8_VAL
  AND M3.PIN_CHART8_VAL  = MNK30.PIN_CHART8_VAL
  AND M3.PIN_CHART9_VAL  = MNK30.PIN_CHART9_VAL
  AND M3.PIN_CHART10_VAL = MNK30.PIN_CHART10_VAL
  AND M3.PIN_CHART11_VAL = MNK30.PIN_CHART11_VAL
  AND M3.PIN_CHART12_VAL = MNK30.PIN_CHART12_VAL
  AND M3.PIN_CHART13_VAL = MNK30.PIN_CHART13_VAL
  AND M3.PIN_CHART14_VAL = MNK30.PIN_CHART14_VAL
  AND M3.PIN_CHART15_VAL = MNK30.PIN_CHART15_VAL
  AND M3.PIN_CHART16_VAL = MNK30.PIN_CHART16_VAL
  AND M3.PIN_CHART17_VAL = MNK30.PIN_CHART17_VAL
  AND M3.PIN_CHART18_VAL = MNK30.PIN_CHART18_VAL
  AND M3.PIN_CHART19_VAL = MNK30.PIN_CHART19_VAL
  AND M3.PIN_CHART20_VAL = MNK30.PIN_CHART20_VAL
  AND M3.PIN_CHART21_VAL = MNK30.PIN_CHART21_VAL    
  AND M3.RUN_TYPE = MNK30.RUN_TYPE
  AND M3.GPBR_REVERSE_SIGN = MNK30.GPBR_REVERSE_SIGN
  AND PAR.ESTABID = $RC_estabID
  AND PAR.RUN_TYPE = M3.RUN_TYPE 
  AND PAR.EFFDT = ( SELECT MAX(PAR2.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM PAR2 
                  WHERE PAR2.ESTABID = PAR.ESTABID 
                  AND PAR2.EFFDT <= $AsOfToday
                  AND PAR2.EFF_STATUS = 'A')
  AND ( MNK30.CALC_RSLT_VAL * MNK30.GPBR_REVERSE_SIGN) > 0
  AND ET.ESTABID = $RC_estabID
End-Sql

Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP2 ( 
 PROCESS_INSTANCE                        
,GPBR_MAN_ROW_TYPE                       
,GP_RPT_KEY                              
,ESTABID                                 
,DEPTID                                  
,SETID_DEPT                              
,EMPLID                                  
,EMPL_RCD                                
,EFFDT                                   
,HIRE_DT                                 
,TERMINATION_DT                          
,GPBR_MAN_TEXT                           
,ROW_COUNT                               
,PIN_NUM                                 
,BIRTHDATE                               
,EMPL_CLASS                              
,SEFIP_CATEGORY_BRA                      
,RUN_TYPE                                
,CALC_RSLT_VAL                           
,GPBR_SEFIP_RIS_LVL                                     
,GPBR_SERVICE_TAKER                                                   
,PYMNT_DT                                
,BUSINESS_UNIT                           
,PAY_ENTITY                              
,GPBR_RUN_TYPE_ID     
,SLICE_BGN_DT
,SLICE_END_DT
) 
Select DISTINCT
#prcs_process_instance
,'K300'
,MNK30.GP_RPT_KEY                          
,MNK30.ESTABID                              
,MNK30.DEPTID                               
,MNK30.SETID_DEPT                               
,MNK30.EMPLID                               
,MNK30.EMPL_RCD                             
,MNK30.EFFDT                         
,Null                                     
,Null                                    
,' '
,1
,MNK30.PIN_NUM                              
,Null
,' '                                      
,' '                                      
,MNK30.RUN_TYPE                            
,0
,' '  
,' '  
,MNK30.PYMNT_DT                             
,MNK30.BUSINESS_UNIT
,MNK30.PAY_ENTITY                          
,PAR.GPBR_RUN_TYPE_ID   
,MNK30.SLICE_BGN_DT
,MNK30.SLICE_END_DT
FROM PS_GPBR_MN_K300_T MNK30
    ,PS_GPBR_GLMAP300_T M3 
    ,PS_GPBR_MANAD_RUNT PAR
    ,PS_GPBR_MND_ELEM_T ET
where MNK30.PROCESS_INSTANCE = #prcs_process_instance
  AND M3.PROCESS_INSTANCE = #prcs_process_instance
  AND ET.PROCESS_INSTANCE = #prcs_process_instance
  AND M3.GPBR_MAN_ROW_TYPE = 'K300'
  AND M3.GP_RPT_KEY = MNK30.GP_RPT_KEY
  AND M3.ESTABID = MNK30.ESTABID
  AND M3.EMPLID = MNK30.EMPLID
  AND M3.EMPL_RCD = MNK30.EMPL_RCD
  AND M3.PIN_NUM = MNK30.PIN_NUM
  AND M3.PIN_CHART1_VAL  = MNK30.PIN_CHART1_VAL
  AND M3.PIN_CHART2_VAL  = MNK30.PIN_CHART2_VAL
  AND M3.PIN_CHART3_VAL  = MNK30.PIN_CHART3_VAL
  AND M3.PIN_CHART4_VAL  = MNK30.PIN_CHART4_VAL
  AND M3.PIN_CHART5_VAL  = MNK30.PIN_CHART5_VAL
  AND M3.PIN_CHART6_VAL  = MNK30.PIN_CHART6_VAL
  AND M3.PIN_CHART7_VAL  = MNK30.PIN_CHART7_VAL
  AND M3.PIN_CHART8_VAL  = MNK30.PIN_CHART8_VAL
  AND M3.PIN_CHART9_VAL  = MNK30.PIN_CHART9_VAL
  AND M3.PIN_CHART10_VAL = MNK30.PIN_CHART10_VAL
  AND M3.PIN_CHART11_VAL = MNK30.PIN_CHART11_VAL
  AND M3.PIN_CHART12_VAL = MNK30.PIN_CHART12_VAL
  AND M3.PIN_CHART13_VAL = MNK30.PIN_CHART13_VAL
  AND M3.PIN_CHART14_VAL = MNK30.PIN_CHART14_VAL
  AND M3.PIN_CHART15_VAL = MNK30.PIN_CHART15_VAL
  AND M3.PIN_CHART16_VAL = MNK30.PIN_CHART16_VAL
  AND M3.PIN_CHART17_VAL = MNK30.PIN_CHART17_VAL
  AND M3.PIN_CHART18_VAL = MNK30.PIN_CHART18_VAL
  AND M3.PIN_CHART19_VAL = MNK30.PIN_CHART19_VAL
  AND M3.PIN_CHART20_VAL = MNK30.PIN_CHART20_VAL
  AND M3.PIN_CHART21_VAL = MNK30.PIN_CHART21_VAL   
  AND M3.RUN_TYPE = MNK30.RUN_TYPE
  AND M3.GPBR_REVERSE_SIGN = MNK30.GPBR_REVERSE_SIGN
  AND PAR.ESTABID = $RC_estabID
  AND PAR.RUN_TYPE = M3.RUN_TYPE 
  AND PAR.EFFDT = ( SELECT MAX(PAR2.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM PAR2 
                  WHERE PAR2.ESTABID = PAR.ESTABID 
                  AND PAR2.EFFDT <= $AsOfToday
                  AND PAR2.EFF_STATUS = 'A')
  AND ( MNK30.CALC_RSLT_VAL * MNK30.GPBR_REVERSE_SIGN) <= 0
  AND NOT EXISTS (SELECT 'X' FROM PS_GPBR_MANAD_TMP2 INT2
                  WHERE INT2.PROCESS_INSTANCE = #prcs_process_instance
                    AND INT2.GPBR_MAN_ROW_TYPE = 'K300' 
                    AND INT2.GP_RPT_KEY = MNK30.GP_RPT_KEY
                    AND INT2.ESTABID = MNK30.ESTABID
                    AND INT2.EMPLID = MNK30.EMPLID
                    AND INT2.EMPL_RCD = MNK30.EMPL_RCD
                    AND INT2.EFFDT = MNK30.EFFDT 
                    AND INT2.PIN_NUM = MNK30.PIN_NUM)
  AND ET.ESTABID = $RC_estabID
End-Sql

!Inserir Tomador de Servico e Risco Sefip 

!Begin-Sql
!UPDATE ps_gpbr_manad_tmp2 A SET (A.GPBR_SEFIP_RIS_LVL,A.GPBR_SERVICE_TAKER) = (SELECT  PAYE30.GPBR_SEFIP_RIS_LVL, PAYE30.GPBR_SERVICE_TAKER
!         FROM ps_gpbr_manad_tmp2 RG301, 
!              PS_GPBR_PAYEE_PA_T PAYE30
!             WHERE RG301.PROCESS_INSTANCE = #prcs_process_instance 
!                   AND RG301.GPBR_MAN_ROW_TYPE = 'K300'
!                   AND PAYE30.PROCESS_INSTANCE =  RG301.PROCESS_INSTANCE 
!                   AND RG301.EMPLID   = PAYE30.EMPLID 
!                   AND RG301.EMPL_RCD = PAYE30.EMPL_RCD 
!                   AND RG301.PROCESS_INSTANCE =  A.PROCESS_INSTANCE 
!                   AND RG301.GPBR_MAN_ROW_TYPE = A.GPBR_MAN_ROW_TYPE 
!                   AND RG301.GP_RPT_KEY = A.GP_RPT_KEY 
!                   AND RG301.ESTABID = A.ESTABID 
!                   AND RG301.EMPLID =  A.EMPLID 
!                   AND RG301.EMPL_RCD = A.EMPL_RCD 
!                   AND RG301.EFFDT = A.EFFDT 
!                   AND RG301.PIN_NUM = A.PIN_NUM )
!  WHERE A.PROCESS_INSTANCE = #prcs_process_instance
!  AND A.GPBR_MAN_ROW_TYPE = 'K300'
!End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP2 COMPUTE STATISTICS
    end-sql
#endif

End-Procedure Row-K300

!**************************************
begin-procedure Set-Other300
#debug show '* Set-Other300'
!**************************************

Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP4
( 
 PROCESS_INSTANCE
,GPBR_MAN_ROW_TYPE
,ESTAB_ID_BRA
,EMPLID
,EMPL_RCD
,EFFDT
,PIN_NUM
,PYMNT_DT
,RUN_TYPE
,PIN_NM
,PIN_TYPE 
,DEPTID
,SEFIP_CATEGORY_BRA
,GPBR_SEFIP_RIS_LVL
,GPBR_SERVICE_TAKER
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID
,GPBR_MAN_EMP_FORM
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
)
SELECT 
 T7.PROCESS_INSTANCE
,T7.GPBR_MAN_ROW_TYPE
,T7.ESTAB_ID_BRA
,T7.EMPLID
,T7.EMPL_RCD
,T7.EFFDT
,T7.PIN_NUM
,T7.PYMNT_DT
,T7.RUN_TYPE
,T7.PIN_NM
,CASE WHEN ET.GPBR_PIN_MAN_NUM <> 0 THEN 'O' ELSE T7.PIN_TYPE END
,T7.DEPTID
,T7.SEFIP_CATEGORY_BRA
,T7.GPBR_SEFIP_RIS_LVL
,T7.GPBR_SERVICE_TAKER
,T7.GPBR_TAKER_INSCR
,T7.GPBR_RUN_TYPE_ID
,T7.GPBR_MAN_EMP_FORM
,T7.CBO_CD_BRA
,T7.DESCR
,T7.GPBR_IT_BASE_TYPE
,T7.GPBR_IT2_BASE_TYPE
,T7.GPBR_INSS_BSE_TYPE
,T7.GPBR_INS2_BSE_TYPE
,T7.GPBR_FAM_ALLOW_IND
,T7.GPBR_INC_TAX_IND
,T7.GPBR_IRRF_BASE_VAL
,T7.GPBR_INSS_BASE_VAL
,T7.CALC_RSLT_VAL
FROM PS_GPBR_MANAD_TMP7 T7 LEFT OUTER JOIN PS_GPBR_MND_OTH_T ET 
                                      ON ET.PROCESS_INSTANCE = #prcs_process_instance 
                                     AND ET.ESTABID = $RC_EstabID 
                                     AND ET.GPBR_PIN_MAN_NUM = T7.PIN_NUM
                                     AND ( ET.GPBR_ELEM_MBR = ' '   
                                        OR ( ET.GPBR_ELEM_MBR = 'M'   
                                        AND ET.BGN_DT <= T7.SLICE_END_DT
                                        AND ( ET.END_DT >= T7.SLICE_END_DT 
                                           OR ET.END_DT IS NULL ) ) )
WHERE T7.PROCESS_INSTANCE = #prcs_process_instance
AND T7.GPBR_MAN_ROW_TYPE = 'K300'
End-Sql

End-Procedure Set-Other300

!**************************************
begin-procedure SumCalend
#debug show '* SumCalend'
!**************************************

!Inserir os grupos de calendarios indentificados em K300

Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP3
(PROCESS_INSTANCE              
,GPBR_MAN_ROW_TYPE
,GP_RPT_KEY                   
,CAL_RUN_ID                   
,CAL_ID                       
,RUN_TYPE                     
,BUSINESS_UNIT                
,PAY_ENTITY   )   
SELECT DISTINCT GDE.PROCESS_INSTANCE              
,'K300'
,GDE.GP_RPT_KEY                   
,GDE.CAL_RUN_ID                   
,GDE.CAL_ID                       
,GDE.RUN_TYPE                     
,GDE.BUSINESS_UNIT                
,GDE.PAY_ENTITY                   
 FROM 
    PS_GPBR_RGST_GDE_T GDE
      WHERE GDE.PROCESS_INSTANCE = #prcs_process_instance
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP3 COMPUTE STATISTICS
    end-sql
#endif

End-Procedure SumCalend

!**************************************
begin-procedure Adjust-K300
#debug show '* Adjust-K300'
!**************************************

!*** K300 Adjust SQL #1 - K300 - Get into TMP4 all Run Type Ids <> 6
#debug show '* Adjust-K300 - SQL #1'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP7
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD           
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
,SLICE_BGN_DT
,SLICE_END_DT
)
 select distinct 
 TK2_300.PROCESS_INSTANCE
,TK2_300.GPBR_MAN_ROW_TYPE
,TK1_300.ESTAB_ID_BRA
,TK2_300.EMPLID
,TK2_300.EMPL_RCD
,TK2_300.EFFDT
,TK2_300.PIN_NUM
,TK2_300.PYMNT_DT
,TK2_300.RUN_TYPE
,PIN300.PIN_NM
,CASE WHEN PIN300.PIN_TYPE = 'DD' THEN 'D' WHEN PIN300.PIN_TYPE = 'ER' THEN 'P' ELSE '0' END
,TK2_300.DEPTID
,' '
,' ' 
,COALESCE(SER_300.GPBR_SERVICE_TAKER,' ')
,COALESCE(SER_300.GPBR_TAKER_INSCR,' ')  
,TK2_300.GPBR_RUN_TYPE_ID
,TK1_300.GPBR_MAN_EMP_FORM
,' '
,' '
,COALESCE(IT300.GPBR_IT_BASE_TYPE,'3')   
,COALESCE(AC300.GPBR_IT_BASE_TYPE,'3')   
,COALESCE(IN300.GPBR_INSS_BSE_TYPE,'8')  
,COALESCE(ACN300.GPBR_INSS_BSE_TYPE,'8') 
,0
,0
,0
,0
,TK2_300.CALC_RSLT_VAL
,TK2_300.SLICE_BGN_DT
,TK2_300.SLICE_END_DT
FROM  PS_GPBR_MANAD_TMP2 TK2_300 LEFT OUTER JOIN PS_GPBR_SER_TAK_TM SER_300 ON SER_300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.GPBR_SERVICE_TAKER =  SER_300.GPBR_SERVICE_TAKER 
                                 LEFT OUTER JOIN PS_GPBR_K300_IT_T IT300 ON IT300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = IT300.ESTABID AND TK2_300.EMPLID = IT300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = IT300.EMPL_RCD AND TK2_300.GP_RPT_KEY = IT300.GP_RPT_KEY AND TK2_300.PIN_NUM = IT300.PIN_NUM 
                                 LEFT OUTER JOIN PS_GPBR_K300_INS_T IN300 ON IN300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = IN300.ESTABID AND TK2_300.EMPLID = IN300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = IN300.EMPL_RCD AND TK2_300.GP_RPT_KEY = IN300.GP_RPT_KEY AND TK2_300.PIN_NUM = IN300.PIN_NUM 
                                 LEFT OUTER JOIN PS_GPBR_ACM_IT_T AC300 ON AC300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = AC300.ESTABID AND TK2_300.EMPLID = AC300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = AC300.EMPL_RCD AND TK2_300.GP_RPT_KEY = AC300.GP_RPT_KEY AND TK2_300.PIN_NUM = AC300.PIN_NUM 
                                 LEFT OUTER JOIN PS_GPBR_ACM_INSS_T ACN300 ON ACN300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = ACN300.ESTABID AND TK2_300.EMPLID = ACN300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = ACN300.EMPL_RCD AND TK2_300.GP_RPT_KEY = ACN300.GP_RPT_KEY AND TK2_300.PIN_NUM = ACN300.PIN_NUM
    , PS_GPBR_MANAD_TMP1 TK1_300
    , PS_GP_PIN PIN300
    , PS_GPBR_CENT_ESTAB CENT
WHERE TK2_300.PROCESS_INSTANCE = #prcs_process_instance  
  AND TK2_300.GPBR_MAN_ROW_TYPE = 'K300'
  AND TK1_300.PROCESS_INSTANCE = #prcs_process_instance  
  AND CENT.PROCESS_INSTANCE = #prcs_process_instance
  AND CENT.CENTR_ESTABID_BRA = $RC_estabID 
  AND TK1_300.GPBR_MAN_ROW_TYPE = '0000'
  AND TK2_300.ESTABID = TK1_300.ESTABID
  AND PIN300.PIN_NUM = TK2_300.PIN_NUM
  AND TK2_300.ESTABID = CENT.ESTABID 
  AND TK2_300.GPBR_RUN_TYPE_ID <> '6'
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP4 COMPUTE STATISTICS
    end-sql
#endif

BEGIN-SELECT
count(*) &Check36

FROM PS_GPBR_MANAD_TMP4 
WHERE GPBR_MAN_ROW_TYPE = 'K300' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

If &Check36 <> &Count300

!*** K300 Adjust SQL #2 - K300 - Get into TMP5 all Run Type Ids = 6 for possible further work
#debug show '* Adjust-K300 - SQL #2'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP5
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD   
,GP_RPT_KEY
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
,SLICE_BGN_DT
,SLICE_END_DT
)
 select distinct 
 TK2_300.PROCESS_INSTANCE
,TK2_300.GPBR_MAN_ROW_TYPE
,TK1_300.ESTAB_ID_BRA
,TK2_300.EMPLID
,TK2_300.EMPL_RCD
,TK2_300.GP_RPT_KEY
,TK2_300.EFFDT
,TK2_300.PIN_NUM
,TK2_300.PYMNT_DT
,TK2_300.RUN_TYPE
,PIN300.PIN_NM
,CASE WHEN PIN300.PIN_TYPE = 'DD' THEN 'D' WHEN PIN300.PIN_TYPE = 'ER' THEN 'P' ELSE '0' END
,TK2_300.DEPTID
,' '
,' ' 
,COALESCE(SER_300.GPBR_SERVICE_TAKER,' ')
,COALESCE(SER_300.GPBR_TAKER_INSCR,' ')  
,TK2_300.GPBR_RUN_TYPE_ID
,TK1_300.GPBR_MAN_EMP_FORM
,' '
,' '
,COALESCE(IT300.GPBR_IT_BASE_TYPE,'3')   
,COALESCE(AC300.GPBR_IT_BASE_TYPE,'3')   
,COALESCE(IN300.GPBR_INSS_BSE_TYPE,'8')  
,COALESCE(ACN300.GPBR_INSS_BSE_TYPE,'8') 
,0
,0
,0
,0
,TK2_300.CALC_RSLT_VAL
,TK2_300.SLICE_BGN_DT
,TK2_300.SLICE_END_DT
FROM  PS_GPBR_MANAD_TMP2 TK2_300 LEFT OUTER JOIN PS_GPBR_SER_TAK_TM SER_300 ON SER_300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.GPBR_SERVICE_TAKER =  SER_300.GPBR_SERVICE_TAKER 
                                 LEFT OUTER JOIN PS_GPBR_K300_IT_T IT300 ON IT300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = IT300.ESTABID AND TK2_300.EMPLID = IT300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = IT300.EMPL_RCD AND TK2_300.GP_RPT_KEY = IT300.GP_RPT_KEY AND TK2_300.PIN_NUM = IT300.PIN_NUM 
                                 LEFT OUTER JOIN PS_GPBR_K300_INS_T IN300 ON IN300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = IN300.ESTABID AND TK2_300.EMPLID = IN300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = IN300.EMPL_RCD AND TK2_300.GP_RPT_KEY = IN300.GP_RPT_KEY AND TK2_300.PIN_NUM = IN300.PIN_NUM 
                                 LEFT OUTER JOIN PS_GPBR_ACM_IT_T AC300 ON AC300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = AC300.ESTABID AND TK2_300.EMPLID = AC300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = AC300.EMPL_RCD AND TK2_300.GP_RPT_KEY = AC300.GP_RPT_KEY AND TK2_300.PIN_NUM = AC300.PIN_NUM 
                                 LEFT OUTER JOIN PS_GPBR_ACM_INSS_T ACN300 ON ACN300.PROCESS_INSTANCE = #prcs_process_instance AND TK2_300.ESTABID = ACN300.ESTABID AND TK2_300.EMPLID = ACN300.EMPLID 
                                      AND  TK2_300.EMPL_RCD = ACN300.EMPL_RCD AND TK2_300.GP_RPT_KEY = ACN300.GP_RPT_KEY AND TK2_300.PIN_NUM = ACN300.PIN_NUM 
    , PS_GPBR_MANAD_TMP1 TK1_300
    , PS_GP_PIN PIN300
    , PS_GPBR_CENT_ESTAB CENT
WHERE TK2_300.PROCESS_INSTANCE = #prcs_process_instance  
  AND TK2_300.GPBR_MAN_ROW_TYPE = 'K300'
  AND TK1_300.PROCESS_INSTANCE = #prcs_process_instance  
  AND CENT.PROCESS_INSTANCE = #prcs_process_instance
  AND CENT.CENTR_ESTABID_BRA = $RC_estabID 
  AND TK1_300.GPBR_MAN_ROW_TYPE = '0000'
  AND TK2_300.ESTABID = TK1_300.ESTABID
  AND PIN300.PIN_NUM = TK2_300.PIN_NUM
  AND TK2_300.ESTABID = CENT.ESTABID 
  AND TK2_300.GPBR_RUN_TYPE_ID = '6'
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP5 COMPUTE STATISTICS
    end-sql
#endif


!*** K300 Adjust SQL #3 - K300 - Get into TMP4 all Run Type Ids = 6 (from TMP5) that won't need further renumbering
#debug show '* Adjust-K300 - SQL #3'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP7
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD           
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
,SLICE_BGN_DT
,SLICE_END_DT
)
Select
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP5.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
,SUM(TMP5.GPBR_IRRF_BASE_VAL)
,SUM(TMP5.GPBR_INSS_BASE_VAL)
,SUM(TMP5.CALC_RSLT_VAL)
,TMP5.SLICE_BGN_DT
,TMP5.SLICE_END_DT

FROM PS_GPBR_MANAD_TMP5 TMP5
  WHERE PROCESS_INSTANCE = #prcs_process_instance
    AND GPBR_MAN_ROW_TYPE  = 'K300'
AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_MANAD_TMP6 T6
        WHERE T6.PROCESS_INSTANCE = #prcs_process_instance 
         AND T6.GPBR_MAN_ROW_TYPE  = 'K250'
         AND T6.ESTAB_ID_BRA = TMP5.ESTAB_ID_BRA
         AND T6.EMPLID = TMP5.EMPLID
         AND T6.EMPL_RCD = TMP5.EMPL_RCD
         AND T6.EFFDT = TMP5.EFFDT
         AND T6.PYMNT_DT = TMP5.PYMNT_DT
         AND T6.RUN_TYPE = TMP5.RUN_TYPE )
 GROUP BY 
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP5.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
,TMP5.SLICE_BGN_DT
,TMP5.SLICE_END_DT
End-Sql


!*** K300 Adjust SQL #4 - K300 - Get into TMP4 all Run Type Ids = 6 (from TMP5) that needed further renumbering or merging - Using TMP6 loaded for K250
#debug show '* Adjust-K300 - SQL #4'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP7
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD           
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
,SLICE_BGN_DT
,SLICE_END_DT
)
SELECT 
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP6.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
,TMP5.GPBR_IRRF_BASE_VAL
,TMP5.GPBR_INSS_BASE_VAL
,sum(TMP5.CALC_RSLT_VAL)
,TMP5.SLICE_BGN_DT
,TMP5.SLICE_END_DT

FROM PS_GPBR_MANAD_TMP5 TMP5
    ,PS_GPBR_MANAD_TMP6 TMP6
  WHERE TMP5.PROCESS_INSTANCE = #prcs_process_instance 
    AND TMP5.GPBR_MAN_ROW_TYPE = 'K300'
    AND TMP6.PROCESS_INSTANCE = #prcs_process_instance
    AND TMP6.GPBR_MAN_ROW_TYPE = 'K250'
    AND TMP6.ESTAB_ID_BRA = TMP5.ESTAB_ID_BRA       
    AND TMP6.EMPLID = TMP5.EMPLID             
    AND TMP6.EMPL_RCD = TMP5.EMPL_RCD    
    AND TMP6.GP_RPT_KEY = TMP5.GP_RPT_KEY
    AND TMP6.EFFDT = TMP5.EFFDT              
    AND TMP6.PYMNT_DT = TMP5.PYMNT_DT           
    AND TMP6.RUN_TYPE = TMP5.RUN_TYPE
 GROUP BY 
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP6.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
,TMP5.GPBR_IRRF_BASE_VAL
,TMP5.GPBR_INSS_BASE_VAL
,TMP5.SLICE_BGN_DT
,TMP5.SLICE_END_DT
End-Sql


do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP7 COMPUTE STATISTICS
    end-sql
#endif

End-If

End-Procedure Adjust-K300

!**************************************
begin-procedure Row-K050
#debug show '* Row-K050'
!************************************** 

Begin-Select
PAR.GPBR_MND_PERONLY

    Let $PerOnlyFlg = &PAR.GPBR_MND_PERONLY
  
FROM PS_GPBR_MANAD_PARM PAR
   WHERE PAR.ESTABID = $RC_estabID
     AND PAR.EFFDT = ( SELECT MAX(PAR2.EFFDT) 
                        FROM PS_GPBR_MANAD_PARM PAR2 
                       WHERE PAR2.ESTABID = PAR.ESTABID 
                         AND PAR2.EFFDT <= $AsOfToday
                         AND PAR2.EFF_STATUS = 'A')
End-Select




If $PerOnlyFlg = 'N'

   Let $K050EffDt = ' AND J050.EFFDT = (SELECT MAX(J1.EFFDT) FROM PS_JOB J1 WHERE J1.EMPLID = J050.EMPLID '
   Let $K050EffDt = $K050EffDt || ' AND J1.EMPL_RCD = J050.EMPL_RCD AND J1.EFFDT <= ' || '''' || $RC_DateTo || ''''
   Let $K050EffDt = $K050EffDt || ' AND J1.ACTION = B.ACTION AND J1.ACTION_REASON = B.ACTION_REASON) '
   
   Do MainSQL-K050

else

   Let $K050EffDt = ' AND J050.EFFDT = (SELECT MAX(J1.EFFDT) FROM PS_JOB J1 WHERE J1.EMPLID = J050.EMPLID '
   Let $K050EffDt = $K050EffDt || ' AND J1.EMPL_RCD = J050.EMPL_RCD AND J1.EFFDT < ' || '''' || $RC_DateFrom || ''''
   Let $K050EffDt = $K050EffDt || ' AND EXISTS (SELECT ''X'' FROM PS_LEG_MOV_DET_BRA LEGIN WHERE LEGIN.PROCESS_TYPE_BRA = ''50'' AND LEGIN.EFFDT = A.EFFDT '
   Let $K050EffDt = $K050EffDt || ' AND LEGIN.ACTION = J1.ACTION AND LEGIN.ACTION_REASON = J1.ACTION_REASON AND LEGIN.MANAD_HIRACTN_BRA = ''Y'' ) ) '

   Do MainSQL-K050

   Let $K050EffDt = ' AND J050.EFFDT BETWEEN ' || '''' || $RC_DateFrom || '''' || ' AND ' || '''' || $RC_DateTo || ''''

   Do MainSQL-K050

end-if

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP2 COMPUTE STATISTICS
    end-sql

#endif

End-Procedure Row-K050

!**************************************
begin-procedure MainSQL-K050
#debug show '* MainSQL-K050'
!************************************** 
#debug show '* $K050EffDt ' $K050EffDt
#ifdef MICROSOFT !Block for MS SQL Databases
     
 Begin-Sql
 INSERT INTO PS_GPBR_MANAD_TMP2 ( PROCESS_INSTANCE 
 ,GPBR_MAN_ROW_TYPE  
 ,GP_RPT_KEY 
 ,ESTABID
 ,DEPTID
 ,SETID_DEPT
 ,EMPLID
 ,EMPL_RCD
 ,EFFDT
 ,HIRE_DT
 ,TERMINATION_DT
 ,GPBR_MAN_TEXT
 ,ROW_COUNT
 ,PIN_NUM
 ,BIRTHDATE
 ,EMPL_CLASS
 ,SEFIP_CATEGORY_BRA
 ,RUN_TYPE
 ,CALC_RSLT_VAL
 ,GPBR_SEFIP_RIS_LVL
 ,GPBR_SERVICE_TAKER
 ,PYMNT_DT
 ,BUSINESS_UNIT
 ,PAY_ENTITY
 ,GPBR_RUN_TYPE_ID
 ,SLICE_BGN_DT
 ,SLICE_END_DT
  ) 
 Select DISTINCT
 #prcs_process_instance
 ,$MANADRowType 
 ,concat(T50.EMPLID , T50.EMPL_RCD ,CASE WHEN J050.TERMINATION_DT IS NOT NULL THEN J050.TERMINATION_DT ELSE J050.EFFDT END)
 ,J050.ESTABID 
 ,$deptID
 ,$setID
 ,T50.EMPLID
 ,T50.EMPL_RCD
 ,J050.EFFDT  
 ,J050.HIRE_DT
 ,J050.TERMINATION_DT 
 ,' '
 ,#rowCount
 ,#pinNum
 ,P5.BIRTHDATE
 ,J050.EMPL_CLASS
 ,JR050.SEFIP_CATEGORY_BRA
 ,' '
 ,0
 ,' '
 ,' '
 ,Null
 ,' '
 ,' '
 ,' '
 ,NULL
 ,NULL
 FROM PS_JOB J050 
   ,PS_GPBR_MANAD_TMP2 T50
   ,PS_PERSON P5 
   ,PS_GPBR_MANAD_TMP1 TM50
   ,PS_JOB_JR JR050
   ,PS_LEG_MOV_COD_BRA A
   ,PS_LEG_MOV_DET_BRA B
  WHERE T50.PROCESS_INSTANCE = #prcs_process_instance
    AND TM50.PROCESS_INSTANCE = #prcs_process_instance
    AND T50.EMPLID = P5.EMPLID 
    AND J050.ESTABID = TM50.ESTABID
    AND T50.EMPLID  = J050.EMPLID
    AND T50.EMPL_RCD = J050.EMPL_RCD
    [$K050EffDt]
    AND J050.EFFSEQ = (SELECT MAX(J2.EFFSEQ) 
                       FROM PS_JOB J2 
                      WHERE J2.EMPLID = J050.EMPLID
                       AND J2.EMPL_RCD = J050.EMPL_RCD 
                       AND J2.EFFDT    = J050.EFFDT ) 
    AND J050.EMPLID = JR050.EMPLID
    AND J050.EMPL_RCD = JR050.EMPL_RCD
    AND J050.EFFDT = JR050.EFFDT
    AND J050.EFFSEQ = JR050.EFFSEQ
    AND T50.GPBR_MAN_ROW_TYPE = 'K250'  
    AND TM50.GPBR_MAN_ROW_TYPE = '0000'    
    AND A.PROCESS_TYPE_BRA = '50'
    AND A.EFFDT = (SELECT MAX(EFFDT) 
                       FROM PS_LEG_MOV_COD_BRA 
                      WHERE PROCESS_TYPE_BRA = A.PROCESS_TYPE_BRA 
                        AND EFFDT <= $RC_DateTo)
    AND B.PROCESS_TYPE_BRA = A.PROCESS_TYPE_BRA
    AND B.EFFDT = A.EFFDT
    AND B.ACTION = J050.ACTION
    AND B.ACTION_REASON = J050.ACTION_REASON
 End-Sql
#endif


#IFNDEF MICROSOFT !Block for Non - MS SQL Databaseselse 
 Begin-Sql
 INSERT INTO PS_GPBR_MANAD_TMP2 ( PROCESS_INSTANCE 
 ,GPBR_MAN_ROW_TYPE  
 ,GP_RPT_KEY 
 ,ESTABID
 ,DEPTID
 ,SETID_DEPT
 ,EMPLID
 ,EMPL_RCD
 ,EFFDT
 ,HIRE_DT
 ,TERMINATION_DT
 ,GPBR_MAN_TEXT
 ,ROW_COUNT
 ,PIN_NUM
 ,BIRTHDATE
 ,EMPL_CLASS
 ,SEFIP_CATEGORY_BRA
 ,RUN_TYPE
 ,CALC_RSLT_VAL
 ,GPBR_SEFIP_RIS_LVL
 ,GPBR_SERVICE_TAKER
 ,PYMNT_DT
 ,BUSINESS_UNIT
 ,PAY_ENTITY
 ,GPBR_RUN_TYPE_ID
 ,SLICE_BGN_DT
 ,SLICE_END_DT
 ) 
 Select DISTINCT
 #prcs_process_instance
 ,$MANADRowType 
 ,T50.EMPLID || T50.EMPL_RCD || CASE WHEN J050.TERMINATION_DT IS NOT NULL THEN J050.TERMINATION_DT ELSE J050.EFFDT END
 ,J050.ESTABID 
 ,$deptID
 ,$setID
 ,T50.EMPLID
 ,T50.EMPL_RCD
 ,J050.EFFDT  
 ,J050.HIRE_DT
 ,J050.TERMINATION_DT 
 ,' '
 ,#rowCount
 ,#pinNum
 ,P5.BIRTHDATE
 ,J050.EMPL_CLASS
 ,JR050.SEFIP_CATEGORY_BRA
 ,' '
 ,0
 ,' '
 ,' '
 ,Null
 ,' '
 ,' '
 ,' '
 ,NULL
 ,NULL
 FROM PS_JOB J050 
   ,PS_GPBR_MANAD_TMP2 T50
   ,PS_PERSON P5 
   ,PS_GPBR_MANAD_TMP1 TM50
   ,PS_JOB_JR JR050
   ,PS_LEG_MOV_COD_BRA A
   ,PS_LEG_MOV_DET_BRA B
  WHERE T50.PROCESS_INSTANCE = #prcs_process_instance
    AND TM50.PROCESS_INSTANCE = #prcs_process_instance
    AND T50.EMPLID = P5.EMPLID 
    AND J050.ESTABID = TM50.ESTABID
    AND T50.EMPLID  = J050.EMPLID
    AND T50.EMPL_RCD = J050.EMPL_RCD
    [$K050EffDt]
    AND J050.EFFSEQ = (SELECT MAX(J2.EFFSEQ) 
                       FROM PS_JOB J2 
                      WHERE J2.EMPLID = J050.EMPLID
                         AND J2.EMPL_RCD = J050.EMPL_RCD 
                       AND J2.EFFDT    = J050.EFFDT ) 
    AND J050.EMPLID = JR050.EMPLID
    AND J050.EMPL_RCD = JR050.EMPL_RCD
    AND J050.EFFDT = JR050.EFFDT
    AND J050.EFFSEQ = JR050.EFFSEQ
    AND T50.GPBR_MAN_ROW_TYPE = 'K250'  
    AND TM50.GPBR_MAN_ROW_TYPE = '0000'    
    AND A.PROCESS_TYPE_BRA = '50'
    AND A.EFFDT = (SELECT MAX(EFFDT) 
                       FROM PS_LEG_MOV_COD_BRA 
                      WHERE PROCESS_TYPE_BRA = A.PROCESS_TYPE_BRA 
                        AND EFFDT <= $RC_DateTo)
    AND B.PROCESS_TYPE_BRA = A.PROCESS_TYPE_BRA
    AND B.EFFDT = A.EFFDT
    AND B.ACTION = J050.ACTION
    AND B.ACTION_REASON = J050.ACTION_REASON
 End-Sql
#endif

End-Procedure MainSQL-K050

!**************************************
begin-procedure Row-K250
#debug show '* Row-K250'
!************************************** 

   Let $hireDt = ''
   Let $terminationDt = ''

Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP2 ( 
 PROCESS_INSTANCE               
,GPBR_MAN_ROW_TYPE              
,GP_RPT_KEY                     
,ESTABID                        
,DEPTID                         
,SETID_DEPT                     
,EMPLID                         
,EMPL_RCD                       
,EFFDT                          
,HIRE_DT                        
,TERMINATION_DT                 
,GPBR_MAN_TEXT                  
,ROW_COUNT                      
,PIN_NUM                        
,BIRTHDATE                      
,EMPL_CLASS                     
,SEFIP_CATEGORY_BRA             
,RUN_TYPE                       
,CALC_RSLT_VAL                  
,GPBR_SEFIP_RIS_LVL             
,GPBR_SERVICE_TAKER             
,PYMNT_DT
,BUSINESS_UNIT
,PAY_ENTITY
,GPBR_RUN_TYPE_ID
,SLICE_BGN_DT
,SLICE_END_DT
) 
Select DISTINCT
#prcs_process_instance
,$MANADRowType
,RG25.GP_RPT_KEY
,RG25.ESTABID     
,RG25.DEPTID 
,RG25.SETID_DEPT 
,RG25.EMPLID 
,RG25.EMPL_RCD 
,RG25.PRD_END_DT 
,$hireDt
,$terminationDt
,' '
,#rowCount
,#pinNum
,Null
,' '
,' '
,RG25.RUN_TYPE
,0
,' '
,' '
,RG25.PYMT_DT
,RG25.BUSINESS_UNIT 
,RG25.PAY_ENTITY
,PK250.GPBR_RUN_TYPE_ID
,NULL
,NULL
FROM PS_GPBR_RGST_GDE_T RG25 
     ,PS_GPBR_MANAD_RUNT PK250 
     ,PS_DEPT_TBL D250 
     ,PS_GPBR_MANAD_TMP1 T250
     ,PS_GPBR_CENT_ESTAB CENT
 WHERE RG25.PROCESS_INSTANCE = #prcs_process_instance
   AND T250.PROCESS_INSTANCE = #prcs_process_instance
   AND D250.SETID  =  RG25.SETID_DEPT
   AND D250.DEPTID = RG25.DEPTID 
   AND D250.EFFDT  = ( SELECT MAX(D2_250.EFFDT) FROM PS_DEPT_TBL D2_250
                      WHERE D2_250.DEPTID = D250.DEPTID 
                        AND D2_250.SETID  = D250.SETID
                        AND D2_250.EFFDT <=  $RC_DateTo)
   AND PK250.RUN_TYPE = RG25.RUN_TYPE  
   AND PK250.ESTABID  = CENT.CENTR_ESTABID_BRA
   AND T250.ESTABID = RG25.ESTABID
   AND T250.GPBR_MAN_ROW_TYPE = '0000'
   AND PK250.EFFDT = ( SELECT MAX(P2_PK250.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM P2_PK250  
                  WHERE P2_PK250.ESTABID = PK250.ESTABID 
                  AND P2_PK250.EFFDT <= $AsOfToday
                  AND P2_PK250.EFF_STATUS = 'A' )
   AND CENT.PROCESS_INSTANCE = #prcs_process_instance
   AND CENT.CENTR_ESTABID_BRA = $RC_estabID
   AND CENT.ESTABID = RG25.ESTABID

End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP2 COMPUTE STATISTICS
    end-sql

#endif

End-Procedure Row-K250

!**************************************
begin-procedure Adjust-K250
#debug show '* Adjust-K250'
!**************************************

!*** K250 Adjust SQL #1 - K250 - Get into TMP4 all Run Type Ids <> 6
#debug show '* Adjust-K250 - SQL #1'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP4
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD           
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
)
Select
 TK250.PROCESS_INSTANCE
,TK250.GPBR_MAN_ROW_TYPE
,T1K250.ESTAB_ID_BRA
,TK250.EMPLID
,TK250.EMPL_RCD
,TK250.EFFDT
,0
,TK250.PYMNT_DT
,TK250.RUN_TYPE
,' '
,' '
,TK250.DEPTID
,' '
,COALESCE(STK250.GPBR_SEFIP_RIS_LVL,'00')  
,COALESCE(STK250.GPBR_SERVICE_TAKER,' ') 
,COALESCE(STK250_1.GPBR_TAKER_INSCR,' ')
,TK250.GPBR_RUN_TYPE_ID
,T1K250.GPBR_MAN_EMP_FORM
,JK250.CBO_CD_BRA
,JK250.DESCR
,' '
,' '
,' '
,' '
,COALESCE(DTK250.GPBR_FAM_ALLOW_IND,0)    
,COALESCE(DTK250.GPBR_INC_TAX_IND,0)     
,COALESCE(ITK250.CALC_RSLT_VAL,0)  
,COALESCE(INTK250.CALC_RSLT_VAL,0) 
,0

FROM PS_GPBR_MANAD_TMP1 T1K250
    ,PS_GPBR_MANAD_TMP2 TK250 LEFT OUTER JOIN PS_GPBR_PAYEE_PA_T STK250 ON STK250.PROCESS_INSTANCE = #prcs_process_instance AND STK250.EMPLID = TK250.EMPLID AND TK250.EMPL_RCD = STK250.EMPL_RCD
                              LEFT OUTER JOIN PS_GPBR_DEPEN_TMP DTK250 ON DTK250.PROCESS_INSTANCE = #prcs_process_instance AND DTK250.EMPLID = TK250.EMPLID AND DTK250.EMPL_RCD = TK250.EMPL_RCD 
                                   AND DTK250.GP_RPT_KEY = TK250.GP_RPT_KEY AND DTK250.PYMT_DT = TK250.PYMNT_DT
                              LEFT OUTER JOIN PS_GPBR_RSLT_IT_T ITK250 ON ITK250.PROCESS_INSTANCE = #prcs_process_instance AND ITK250.EMPLID = TK250.EMPLID AND ITK250.EMPL_RCD = TK250.EMPL_RCD 
                                   AND ITK250.GP_RPT_KEY = TK250.GP_RPT_KEY
                              LEFT OUTER JOIN PS_GPBR_RSLT_INS_T INTK250 ON INTK250.PROCESS_INSTANCE = #prcs_process_instance AND INTK250.EMPLID = TK250.EMPLID AND INTK250.EMPL_RCD = TK250.EMPL_RCD 
                                   AND INTK250.GP_RPT_KEY = TK250.GP_RPT_KEY
                              LEFT OUTER JOIN PS_GPBR_SER_TAK_TM STK250_1 ON STK250_1.PROCESS_INSTANCE = #prcs_process_instance AND TK250.GPBR_SERVICE_TAKER =  STK250_1.GPBR_SERVICE_TAKER
   , PS_GPBR_JOBDAT_TMP JK250
   , PS_GPBR_CENT_ESTAB CENT
WHERE T1K250.PROCESS_INSTANCE = #prcs_process_instance 
  AND TK250.PROCESS_INSTANCE = #prcs_process_instance 
  AND JK250.PROCESS_INSTANCE = #prcs_process_instance 
  AND CENT.PROCESS_INSTANCE = #prcs_process_instance
  AND CENT.CENTR_ESTABID_BRA = $RC_estabID 
  AND TK250.GPBR_MAN_ROW_TYPE = 'K250'
  AND TK250.ESTABID = CENT.ESTABID
  AND TK250.GP_RPT_KEY = JK250.GP_RPT_KEY
  AND T1K250.GPBR_MAN_ROW_TYPE = '0000'
  AND TK250.ESTABID = T1K250.ESTABID
  AND TK250.EMPLID = JK250.EMPLID
  AND TK250.EMPL_RCD = JK250.EMPL_RCD
  AND TK250.ESTABID = JK250.ESTABID  
  AND TK250.GPBR_RUN_TYPE_ID <> '6'
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP4 COMPUTE STATISTICS
    end-sql
#endif

BEGIN-SELECT
count(*) &Check256

FROM PS_GPBR_MANAD_TMP4 
WHERE GPBR_MAN_ROW_TYPE = 'K250' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

If &Check256 <> &Count250

!*** K250 Adjust SQL #2 - K250 - Get into TMP5 all Run Type Ids = 6 for possible further work
#debug show '* Adjust-K250 - SQL #2'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP5
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD   
,GP_RPT_KEY
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
,SLICE_BGN_DT
,SLICE_END_DT
)
Select
 TK250.PROCESS_INSTANCE
,TK250.GPBR_MAN_ROW_TYPE
,T1K250.ESTAB_ID_BRA
,TK250.EMPLID
,TK250.EMPL_RCD
,TK250.GP_RPT_KEY
,TK250.EFFDT
,0
,TK250.PYMNT_DT
,TK250.RUN_TYPE
,' '
,' '
,TK250.DEPTID
,' '
,COALESCE(STK250.GPBR_SEFIP_RIS_LVL,'00')  
,COALESCE(STK250.GPBR_SERVICE_TAKER,' ') 
,COALESCE(STK250_1.GPBR_TAKER_INSCR,' ')
,TK250.GPBR_RUN_TYPE_ID
,T1K250.GPBR_MAN_EMP_FORM
,JK250.CBO_CD_BRA
,JK250.DESCR
,' '
,' '
,' '
,' '
,COALESCE(DTK250.GPBR_FAM_ALLOW_IND,0)    
,COALESCE(DTK250.GPBR_INC_TAX_IND,0)     
,COALESCE(ITK250.CALC_RSLT_VAL,0)  
,COALESCE(INTK250.CALC_RSLT_VAL,0) 
,0
,TK250.SLICE_BGN_DT
,TK250.SLICE_END_DT
FROM PS_GPBR_MANAD_TMP1 T1K250
    ,PS_GPBR_MANAD_TMP2 TK250 LEFT OUTER JOIN PS_GPBR_PAYEE_PA_T STK250 ON STK250.PROCESS_INSTANCE = #prcs_process_instance AND STK250.EMPLID = TK250.EMPLID AND TK250.EMPL_RCD = STK250.EMPL_RCD
                              LEFT OUTER JOIN PS_GPBR_DEPEN_TMP DTK250 ON DTK250.PROCESS_INSTANCE = #prcs_process_instance AND DTK250.EMPLID = TK250.EMPLID AND DTK250.EMPL_RCD = TK250.EMPL_RCD 
                                   AND DTK250.GP_RPT_KEY = TK250.GP_RPT_KEY AND DTK250.PYMT_DT = TK250.PYMNT_DT
                              LEFT OUTER JOIN PS_GPBR_RSLT_IT_T ITK250 ON ITK250.PROCESS_INSTANCE = #prcs_process_instance AND ITK250.EMPLID = TK250.EMPLID AND ITK250.EMPL_RCD = TK250.EMPL_RCD 
                                   AND ITK250.GP_RPT_KEY = TK250.GP_RPT_KEY
                              LEFT OUTER JOIN PS_GPBR_RSLT_INS_T INTK250 ON INTK250.PROCESS_INSTANCE = #prcs_process_instance AND INTK250.EMPLID = TK250.EMPLID AND INTK250.EMPL_RCD = TK250.EMPL_RCD 
                                   AND INTK250.GP_RPT_KEY = TK250.GP_RPT_KEY
                              LEFT OUTER JOIN PS_GPBR_SER_TAK_TM STK250_1 ON STK250_1.PROCESS_INSTANCE = #prcs_process_instance AND TK250.GPBR_SERVICE_TAKER =  STK250_1.GPBR_SERVICE_TAKER
   , PS_GPBR_JOBDAT_TMP JK250
   , PS_GPBR_CENT_ESTAB CENT
WHERE T1K250.PROCESS_INSTANCE = #prcs_process_instance 
  AND TK250.PROCESS_INSTANCE = #prcs_process_instance 
  AND JK250.PROCESS_INSTANCE = #prcs_process_instance 
  AND CENT.PROCESS_INSTANCE = #prcs_process_instance
  AND CENT.CENTR_ESTABID_BRA = $RC_estabID 
  AND TK250.GPBR_MAN_ROW_TYPE = 'K250'
  AND TK250.ESTABID = CENT.ESTABID
  AND TK250.GP_RPT_KEY = JK250.GP_RPT_KEY
  AND T1K250.GPBR_MAN_ROW_TYPE = '0000'
  AND TK250.ESTABID = T1K250.ESTABID
  AND TK250.EMPLID = JK250.EMPLID
  AND TK250.EMPL_RCD = JK250.EMPL_RCD
  AND TK250.ESTABID = JK250.ESTABID  
  AND TK250.GPBR_RUN_TYPE_ID = '6'  
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP5 COMPUTE STATISTICS
    end-sql
#endif


!*** K250 Adjust SQL #3 - K250 - Get into TMP4 all Run Type Ids = 6 (from TMP5) that won't need further renumbering
#debug show '* Adjust-K250 - SQL #3'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP4
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD           
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
)
Select
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP5.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
,SUM(TMP5.GPBR_IRRF_BASE_VAL)
,SUM(TMP5.GPBR_INSS_BASE_VAL)
,SUM(TMP5.CALC_RSLT_VAL)

FROM PS_GPBR_MANAD_TMP5 TMP5
  WHERE PROCESS_INSTANCE = #prcs_process_instance
   AND 0 = ( SELECT COUNT(*) FROM PS_GPBR_MANAD_TMP5 T5
       WHERE T5.PROCESS_INSTANCE = #prcs_process_instance 
         AND T5.GPBR_MAN_ROW_TYPE  = 'K250'
         AND T5.ESTAB_ID_BRA = TMP5.ESTAB_ID_BRA
         AND T5.EMPLID = TMP5.EMPLID
         AND T5.EMPL_RCD = TMP5.EMPL_RCD
         AND T5.EFFDT = TMP5.EFFDT
         AND T5.PIN_NUM = TMP5.PIN_NUM
         AND T5.PYMNT_DT <> TMP5.PYMNT_DT
         AND T5.RUN_TYPE = TMP5.RUN_TYPE )
 GROUP BY 
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP5.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP4 COMPUTE STATISTICS
    end-sql
#endif


!*** K250 Adjust SQL #4 - K250 - Get into TMP6 all Run Type Ids = 6 renumbering 
#debug show '* Adjust-K250 - SQL #4'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP6
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD  
,GP_RPT_KEY
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,GPBR_RUN_TYPE_ID
)
Select
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD    
,TMP5.GP_RPT_KEY
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.GPBR_RUN_TYPE_ID + (SELECT COUNT(*) FROM PS_GPBR_MANAD_TMP5 T5
        WHERE T5.PROCESS_INSTANCE = #prcs_process_instance 
         AND T5.GPBR_MAN_ROW_TYPE  = 'K250'
         AND T5.ESTAB_ID_BRA = TMP5.ESTAB_ID_BRA
         AND T5.EMPLID = TMP5.EMPLID
         AND T5.EMPL_RCD = TMP5.EMPL_RCD
         AND T5.EFFDT = TMP5.EFFDT
         AND T5.PIN_NUM = TMP5.PIN_NUM
         AND T5.PYMNT_DT < TMP5.PYMNT_DT
         AND T5.RUN_TYPE = TMP5.RUN_TYPE)

FROM PS_GPBR_MANAD_TMP5 TMP5
  WHERE PROCESS_INSTANCE = #prcs_process_instance
AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_MANAD_TMP4 T4
        WHERE T4.PROCESS_INSTANCE = #prcs_process_instance 
         AND T4.GPBR_MAN_ROW_TYPE  = 'K250'
         AND T4.ESTAB_ID_BRA = TMP5.ESTAB_ID_BRA
         AND T4.EMPLID = TMP5.EMPLID
         AND T4.EMPL_RCD = TMP5.EMPL_RCD
         AND T4.EFFDT = TMP5.EFFDT
         AND T4.PIN_NUM = TMP5.PIN_NUM
         AND T4.PYMNT_DT = TMP5.PYMNT_DT
         AND T4.RUN_TYPE = TMP5.RUN_TYPE )
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP6 COMPUTE STATISTICS
    end-sql
#endif


!*** K250 Adjust SQL #5 - K250 - Get into TMP4 all Run Type Ids = 6 (from TMP5) that needed further renumbering or merging
#debug show '* Adjust-K250 - SQL #5'
Begin-Sql
INSERT INTO PS_GPBR_MANAD_TMP4
(PROCESS_INSTANCE   
,GPBR_MAN_ROW_TYPE  
,ESTAB_ID_BRA       
,EMPLID             
,EMPL_RCD           
,EFFDT              
,PIN_NUM            
,PYMNT_DT           
,RUN_TYPE 
,PIN_NM
,PIN_TYPE
,DEPTID             
,SEFIP_CATEGORY_BRA 
,GPBR_SEFIP_RIS_LVL 
,GPBR_SERVICE_TAKER 
,GPBR_TAKER_INSCR
,GPBR_RUN_TYPE_ID 
,GPBR_MAN_EMP_FORM 
,CBO_CD_BRA
,DESCR
,GPBR_IT_BASE_TYPE
,GPBR_IT2_BASE_TYPE
,GPBR_INSS_BSE_TYPE
,GPBR_INS2_BSE_TYPE
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
,GPBR_IRRF_BASE_VAL
,GPBR_INSS_BASE_VAL
,CALC_RSLT_VAL
)
SELECT 
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP6.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
,sum(TMP5.GPBR_IRRF_BASE_VAL)
,sum(TMP5.GPBR_INSS_BASE_VAL)
,TMP5.CALC_RSLT_VAL

FROM PS_GPBR_MANAD_TMP5 TMP5
    ,PS_GPBR_MANAD_TMP6 TMP6
  WHERE TMP5.PROCESS_INSTANCE = #prcs_process_instance 
    AND TMP6.PROCESS_INSTANCE = #prcs_process_instance 
    AND TMP6.GPBR_MAN_ROW_TYPE = TMP5.GPBR_MAN_ROW_TYPE  
    AND TMP6.ESTAB_ID_BRA = TMP5.ESTAB_ID_BRA       
    AND TMP6.EMPLID = TMP5.EMPLID             
    AND TMP6.EMPL_RCD = TMP5.EMPL_RCD    
    AND TMP6.GP_RPT_KEY = TMP5.GP_RPT_KEY
    AND TMP6.EFFDT = TMP5.EFFDT              
    AND TMP6.PIN_NUM = TMP5.PIN_NUM            
    AND TMP6.PYMNT_DT = TMP5.PYMNT_DT           
    AND TMP6.RUN_TYPE = TMP5.RUN_TYPE
 GROUP BY 
 TMP5.PROCESS_INSTANCE   
,TMP5.GPBR_MAN_ROW_TYPE  
,TMP5.ESTAB_ID_BRA       
,TMP5.EMPLID             
,TMP5.EMPL_RCD           
,TMP5.EFFDT              
,TMP5.PIN_NUM            
,TMP5.PYMNT_DT           
,TMP5.RUN_TYPE 
,TMP5.PIN_NM
,TMP5.PIN_TYPE
,TMP5.DEPTID             
,TMP5.SEFIP_CATEGORY_BRA 
,TMP5.GPBR_SEFIP_RIS_LVL 
,TMP5.GPBR_SERVICE_TAKER 
,TMP5.GPBR_TAKER_INSCR
,TMP6.GPBR_RUN_TYPE_ID 
,TMP5.GPBR_MAN_EMP_FORM 
,TMP5.CBO_CD_BRA
,TMP5.DESCR
,TMP5.GPBR_IT_BASE_TYPE
,TMP5.GPBR_IT2_BASE_TYPE
,TMP5.GPBR_INSS_BSE_TYPE
,TMP5.GPBR_INS2_BSE_TYPE
,TMP5.GPBR_FAM_ALLOW_IND
,TMP5.GPBR_INC_TAX_IND
,TMP5.CALC_RSLT_VAL
End-Sql

End-If

End-Procedure Adjust-K250

!**************************************
begin-procedure AdjCnt-K250-K300
#debug show '* AdjCnt-K250-K300'
!**************************************

BEGIN-SELECT 
count(*) &Count2504

  Let $estabid = ' '
  Let $MANADRowType = 'K250'
  Let $MANADtext = 'K250'
  Let $GPRptKey = 'K250'
  Let #rowCount = &Count2504
  Do Insert-MANAD-TMP

FROM PS_GPBR_MANAD_TMP4 
WHERE GPBR_MAN_ROW_TYPE = 'K250' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

BEGIN-SELECT 
count(*) &Count3004

  Let $estabid = ' '
  Let $MANADRowType = 'K300'
  Let $MANADtext = 'K300'
  Let $GPRptKey = 'K300'
  Let #rowCount = &Count3004
  Do Insert-MANAD-TMP

FROM PS_GPBR_MANAD_TMP4 
WHERE GPBR_MAN_ROW_TYPE = 'K300' 
AND PROCESS_INSTANCE = #prcs_process_instance
END-SELECT

End-Procedure AdjCnt-K250-K300

!**************************************
begin-procedure Extract-Data-9000
#debug show '* Extract-Data-9000'
!**************************************

Let $MANADRowType = '9001'
if  $K_IND_MOV = '0' or $IND_MOV ='0'
    Let $MANADtext = '0'
else 
    Let $MANADtext = '1'
end-if

Let $GPRptKey = $MANADRowType
Do Insert-MANAD-TMP

write 1 from
    $MANADRowType '|' -
    $MANADtext
     
End-Procedure Extract-Data-9000

!**************************************
begin-procedure Create-Text-0000
#debug show '* Create-Text-0000'
!**************************************

If $CNPJAsoc <> ' '
   let $cnpj = $CNPJAsoc
end-if

Let $MANADtext = $nome || '|' || rtrim($cnpj, ' ')  || '|' || rtrim($CPF, ' ') || '|' || rtrim($CEI, ' ')  || '|' || $NIT  || '|' || $UF  || '|' || $IE  || '|' || $COD_MUN 
Let $MANADtext = $MANADtext || '|' || $IM  || '|' || $SUFRAMA  || '|' || $IND_CENTR || '|' || $DT_INI || '|' || $DT_FIN
Let $MANADtext = $MANADtext || '|003|' || $COD_FIN || '|' || $IND_ED 

End-Procedure Create-Text-0000

!**************************************
begin-procedure Get-Taker-Data
#debug show '* Get-Taker-Data'
!**************************************

Begin-Sql
Insert into PS_GPBR_SER_TAK_TM
(
PROCESS_INSTANCE
,GPBR_SERVICE_TAKER
,GPBR_TAKER_INSCR
,EFFDT
)
SELECT DISTINCT
#prcs_process_instance
,TK1.GPBR_SERVICE_TAKER 
,TK1.GPBR_TAKER_INSCR
,TKE1.EFFDT
FROM PS_GPBR_SERV_TAKER TK1
   , PS_GPBR_ST_ESTABID TKE1
WHERE TKE1.GPBR_SERVICE_TAKER = TK1.GPBR_SERVICE_TAKER 
AND TKE1.EFFDT = TK1.EFFDT
AND TK1.EFFDT = (SELECT MAX(TK21.EFFDT) FROM PS_GPBR_SERV_TAKER TK21 
                 WHERE TK21.GPBR_SERVICE_TAKER = TK1.GPBR_SERVICE_TAKER 
                   AND TK21.EFFDT <= $RC_DateTo 
                   AND TK21.EFF_STATUS = 'A')
End-Sql


do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_SER_TAK_TM COMPUTE STATISTICS
    end-sql

#endif

end-procedure Get-Taker-Data

!**************************************
Begin-Procedure Job-Codes-Lang
#debug show '** Job-Codes-Lang **'
!**************************************

Begin-Sql
Insert into PS_GPBR_JOBCODE_TM
( 
 PROCESS_INSTANCE
,SETID
,JOBCODE
,LANGUAGE_CD
,EFFDT
,DESCR
)
Select
#prcs_process_instance
,JL1.SETID
,JL1.JOBCODE
,JL1.LANGUAGE_CD
,JL1.EFFDT
,JL1.DESCR
FROM PS_JOBCODE_LANG JL1
WHERE JL1.EFFDT = ( SELECT MAX(JC12.EFFDT)  FROM PS_JOBCODE_LANG JC12  WHERE JC12.JOBCODE = JL1.JOBCODE 
                      AND JC12.SETID = JL1.SETID 
                      AND JC12.EFFDT <= $RC_DateTo
                      AND JC12.LANGUAGE_CD = $curr_language_cd
                  )  
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_JOBCODE_TM COMPUTE STATISTICS
    end-sql

#endif

End-Procedure Job-Codes-Lang

!**************************************
Begin-Procedure Get-Employee-Data
#debug show '** Get-Employee-Data **'
!**************************************

Begin-Sql
INSERT INTO PS_GPBR_JOBDAT_TMP
(
 PROCESS_INSTANCE
,EMPLID
,EMPL_RCD
,ESTABID
,GP_RPT_KEY
,DESCR
,JOBCODE
,SETID
,CBO_CD_BRA 
,SEFIP_CATEGORY_BRA  
)
Select DISTINCT
#prcs_process_instance
,J_A.EMPLID
,J_A.EMPL_RCD
,J_A.ESTABID
,K250T_A.GP_RPT_KEY
,CASE WHEN JCRL_A.DESCR IS NULL THEN JCR_A.DESCR ELSE JCRL_A.DESCR END 
,JCR_A.JOBCODE
,JCR_A.SETID
,JR_A.CBO_CD_BRA 
,JR_A.SEFIP_CATEGORY_BRA   
FROM PS_JOB J_A
    ,PS_JOB_JR JR_A
    ,PS_JOBCODE_TBL JCR_A left OUTER JOIN PS_GPBR_JOBCODE_TM JCRL_A 
        ON JCRL_A.PROCESS_INSTANCE = #prcs_process_instance AND JCR_A.JOBCODE = JCRL_A.JOBCODE AND JCR_A.SETID = JCRL_A.SETID AND JCRL_A.LANGUAGE_CD = $curr_language_cd
    ,PS_GPBR_MANAD_TMP2 K250T_A
WHERE K250T_A.PROCESS_INSTANCE = #prcs_process_instance
AND K250T_A.GPBR_MAN_ROW_TYPE = 'K250'
AND J_A.EMPLID = K250T_A.EMPLID 
AND J_A.EMPL_RCD = K250T_A.EMPL_RCD 
and J_A.EFFDT = (select MAX(J1_A.EFFDT) 
               from PS_JOB J1_A 
               where J1_A.EMPLID = J_A.EMPLID 
               and J1_A.EMPL_RCD = J_A.EMPL_RCD
               and J1_A.EFFDT <= K250T_A.EFFDT ) 
and J_A.EFFSEQ = (select MAX(J2_A.EFFSEQ) 
                from PS_JOB J2_A 
                where J2_A.EMPLID = J_A.EMPLID 
                and J2_A.EMPL_RCD = J_A.EMPL_RCD 
                and J2_A.EFFDT    = J_A.EFFDT ) 
AND JR_A.EMPLID = J_A.EMPLID
AND JR_A.EMPL_RCD = J_A.EMPL_RCD
AND JR_A.EFFDT    = J_A.EFFDT
AND JR_A.EFFSEQ   = J_A.EFFSEQ
and JCR_A.SETID  = J_A.SETID_JOBCODE 
and JCR_A.JOBCODE = J_A.JOBCODE 
and JCR_A.EFFDT = (select MAX(JC1_A.EFFDT) 
                 from PS_JOBCODE_TBL JC1_A 
                 where JC1_A.SETID = JCR_A.SETID 
                 and JC1_A.JOBCODE = JCR_A.JOBCODE 
                 and JC1_A.EFFDT <= J_A.EFFDT) 
End-Sql                   


do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_JOBDAT_TMP COMPUTE STATISTICS
    end-sql
#endif

End-Procedure Get-Employee-Data

!**************************************
Begin-Procedure Get-Manad-Parm
#debug show '** Get-Manad-Parm **'
!**************************************

Begin-Sql
Insert Into PS_GPBR_MAN_PARM_T
(
PROCESS_INSTANCE
,ESTABID
,EFFDT
,EFF_STATUS
,GPBR_MAN_EMP_FORM
,GPBR_MAN_GL_IND
,GP_CHFLD_IND
)
Select
#prcs_process_instance
,PARM.ESTABID
,PARM.EFFDT
,PARM.EFF_STATUS
,PARM.GPBR_MAN_EMP_FORM
,PARM.GPBR_MAN_GL_IND
,PARM.GP_CHFLD_IND
From PS_GPBR_MANAD_PARM PARM
WHERE PARM.ESTABID = $RC_estabID 
  AND PARM.EFFDT = (SELECT MAX(PARM2.EFFDT) FROM PS_GPBR_MANAD_PARM PARM2
                     WHERE PARM.ESTABID = PARM2.ESTABID
                                     AND PARM.EFFDT <= $AsOfToday
                       AND PARM.EFF_STATUS = 'A')
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MAN_PARM_T COMPUTE STATISTICS
    end-sql
#endif

Begin-select
COUNT(*) &CountParam

 Let #countparam = &countparam
 
 FROM PS_GPBR_MAN_PARM_T
 WHERE PROCESS_INSTANCE = #prcs_process_instance
End-Select

End-Procedure Get-Manad-Parm

!**************************************
Begin-Procedure Get-Dependent-Data
#debug show '** Get-Dependent-Data **'
!**************************************

Begin-Sql
Insert Into PS_GPBR_DEPEN_TMP 
(
PROCESS_INSTANCE
,EMPLID
,EMPL_RCD
,GP_RPT_KEY
,PYMT_DT
,GPBR_FAM_ALLOW_IND
,GPBR_INC_TAX_IND
)
select
 DEP_50.PROCESS_INSTANCE
,WA.EMPLID
,WA.EMPL_RCD
,DEP_50.GP_RPT_KEY
,DEP_50.PYMT_DT
,SUM(CASE WHEN GPBR_FAM_ALLOW_IND = 1 THEN 1 ELSE 0 END ) 
,SUM(CASE WHEN GPBR_INC_TAX_IND = 1 THEN 1 ELSE 0 END )  
FROM PS_GPBR_DEPEND_WA WA 
   , PS_GPBR_RGST_GDE_T DEP_50
  WHERE DEP_50.PROCESS_INSTANCE = #prcs_process_instance
   AND  WA.EMPLID = DEP_50.EMPLID
   AND  WA.CAL_RUN_ID = DEP_50.CAL_RUN_ID
   AND  WA.EMPL_RCD = DEP_50.EMPL_RCD
   AND  WA.GP_PAYGROUP = DEP_50.GP_PAYGROUP
   AND  WA.CAL_ID = DEP_50.CAL_ID
   AND  WA.ORIG_CAL_RUN_ID = DEP_50.ORIG_CAL_RUN_ID
   AND  WA.RSLT_SEG_NUM = DEP_50.RSLT_SEG_NUM 
   AND  WA.PAYMENT_DT = (SELECT MAX(D.PAYMENT_DT)
                     FROM PS_GPBR_DEPEND_WA  D
                     WHERE D.EMPLID = WA.EMPLID
                     AND D.EMPL_RCD = WA.EMPL_RCD
                     AND D.PAYMENT_DT <= DEP_50.PYMT_DT  ) 
   AND (WA.GPBR_FAM_ALLOW_IND = 1  
          OR WA.GPBR_INC_TAX_IND = 1)
GROUP BY DEP_50.PROCESS_INSTANCE, WA.EMPLID, WA.EMPL_RCD, DEP_50.GP_RPT_KEY, DEP_50.PYMT_DT
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_DEPEN_TMP COMPUTE STATISTICS
    end-sql
#endif

End-Procedure Get-Dependent-Data

!**************************************
begin-procedure Insert-MANAD-TMP
#debug show '* Insert-MANAD-TMP'
#debug show '$GPRptKey:     ' $GPRptKey
#debug show '$MANADtext:    ' $MANADtext
#debug show '$MANADRowType: ' $MANADRowType
#debug show '$estabID:      ' $estabID
#debug show '$GPRptKey:     ' $GPRptKey 
#debug show '$centrEstabID: ' $centrEstabID 
#debug show '$IND_CENTR:    ' $IND_CENTR
#debug show '$estabInscription: ' $estabInscription 
#debug show '#prcs_process_instance     '#prcs_process_instance
#debug show '$MANADRowType     '$MANADRowType
#debug show '$company          '$company
#debug show '$estabID          '$estabID
#debug show '$GPRptKey         '$GPRptKey 
#debug show '$centrEstabID     '$centrEstabID 
#debug show '$IND_CENTR        '$IND_CENTR
#debug show '$CNPJAsoc         '$CNPJAsoc
#debug show '$deptID           '$deptID
#debug show '$GPRptKey:        '$MANADtext
#debug show '#pinNum           '#pinNum
#debug show '$emplFormat       '$emplFormat
#debug show '$#rowCount        '#rowCount
!**************************************

If $company = ''
Let $company = ' '
End-If

Begin-SQL
INSERT INTO PS_GPBR_MANAD_TMP1 ( PROCESS_INSTANCE 
 ,GPBR_MAN_ROW_TYPE 
 ,COMPANY
 ,ESTABID 
 ,GP_RPT_KEY 
 ,CENTR_ESTABID_BRA 
 ,GPBR_MAN_CENTR_IND 
 ,ESTAB_ID_BRA 
 ,GPBR_CNPJ
 ,DEPTID
 ,GPBR_MAN_TEXT
 ,PIN_NUM
 ,GPBR_MAN_EMP_FORM
 ,ROW_COUNT
 ,EFFDT
 ,GL_EXPENSE
,ACCOUNT
,PIN_NM
,GPBR_SERVICE_TAKER
) 
 VALUES
 (#prcs_process_instance
 ,$MANADRowType
 ,$company
 ,$estabID
 ,$GPRptKey 
 ,$centrEstabID 
 ,$IND_CENTR
 ,$estabInscription 
 ,$CNPJAsoc
 ,$deptID
 ,$MANADtext
 ,#pinNum
 ,$emplFormat
 ,#rowCount
 ,NULL
 ,' '
 ,' '
 ,' '
 ,' '
 ) 
End-SQL
#ifndef MICROSOFT
  do Commit-Transaction
#endif


#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_TMP1 COMPUTE STATISTICS
    end-sql

#endif
 
end-procedure Insert-MANAD-TMP

!**************************************
begin-procedure Get-Estab-Data
#debug show '** Get-Estab-Data **'
!**************************************

Let $CNPJ = ' '
Let $CEI = ''
Let $CNPJAsoc = ' '
Let $SUFRAMA = ''
Let $IM = ''
Let $IE = ''
Let $estabAss = ''

Begin-Select
ES.COUNTY_CD_BRA 
E.STATE 
E.DESCR
ES.EFFDT
ES.ESTAB_ASOC_BRA
E.COMPANY
ES.LEGAL_ENT_TYPE_BRA
ES.COMP_INS_TYPE_BRA

    Let $effdt = &ES.EFFDT
    Let $estabAsoc = Rtrim(&ES.ESTAB_ASOC_BRA, ' ')
    Let $company = rtrim(&E.COMPANY, ' ')
    Let $insType = rtrim(&ES.COMP_INS_TYPE_BRA, ' ')
    Let $ResEstabID = $estabID   
    Do Get-Estab-Id
    
    if $company = ''
       Let $company = ' '
    end-if
        
    Do Estab-HeadQuarters
    Do Verify-MANAD-Responsible 
    
    if RTRIM(&ES.LEGAL_ENT_TYPE_BRA, ' ') = 'COM'
       Do Get-Company-Name
    ELSE
       Let $Nome = rtrim(&E.DESCR,' ') 
       do Check-Strings ($Nome , $Nome)
       Do Get-Estab-Lang
    END-IF
    
    Let $UF = &E.STATE 
    Let $COD_MUN = edit(&ES.COUNTY_CD_BRA , '0000000') 
  
FROM PS_ESTAB_TBL E 
    ,PS_ESTAB_TBL_BRA ES 
WHERE E.ESTABID = $estabID
AND E.ESTABID= ES.ESTABID 
AND E.EFFDT = ES.EFFDT 
AND E.EFFDT = ( SELECT MAX(E2.EFFDT) 
                FROM PS_ESTAB_TBL E2 
                WHERE E2.ESTABID = E.ESTABID 
                AND E2.EFFDT <= $RC_DateTo 
                AND E2.EFF_STATUS = 'A' )

End-Select

End-Procedure Get-Estab-Data

!**************************************
begin-procedure Estab-HeadQuarters
#debug show '** Estab-HeadQuarters'
!**************************************

Begin-Select
HE.EFFDT
HE.ESTABID

    Let $effdt = &HE.EFFDT
    Let $Head_EstabID = rtrim(&HE.ESTABID, ' ') 
  
FROM PS_ESTAB_TBL HE 
 WHERE HE.COMPANY = $company
   AND HE.HQUNIT = 'Y'
   AND HE.EFFDT = ( 
 SELECT MAX(E2.EFFDT) 
  FROM PS_ESTAB_TBL E2 
 WHERE E2.ESTABID = HE.ESTABID 
   AND E2.EFFDT <= $RC_DateTo 
   AND E2.EFF_STATUS = 'A' )
End-Select

End-Procedure Estab-HeadQuarters

!**************************************
begin-procedure Get-Estab-Lang
#debug show '** Get-Estab-Lang **'
!**************************************

BEGIN-Select
EE.DESCR     

  Let $Nome   = Ltrim(Rtrim(&EE.DESCR, ' '), ' ')
  do Check-Strings ($Nome , $Nome)
  
FROM PS_ESTAB_TBL_LANG EE
WHERE EE.ESTABID = $Estabid
AND   EE.LANGUAGE_CD = $curr_language_cd
AND   EE.EFFDT = (SELECT MAX(EFFDT)
               FROM PS_ESTAB_TBL_LANG
               WHERE ESTABID = EE.ESTABID
               AND   LANGUAGE_CD = EE.LANGUAGE_CD
               AND   EFFDT <= $RC_DateTo)
End-Select

End-Procedure Get-Estab-Lang

!**************************************
begin-procedure Get-Estab-Id
#debug show '* Get-Estab-Id'
!**************************************

Let $CEI = ' '
Let $CNPJAsoc = ' '
Let $CNPJ = ' '
Let $estabInscription = ' '


Begin-Select
A.ESTAB_ID_TYPE_BRA
A.ESTAB_ID_BRA

  Let $EstabIdType = rtrim(&A.ESTAB_ID_TYPE_BRA, ' ')
 
  Evaluate $EstabIdType
  when = 'CNPJ'
       Let $CNPJ = Rtrim(&A.ESTAB_ID_BRA, ' ' )
  when = 'CEI'
       Let $CEI = substr(Rtrim(&A.ESTAB_ID_BRA, ' ' ),1,12) 
  when = 'IE'
       Let $IE = Rtrim(&A.ESTAB_ID_BRA, ' ' )   
  when = 'IM'
    Let $IM = Rtrim(&A.ESTAB_ID_BRA, ' ' )  
  when = 'SUFRAM'
    Let $SUFRAMA = Rtrim(&A.ESTAB_ID_BRA, ' ' ) 
  End-Evaluate
  
FROM  PS_ESTAB_ID_BRA A
WHERE A.ESTABID = $EstabId
AND   A.COUNTRY = 'BRA'
AND   A.EFFDT   = $effdt
End-Select

if $insType = '10'
   Let $estabInscription = $CNPJ
   Let $CEI = ' '
else
   if $CNPJ = ' ' and  $estabAsoc <> ''
         Do Get-EstabId-estabAsoc
   end-if
   
   IF RTRIM($CEI, ' ')  <> ''
      Let $estabInscription = $CEI
   else
      Let $estabInscription = $CNPJAsoc
        show 'Registro tipo 0000: Sem dados do CNPJ/CEI' $EstabID
        show '*03-Nmero de inscrio do contribuinte no CNPJ ' 
   end-if
end-if

if $IE = ' '
   show 'Registro tipo 0000: Sem dados do IE ' $EstabID
   show '*08-Nmero de inscrio Estadual do contribuinte '       
end-if

if $SUFRAMA = ' '
   show 'Registro tipo 0000: Sem dados do SUFRAMA ' $EstabID
   show '*11-Nmero de inscrio do contribuinte na SUFRAMA '       
end-if

if $IM = ' '
   show 'Registro tipo 0000: Sem dados do IM ' $EstabID
   show '*10-Nmero de inscrio Municipal do contribuinte'       
end-if

End-Procedure Get-Estab-Id

!**************************************
begin-procedure Get-EstabId-estabAsoc
#debug show '* Get-EstabId-estabAsoc'
!**************************************

Begin-Select
EA.ESTAB_ID_BRA

  Let $CNPJAsoc = Rtrim(&EA.ESTAB_ID_BRA, ' ' )
   
FROM  PS_GET_CNPJ_VW_BRA EA
WHERE EA.ESTAB_ASOC_BRA = $estabAsoc
AND   EA.COMPANY = $company
AND   EA.EFFDT   = $effdt
End-Select

if $CNPJAsoc = ' '
  show 'Registro tipo 0000: Nos dados do CNPJ ' $EstabID
  show '*   Nmero de inscrio do contribuinte no CNPJ ' 
end-if

End-Procedure Get-EstabId-estabAsoc

!**************************************
begin-procedure Verify-MANAD-Responsible
#debug show '* Verify-MANAD-Responsible'
!**************************************
 
Do Get-MANAD-Responsible 

If $MANADResponsible_Flag = '0'
   if $ResEstabID <> $Head_EstabID
      Let $ResEstabID = $head_estabID
      Do Get-MANAD-Responsible 
      If $MANADResponsible_Flag = '0' 
        show 'Registro tipo 0000: Nos dados responsvel do MANAD  ' $EstabID
        show '*   Nmero de inscrio do contribuinte no CPF ' 
        show '*   Nmero de inscrio no cadastro correspondente (PIS/PASEP/CI/SUS)'
      end-if
   else
     show 'Registro tipo 0000: Sem dados responsvel do MANAD  ' $EstabID
     show '*   Nmero de inscrio do contribuinte no CPF ' 
     show '*   Nmero de inscrio no cadastro correspondente (PIS/PASEP/CI/SUS)'
   end-if
end-if

End-Procedure Verify-MANAD-Responsible

!**************************************
begin-procedure Get-MANAD-Responsible
#debug show '* Get-MANAD-Responsible'
!**************************************

Let $MANADResponsible_Flag = '0'
Begin-Select
R.GPBR_RESP_CPF 
R.GPBR_RESP_ID 
R.EMPLID 

  Let $MANADResponsible_Flag = '1'
  Let $CPF = rtrim(&R.GPBR_RESP_CPF, ' ')
  if rtrim(&R.GPBR_RESP_ID, ' ') <> ''
     Let $emplID = rtrim(&R.GPBR_RESP_ID, ' ')
  else
     Let $emplID = rtrim(&R.EMPLID, ' ')
  end-if
  
  Do Get-National-Id
  
FROM PS_GPBR_MANAD_RESP R 
WHERE R.ESTABID = $ResEstabID
AND R.EFFDT = ( 
SELECT MAX(R2.EFFDT) 
FROM PS_GPBR_MANAD_RESP R2 
WHERE R2.ESTABID = R.ESTABID 
AND R2.EFFDT <= $RC_DateTo 
AND R2.EFF_STATUS = 'A' )
End-Select

End-Procedure Get-MANAD-Responsible

!**************************************
Begin-procedure Get-Company-Name
#debug show '* Get-Company-Name'
!**************************************

Begin-select
C.DESCR
  
  Let $Nome = rtrim(&C.DESCR,' ') 
  do Check-Strings ( $Nome , $Nome)
  
FROM PS_COMPANY_TBL C
WHERE C.COMPANY = $Company
AND  C.EFFDT = (SELECT MAX(CC.EFFDT)          
                FROM PS_COMPANY_TBL CC
                WHERE CC.COMPANY  = C.COMPANY   
                AND   CC.EFFDT   <= $RC_DateTo
                AND   CC.EFF_STATUS = 'A')
end-select
End-procedure Get-Company-Name

!**************************************
begin-procedure Get-National-Id
#debug show '* Get-National-Id **'
!**************************************

Let $NIT  = ''
Let $PIS = ''
Let $PASEP = ''
Let $CPF = ''

Begin-Select
A.NATIONAL_ID
A.NATIONAL_ID_TYPE

   Let $NationalId = Rtrim(&A.NATIONAL_ID_TYPE, ' ')
  
   Evaluate $NationalId 
   when = 'PIS'
     Let $PIS       = Rtrim(&A.NATIONAL_ID,' ')
     Let #PIS = $PIS
     Let $PIS = Edit(#PIS, '00000000000')
   when = 'PASEP'
     Let $PASEP     = edit(ltrim(Rtrim(&A.NATIONAL_ID,' '), ' '), '00000000000')
   when = 'CPF'
     Let $CPF    = edit(ltrim(Rtrim(&A.NATIONAL_ID,' '), ' '), '00000000000')
   End-Evaluate
   
   if $PIS <> ''
      Let $NIT = $PIS
   else
      Let $NIT = $PASEP
   end-if
   
from PS_PERS_NID A
WHERE A.NATIONAL_ID_TYPE IN  ('PIS', 'PASEP', 'CPF')
AND A.EMPLID = $emplID
AND A.COUNTRY = 'BRA' 
End-Select


Begin-Select
H.NATIONAL_ID
H.NATIONAL_ID_TYPE

   Let $NationalId = Rtrim(&H.NATIONAL_ID_TYPE, ' ')
  
   Evaluate $NationalId 
   when = 'PIS'
     Let $PIS       = Rtrim(&H.NATIONAL_ID,' ')
     Let #PIS = $PIS
     Let $PIS = Edit(#PIS, '00000000000')
   when = 'PASEP'
     Let $PASEP     = edit(ltrim(Rtrim(&H.NATIONAL_ID,' '), ' '), '00000000000')
   when = 'CPF'
     Let $CPF    = edit(ltrim(Rtrim(&H.NATIONAL_ID,' '), ' '), '00000000000')
   End-Evaluate
   
   if $PIS <> ''
      Let $NIT = $PIS
   else
      Let $NIT = $PASEP
   end-if
   
FROM PS_PERS_NID_HI_BRA H
WHERE H.NATIONAL_ID_TYPE IN  ('PIS', 'PASEP', 'CPF')
AND H.EMPLID = $emplID
AND H.ACTION_DT = (SELECT MAX(H1.ACTION_DT)
                   FROM PS_PERS_NID_HI_BRA H1
                   WHERE H1.EMPLID = H.EMPLID
                   AND H1.COUNTRY = H.COUNTRY
                   AND H1.ACTION_DT <= $effdt)
AND H.COUNTRY = 'BRA' 
End-Select
End-Procedure Get-National-Id

!**************************************
begin-procedure Write-0000
#debug show '* Write-0000'
!**************************************

begin-select
T0.GPBR_MAN_ROW_TYPE
T0.ESTABID
T0.GPBR_MAN_TEXT

  write 1 from
    &T0.GPBR_MAN_ROW_TYPE '|' -
    &T0.GPBR_MAN_TEXT

FROM PS_GPBR_MANAD_TMP1 T0
WHERE T0.GPBR_MAN_ROW_TYPE LIKE '0%' 
AND T0.PROCESS_INSTANCE = #prcs_process_instance
ORDER BY T0.GPBR_MAN_ROW_TYPE, T0.ESTABID
end-select
End-procedure Write-0000

!**************************************
begin-procedure Write-I000
#debug show '* Write-I000'
!**************************************

begin-select
TI.GPBR_MAN_ROW_TYPE
TI.ESTABID
TI.GPBR_MAN_TEXT

  write 1 from
    &TI.GPBR_MAN_ROW_TYPE '|' -
    &TI.GPBR_MAN_TEXT   

FROM PS_GPBR_MANAD_TMP1 TI
WHERE TI.GPBR_MAN_ROW_TYPE LIKE 'I%' 
AND TI.PROCESS_INSTANCE = #prcs_process_instance
ORDER BY TI.GPBR_MAN_ROW_TYPE, TI.ESTABID
end-select
End-procedure Write-I000 

!**************************************
begin-procedure Write-K000
#debug show '* Write-K000'
!**************************************

    Do Write-K001 
    Do Write-K050
    Do Write-K100
    Do Write-K150
    Do Write-K200
    Do Adjust-K250
    Do Write-K250
    Do Adjust-K300
    Do Set-Other300
    Do Write-K300
    Do AdjCnt-K250-K300
    Do Write-K990
    
End-procedure Write-K000  

!**************************************
Begin-Procedure Write-K001
#debug show '* Write-K001'
!**************************************

Begin-Select
TK001.GPBR_MAN_ROW_TYPE
TK001.GPBR_MAN_TEXT

 write 1 from
  &TK001.GPBR_MAN_ROW_TYPE '|' -
  &TK001.GPBR_MAN_TEXT   

FROM PS_GPBR_MANAD_TMP1 TK001 
WHERE TK001.GPBR_MAN_ROW_TYPE = 'K001'
AND TK001.PROCESS_INSTANCE = #prcs_process_instance
End-Select

End-Procedure Write-K001

!**************************************
Begin-Procedure Write-K050
#debug show '* Write-K050'
!**************************************

Let $K_IND_MOV = '0'

Begin-Select
TK0502.EMPLID 
TK0502.EMPL_RCD 
TK0501.GPBR_MAN_EMP_FORM
TK0501.COMPANY
TK0502.EFFDT
TK0502.ESTABID  
TK0502.SEFIP_CATEGORY_BRA
TK0502.EMPL_CLASS
TK0502.BIRTHDATE 
TK0502.HIRE_DT 
TK0502.TERMINATION_DT 
TK0501.ESTAB_ID_BRA
TK0502.DEPTID
CASE WHEN NID1.NATIONAL_ID IS NULL THEN NID2.NATIONAL_ID ELSE NID1.NATIONAL_ID END &NIT
NID3.NATIONAL_ID
N51.NAME_DISPLAY 
TK0502.GPBR_MAN_ROW_TYPE    
    
   IF &TK0502.TERMINATION_DT <> ''
      Do convert-to-dtu-date(&TK0502.TERMINATION_DT, $DT_INC_ALT)
      Do Format-MANAD-Date($DT_INC_ALT, $DT_INC_ALT)
   ELSE
      Do convert-to-dtu-date(&TK0502.EFFDT, $DT_INC_ALT)
      Do Format-MANAD-Date($DT_INC_ALT, $DT_INC_ALT)
   END-IF
 
   Let $CPF  = &NID3.NATIONAL_ID 
   Let $NIT  = &NIT   
 
   Let $estabInscription = rtrim(&TK0501.ESTAB_ID_BRA,' ')
   
   IF $estabInscription <> ''
      Let $estabInscription = replace($estabInscription, '-',  '')
      Let $estabInscription = replace($estabInscription, '.',  '')
   ELSE
       Let $estabInscription = ' '
   END-IF
 
   Do convert-to-dtu-date(&TK0502.BIRTHDATE , $DT_NASC)
   Do Format-MANAD-Date($DT_NASC, $DT_NASC)   
   Do convert-to-dtu-date(&TK0502.HIRE_DT , $DT_ADMISSAO)
   Do Format-MANAD-Date($DT_ADMISSAO, $DT_ADMISSAO)  
   Do convert-to-dtu-date(&TK0502.TERMINATION_DT , $DT_DEMISSAO)
   Do Format-MANAD-Date($DT_DEMISSAO, $DT_DEMISSAO)    
   
      
   Let $COD_CATEG = RTRIM(&TK0502.SEFIP_CATEGORY_BRA, ' ')
   
   If &TK0502.EMPL_CLASS = '55' 
      Let $COD_CATEG = '07'
   else
      if &TK0502.EMPL_CLASS = '199'  
         Let $COD_CATEG = '00'
      End-If
   End-If   

   Let $emplid = &TK0502.EMPLID
   Let #emplRcd = &TK0502.EMPL_RCD
      
   IF rtrim(&TK0501.GPBR_MAN_EMP_FORM, ' ') = 'Y'
      Let $COD_REG_TRAB =  $emplID || ' ' || to_char(#emplRcd) 
   else 
      Let $COD_REG_TRAB =  $emplID  
   end-if
 
   Let $namedisp = RTRIM(&N51.NAME_DISPLAY, ' ') 
   Do Check-Strings ( $namedisp , $namedisp)
 
   Let $MANADtext = $estabInscription || '|' ||  $DT_INC_ALT || '|' || $COD_REG_TRAB || '|' || $CPF || '|' || $NIT || '|'
   Let $MANADtext = $MANADtext || $COD_CATEG || '|' || $namedisp || '|' || $DT_NASC || '|' 
   Let $MANADtext = $MANADtext || $DT_ADMISSAO || '|' || $DT_DEMISSAO ||  '||||'
     
  write 1 from
    &TK0502.GPBR_MAN_ROW_TYPE '|' -
    $MANADtext 
    
FROM PS_GPBR_MANAD_TMP2 TK0502 LEFT OUTER JOIN PS_PERS_NID NID1 ON TK0502.EMPLID = NID1.EMPLID AND NID1.NATIONAL_ID_TYPE = 'PIS'
                 LEFT OUTER JOIN PS_PERS_NID NID2 ON TK0502.EMPLID = NID2.EMPLID AND NID2.NATIONAL_ID_TYPE = 'PASEP'
                 LEFT OUTER JOIN PS_PERS_NID NID3 ON TK0502.EMPLID = NID3.EMPLID AND NID3.NATIONAL_ID_TYPE = 'CPF'
,PS_GPBR_MANAD_TMP1 TK0501 
,PS_NAMES N51 
WHERE TK0502.GPBR_MAN_ROW_TYPE = 'K050'
AND TK0502.PROCESS_INSTANCE = #prcs_process_instance
AND TK0501.PROCESS_INSTANCE = #prcs_process_instance
AND TK0501.GPBR_MAN_ROW_TYPE = '0000'
AND TK0502.ESTABID = TK0501.ESTABID
AND N51.EMPLID = TK0502.EMPLID
AND N51.EFFDT  = ( 
 SELECT MAX(N.EFFDT) 
  FROM PS_NAMES N 
 where N.EMPLID = N51.EMPLID 
   and N.NAME_TYPE=N51.NAME_TYPE
   and N.EFFDT < $RC_DateTo)
   and N51.NAME_TYPE='PRI'
ORDER BY TK0501.ESTAB_ID_BRA, TK0502.EMPLID, TK0502.EFFDT            
End-Select

End-Procedure Write-K050

!**************************************
Begin-Procedure Write-K150
#debug show '* Write-K150'
!**************************************

Begin-Select
TK150.GPBR_MAN_ROW_TYPE
TK150.ESTAB_ID_BRA
ED1.EFFDT 
PN.PIN_NM
CASE WHEN PNL.DESCR IS NOT NULL THEN PNL.DESCR ELSE PN.DESCR END &PinDescr

   Do convert-to-dtu-date(&ED1.EFFDT , $DT_INC_ALT)
   Do Format-MANAD-Date($DT_INC_ALT, $DT_INC_ALT)

   Let $K_IND_MOV = '0'

   Let $descr = rtrim(&PinDescr, ' ')
   Do Check-Strings ( $descr , $descr)
   
   Let $estabInscription = &TK150.ESTAB_ID_BRA
   Let $estabInscription = replace($estabInscription, '-',  '') 
   Let $estabInscription = replace($estabInscription, '.',  '') 
   
   Let $MANADtext = RTRIM($estabInscription, ' ') || '|' || rtrim($DT_INC_ALT, ' ') || '|' || rtrim(&PN.PIN_NM,' ')   || '|' || $descr
    
    write 1 from
      &TK150.GPBR_MAN_ROW_TYPE '|' - 
      $MANADtext

FROM PS_GP_PIN PN LEFT OUTER JOIN PS_GP_PIN_LANG PNL ON PN.PIN_NUM = PNL.PIN_NUM AND PNL.LANGUAGE_CD = $curr_language_cd
                  LEFT OUTER JOIN PS_GPBR_MANAD_TMP1 TK150  ON TK150.PIN_NUM = PN.PIN_NUM
                  LEFT OUTER JOIN PS_GP_ERN_DED ED1  ON ED1.PIN_NUM = PN.PIN_NUM
WHERE TK150.GPBR_MAN_ROW_TYPE = 'K150'
AND TK150.PROCESS_INSTANCE = #prcs_process_instance
AND ED1.EFFDT = ( SELECT MAX(ED2.EFFDT) 
                 FROM PS_GP_ERN_DED ED2 
                 WHERE ED2.PIN_NUM = ED1.PIN_NUM 
                 AND ED2.EFFDT <= $RC_DateTo) 
ORDER BY TK150.ESTAB_ID_BRA, TK150.EFFDT, TK150.GPBR_MAN_TEXT
End-Select

End-Procedure Write-K150

!**************************************
Begin-Procedure Write-K990
#debug show '* Write-K990'
!**************************************

Let #rowCount2 = #rowCount

Begin-Select
SUM(TK990.ROW_COUNT) &TK990.ROW_COUNT

 Let $RowCount = ltrim(rtrim(edit(&TK990.ROW_COUNT, '999999'), ' '), ' ')
   
 write 1 from
  'K990|' -
  $RowCount

FROM PS_GPBR_MANAD_TMP1 TK990 
WHERE TK990.GPBR_MAN_ROW_TYPE LIKE 'K%'
AND TK990.PROCESS_INSTANCE = #prcs_process_instance
End-Select

Let #rowCount = #rowCount2

End-Procedure Write-K990

!**************************************
Begin-Procedure Write-K100
#debug show '* Write-K100'
!**************************************
   
Begin-select DISTINCT
TK100.GPBR_MAN_ROW_TYPE
TK100.ESTABID
TK100.GPBR_MAN_TEXT
TK100.DEPTID
TK100.ESTAB_ID_BRA
TK100.EFFDT
COALESCE(TMK1.GPBR_SERVICE_TAKER,' ') &TMK1.GPBR_SERVICE_TAKER
COALESCE(TMK1.GPBR_TAKER_INSCR,' ') &TMK1.GPBR_TAKER_INSCR

  let $TAKER_INSCR = rtrim(&TMK1.GPBR_TAKER_INSCR,' ')

  Let $GPBR_SERVICE_TAKER = rtrim(&TMK1.GPBR_SERVICE_TAKER, ' ')
    
  If $GPBR_SERVICE_TAKER <> ''
     Let $GPBR_SERVICE_TAKER = ' ' || $GPBR_SERVICE_TAKER
  End-If

   Let $deptid= rtrim(&TK100.DEPTID, ' ')

   Do convert-to-dtu-date($RC_DateFrom, $DateK100)
   Do Format-MANAD-Date($DateK100, $DateK100) 
   Let $DateK100 = '01' || substr($DateK100,3,6) 

   Let $estabInscription = &TK100.ESTAB_ID_BRA
   Let $estabInscription = replace($estabInscription, '.',  '')
   Let $estabInscription = replace($estabInscription, '-',  '') 
   
   Let $descr_100 = rtrim(&TK100.GPBR_MAN_TEXT,' ')
   Do Check-Strings ( $descr_100 , $descr_100)
   
    Let $MANADtext = $DateK100 || '|' || $deptid || $GPBR_SERVICE_TAKER || '|' || rtrim($estabInscription, ' ') || '|' || $descr_100 || '|' ||  $TAKER_INSCR 

  write 1 from
    &TK100.GPBR_MAN_ROW_TYPE '|' -
    $MANADtext
    
    Let $K_IND_MOV = '0'

FROM PS_GPBR_MANAD_TMP1 TK100 LEFT OUTER JOIN PS_GPBR_SER_TAK_TM TMK1 ON TMK1.PROCESS_INSTANCE = #prcs_process_instance AND TK100.GPBR_SERVICE_TAKER = TMK1.GPBR_SERVICE_TAKER
WHERE TK100.GPBR_MAN_ROW_TYPE = 'K100' 
AND TK100.PROCESS_INSTANCE = #prcs_process_instance
ORDER BY TK100.GPBR_MAN_ROW_TYPE, TK100.ESTAB_ID_BRA
end-select

End-Procedure Write-K100

!**************************************
begin-procedure Create-I000
#debug show '* Create-I000'
!**************************************

Let $MANADRowType = 'I001'
Let $MANADtext = '1'
Let #RowCount = 1
Let $estabID =' '
Let $GPRptKey = $MANADRowType
Do Insert-MANAD-TMP  

Let $MANADRowType = 'I990'
Let $MANADtext = '2'
Let $GPRptKey = $MANADRowType
Do Insert-MANAD-TMP 
  
End-procedure Create-I000 

!**************************************
begin-procedure Write-9000
#debug show '* Write-9000'
!**************************************

Do Extract-Data-9000
Let #RowCount9900 = 0

Let $MANADRowType = '9900'
begin-select
T9.GPBR_MAN_ROW_TYPE 
SUM(T9.ROW_COUNT) &T9.ROW_COUNT

 Let #RowCount9900 = #RowCount9900 + 1

 Let #RowCount = &T9.ROW_COUNT
 Let $RowCount = ltrim(rtrim(edit(&T9.ROW_COUNT, '999999'), ' '), ' ')
   
 
  write 1 from $MANADRowType '|' -
    &T9.GPBR_MAN_ROW_TYPE '|' -
    $RowCount
    
  Let $GPRptKey = &T9.GPBR_MAN_ROW_TYPE
  Do Insert-MANAD-TMP  
    

FROM PS_GPBR_MANAD_TMP1 T9
WHERE T9.PROCESS_INSTANCE = #prcs_process_instance
AND T9.GPBR_MAN_ROW_TYPE NOT LIKE '9%'
GROUP BY T9.GPBR_MAN_ROW_TYPE 
ORDER BY T9.GPBR_MAN_ROW_TYPE
end-select


Do Write-9900-Complement

Let $MANADRowType = '9990'
begin-select
COUNT(*) &T990.COUNT

 Let #RowCount = &T990.COUNT  + 6
 Let $RowCount = ltrim(rtrim(edit(#RowCount '999999'), ' '), ' ')
  write 1 from
     $MANADRowType '|' -
     $RowCount     
     
  Let $GPRptKey = $MANADRowType
  Do Insert-MANAD-TMP  
    

FROM PS_GPBR_MANAD_TMP1 T990
WHERE T990.PROCESS_INSTANCE = #prcs_process_instance
AND T990.GPBR_MAN_ROW_TYPE LIKE '9%'
end-select

Let $MANADRowType = '9999'
begin-select
SUM(T99.ROW_COUNT) &T99.COUNT

 Let $RowCount = ltrim(rtrim(edit((&T99.COUNT + #RowCount), '999999'), ' '), ' ')
   
 
  write 1 from
    $MANADRowType '|' -
    $RowCount
    
  Let $GPRptKey = $MANADRowType
  Do Insert-MANAD-TMP  
    

FROM PS_GPBR_MANAD_TMP1 T99
WHERE T99.PROCESS_INSTANCE = #prcs_process_instance
AND T99.GPBR_MAN_ROW_TYPE = '9900'
end-select

End-procedure Write-9000 

!**************************************
begin-procedure Write-9900-Complement
#debug show '* Write-9900-Complement'
!**************************************

Let $MANADRowType = '9900'

write 1 from
    $MANADRowType '|' -
    '9001' -
    '|1' 
    
Let #RowCount9900 = #RowCount9900 + 4 !these 4 lines
Let $RowCount9900 = ltrim(rtrim(edit(#RowCount9900, '999999'), ' '), ' ')    
    
write 1 from
    $MANADRowType '|' -
    '9900|' -
    $RowCount9900  
write 1 from
    $MANADRowType '|' -
    '9990' -
    '|1'       
write 1 from
    $MANADRowType '|' -
    '9999' -
    '|1'    
   
End-procedure Write-9900-Complement

!**************************************
begin-procedure Row-0000
#debug show '* Row-0000'
!**************************************

Let $deptID = ' '
Let #pinNum = 0
Let $MANADRowType = '0000'
Let #rowCount = 1
Let $deptID = ' '
Let $estabInscription = ' '
Let $CNPJ = ' '
Let $CEI = ' '
Let $centrEstabID = ' '
Let $emplFormat = 'N'

Begin-Select
C.CENTR_ESTABID_BRA 
C.EFFDT
   
  Let $IND_CENTR = '1'
  Let $IND_MOV = '0'
  Let $estabID = rtrim(&C.CENTR_ESTABID_BRA, ' ')
  Let $centrEstabID = rtrim(&C.CENTR_ESTABID_BRA, ' ')
  Let $GPRptKey = $centrEstabID
  Let $parm_estabID = $estabID
  Do Get-Estab-Data 
    
  Do Create-Text-0000 
  DO Get-Parameters 
  if $parmFlag = 'N'
     if $Head_EstabID <> $estabID
        Let $parm_estabID = $Head_EstabID
        DO Get-Parameters
     end-if
  end-if
  
  Let $CentrEffdt = &C.EFFDT

  Do Insert-MANAD-TMP
  
FROM PS_CENTR_DATA_BRA C 
WHERE C.PROCESS_TYPE_BRA = '50' 
AND C.CENTR_ESTABID_BRA = $RC_EstabID 
AND C.EFFDT = (SELECT MAX(C2.EFFDT) 
               FROM PS_CENTR_DATA_BRA C2 
               WHERE C2.CENTR_ESTABID_BRA = C.CENTR_ESTABID_BRA 
               AND C2.PROCESS_TYPE_BRA = C.PROCESS_TYPE_BRA 
               AND C2.EFFDT <=  $RC_DateTo) 

End-Select

Let $ExistCentr = 'N'
Begin-Select
C2.CENTR_ESTABID_BRA 
C2.ESTABID

  Let $IND_CENTR = '2'
  Let $IND_MOV = '0'
  Let $estabID = rtrim(&C2.ESTABID, ' ')
  Let $centrEstabID = rtrim(&C2.CENTR_ESTABID_BRA, ' ')
  Let $GPRptKey = $centrEstabID
  Let $parm_estabID = $estabID
  
  Do Get-Estab-Data 
  Do Create-Text-0000 
  
  Do Insert-MANAD-TMP 

  FROM PS_CENTR_DTL_BRA C2 
 WHERE C2.PROCESS_TYPE_BRA = '50' 
   AND C2.CENTR_ESTABID_BRA = $centrEstabID 
   AND C2.EFFDT = $CentrEffdt
   AND C2.ESTABID <> $centrEstabID 
End-Select

IF $centrEstabID <> $RC_EstabID

Begin-Select DISTINCT
C3.ESTABID 
 
  Let $IND_CENTR = '2'
  Let $IND_MOV = '0'
  Let $deptID = ' '
  Let $EstabID = rtrim(&C3.ESTABID, ' ')
  Let $GPRptKey = $EstabID
  Let $parm_estabID = $estabID
  
  Do Get-Estab-Data 
  Do Create-Text-0000 
  
  if $centrEstabID = ' ' 
     DO Get-Parameters
     if $parmFlag = 'N'
        if $Head_EstabID <> $estabID
           Let $parm_estabID = $Head_EstabID
           DO Get-Parameters
        end-if
     end-if 
  end-if
  
  Do Insert-MANAD-TMP
  
  FROM PS_CENTR_DTL_BRA C3 
 WHERE C3.PROCESS_TYPE_BRA = '50' 
   AND C3.ESTABID = $RC_EstabID
   AND C3.CENTR_ESTABID_BRA <> $RC_EstabID
   AND C3.EFFDT = ( 
 SELECT MAX(C2.EFFDT) 
  FROM PS_CENTR_DATA_BRA C2 
 WHERE C2.CENTR_ESTABID_BRA = C3.CENTR_ESTABID_BRA 
   AND C2.PROCESS_TYPE_BRA = C3.PROCESS_TYPE_BRA 
   AND C2.EFFDT <= $RC_DateTo)    
End-Select

END-IF

Begin-Select
E1.ESTABID
E2.COUNTY_CD_BRA 
E1.STATE 
E1.DESCR
E1.EFFDT
E1.COMPANY

  Let $IND_CENTR = '0'
  Let $IND_MOV = '0'
  Let $EstabID = rtrim(&E1.ESTABID, ' ')
  Let $effdt = &E1.EFFDT    
  Let $Nome = rtrim(&E1.DESCR,' ')
  do Check-Strings ( $Nome , $Nome)
  Let $UF = &E1.STATE 
  Let $COD_MUN = &E2.COUNTY_CD_BRA 
  Let $GPRptKey = $EstabID
  Let $deptID = ' '
  Let $Company = rtrim(&E1.COMPANY, ' ')
  Let $parm_estabID = $estabID
  
  if $company = ''
     Let $company = ' '
  end-if
    
  Do Get-Estab-Data 
  Do Create-Text-0000 
  DO Get-Parameters
  
  Do Insert-MANAD-TMP
  
 FROM PS_ESTAB_TBL E1 
  ,PS_ESTAB_TBL_BRA E2 
 WHERE E1.ESTABID = $RC_EstabID
   AND E1.ESTABID= E2.ESTABID 
   AND E1.EFFDT = E2.EFFDT 
   AND E1.EFFDT = ( 
 SELECT MAX(ES.EFFDT) 
  FROM PS_ESTAB_TBL ES 
 WHERE ES.ESTABID = E1.ESTABID 
   AND ES.EFFDT <= $RC_DateTo
   AND ES.EFF_STATUS = 'A' )
   AND NOT EXISTS ( 
 SELECT 'X' 
  FROM PS_CENTR_DATA_BRA C 
 WHERE C.CENTR_ESTABID_BRA = $RC_EstabID
   AND C.PROCESS_TYPE_BRA = '50' 
   AND C.EFFDT = ( 
 SELECT MAX(C2.EFFDT) 
  FROM PS_CENTR_DATA_BRA C2 
 WHERE C2.CENTR_ESTABID_BRA = C.CENTR_ESTABID_BRA 
   AND C2.PROCESS_TYPE_BRA = C.PROCESS_TYPE_BRA 
   AND C2.EFFDT <= $RC_DateTo)) 
   AND NOT EXISTS ( 
 SELECT 'X' 
  FROM PS_CENTR_DTL_BRA C3 
 WHERE C3.ESTABID = $RC_EstabID
   AND C3.PROCESS_TYPE_BRA = '50' 
   AND C3.EFFDT = ( 
 SELECT MAX(C4.EFFDT) 
  FROM PS_CENTR_DTL_BRA C4 
 WHERE C4.ESTABID = C3.ESTABID 
   AND C4.PROCESS_TYPE_BRA = C3.PROCESS_TYPE_BRA 
   AND C4.EFFDT <= $RC_DateTo) )
End-Select
End-Procedure Row-0000

!**************************************
begin-procedure Row-0100
#debug show '* Row-0100'
!**************************************

Let $MANADRowType = '0100'
Let $deptID = ' '
Let #pinNum = 0
Let $Responsable_Flag = '0'
Let $IND_CENTR = ' '
Let $MANADtext = ' '
Let #rowCount = 1
Let $CNPJ = ' '
let $CNPJAsoc = ' '

Begin-Select
MR.EFFDT
MR.ESTABID
MR.GPBR_END_DATE
MR.GPBR_RESP_NAME
MR.GPBR_RESP_COMPANY
MR.GPBR_RESP_ID
MR.EMPLID
MR.GPBR_RESP_CPF
MR.GPBR_RESP_CNPJ
MR.EMAIL_ADDR
MR.PHONE
MR.FAX

  Do convert-to-dtu-date(&MR.EFFDT , $DT_INI)
  Do convert-to-dtu-date(&MR.GPBR_END_DATE , $DT_FIN)
  Do convert-to-dtu-date($RC_DateFrom , $RC_DateFromDTU)
  
  Let $Responsable_Flag = '1'
  
  IF RTRIM(&MR.GPBR_RESP_NAME, ' ') <> ''
     Let $EMP_TEC = RTRIM(&MR.GPBR_RESP_NAME, ' ')
  ELSE
     Let $EMP_TEC = RTRIM(&MR.GPBR_RESP_COMPANY, ' ')
  END-IF
  
  do Check-Strings ($EMP_TEC , $EMP_TEC)
  
  let $FullPhone = rtrim(&MR.FAX, ' ')
  do GetPhoneBRA ($FullPhone, $PhoneDDI, $PhoneDDD, $Phone, $PhoneRamal)  
  let $FAX = rtrim($PhoneDDI, ' ') || rtrim($PhoneDDD, ' ') || rtrim($Phone, ' ')
    
  let $FullPhone = rtrim(&MR.PHONE, ' ') 
  do GetPhoneBRA ($FullPhone, $PhoneDDI, $PhoneDDD, $Phone, $PhoneRamal)  
  let $Phone = rtrim($PhoneDDI, ' ') || rtrim($PhoneDDD, ' ') || rtrim($Phone, ' ')

  If RTRIM(&MR.EMPLID, ' ')  <> ' ' 
     Let $emplID = RTRIM(&MR.EMPLID, ' ') 
     Let #emplRcd = 0
     Let $effdt = $RC_DateTo
     Do Get-Job-Data
     Do Get-National-Id
  else
     Let $CPF = &MR.GPBR_RESP_CPF
  End-If
    
  Do Format-MANAD-Date($DT_INI, $DT_INI)
  IF RTRIM($DT_FIN,' ') = ''
     Do convert-to-dtu-date($RC_DateTo , $DT_FIN)
  END-IF
 
  Do Format-MANAD-Date($DT_FIN, $DT_FIN)
  
  if RTRIM(&MR.GPBR_RESP_CNPJ, ' ') <> ''
     Let $estabInscription = RTRIM(&MR.GPBR_RESP_CNPJ, ' ')
     Let $estabInscription = replace($estabInscription, '-',  '')
     Let $estabInscription = replace($estabInscription, '.',  '')
  else
     Let $estabInscription = ' '
     show 'Registro tipo 0100: '
     show 'Sem Dados do responsvel  ' $EMP_TEC
     show 'Nmero de inscrio no CNPJ '
  end-if
  
  Let $EstabID = rtrim(&MR.ESTABID, ' ')
  Let $company = ' '
  Let $GPRptKey = $EstabID || $DT_INI
  Let $IND_MOV = '0'
  
  Let $MANADtext = $EMP_TEC || '|' ||  $CARGO || '|' || $DT_INI || '|' || $DT_FIN || '|' 
  Let $MANADtext = $MANADtext || $estabInscription || '|' || $CPF || '|' 
  Let $MANADtext = $MANADtext || RTRIM($PHONE, ' ') || '|' || rtrim($FAX, ' ') || '|' || rtrim(&MR.EMAIL_ADDR, ' ')

  Do Insert-MANAD-TMP
  
FROM PS_GPBR_MANAD_RESP MR
    ,PS_GPBR_MANAD_TMP1 T
WHERE T.ESTABID = MR.ESTABID
AND T.GPBR_MAN_ROW_TYPE = '0000'
AND MR.EFFDT = (SELECT MAX(MR1.EFFDT) 
                FROM PS_GPBR_MANAD_RESP MR1
                WHERE MR1.ESTABID = MR.ESTABID
                AND MR1.EFFDT <= $RC_DateTo)
AND T.PROCESS_INSTANCE = #prcs_process_instance                
End-Select

If $Responsable_Flag = '0'
  show 'Registro tipo 0100: Sem Dados do responsvel  '  
end-if

End-Procedure Row-0100

!**************************************
begin-procedure Get-Job-Data
#debug show '* Get-Job-Data'
!**************************************

Begin-Select
JCR.DESCR
JCR.JOBCODE
JCR.SETID
JR.CBO_CD_BRA 
JR.SEFIP_CATEGORY_BRA

  Let $sefipCategory = &JR.SEFIP_CATEGORY_BRA
  Let $COD_CBO = EDIT(replace(&JR.CBO_CD_BRA, '-',  ''), '000000')  
  Let $CARGO = rtrim(&JCR.DESCR, ' ')
  do Check-Strings ( $CARGO , $CARGO)
  Let $Jobcode = RTRIM(&JCR.JOBCODE, ' ')
  Let $setid = &JCR.SETID
    
                 Do Get-Jobcode-lang   
   
FROM PS_JOB J
    ,PS_JOB_JR JR
    ,PS_JOBCODE_TBL JCR
WHERE J.EMPLID = $emplID
AND J.EMPLID = JR.EMPLID
AND J.EMPL_RCD = #emplRcd
AND J.EMPL_RCD = JR.EMPL_RCD
AND J.EFFDT    = JR.EFFDT
AND J.EFFSEQ   = JR.EFFSEQ
and J.EFFDT = (select MAX(J1.EFFDT) 
               from PS_JOB J1 
               where J1.EMPLID = J.EMPLID 
               and J1.EMPL_RCD = J.EMPL_RCD
               and J1.ESTABID=J.ESTABID 
               and J1.EFFDT <= $effdt ) 
and J.EFFSEQ = (select MAX(J2.EFFSEQ) 
                from PS_JOB J2 
                where J2.EMPLID = J.EMPLID 
                and J2.EMPL_RCD = J.EMPL_RCD 
                and J2.EFFDT = J.EFFDT 
                and J2.ESTABID=J.ESTABID) 
and J.JOBCODE = JCR.JOBCODE 
and J.SETID_JOBCODE = JCR.SETID 
and JCR.EFFDT = (select MAX(JC1.EFFDT) 
                 from PS_JOBCODE_TBL JC1 
                 where JC1.JOBCODE = JCR.JOBCODE 
                 and JC1.SETID = JCR.SETID 
                 and JC1.EFFDT <= J.EFFDT)   
End-Select

End-Procedure Get-Job-Data

!**************************************
begin-procedure Get-Jobcode-lang
#debug show '* Get-Jobcode-lang'
!**************************************

Begin-Select
JL.DESCR

  Let $CARGO = rtrim(&JL.DESCR, ' ')
  do Check-Strings ( $CARGO , $CARGO)
   
FROM PS_JOBCODE_LANG JL
WHERE JL.EFFDT = ( 
 SELECT MAX(JC1.EFFDT) 
  FROM PS_JOBCODE_LANG JC1 
 WHERE JC1.JOBCODE = JL.JOBCODE 
   AND JC1.SETID = JL.SETID 
   AND JC1.EFFDT <= $RC_DateTo
   AND JC1.LANGUAGE_CD = $curr_language_cd )   
AND JL.JOBCODE = $JobCode
AND JL.SETID = $setid
AND JL.LANGUAGE_CD = $curr_language_cd   
End-Select

End-Procedure Get-Jobcode-lang

!**************************************
begin-procedure Get-Payee-Parm
#debug show '* Get-Payee-Parm'
!*********************************

Let $TAKER = ' '
Let $TAKER_INSCR = ' '

Begin-Sql
INSERT INTO PS_GPBR_PAYEE_PA_T
(
 PROCESS_INSTANCE
,EMPLID 
,EMPL_RCD
,GPBR_SEFIP_RIS_LVL
,GPBR_SERVICE_TAKER
,BGN_DT
)
Select
#prcs_process_instance 
,PYE1.EMPLID 
,PYE1.EMPL_RCD
,PYE1.GPBR_SEFIP_RIS_LVL
,PYE1.GPBR_SERVICE_TAKER
,PYE1.BGN_DT
FROM PS_GPBR_PAYEE_PARM PYE1
WHERE PYE1.BGN_DT = (
 SELECT MAX(PY21.BGN_DT) 
  FROM PS_GPBR_PAYEE_PARM PY21
 WHERE PY21.EMPLID = PYE1.EMPLID
   AND PY21.EMPL_RCD = PYE1.EMPL_RCD
   AND PY21.BGN_DT <= $RC_DateTo 
   AND (PY21.END_DT >= $RC_DateFrom 
   OR PY21.END_DT IS NULL))
End-Sql

do Commit-Transaction

#Ifdef ORACLE
    Begin-Sql
        ANALYZE table PS_GPBR_PAYEE_PA_T COMPUTE STATISTICS
    End-Sql
#Endif

End-Procedure Get-Payee-Parm

!**************************************
begin-procedure Row-0050
#debug show '* Row-0050'
!**************************************

Let $MANADRowType = '0050'
Let $deptID = ' '
Let #pinNum = 0
Let $Accountant_Flag = '0'
Let $IND_CENTR = ' '
Let $MANADtext = ' '
Let #rowCount = 1
Let $CNPJ = ' '
Let $CEI = ' '
Let $estabInscription = ' '
let $CNPJAsoc = ' '
 

Begin-Select
AR.ESTABID
AR.EFFDT 
AR.GPBR_ACCT_COMPANY
AR.GPBR_ACCT_CNPJ
AR.GPBR_ACCT_CPF
AR.GPBR_ACCT_CRC_NBR
AR.GPBR_ACCOUNTANT_NM
AR.GPBR_END_DATE
AR.ADDRESS2
AR.ADDRESS3
AR.POSTAL
AR.GPBR_ACCT_MBOX_POS
AR.EMPLID
AR.NUM1
AR.ADDRESS1
AR.ADDRESS4 
AR.STATE 
AR.GPBR_ACCT_MAILBOX 
AR.PHONE
AR.FAX
AR.EMAIL_ADDR

   Do convert-to-dtu-date(&AR.EFFDT , $DT_INI)
   Do convert-to-dtu-date(&AR.GPBR_END_DATE , $DT_FIN)
  
  Let $Accountant_Flag = '1'
  
  IF RTRIM(&AR.GPBR_ACCT_COMPANY, ' ') <> ''
     Let $NOME = RTRIM(&AR.GPBR_ACCT_COMPANY, ' ')
  ELSE
     Let $NOME = RTRIM(&AR.GPBR_ACCOUNTANT_NM, ' ')
  END-IF
  
  let $FullPhone = rtrim(&AR.FAX, ' ')
  do GetPhoneBRA ($FullPhone, $PhoneDDI, $PhoneDDD, $Phone, $PhoneRamal)  
  let $FAX = rtrim($PhoneDDI, ' ') || rtrim($PhoneDDD, ' ') || rtrim($Phone, ' ')
    
  let $FullPhone = rtrim(&AR.PHONE, ' ')
  do GetPhoneBRA ($FullPhone, $PhoneDDI, $PhoneDDD, $Phone, $PhoneRamal)  
  let $Phone = rtrim($PhoneDDI, ' ') || rtrim($PhoneDDD, ' ') || rtrim($Phone, ' ')  
    
  If RTRIM(&AR.EMPLID, ' ')  <> ' ' 
     Let $emplID = RTRIM(&AR.EMPLID, ' ') 
     Do Get-National-Id
  End-If
  
  Do Format-MANAD-Date($DT_INI, $DT_INI)
  IF RTRIM($DT_FIN,' ') = ''
     Do convert-to-dtu-date($RC_DateTo , $DT_FIN)
  END-IF
  
  Do Format-MANAD-Date($DT_FIN, $DT_FIN)
  if RTRIM(&AR.GPBR_ACCT_CNPJ, ' ') <> ''
     Let $estabInscription = RTRIM(&AR.GPBR_ACCT_CNPJ, ' ')
     Let $estabInscription = replace($estabInscription, '-',  '')
     Let $estabInscription = replace($estabInscription, '.',  '')
  else
     Let $estabInscription = ' '
     show 'Registro tipo 0050: Sem Dados do contabilista  ' $Nome
     show 'Nmero de inscrio do escritrio de contabilidade no CNPJ: '
  end-if
  Let $EstabID = rtrim(&AR.ESTABID, ' ')
  Let $Company = ' '
  Let $effdt = &AR.EFFDT    
  Let $UF = &E1.STATE 
  Let $COD_MUN = &E2.COUNTY_CD_BRA 
  Let $GPRptKey = $EstabID || $DT_INI
  Let $IND_MOV = '0'
  Let $NUM = &AR.NUM1
  Let $Addr1 = substr(RTRIM(&AR.ADDRESS1 , ' '),1, 30)
  Let $Addr2 = RTrim(&AR.ADDRESS2, ' ')
  Let $Addr3 = RTrim(&AR.ADDRESS3, ' ')
  Let $Addr4 = substr(RTRIM(&AR.ADDRESS4, ' ')1,20)
  do Check-Strings ( $Addr1 , $Addr1)
  do Check-Strings ( $Addr2 , $Addr2)
  do Check-Strings ( $Addr3 , $Addr3)
  do Check-Strings ( $Addr4 , $Addr4)
  Let $CPF = rtrim(&AR.GPBR_ACCT_CPF, ' ')
  Let $CPF = replace($CPF, '-',  '') 
  Let $CPF = replace($CPF, '.',  '')   
  Let $COMPL = $Addr2 || ' ' || $Addr3
  Let $CEP = EDIT(replace(&AR.POSTAL, '-',  ''), '00000000')
 
  Let $CAIXA_CEP = REPLACE(&AR.GPBR_ACCT_MBOX_POS, ' ', '')
  Let $CAIXA_CEP = REPLACE(&AR.GPBR_ACCT_MBOX_POS, '-', '')
  
  Let $CAIXA_CEP = EDIT($CAIXA_CEP, '00000000')
  Let $CRC = rtrim(&AR.GPBR_ACCT_CRC_NBR, ' ')
  Let $CRC = replace($CRC, '-', '')
  Let $CRC = replace($CRC, '.', '')
  
  Let $MANADtext = $NOME || '|' ||  $estabInscription  || '|' || $CPF || '|' || $CRC || '|'
  Let $MANADtext = $MANADtext || $DT_INI || '|' || $DT_FIN || '|' 
  Let $MANADtext = $MANADtext || $Addr1 || '|' || rtrim($NUM, ' ') || '|' || substr($COMPL,1, 20) || '|' || $Addr4 || '|'
  Let $MANADtext = $MANADtext || $CEP || '|' || RTRIM(&AR.STATE, ' ') || '|' || RTRIM(&AR.GPBR_ACCT_MAILBOX, ' ') || '|' ||  $CAIXA_CEP || '|'
  Let $MANADtext = $MANADtext || $PHONE|| '|' || $FAX || '|' || &AR.EMAIL_ADDR     

  Do Insert-MANAD-TMP

FROM PS_GPBR_MANAD_ACCT AR
WHERE AR.ESTABID = $RC_estabID
AND ((AR.EFFDT BETWEEN $RC_DateFrom AND $RC_DateTo) 
OR (AR.GPBR_END_DATE BETWEEN $RC_DateFrom AND $RC_DateTo)
OR (AR.EFFDT = (SELECT MAX(AR1.EFFDT) 
               FROM PS_GPBR_MANAD_ACCT AR1
               WHERE AR1.ESTABID = AR.ESTABID
               and AR1.EFFDT <= $RC_DateTo)
    AND AR.GPBR_END_DATE IS NULL)
OR (AR.EFFDT < $RC_DateFrom AND 
    AR.GPBR_END_DATE > $RC_DateTo) )
End-Select

If $Accountant_Flag = '0'
  show 'Registro tipo 0050: Sem Dados do contabilista  '  
end-if

End-Procedure Row-0050

!**************************************
Begin-Procedure Create-Base-IT-K250
#debug show '* Create-Base-IT-K250'
!**************************************

!* GPBR_RUN_TYPE_TERM = 1 (IT) 
!* GPBR_RUN_TYPE_TERM = 2 (INSS)

!* IT - 1 - Elements in the setup found on the results
Begin-Sql
Insert Into PS_GPBR_RSLT_DTL_T
(
  PROCESS_INSTANCE
, EMPLID
, EMPL_RCD
, GP_RPT_KEY
, ESTABID
, PIN_TYPE
, PIN_NUM
, GPBR_RUN_TYPE_TERM
, CALC_RSLT_VAL
, GPBR_IT_BASE_TYPE
)
SELECT DISTINCT
  A1.PROCESS_INSTANCE
, A1.EMPLID
, A1.EMPL_RCD
, A1.GP_RPT_KEY
, R.ESTABID
, R.PIN_TYPE
, R.PIN_NUM
, '1'
, CASE WHEN (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) < 0 THEN 0 ELSE (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) END
, IT.GPBR_IT_BASE_TYPE
   FROM PS_GPBR_MANAD_TMP2 A1
      , PS_GPBR_RGST_DTL_T R 
      , PS_GPBR_CENT_ESTAB CENT
      , PS_GPBR_MANAD_IT IT 
   WHERE A1.PROCESS_INSTANCE    = #prcs_process_instance 
     AND A1.GPBR_MAN_ROW_TYPE   = 'K250'
     AND R.PROCESS_INSTANCE     = #prcs_process_instance
     AND CENT.PROCESS_INSTANCE  = #prcs_process_instance 
     AND CENT.CENTR_ESTABID_BRA = $RC_estabID
     AND A1.EMPLID      = R.EMPLID
     AND A1.EMPL_RCD    = R.EMPL_RCD
     AND A1.ESTABID     = R.ESTABID
     AND A1.GP_RPT_KEY  = R.GP_RPT_KEY
     AND CENT.ESTABID =  R.ESTABID 
     AND R.PIN_TYPE <> 'AC'
     AND A1.RUN_TYPE = R.RUN_TYPE  
     AND IT.ESTABID = CENT.CENTR_ESTABID_BRA
     AND IT.EFFDT = (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = IT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A') 
     AND IT.GPBR_BASE_FLG = 'Y' 
     AND R.PIN_NUM =  IT.GPBR_PIN_MAN_NUM
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RSLT_DTL_T COMPUTE STATISTICS
    end-sql

#endif

!* IT - 2 - Accumulators in the setup found on the results
Begin-Sql
Insert Into PS_GPBR_RSLT_DTL_T
(
  PROCESS_INSTANCE
, EMPLID
, EMPL_RCD
, GP_RPT_KEY
, ESTABID
, PIN_TYPE
, PIN_NUM
, GPBR_RUN_TYPE_TERM
, CALC_RSLT_VAL
, GPBR_IT_BASE_TYPE
)
SELECT DISTINCT 
  A1.PROCESS_INSTANCE
, A1.EMPLID
, A1.EMPL_RCD
, A1.GP_RPT_KEY
, R.ESTABID
, R.PIN_TYPE
, R.PIN_NUM
, '1'
, CASE WHEN (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) < 0 THEN 0 ELSE (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) END
, IT.GPBR_IT_BASE_TYPE
   FROM PS_GPBR_MANAD_TMP2 A1
      , PS_GPBR_RGST_DTL_T R 
      , PS_GPBR_CENT_ESTAB CENT
      , PS_GPBR_MANAD_IT IT 
      , PS_GP_ACM_MBR M 
   WHERE A1.PROCESS_INSTANCE = #prcs_process_instance 
     AND A1.GPBR_MAN_ROW_TYPE = 'K250'
     AND R.PROCESS_INSTANCE = #prcs_process_instance
     AND CENT.PROCESS_INSTANCE = #prcs_process_instance
     AND CENT.CENTR_ESTABID_BRA = $RC_estabID
     AND A1.EMPLID = R.EMPLID
     AND A1.EMPL_RCD = R.EMPL_RCD
     AND A1.ESTABID = R.ESTABID
     AND A1.GP_RPT_KEY = R.GP_RPT_KEY
     AND CENT.ESTABID =  R.ESTABID 
     AND IT.ESTABID = CENT.CENTR_ESTABID_BRA
     AND IT.EFFDT = (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = IT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                                              AND IT2.EFF_STATUS = 'A') 
     AND IT.GPBR_BASE_FLG = 'Y' 
     AND M.PIN_NUM = IT.GPBR_PIN_MAN_NUM
     AND R.PIN_NUM = M.PIN_MBR_NUM
     AND M.BGN_DT <= R.SLICE_END_DT
     AND ( M.END_DT >= R.SLICE_END_DT OR M.END_DT IS NULL)
     AND NOT EXISTS (SELECT 'X' FROM PS_GPBR_RSLT_DTL_T RSINT
                      WHERE RSINT.PROCESS_INSTANCE = #prcs_process_instance 
                        AND RSINT.EMPLID = A1.EMPLID
                        AND RSINT.EMPL_RCD = A1.EMPL_RCD
                        AND RSINT.GP_RPT_KEY = A1.GP_RPT_KEY
                        AND RSINT.ESTABID = R.ESTABID
                        AND RSINT.PIN_TYPE = R.PIN_TYPE
                        AND RSINT.GPBR_RUN_TYPE_TERM = '1')
     
End-Sql
do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RSLT_DTL_T COMPUTE STATISTICS
    end-sql

#endif

Begin-Sql
UPDATE PS_GPBR_RSLT_DTL_T
  Set CALC_RSLT_VAL = 0 
  WHERE PROCESS_INSTANCE = #prcs_process_instance
    AND GPBR_IT_BASE_TYPE = '9'
End-Sql

Begin-Sql
Insert Into PS_GPBR_RSLT_IT_T
(
   PROCESS_INSTANCE
 , EMPLID
 , EMPL_RCD
 , GP_RPT_KEY
 , ESTABID
 , CALC_RSLT_VAL
)
SELECT
   TOT.PROCESS_INSTANCE
 , TOT.EMPLID
 , TOT.EMPL_RCD
 , TOT.GP_RPT_KEY
 , TOT.ESTABID
 , SUM(TOT.CALC_RSLT_VAL)
 FROM PS_GPBR_RSLT_DTL_T  TOT
  where TOT.PROCESS_INSTANCE = #prcs_process_instance 
    and TOT.GPBR_RUN_TYPE_TERM = '1'
  GROUP BY TOT.PROCESS_INSTANCE,TOT.EMPLID, TOT.EMPL_RCD, TOT.GP_RPT_KEY, TOT.ESTABID  
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RSLT_IT_T COMPUTE STATISTICS
    end-sql

#endif

! INSS

Begin-Sql
Insert Into PS_GPBR_RSLT_DTL_T
(
  PROCESS_INSTANCE
, EMPLID
, EMPL_RCD
, GP_RPT_KEY
, ESTABID
, PIN_TYPE
, PIN_NUM
, GPBR_RUN_TYPE_TERM
, CALC_RSLT_VAL
, GPBR_IT_BASE_TYPE
)
SELECT DISTINCT
  A1.PROCESS_INSTANCE
, A1.EMPLID
, A1.EMPL_RCD
, A1.GP_RPT_KEY
, R.ESTABID
, R.PIN_TYPE
, R.PIN_NUM
, '2'
, CASE WHEN (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) < 0 THEN 0 ELSE (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) END
, IT.GPBR_INSS_BSE_TYPE
   FROM PS_GPBR_MANAD_TMP2 A1
      , PS_GPBR_RGST_DTL_T R  
      , PS_GPBR_CENT_ESTAB CENT
      , PS_GPBR_MANAD_INSS IT 
   WHERE A1.PROCESS_INSTANCE = #prcs_process_instance 
     AND A1.GPBR_MAN_ROW_TYPE = 'K250'
     AND R.PROCESS_INSTANCE = #prcs_process_instance
     AND CENT.PROCESS_INSTANCE = #prcs_process_instance
     AND CENT.CENTR_ESTABID_BRA = $RC_estabID
     AND A1.EMPLID = R.EMPLID
     AND A1.EMPL_RCD = R.EMPL_RCD
     AND A1.ESTABID = R.ESTABID
     AND A1.GP_RPT_KEY = R.GP_RPT_KEY
     AND CENT.ESTABID =  R.ESTABID 
     AND R.PIN_TYPE <> 'AC'
     AND A1.RUN_TYPE = R.RUN_TYPE  
     AND IT.ESTABID = CENT.CENTR_ESTABID_BRA
     AND IT.EFFDT = (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = IT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A') 
     AND IT.GPBR_BASE_FLG = 'Y' 
     AND R.PIN_NUM =  IT.GPBR_PIN_MAN_NUM
     
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RSLT_DTL_T COMPUTE STATISTICS
    end-sql
#endif

Begin-Sql
Insert Into PS_GPBR_RSLT_DTL_T
(
  PROCESS_INSTANCE
, EMPLID
, EMPL_RCD
, GP_RPT_KEY
, ESTABID
, PIN_TYPE
, PIN_NUM
, GPBR_RUN_TYPE_TERM
, CALC_RSLT_VAL
, GPBR_IT_BASE_TYPE
)
SELECT 
  A1.PROCESS_INSTANCE
, A1.EMPLID
, A1.EMPL_RCD
, A1.GP_RPT_KEY
, R.ESTABID
, R.PIN_TYPE
, R.PIN_NUM
, '2'
, CASE WHEN (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) < 0 THEN 0 ELSE (R.CALC_RSLT_VAL + R.CALC_ADJ_VAL) END
, IT.GPBR_INSS_BSE_TYPE
   FROM PS_GPBR_MANAD_TMP2 A1
      , PS_GPBR_RGST_DTL_T R  
      , PS_GPBR_CENT_ESTAB CENT
      , PS_GPBR_MANAD_INSS IT 
      , PS_GP_ACM_MBR M
   WHERE A1.PROCESS_INSTANCE = #prcs_process_instance 
     AND A1.GPBR_MAN_ROW_TYPE = 'K250'
     AND R.PROCESS_INSTANCE = #prcs_process_instance 
     AND CENT.PROCESS_INSTANCE = #prcs_process_instance 
     AND CENT.CENTR_ESTABID_BRA = $RC_estabID
     AND A1.EMPLID = R.EMPLID
     AND A1.EMPL_RCD = R.EMPL_RCD
     AND A1.ESTABID = R.ESTABID
     AND A1.GP_RPT_KEY = R.GP_RPT_KEY
     AND CENT.ESTABID =  R.ESTABID 
     AND IT.ESTABID = CENT.CENTR_ESTABID_BRA
     AND IT.EFFDT = (  SELECT MAX(IT2.EFFDT) FROM PS_GPBR_MANAD_PARM IT2 
                        WHERE IT2.ESTABID = IT.ESTABID 
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A') 
     AND IT.GPBR_BASE_FLG = 'Y' 
     AND M.PIN_NUM = IT.GPBR_PIN_MAN_NUM
     AND R.PIN_NUM = M.PIN_MBR_NUM
     AND M.BGN_DT <= R.SLICE_END_DT
      AND ( M.END_DT >= R.SLICE_END_DT OR M.END_DT IS NULL)
         AND NOT EXISTS (SELECT 'X' FROM PS_GPBR_RSLT_DTL_T RSINT
                      WHERE RSINT.PROCESS_INSTANCE = #prcs_process_instance
                        AND RSINT.EMPLID = A1.EMPLID
                        AND RSINT.EMPL_RCD = A1.EMPL_RCD
                        AND RSINT.GP_RPT_KEY = A1.GP_RPT_KEY
                        AND RSINT.ESTABID = R.ESTABID
                        AND RSINT.PIN_TYPE = R.PIN_TYPE
                        AND RSINT.GPBR_RUN_TYPE_TERM = '2')
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RSLT_DTL_T COMPUTE STATISTICS
    end-sql
#endif

Begin-Sql
Update PS_GPBR_RSLT_DTL_T
  Set CALC_RSLT_VAL = 0 
  WHERE PROCESS_INSTANCE = #prcs_process_instance
    AND GPBR_IT_BASE_TYPE = '9'
End-Sql

Begin-Sql
Insert Into PS_GPBR_RSLT_INS_T
(
   PROCESS_INSTANCE
 , EMPLID
 , EMPL_RCD
 , GP_RPT_KEY
 , ESTABID
 , CALC_RSLT_VAL
)
SELECT
   TOT.PROCESS_INSTANCE
 , TOT.EMPLID
 , TOT.EMPL_RCD
 , TOT.GP_RPT_KEY
 , TOT.ESTABID
 , SUM(TOT.CALC_RSLT_VAL)
 FROM PS_GPBR_RSLT_DTL_T  TOT
  where TOT.PROCESS_INSTANCE = #prcs_process_instance 
    and TOT.GPBR_RUN_TYPE_TERM = '2'
  GROUP BY TOT.PROCESS_INSTANCE,TOT.EMPLID, TOT.EMPL_RCD, TOT.GP_RPT_KEY, TOT.ESTABID  
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_RSLT_INS_T COMPUTE STATISTICS
    end-sql
#endif

End-Procedure Create-Base-IT-K250

!**************************************
Begin-Procedure Write-k250
#debug show '* Write-k250'
!**************************************

Begin-Select
WRT4.GPBR_MAN_ROW_TYPE
WRT4.EMPLID
WRT4.EMPL_RCD
WRT4.RUN_TYPE
WRT4.GPBR_RUN_TYPE_ID
WRT4.DEPTID
WRT4.EFFDT
WRT4.ESTAB_ID_BRA
WRT4.GPBR_MAN_EMP_FORM
WRT4.GPBR_SERVICE_TAKER
WRT4.GPBR_SEFIP_RIS_LVL
WRT4.PYMNT_DT
WRT4.CBO_CD_BRA
WRT4.DESCR
WRT4.GPBR_FAM_ALLOW_IND
WRT4.GPBR_INC_TAX_IND
WRT4.GPBR_IRRF_BASE_VAL
WRT4.GPBR_INSS_BASE_VAL
WRT4.GPBR_TAKER_INSCR


     Do convert-to-dtu-date(&WRT4.EFFDT , $PeriodEnd)
     Let $estabInscription = &WRT4.ESTAB_ID_BRA
     Let $estabInscription = replace($estabInscription, '-',  '') 
     Let $estabInscription = replace($estabInscription, '.',  '')
     
     Let $IND_FL = Rtrim(&WRT4.GPBR_RUN_TYPE_ID, ' ')

     Let $deptID = Rtrim(&WRT4.DEPTID, ' ')
    
     Let $K_IND_MOV = '0'
    
     Let $emplID = Rtrim(&WRT4.EMPLID, ' ')  
     Let #emplRcd  = &WRT4.EMPL_RCD 
     
     IF rtrim(&WRT4.GPBR_MAN_EMP_FORM, ' ') = 'Y'
        Let $COD_REG_TRAB =  $emplID || ' ' || to_char(#emplRcd) 
     else 
        Let $COD_REG_TRAB =  $emplID  
     end-if

     Do convert-to-dtu-date(&WRT4.PYMNT_DT , $DT_PGTO)
     Do Format-MANAD-Date($DT_PGTO, $DT_PGTO)  
     Do Format-MANAD-Date($PeriodEnd, $PeriodEnd)  
    
     If $IND_FL <> '2'
        Let $PeriodEnd = Substr($PeriodEnd,3,6)
     Else
        Let $PeriodEnd = '13' || Substr($PeriodEnd,5,4)
     End-If  

     Let $COD_CBO = Edit(replace(&WRT4.CBO_CD_BRA, '-',''), '000000')  
     
     
     Let $CARGO = Rtrim(&WRT4.DESCR, ' ')                         
     Do Check-Strings ( $CARGO  , $CARGO )
     
     Let $COD_OCORR = Rtrim(&WRT4.GPBR_SEFIP_RIS_LVL,' ')
     
     Let $GPBR_SERVICE_TAKER = rtrim(&WRT4.GPBR_SERVICE_TAKER, ' ')
     
     If $GPBR_SERVICE_TAKER <> ''
        Let $GPBR_SERVICE_TAKER = ' ' || $GPBR_SERVICE_TAKER
     End-If
      
     Let #QTD_DEP_IR = &WRT4.GPBR_INC_TAX_IND
     Let $QTD_DEP_IR = Edit(#QTD_DEP_IR, '00')

     Let #QTD_DEP_SF = &WRT4.GPBR_FAM_ALLOW_IND
     Let $QTD_DEP_SF = Edit(#QTD_DEP_SF, '00')
     
     If &WRT4.GPBR_IRRF_BASE_VAL > 0 
          
          Let #VL_BASE_IRRF = &WRT4.GPBR_IRRF_BASE_VAL
          Let #VL_BASE_IRRF_INT = (trunc(abs(&WRT4.GPBR_IRRF_BASE_VAL),0) * 1)
          Let $VL_BASE_IRRF_INT = LTRIM(rtrim(EDIT(#VL_BASE_IRRF_INT,'99999999999'), ' '), ' ')
          Let #VL_BASE_IRRF_DEC = round((#VL_BASE_IRRF - #VL_BASE_IRRF_INT),2)
          
          If #VL_BASE_IRRF_DEC >= 1
             Let #VL_BASE_IRRF_INT = #VL_BASE_IRRF_INT + (trunc(abs(#VL_BASE_IRRF_DEC),0) * 1)
             Let $VL_BASE_IRRF_INT = LTRIM(rtrim(EDIT(#VL_BASE_IRRF_INT,'99999999999'), ' '), ' ')
             Let $VL_BASE_IRRF_DEC = '00'
          else
             Let $VL_BASE_IRRF_DEC = ltrim(rtrim(edit(round((#VL_BASE_IRRF_DEC * 100),2), '00') , ' '), ' ')
          End-If
          
          If #VL_BASE_IRRF_DEC > 0
             Let $VL_BASE_IRRF = $VL_BASE_IRRF_INT || ',' || $VL_BASE_IRRF_DEC
          Else
             Let $VL_BASE_IRRF = $VL_BASE_IRRF_INT  || ',00' 
          End-if
     Else
         Let $VL_BASE_IRRF = '0'
     End-If
     Let $TAKER_INSCR = &WRT4.GPBR_TAKER_INSCR
 
     If &WRT4.GPBR_INSS_BASE_VAL > 0 
 
         Let #VL_BASE_PS = &WRT4.GPBR_INSS_BASE_VAL
         Let #VL_BASE_PS_INT = (trunc(abs(&WRT4.GPBR_INSS_BASE_VAL),0) * 1)
         Let $VL_BASE_PS_INT = LTRIM(rtrim(EDIT(#VL_BASE_PS_INT,'99999999999'), ' ') , ' ')
         Let #VL_BASE_PS_DEC = round((#VL_BASE_PS - #VL_BASE_PS_INT),2)
         
         If #VL_BASE_PS_DEC >= 1
             Let #VL_BASE_PS_INT = #VL_BASE_PS_INT + (trunc(abs(#VL_BASE_PS_DEC),0) * 1)
             Let $VL_BASE_PS_INT = LTRIM(rtrim(EDIT(#VL_BASE_PS_INT,'99999999999'), ' ') , ' ')
             Let $VL_BASE_PS_DEC = '00'
         Else
             Let $VL_BASE_PS_DEC = ltrim(rtrim(edit((#VL_BASE_PS_DEC * 100), '00') , ' '), ' ')
         End-if
             
         If #VL_BASE_PS_DEC > 0
            Let $VL_BASE_PS = $VL_BASE_PS_INT || ',' || $VL_BASE_PS_DEC
         Else
            Let $VL_BASE_PS = $VL_BASE_PS_INT  || ',00' 
         End-if
     Else
         Let $VL_BASE_PS = '0' 
     End-If      

     Let $MANADtext = rtrim($estabInscription, ' ') || '|' || $IND_FL || '|' || $deptID || $GPBR_SERVICE_TAKER || '|' 
     let $MANADtext = $MANADtext || $COD_REG_TRAB || '|' || $PeriodEnd || '|' || $DT_PGTO || '|' || $COD_CBO || '|'
     Let $MANADtext = $MANADtext || $COD_OCORR || '|' || $CARGO  || '|' || $QTD_DEP_IR || '|' || $QTD_DEP_SF || '|' 
     Let $MANADtext = $MANADtext || $VL_BASE_IRRF || '|' || $VL_BASE_PS

  write 1 from
    &WRT4.GPBR_MAN_ROW_TYPE '|' -
    $MANADtext

FROM PS_GPBR_MANAD_TMP4 WRT4 
WHERE WRT4.PROCESS_INSTANCE = #prcs_process_instance
  AND WRT4.GPBR_MAN_ROW_TYPE = 'K250'
ORDER BY WRT4.ESTAB_ID_BRA, WRT4.EMPLID, WRT4.EFFDT, WRT4.GPBR_RUN_TYPE_ID
End-Select

End-Procedure Write-k250

!*****************************
Begin-Procedure Get-Acum-type-INSS
#debug show '* Get-Acum-type-INSS'
!**************************************

!Seleciona elementos que no so acumuladores

Begin-Sql
Insert Into PS_GPBR_ACM_INSS_T
(
 PROCESS_INSTANCE
,ESTABID
,EMPLID
,EMPL_RCD
,GP_RPT_KEY  
,PIN_NUM
,GPBR_INSS_BSE_TYPE
)
Select   DISTINCT
 #prcs_process_instance
,R.ESTABID
,R.EMPLID
,R.EMPL_RCD
,R.GP_RPT_KEY  
,R.PIN_NUM
,INM.GPBR_INSS_BSE_TYPE
FROM PS_GPBR_MANAD_INSS INM
    ,PS_GPBR_MANAD_TMP2 R 
    ,PS_GPBR_CENT_ESTAB CENT
WHERE R.PROCESS_INSTANCE  = #prcs_process_instance
AND CENT.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.CENTR_ESTABID_BRA = $RC_estabID
AND INM.ESTABID = CENT.CENTR_ESTABID_BRA
AND R.ESTABID = CENT.ESTABID 
AND INM.EFFDT = ( SELECT MAX(IT2.EFFDT) 
                 FROM PS_GPBR_MANAD_PARM IT2 
                 WHERE IT2.ESTABID  = INM.ESTABID
                   AND IT2.EFFDT <= $AsOfToday
                   AND IT2.EFF_STATUS = 'A') 
AND R.GPBR_MAN_ROW_TYPE = 'K300'
AND R.PIN_NUM = INM.GPBR_PIN_MAN_NUM
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_ACM_INSS_T COMPUTE STATISTICS
    end-sql

#endif


! insert 2 - Seleciona elementos membros de acumuladores inss

#ifdef MICROSOFT ! Microsoft Block
Begin-Sql
 Insert Into PS_GPBR_ACM_INSS_T
 (
  PROCESS_INSTANCE
 ,ESTABID
 ,EMPLID
 ,EMPL_RCD
 ,GP_RPT_KEY  
 ,PIN_NUM
 ,GPBR_INSS_BSE_TYPE
 )
 Select   DISTINCT
  #prcs_process_instance
 ,R.ESTABID
 ,R.EMPLID
 ,R.EMPL_RCD
 ,R.GP_RPT_KEY  
 ,R.PIN_NUM
 ,INM.GPBR_INSS_BSE_TYPE
 FROM PS_GPBR_MANAD_INSS INM
     ,PS_GP_ACM_MBR M
     ,PS_GPBR_MANAD_TMP2 R 
     ,PS_GPBR_CENT_ESTAB CENT
 WHERE R.PROCESS_INSTANCE  = #prcs_process_instance
 AND CENT.PROCESS_INSTANCE = #prcs_process_instance
 AND CENT.CENTR_ESTABID_BRA = $RC_estabID
 AND INM.ESTABID = CENT.CENTR_ESTABID_BRA
 AND R.ESTABID = CENT.ESTABID 
 AND INM.EFFDT = ( SELECT MAX(IT2.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM IT2 
                  WHERE IT2.ESTABID  = INM.ESTABID
                          AND IT2.EFFDT <= $AsOfToday
                          AND IT2.EFF_STATUS = 'A') 
 AND R.GPBR_RUN_TYPE_ID = REPLACE(INM.GPBR_INSS_BSE_TYPE,'9','6')                                  
 AND R.GPBR_MAN_ROW_TYPE = 'K300'
 AND M.PIN_NUM = INM.GPBR_PIN_MAN_NUM
 AND R.PIN_NUM = M.PIN_MBR_NUM
 AND M.BGN_DT <= R.PYMNT_DT
 AND ( M.END_DT >= R.PYMNT_DT OR M.END_DT IS NULL)
 AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_ACM_INSS_T NECHK                
                 WHERE NECHK.PROCESS_INSTANCE = #prcs_process_instance
                   AND NECHK.ESTABID  = R.ESTABID
                   AND NECHK.EMPLID   = R.EMPLID
                   AND NECHK.EMPL_RCD = R.EMPL_RCD
                   AND NECHK.GP_RPT_KEY   = R.GP_RPT_KEY  
                   AND NECHK.PIN_NUM = R.PIN_NUM)
 End-Sql
#endif

#ifndef MICROSOFT ! non - Microsoft Block

Begin-Sql
 Insert Into PS_GPBR_ACM_INSS_T
 (
  PROCESS_INSTANCE
 ,ESTABID
 ,EMPLID
 ,EMPL_RCD
 ,GP_RPT_KEY  
 ,PIN_NUM
 ,GPBR_INSS_BSE_TYPE
 )
 Select   DISTINCT
  #prcs_process_instance
 ,R.ESTABID
 ,R.EMPLID
 ,R.EMPL_RCD
 ,R.GP_RPT_KEY  
 ,R.PIN_NUM
 ,INM.GPBR_INSS_BSE_TYPE
 FROM PS_GPBR_MANAD_INSS INM
     ,PS_GP_ACM_MBR M
     ,PS_GPBR_MANAD_TMP2 R 
     ,PS_GPBR_CENT_ESTAB CENT
 WHERE R.PROCESS_INSTANCE  = #prcs_process_instance
 AND CENT.PROCESS_INSTANCE = #prcs_process_instance
 AND CENT.CENTR_ESTABID_BRA = $RC_estabID
 AND INM.ESTABID = CENT.CENTR_ESTABID_BRA
 AND R.ESTABID = CENT.ESTABID 
 AND INM.EFFDT = ( SELECT MAX(IT2.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM IT2 
                  WHERE IT2.ESTABID  = INM.ESTABID
                          AND IT2.EFFDT <= $AsOfToday
                          AND IT2.EFF_STATUS = 'A') 
 AND R.GPBR_RUN_TYPE_ID = TRANSLATE(INM.GPBR_INSS_BSE_TYPE,'9','6')                                  
 AND R.GPBR_MAN_ROW_TYPE = 'K300'
 AND M.PIN_NUM = INM.GPBR_PIN_MAN_NUM
 AND R.PIN_NUM = M.PIN_MBR_NUM
 AND M.BGN_DT <= R.PYMNT_DT
 AND ( M.END_DT >= R.PYMNT_DT OR M.END_DT IS NULL)
 AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_ACM_INSS_T NECHK                
                 WHERE NECHK.PROCESS_INSTANCE = #prcs_process_instance
                   AND NECHK.ESTABID  = R.ESTABID
                   AND NECHK.EMPLID   = R.EMPLID
                   AND NECHK.EMPL_RCD = R.EMPL_RCD
                   AND NECHK.GP_RPT_KEY   = R.GP_RPT_KEY  
                   AND NECHK.PIN_NUM = R.PIN_NUM)
 End-Sql
#endif
do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_ACM_INSS_T COMPUTE STATISTICS
    end-sql

#endif

! insert 3 - Seleciona elementos membros de acumuladores com base exclusiva/deducoes

Begin-Sql
Insert Into PS_GPBR_ACM_INSS_T
(
 PROCESS_INSTANCE
,ESTABID
,EMPLID
,EMPL_RCD
,GP_RPT_KEY  
,PIN_NUM
,GPBR_INSS_BSE_TYPE
)
Select   DISTINCT
 #prcs_process_instance
,R.ESTABID
,R.EMPLID
,R.EMPL_RCD
,R.GP_RPT_KEY  
,R.PIN_NUM
,INM.GPBR_INSS_BSE_TYPE
FROM PS_GPBR_MANAD_INSS INM
    ,PS_GP_ACM_MBR M
    ,PS_GPBR_MANAD_TMP2 R 
    ,PS_GPBR_CENT_ESTAB CENT
WHERE R.PROCESS_INSTANCE  = #prcs_process_instance
AND CENT.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.CENTR_ESTABID_BRA = $RC_estabID
AND INM.ESTABID = CENT.CENTR_ESTABID_BRA
AND R.ESTABID = CENT.ESTABID 
AND INM.EFFDT = ( SELECT MAX(IT2.EFFDT) 
                 FROM PS_GPBR_MANAD_PARM IT2 
                 WHERE IT2.ESTABID  = INM.ESTABID
                         AND IT2.EFFDT <= $AsOfToday
                         AND IT2.EFF_STATUS = 'A') 
AND R.GPBR_MAN_ROW_TYPE = 'K300'
AND M.PIN_NUM = INM.GPBR_PIN_MAN_NUM
AND R.PIN_NUM = M.PIN_MBR_NUM
AND M.BGN_DT <= R.PYMNT_DT
AND ( M.END_DT >= R.PYMNT_DT OR M.END_DT IS NULL)
AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_ACM_INSS_T NECHK                
                WHERE NECHK.PROCESS_INSTANCE = #prcs_process_instance
                  AND NECHK.ESTABID  = R.ESTABID
                  AND NECHK.EMPLID   = R.EMPLID
                  AND NECHK.EMPL_RCD = R.EMPL_RCD
                  AND NECHK.GP_RPT_KEY   = R.GP_RPT_KEY  
                  AND NECHK.PIN_NUM = R.PIN_NUM)
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_ACM_INSS_T COMPUTE STATISTICS
    end-sql
#endif

End-Procedure Get-Acum-type-INSS

!*****************************
Begin-Procedure Get-Acum-type-IT
#debug show '* Get-Acum-type-IT'
!**************************************

!Seleciona elementos que no so acumuladores

Begin-Sql
Insert Into PS_GPBR_ACM_IT_T 
(
 PROCESS_INSTANCE
,ESTABID
,EMPLID
,EMPL_RCD
,GP_RPT_KEY  
,PIN_NUM
,GPBR_IT_BASE_TYPE
)
Select  DISTINCT
 #prcs_process_instance
,IT_R.ESTABID
,IT_R.EMPLID
,IT_R.EMPL_RCD
,IT_R.GP_RPT_KEY  
,IT_R.PIN_NUM
,IT_INM.GPBR_IT_BASE_TYPE
FROM PS_GPBR_MANAD_IT   IT_INM
    ,PS_GPBR_MANAD_TMP2 IT_R 
    ,PS_GPBR_CENT_ESTAB CENT
WHERE IT_R.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.CENTR_ESTABID_BRA = $RC_estabID
AND IT_INM.ESTABID = CENT.CENTR_ESTABID_BRA
AND IT_R.ESTABID = CENT.ESTABID
AND IT_INM.EFFDT = ( SELECT MAX(IT_IT2.EFFDT) 
                 FROM PS_GPBR_MANAD_PARM IT_IT2 
                 WHERE IT_IT2.ESTABID  = IT_INM.ESTABID
                         AND IT_IT2.EFFDT <= $AsOfToday
                         AND IT_IT2.EFF_STATUS = 'A') 
AND IT_R.GPBR_MAN_ROW_TYPE = 'K300'        
AND IT_R.PIN_NUM = IT_INM.GPBR_PIN_MAN_NUM
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_ACM_IT_T COMPUTE STATISTICS
    end-sql

#endif


! insert 2 - Seleciona elementos membros de acumuladores


#ifdef MICROSOFT ! Microsoft Block
Begin-Sql
 Insert Into PS_GPBR_ACM_IT_T 
 (
  PROCESS_INSTANCE
 ,ESTABID
 ,EMPLID
 ,EMPL_RCD
 ,GP_RPT_KEY  
 ,PIN_NUM
 ,GPBR_IT_BASE_TYPE
 )
 Select   DISTINCT
  #prcs_process_instance
 ,IT_R.ESTABID
 ,IT_R.EMPLID
 ,IT_R.EMPL_RCD
 ,IT_R.GP_RPT_KEY  
 ,IT_R.PIN_NUM
 ,IT_INM.GPBR_IT_BASE_TYPE
 FROM PS_GPBR_MANAD_IT IT_INM
    ,PS_GP_ACM_MBR IT_M
    ,PS_GPBR_MANAD_TMP2 IT_R 
    ,PS_GPBR_CENT_ESTAB CENT
 WHERE IT_R.PROCESS_INSTANCE = #prcs_process_instance
 AND CENT.PROCESS_INSTANCE = #prcs_process_instance
 AND CENT.CENTR_ESTABID_BRA = $RC_estabID
 AND IT_INM.ESTABID = CENT.CENTR_ESTABID_BRA
 AND IT_R.ESTABID = CENT.ESTABID
 AND IT_INM.EFFDT = ( SELECT MAX(IT_IT2.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM IT_IT2 
                  WHERE IT_IT2.ESTABID  = IT_INM.ESTABID
                          AND IT_IT2.EFFDT <= $AsOfToday
                          AND IT_IT2.EFF_STATUS = 'A') 
 AND IT_R.GPBR_RUN_TYPE_ID = REPLACE(IT_INM.GPBR_IT_BASE_TYPE,'9','6')                 
 AND IT_R.GPBR_MAN_ROW_TYPE = 'K300'
 AND IT_M.PIN_NUM = IT_INM.GPBR_PIN_MAN_NUM
 AND IT_R.PIN_NUM = IT_M.PIN_MBR_NUM
 AND IT_M.BGN_DT <= IT_R.PYMNT_DT
 AND ( IT_M.END_DT >= IT_R.PYMNT_DT OR IT_M.END_DT IS NULL)
 AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_ACM_IT_T NECHK                
                 WHERE NECHK.PROCESS_INSTANCE = #prcs_process_instance
                   AND NECHK.ESTABID  = IT_R.ESTABID
                   AND NECHK.EMPLID   = IT_R.EMPLID
                   AND NECHK.EMPL_RCD = IT_R.EMPL_RCD
                   AND NECHK.GP_RPT_KEY   = IT_R.GP_RPT_KEY  
                   AND NECHK.PIN_NUM = IT_R.PIN_NUM)
 End-Sql
#endif

#ifNdef MICROSOFT ! non - Microsoft Block
 Begin-Sql
 Insert Into PS_GPBR_ACM_IT_T 
 (
  PROCESS_INSTANCE
 ,ESTABID
 ,EMPLID
 ,EMPL_RCD
 ,GP_RPT_KEY  
 ,PIN_NUM
 ,GPBR_IT_BASE_TYPE
 )
 Select   DISTINCT
  #prcs_process_instance
 ,IT_R.ESTABID
 ,IT_R.EMPLID
 ,IT_R.EMPL_RCD
 ,IT_R.GP_RPT_KEY  
 ,IT_R.PIN_NUM
 ,IT_INM.GPBR_IT_BASE_TYPE
 FROM PS_GPBR_MANAD_IT IT_INM
     ,PS_GP_ACM_MBR IT_M
     ,PS_GPBR_MANAD_TMP2 IT_R 
     ,PS_GPBR_CENT_ESTAB CENT
 WHERE IT_R.PROCESS_INSTANCE = #prcs_process_instance
 AND CENT.PROCESS_INSTANCE = #prcs_process_instance
 AND CENT.CENTR_ESTABID_BRA = $RC_estabID
 AND IT_INM.ESTABID = CENT.CENTR_ESTABID_BRA
 AND IT_R.ESTABID = CENT.ESTABID
 AND IT_INM.EFFDT = ( SELECT MAX(IT_IT2.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM IT_IT2 
                  WHERE IT_IT2.ESTABID  = IT_INM.ESTABID
                          AND IT_IT2.EFFDT <= $AsOfToday
                          AND IT_IT2.EFF_STATUS = 'A') 
 AND IT_R.GPBR_RUN_TYPE_ID = TRANSLATE(IT_INM.GPBR_IT_BASE_TYPE,'9','6')                 
 AND IT_R.GPBR_MAN_ROW_TYPE = 'K300'
 AND IT_M.PIN_NUM = IT_INM.GPBR_PIN_MAN_NUM
 AND IT_R.PIN_NUM = IT_M.PIN_MBR_NUM
 AND IT_M.BGN_DT <= IT_R.PYMNT_DT
 AND ( IT_M.END_DT >= IT_R.PYMNT_DT OR IT_M.END_DT IS NULL)
 AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_ACM_IT_T NECHK                
                 WHERE NECHK.PROCESS_INSTANCE = #prcs_process_instance
                   AND NECHK.ESTABID  = IT_R.ESTABID
                   AND NECHK.EMPLID   = IT_R.EMPLID
                   AND NECHK.EMPL_RCD = IT_R.EMPL_RCD
                   AND NECHK.GP_RPT_KEY   = IT_R.GP_RPT_KEY  
                   AND NECHK.PIN_NUM = IT_R.PIN_NUM)
 End-Sql
#endif

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_ACM_IT_T COMPUTE STATISTICS
    end-sql

#endif

! insert 3 - Seleciona elementos membros de acumuladores com base tributaria exclusiva

Begin-Sql
Insert Into PS_GPBR_ACM_IT_T 
(
 PROCESS_INSTANCE
,ESTABID
,EMPLID
,EMPL_RCD
,GP_RPT_KEY  
,PIN_NUM
,GPBR_IT_BASE_TYPE
)
Select   DISTINCT
 #prcs_process_instance
,IT_R.ESTABID
,IT_R.EMPLID
,IT_R.EMPL_RCD
,IT_R.GP_RPT_KEY  
,IT_R.PIN_NUM
,IT_INM.GPBR_IT_BASE_TYPE
FROM PS_GPBR_MANAD_IT IT_INM
    ,PS_GP_ACM_MBR IT_M
    ,PS_GPBR_MANAD_TMP2 IT_R 
    ,PS_GPBR_CENT_ESTAB CENT
WHERE IT_R.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.CENTR_ESTABID_BRA = $RC_estabID
AND IT_INM.ESTABID = CENT.CENTR_ESTABID_BRA
AND IT_R.ESTABID = CENT.ESTABID
AND IT_INM.EFFDT = ( SELECT MAX(IT_IT2.EFFDT) 
                 FROM PS_GPBR_MANAD_PARM IT_IT2 
                 WHERE IT_IT2.ESTABID  = IT_INM.ESTABID
                         AND IT_IT2.EFFDT <= $AsOfToday
                         AND IT_IT2.EFF_STATUS = 'A') 
AND IT_R.GPBR_MAN_ROW_TYPE = 'K300'
AND IT_M.PIN_NUM = IT_INM.GPBR_PIN_MAN_NUM
AND IT_R.PIN_NUM = IT_M.PIN_MBR_NUM
AND IT_M.BGN_DT <= IT_R.PYMNT_DT
AND ( IT_M.END_DT >= IT_R.PYMNT_DT OR IT_M.END_DT IS NULL)
AND NOT EXISTS ( SELECT 'X' FROM PS_GPBR_ACM_IT_T NECHK                
                WHERE NECHK.PROCESS_INSTANCE = #prcs_process_instance
                  AND NECHK.ESTABID  = IT_R.ESTABID
                  AND NECHK.EMPLID   = IT_R.EMPLID
                  AND NECHK.EMPL_RCD = IT_R.EMPL_RCD
                  AND NECHK.GP_RPT_KEY   = IT_R.GP_RPT_KEY  
                  AND NECHK.PIN_NUM = IT_R.PIN_NUM)
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_ACM_IT_T COMPUTE STATISTICS
    end-sql
#endif

End-Procedure Get-Acum-type-IT

!*****************************
Begin-Procedure Get-K300-Base-IT
#debug show '* Get-K300-Base-IT'
!**************************************

Begin-Sql
Insert Into PS_GPBR_K300_IT_T
(
 PROCESS_INSTANCE
,ESTABID
,EMPLID
,EMPL_RCD
,GP_RPT_KEY  
,PIN_NUM
,GPBR_IT_BASE_TYPE
)
Select  
 #prcs_process_instance
,IT_R.ESTABID
,IT_R.EMPLID
,IT_R.EMPL_RCD
,IT_R.GP_RPT_KEY  
,IT_R.PIN_NUM
,IT_INM.GPBR_IT_BASE_TYPE
FROM PS_GPBR_MANAD_IT IT_INM
    ,PS_GPBR_MANAD_TMP2 IT_R 
    ,PS_GPBR_CENT_ESTAB CENT
WHERE IT_R.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.CENTR_ESTABID_BRA = $RC_estabID
AND IT_R.ESTABID = CENT.ESTABID
AND IT_INM.EFFDT = ( SELECT MAX(IT_IT2.EFFDT) 
                 FROM PS_GPBR_MANAD_PARM IT_IT2 
                 WHERE IT_IT2.ESTABID  = IT_INM.ESTABID
                         AND IT_IT2.EFFDT <= $AsOfToday
                         AND IT_IT2.EFF_STATUS = 'A') 
AND CENT.CENTR_ESTABID_BRA = IT_INM.ESTABID
AND IT_INM.GPBR_PIN_MAN_NUM = IT_R.PIN_NUM
AND IT_R.GPBR_MAN_ROW_TYPE = 'K300'  
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_K300_IT_T COMPUTE STATISTICS
    end-sql
#endif

End-Procedure Get-K300-Base-IT

!*******************************************
Begin-Procedure Get-K300-Base-INSS
#debug show '* Get-K300-Base-INSS'
!********************************************

Begin-Sql
Insert Into PS_GPBR_K300_INS_T
(
 PROCESS_INSTANCE
,ESTABID
,EMPLID
,EMPL_RCD
,GP_RPT_KEY  
,PIN_NUM
,GPBR_INSS_BSE_TYPE
)
Select  
 #prcs_process_instance
,IT_R.ESTABID
,IT_R.EMPLID
,IT_R.EMPL_RCD
,IT_R.GP_RPT_KEY  
,IT_R.PIN_NUM
,IT_INM.GPBR_INSS_BSE_TYPE
FROM PS_GPBR_MANAD_INSS IT_INM
    ,PS_GPBR_MANAD_TMP2 IT_R 
    ,PS_GPBR_CENT_ESTAB CENT
WHERE IT_R.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.PROCESS_INSTANCE = #prcs_process_instance
AND CENT.CENTR_ESTABID_BRA = $RC_estabID
AND IT_R.ESTABID = CENT.ESTABID
AND IT_INM.EFFDT = ( SELECT MAX(IT_IT2.EFFDT) 
                 FROM PS_GPBR_MANAD_PARM IT_IT2 
                 WHERE IT_IT2.ESTABID  = IT_INM.ESTABID
                         AND IT_IT2.EFFDT <= $AsOfToday
                         AND IT_IT2.EFF_STATUS = 'A') 
AND CENT.CENTR_ESTABID_BRA = IT_INM.ESTABID
AND IT_INM.GPBR_PIN_MAN_NUM = IT_R.PIN_NUM
AND IT_R.GPBR_MAN_ROW_TYPE = 'K300'   
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_K300_INS_T COMPUTE STATISTICS
    end-sql
#endif


End-Procedure Get-K300-Base-INSS

!**************************************
Begin-Procedure Write-k300
#debug show '* Write-k300'
!**************************************

begin-select
WRT300.GPBR_MAN_ROW_TYPE
WRT300.EMPLID
WRT300.EMPL_RCD
WRT300.EFFDT
WRT300.ESTAB_ID_BRA
WRT300.CALC_RSLT_VAL
WRT300.PYMNT_DT
WRT300.DEPTID
WRT300.PIN_NUM
WRT300.RUN_TYPE
WRT300.GPBR_SERVICE_TAKER
WRT300.GPBR_MAN_EMP_FORM
WRT300.GPBR_RUN_TYPE_ID
WRT300.PIN_NM
WRT300.PIN_TYPE
WRT300.GPBR_TAKER_INSCR
WRT300.GPBR_IT_BASE_TYPE
WRT300.GPBR_IT2_BASE_TYPE
WRT300.GPBR_INSS_BSE_TYPE
WRT300.GPBR_INS2_BSE_TYPE

   Let $IND_BASE_IRRF1 = &WRT300.GPBR_IT_BASE_TYPE
   Let $IND_BASE_IRRF2 = &WRT300.GPBR_IT2_BASE_TYPE
   
   Let $IND_BASE_PS1 = &WRT300.GPBR_INSS_BSE_TYPE
   Let $IND_BASE_PS2 = &WRT300.GPBR_INS2_BSE_TYPE
   
   If $IND_BASE_IRRF1 = '3' 
       Let $IND_BASE_IRRF = $IND_BASE_IRRF2
   Else
       Let $IND_BASE_IRRF = $IND_BASE_IRRF1
   End-If

   If  $IND_BASE_PS1 = '8'   
       Let $IND_BASE_PS = $IND_BASE_PS2
   Else
       Let $IND_BASE_PS = $IND_BASE_PS1   
   End-If

   Let $GPBR_SERVICE_TAKER = rtrim(&WRT300.GPBR_SERVICE_TAKER, ' ')
    
   If $GPBR_SERVICE_TAKER <> ''
     Let $GPBR_SERVICE_TAKER = ' ' || $GPBR_SERVICE_TAKER
   End-If

   Let $estabInscription = &WRT300.ESTAB_ID_BRA
   Let $estabInscription = replace($estabInscription, '-',  '') 
   Let $estabInscription = replace($estabInscription, '.',  '') 

   Let $pymtDt = &WRT300.PYMNT_DT
   Do convert-to-dtu-date(&WRT300.PYMNT_DT , $DT_PGTO)
   Do Format-MANAD-Date($DT_PGTO, $DT_PGTO)  
   Let $DT_COMP = SUBSTR($DT_PGTO,3,6)
   
   Do convert-to-dtu-date(&WRT300.EFFDT , $DT_PGTO2)
   
   Do Format-MANAD-Date($DT_PGTO2, $PeriodEnd)  
   
   If $DT_PGTO2 > $DT_PGTO
     Do Format-MANAD-Date($DT_PGTO2, $DT_PGTO2)  
     Let $DT_COMP = SUBSTR($DT_PGTO2,3,6)
   End-if 
   
   Let $deptid= rtrim(&WRT300.DEPTID, ' ')
 
   Let #emplRcd = &WRT300.EMPL_RCD
      
   Let $emplID = rtrim(&WRT300.EMPLID, ' ')
   
   Let $IND_FL  = &WRT300.GPBR_RUN_TYPE_ID
   
   If $IND_FL <> '2'
      Let $PeriodEnd = Substr($PeriodEnd,3,6)
   Else
      Let $PeriodEnd = '13' || Substr($PeriodEnd,5,4)
   End-If  

   Let $TAKER_INSCR = &WRT300.GPBR_TAKER_INSCR
   
   Let $K_IND_MOV = '0'
   
   Let $IND_RUBR = &WRT300.PIN_TYPE
   
      Let #VLR_RUBR_INT = (trunc(&WRT300.CALC_RSLT_VAL,0) * 1)
      Let $VLR_RUBR_INT = LTRIM(rtrim(EDIT(#VLR_RUBR_INT,'999999999999'), ' '), ' ')
      Let #VLR_RUBR_DEC = ROUND((&WRT300.CALC_RSLT_VAL - #VLR_RUBR_INT), 2)
      
      If #VLR_RUBR_DEC >= 1
        Let #VLR_RUBR_INT = #VLR_RUBR_INT + (trunc(abs(#VLR_RUBR_DEC),0) * 1)
        Let $VLR_RUBR_INT = LTRIM(rtrim(EDIT(#VLR_RUBR_INT,'99999999999'), ' '), ' ')
        Let $VLR_RUBR_DEC = '00'
      Else
        Let $VLR_RUBR_DEC = ltrim(rtrim(edit(round((#VLR_RUBR_DEC * 100),2) , '00') , ' '), ' ')
      End-If
      
      if #VLR_RUBR_DEC > 0
         LET $VLR_RUBR = $VLR_RUBR_INT || ',' || SUBSTR($VLR_RUBR_DEC, 1,2)
      else
         LET $VLR_RUBR = $VLR_RUBR_INT  || ',00' 
      end-if
     
      IF RTRIM(&WRT300.GPBR_MAN_EMP_FORM, ' ')  = 'Y'
         Let $COD_REG_TRAB =  $emplID || ' ' || to_char(#emplRcd) 
      Else 
         Let $COD_REG_TRAB =  $emplID  
   End-If

   Let $MANADtext = rtrim($estabInscription, ' ') || '|' || $IND_FL || '|' || $Deptid || $GPBR_SERVICE_TAKER || '|' || $COD_REG_TRAB || '|' || $PeriodEnd || '|' || rtrim(&WRT300.PIN_NM, ' ')
   Let $MANADtext = $MANADtext || '|' || $VLR_RUBR || '|' || $IND_RUBR || '|' ||  $IND_BASE_IRRF || '|' || $IND_BASE_PS
 
  write 1 from
    &WRT300.GPBR_MAN_ROW_TYPE '|' -
    $MANADtext 
 
FROM PS_GPBR_MANAD_TMP4 WRT300 
WHERE WRT300.PROCESS_INSTANCE = #prcs_process_instance 
  AND WRT300.GPBR_MAN_ROW_TYPE = 'K300'
ORDER BY WRT300.GPBR_MAN_ROW_TYPE, WRT300.ESTAB_ID_BRA, WRT300.EMPLID, WRT300.EFFDT, WRT300.GPBR_RUN_TYPE_ID, WRT300.PIN_NM
End-Select

End-Procedure Write-k300

!*****************************
Begin-Procedure Write-K200
#debug show '* Write-K200'
!**************************************

Begin-Select
TK200.GPBR_MAN_ROW_TYPE
TK200.ESTABID
TK200.GPBR_MAN_TEXT
TK200.EFFDT
TK200.DEPTID
TK200.GL_EXPENSE
TK200.ACCOUNT
TK200.PIN_NUM
TK200.ESTAB_ID_BRA 
TK200.PIN_NM
TK200.GPBR_SERVICE_TAKER &TK200.GPBR_SERVICE_TAKER

   Let $K200_Flag = 'Y'
   
   Do convert-to-dtu-date($RC_DateFrom, $DateK200)
   Do Format-MANAD-Date($DateK200, $DateK200) 
   Let $DateK100 = '01' || substr($DateK200,3,6) 
   
   Let $deptID = rtrim(&TK200.DEPTID, ' ')
   Let $COD_CTA =  rtrim(&TK200.ACCOUNT, ' ')

   Let $COD_CCUS = rtrim(&TK200.GL_EXPENSE, ' ')  
  
   Let $GPBR_SERVICE_TAKER = rtrim(&TK200.GPBR_SERVICE_TAKER, ' ')
    
   If $GPBR_SERVICE_TAKER <> ''
     Let $GPBR_SERVICE_TAKER = ' ' || $GPBR_SERVICE_TAKER
   End-If
 
   Let $estabInscription = &TK200.ESTAB_ID_BRA
   Let $estabInscription = replace($estabInscription, '-',  '') 
   Let $estabInscription = replace($estabInscription, '.',  '') 
  
   If $Account_Pin = ''
     Let $Account_Pin =  rtrim(&TK200.ACCOUNT, ' ') || to_char(&TK200.PIN_NUM)
   End-if  
   
  Let $K_IND_MOV = '0'
  
  Let $MANADtext =  $DateK200 || '|' || rtrim($estabInscription, ' ') || '|' || &TK200.PIN_NM || '|' || $deptID || $GPBR_SERVICE_TAKER || '|' || $COD_CCUS || '|' || $COD_CTA
  
  
  Write 1 from
    &TK200.GPBR_MAN_ROW_TYPE '|' -
    $MANADtext
    
From PS_GPBR_MANAD_TMP1 TK200
Where TK200.PROCESS_INSTANCE = #prcs_process_instance
  And TK200.GPBR_MAN_ROW_TYPE = 'K200' 
  And TK200.PIN_NUM IN (SELECT PIN_NUM 
                          FROM PS_GPBR_MANAD_TMP1 TEMP1
                         Where TEMP1.PROCESS_INSTANCE = TK200.PROCESS_INSTANCE
                           And TEMP1.GPBR_MAN_ROW_TYPE = 'K150' )
  Order By TK200.GPBR_MAN_ROW_TYPE, TK200.ESTABID,TK200.ESTAB_ID_BRA, TK200.ACCOUNT, TK200.DEPTID
End-Select

End-Procedure Write-K200

!*****************************
!*** Change non ascii characters to its ascii equivalent.
begin-procedure Check-Strings( $StringIn , :$StringOut )
#debug show '** Check-Strings **'
!*****************************

let $StringIn  = ltrim(rtrim($StringIn, ' '),' ')
let #I = 1
let $StringOut = ''
let #Len = length($StringIn)
let $Test_Char1 = ''
let $Test_Char2 = ''
let $Test_Char3 = ''

while #I  <= #Len
   let $Test_Char    = substr($StringIn,#I, 1)
   let $Test_Char3   = $Test_Char2
   let $Test_Char2   = $Test_Char1
   let $Test_Char1   = $Test_Char
   if ($Test_Char3 = $Test_Char2 and $Test_Char2 = $Test_Char1) or ($Test_Char2 = $Test_Char1 and $Test_Char1 = ' ')
      let $Test_Char  = ''
   end-if
   let $Found = 'N'
   let #Test_Code = ascii(upper($Test_Char))
   if (#Test_Code > 64 and #Test_Code < 91) or (#Test_Code > 47 and #Test_Code < 58)
      let $StringOut = $StringOut || upper($Test_Char)
      let $Found = 'Y'
   end-if

   if ($Found = 'N')
      evaluate $Test_Char
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
          let $Test_Char = 'E'
          let $StringOut  = $StringOut || $Test_Char
          break
        when = ''
        when = ''
       when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
          let $Test_Char = 'A'
          let $StringOut  = $StringOut || $Test_Char
          break
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
          let $Test_Char = 'I'
          let $StringOut  = $StringOut || $Test_Char
          break
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
          let $Test_Char = 'O'
          let $StringOut  = $StringOut || $Test_Char
          break
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
        when = ''
          let $Test_Char = 'U'
          let $StringOut  = $StringOut || $Test_Char
          break
        when = ''
        when = ''
          let $Test_Char = 'N'
          let $StringOut  = $StringOut || $Test_Char
          break
        when = ''
        when = ''
          let $Test_Char = 'C'
          let $StringOut  = $StringOut || $Test_Char
          break
        when = ' '
        when = '-'
          let $Test_Char = ' '
          let $StringOut  = $StringOut || $Test_Char
        when-other
          break
      end-evaluate
    end-if
    add 1 to #I
end-while
let $StringIn  = ''
end-procedure Check-Strings

!******************************************************************************
begin-procedure GetPhoneBRA ($FullPhone, :$PhoneDDI, :$PhoneDDD, :$Phone, :$PhoneRamal)
#debug show 'Procedure: GetPhoneBRA'
!******************************************************************************

  let $PhoneDDI      = '0'
  let $PhoneDDD      = '0000'
  let $Phone         = '0'
  let $PhoneRamal    = '0'
  let #i             = 1
  let #DotNumber     = 0
  let #SizeFullPhone = length($FullPhone)
  let $CleanPhone    = ''
  let #PosDot1       = 0
  let #PosDot2       = 0
  let #PosDot3       = 0
  !Clean Phone
  while #i <= #SizeFullPhone
    let $Test = substr($FullPhone,#i,1)
    if $Test >= '0' and $Test <= '9' or $Test = '.'
          let $CleanPhone = $CleanPhone || $Test
    end-if
    add 1 to #i
  end-while
  
  let #SizeCleanPhone = length($CleanPhone)
  let #i = 1
  
  !Find dots positions
  while #i <= #SizeCleanPhone
    let $Test = substr($CleanPhone,#i,1)
    if $Test = '.'
      if #PosDot1 > 0 and #PosDot2 > 0
        let #PosDot3 = #i
      end-if
      if #PosDot1 > 0 and #PosDot3 = 0
              let #PosDot2 = #i
      end-if
      if #PosDot2 = 0 and #PosDot3 = 0
              let #PosDot1 = #i
      end-if
      add 1 to #DotNumber
    end-if
    add 1 to #i
  end-while
  
  evaluate #DotNumber
    when = 0
      !Only phone
      let $Phone = $CleanPhone
      break
    when = 1
      !Maybe DDD.phone or phone.Ramal
      if #PosDot1 <= 4
        !DDD.Phone
        let $PhoneDDD   = substr($CleanPhone,1           , #PosDot1 - 1)
        let $Phone      = substr($CleanPhone,#PosDot1 + 1, #SizeCleanPhone)
      else
        !Phone.Ramal
        let $Phone      = substr($CleanPhone,1           , #PosDot1 - 1)
        let $PhoneRamal = substr($CleanPhone,#PosDot1 + 1, #SizeCleanPhone)
      end-if
      break
    when = 2
      !Maybe DDD.Phone.Ramal or DDI.DDD.Phone 
      if (#PosDot2 - #PosDot1) > 5
        !DDD.Phone.Ramal
        let $PhoneDDD   = substr($CleanPhone, 1           , #PosDot1 - 1)
        let $Phone      = substr($CleanPhone, #PosDot1 + 1, (#PosDot2 - #PosDot1) - 1)
        let $PhoneRamal = substr($CleanPhone,#PosDot2 + 1, #SizeCleanPhone)
      else
        !DDI.DDD.Phone
        let $PhoneDDI   = substr($CleanPhone,1           , #PosDot1 - 1)
        let $PhoneDDD   = substr($CleanPhone,#PosDot1 + 1, (#PosDot2 - #PosDot1) - 1)
        let $Phone      = substr($CleanPhone,#PosDot2 + 1, #SizeCleanPhone)
      end-if
      
      break
    when = 3
      !Must be DDI.DDD.Phone.Ramal
      let $PhoneDDI   = substr($CleanPhone, 1           , #PosDot1 - 1)
      let $PhoneDDD   = substr($CleanPhone, #PosDot1 + 1, (#PosDot2 - #PosDot1) - 1)
      let $Phone      = substr($CleanPhone, #PosDot2 + 1, (#PosDot3 - #PosDot2) - 1)
      let $PhoneRamal = substr($CleanPhone, #PosDot3 + 1, #SizeCleanPhone)
      break
  end-evaluate
  let #X = length($Phone)
  let #Y = length($PhoneDDD)
  
  if substr($PhoneDDD,1,1) = '0'
      let $PhoneDDD = substr($PhoneDDD,2,#Y)
      let #Y = length($PhoneDDD)
  end-if
  
  if #X > 8
    let $Phone = substr($Phone, 1,8)
  end-if
  
  if #Y > 2
    let $PhoneDDD = substr($PhoneDDD, 1,2)
  end-if
end-procedure GetPhoneBRA

!**************************************
begin-procedure LoadCentralTbl
#debug show '* LoadCentralTbl'
!**************************************

Begin-Sql
insert into PS_GPBR_CENT_ESTAB
(
 PROCESS_INSTANCE
,CENTR_ESTABID_BRA
,ESTABID
)
SELECT #prcs_process_instance,
       CENTR.CENTR_ESTABID_BRA, 
       CENTR.ESTABID
FROM PS_CENTR_DTL_BRA CENTR
WHERE CENTR.CENTR_ESTABID_BRA = $RC_estabID
  AND CENTR.PROCESS_TYPE_BRA = '50' 
  AND CENTR.EFFDT            = (select MAX(A_ED.EFFDT) 
                                from PS_CENTR_DTL_BRA A_ED 
                                Where A_ED.CENTR_ESTABID_BRA = CENTR.CENTR_ESTABID_BRA
                                  AND A_ED.PROCESS_TYPE_BRA = '50'
                                  AND A_ED.EFFDT <= $RC_DateTo) 
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_CENT_ESTAB COMPUTE STATISTICS
    end-sql

#endif



Begin-Sql
insert into PS_GPBR_CENT_ESTAB
(
 PROCESS_INSTANCE
,CENTR_ESTABID_BRA
,ESTABID
)
SELECT #prcs_process_instance,
       $RC_estabID, 
       $RC_estabID
  FROM PS_INSTALLATION
  WHERE 0 = ( SELECT COUNT(*) 
  FROM PS_GPBR_CENT_ESTAB 
  WHERE PROCESS_INSTANCE = #prcs_process_instance
    AND CENTR_ESTABID_BRA = $RC_estabID
    AND ESTABID = $RC_estabID)
End-Sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_CENT_ESTAB COMPUTE STATISTICS
    end-sql
#endif


end-procedure LoadCentralTbl

!**************************************
begin-procedure Isolate-Termin
#debug show '* Isolate-Termin'
!**************************************

begin-SQL
insert into PS_GPBR_MANAD_DELT
(
PROCESS_INSTANCE       
,EMPLID                
,CAL_RUN_ID            
,EMPL_RCD              
,GP_PAYGROUP           
,CAL_ID                
,ORIG_CAL_RUN_ID       
,RSLT_SEG_NUM          
,GP_RPT_KEY            
,SEQ_NUM               
,PRD_BGN_DT            
,PRD_END_DT 
)
Select DISTINCT
 #prcs_process_instance
,RG25.EMPLID 
,RG25.CAL_RUN_ID 
,RG25.EMPL_RCD 
,RG25.GP_PAYGROUP 
,RG25.CAL_ID 
,RG25.ORIG_CAL_RUN_ID 
,RG25.RSLT_SEG_NUM 
,RG25.GP_RPT_KEY
,RG25.SEQ_NUM
,RG25.PRD_BGN_DT
,RG25.PRD_END_DT

FROM PS_GP_RGST_GDE_TMP RG25
    ,PS_GPBR_MANAD_RUNT PSET
 WHERE RG25.PROCESS_INSTANCE = #prcs_process_instance - 1
   AND PSET.ESTABID = $RC_estabID 
   AND PSET.RUN_TYPE = RG25.RUN_TYPE
   AND PSET.EFFDT = ( SELECT MAX(P2.EFFDT) 
                  FROM PS_GPBR_MANAD_PARM P2 
                  WHERE P2.ESTABID = PSET.ESTABID 
                  AND P2.EFFDT <= $AsOfToday
                  AND P2.EFF_STATUS = 'A')
   AND PSET.GPBR_RUN_TYPE_TERM = 'Y'
end-SQL

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GPBR_MANAD_DELT COMPUTE STATISTICS
    end-sql
#endif


begin-SQL
DELETE FROM PS_GP_RGST_GDE_TMP
WHERE PROCESS_INSTANCE = #prcs_process_instance - 1
  AND RUN_TYPE IN (SELECT PSET.RUN_TYPE
                FROM PS_GPBR_MANAD_RUNT PSET
                WHERE PSET.ESTABID = $RC_estabID 
                  AND PSET.EFFDT = ( SELECT MAX(P2.EFFDT) 
                      FROM PS_GPBR_MANAD_PARM P2 
                     WHERE P2.ESTABID = PSET.ESTABID 
                       AND P2.EFFDT <= $AsOfToday
                       AND P2.EFF_STATUS = 'A')
                  AND PSET.GPBR_RUN_TYPE_TERM = 'N' )      
  AND  EXISTS (SELECT 'X' FROM PS_GPBR_MANAD_DELT MDEL 
                   WHERE MDEL.PROCESS_INSTANCE = #prcs_process_instance
                     AND MDEL.EMPLID = PS_GP_RGST_GDE_TMP.EMPLID
                     AND MDEL.EMPL_RCD = PS_GP_RGST_GDE_TMP.EMPL_RCD
                     AND MDEL.GP_PAYGROUP = PS_GP_RGST_GDE_TMP.GP_PAYGROUP
                     AND MDEL.SEQ_NUM = PS_GP_RGST_GDE_TMP.SEQ_NUM
                     AND MDEL.PRD_BGN_DT >= PS_GP_RGST_GDE_TMP.PRD_BGN_DT
                     AND MDEL.PRD_END_DT <= PS_GP_RGST_GDE_TMP.PRD_END_DT)
end-sql

do Commit-Transaction

#ifdef ORACLE
    begin-sql
        ANALYZE table PS_GP_RGST_GDE_TMP COMPUTE STATISTICS
    end-sql
#endif


end-procedure Isolate-Termin

!**************************************
#Include 'reset.sqc'     !Reset printer procedure
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#Include 'stdapi.sqc'    !Update Process API
#Include 'datemath.sqc'
#Include 'useprntr.sqc'  !Indicate which printer to use for reports
#include 'tranctrl.sqc'  !Commit-Transaction
#include 'brfile01.sqc'  !File Utilities
