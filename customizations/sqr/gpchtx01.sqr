!***********************************************************************
! GPCHTX01.SQR  : Source Tax Year -Quellensteuer Jahr-                 *
!***********************************************************************
!                                                                      *
!                                                                      *
!                                                                      *
! This software and related documentation are provided under a         *
! license agreement containing restrictions on use and                 *
! disclosure and are protected by intellectual property                *
! laws. Except as expressly permitted in your license agreement        *
! or allowed by law, you may not use, copy, reproduce,                 *
! translate, broadcast, modify, license, transmit, distribute,         *
! exhibit, perform, publish or display any part, in any form or        *
! by any means. Reverse engineering, disassembly, or                   *
! decompilation of this software, unless required by law for           *
! interoperability, is prohibited.                                     *
! The information contained herein is subject to change without        *
! notice and is not warranted to be error-free. If you find any        *
! errors, please report them to us in writing.                         *
!                                                                      *
!
! Copyright (C) 1988, 2015, Oracle and/or its affiliates.              *
! All Rights Reserved.                                                 *
!----------------------------------------------------------------------
!
!          $Date:  2015/05/12:23:42:45                                 !
!       $Release:  HR92                                                !
!      $Revision:  118                                                 !
!***********************************************************************

#include 'setenv.sqc'    ! set Default environment
#include 'gpchut10.sqc'  ! setenv override for Swiss Default.
#include 'gpchut12.sqc'  ! Substitution Variables Defined.
#include 'setup31.sqc'
#define PAGE_PAPER_SIZE (A4)
!***********************************************************************
begin-setup

create-array name = RekapData size = 50
field = Rekap1:char
field = Rekap2:char
field = Rekap3:number
field = Rekap4:number
field = Rekap5:number
field = Rekap6:number

create-array name = CRekapData size = 1000
field = CRekap1:char
field = CRekap2:char
field = CRekap3:char
field = CRekap4:number

create-array name = ChildData_GE size = 300
field = ChildName:char
field = ChildBDt:char

!----------------------------------------------------------------

declare-layout reportA
paper-size={PAGE_PAPER_SIZE}
orientation = LANDSCAPE
line-height=9
char-width=4.32
!left-margin=.05
!right-margin=.05
end-declare

declare-layout reportB
paper-size={PAGE_PAPER_SIZE}
orientation = PORTRAIT
line-height=9
char-width=4.32
left-margin=.05
right-margin=.05
end-declare

declare-layout reportC
paper-size={PAGE_PAPER_SIZE}
orientation = PORTRAIT
line-height=9
char-width=4.32
left-margin=.05
right-margin=.05
end-declare

declare-layout reportD
paper-size={PAGE_PAPER_SIZE}
orientation = PORTRAIT
line-height=9
char-width=4.32
left-margin=.35
right-margin=.35
end-declare

declare-layout reportE
paper-size={PAGE_PAPER_SIZE}
orientation = PORTRAIT
line-height=9
char-width=4.32
left-margin=.35
right-margin=.35
bottom-margin=.01
end-declare

!----------------------------------------------------------------------
declare-report reportA
layout = reportA
end-declare

declare-report reportB
layout = reportB
end-declare

declare-report reportC
layout = reportC
end-declare

declare-report reportD
layout = reportD
end-declare

declare-report reportE
layout = reportE
end-declare

declare-variable
date   $Date1
end-declare

end-setup
!***********************************************************************

#define col1   10


! A Report Canton Total
#define col31     40
#define col41     60
#define col51     90
#define col61    123

#define colA1      3
#define colA2     73
#define colA3     98
#define colA4    121
#define colA5    146
#define colA6    158
#define colA7    129
#define colA8     67
#define col9A     62

! GE Report
#define colG1  10
#define colG2  50
#define colG3  72

!***********************************************************************
Begin-Program
   
  do Init-DateTime
  do Init-Number
  do Get-Current-DateTime
  do Init-Report
  do Get_Data
  
     
  If $GPCH_EG_YEP_FLG = 'Y'
   If $Run_Option = 'Y' and $Rpt_Type ='Y' ! For determining if running quarterly or yearly from db
   do Init_Statustbl
    
  do Process-Main
  do Delete-Rec-tx011
  do Delete-Rec-tx012
  
  
 
  do Stdapi-Term
   let $language_cd  = $Log_language
  do Get-Log
  Do Update_Status($Ctl_Year,#ptot_domainid,$Comp,$providertype,$Run_Option,$SysDateTime,$Cancel_option)
  close 10
  close 12
   Else
     If $Cancel_Option = 'Y'
     do Cancle_YEA($ptot_requestid,$Ctl_Year,$comp,$providertype,#ptot_domainid)
     Do Update_Status($Ctl_Year,#ptot_domainid,$Comp,$providertype,$Run_Option,'',$Cancel_option) 
    End-If
    !Do Update_Status($Ctl_Year,#ptot_domainid,$Comp,$providertype,$Run_Option,'',$Cancel_option)
    do Stdapi-Term
    do Get-Log
  End-if
  else
 
  do Process-Main
  do Delete-Rec-tx011
  do Delete-Rec-tx012
  do Stdapi-Term
  let $language_cd  = $Log_language
  do Get-Log
  close 10
  close 12
 End-IF
End-Program
!***********************************************************************
Begin-Procedure Get_Date_Values
#Debug Show 'Get_Date_Values -> '  $Ctl_Curr_Pay_End_Dt

  let #Date_Type= {DateType}

  if $Ctl_Year <> '0'
      do ConvertToComponents($Ctl_End_Dt  ,$yy11,$mm11,$dd11)
      do ConvertToComponents($Ctl_Start_Dt,$yy10,$mm10,$dd10)

      do Format-DateTime($Ctl_Start_Dt,$Ctl_B_Date,{DEFCMP},'','')
      do Format-DateTime($Ctl_End_Dt  ,$Ctl_E_Date,{DEFCMP},'','')

      evaluate #Date_Type
      when = 1
         let $from_to_format = $dd10 || '{PTDateDelim}' ||
         $mm10 || '{PTDateDelim}' || ' - ' || $dd11 ||
         '{PTDateDelim}' || $mm11 || '{PTDateDelim}' || $yy11
         let $from_to = $dd10 || '{PTDateDelim}' ||
         $mm10 || '{PTDateDelim}' || $yy10 || ' - ' || $dd11 ||
         '{PTDateDelim}' || $mm11 || '{PTDateDelim}' || $yy11
         break
      when = 2
         let $from_to_format = $mm10 || '{PTDateDelim}'
         || $dd10 || '{PTDateDelim}' || ' - ' || $yy11
         || '{PTDateDelim}' || $mm11 || '{PTDateDelim}' || $dd11
         let $from_to = $yy10 || '{PTDateDelim}' ||
         $mm10 || '{PTDateDelim}' || $dd10 || ' - ' || $yy11 ||
         '{PTDateDelim}' || $mm11 || '{PTDateDelim}' || $dd11
         break
      when-other
         let $from_to_format = $mm10 || '{PTDateDelim}'
         || $dd10 || '{PTDateDelim}' || ' - ' || $mm11
         || '{PTDateDelim}' || $dd11 || '{PTDateDelim}' || $yy11
         let $from_to = $mm10 || '{PTDateDelim}' ||
         $dd10 || '{PTDateDelim}' || $yy10 || ' - ' || $mm11 ||
         '{PTDateDelim}' || $dd11 || '{PTDateDelim}' || $yy11
         break
      end-evaluate
  end-if

#Debug Show 'Get_Date_Values <- '
End-Procedure Get_Date_Values
!***********************************************************************
Begin-procedure Init-Report

  do Stdapi-Init
  move 'GPCHTX01' to $ReportID
  if $prcs_process_instance = ''
     do ask-input
  else
     do Get-Report-Parameters
     do Get-Base-Language
  end-if
 
  
   let $providertype ='A'
    if $GPCH_EG_YEP_FLG = 'Y'
       do Get-Provider($providertype,$prcs_oprid,$prcs_run_cntl_id,$prov_crit)
            
         If rtrim($prov_crit,' ') <>''
        let $Provider_crit = ' AND P.GPCH_SI_PROV_CD   = ''' || $prov_crit || ''' '
            else
            let $Provider_crit = ' '
         End-If
         
    do Get-PTotals-Data($Provider_crit,$providertype,#Domainid,$ptot_company,$ptot_year,#ptot_domainid,$ptot_providercd,$ptot_provtype,$ptot_requestid,$ptot_userkey) 
    do Check_Run_Report(#ptot_domainid,$Ctl_Year,$comp,$providertype,$Run_Option,$Cancel_option,$Rpt_Type)
    
    Let $Ctl_PayEntity = $comp
    
    
   end-if 
  let $Log_language = $language_cd

  if $language_cd <> ''
     do Get-Language ($ReportID, $language_cd)
  else
     let $Blank_lang = 'Y'
  end-if

  let $ReportTitle = $TITLE1_STR
  let $TITLE1      = $TITLE1_STR

  do Get_Date_Values

  if #count_Emplid <> 0
     let $Emplid_Criteria      = ' AND PBD.EMPLID  IN ( ' || $Emplid-String || ')'
     let $Emplid_Criteria_INSD = ' AND INSD.EMPLID IN ( ' || $Emplid-String || ')'
     let $Emplid_CriteriaAJ    = ' AND AJ.EMPLID   IN ( ' || $Emplid-String || ')'
  else
     let $Emplid_Criteria      = ' '
     let $Emplid_Criteria_INSD = ' '
     let $Emplid_CriteriaAJ    = ' '
  end-if


  if rtrim($Cal_Run_Id_String, ' ') <> ''
     let $Cal_Run_Id_Criteria          = ' AND  PBD.CAL_RUN_ID IN ( ' || $Cal_Run_Id_String || ')'
     let $Cal_Run_Id_Criteria_INSD     = ' AND INSD.CAL_RUN_ID IN ( ' || $Cal_Run_Id_String || ')'
  else
     let $Cal_Run_Id_Criteria          = ' '
     let $Cal_Run_Id_Criteria_INSD     = ' '
  end-if


      do Get-Output-Directory('GPCHTX01',$Output_Directory,$prcs_no)
  !-----------------------------------------------------------------------
           let #position1     = instr($prcs_no,'.',0)
           let #position1     = #position1 - 1
           let $prcs_no2 = substr($prcs_no,1,#position1)  
   
  
   let $reportdirA = $Output_Directory || 'GPCHTX1A_' || $prcs_no  ! oracle / Mss

   if $Formalix_Output<>''
       let $reportdir3 = $Formalix_Output || 'Formalix' || $prcs_no2||'.CSV'  ! oracle / Mss
       let $reportdir4 = $Formalix_Output || 'ErrorLOG'||$prcs_no2||'.TXT' ! oracle / Mss
   else    
       let $reportdir3 = $Output_Directory || 'Formalix' || $prcs_no2||'.CSV'  ! oracle / Mss
       let $reportdir4 = $Output_Directory || 'ErrorLOG'||$prcs_no2||'.TXT' ! oracle / Mss
   end-if

      #ifdef MVS
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirA = $path || 'GPCHTX01(GPCHTX1A)'

      if $Formalix_Output<>''
         let $reportdir3 = $Formalix_Output || 'Formalix'
         let $reportdir4 = $Formalix_Output || 'ErrorLOG'
      else    
         let $reportdir3 = $path || 'Formalix' 
         let $reportdir4 = $path || 'ErrorLOG'
      end-if

      #end-if

      #ifdef OS390
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirA = $path || 'GPCHTX01(GPCHTX1A)'

      if $Formalix_Output<>''
         let $reportdir3 = $Formalix_Output || 'Formalix'
         let $reportdir4 = $Formalix_Output || 'ErrorLOG'
      else    
         let $reportdir3 = $path || 'Formalix' 
         let $reportdir4 = $path || 'ErrorLOG'
      end-if

      #end-if

      #ifdef OS400
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirA = $path || 'GPCHTX01(GPCHTX1A)'

      if $Formalix_Output<>''
         let $reportdir3 = $Formalix_Output || 'Formalix'
         let $reportdir4 = $Formalix_Output || 'ErrorLOG'
      else    
         let $reportdir3 = $path || 'Formalix' 
         let $reportdir4 = $path || 'ErrorLOG'
      end-if

      #end-if

   open $reportdir3 as 10 FOR-WRITING RECORD=4000:VARY
   open $reportdir4 as 12 FOR-WRITING RECORD=100:VARY


   Use-Report reportA
   New-report $reportdirA



!-----------------------------------------------------------------------
  let $reportdirB = $Output_Directory || 'GPCHTX1B_' || $prcs_no  ! oracle / Mss

      #ifdef MVS
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirB = $path || 'GPCHTX01(GPCHTX1B)'
      #end-if

      #ifdef OS390
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirB = $path || 'GPCHTX01(GPCHTX1B)'

      #end-if

      #ifdef OS400
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirB = $path || 'GPCHTX01(GPCHTX1B)'
      #end-if


   Use-Report reportB
   New-report $reportdirB

!-----------------------------------------------------------------------
  let $reportdirC = $Output_Directory || 'GPCHTX1C_' || $prcs_no  ! oracle / Mss

      #ifdef MVS
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirC = $path || 'GPCHTX01(GPCHTX1C)'
      #end-if

      #ifdef OS390
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirC = $path || 'GPCHTX01(GPCHTX1C)'

      #end-if

      #ifdef OS400
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirC = $path || 'GPCHTX01(GPCHTX1C)'
      #end-if

   Use-Report reportC
   New-report $reportdirC

!-----------------------------------------------------------------------
  let $reportdirD = $Output_Directory || 'GPCHTX1D_' || $prcs_no  ! oracle / Mss

      #ifdef MVS
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirD = $path || 'GPCHTX01(GPCHTX1D)'
      #end-if

      #ifdef OS390
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirD = $path || 'GPCHTX01(GPCHTX1D)'

      #end-if

      #ifdef OS400
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirD = $path || 'GPCHTX01(GPCHTX1D)'
      #end-if


   Use-Report reportD
   New-report $reportdirD
!-----------------------------------------------------------------------
  let $reportdirE = $Output_Directory || 'GPCHTX1E_' || $prcs_no  ! oracle / Mss

      #ifdef MVS
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirE = $path || 'GPCHTX01(GPCHTX1E)'
      #end-if

      #ifdef OS390
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirE = $path || 'GPCHTX01(GPCHTX1E)'

      #end-if

      #ifdef OS400
      let #pos  = instr($sqr-report,'GPCHTX01',0)
      let #pos  = #pos - 1
      let $path = substr($sqr-report,1,#pos)
      let $reportdirE = $path || 'GPCHTX01(GPCHTX1E)'
      #end-if


   Use-Report reportE
   New-report $reportdirE

end-procedure

!******************************************************************************************
Begin-Procedure Get-Language($ReportID, $language_cd)

  do Init_Report_Translation ($ReportID, $language_cd)
  do Append_Report_Translation ('GPCHTX02')
  do Append_Report_Translation ('GPCHGLOB')

  do Gpce_Init_Report_Translation ($ReportID, $language_cd)
  do Gpce_Append_Report_Translation ('GPCHTX02', $language_cd)
  do Gpce_Append_Report_Translation ('GPCHGLOB', $language_cd)
  do Report-Translation


end-procedure
!***********************************************************************
begin-procedure Get-Base-Language

begin-select
LANGUAGE_CD
  move &Language_Cd to $Base_Language
FROM PSOPTIONS
end-select
end-procedure
!************************************************
begin-procedure Report-Translation


  do Get_Field_Information ('GPCHTX02', 'TITLE1_STR',             $TITLE1_STR,        #CW)
  do Get_Field_Information ('GPCHTX02', 'ZIP_CODE_STR',           $ZIP_CODE_STR,      #CW)
  do Get_Field_Information ('GPCHTX02', 'RECAPITULATION_STR',     $RECAPITULATION_STR,#CW)
  do Get_Field_Information ('GPCHTX02', 'COMM_DOMICILE_STR',      $COMM_DOMICILE_STR, #CW)
  do Get_Field_Information ('GPCHTX02', 'TOTAL_CANTON_STR',       $TOTAL_CANTON_STR,  #CW)
  do Get_Field_Information ('GPCHTX02', 'PERCENT1_STR',           $PERCENT1_STR,      #CW)
  do Get_Field_Information ('GPCHTX02', 'PERCENT2_STR',           $PERCENT2_STR,      #CW)
  do Get_Field_Information ('GPCHTX02', 'CANTON_NAME_STR',        $CANTON_NAME_STR,   #CW)
  do Get_Field_Information ('GPCHTX02', 'PROVISION_REF_STR',      $PROVISION_REF_STR, #CW)
  do Get_Field_Information ('GPCHTX02', 'RESTITUTION_STR',        $RESTITUTION_STR,   #CW)
  do Get_Field_Information ('GPCHTX02', 'DELIVERY_STR',           $DELIVERY_STR,      #CW)
  do Get_Field_Information ('GPCHTX02', 'FROM_STR',               $FROM_STR,          #CW)
  do Get_Field_Information ('GPCHTX02', 'EMPLOYER_STR',           $EMPLOYER_STR,      #CW)
  do Get_Field_Information ('GPCHTX02', 'TAX_AMOUNT_STR',         $TAX_AMOUNT_STR,    #CW)
  do Get_Field_Information ('GPCHTX02', 'TOTAL_COMMUNE_STR',      $TOTAL_COMMUNE_STR, #CW)
  do Get_Field_Information ('GPCHTX02', 'TAX_CANTON_STR',         $TAX_CANTON_STR,    #CW)
  do Get_Field_Information ('GPCHTX02', 'COMM_WORK_STR',          $COMM_WORK_STR,     #CW)
  do Get_Field_Information ('GPCHTX02', 'BORDER_CR_STR',          $BORDER_CR_STR,     #CW)
  do Get_Field_Information ('GPCHTX02', 'CORRECTION_STR',         $CORRECTION_STR,    #CW)
  do Get_Field_Information ('GPCHTX02', 'CORR_OPTIM_STR',         $CORR_OPTIM_STR,    #CW)
  do Get_Field_Information ('GPCHTX02', 'WITHOUT_STR',            $WITHOUT_STR,       #CW)
  do Get_Field_Information ('GPCHTX02', 'OPTIM_STR',              $OPTIM_STR,         #CW)
  do Get_Field_Information ('GPCHTX02', 'TAX_VILLAGE_STR',        $TAX_VILLAGE_STR,   #CW)
  do Get_Field_Information ('GPCHTX02', 'NAME2_STR',              $NAME2_STR,         #CW)

  do Get_Field_Information ('GPCHTX02', 'HD_AHV_NUMBER',          $HD_AHV_NUMBER,     #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_NNSS_NUMBER',         $HD_NNSS_NUMBER,    #CW)
  !do Get_Field_Information ('GPCHTX02', 'BIRTHDATE_STR',         $BIRTHDATE_STR,    #CW)
  
  do Get_Field_Information ('GPCHTX02', 'HD_NAME',                $HD_NAME,           #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_MUTATION',            $HD_MUTATION,       #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_ENTRYEXIT',           $HD_ENTRYEXIT,      #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_TARIFFCHG',           $HD_TARIFFCHG,      #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_GROSSWAGE',           $HD_GROSSWAGE,      #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_COMMUNE',             $HD_COMMUNE,        #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_TAXAMT',              $HD_TAXAMT,         #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_TXTARIFF',            $HD_TXTARIFF,       #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_BNSBEN1',             $HD_BNSBEN1,        #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_BNSBEN2',             $HD_BNSBEN2,        #CW)
  do Get_Field_Information ('GPCHTX02', 'HD_BNSBEN3',             $HD_BNSBEN3,        #CW)



  do Get_Field_Information ('GPCHTX01', 'BIRTHDATE_STR',          $BIRTHDATE_STR,     #CW)
  do Get_Field_Information ('GPCHTX01', 'POSTAL_CODE_STR',        $POSTAL_CODE_STR,   #CW)
  do Get_Field_Information ('GPCHTX01', 'YEARS_SALARY_STR',       $YEARS_SALARY_STR,  #CW)
  do Get_Field_Information ('GPCHTX01', 'TOTAL_STR',              $TOTAL_STR,         #CW)
  do Get_Field_Information ('GPCHTX01', 'CANTON_TOTAL_STR',       $CANTON_TOTAL_STR,  #CW)
  do Get_Field_Information ('GPCHTX01', 'TITLE1_STR',             $TITLE_BC_STR,      #CW)
  do Get_Field_Information ('GPCHTX01', 'COUNTRY_AUSTRIA',        $COUNTRY_AUSTRIA,   #CW)
  do Get_Field_Information ('GPCHTX01', 'COUNTRY_GERMANY',        $COUNTRY_GERMANY,   #CW)
  do Get_Field_Information ('GPCHTX01', 'COUNTRY_ITALY',          $COUNTRY_ITALY,     #CW)
  do Get_Field_Information ('GPCHTX01', 'COUNTRY_FRANCE',         $COUNTRY_FRANCE,    #CW)
  do Get_Field_Information ('GPCHTX01', 'COUNTRY_SWISS',          $COUNTRY_SWISS,     #CW)
  do Get_Field_Information ('GPCHTX01', 'NOT_ASS_SOURCE_TAX',     $NOT_ASS_SOURCE_TAX,#CW)

  do Get_Field_Information ('GPCHGLOB', 'TOTAL' ,                 $TOTAL_SUM_STR,     #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_BDTTIME',      $LG_BDTTIME,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_DBNAME',       $LG_DBNAME,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_DBTYPE',       $LG_DBTYPE,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_EDTTIME',      $LG_EDTTIME,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OPERID',       $LG_OPERID,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OPERSYS',      $LG_OPERSYS,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OUTDESTFOR',   $LG_OUTDESTFOR,   #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_OUTDESTTYPE',  $LG_OUTDESTTYPE,  #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PRCINSTNUM',   $LG_PRCINSTNUM,   #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PRCNM',        $LG_PRCNM,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PRCTYPE',      $LG_PRCTYPE,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_REPLNG',       $LG_REPLNG,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_REPNM',        $LG_REPNM,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNCTLID',     $LG_RUNCTLID,     #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNLOC',       $LG_RUNLOC,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNSTAT',      $LG_RUNSTAT,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_TOTDURA',      $LG_TOTDURA,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_CURRDT',       $LG_CURRDT,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_SRTORD',       $LG_SRTORD,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PAYENT',       $LG_PAYENT,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PSTYPE',       $LG_PSTYPE,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_FORYR',        $LG_FORYR,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_RUNCTLPA',     $LG_RUNCTLPA,     #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_VALUE',        $LG_VALUE,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_REPLOG',       $LG_REPLOG,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_LOGITEM',      $LG_LOGITEM,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_PINNM',        $LG_PINNM,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'LG_CALIDCR',      $LG_CALIDCR,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'EMPLID',          $HD_EMPLID,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'FROMTODT',        $FROMTODT,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'PAGE_TOTAL',      $PAGE_TOTAL,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'CANTON_PAGE',     $HD_CANTON_PAGE,  #CW)
  do Get_Field_Information ('GPCHGLOB', 'COMMON_LAW',      $COMMON_LAW,      #CW)
  do Get_Field_Information ('GPCHGLOB', 'DIVORCED',        $DIVORCED,        #CW)
  do Get_Field_Information ('GPCHGLOB', 'SEPARATED',       $SEPARATED,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'HEADHOUSE',       $HEADHOUSE,       #CW)
  do Get_Field_Information ('GPCHGLOB', 'MARRIED',         $MARRIED,         #CW)
  do Get_Field_Information ('GPCHGLOB', 'SINGLE',          $SINGLE,          #CW)
  do Get_Field_Information ('GPCHGLOB', 'UNKNOWN',         $UNKNOWN,         #CW)
  do Get_Field_Information ('GPCHGLOB', 'WIDOWED',         $WIDOWED,         #CW)
  
  
  !do Strings_Pads($PROVISION_REF_STR,$PROVISION_REF_L_STR,24)

  let $DELIVERY_STR_CAN = ltrim($DELIVERY_STR,' ')

end-procedure
!******************************************************************************************
begin-heading 13 FOR-REPORTS = (reportA)
#DEBUG SHOW '-> begin-heading  '

  alter-printer
  point-size = 9

    #Define ColR 141
    #Define ColM 168

    do Append_Report_Translation ('GPCHGLOB')
    do Get_Field_Information ('GPCHGLOB', 'COMPANY_NM', $stdhdg_co_nm  , #dummy_width)
    do Get_Field_Information ('GPCHGLOB', 'REPORT_ID' , $stdhdg_rep_id , #dummy_width)
    do Get_Field_Information ('GPCHGLOB', 'PAGE_NO'   , $stdhdg_page_no, #dummy_width)
    do Get_Field_Information ('GPCHGLOB', 'RUN_DATE'  , $stdhdg_run_dt , #dummy_width)
    do Get_Field_Information ('GPCHGLOB', 'RUN_TIME'  , $stdhdg_run_tm , #dummy_width)
    do Get_Field_Information ('GPCHGLOB', 'END_REPORT', $stdhdg_end_rep, #dummy_width)


    if rtrim($Canton,' ') = 'GE'
          let $COMM_DOMICILE_STR1 = $COMM_WORK_STR
       else
          let $COMM_DOMICILE_STR1 = $COMM_DOMICILE_STR
    end-if
    
    if $Ctl_Cross_Type = 'Y'    ! Populate Header for Cross Border in time
       let $ReportTitle  = $TITLE_BC_STR
    end-if   



            print '            '    (1,1)
            print $stdhdg_co_nm     ()          center

            print $stdhdg_rep_id    (+1,3)
            print $ReportID         (0,+7)
            print $ReportTitle      ()          center

            print $stdhdg_page_no   (0,{ColR})
            print #page-count       (0,{ColM})      edit 88888888

            print $stdhdg_run_dt    (+1,{ColR})
            print $ReportDate       (0,{ColM})

            print $stdhdg_run_tm    (+1,{ColR})
            print $ReportTime       (0,{ColM})


  if $Ctl_Cross_Type = 'N'


      position (-1,1)
      let $empl_str = $EMPLOYER_STR || ': ' || $Employer_StaxNr
      let $fr_str   = $FROM_STR     || ' '  || $from_to_format

      if ($Ctl_Canton <> '') or ($Merk_Header <> 'TOT')
              print $empl_str            ()     center
      end-if

      print $fr_str                 (+1,)  center

      if ($Merk_Header <> 'TOT')
          let #PageCounter = #PageCounter + 1
          print $HD_CANTON_PAGE      (5,{ColR})
          print #PageCounter         (,{ColM}) edit 88888888
      end-if

      print $Cpdescr          (4,3)


      if rtrim ($Canton,' ') = '' and $last_header <> 'Y'
         print $NOT_ASS_SOURCE_TAX  (+1,)  center
         goto aftervillage
      end-if

      if rtrim ($Village_CD,' ') = '' and $last_header <> 'Y'
         print $NOT_ASS_SOURCE_TAX  (+1,)  center
      end-if
      aftervillage:

  position (4,1)
  evaluate $Merk_Header
    when = 'CAN'


           print $Canton_Name       (+1,3)
           print $Village_CD        (+1,3)
           print $Village_Name      (+1,3)
           print '_'                (+2,3,176)  fill
           print $HD_AHV_NUMBER     (+1,3)
                      
           print $HD_NAME           (,39)

           if $Ctl_Canton <> 'GE' and rtrim($Actual_Can,' ') <> 'GE'
              print $BIRTHDATE_STR    (,22)
           end-if

           if $Ctl_Canton = 'GE' or rtrim($Actual_Can,' ') = 'GE'
           print $HD_COMMUNE        (,57)
           end-if
           print $HD_MUTATION       (,73)

           if $Language_cd = 'FRA' 
         if $Ctl_Canton = 'GE' or rtrim($Actual_Can,' ') = 'GE'
              let $HD_GROSSWAGE = 'Prestations'
             Else
                  let $HD_GROSSWAGE = 'Salaire brut'                 
              end-if
           End-if           
           print $HD_GROSSWAGE      (,106)

           print $HD_BNSBEN1       (,122)
           print $HD_TXTARIFF      (,140)
           print $HD_TAXAMT        (,160)

           print $HD_ENTRYEXIT    (+1,73)

           if $Language_cd = 'FRA' 
             let $AMOUNT1_STR = 'soumis'
             if $Ctl_Canton = 'GE' or rtrim($Actual_Can,' ') = 'GE'
                let $AMOUNT1_STR = 'soumises'
                print $AMOUNT1_STR      (,107)
             else           
                let $AMOUNT1_STR = 'soumis'
                print $AMOUNT1_STR      (,107)
             end-if
           End-if
           
           print $HD_BNSBEN2       (,122)

           print $HD_TARIFFCHG    (+1,73)
           print $HD_BNSBEN3       (,122)
           print '_'           (+1,3,176)    fill

       if ($Tax_Tariff_Type <> 'S')
          evaluate $Tax_Tariff_Type
          when = 'A'
             let $BC_STR = $BORDER_CR_STR || ' ' || $COUNTRY_AUSTRIA
             print  $BC_STR  (8,3)
             break
          when = 'D'
             let $BC_STR = $BORDER_CR_STR || ' ' || $COUNTRY_GERMANY
             print  $BC_STR  (8,3)
             break
          when = 'O'
             let $BC_STR = $BORDER_CR_STR || ' ' || $WITHOUT_STR
             print  $BC_STR  (8,3)
             break
          when = 'I'
             let $BC_STR = $BORDER_CR_STR || ' ' || $COUNTRY_ITALY
             print  $BC_STR  (8,3)
             break
          when-other
             let $BC_STR = ''
             break
          end-evaluate
       end-if


       break
    when = 'COM'
       print $Canton_Name         (+1,3)
       print $RECAPITULATION_STR   (+1,3)
       print '_'                   (+4,3,176)    fill
       print $ZIP_CODE_STR         (+1,{colA1})
       if $Ctl_Canton = 'GE' or rtrim($Actual_Can,' ') = 'GE'
          print $COMM_WORK_STR     (,61)
       else
          print $COMM_DOMICILE_STR (,61)
       end-if
       print $TAX_AMOUNT_STR       (,127)
       print '_'                   (+1,3,176)    fill
       break
    when = 'TOT'
       if ($Ctl_Canton <> '')
          let #PageCounter = #PageCounter + 1
          print $stdhdg_page_no    (5,{ColR})
          print #PageCounter       (,{ColM}) edit 88888888
       end-if

       if $Ctl_Canton <> ''
          print $Canton_Name       (,3)
       end-if

       print $COUNTRY_SWISS        (+1,3)
       print $RECAPITULATION_STR   (+1,3)
       print $Ctl_Year             (+1,3)
       print '_'                   (+3,3,176)    fill
       print $CANTON_NAME_STR      (+1,3)
       print $TAX_AMOUNT_STR       (,38)
       print $PROVISION_REF_STR    (,62)
       print $RESTITUTION_STR      (,97)
       print $DELIVERY_STR         (,121) !wrap 11 2 keep-top
       print '_'                   (+1,3,176)    fill
       break
    when-other
       break
    end-evaluate

   end-if
   !---------------------------------------------------------------------------------
   if $Ctl_Cross_Type = 'Y'   ! Header for Cross Border Report


         let $ReportTitle = $TITLE_BC_STR

         position                                (-1,1)
         let $empl_str = $EMPLOYER_STR || ': ' || $Employer_StaxNr
         let $fr_str   = $FROM_STR     || ' '  || $from_to_format

         print $empl_str                         ()     center
         print $Cpdescr                          (,3)
         print $fr_str                           (+1,)  center


         if ($Ctl_Canton <> '')
             let #PageCounter = #PageCounter + 1
             let #PageCoun    = #PageCoun    + 1
             print $HD_CANTON_PAGE               (+1,{ColR})
             print #PageCounter                  (,{ColM}) edit 88888888
         end-if

         print $TAX_CANTON_STR                   (+1,3)
         print ' : '                             (,+1)
         print $Canton                           (,+1)
         print $TAX_VILLAGE_STR                  (+1,3)
         print ' : '                             (,+1)
         print $Village_Name                     (,+1)
         print '_'                               (+4,3,176)       fill
         print $FROMTODT                         (+1,{colA1})
!         print $NAME2_STR                        (,37)
         if $Canton_BCR = 'VD'
            print $BIRTHDATE_STR                 (,59)
         end-if
         print $POSTAL_CODE_STR                  (,84)
         print $COMM_DOMICILE_STR1               (,110)
         print $COMM_WORK_STR                    (,140)
         print $YEARS_SALARY_STR                 (,166)
         print '_'                               (+1,3,176)       fill
   end-if

#DEBUG SHOW '<- begin-heading  '
end-heading
!******************************************************************************************
begin-footing 5
#Debug Show '-> begin-footing   '


   if $Ctl_Cross_Type = 'Y'

        do Format-Number(#Amount1_BCR_Page,$Amount1_BCR_Page_1,'999,999,999,999.99')
        do Format-Number(#Amount1_BCR_Cant,$Amount1_BCR_Cant_1,'999,999,999,999.99')
        do Format-Number(#Amount1_BCR_Vill,$Amount1_BCR_Vill_1,'999,999,999,999.99')

        print $PAGE_TOTAL               (+1,100)
        print $Amount1_BCR_Page_1       (,160)

        if $Ctl_Canton_Sort = 'V' and $New_Village = 'Y'
           print $TAX_VILLAGE_STR       (+1,100)
           print ' '                    (,+1)
           print $TOTAL_STR             (,+1)
           print $Amount1_BCR_Vill_1    (,160)
        end-if

        if $New_Canton = 'Y'
           print $CANTON_TOTAL_STR      (+1,100)
           print $Amount1_BCR_Cant_1    (,160)
        end-if

        let $New_Canton = 'N'
        let #Amount1_BCR_Page = 0
        let #Amount1_BCR_Line = 0

   end-if

#Debug Show '<- begin-footing   '
end-footing
!*************************************************************************************
begin-procedure Ask-Input

  let $Emplid-String            = ''
  let $temp-value               = ''
  let #count_Emplid             = 0
  let $Emplid_Criteria          = ''


  input $Ctl_Curr_Pay_End_Dt    'Current Pay End Date ' type=date
  input $Ctl_PayEntity          'Pay Entity '           type=char
  more:
  input $Ask_Emplid     'EMPLID, you can select mmore again Yes(Y) No(N)'
  if $Ask_Emplid = 'Y'
     input $Ctl_Emplid  'EMPLID '
     if $Ctl_Emplid <> ''
         let $temp-value        = rtrim($Ctl_Emplid,' ')
         let $Emplid-String     = $Emplid-String || '''' || $temp-value || '''' || ','
         let #count_Emplid      = #count_Emplid + 1
     end-if
     goto more
  end-if

  if #count_Emplid <> 0
    let $Emplid-String               = rtrim($Emplid-String,',')
    let $Emplid_Criteria             = ' AND PBD.EMPLID IN ( ' || $Emplid-String || ')'
  else
    let $Emplid-String               = ' '
    let $Emplid_Criteria             = ' '
  end-if

  input $Ctl_Canton       'Canton '
  input $Ctl_Canton_Sort  'Canton Sort '
  input $Ctl_Village_CD   'Village CD '
  input $Ctl_Cross_Type   'Cross Border Type '

end-procedure Ask-Input
!******************************************************************************************
begin-procedure Get-Values
#DEBUG SHOW '-> Get-Values  '
    let $providertype='A'
     Let $GPCH_EG_YEP_FLG = &GPCH_RUN_CNTL.GPCH_EG_YEP_FLG
    let $language_cd                 = RTRIM($PRCS_LANGUAGE_CD,' ')
    let #Domainid = &GPCH_RUN_CNTL.GPCH_EG_DOMAINID
    let $lang_item                   = $language_cd
    let $Ctl_Dept_ID                 = $Ctl_Deptid
    let $Ctl_Canton                  = RTRIM(&GPCH_RUN_CNTL.GPCH_TX_CANTON,' ')
    let $Ctl_Canton_Sort             = RTRIM(&GPCH_RUN_CNTL.GPCH_TX_CANTON_SRT,' ')
    let $Ctl_Print_Vill_Total        = RTRIM(&GPCH_RUN_CNTL.GPCH_RC_FINAL_PR,' ')
    let $Ctl_Village_CD              = rtrim(&GPCH_RUN_CNTL.GPCH_TX_VILLAGE_CD,' ')
    let $Ctl_Cross_Type              = rtrim(&GPCH_RUN_CNTL.GPCH_TX_CROSS_TYPE,' ')
    let $Issued_Date                 = &GPCH_RUN_CNTL.GPCH_RC_ADJUST_DT
    let $Formalix_Output             = RTRIM(&GPCH_RUN_CNTL.FILE_OUTPUT_DIR,' ')
     Let $comp                  = rtrim(&GPCH_RUN_CNTL.COMPANY,' ') !Only for use in status tbl
    if $Ctl_Canton <> ''
       let $Ctl_Canton_Crit          = ' AND PBD.GPCH_TX_CANTON   = ''' || $Ctl_Canton || ''' '
       let $Ctl_Canton_Crit_INSD     = ' AND INSD.GPCH_TX_CANTON  = ''' || $Ctl_Canton || ''' '
    else
       let $Ctl_Canton_Crit          = ' '
       let $Ctl_Canton_Crit_INSD     = ' '
    end-if




#DEBUG SHOW '<- Get-Values  ' $Ctl_End_Dt
end-procedure
!******************************************************************************************
begin-procedure Process-Main
#DEBUG SHOW '-> Process-Main  ' $Ctl_Curr_Pay_End_Dt

   let #PageCounter         = 0
   let #PageCoun            = 0
   let $Ctl_Company         = $Ctl_PayEntity
   let $Ctl_Curr_Pay_End_Dt = $Ctl_End_Dt
   let $CompanyErrorFlag= '0'

   do Get-PayEntity-Company
   do Get_Village_Description
   do Get_Canton_Description

   do Load_Supervisor_Details($Ctl_PayEntity,$Ctl_End_Dt,$Emplid_CriteriaAJ,$language_cd,
                              $Address_Type,$Signature_Type,$Signature1,$Signature2,$foot_text,
                              $SI_PHONE,$Other_Py)

   do Get-Company-Address($Ctl_PayEntity,$Ctl_Curr_Pay_End_Dt,$language_cd,$Cpline1,$Cpline2,$Cpline3,$Cpline31,
                          $Cpline4,$Cpline5,$Cpline6,$Cpdescr,$Cpdescrshrt,$Cpcity,$Cpstate,$Cppostal,$CpBusn_Phone,$CpFax_Phone,$CpOtr_Phone)
   do Load_Company_Description
    
     if $GPCH_EG_YEP_FLG = 'Y' and $ptot_userkey='VD'
          do Get-Employee-xml
     End-if
   !---------------------------------------------------------------Cross Border A
   if $Ctl_Cross_Type = 'Y'
      Use-Report reportA
      do BorderCrosserFrance_Report
      goto EndReport
   end-if
  !---------------------------------------------------------------Normal list A

     Use-Report reportA
  do Prepare_Print_Data

  !--------------------------------------------------------------- GE Attestation Quittance C
  if $Print_Canton_GE = 'Y' or ($GPCH_EG_YEP_FLG <> 'Y' and $ptot_userkey='GE')
     Use-Report reportC
     let $SubReport   = 'GE'
     let $language_cd = 'FRA'
     do Get_Report_Address
     do Get_Report_GE
  end-if
  !--------------------------------------------------------------- VD Attestation D'Impot A La Source B
  if $Print_Canton_VD = 'Y'
     Use-Report reportB
     let $SubReport   = 'VD'
     do Get_Report_Address
     do Get_Report_VD
  end-if

  !--------------------------------------------------------------- FR Certificat De Salaire D
  if $Print_Canton_FR = 'Y'
     Use-Report reportD
     let $SubReport   = 'FR'
     do Get_Report_Address
     do Get_Report_FR
  end-if
  !--------------------------------------------------------------- TI Attestato Ricevuta E

  if $Print_Canton_TI = 'Y'
     Use-Report reportE
     let $SubReport   = 'TI'
     do Get_Report_Address
     do Get_Report_TI
  end-if
  !---------------------------------------------------------------
  if $ErrorFlag = '0'
     let $Formalix_Error = 'CSV File Generated Without errors'
     write 12 from $Formalix_Error
  end-if   
  EndReport:

#DEBUG SHOW '<- Process-Main  '
end-procedure
!*********************************************************************************************
begin-procedure Get_Report_Address
#DEBUG SHOW '-> Get_Report_Address ' $Ctl_PayEntity ' , ' $SubReport ' , ' $Ctl_End_Dt

Begin-Select
SA.DESCR
SA.ADDRESS1
SA.ADDRESS2
SA.ADDRESS3
SA.ADDRESS4
SA.GPCH_AL_SIGNATURE
SA.CITY
SA.POSTAL 
SA.GPCH_AL_POSTBOX 
FROM PS_GPCH_AL_SDR_DTL SA
WHERE SA.COMPANY            = $Ctl_PayEntity
AND   SA.GPCH_RC_REPORTNAME = 'GPCHTX01'
AND   SA.EFFDT              = (SELECT MAX(SA1.EFFDT) FROM PS_GPCH_AL_SDR_DTL SA1
                               WHERE  SA1.COMPANY            = SA.COMPANY
                               AND    SA1.EFFDT             <= $Ctl_End_Dt)
AND   SA.GPCH_SI_SUB_RPT    = $SubReport
End-Select

 let $Rep_Descr = rtrim(&SA.DESCR,' ')
 let $Rep_Addr1 = rtrim(&SA.ADDRESS1,' ')
 let $Rep_Addr2 = rtrim(&SA.ADDRESS2,' ')
 let $Rep_Addr3 = rtrim(&SA.ADDRESS3,' ')
 let $Rep_Addr4 = rtrim(&SA.ADDRESS4,' ')
 let $PostBox   = rtrim(&SA.GPCH_AL_POSTBOX,' ') 
 let $JobSuper_name1 = rtrim(&SA.GPCH_AL_SIGNATURE,' ')
 let $POSTAL1 = rtrim(&SA.POSTAL,' ')
 let $CITY1 = rtrim(&SA.CITY,' ')
 
 let $Rep_Postal = LTRIM(RTRIM($POSTAL1||' '||$CITY1,' '),' ')
  
 
#DEBUG SHOW '<- Get_Report_Address ' $Rep_Descr ' , ' $Rep_Addr1 ' , ' $Rep_Addr2 ' , ' $Rep_Addr3
end-procedure Get_Report_Address
!*********************************************************************************************

begin-procedure Prepare_Print_Data
#DEBUG SHOW '-> Prepare_Print_Data '

  let $last_header = 'N'
  let #CantonCount = 0
  do InitRekapData
  let #ComCount = 0
  do InitialCommRekap

  do Canton_Report

  if $Was_Printed_Data = 'Y'
     let $Merk_Header = 'TOT'
     if $Blank_lang = 'Y'
        do Get-Language($ReportID, $Base_Language)
        
        let $last_header = 'Y'
        do Get_Company_Name
        
     end-if
     let $ReportTitle = $TITLE1_STR
     let $TITLE1      = $TITLE1_STR
     !let $last_header = 'Y'
     do Print_Final_Canton_Total
     new-page
  end-if
  ! if $GPCH_EG_YEP_FLG = 'Y' !SYed for B14
 ! do Insert-Ptotals
  ! End-If

#DEBUG SHOW '<- Prepare_Print_Data '
end-procedure

!*************************************************************************************
begin-procedure InitRekapData
#Debug Show '-> InitRekapData  '
let #b1 = 0
while #b1 < 50
put ''            into RekapData(#b1) Rekap1
put ''            into RekapData(#b1) Rekap2
put 0             into RekapData(#b1) Rekap3
put 0             into RekapData(#b1) Rekap4
put 0             into RekapData(#b1) Rekap5
put 0             into RekapData(#b1) Rekap6
let #b1 = #b1 + 1
end-while
#Debug Show '<- InitRekapData  '
end-procedure
!******************************************************************************
begin-procedure InitialCommRekap
#Debug Show '-> InitialCommRekap  '
let #b2 = 0
while #b2 < 1000
put ''            into CRekapData(#b2) CRekap1
put ''            into CRekapData(#b2) CRekap2
put ''            into CRekapData(#b2) CRekap3
put 0             into CRekapData(#b2) CRekap4
let #b2 = #b2 + 1
end-while
#Debug Show '<- InitialCommRekap  '
end-procedure
!*************************************************************************************
begin-procedure InitChildData_GE
#Debug Show '-> InitChildData_GE '
let #b3 = 0
while #b3 < 5
put ''            into ChildData_GE(#b3) ChildName
put ''            into ChildData_GE(#b3) ChildBDt

let #b3 = #b3 + 1
end-while
#Debug Show '<- InitChildData_GE  '
end-procedure
!*************************************************************************************
begin-procedure Print_Final_Canton_Total
#Debug Show '-> Print_Final_Canton_Total '
  
let #Sum_Delivery_Total = 0
let #CountRekData       = 0

while #CountRekData < #CantonCount
   get $Canton         from RekapData(#CountRekData) Rekap1
   get $Canton_Name    from RekapData(#CountRekData) Rekap2
   get #RP_amnt3       from RekapData(#CountRekData) Rekap3
   get #RP_stx         from RekapData(#CountRekData) Rekap4
   get #RP_amnt4       from RekapData(#CountRekData) Rekap5
   get #RP_amnt5       from RekapData(#CountRekData) Rekap6

   let #Sum_Delivery_Total =  #Sum_Delivery_Total + #RP_amnt5

   do Format-Number(#RP_amnt3,$RP_amnt3_1,',999,999,999,999.99')
   do Format-Number(#RP_amnt4,$RP_amnt4_1,',999,999,999,999.99')
   do Format-Number(#RP_amnt5,$RP_amnt5_1,',999,999,999,999.99')
   do Format-Number(#RP_stx,$RP_stx_1,'9,999,999,999,999,999.99')

   print $Canton_Name           (+1,{colA1})
   print $RP_amnt3_1            (,{col31})
   print $RP_amnt4_1            (,{col51})
   print $RP_amnt5_1            (,{col61})
   print $RP_stx_1              (,{col41})
    
  if $GPCH_EG_YEP_FLG = 'Y' and  rtrim($Canton,' ') = 'VD' !SYed for B14
   
     do Insert-Ptotals
  End-If

   let #CountRekData       =  #CountRekData + 1

end-while

do Format-Number(#Sum_Delivery_Total,$Sum_Delivery_Total_1,',999,999,999,999.99')

print '_'                       (+2,3,176)  fill
print $TOTAL_SUM_STR            (+2,{colA1})
print $Sum_Delivery_Total_1     (,{col61})


#Debug Show '<- Print_Final_Canton_Total '
end-procedure Print_Final_Canton_Total

!**********************************************************************
Begin-Procedure Get_Canton_Name  !Get Canton name
#Debug Show '-> Get_Canton_Name '


  #ifdef ORACLE

  #else
     #ifdef DB2ALL

     #else
        let $Canton =  $Canton
     #end-if
  #end-if


      let $Key_Canton = $Canton || $Tax_Language

      Lookup Get_Base_Canton_Descr $Canton $Return_Val
      if Not Isnull ($Return_Val)
         let $Canton_Name = rtrim($Return_Val,' ')
      end-if


      if ($BASE_LANG <> $language_cd) and ($language_cd <> '')
         Lookup Get_Trans_Canton_Descr $Canton $Return_Val
         if Not Isnull ($Return_Val)  ! Only if value returned else base language is printed.
            let $Canton_Name = rtrim($Return_Val,' ')
         end-if
      end-if

      if ($BASE_LANG <> $language_cd) and ($language_cd = '')
         Lookup Get_Trans_Canton_Descr_ALL $Key_Canton $Return_Val
         if Not Isnull ($Return_Val)  ! Only if value returned else base language is printed.
            let $Canton_Name = rtrim($Return_Val,' ')
         end-if
      end-if

#Debug Show '<- Get_Canton_Name ' $Canton_Name
End-Procedure Get_Canton_Name
!***********************************************************************
Begin-Procedure Get_Village_Name  !Get Canton name
#Debug Show '-> Get_Village_Name '

    Lookup Get_Village_Descr $Village_CD $Return_Val
    let $Village_Name = rtrim($Return_Val,' ')
    
    if $Village_Name = ''
      let #lenvillcd= length($Village_CD)
      If  #lenvillcd= 3
      let $Village_CD = $Village_CD || ' '
      End-If
      If  #lenvillcd= 2
      let $Village_CD = $Village_CD || '  '
      End-If
      If  #lenvillcd= 1
      let $Village_CD = $Village_CD || '   '
      End-If
      Lookup Get_Village_Descr $Village_CD $Return_Val
      let $Village_Name = rtrim($Return_Val,' ')
    End-If
  #DEBUG SHOW 'Village_Descr : '  $Village_CD  ' , ' $Village_Name

#Debug Show '<- Get_Village_Name '
End-Procedure Get_Village_Name
!***********************************************************************
begin-procedure Get_Company_Name
#DEBUG show '-> Get_Company_Name   ' $Ctl_Company ' , ' $BASE_LANG ' , ' $language_cd  ' , ' $Tax_Language

      if( $last_header = 'Y')
         let $Key_Company  = $Ctl_Company || $Base_Language
     else    
         let $Key_Company  = $Ctl_Company || $Tax_Language
     end-if

      Lookup Base_Company_Descr $Ctl_Company $Return_Val
      if Not Isnull ($Return_Val)
                     let $Cpdescr = rtrim($Return_Val,' ')
      end-if


      if ($BASE_LANG <> $language_cd) and ($language_cd <> '')
          Lookup Trans_Company_Descr $Ctl_Company $Return_Val
          if Not Isnull ($Return_Val)  ! Only if value returned else base language is printed.
             let $Cpdescr = rtrim($Return_Val,' ')
          end-if
      end-if

      if ($BASE_LANG <> $language_cd) and ($language_cd = '')
          Lookup Trans_Company_Descr_ALL $Key_Company $Return_Val
          if Not Isnull ($Return_Val)  ! Only if value returned else base language is printed.
            let $Cpdescr = rtrim($Return_Val,' ')
          end-if
      end-if




#DEBUG show '<- Get_Company_Name   ' $Cpdescr
end-procedure Get_Company_Name
!*************************************************************************************
begin-procedure Get_End_Mnth($Dte1,:$Dte2)
#DEBUG SHOW '-> Get_End_Mnth '
  do ConvertToComponents($Dte1,$tmp1_yy,$tmp1_mm,$tmp1_dd)
  let  #tmp1_mm  = to_number($tmp1_mm)
  let  #tmp1_yy  = to_number($tmp1_yy)

  if #tmp1_mm = 2
     move 28 to #MonthDays1
     if (((mod(#tmp1_yy,4) = 0) and (mod(#tmp1_yy,100) != 0)) or
        (mod(#tmp1_yy,400) = 0))
         add 1 to #MonthDays1
     end-if
   else
     if #tmp1_mm = 4 or #tmp1_mm = 6 or #tmp1_mm = 9 or #tmp1_mm = 11
         move 30 to #MonthDays1
     else
         move 31 to #MonthDays1
     end-if
   end-if

   let $MonthDays1 = to_char(#MonthDays1)
   let $E_DT_tmp1 = $tmp1_yy  || $tmp1_mm  || $MonthDays1 || '0000'
   do Format-DateTime($E_DT_tmp1,$Dte2, {DEFCMP},'','native')

#DEBUG SHOW '<- Get_End_Mnth '
end-procedure

!********************************************************************************************
begin-procedure Get_Beg_Mnth($Dte1,:$Dte2)
#DEBUG SHOW '-> Get_Beg_Mnth '
  do ConvertToComponents($Dte1,$tmp1_yy,$tmp1_mm,$tpm1_dd)

  let $B_DT_tmp1 = $tmp1_yy  || $tmp1_mm  || '01' || '0000'
  do Format-DateTime($B_DT_tmp1,$Dte2, {DEFCMP},'','native')
#DEBUG SHOW '<- Get_Beg_Mnth '
end-procedure

!*********************************************************************************************
begin-procedure Canton_Change
#Debug Show '-> Canton_Change' $Canton


   let $Canton_New = $Canton

   if $Existed_Dat = 'Y'
       do New_Canton              ! If Village Current or Retro Village data is printed.
   end-if

   if ($Ctl_Canton = '')
     let #PageCounter = 0
   end-if

   let $Existed_Dat = 'N'


   #Debug Show '-> Canton_Change' $Canton

   if rtrim($Canton,' ') = 'GE'
      let $Print_Canton_GE = 'Y'
   end-if
   
   if rtrim($Canton,' ') = 'VD'
      let $Print_Canton_VD = 'Y'
   end-if

   if rtrim($Canton,' ') = 'FR'
      let $Print_Canton_FR = 'Y'
   end-if

   if rtrim($Canton,' ') = 'TI'
      let $Print_Canton_TI = 'Y'
   end-if

#Debug Show '<- Canton_Change '
End-Procedure Canton_Change
!*************************************************************************************
begin-procedure Canton_Report
#Debug Show '-> Canton_Report '
 
alter-printer
font = 1
point-size = 7.2

let $Canton_Old           = ''
let $Was_Printed_Data     = 'N'      ! To print Final page (Canton total)
let $Merk_Header          = 'CAN'    ! To print header
let $IT_Exist_Data        = 'N'      ! To print village total

begin-select
PBD.GPCH_TX_CANTON       () On-Break level = 1 After=Canton_Change Print=Never
PBD.GPCH_TX_VILLAGE_CD
PBD.GPCH_TX_TRF_TYPE
PBD.EMPLID
PBD.EMPL_RCD
PBD.BEGIN_DT
PBD.END_DT
PBD.HIRE_DT
PBD.TERMINATION_DT
PBD.GPCH_TX_TRF_CD
PBD.POSTAL
PBD.GPCH_RP_AMOUNT1
PBD.GPCH_RP_AMOUNT2
PBD.GPCH_RP_AMOUNT3
PBD.GPCH_RP_AMOUNT14
PBD.GPCH_RP_AMOUNT15
PBD.GPCH_RP_AMOUNT19
PBD.GPCH_RP_AMOUNT20
PBD.GPCH_RC_AL01_S1
PBD.GPCH_RC_AL01_S2
PBD.NATIONAL_ID
PBD.GPCH_AH_NNSS
PBD.NAME
PBD.BIRTHDATE
PBD.SEX
PBD.GPCH_TX_VILLAGE_L
PBD.VISA_PERMIT_TYPE
PBD.CONTRACT_TYPE

  let $VillageCross = rtrim(&PBD.GPCH_TX_CANTON,' ') || rtrim(&PBD.GPCH_TX_VILLAGE_CD,' ') || rtrim(&PBD.GPCH_TX_TRF_TYPE,' ')

  print $VillageCross () on-break level = 2 After=Print_CrossBdr_Villages Print=Never


  !----------------------------------------------------------
  let $Empl_ID               =  rtrim(&PBD.EMPLID,' ')
  let #Empl_RCD              =  &PBD.EMPL_RCD
  let $Pay_Entity            =  $Ctl_PayEntity
  let $Company               =  $Ctl_PayEntity
  let $Canton                =  rtrim(&PBD.GPCH_TX_CANTON,' ')
  let $Actual_Can            =  &PBD.GPCH_TX_CANTON
  let $Postal_Lok            =  rtrim(&PBD.POSTAL,' ')
  let $Village_CD            =  rtrim(&PBD.GPCH_TX_VILLAGE_CD,' ')
  let $Actual_Vill           =  &PBD.GPCH_TX_VILLAGE_CD
  let $Tariff_CD             =  rtrim(ltrim(&PBD.GPCH_TX_TRF_CD,' '),' ')
  let $Hire_DT               =  &PBD.HIRE_DT
  let $Termination_DT        =  &PBD.TERMINATION_DT
  let #Amount1               =  &PBD.GPCH_RP_AMOUNT1
  let #Amount2               =  &PBD.GPCH_RP_AMOUNT2
  let #Amount3               =  &PBD.GPCH_RP_AMOUNT3 + &PBD.GPCH_RP_AMOUNT14 + &PBD.GPCH_RP_AMOUNT19
  let $B_DT                  =  &PBD.BEGIN_DT
  let $E_DT                  =  &PBD.END_DT
  let $Tax_Tariff_Type       =  &PBD.GPCH_TX_TRF_TYPE

  let $PBD.GPCH_RC_AL01_S1   =  &PBD.GPCH_RC_AL01_S1
  let $PBD.GPCH_RC_AL01_S2   =  &PBD.GPCH_RC_AL01_S2

  let $Empl_sex              =  rtrim(&PBD.SEX,' ')  !SYED
  let #Amount20              =  &PBD.GPCH_RP_AMOUNT20 
  let $Village_name          =  rtrim(&PBD.GPCH_TX_VILLAGE_L,' ')

  let $N_Id                  =  rtrim(ltrim(&PBD.NATIONAL_ID,' '),' ')
  let $NNSS_Id               =  rtrim(ltrim(&PBD.GPCH_AH_NNSS,' '),' ')
  let $Empl_Name             =  rtrim(&PBD.NAME,' ')

  let $Birth_DT              =  &PBD.BIRTHDATE
  let #Staxb_PCT             =  #Staxb_PCTR

  let $Village_CD            =  rtrim(&PBD.GPCH_TX_VILLAGE_CD,' ')
  let $Canton                =  rtrim(&PBD.GPCH_TX_CANTON,' ')
  let $Visa_per              = rtrim(&PBD.VISA_PERMIT_TYPE,' ')
  let $Cont_type             = rtrim(&PBD.CONTRACT_TYPE,' ')
  !-----------------------------------------------------------------------------
    


  if $Canton_Old <> $Canton
     do Get_Fak_Tax_Data($Canton,$Ctl_PayEntity,$Ctl_End_Dt,
                         $Fak_Language,$Employer_Fak_Nbr,#Employer_Fak_Pct,
                         $Tax_Language,$Employer_StaxNr,#Staxb_PCTR,
                         #Employer_SI_Pct,$SI_AHV_MBR_ID,$SI_AHV_PROVCD,
                         $SI_KTG_MBR_ID,#SI_AHV_ADM_PC,#SI_TOT_AHV_PC,
                         #SI_TOT_ALV1PC,#SI_TOT_ALV2PC)

                            if rtrim($Canton,' ') = 'GE'
                   let $Employer_StaxNr_GE = $Employer_StaxNr
                end-if

                if rtrim($Canton,' ') = 'VD'
                   let $Employer_StaxNr_VD = $Employer_StaxNr
                end-if

                if rtrim($Canton,' ') = 'FR'
                   let $Employer_StaxNr_FR = $Employer_StaxNr
                end-if

                if rtrim($Canton,' ') = 'TI'
                   let $Employer_StaxNr_TI = $Employer_StaxNr
                            end-if


     if $language_cd = ''
        let $language_cd = $Tax_Language
        do Get-Language($ReportID, $Tax_Language)
        let $lang_item = $Tax_Language
        let $ReportTitle = $TITLE1_STR
        let $TITLE1      = $TITLE1_STR
        let $language_cd = ''
     end-if
     do Get_Canton_Name
     do Get_Company_Name
  end-if

     do Get_Village_Name

  evaluate $lang_item
   when = 'GER'
     let $EStr = 'E: '
     let $AStr = 'A: '
     let $TStr = 'TW: '
     break
   when = 'FRA'
     let $EStr = 'E: '
     let $AStr = 'S: '
     let $TStr = 'CT: '
     break
   when = 'ITA'
     let $EStr = 'E: '
     let $AStr = 'U: '
     let $TStr = 'MT: '
     break
   when-other
     let $EStr = 'E: '
     let $AStr = 'T: '
     let $TStr = 'TC: '
     break
   end-evaluate

  do Print_Current_Data
  
  let #Amount1_ptot=#Amount1_ptot+#Amount1   
  let #Amount3_ptot=#Amount31_ptot+#Amount3    

  let $Canton_Old     = $Canton

FROM  PS_GPCHTX012_VW PBD
WHERE PBD.PROCESS_INSTANCE = #prcs_process_instance
[$Emplid_Criteria]
ORDER BY PBD.GPCH_TX_CANTON,PBD.GPCH_TX_VILLAGE_CD,PBD.GPCH_TX_TRF_TYPE,PBD.NATIONAL_ID,PBD.GPCH_AH_NNSS,PBD.NAME,PBD.EMPLID,
PBD.EMPL_RCD,PBD.BIRTHDATE,PBD.BEGIN_DT
end-select
 
  

#Debug Show '<- Canton_Report '
end-procedure

!***********************************************************************************************
Begin-procedure Get-Employee-xml



begin-select
TXML.CAL_RUN_ID
TXML.GP_PAYGROUP
TXML.CAL_ID
TXML.RSLT_SEG_NUM
TXML.SLICE_END_DT
TXML.PAY_ENTITY
TXML.COMPANY
TXML.PRD_END_DT
TXML.GPCH_AL_CPAY_ENDDT
TXML.GPCH_TX_VILLAGE_CD       
TXML.GPCH_TX_CANTON           
TXML.EMPLID                   
TXML.EMPL_RCD                 
TXML.CITY                     
TXML.POSTAL
TXML.ACTION
TXML.GPCH_TX_TRF_CD
TXML.BEGIN_DT
TXML.END_DT
TXML.GPCH_RP_AMOUNT1
TXML.NATIONAL_ID
TXML.BIRTHDATE
TXML.NAME
TXML.SEG_BGN_DT
TXML.SEG_END_DT
TXML.HIRE_DT
TXML.TERMINATION_DT
TXML.GPCH_RP_AMOUNT2
TXML.GPCH_TX_TRF_TYPE
TXML.SEX
TXML.GPCH_RP_AMOUNT20
TXML.GPCH_RP_AMOUNT3
TXML.GPCH_RP_AMOUNT14
TXML.GPCH_RP_AMOUNT19
TXML.GPCH_AH_NNSS
TXML.VISA_PERMIT_TYPE
TXML.CONTRACT_TYPE
TXML.REG_TEMP
TXML.GPCH_RP_CHAR03
TXML.GPCH_RP_FROMDT1

 

  let $Empl_ID               =  rtrim(&TXML.EMPLID,' ')
  let #Empl_RCD              =  &TXML.EMPL_RCD
  let $Pay_Entity            =  $Ctl_PayEntity
  let $Company               =  $Ctl_PayEntity
  let $Canton                =  rtrim(&TXML.GPCH_TX_CANTON,' ')
  let $Actual_Can            =  &TXML.GPCH_TX_CANTON
  let $Postal_Lok            =  rtrim(&TXML.POSTAL,' ')
  let $Village_CD            =  rtrim(&TXML.GPCH_TX_VILLAGE_CD,' ')
  let $Actual_Vill           =  &TXML.GPCH_TX_VILLAGE_CD
  let $Tariff_CD             =  rtrim(ltrim(&TXML.GPCH_TX_TRF_CD,' '),' ')
  let $Hire_DT               =  &TXML.HIRE_DT
  let $Termination_DT        =  &TXML.TERMINATION_DT
  let #Amount1               =  &TXML.GPCH_RP_AMOUNT1
  let #Amount2               =  &TXML.GPCH_RP_AMOUNT2
  let #Amount3               =  &TXML.GPCH_RP_AMOUNT3 + &TXML.GPCH_RP_AMOUNT14 + &TXML.GPCH_RP_AMOUNT19
  let $B_DT                  =  &TXML.BEGIN_DT
  let $E_DT                  =  &TXML.END_DT
  let $Tax_Tariff_Type       =  &TXML.GPCH_TX_TRF_TYPE



  let $Empl_sex              =  rtrim(&TXML.SEX,' ')  !SYED
  let #Amount20              =  &TXML.GPCH_RP_AMOUNT20 
  !let $Village_name          =  rtrim(&TXML.GPCH_TX_VILLAGE_L,' ')

  let $N_Id                  =  rtrim(ltrim(&TXML.NATIONAL_ID,' '),' ')
  let $NNSS_Id               =  rtrim(ltrim(&TXML.GPCH_AH_NNSS,' '),' ')
  let $Empl_Name             =  rtrim(&TXML.NAME,' ')

  let $Birth_DT              =  &TXML.BIRTHDATE
  let #Staxb_PCT             =  #Staxb_PCTR

  let $Village_CD            =  rtrim(&TXML.GPCH_TX_VILLAGE_CD,' ')
  let $Canton                =  rtrim(&TXML.GPCH_TX_CANTON,' ')
  let $Visa_per              = rtrim(&TXML.VISA_PERMIT_TYPE,' ')
  let $Cont_type             = rtrim(&TXML.CONTRACT_TYPE,' ')
  let $Type_employee         = rtrim(&TXML.REG_TEMP,' ')
  ! **************syed code for b14 ***************
  let $Segbegdt              =&TXML.SEG_BGN_DT
  let $Segenddt              = &TXML.SEG_END_DT 
  let $TaxTerm               =  rtrim(&TXML.GPCH_RP_CHAR03,' ')
  let $TaxTermDt             =  &TXML.GPCH_RP_FROMDT1  
   let $ActionR               =  &TXML.ACTION 
   let $PRD_E_DTR             =  &TXML.PRD_END_DT
  !-----------------------------------------------------------------------------
   
     let $Term_DT_xml = ''
     let $enddt= ''
   
   If $Type_employee='T'
    let  $Type_emp_xml='A'
   End-If
   If $Type_employee='R'
    let  $Type_emp_xml='P'
   End-If
    
    !********************
   let #lenname= length($Empl_Name)
    let #pos  = instr($Empl_Name,',',0)
      let #pos  = #pos - 1
      let $lname = substr($Empl_Name,0,#pos)
       let #pos  = #pos +2
    let $fname = substr($Empl_Name,#pos,#lenname)
  !********************
    let $Tariff_CD_xml= substr($Tariff_CD,0,1)
       If $Tariff_CD_xml='B' or $Tariff_CD_xml='C'
        let $Tariff_CD_xml= substr($Tariff_CD,0,2)
      End-If
     
          If $Visa_per='PC'
        let $Visa_per='C'
           End-If

  if $Empl_sex='M'      !SYED
   let $sex_empl='0'
      end-if
     if $Empl_sex='F'
   let $sex_empl='1'
   end-if
  let #Amt_tot = #Amount1 +#Amount2

 
   
   If $Hire_DT > $Ctl_Start_Dt 
     let $stdate= $Hire_DT
    else 
  let $stdate= $Ctl_Start_Dt
   end-if
   if $Termination_DT< $Ctl_End_Dt
   let $enddt= $Termination_DT
    else
    let $enddt=  $Ctl_End_Dt
     end-if  
    

   
  do Get_Formatted_Date 

  !**************For Mutation**************

 evaluate $lang_item
  when = 'GER'
     let $EStr = 'E: '
     let $AStr = 'A: '
     let $TStr = 'TW: '
     break
  when = 'FRA'
     let $EStr = 'E: '
     let $AStr = 'S: '
     let $TStr = 'CT: '
     break
  when = 'ITA'
     let $EStr = 'E: '
     let $AStr = 'U: '
     let $TStr = 'MT: '
     break
  when-other
     let $EStr = 'E: '
     let $AStr = 'T: '
     let $TStr = 'TC: '
     break
  end-evaluate

  if $ActionR = 'HIR'
    let $String_Before_E = $EStr
  end-if

  if $ActionR = 'TWE'
    let $String_Before_E = $TStr
  end-if

  !if $ActionR = 'TER'
  if $Taxterm = 'TER'  
    let $String_Before_T = $AStr
  end-if

  !**************************
    do Create_Mutation
   

    do ConvertToComponents($Segenddt,$yy1_EDT,$mm1_EDT,$dd1_EDT)
   do ConvertToComponents($Segbegdt,$yy2_BDT,$mm2_BDT,$dd2_BDT)
   do ConvertToComponents($E_DT,$yy3_TDT,$mm3_TDT,$dd3_TDT)


   let  $B_DT_xml = $yy2_BDT||'-'||$mm2_BDT||'-'||$dd2_BDT
   If $Segenddt <> ''
   let   $E_DT_xml = $yy1_EDT||'-'||$mm1_EDT||'-'||$dd1_EDT
     else 
     let   $E_DT_xml = $yy2_BDT||'-12'||'-31'
     End-If
 

     if $E_DT <> '' and ($E_DT >= $Segbegdt and $E_DT <= $Segenddt) !SYED for b14
    
    let   $Term_DT_xml = $yy3_TDT||'-'||$mm3_TDT||'-'||$dd3_TDT
   
      else
       
     let $Term_DT_xml = ''
   End-if

  !--------------------------------------------------------------------------
      


    do ConvertToComponents($Birth_DT,$tmp_y,$tmp_m,$tmp_d)
    let $Birth_DT1 = $tmp_y ||'-' || $tmp_m ||'-' || $tmp_d
   
     if $N_Id <> ''
       let $N_IdT      = edit($N_Id,'XXX.XX.XXX.XXX')
        End-If
         if $NNSS_Id <> ''
       let $NNSS_IdT      = edit($NNSS_Id,'XXX.XXXX.XXXX.XX')
        End-If
        
       do Format-Number(#Amount20,$Amount20_1,',99')
        do Format-Number(#Amount1,$Amount1_1,',999999999999.99') 
         do Format-Number(#Amount2,$Amount2_1,'9999999.99') 
          do Format-Number(#Amt_tot,$Amt_tot_1,',999999999999.99')
           do Format-Number(#Amount3,$Amount3_1,',999999999999.99') 

  do Get_Village_Name
  do Get_Canton_Name
  do Get_Company_Name  ! fill language array with correct company name
  
  do Create-xml
  
FROM  PS_GPCHTX011_VW TXML
WHERE TXML.PROCESS_INSTANCE = #prcs_process_instance
and TXML.GPCH_TX_CANTON   = 'VD'

ORDER BY TXML.EMPLID,TXML.GPCH_TX_CANTON,TXML.GPCH_TX_VILLAGE_CD,TXML.CITY,TXML.NATIONAL_ID,
      TXML.BIRTHDATE,TXML.EMPL_RCD ,TXML.PRD_END_DT,TXML.GPCH_AL_CPAY_ENDDT
End-select


   

#Debug Show '<- Get-Employee-xml  '
end-procedure
!*************************************************************************************


  Begin-Procedure Insert-Ptotals
  
 
    do Format-Number(#RP_amnt3,$RP_amnt3_xml,',999999999999.99')
   do Format-Number(#RP_amnt4,$RP_amnt4_xml,',999999999999.99')
   do Format-Number(#RP_amnt5,$RP_amnt5_xml,',999999999999.99')

   let $RP_amnt3_xml= rtrim(ltrim($RP_amnt3_xml,' '),' ')
  let $RP_amnt4_xml= rtrim(ltrim($RP_amnt4_xml,' '),' ')
  let $RP_amnt5_xml= rtrim(ltrim($RP_amnt5_xml,' '),' ')


 
 let $TotalBrut='<TotalBrutImpotDu>'||$RP_amnt3_xml||'</TotalBrutImpotDu>' 
 let $Comper='<CommissionPerception>' ||$RP_amnt4_xml||'</CommissionPerception>'
 let $TotalNetD='<TotalNetDu>'||$RP_amnt5_xml||'</TotalNetDu>'
    !let $xml_ptot1= $Numseq ||$codtc ||$hirecrt||$Numt
    !let $xml_ptot2= $NbrEn||$Env||$TotalBrut||$Comper||$TotalNetD
 let $xml_ptotals= $TotalBrut ||$Comper||$TotalNetD
 
 


Begin-Sql on-error=give_warning

DELETE FROM PS_GPCH_EG_PTOTALS WHERE GPCH_SI_PROV_TYPE = 'A' AND GPCH_SI_PROV_CD=$ptot_providercd  AND GPCH_RC_PAY_YEAR = $ptot_year AND COMPANY = $ptot_company  
AND GPCH_EG_REQUEST_ID=$ptot_requestid AND GPCH_EG_DOMAINID = #ptot_domainid

End-SQL




Begin-Sql on-error=give_warning

 Insert into PS_GPCH_EG_PTOTALS (COMPANY,GPCH_RC_PAY_YEAR,GPCH_EG_DOMAINID,GPCH_EG_REQUEST_ID,GPCH_SI_PROV_TYPE,GPCH_SI_PROV_CD,GPCH_EG_USERKEY,GPCH_EG_CMP_XML) 
 values ($ptot_company,$ptot_year,#ptot_domainid,$ptot_requestid,'A',$ptot_providercd,'X',$xml_ptotals)

End-SQL


End-Procedure
!************************************************************************************************
Begin-Procedure Create_Mutation



    do Format-DateTime($Ctl_Start_Dt,$Ctl_B_Dat1,{DEFCMP},'','')
   do Format-DateTime($Ctl_End_Dt,$Ctl_E_Dat1,{DEFCMP},'','')
   do Format-DateTime($B_DT     , $B_Date   ,{DEFCMP},'','')
   do Format-DateTime($E_DT    , $E_Date   ,{DEFCMP},'','')
  

  let $Mutation =''
Evaluate $ActionR
           when = 'HIR'
               if ($B_Date >= $Ctl_B_Dat1) and ($B_Date <= $Ctl_E_Dat1)
                
                     let $Mutation = $String_Before_E ||$B_DatePr1
               end-if
            
             if $Taxterm = 'TER'  
               
!               if ($B_Date >= $Ctl_B_Dat1) and ($B_Date <= $Ctl_E_Dat1)
                  
                   let $Mutation = $Mutation||';'|| $String_Before_T  ||$E_DTR1
!               end-if
             
             end-if
            

           break
           when = 'TWE'

               if ($B_Date >= $Ctl_B_Dat1) and ($B_Date <= $Ctl_E_Dat1)
                 
                  let $Mutation = $String_Before_E  ||$B_DatePr1
               end-if
               
               if $Taxterm = 'TER'  
                  let $Mutation =$Mutation||';'|| $String_Before_T  ||$E_DTR1
            
             end-if

           break
     
           when-other
            
            if $Taxterm = 'TER' 
        
                let $Mutation = $String_Before_T  ||$E_DTR1

            end-if   
           break
           End-Evaluate



End-Procedure
!*************************************************************************************************
Begin-Procedure Create-xml

  let $Amount20_1= rtrim(ltrim($Amount20_1,' '),' ')
  let $Amount1_1= rtrim(ltrim($Amount1_1,' '),' ')
  let $Amount2_1= rtrim(ltrim($Amount2_1,' '),' ')
  let $Amt_tot_1= rtrim(ltrim($Amt_tot_1,' '),' ') 
  let $Amount3_1= rtrim(ltrim($Amount3_1,' '),' ')
  let $Empl_ID= rtrim(ltrim($Empl_ID,' '),' ') 
   
   
  !let $NumSour_xml= '<NumSourcier>' ||'1111'|| '</NumSourcier>'
 let $NumSour_xml= '<NvlSourcier>' ||'O'|| '</NvlSourcier>'
 let $empl_xml='<NumSalarie>' ||$Empl_ID|| '</NumSalarie>'
 let $fname_xml='<Nom>'||$lname||'</Nom>'
 let $lname_xml='<Prenom>'||$fname||'</Prenom>'
 let $bdt_xml='<DatNai>'||$Birth_Dt1||'</DatNai>'
 let $sex_xml='<CodSexe>'||$sex_empl||'</CodSexe>'
 If  $N_Id <> ''
 let $Ntnl_xml='<NumAVS>'||$N_Id||'</NumAVS>'
  End-If
  If $NNSS_Id <> ''
 let $Newntnl_xml= '<NvlNumAVS>'||$NNSS_Id||'</NvlNumAVS>'
  End-If
 let $tariff_xml='<SituationFamille>'||$Tariff_CD_xml||'</SituationFamille>'
 let $infant_xml='<NbrEnfants>'||$Amount20_1 ||'</NbrEnfants>'
   If $Village_name <> ''
 let $loc_xml= '<LocLieuLbl>'||$Village_name||'</LocLieuLbl>'
  End-If
  If $Visa_per <> ''
 let $permit_xml='<PermisTravail>'||$Visa_per||'</PermisTravail>'
   End-If
 let $ident_xml1= $NumSour_xml||$empl_xml || $fname_xml || $lname_xml || $bdt_xml || $sex_xml
 let $ident_xml2= $Ntnl_xml || $Newntnl_xml || $tariff_xml || $infant_xml || $loc_xml || $permit_xml
 let $Identify_xml = '<Instance>'||'<Identification>' || $ident_xml1 || $ident_xml2 || '</Identification>'

 let $Amt1_xml='<SalaireVerse>'||$Amount1_1||'</SalaireVerse>' 
 let $Act_xml='<TypActivite>'||$Type_emp_xml||'</TypActivite>'
 let $Amt2_xml='<AutresPrestations>'||$Amount2_1||'</AutresPrestations>'
 let $Amttot_xml='<MontantTotal>'||$Amt_tot_1||'</MontantTotal>'
 let $begdate_xml= '<DatDebPeriodeSalaire>'||$B_DT_xml||'</DatDebPeriodeSalaire>'
 let $enddate_xml='<DatFinPeriodeSalaire>'||$E_DT_xml||'</DatFinPeriodeSalaire>'
 let $tax_xml='<ImpotRetenu>'||$Amount3_1||'</ImpotRetenu>'
   If $Mutation <> ''
 let $mutn_xml= '<CommentaireEmployeur>'||$Mutation||'</CommentaireEmployeur>'
   End-If
  If $Term_DT_xml <> ''
 let $taxtermn_xml='<DatFinActivite>'||$Term_DT_xml||'</DatFinActivite>'
   End-If
 let $sal_xml1= $Amt1_xml || $Act_xml || $Amt2_xml ||$Amttot_xml
 let $Sal_xml2= $begdate_xml || $enddate_xml|| $tax_xml || $mutn_xml 
 let $Salary_xml='<InfActivite>' || $sal_xml1 || $sal_xml2 || '</InfActivite>'|| $taxtermn_xml||'</Instance>'


     If $Empl_ID <>  $EmplID_old
  Let $final_xml = ''
 End-If
     let $EmplID_old   =  $Empl_ID 
    let $final_xml=$final_xml||$Identify_xml||$Salary_xml
   
   
 do Insert_Employee_Data_XML
   let $taxtermn_xml=''
   let $Ntnl_xml= ''
   let $Newntnl_xml= ''
   let $loc_xml= ''
   let $permit_xml= ''
   let  $mutn_xml =''
  
End-Procedure




!***********************************************************************************************


!**********************************************************************************************
Begin-Procedure Insert_Employee_Data_XML

Begin-Sql on-error=give_warning

 DELETE FROM PS_GPCH_EG_PERSON WHERE  GPCH_EG_DOMAINID= #ptot_domainid AND GPCH_SI_PROV_CD=$ptot_providercd
 AND GPCH_RC_PAY_YEAR = $ptot_year AND COMPANY = $ptot_company  AND  EMPLID = $Empl_ID AND EMPL_RCD = #Empl_RCD
 AND GPCH_SI_PROV_TYPE='A'AND BEGIN_DT=$Ctl_Start_Dt AND END_DT= $Ctl_End_Dt

End-SQL



 

Begin-Sql on-error=give_warning

 Insert into PS_GPCH_EG_PERSON (GPCH_EG_DOMAINID,GPCH_RC_PAY_YEAR,COMPANY,GPCH_SI_PROV_TYPE,
 GPCH_SI_PROV_CD,EMPLID,EMPL_RCD,BEGIN_DT,END_DT,GPCH_IF_VER,GPCH_EG_PRSN_XML) 
 values (#ptot_domainid,$ptot_year,$ptot_company,$ptot_provtype,$ptot_providercd,$Empl_ID,#Empl_RCD,
 $Ctl_Start_Dt,$Ctl_End_Dt,1,$final_xml)

End-SQL




End-procedure
!**********************************************************************************************
!************************************************************************************************
begin-procedure Print_CrossBdr_Villages  ! Select each village and prepares where condition
#Debug Show '-> Print_CrossBdr_Villages ' $VillageCross ' , ' $Actual_Vill ' , ' $Tax_Tariff_Type ' , ' $IT_Exist_Data


   if $IT_Exist_Data   = 'Y'
            do Accumulate_Print_Village_Total
   end-if

   let $IT_Exist_Data  = 'N'

#Debug Show '<- Print_CrossBdr_Villages ' $Ctl_PayEntity ' , ' $ReportEndDate
end-procedure Print_CrossBdr_Villages
!*****************************************************************************************
begin-procedure Get_Formatted_Date
#Debug Show '-> Get_Formatted_Date '


  !-----------------------------------------------------------------------------

   do Format-DateTime($B_DT, $B_DT_P, {DEFDATE}, '', '')
   do Format-DateTime($E_DT, $E_DT_P, {DEFDATE}, '', '')

   do ConvertToComponents($B_DT,$yy_BDT,$mm_BDT,$dd_BDT)
   do ConvertToComponents($E_DT,$yy_EDT,$mm_EDT,$dd_EDT)
    do ConvertToComponents($TaxTermDt,$yy_EDTR,$mm_EDTR,$dd_EDTR)
   do ConvertToComponents($PRD_E_DTR,$yy_DTR,$mm_DTR,$dd_DTR)

      let #Date_Type= {DateType}
   
   let $B_DatePr     = ''
   let $E_DTR1     = ''
   let $PRD_E_DTR1 = ''

   evaluate #Date_Type
   when = 1
          let $B_DatePr = $dd_BDT || '{PTDateDelim}' || $mm_BDT || '{PTDateDelim}'
          break
   when-other
          let $B_DatePr = $mm_BDT || '{PTDateDelim}' || $dd_BDT || '{PTDateDelim}'
          break
   end-evaluate

   evaluate #Date_Type
   when = 1
          let $E_DatePr = $dd_EDT || '{PTDateDelim}' || $mm_EDT || '{PTDateDelim}'
          break
   when-other
          let $E_DatePr = $mm_EDT || '{PTDateDelim}' || $dd_EDT || '{PTDateDelim}'
          break
   end-evaluate
 !************Syed for 89 B14**********
    
   if rtrim($TaxTermDt,' ') <> '' 
      Evaluate #Date_Type
      when = 1
           let $E_DTR1 = $dd_EDTR || '{PTDateDelim}' || $mm_EDTR || '{PTDateDelim}'
      break
      when-other
           let $E_DTR1 = $mm_EDTR || '{PTDateDelim}' || $dd_EDTR || '{PTDateDelim}'
      break
      End-Evaluate
     end-if

   if rtrim($B_DT,' ') <> ''
    evaluate #Date_Type
   when = 1
          let $B_DatePr1 = $dd_BDT || '{PTDateDelim}' || $mm_BDT || '{PTDateDelim}'
          break
   when-other
          let $B_DatePr1 = $mm_BDT || '{PTDateDelim}' || $dd_BDT || '{PTDateDelim}'
          break
   end-evaluate
   end-if

    if rtrim($PRD_E_DTR,' ') <> ''

      Evaluate #Date_Type
      when = 2
        let $PRD_E_DTR1 = $yy_DTR || '{PTDateDelim}' || $mm_DTR
      break
      when-other
        let $PRD_E_DTR1 = $mm_DTR || '{PTDateDelim}' || $yy_DTR
      break
      End-Evaluate

   end-if

  

 !**************************************

  if $PBD.GPCH_RC_AL01_S1 = 'E'
     let $Mutation = $EStr || $B_DatePr
  end-if

  if $PBD.GPCH_RC_AL01_S1 = 'T'
     let $Mutation = $TStr || $B_DatePr
  end-if

  if rtrim($PBD.GPCH_RC_AL01_S1,' ') <> ''
     if $PBD.GPCH_RC_AL01_S2 = 'A'
        let $Mutation = $Mutation || ' ' || $AStr || $E_DatePr
     end-if
  else
     if $PBD.GPCH_RC_AL01_S2 = 'A'
        let $Mutation = $AStr || $E_DatePr
     end-if
  end-if
    
#Debug Show '<- Get_Formatted_Date '
end-procedure Get_Formatted_Date
!******************************************************************************
begin-procedure Print_Current_Data
#Debug Show '-> Print_Current_Data '  $N_Id 

  alter-printer
  point-size = 9

   let $IT_Exist_Data    = 'Y'
   let $Existed_Dat      = 'Y'
   let $Was_Printed_Data = 'Y'
   let $Mutation         = ''

   do Get_Formatted_Date
  !   do ConvertToComponents($Birth_DT,$tmp_y,$tmp_m,$tmp_d)
   ! let $Birth_DT1 = $tmp_d ||'-' || $tmp_m ||'-' || $tmp_y
   
   do Format-DateTime($Birth_DT, $Birth_DT1, {DEFDATE}, '', '')
   do Format-Number(#Amount1,$Amount1_1,',999,999,999,999.99')
   do Format-Number(#Amount2,$Amount2_1,'9,999,999.99')
   do Format-Number(#Amount3,$Amount3_1,',999,999,999,999.99')
    do Format-Number(#Amt_tot,$Amt_tot_1,',999,999,999,999.99')
    do Format-Number(#Amount20,$Amount20_1,',99')
     

      
      if $N_Id <> ''
         let $N_IdT      = edit($N_Id,'XXX.XX.XXX.XXX')
      else
         do Format-Number(#Empl_RCD,$EmplRcd,'888')
         let $EmplID_Rcd = $Birth_DT1 || '-' || $EmplRcd
      end-if

      if $NNSS_Id <> ''
         let $NNSS_IdT= substr($NNSS_Id,1,3)||'.'||
                       substr($NNSS_Id,4,4)||'.'||
                       substr($NNSS_Id,8,4)||'.'||
                       substr($NNSS_Id,12,2)

        print $NNSS_IdT  (+1,{colA1})
      else
        let $N_IdT = ''
        if $N_Id <> ''
          let $N_IdT      = edit($N_Id,'XXX.XX.XXX.XXX')
        end-if
        print $N_IdT  (+1,{colA1})
      end-if 


      print $Empl_Name              (,39,35)  bold
      print $Birth_DT1              (,24,10)




      if rtrim($Canton,' ') = 'GE'
      print $Postal_Lok             (,{colA8},5)   bold
      end-if
      print $Mutation               (,{colA2})
      print $Amount1_1              (,{colA3})
      print $Amount2_1              (,{colA4})
      print $Tariff_CD              (,{colA5})
      print $Amount3_1              (,{colA6})




   let #Total_Comm_Tax_Amnt  = #Total_Comm_Tax_Amnt + #Amount3
   let #Total_Gross_Tax_Amnt = #Total_Gross_Tax_Amnt + #Amount1

#Debug Show '<- Print_Current_Data '
end-procedure Print_Current_Data
!*****************************************************************************************
begin-procedure TO_5Rapen(:#AmntInOut)
#Debug Show '-> TO_5Rapen '
   let #AmntInOut = round(#AmntInOut, 2)
   let #AmntInOut = #AmntInOut * 20
   let #AmntInOut = round(#AmntInOut, 0)
   let #AmntInOut = #AmntInOut / 20
#Debug Show '<- TO_5Rapen '
end-procedure
!***********************************************************************************************
begin-procedure Accumulate_Print_Village_Total
#Debug Show '-> Accumulate_Print_Village_Total '


 let $Merk_Header = 'CAN'

 do Format-Number(#Total_Comm_Tax_Amnt ,$Total_Comm_Tax_Amount_1 ,',999,999,999,999.99')
 do Format-Number(#Total_Gross_Tax_Amnt,$Total_Gross_Tax_Amount_1,',999,999,999,999.99')

 print '_'                       (+2,3,176) fill
 print $TOTAL_COMMUNE_STR        (+1,{colA1})
 print $Village_Name             (,22)
 print $Total_Gross_Tax_Amount_1 (,{colA3})
 print $Total_Comm_Tax_Amount_1  (,{colA6})



    if $Ctl_Print_Vill_Total = 'Y'

       let #Total_Comm_Tax_Amnt5_0 = #Total_Comm_Tax_Amnt
       let #Total_Comm_Tax_Amnt5_1 = (#Staxb_PCTR  * #Total_Comm_Tax_Amnt5_0) / 100
       let #Total_Comm_Tax_Amnt5_1 = round(#Total_Comm_Tax_Amnt5_1,2)
       let #Total_Comm_Tax_Amnt5_1 = #Total_Comm_Tax_Amnt5_1 * 20
       let #Total_Comm_Tax_Amnt5_1 = round(#Total_Comm_Tax_Amnt5_1,0)
       let #Total_Comm_Tax_Amnt5_1 = #Total_Comm_Tax_Amnt5_1 / 20

       let #Total_Comm_Tax_Amnt6_1 = #Total_Comm_Tax_Amnt - #Total_Comm_Tax_Amnt5_1
       let #Total_Comm_Tax_Amnt6_1 = round(#Total_Comm_Tax_Amnt6_1,2)
       let #Total_Comm_Tax_Amnt6_1 = #Total_Comm_Tax_Amnt6_1 * 20
       let #Total_Comm_Tax_Amnt6_1 = round(#Total_Comm_Tax_Amnt6_1,0)
       let #Total_Comm_Tax_Amnt6_1 = #Total_Comm_Tax_Amnt6_1 / 20

       do Format-Number(#Staxb_PCTR,$Staxb_PCTR_1,'888.00')
       do Format-Number(#Total_Comm_Tax_Amnt5_1,$Total_Comm_Tax_Amnt4_1,',999,999,999,999.99')
       do Format-Number(#Total_Comm_Tax_Amnt6_1,$Total_Comm_Tax_Amnt5_1,',999,999,999,999.99')



       print $PERCENT1_STR           (+2,{colA1})
       print ' '                     (,+1)
       print $Staxb_PCTR_1           (,+1)
       print ' '                     (,+1)
       print '%'                     (,+1)
       print ' '                     (,+1)
       print $PERCENT2_STR           (,+1)
       print $Total_Comm_Tax_Amnt4_1 (,{colA6})
       print $DELIVERY_STR_CAN       (+2,{colA1})
       print $Total_Comm_Tax_Amnt5_1 (,{colA6})

    end-if


     do Insert_Canton_Data
     let #Total_Cant_Tax_Amount = #Total_Cant_Tax_Amount + #Total_Comm_Tax_Amnt
     let #Total_Comm_Tax_Amnt   = 0
     let #Total_Gross_Tax_Amnt  = 0
     new-page


#Debug Show '<- Accumulate_Print_Village_Total '
end-procedure Accumulate_Print_Village_Total
!******************************************************************************************
begin-procedure Insert_Canton_Data
#Debug Show '-> Insert_Canton_Data'
put $Tax_Tariff_Type            into CRekapData(#ComCount) CRekap1
put $Village_CD                 into CRekapData(#ComCount) CRekap2
put $Village_Name               into CRekapData(#ComCount) CRekap3
put #Total_Comm_Tax_Amnt        into CRekapData(#ComCount) CRekap4

let #ComCount = #ComCount + 1
#Debug Show '<- Insert_Canton_Data'
end-procedure

!******************************************************************************************
begin-procedure Print_Canton_Total
#Debug Show '-> Print_Canton_Total'

let $Post_Rek     = '1'
let #CountRekData = 0


while #CountRekData < #ComCount

  get $Post_Rek       from CRekapData(#CountRekData) CRekap1
  get $Tx_CD_rek      from CRekapData(#CountRekData) CRekap2
  get $Descr_Rek      from CRekapData(#CountRekData) CRekap3
  get #Tax_Amn3       from CRekapData(#CountRekData) CRekap4

      if ($Post_Rek <> 'S')
           evaluate $Post_Rek
           when = 'A'
              let $BC_STR = $BORDER_CR_STR || ' (' || $COUNTRY_AUSTRIA || ')'
              break
           when = 'D'
              let $BC_STR = $BORDER_CR_STR || ' (' || $COUNTRY_GERMANY|| ')'
              break
           when = 'O'
              let $BC_STR = $BORDER_CR_STR || ' ' || $WITHOUT_STR
              break
           when = 'I'
              let $BC_STR = $BORDER_CR_STR || ' (' || $COUNTRY_ITALY|| ')'
              break
           when-other
              let $BC_STR = ''
              break
           end-evaluate
       else
              let $BC_STR = ''
       end-if

     let $BC_STR = $Descr_Rek || ' ' || $BC_STR


  do Format-Number(#Tax_Amn3,$Tax_Amn3_1,'99,999,999,999.99')

  print $Tx_CD_rek      (+1,{colA1})
  print $BC_STR         (,{col9A})
  print $Tax_Amn3_1     (,{colA7})
  let #CountRekData = #CountRekData + 1
end-while

let #ComCount = 0

#Debug Show '<- Print_Canton_Total'
end-procedure Print_Canton_Total
!*************************************************************************
begin-procedure New_Canton
#Debug Show '-> New_Canton '

   let #Count_Cant = #Count_Cant + 1

   let $Merk_Header = 'COM'

   do Print_Canton_Total
   do Format-Number(#Total_Cant_Tax_Amount,$Total_Cant_Tax_Amount_1,'99,999,999,999.99')
   do Format-Number(#Staxb_PCT,$Staxb_PCT_1,'888.00')

   let #Total_Cant_Amount4 = (#Staxb_PCT  * #Total_Cant_Tax_Amount) / 100
   do TO_5Rapen(#Total_Cant_Amount4)
   do Format-Number(#Total_Cant_Amount4,$Total_Cant_Amount4_1,'99,999,999,999.99')

   let #Total_Cant_Amount5 = #Total_Cant_Tax_Amount - #Total_Cant_Amount4
   do TO_5Rapen(#Total_Cant_Amount5)
   do Format-Number(#Total_Cant_Amount5,$Total_Cant_Amount5_1,'99,999,999,999.99')

   print '_'                      (+2,3,176) fill
   print $TOTAL_CANTON_STR        (+1,{colA1})
   print $Canton_Name             (,22)
   print $Total_Cant_Tax_Amount_1 (,{colA7})
   print $PERCENT1_STR            (+2,{colA1})
   print ' '                      (,+1)
   print $Staxb_PCT_1             (,+1)
   print ' '                      (,+1)
   print '%'                      (,+1)
   print ' '                      (,+1)
   print $PERCENT2_STR            (,+1)
   print $Total_Cant_Amount4_1    (,{colA7})
   print $DELIVERY_STR_CAN        (+2,{colA1})
   print $Total_Cant_Amount5_1    (,{colA7})

   do Insert_Total_Data

   let #Total_Cant_Tax_Amount     = 0
   let #Total_Cant_Amount4        = 0
   let #Total_Cant_Amount5        = 0

   new-page

   let $Merk_Header = 'CAN'
   let #PageCounter = 0

#Debug Show '<- New_Canton '
end-procedure New_Canton
!********************************************************************
begin-procedure Insert_Total_Data
#Debug Show '-> Insert_Total_Data  '

put $Canton                              into RekapData(#CantonCount) Rekap1
put $Canton_Name                         into RekapData(#CantonCount) Rekap2
put #Total_Cant_Tax_Amount               into RekapData(#CantonCount) Rekap3
put #Staxb_PCT                           into RekapData(#CantonCount) Rekap4
put #Total_Cant_Amount4                  into RekapData(#CantonCount) Rekap5
put #Total_Cant_Amount5                  into RekapData(#CantonCount) Rekap6

let #CantonCount = #CantonCount + 1

#Debug Show '<- Insert_Total_Data  '
end-procedure
!********************************************************************
Begin-Procedure Get_Martial_Status_GE($ZivStatus,:$MarStat,:$Mar_Stat_Formalix_GE,:$MarStat_Common_Law)
#debug show 'Get_Martial_Status_GE -> ' $eMPLID ' , ' $ZivStatus
#debug show $_COMMON_LAW ' , ' $_DIVORCED ' , ' $_SEPARATED ' , ' $_HEADHOUSE  ' , ' $_MARRIED ' , ' $_SINGLE ' , ' $_UNKNOWN ' , ' $_WIDOWED


   let $MarStat_Common_Law = '0'
   evaluate $ZivStatus
   when = 'C'
    let $MarStat = $_COMMON_LAW
    let $Mar_Stat_Formalix_GE='1'
    let $MarStat_Common_Law = '1'   
   break
   when = 'D'
    let $MarStat = $_DIVORCED
    let $Mar_Stat_Formalix_GE='3'
   break
   when = 'E'
    let $MarStat = $_SEPARATED
    let $Mar_Stat_Formalix_GE='4'
   break
   when = 'H'
    let $MarStat = $_HEADHOUSE
    let $Mar_Stat_Formalix_GE=''
   break
   when = 'M'
    let $MarStat = $_MARRIED
    let $Mar_Stat_Formalix_GE='2'
   break
   when = 'S'
    let $MarStat = $_SINGLE
    let $Mar_Stat_Formalix_GE='1'
   break
   when = 'U'
    let $MarStat = $_UNKNOWN
    let $Mar_Stat_Formalix_GE='0'
   break
   when = 'W'
    let $MarStat = $_WIDOWED
    let $Mar_Stat_Formalix_GE='5'
   break
      when = 'L'
    let $MarStat = $_PARTNERSHIP
    let $Mar_Stat_Formalix_GE='6'
   break
   when = 'P' 
    let $MarStat = $_PARTNERSHIP
    let $Mar_Stat_Formalix_GE='6'
   break
   when = 'T' 
    let $MarStat = $_PARTNERSHIP
    let $Mar_Stat_Formalix_GE='6'
   break
   when = 'V' 
    let $MarStat = $_PARTNERSHIP
    let $Mar_Stat_Formalix_GE='6'
   break
   when-other
   let $FormalixError = 'Error:'||rtrim($Emplid_Q,' ')||' - Civil Status Invalid'
       write 12 from $FormalixError
       let $ErrorFlag = '1'
   break
   end-evaluate

#debug show 'Get_Martial_Status_GE <- ' $MarStat
End-Procedure
!********************************************************************
Begin-Procedure Get_Martial_Status_TI($ZivStatus,:$MarStat)
#debug show 'Get_Martial_Status_TI -> ' $eMPLID ' , ' $ZivStatus
#debug show $_COMMON_LAW ' , ' $_DIVORCED ' , ' $_SEPARATED ' , ' $_HEADHOUSE  ' , ' $_MARRIED ' , ' $_SINGLE ' , ' $_UNKNOWN ' , ' $_WIDOWED

   evaluate $ZivStatus
   when = 'C'
    let $MarStat = 'Convivente'
   break
   when = 'D'
    let $MarStat = 'Divorziato'
   break
   when = 'E'
    let $MarStat = 'Separato'
   break
   when = 'H'
    let $MarStat = 'Capofamiglia'
   break
   when = 'M'
    let $MarStat = 'Coniugato'
   break
   when = 'S'
    let $MarStat = 'Celibe/Nubile'
   break
   when = 'U'
    let $MarStat = 'Non disponibile'
   break
   when = 'W'
    let $MarStat = 'Vedovo'
   break
   when-other
   break
   end-evaluate

#debug show 'Get_Martial_Status_TI <- ' $MarStat
End-Procedure
!***********************************************************************************************
! Attestation Quittance   : Report B
!***********************************************************************************************
Begin-Procedure Initial_Strings_GE
#Debug Show '-> Initial_Strings_GE '

  let $At_StringH1   = 'ATTESTATION-QUITTANCE '
  let $At_StringH2   = 'RPUBLIQUE ET CANTON DE GENVE'
  let $At_StringH3   = 'concernant l''impt  la source sur les prestations verses aux salaris ' ||
                       'trangers, frontaliers, enfants mineurs,'
  let $At_StringH4   = 'bnficiaires de revenus acquis en compensation, administrateurs*, ' ||
                       'cranciers hypothcaires*,'
  let $At_StringH5   = 'bnficiaires de prestations priodiques de caisses de prvoyance (rentes)*'
  let $At_StringH6   = '(*  prciser ci-dessous)'
  let $At_StringH7   = 'Administration fiscale cantonale'
  let $At_StringH8   = 'Numro AVS'

  let $At_String1   = '1*. Administrateur'
  let $At_String2   = 'Crancier hypothcaire'
  let $At_String3   = 'Bnficiaire de rentes de caisses de prvoyance'
  let $At_String4   = '2. Personne assujettie  l''impt  la source'
  let $At_String5   = 'Nom'
  let $At_String6   = 'Prnom'
  let $At_String7   = 'Domicile'
  let $At_String8   = 'Rue/no'
  let $At_String9   = 'Localit/pays'
  let $At_String10  = 'Lieu de travail'
  let $At_String11  = 'Commune'
  let $At_String12   = 'Canton'
  let $At_String13   = 'Date de naissance'
  let $At_String14   = 'Etat civil'
  let $At_String15   = 'Nombre d''enfants'
  let $At_String151  = 'Nom et prnom du conjoint'
  let $At_String152  = 'Celui-ci travaille-t-il en Suisse ?'
  let $At_String153  = 'oui'
  let $At_String154  = 'non'
  let $At_String16   = '3. Retenue de l''impt  la source'
  let $At_String17   = 'Priode d''assujettissement'
  let $At_String18   = 'du'
  let $At_String19   = 'au'
  let $At_String20   = 'Nombre de jours de travail'
  let $At_String21   = 'Barme appliqu:'
  let $At_String22   = 'Taux: (%)'
  let $At_String23   = 'Prestations soumises  l''impt'
  let $At_String24   = 'en espces + en nature'
  let $At_String25   = 'Impts retenus'
  let $At_String26   = 'Contribution'
  let $At_String27   = 'ecclsiastique*'
  let $At_String28   = 'Retenue totale'
  let $At_String28_1 = 'Prestations en capital verses  la fin des rapports de service, incluses dans les prestations soumises  l''impt'
  let $At_String29   = 'Indemnits pour frais non incluses dans les prestations soumises  l''impt'
  let $At_String30   = 'Nombre de jours d''absence par suite de vacances, de maladie, d''accident ' ||
                       'ou de chmage, pour lesquels les indemnits'
  let $At_String31   = 'n''ont pas t verses par l''employeur et qui ne figurent pas dans ' ||
                       'les prestations soumises  l''impt'
  let $At_String32   = '4. Employeur/Dbiteur de la prestation imposable'
  let $At_String33   = 'No. d''identification'
  let $At_String34   = 'Nom ou raison sociale'
  let $At_String35   = 'Rue/no'
  let $At_String36   = 'Localit'
  let $At_String37   = 'Canton'
  let $At_String38   = 'Date de remise de l''attestation'
  let $At_String39   = 'Signature'
  let $At_String40   = 'Le contribuable qui conteste le montant de la retenue  la source qui lui ' ||
                       'est faite peut dposer une rclamation crite'
  let $At_String41   = 'et motive auprs du dpartement:'
  let $At_String42   = 'a) si l''attestation a t remise avant le dernier ' ||
                       'jour du mois de fvrier de l''anne qui suit celle pour laquelle l''impt ' ||
                       'a t retenu:'
  let $At_String43   = 'jusqu''au 31 mars de cette mme anne.'
  let $At_String44   = 'b) si l''attestation a t remise ultrieurement: dans les 30 jours qui suivent ' ||
                       'cette remise, mais au plus tard le 31 dcembre de l''anne qui suit celle pour'
  let $At_String45   = 'laquelle l''impt a t retenu.'
  let $At_String46   = 'Lorsque le contribuable a reu plusieurs attestations pour l''impt d''une ' ||
                       'mme anne, le dlai de rclamation court  compter de la date  laquelle la'
  let $At_String47   = 'dernire attestation lui a t remise.'
  let $At_String48   = '* ne complter qu''en cas de paiement de la contribution ecclsiastique'
  let $At_String49   = 'Exemplaire pour l''administration fiscale cantonale'
  let $At_String50   = 'Exemplaire pour l''employ'
  let $At_String51   = 'Exemplaire pour l''employeur'

#Debug Show '<- Initial_Strings_GE '
End-Procedure Initial_Strings_GE
!***********************************************************************************************
begin-procedure Print_Data_GE
#Debug Show '-> Print_Data_GE '
  do Get-Language($ReportID, 'FRA')
  do Initial_Strings_GE

  let $NoDat      = 'Y'
  let $old_Emplid = ' '
  
 if $GPCH_EG_YEP_FLG ='Y' and $ptot_userkey='GE'  
    let $AccumlatorNames = '''CH_TX_GE39_YTD'',''CH_TX_GE31_YTD'',''CH_TX_GE34_YTD'',''CH_LW_30'',''CH_LW_15006'',''CH_LW_1311'',''CH_LW_1312'',''CH_LW_1321'',''CH_LW_1322'',''CH_LW_1323'',''CH_LW_15001'',''CH_LW_120'''
     do Extract_ERN_DED_YTD_CALC
    let $assujettissementContribuable = ''
    let $AssujettissementTag_Flag = 'False'
 end-if
  
  
  
begin-select
PBDQ.EMPLID
PBDQ.GPCH_TX_CANTON
PBDQ.GPCH_TX_VILLAGE_CD
PBDQ.GPCH_TX_TRF_TYPE
PBDQ.EMPL_RCD
PBDQ.BEGIN_DT
PBDQ.END_DT
PBDQ.HIRE_DT
PBDQ.TERMINATION_DT
PBDQ.GPCH_TX_TRF_CD
PBDQ.GPCH_RP_AMOUNT1
PBDQ.GPCH_RP_AMOUNT2
PBDQ.GPCH_RP_AMOUNT3
PBDQ.GPCH_RP_AMOUNT10
PBDQ.GPCH_RP_AMOUNT14
PBDQ.GPCH_RP_AMOUNT15
PBDQ.GPCH_RP_AMOUNT19
PBDQ.GPCH_RP_AMOUNT20
PBDQ.GPCH_RP_AMOUNT21
PBDQ.GPCH_RP_AMOUNT24
PBDQ.GPCH_RP_AMOUNT25
PBDQ.GPCH_RP_AMOUNT27
PBDQ.NATIONAL_ID
PBDQ.GPCH_AH_NNSS
PBDQ.NAME
PBDQ.BIRTHDATE
PBDQ.SEX
PBDQ.MAR_STATUS
PBDQ.COUNTRY_FROM
PBDQ.POSTAL
PBDQ.GPCH_TX_VILLAGE_L
PBDQ.SPOUSE_NAME
PBDQ.GPCH_TX_SPOUSE_WL
PBDQ.LOCATION
PBDQ.FTE
PBDQ.SETID_LOCATION

     let #CH_TX_GE39_YTD_Val = 0
     let #CH_TX_GE31_YTD_Val = 0
     let #CH_TX_GE34_YTD_Val = 0
     let #CH_TX_GE30_YTD_Val = 0
     let #CH_LW_30_Val = 0
     let #CH_LW_15006_Val = 0
     let #CH_LW_1311_Val = 0
     let #CH_LW_1312_Val = 0
     let #CH_LW_1321_Val = 0
     let #CH_LW_1322_Val = 0
     let #CH_LW_1323_Val = 0
     let #CH_LW_15001_Val = 0
     let #CH_LW_120_Val = 0
     let #CH_TX_GE39_YTD_Val = 0
     
   if $NoDat = 'N' and $Empl_IDQ <> rtrim(&PBDQ.EMPLID,' ')
     if $GPCH_EG_YEP_FLG ='Y'
      do Get_Accum_Value('CH_TX_GE39_YTD',$Empl_IDQ,#Empl_RCDQ,#CH_TX_GE39_YTD_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_TX_GE31_YTD',$Empl_IDQ,#Empl_RCDQ,#CH_TX_GE31_YTD_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_TX_GE34_YTD',$Empl_IDQ,#Empl_RCDQ,#CH_TX_GE34_YTD_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_30',$Empl_IDQ,#Empl_RCDQ,#CH_LW_30_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_15006',$Empl_IDQ,#Empl_RCDQ,#CH_LW_15006_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1311',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1311_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1312',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1312_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      
      let #Amount_LW_1311_12_Val = #CH_LW_1311_Val + #CH_LW_1312_Val
      
      do Get_Accum_Value('CH_LW_1321',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1321_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1322',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1322_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1323',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1323_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      
      let #Amount_LW_1321_22_Val = #CH_LW_1321_Val + #CH_LW_1322_Val + #CH_LW_1323_Val
      
      do Get_Accum_Value('CH_LW_15001 ',$Empl_IDQ,#Empl_RCDQ,#CH_LW_15001_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_120',$Empl_IDQ,#Empl_RCDQ,#CH_LW_120_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      ! 20140207 $participationsEmployes
      do Get_Accum_Value('CH_QS_F',$Empl_IDQ,#Empl_RCDQ,#CH_QS_F_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)

              
     end-if
      do Print_Strings_GE
     
     let  #Amount24Q=0
     let #Amount25Q=0
     let #Amount27Q=0 
     let $AssujettissementTag_Flag = 'False'
     let $assujettissementContribuable=''
     
   end-if
  
   
   let $Emplid_Q       =  &PBDQ.EMPLID
   let $Empl_IDQ       =  rtrim(&PBDQ.EMPLID,' ')
   let #Empl_RCDQ      =  &PBDQ.EMPL_RCD
   let $CantonQ        =  rtrim(&PBDQ.GPCH_TX_CANTON,' ')
   let $Village_CDQ    =  rtrim(&PBDQ.GPCH_TX_VILLAGE_CD,' ')
   let $Tariff_CDQ     =  rtrim(&PBDQ.GPCH_TX_TRF_CD,' ')
   let $ZivStatQ       =  rtrim(&PBDQ.MAR_STATUS,' ')
   let $B_DTQ          =  &PBDQ.BEGIN_DT
   let $E_DTQ          =  &PBDQ.END_DT
   !FMB 20090422 Read Spouse_Name instead of taking from GPCH_RP_0001
        let $Spouse_enddtQ = $Ctl_End_Dt
        do Get_Spouse_Name($Empl_IDQ,$Spouse_enddtQ,$SPOUSE_NAMEQ)

   let $SPOUSE_WLQ_GE     = rtrim(&PBDQ.GPCH_TX_SPOUSE_WL,' ')
   let $Sex_GE         = rtrim(&PBDQ.SEX,' ')
   let $Postal_GE      = rtrim(&PBDQ.POSTAL,' ')
   let $Village_LQ     = rtrim(&PBDQ.GPCH_TX_VILLAGE_L,' ')
   let $Country_GE     = rtrim(&PBDQ.COUNTRY_FROM,' ')
   let $Wrk_Location_GE = rtrim(&PBDQ.LOCATION,' ')
   let #FTE_GE_XML     =  &PBDQ.FTE
   let $loc_setid       = rtrim(&PBDQ.SETID_LOCATION,' ') !sqh

   do Get_Martial_Status_GE($ZivStatQ,$MarStatQ,$Mar_Stat_Formalix_GE,$MarStat_Common_Law)

   let #Amount1Q     =  #Amount1Q + &PBDQ.GPCH_RP_AMOUNT1+ &PBDQ.GPCH_RP_AMOUNT2
   let #Amount2Q     =  0
   let #Amount3Q     =  #Amount3Q + &PBDQ.GPCH_RP_AMOUNT3 + &PBDQ.GPCH_RP_AMOUNT14 + &PBDQ.GPCH_RP_AMOUNT19
   let #Amount7Q     =  0
   let #Amount8Q     =  #Amount8Q + &PBDQ.GPCH_RP_AMOUNT3 + &PBDQ.GPCH_RP_AMOUNT14 + &PBDQ.GPCH_RP_AMOUNT19
   let #Amount10Q    =  &PBDQ.GPCH_RP_AMOUNT10
   let #Amount14Q    =  0
   let #Amount15Q    =  &PBDQ.GPCH_RP_AMOUNT15
   let #Amount20Q    =  &PBDQ.GPCH_RP_AMOUNT20
   let #Amount21Q    =  #Amount21Q + &PBDQ.GPCH_RP_AMOUNT21
   let #Amount24Q    =  #Amount24Q + &PBDQ.GPCH_RP_AMOUNT24
   let #Amount25Q    =  #Amount25Q + &PBDQ.GPCH_RP_AMOUNT25
   let #Amount27Q    =  #Amount27Q + &PBDQ.GPCH_RP_AMOUNT27


   let $N_IdQ        =  rtrim(ltrim(&PBDQ.NATIONAL_ID,' '),' ')
   let $NNSS_IdQ     =  rtrim(ltrim(&PBDQ.GPCH_AH_NNSS,' '),' ')
   let $Birth_DTQ    = &PBDQ.BIRTHDATE

   let $Canton       = $CantonQ
   let $Village_CD   = $Village_CDQ
      do Get_Village_Name
      do Get_Canton_Name
   if $old_Emplid <> $Empl_IDQ or ($old_Emplid = $Empl_IDQ and $AQ_Begin_Date <> $B_DTQ)
      let $AQ_Begin_Date = $B_DTQ
   end-if

   let $AQ_End_Date            = $E_DTQ
   
   let $NoDat                  = 'N'
  

   if $GPCH_EG_YEP_FLG ='Y' and $ptot_userkey='GE' 
     if $AssujettissementTag_Flag = 'False'
          do Get_Canton_Tariff_Formalix
          do Create_AssujettissementTag
          let $AssujettissementTag_Flag = 'True'
     else
     
       if ($Empl_IDQ = $old_Emplid) and ($Village_LQ_old <> rtrim(&PBDQ.GPCH_TX_VILLAGE_L,' ') 
           or $Tariff_CDQ_old  <>  rtrim(&PBDQ.GPCH_TX_TRF_CD,' ') or  $Wrk_Location_GE_old  <>  rtrim(&PBDQ.LOCATION,' ') or $Begin_date_old <>$B_DTQ)
           do Get_Canton_Tariff_Formalix
           do Create_AssujettissementTag
       End-if
      end-if
   end-if
   let $Village_LQ_old = $Village_LQ
   let $old_Emplid = $Empl_IDQ
   let $Tariff_CDQ_old =$Tariff_CDQ
   let $Wrk_Location_GE_old = $Wrk_Location_GE
   let $Begin_date_old =$B_DTQ
  

FROM PS_GPCHTX012_VW PBDQ
WHERE PBDQ.GPCH_TX_CANTON   = 'GE'
AND   PBDQ.PROCESS_INSTANCE = #prcs_process_instance
ORDER BY PBDQ.NATIONAL_ID,PBDQ.GPCH_AH_NNSS,PBDQ.NAME,PBDQ.EMPLID,PBDQ.EMPL_RCD,PBDQ.BEGIN_DT
end-select

if $NoDat = 'N'

     let #CH_TX_GE39_YTD_Val = 0
     let #CH_TX_GE31_YTD_Val = 0
     let #CH_TX_GE34_YTD_Val = 0
     let #CH_TX_GE30_YTD_Val = 0
     let #CH_LW_30_Val = 0
     let #CH_LW_15006_Val = 0
     let #CH_LW_1311_Val = 0
     let #CH_LW_1312_Val = 0
     let #CH_LW_1321_Val = 0
     let #CH_LW_1322_Val = 0
     let #CH_LW_1323_Val = 0
     let #CH_LW_15001_Val = 0
     let #CH_LW_120_Val = 0
     let #CH_TX_GE39_YTD_Val = 0
     let #CH_QS_F_Val = 0
     
    if $GPCH_EG_YEP_FLG ='Y'
      do Get_Accum_Value('CH_TX_GE39_YTD',$Empl_IDQ,#Empl_RCDQ,#CH_TX_GE39_YTD_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_TX_GE31_YTD',$Empl_IDQ,#Empl_RCDQ,#CH_TX_GE31_YTD_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_TX_GE34_YTD',$Empl_IDQ,#Empl_RCDQ,#CH_TX_GE34_YTD_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_30',$Empl_IDQ,#Empl_RCDQ,#CH_LW_30_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_15006',$Empl_IDQ,#Empl_RCDQ,#CH_LW_15006_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1311',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1311_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1312',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1312_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      
      let #Amount_LW_1311_12_Val = #CH_LW_1311_Val + #CH_LW_1312_Val
      
      do Get_Accum_Value('CH_LW_1321',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1321_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1322',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1322_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_1323',$Empl_IDQ,#Empl_RCDQ,#CH_LW_1323_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      
      let #Amount_LW_1321_22_Val = #CH_LW_1321_Val + #CH_LW_1322_Val + #CH_LW_1323_Val
      
      do Get_Accum_Value('CH_LW_15001 ',$Empl_IDQ,#Empl_RCDQ,#CH_LW_15001_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      do Get_Accum_Value('CH_LW_120',$Empl_IDQ,#Empl_RCDQ,#CH_LW_120_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)
      ! 20140207 $participationsEmployes
      do Get_Accum_Value('CH_QS_F',$Empl_IDQ,#Empl_RCDQ,#CH_QS_F_Val,'GE',$Ctl_Start_Dt, $Ctl_End_Dt, #prcs_process_instance)     

     end-if
     do Print_Strings_GE
end-if

alter-printer
font = 1
point-size = 7.2
  do Delete-Rec-st023
  do Delete-Rec-AL078
#Debug Show '<- Print_Data_GE '
end-procedure Print_Data_GE
!******************************************************************************************
begin-procedure Get_Report_GE
#Debug Show '-> Get_Report_GE '

  let $PrType = '1'
  do Print_Data_GE
  let $PrType = '2'
  do Print_Data_GE
  let $PrType = '3'
  do Print_Data_GE

#Debug Show '<- Get_Report_GE '
end-procedure Get_Report_GE
!******************************************************************************************
begin-procedure Print_Strings_GE
#Debug Show '-> Print_Strings_GE '

   do InitChildData_GE


   do Get_Signature($Emplid_Q,$AQ_End_Date,$language_cd,$Signature_Type,$Cpdescr,$HD_FOR,
                    $Other_Py,$Signature1,$Signature2,$SI_PHONE,
                    $PAYENT_DESCR,$JobSuper_name,$JobPhone_num)

   do Get-Emp-Address($Empl_IDQ,$AQ_End_Date,'HOME', $ADDLINE1, $ADDLINE2, $ADDLINE3,$ADDLINE31, $ADDLINE4,
                      $ADDLINE5,$ADDLINE6,$Full_Name,$FirstName,$LastName,$NAME_PREFIX,$NAME_TITLE,
                      $NAME_ROYAL_PREFIX,$NAME_ROYAL_SUFFIX,$Phone,$Email,$City,$State,$Postal)
                      
                     
   let $PostBox_GE= $ADDLINE4                   
   let $ADDLINE4 = LTRIM(RTRIM($POSTAL1||' '||$CITY1,' '),' ')
   !-------------------------------------------------------------------
   Lookup Get_Trans_Canton_Descr $Cpstate $Return_Val
   let $Canton_Name_Employer = rtrim($Return_Val,' ')
   #DEBUG SHOW 'Canton_Descr_Lang : '  $Cpstate ' , ' $Canton_Name_Employer

   if Isnull ($Return_Val)
      Lookup Get_Base_Canton_Descr $Cpstate $Return_Val
      let $Canton_Name_Employer = rtrim($Return_Val,' ')
      #DEBUG SHOW 'Canton_Descr : '  $Cpstate  ' , ' $Canton_Name_Employer
   end-if
   !-------------------------------------------------------------------

   do Format-Number(#Amount20Q,$Amount20Q_1,'88')

   let $ChildCount = $Amount20Q_1
  
   do Format-DateTime($Issued_Date  , $Issued_Date1  , {DEFDATE}, '', '')
   do Format-DateTime($Birth_DTQ    , $Birth_DTQ1    , {DEFDATE}, '', '')
   do Format-DateTime($AQ_Begin_Date, $AQ_Begin_Date1, {DEFDATE}, '', '')
   do Format-DateTime($AQ_End_Date  , $AQ_End_Date1  , {DEFDATE}, '', '')

    
   if rtrim($AQ_Begin_Date1 , ' ') = ''
      do Format-DateTime($Ctl_Start_Dt, $AQ_Begin_Date1, {DEFDATE}, '', '')
   end-if

   if rtrim($AQ_End_Date1 , ' ') = ''
      do Format-DateTime($Ctl_End_Dt  , $AQ_End_Date1  , {DEFDATE}, '', '')
   end-if


   !-------------------------------------------------------------------
   do Format-Number(#Amount1Q ,$Amount1Q_1 ,'8,888,888,888.00')
   do Format-Number(#Amount3Q ,$Amount3Q_1 ,'8,888,888,888.00')
   do Format-Number(#Amount7Q ,$Amount7Q_1 ,'B,888,888,888.00')
   do Format-Number(#Amount8Q ,$Amount8Q_1 ,'8,888,888,888.00')
   do Format-Number(#Amount2Q ,$Amount2Q_2 ,'B,888,888,888.00')
   do Format-Number(#Amount14Q,$Amount14Q_1,'B,888,888,888.00')
   do Format-Number(#Amount15Q,$Amount15Q_1,'B,888,888,888.00')
   do Format-Number(#Amount21Q,$Amount21Q_1,'9,999')
   do Format-Number(#Amount24Q,$Amount24Q_2,'B,888,888,888.00')
   do Format-Number(#Amount25Q,$Amount25Q_2,'B,888,888,888.00')
   do Format-Number(#Amount27Q,$Amount27Q_2,'B,999')
   !Amounts For Formalix 
   do Format-Number(#Amount1Q ,$Amount1Q_1_FORLX ,'9999999999')
   do Format-Number(#Amount3Q ,$Amount3Q_1_FORLX ,'9999999999')
   do Format-Number(#Amount7Q ,$Amount7Q_1_FORLX ,'9999999999')
   do Format-Number(#Amount8Q ,$Amount8Q_1_FORLX ,'9999999999')
   do Format-Number(#Amount14Q,$Amount14Q_1_FORLX,'9999999999')
   do Format-Number(#Amount21Q,$Amount21Q_1_FORLX,'9999')
   !do Format-Number(#Amount15Q,$Amount15Q_1_FORLX,'9999999999')
   do Format-Number(#Amount15Q,$Amount15Q_1_FORLX,'88.00')
   do Format-Number(#Amount24Q,$Amount24Q_2_FORLX,'9999999999')
   do Format-Number(#Amount25Q,$Amount25Q_2_FORLX,'9999999999')


   if #Amount10Q <> 0
      let $Amount15Q_1 = $Amount15Q_1
   else
      let $Amount15Q_1 = ' '
   end-if

   !let $N_IdT = edit($N_IdQ,'XXX.XX.XXX.XXX')
   
   !let $NNSS_IdT = substr($NNSS_IdQ,1,3)||'.'||
   !                    substr($NNSS_IdQ,4,4)||'.'||
   !                   substr($NNSS_IdQ,8,4)||'.'||
   !                    substr($NNSS_IdQ,12,2)
     if $N_IdQ <> ''
       let $N_IdT      = edit($N_IdQ,'XXX.XX.XXX.XXX')
     End-If
     if $NNSS_IdQ <> ''
       let $NNSS_IdT      = edit($NNSS_IdQ,'XXX.XXXX.XXXX.XX')
     End-If

   
   do Format-Number(#Empl_RCDQ,$EmplRcd,'888')
   let $EmplID_Rcd = $N_IdT !|| '-' || $EmplRcd
   let $EmplID_Rcd1 = $NNSS_IdT
   let $At_String1_1 = $At_StringH1 || ' ' || $Ctl_Year

   !-------------------------------------------------------------------Printing Starts
   alter-printer
   font = 4
   point-size = 14
   print $At_String1_1     (1,{colG2})        bold
   !------------------------------------------------
   alter-printer
   font = 4
   point-size = 12
   print $At_StringH8         (11,95)
   !------------------------------------------------
   alter-printer
   font = 4
   point-size = 9.2
   print $At_String4          (18,{colG1})    bold
   print $At_String16         (31,{colG1})    bold
   print $At_String32         (56,{colG1})    bold
   !------------------------------------------------
   alter-printer
   font = 4
   point-size = 7.2
   print $At_StringH2        (1,{colG1})
   print $At_StringH7        (2,{colG1})
   print $At_StringH3        (3,{colG2})
   print $At_StringH4        (5,{colG2})
   print $At_StringH5        (7,{colG2})
   print $At_StringH6        (9,{colG2})
   graphic                   (10,93,35)        box 5 8
   print '      '           (14,95,70)       fill  bold
   print $At_String1          (16,{colG1})     bold
   graphic                    (,27,2)          box 1 8
   print $At_String2          (,44)            bold
   graphic                    (,66,2)          box 1 8
   print $At_String3          (,80)            bold
   graphic                    (,122,2)         box 1 8
   print $At_String5          (20,{colG1})     bold
   print '.   '               (20,15,110)      fill
   print $At_String6          (20,{colG3})     bold
   print '.   '               (20,79,108)      fill
   print $At_String7          (22,{colG1})     bold
   graphic                    (21,{colG1},15)  horz-line 9
   graphic                    (22,{colG1},15)  horz-line 9
   graphic                    (21,25,1)        vert-line 9
   print $At_String8          (22,27)
   print '.   '               (22,34,70)       fill
   print $At_String9          (22,{colG3})     bold
   print '.   '               (22,83,98)       fill
   print $At_String10         (24,{colG1})     bold
   graphic                    (23,{colG1},15)  horz-line 9
   graphic                    (24,{colG1},15)  horz-line 9
   graphic                    (23,25,1)        vert-line 9
   print $At_String11         (24,27)
   print '.   '               (24,34,70)       fill
   print $At_String12         (24,{colG3})     bold
   print '.   '               (24,83,98)       fill
   print $At_String13         (26,{colG1})     bold
   print '.   '               (26,25,40)       fill
   print $At_String14         (26,48)          bold
   print '.   '               (26,56,25)       fill
   print $At_String15         (26,{colG3})     bold
   print '.   '               (26,87,90)       fill
   print $At_String151        (28,{colG1})     bold
   print '.   '               (28,35,80)       fill
   print $At_String152        (29,{colG1})     bold
   print $At_String153        (29,40)          bold
   graphic                    (,45,2)          box 1 8
   print $At_String154        (29,50)          bold
   graphic                    (,55,2)          box 1 8
   print $At_String17         (33,{colG1})     bold
   print $At_String18         (33,48)          bold
   print '.   '               (33,51,28)       fill
   print $At_String19         (33,66)          bold
   print '.   '               (33,69,114)      fill
   print $At_String20         (35,{colG1})     bold
   graphic                    (34,36,8)        box 2 8
   print $At_String21         (37,{colG1})     bold
   graphic                    (37,25,16)       box 2 8
   print $At_String22         (37,48)          bold
   graphic                    (37,58,16)       box 2 8
   graphic                    (40,{colG1},118) horz-line 9
   print $At_String23         (41,{colG1})     bold
   print $At_String24         (42,{colG1})     bold
   print $At_String25         (41,40)          bold
   print $At_String26         (41,70)          bold
   print $At_String27         (42,70)          bold
   print $At_String28         (41,90)          bold
   graphic                    (43,{colG1},118) horz-line 9
   graphic                    (46,{colG1},118) horz-line 9
   graphic                    (40,39,6)         vert-line 9
   graphic                    (40,69,6)         vert-line 9
   graphic                    (40,89,6)         vert-line 9
   print $At_String28_1       (48,{colG1})
   graphic                    (48,95,26)        box 2 8
   print $At_String29         (50,{colG1})
   graphic                    (50,66,26)        box 2 8
   print $At_String30         (52,{colG1})
   print $At_String31         (53,{colG1})
   graphic                    (53,85,14)        box 2 8
   graphic                    (55,74,54)        horz-line 9
   graphic                    (57,74,54)        horz-line 9
   graphic                    (55,74,2)         vert-line 9
   print $At_String33         (57,75)
   print '.   '               (57,90,84)        fill
   print $At_String34         (58,{colG1})
   print '.   '               (58,30,80)        fill
   print $At_String35         (60,{colG1})
   print '.   '               (60,15,110)       fill
   print $At_String36         (60,75)
   print '.   '               (60,86,89)        fill
   print $At_String37         (62,75)
   print '.   '               (62,86,89)        fill
   print $At_String38         (63,{colG1})      bold
   print '.   '               (63,35,80)        fill
   print $At_String39         (66,{colG1})
   print '.   '               (66,20,102)       fill
   graphic                    (67,{colG1},118) horz-line 9
   print $At_String40         (68,{colG1})
   print $At_String41         (69,{colG1})
   print $At_String42         (71,{colG1})
   print $At_String43         (72,13)
   print $At_String44         (73,{colG1})
   print $At_String45         (74,13)
   print $At_String46         (75,{colG1})
   print $At_String47         (76,{colG1})
   graphic                    (76,{colG1},118) horz-line 9
   print $At_String48         (77,{colG1})

   !------------------------------------------------

   alter-printer
   font = 4
   point-size = 11
   print $EmplID_Rcd          (13,95)
   print $LastName            (20,16)
   print $FirstName           (20,84)
   print $ADDLINE2            (22,36)
   print $ADDLINE4            (22,84)
   print $Village_Name        (24,36)
   print $Canton_Name         (24,84)
   print $Birth_DTQ1          (26,26)
   print $MarStatQ            (26,57)
   print $ChildCount          (26,88)
   print $AQ_Begin_Date1      (33,52)
   print $AQ_End_Date1        (33,70)
   print $Tariff_CDQ          (38,26)
   print $Amount15Q_1         (38,59)
   print $SPOUSE_NAMEQ        (28,35)


   print $Amount21Q_1         (35,36)
   print $Amount1Q_1          (45,{colG1})
   print $Amount3Q_1          (45,40)
   print $Amount7Q_1          (45,70)
   print $Amount8Q_1          (45,90)
   print $Amount24Q_2         (49,100)
   print $Amount25Q_2         (51,70)
   print $Amount2Q_2          (51,67)
   print $Amount27Q_2         (54,84)
   print $Amount14Q_1         (55,86)
   print $Employer_StaxNr_GE  (57,91)
   print $Rep_Descr           (58,31)
   print $Rep_Addr1           (60,31)
   print $Rep_Postal          (60,86)
   print $Rep_Addr2           (62,86)
   print $Issued_Date1        (63,38)
   print $JobSuper_name1       (66,30)

   let $Rep_Descr = rtrim(&SA.DESCR,' ')
   let $Rep_Addr1 = rtrim(&SA.ADDRESS1,' ')
   let $Rep_Addr2 = rtrim(&SA.ADDRESS2,' ')
   let $Rep_Addr3 = rtrim(&SA.ADDRESS3,' ')
   let $POSTAL1 = rtrim(&SA.POSTAL,' ')
   let $CITY1 = rtrim(&SA.CITY,' ')
 
   let $Rep_Postal = LTRIM(RTRIM($POSTAL1||' '||$CITY1,' '),' ')

   !------------------------------------------------
   alter-printer
   font = 4
   point-size = 8
   graphic                    (80,{colG1},2)   box 1 8
   print $At_String49         (,13)            bold
   graphic                    (,60,2)          box 1 8
   print $At_String50         (,63)            bold
   graphic                    (,100,2)         box 1 8
   print $At_String51         (,103)           bold

   evaluate $PrType
   when = '1'
      print 'X'               (80,10)          bold
     
    if $GPCH_EG_YEP_FLG ='Y' and $ptot_userkey='GE'
       do Get_Employee_XML_GE
    else
      do Write-CSV-File
    end-if  
      
   break
   when = '2'
      print 'X'               (80,60)          bold
   break
   when = '3'
      print 'X'               (80,100)         bold
   break
   when-other
   break
   end-evaluate
   !------------------------------------------------

   alter-printer
   font = 4
   point-size = 7.2

   NEW-PAGE

   let #Amount1Q  = 0
   let #Amount3Q  = 0
   let #Amount8Q  = 0
   let #Amount20Q = 0
   let #Amount21Q = 0
   let #Amount27Q = 0

#Debug Show '<- Print_Strings_GE '
end-procedure Print_Strings_GE
!******************************************************************************************
! ATTESTATION D''IMPT  LA SOURCE   : Report C
!******************************************************************************************
begin-procedure Initial_Strings_VD
#Debug Show '-> Initial_Strings_VD '

  let $Str_Tit_VD       = 'ATTESTATION D''IMPT  LA SOURCE'
  let $Str_Ann_VD       = 'ANNE :'
  let $Str_Exemp_VD1    = 'Exemplaire pour l''Office d''impt de district'
  let $Str_Exemp_VD2    = 'Exemplaire pour l''employ'
  let $Str_Exemp_VD3    = 'Exemplaire pour l''employeur'
  let $Str_Duree_VD     = 'Dure de l''engagement'
  let $Str_Nbre_VD      = 'nbre de jours'
  let $Str_Du_VD        = 'du'
  let $Str_Au_VD        = 'au'
  let $Str_Trav_VD      = 'de travail'
  let $Str_Non_VD       = 'non'
  let $Str_Pay_VD       = 'pays'
  let $Str_Naiss_VD     = 'Date de naissance'
  let $Str_AVS_VD       = 'N AVS'
  let $Str_Nom_VD       = 'NOM'
  let $Str_Pren_VD      = 'PRNOM'
  let $Str_Adress_VD    = 'ADRESSE'
  let $Str_Line1_VD     = 'Le dbiteur soussign atteste que la personne sus-indique a reu'
  let $Str_Line2_VD     = 'au titre de salaires, gratifications, indemnits pour perte de gain et'
  let $Str_Line3_VD     = 'autres prestations de tous genres en espces et en nature les'
  let $Str_Line4_VD     = 'montants suivants sur lesquels l''impt  la source a t prlev:'
  let $Str_Salai_VD     = '1. Salaire'
  let $Str_Explic_VD    = 'Explications au verso'
  let $Str_Prest_VD     = 'PRESTATIONS SOUMISES  L''IMPT'
  let $Str_Code1_VD     = 'C'
  let $Str_Code2_VD     = 'o'
  let $Str_Code3_VD     = 'd'
  let $Str_Code4_VD     = 'e'
  let $Str_Enfant1_VD   = 'E'
  let $Str_Enfant2_VD   = 'n'
  let $Str_Enfant3_VD   = 'f'
  let $Str_Enfant4_VD   = 'a'
  let $Str_Enfant5_VD   = 'n'
  let $Str_Enfant6_VD   = 't'
  let $Str_Taux_VD      = 'TAUX'
  let $Str_Retenu_VD    = 'RETENUES'
  let $Str_Percent_VD   = '%'
  let $Str_Fr_VD        = 'Fr.'
  let $Str_Ct_VD        = 'ct.'
  let $Str_A_1_VD       = 'A'
  let $Str_A_2_VD       = 'salaire brut'
  let $Str_B_1_VD       = 'B'
  let $Str_B_2_VD       = 'autres'
  let $Str_C_1_VD       = 'C'
  let $Str_C_2_VD       = 'total'
  let $Str_Paie_VD      = 'PRIODE DE PAIE'
  let $Str_Total_VD     = 'Totaux'
  let $Str_Salai2_VD    = '2. Le salaire brut indiqu ci-dessus comprend entre autres'
  let $Str_a1_VD        = 'a) Allocation pour'
  let $Str_a2_VD        = 'enfants'
  let $Str_b1_VD        = 'b) Indemnits de'
  let $Str_b2_VD        = 'transport'
  let $Str_c1_VD        = 'c) Indemnits.'
  let $Str_c2_VD        = 'journal.'
  let $Str_c3_VD        = 'd''assurance.'
  let $Str_d_VD         = 'd) pourboires'
  let $Str_e1_VD        = 'e) prestations en'
  let $Str_e2_VD        = 'nature'
  let $Str_f1_VD        = 'f) cadeau pour'
  let $Str_f2_VD        = 'anciennet de'
  let $Str_f3_VD        = 'service'
  let $Str_g1_VD        = 'g) allocation de'
  let $Str_g2_VD        = 'mariage et'
  let $Str_g3_VD        = 'naissance'
  let $Str_h1_VD        = 'h) prestations de'
  let $Str_h2_VD        = 'l''assurance.'
  let $Str_h3_VD        = 'chmage'
  let $Str_Observ_VD    = 'Observations:'
  let $Str_Raison1_VD   = 'Nom ou raison sociale de'
  let $Str_Raison2_VD   = 'l''employeur'
  let $Str_Certif_VD    = 'Certifi exact'
  let $Str_Ordre_VD     = 'N d''ordre de l''employeur'
  let $Str_Lieu_VD      = '(Lieu et date)'
  let $Str_Signat_VD    = '(signature de l''employeur)'
  let $Str_Remarq_VD    = 'Remarque pour le contribuable'
  let $Str_Foot1_VD     = 'Le contribuable peut, jusqu'' fin mars de l''anne qui suit l''chance ' ||
                          'de la prestation, exiger une dcision  relative  l''existence et l''tendue'
  let $Str_Foot2_VD     = 'de l''assujettissement. Une telle demande doit tre adresse  l''autorit ' ||
                          'fiscale comptente du canton de son domicile.'
  let $SubTotalStr      = 'SOUS-TOTAL'

#Debug Show '<- Initial_Strings_VD '
end-procedure Initial_Strings_VD
!*******************************************************************************************
begin-procedure Print_Strings_VD
#Debug Show '-> Print_Strings_VD   '

   do format-number(#Amount1_VD_Sub,$Amount1_VD_Sub1,'99,999,999,999.99')
   do format-number(#Amount1_VD_Tot,$Amount1_VD_Tot1,'99,999,999,999.99')
   do format-number(#Amount2_VD_Sub,$Amount2_VD_Sub1,'99,999,999,999.99')
   do format-number(#Amount2_VD_Tot,$Amount2_VD_Tot1,'99,999,999,999.99')
   do format-number(#Amount9_VD_Sub,$Amount9_VD_Sub1,'99,999,999,999.99')
   do format-number(#Amount9_VD_Tot,$Amount9_VD_Tot1,'99,999,999,999.99')
   do format-number(#Amount1T_VD_Sub,$Amount1T_VD_Sub1,'99,999,999,999.99')
   do format-number(#Amount1T_VD_Tot,$Amount1T_VD_Tot1,'99,999,999,999.99')

   let $Amount1_VD_SubT = rtrim(translate($Amount1_VD_Sub1,',', '.'),' ')
   let $Amount1_VD_TotT = rtrim(translate($Amount1_VD_Tot1,',', '.'),' ')
   let $Amount2_VD_SubT = rtrim(translate($Amount2_VD_Sub1,',', '.'),' ')
   let $Amount2_VD_TotT = rtrim(translate($Amount2_VD_Tot1,',', '.'),' ')
   let $Amount9_VD_SubT = rtrim(translate($Amount9_VD_Sub1,',', '.'),' ')
   let $Amount9_VD_TotT = rtrim(translate($Amount9_VD_Tot1,',', '.'),' ')
   let $Amount1T_VD_SubT = rtrim(translate($Amount1T_VD_Sub1,',', '.'),' ')
   let $Amount1T_VD_TotT = rtrim(translate($Amount1T_VD_Tot1,',', '.'),' ')

   if ($Amount1_VD_SubT  <> $Amount1_VD_TotT  and #Amount1_VD_Sub  <> 0 ) or
      ($Amount2_VD_SubT  <> $Amount2_VD_TotT  and #Amount2_VD_Sub  <> 0 ) or
      ($Amount9_VD_SubT  <> $Amount9_VD_TotT  and #Amount9_VD_Sub  <> 0 ) or
      ($Amount1T_VD_SubT <> $Amount1T_VD_TotT and #Amount1T_VD_Sub <> 0 )

          do format-number(#Amount1_VD_Sub ,$Amount1_VD_Sub ,'9,999,999,999.99')
          do format-number(#Amount2_VD_Sub ,$Amount2_VD_Sub ,'9,999,999,999.99')
          do format-number(#Amount1T_VD_Sub,$Amount1T_VD_Sub,'9,999,999,999.99')
          let $Format = '9,999,999,999.99'
          do Get_Before_After_Comma(#Amount9_VD_Sub,$Format,$Amount9_1VD_Sub,$Amount9_2VD_Sub)

          alter-printer
          font= 5
          point-size = 7.2
          print $SubTotalStr        (+1,15) bold

          alter-printer
          font= 3
          point-size = 8
          print $Amount1_VD_Sub     (,51)   bold
          print $Amount2_VD_Sub     (,65)   bold
          print $Amount1T_VD_Sub    (,80)   bold
          print $Amount9_1VD_Sub    (,111)  bold
          print $Amount9_2VD_Sub    (,126)  bold

          let #Amount1_VD_Sub  = 0
          let #Amount2_VD_Sub  = 0
          let #Amount9_VD_Sub  = 0
          let #Amount1T_VD_Sub = 0

          alter-printer
          font= 1
          point-size = 7.2

   end-if
   !-----------------------------------------------
   let $VD_SegEndDt         = $VD_SegEnd
   let $Ctl_Curr_Pay_End_Dt = $Slice_End_DT_VD

   do Get_Signature($Emplid_VD,$Slice_End_DT_VD,$language_cd,$Signature_Type,$Cpdescr,$HD_FOR,
                    $Other_Py,$Signature1,$Signature2,$SI_PHONE,
                    $PAYENT_DESCR,$JobSuper_name,$JobPhone_num)

   do Get-Emp-Address($Empl_ID_VD,$Slice_End_DT_VD,'HOME', $ADDLINE1, $ADDLINE2, $ADDLINE3,$ADDLINE31,
                      $ADDLINE4,$ADDLINE5,$ADDLINE6,$Full_Name,$FirstName,$LastName,$NAME_PREFIX,$NAME_TITLE,
                      $NAME_ROYAL_PREFIX,$NAME_ROYAL_SUFFIX,$Phone,$Email_E,$City_E,$State_E,$Postal_E)

   !-----------------------------------------------
   do Format-DateTime($Birth_Date_VD,$Birth_Date_VD_1, {DEFDATE}, '', '')
   do Format-DateTime($VD_SegBgnDt  , $VD_SegBgnDt_1 , {DEFDATE}, '', '')
   do Format-DateTime($VD_SegEndDt  , $VD_SegEndDt_1 , {DEFDATE}, '', '')
   do Format-DateTime($Issued_Date  , $Issued_Date1  , {DEFDATE}, '', '')
   do format-number(#Amount21_VD    ,$Amount21_VD    ,'9,999.99')
   do format-number(#Amount1_VD_Tot ,$Amount1_VD_Tot ,'9,999,999,999.99')
   do format-number(#Amount2_VD_Tot ,$Amount2_VD_Tot ,'9,999,999,999.99')
   do format-number(#Amount1T_VD_Tot,$Amount1T_VD_Tot,'9,999,999,999.99')

   if $N_Id_VD <> ''
     let $N_Id_VD = edit($N_Id_VD,'XXX.XX.XXX.XXX')
   end-if


   if $NNSS_Id_VD <> ''
   
   let $NNSS_Id_VD = substr($NNSS_Id_VD,1,3)||'.'||
                       substr($NNSS_Id_VD,4,4)||'.'||
                       substr($NNSS_Id_VD,8,4)||'.'||
                       substr($NNSS_Id_VD,12,2)
   end-if
   
   
   
   let $Format = '9,999,999,999.99'
   do Get_Before_After_Comma(#Amount9_VD_Tot,$Format,$Amount9_VD1_Tot,$Amount9_VD2_Tot)

 !-----------------------------------------------
 alter-printer
 font= 5
 point-size =18

 print $Str_Tit_VD                     (2,35)   bold
 !-----------------------------------------------
 alter-printer
 font= 5
 point-size =14

 print $Str_Ann_VD                     (4,35)   bold
 print $Ctl_Year                       (,+8)    bold

 !-----------------------------------------------
 alter-printer
 font= 5
 point-size =13

 evaluate $PrType_vd
 when = '1'
   print $Str_Exemp_VD1                (4,73)
   break
 when = '2'
   print $Str_Exemp_VD2                (4,73)
   break
 when = '3'
   print $Str_Exemp_VD3                (4,73)
   break
 when-other
   break
 end-evaluate
 !-----------------------------------------------
 alter-printer
 font= 5
 point-size =9.5

 print $Str_Duree_VD                   (8,18)  bold
 print $Str_Nbre_VD                    (8,53)  bold
 print $Str_Naiss_VD                   (8,85)  bold
 print $Str_AVS_VD                     (8,113) bold
 print $Str_Du_VD                      (10,18) bold
 print $Str_Au_VD                      (10,36) bold
 print $Str_Trav_VD                    (10,50) bold
 print $Str_Non_VD                     (10,65) bold
 print $Str_Pay_VD                     (11,64) bold
 print $Str_Line1_VD                   (17,11)
 print $Str_Line2_VD                   (18,11)
 print $Str_Line3_VD                   (19,11)
 print $Str_Line4_VD                   (20,11)
 print $Str_Salai_VD                   (23,10)     bold
 print $Str_Explic_VD                  (23,55)     bold
 print $Str_Salai2_VD                  (60,10)     bold
 print $Str_Raison1_VD                 (68,103)
 print $Str_Raison2_VD                 (69,110)
 print $Str_Certif_VD                  (69,74)
 print $Str_Ordre_VD                   (73,103)
 print '.'                             (73,10,90)  fill
 print '.'                             (73,65,60)  fill
 print $Str_Lieu_VD                    (74,10)
 print $Str_Signat_VD                  (74,65)
 print $Str_Foot1_VD                   (76,10)
 print $Str_Foot2_VD                   (77,10)
 print $Str_Remarq_VD                  (75,10)     bold
 print $Str_Observ_VD                  (69,10)     bold
 !-----------------------------------------------
 alter-printer
 font= 5
 point-size =7.2

 graphic (7,105,4)             vert-line 10  !Vert. Linie 6
 graphic (7,48,8)              vert-line 10  !Vert. Linie 6
 graphic (7,81,4)              vert-line 10  !Vert. Linie 8
 graphic (7,129,4)             vert-line 10  !Vert. Linie

 graphic (8,81,48)             box 2 10
 graphic (8,{col1},62)         box 8 10      !Box Zeitraum
 graphic (9,{col1},62)         horz-line 10  !Horis. Linie
 graphic (9,29,6)              vert-line 10  !Vert. Linie
 graphic (9,61,6)              vert-line 10  !Vert. Linie
 graphic (12,{col1},62)        horz-line 10  !Horis. Linie

 graphic (24,{col1},119)       box 32 10     !Box Salaire 120
 graphic (23,55,35)            vert-line 10  !Vert. Linie
 graphic (25,69,33)            vert-line 10  !Vert. Linie
 graphic (25,83,33)            vert-line 10  !Vert. Linie
 graphic (23,98,35)            vert-line 10  !Vert. Linie
 graphic (23,101,35)           vert-line 10  !Vert. Linie
 graphic (23,104,35)           vert-line 10  !Vert. Linie
 graphic (23,111,35)           vert-line 10  !Vert. Linie
 graphic (25,126,33)           vert-line 10  !Vert. Linie
 graphic (25,55,43)            horz-line 10  !Horis. Linie 8
 graphic (25,104,25)           horz-line 10  !Horis. Linie 8
 graphic (29,{col1},119)       horz-line 10  !Horis. Linie 8
 graphic (58,55,74)            horz-line 10  !Horis. Linie 8
 graphic (55,129,3)            vert-line 10  !Vert. Linie
 graphic (61,{col1},119)       box 6 10      !Horis. Linie 8
 graphic (63,{col1},119)       horz-line 10  !Horis. Linie 8
 graphic (60,25,6)             vert-line 10  !Vert. Linie
 graphic (60,40,6)             vert-line 10  !Vert. Linie
 graphic (60,55,6)             vert-line 10  !Vert. Linie
 graphic (60,70,6)             vert-line 10  !Vert. Linie
 graphic (60,85,6)             vert-line 10  !Vert. Linie
 graphic (60,100,6)            vert-line 10  !Vert. Linie
 graphic (60,115,6)            vert-line 10  !Vert. Linie
 graphic (68,100,29)           box 8 10      !Horis. Linie 8
 graphic (72,100,29)           horz-line 10  !Horis. Linie 8
 !-----------------------------------------------
 alter-printer
 font = 5
 point-size =10

 print $Str_Nom_VD       (15,81)
 print ':'               (,95)
 print $Str_Pren_VD      (16,81)
 print ':'               (,95)
 print $Str_Adress_VD    (17,81)
 print ':'               (,95)
!-----------------------------------------------
 alter-printer
 font= 5
 point-size = 8
 print $Str_Total_VD            (57,47)  bold
 print $Str_a1_VD               (61,11)
 print $Str_b1_VD               (61,26)
 print $Str_c1_VD               (61,42)
 print $Str_d_VD                (61,56)
 print $Str_e1_VD               (61,71)
 print $Str_f1_VD               (61,86)
 print $Str_g1_VD               (61,101)
 print $Str_h1_VD               (61,116)
 print $Str_a2_VD               (62,15)
 print $Str_b2_VD               (62,28)
 print $Str_c2_VD               (62,44)
 print $Str_e2_VD               (62,74)
 print $Str_f2_VD               (62,86)
 print $Str_g2_VD               (62,103)
 print $Str_h2_VD               (62,118)
 print $Str_c3_VD               (63,43)
 print $Str_f3_VD               (63,89)
 print $Str_g3_VD               (63,103)
 print $Str_h3_VD               (63,119)
 !-----------------------------------------------
 alter-printer
 font= 5
 point-size = 7.5

 print $Str_Prest_VD            (24,60)  bold
 print $Str_Code1_VD            (24,99)  bold
 print $Str_Code2_VD            (25,99)  bold
 print $Str_Code3_VD            (26,99)  bold
 print $Str_Code4_VD            (27,99)  bold
 print $Str_Enfant1_VD          (24,102) bold
 print $Str_Enfant2_VD          (25,102) bold
 print $Str_Enfant3_VD          (26,102) bold
 print $Str_Enfant4_VD          (27,102) bold
 print $Str_Enfant5_VD          (28,102) bold
 print $Str_Enfant6_VD          (29,102) bold
 print $Str_Taux_VD             (24,105) bold
 print $Str_Retenu_VD           (24,115) bold
 print $Str_A_1_VD              (26,61)  bold
 print $Str_B_1_VD              (26,75)  bold
 print $Str_C_1_VD              (26,89)  bold
 print $Str_Paie_VD             (27,25)  bold
 print $Str_A_2_VD              (27,57)  bold
 print $Str_B_2_VD              (27,73)  bold
 print $Str_C_2_VD              (27,87)  bold
 print $Str_Fr_VD               (28,60)  bold
 print $Str_Fr_VD               (28,74)  bold
 print $Str_Fr_VD               (28,88)  bold
 print $Str_Percent_VD          (28,107) bold
 print $Str_Fr_VD               (28,116) bold
 print $Str_Ct_VD               (28,127) bold
 !-----------------------------------------------
 alter-printer
 font = 1
 point-size = 7.2

 print $Birth_Date_VD_1         (10,85)
 print $N_Id_VD                 (10,106)
 print $NNSS_Id_VD              (11,106)
 print $VD_SegBgnDt_1           (14,14)
 print $VD_SegEndDt_1           (14,33)
 print $Amount21_VD             (14,51)
 print $LastName                (15,97)
 print $FirstName               (+1,97)
 print $ADDLINE2                (+1,97)
 if $COUNTRY='DEU'
      print $ADDRESS4           (+1,97)
 end-if
 print $ADDLINE3                (+1,97)
 print $ADDLINE31               (+1,97)
 print $Employer_StaxNr_VD      (74,103)
 !print $PAYENTITY_DESCR_PayEnt  (56,102) wrap 27 4
 !print $CITY_PayEnt             (58,11)
 print $Rep_Descr               (70,102) wrap 27 4
 print $Rep_Addr3               (72,11)
 print $CITY1                   (,)
 print ', '                     (,)
 print $Issued_Date1            (,)
 print $JobSuper_name1           (,65)
 !-----------------------------------------------
 alter-printer
 font= 3
 point-size =8

 print $Amount1_VD_Tot          (57,51)    bold
 print $Amount2_VD_Tot          (57,65)    bold
 print $Amount1T_VD_Tot         (57,80)    bold
 print $Amount9_VD1_Tot         (57,111)   bold
 print $Amount9_VD2_Tot         (57,126)   bold
 !-----------------------------------------------
 let #Amount1_VD_Tot  = 0
 let #Amount2_VD_Tot  = 0
 let #Amount9_VD_Tot  = 0
 let #Amount1T_VD_Tot = 0
 let #Amount1_VD_Sub  = 0
 let #Amount2_VD_Sub  = 0
 let #Amount9_VD_Sub  = 0
 let #Amount1T_VD_Sub = 0
 let #Amount21_VD     = 0

 do Print_Attest_VD_Foot

 NEW-PAGE

#Debug Show '<- Print_Strings_VD   '
end-procedure
!*************************************************************************************
begin-procedure Get_Before_After_Comma(#Num_In,$Format,:$Num1_Out,:$Num2_Out)
#Debug Show '-> Get_Before_After_Comma '
do format-number(#Num_In,$Num_In,$Format)

let #Del_Loc  = instr($Num_In,$_SDecimal,1)
let $Num1_Out = substr($Num_In,1,-1 + #Del_Loc)
let $Num2_Out = substr($Num_In,1 + #Del_Loc,2)

#Debug Show '<- Get_Before_After_Comma '
end-procedure
!*******************************************************************************************
begin-procedure Get_Report_VD
#Debug Show '-> Get_Report_VD '

  let $PrType_vd = '1'
  do Print_Attest_VD
  let $PrType_vd = '2'
  do Print_Attest_VD
  let $PrType_vd = '3'
  do Print_Attest_VD

#Debug Show '<- Get_Report_VD '
end-procedure
!*******************************************************************************************
begin-procedure Print_Attest_VD
#Debug Show '-> Print_Attest_VD '

   let $EmplID = ''
   let $Ctl_Canton_Crit_VD           = ' AND VD.GPCH_TX_CANTON    = ''' || $Canton_Old || ''' '
   let $Ctl_Canton_Crit_VD_1         = ' AND VD_1.GPCH_TX_CANTON  = ''' || $Canton_Old || ''' '

   do Initial_Strings_VD

   let $FrstRow = 'Y'


   let $Old_Emplid = ' '

begin-select
VD.EMPLID
VD.CAL_RUN_ID
VD.EMPL_RCD
VD.GP_PAYGROUP
VD.CAL_ID
VD.SEG_BGN_DT
VD.SEG_END_DT
VD.RSLT_SEG_NUM
VD.SLICE_END_DT
VD.PAY_ENTITY
VD.COMPANY
VD.PRD_END_DT
VD.GPCH_AL_CPAY_ENDDT
VD.GPCH_TX_CANTON
VD.POSTAL
VD.GPCH_TX_VILLAGE_CD
VD.ACTION
VD.GPCH_TX_TRF_CD
VD.BEGIN_DT
VD.END_DT
VD.GPCH_RP_AMOUNT1
VD.GPCH_RP_AMOUNT2
VD.GPCH_RP_AMOUNT9
VD.GPCH_RP_AMOUNT11
VD.GPCH_RP_AMOUNT19
VD.GPCH_RP_AMOUNT21
VD.NATIONAL_ID
VD.GPCH_AH_NNSS
VD.HIRE_DT
VD.TERMINATION_DT
VD.BIRTHDATE

  if ($FrstRow = 'N') and ($Empl_ID_VD <> rtrim(&VD.EMPLID,' ') or #Empl_RCD_VD <> &VD.EMPL_RCD)

     do Print_Strings_VD

  end-if
   

  let $Emplid_VD                =  &VD.EMPLID
  let $Empl_ID_VD               =  rtrim(&VD.EMPLID,' ')
  let $Cal_RunID_VD             =  rtrim(&VD.CAL_RUN_ID,' ')
  let #Empl_RCD_VD              =  &VD.EMPL_RCD
  let $GP_Pay_Gr_VD             =  rtrim(&VD.GP_PAYGROUP,' ')
  let $Cal_ID_VD                =  rtrim(&VD.CAL_ID,' ')
  let #Rslt_Seg_Nr_VD           =  &VD.RSLT_SEG_NUM
  let $Slice_End_DT_VD          =  &VD.SLICE_END_DT
  let $Pay_Entity_VD            =  rtrim(&VD.PAY_ENTITY,' ')
  let $Company_VD               =  rtrim(&VD.COMPANY,' ')
  let $PRD_E_DT_VD              =  &VD.PRD_END_DT
  let $Cpay_E_DT_VD             =  &VD.GPCH_AL_CPAY_ENDDT
  let $Canton_VD                =  rtrim(&VD.GPCH_TX_CANTON,' ')
  let $Postal_Lok_VD            =  rtrim(&VD.POSTAL,' ')
  let $Village_CD_VD            =  rtrim(&VD.GPCH_TX_VILLAGE_CD,' ')
  let $Action_VD                =  rtrim(&VD.ACTION,' ')
  let $Tariff_CD_VD             =  rtrim(&VD.GPCH_TX_TRF_CD,' ')
  let $B_DT_VD                  =  &VD.BEGIN_DT
  let $E_DT_VD                  =  &VD.END_DT
  let #Staxb_PCT_VD             =  #Staxb_PCT
  let #Amount1_VD               =  &VD.GPCH_RP_AMOUNT1
  let #Amount2_VD               =  &VD.GPCH_RP_AMOUNT2
  let #Amount9_VD               =  &VD.GPCH_RP_AMOUNT9  + &VD.GPCH_RP_AMOUNT19
  let #Amount11_VD              =  &VD.GPCH_RP_AMOUNT11
  let #Amount19_VD              =  &VD.GPCH_RP_AMOUNT19
  let #Amount21_VD              =  #Amount21_VD + &VD.GPCH_RP_AMOUNT21
  let #Amount1T_VD              =  &VD.GPCH_RP_AMOUNT1 + &VD.GPCH_RP_AMOUNT2
  let $CantonFAK                = $Canton_VD

  let $N_Id_VD                  =  rtrim(ltrim(&VD.NATIONAL_ID,' '),' ')
  let $NNSS_Id_VD               =  rtrim(ltrim(&VD.GPCH_AH_NNSS,' '),' ')
  let #Amount1_VD_Tot           = #Amount1_VD_Tot  + &VD.GPCH_RP_AMOUNT1
  let #Amount2_VD_Tot           = #Amount2_VD_Tot  + &VD.GPCH_RP_AMOUNT2
  let #Amount9_VD_Tot           = #Amount9_VD_Tot + &VD.GPCH_RP_AMOUNT9 + &VD.GPCH_RP_AMOUNT19
  let #Amount1T_VD_Tot          = #Amount1T_VD_Tot  + &VD.GPCH_RP_AMOUNT1 + &VD.GPCH_RP_AMOUNT2

  let $SegBgn                   = &VD.SEG_BGN_DT
  let $SegEnd                   = &VD.SEG_END_DT
  let $VD_TERMINATION_DT        = &VD.TERMINATION_DT
  let $Birth_Date_VD            = &VD.BIRTHDATE
    
   
    do Format-DateTime(&VD.HIRE_DT        , $VD_HIRE_DT_Cmp        , {DEFCMP}, '', '')
    do Format-DateTime(&VD.TERMINATION_DT , $VD_TERMINATION_DT_Cmp , {DEFCMP}, '', '')
    do Format-DateTime(&VD.SEG_END_DT     , $VD_SegEnd_Cmp         , {DEFCMP}, '', '')

    if ($VD_TERMINATION_DT_Cmp <= $VD_SegEnd_Cmp) or ($VD_TERMINATION_DT_Cmp = '')
        let $VD_SegEnd = $VD_TERMINATION_DT
        if $VD_SegEnd = ''
           let $VD_SegEnd = &VD.SEG_END_DT
        end-if
    else
           let $VD_SegEnd = &VD.SEG_END_DT
    end-if

    do Format-DateTime($VD_SegEnd     , $VD_SegEnd1_Cmp         , {DEFCMP}, '', '')

    if $VD_SegEnd_Cmp <= $VD_SegEnd1_Cmp
       do Print_Data_VD
    end-if

    if $Old_Emplid <> $Empl_ID_VD
       let $VD_SegBgnDt = &VD.SEG_BGN_DT
    end-if

    let $EmplID     = $Empl_ID_VD
    let $Old_Emplid = $Empl_ID_VD
    let $FrstRow    = 'N'


FROM  PS_GPCHTX011_VW VD
WHERE VD.PROCESS_INSTANCE = #prcs_process_instance
AND   VD.GPCH_TX_CANTON   = 'VD'
ORDER BY VD.EMPLID,VD.EMPL_RCD,VD.PRD_END_DT,VD.SLICE_END_DT
end-select

   if ($FrstRow = 'N')
      do Print_Strings_VD
   end-if

   alter-printer
   font = 1
   point-size = 7.2

#Debug Show '<- Print_Attest_VD '
end-procedure

!*******************************************************************************************
begin-procedure Print_Data_VD    !Printing the Body Of the Report
#Debug Show '-> Print_Data_VD '

   alter-printer
   font = 1
   point-size = 7.2

   do Get_End_Mnth($Slice_End_DT_VD,$Slice_End)
   do Get_Beg_Mnth($Slice_End_DT_VD,$Slice_Beg)

   do Format-DateTime($Slice_Beg, $Slice_Beg_1, {DEFDATE}, '', '')
   do Format-DateTime($SegEnd   , $SegEnd_1   , {DEFDATE}, '', '')

   do format-number(#Amount1_VD ,$Amount1_VD ,'9,999,999,999.99')
   do format-number(#Amount2_VD ,$Amount2_VD ,'9,999,999,999.99')
   do format-number(#Amount11_VD,$Amount11_VD,'99,999.99')
   do format-number(#Amount1T_VD,$Amount1T_VD,'9,999,999,999.99')

   let $Code_Ins     = substr($Tariff_CD_VD,1,1)
   let $Child_Co     = substr($Tariff_CD_VD,2,1)
   let $Code_InsCmp  = substr($Tariff_CD_VD,1,2)

   if $EmplID <> $Empl_ID_VD
      let $Min_Begin_date = $Slice_Beg_1
      position (29,1)
        if       (#Amount1_VD = 0)
             and (#Amount2_VD = 0)
             and (#Amount11_VD = 0)
             and (#Amount1T_VD = 0)
             goto END_Print_Data_VD
        end-if

      let #Amount1_VD_Sub  = #Amount1_VD
      let #Amount2_VD_Sub  = #Amount2_VD
      let #Amount9_VD_Sub  = #Amount9_VD
      let #Amount1T_VD_Sub = #Amount1_VD + #Amount2_VD

   else

      if $Code_Ins_Old <> $Code_InsCmp

         do format-number(#Amount1_VD_Sub ,$Amount1_VD_Sub ,'9,999,999,999.99')
         do format-number(#Amount2_VD_Sub ,$Amount2_VD_Sub ,'9,999,999,999.99')
         do format-number(#Amount1T_VD_Sub,$Amount1T_VD_Sub,'9,999,999,999.99')

         let $Format = '9,999,999,999.99'
         do Get_Before_After_Comma(#Amount9_VD_Sub,$Format,$Amount9_1VD_Sub,$Amount9_2VD_Sub)

         alter-printer
         font= 5
         point-size = 7.2
         print $SubTotalStr (+1,15)        bold

         alter-printer
         point-size =8
         font= 3
         print $Amount1_VD_Sub     (,51)   bold
         print $Amount2_VD_Sub     (,65)   bold
         print $Amount1T_VD_Sub     (,80)   bold
         print $Amount9_1VD_Sub    (,111)  bold
         print $Amount9_2VD_Sub    (,126)  bold

         let #Amount1_VD_Sub  = #Amount1_VD
         let #Amount2_VD_Sub  = #Amount2_VD
         let #Amount9_VD_Sub  = #Amount9_VD
         let #Amount1T_VD_Sub = #Amount1_VD + #Amount2_VD

         alter-printer
         font= 1
         point-size = 7.2
         position (+1,1)

      else

         let #Amount1_VD_Sub  = #Amount1_VD_Sub  + #Amount1_VD
         let #Amount2_VD_Sub  = #Amount2_VD_Sub  + #Amount2_VD
         let #Amount9_VD_Sub  = #Amount9_VD_Sub  + #Amount9_VD
         let #Amount1T_VD_Sub = #Amount1T_VD_Sub + #Amount1_VD + #Amount2_VD

      end-if

   end-if

   print $Slice_Beg_1    (+1,15)
   print ' - '           (,)
   print $SegEnd_1       (,)


   print $Code_Ins       (,99)
   print $Child_Co       (,102)

   alter-printer
   point-size =8
   font= 3

   print $Amount1_VD     (,51)
   print $Amount2_VD     (,65)
   print $Amount1T_VD    (,80)
   !print $Amount11_VD    (,100)

   let $Format = '9,999,999,999.99'
   do Get_Before_After_Comma(#Amount9_VD,$Format,$Amount9_1VD,$Amount9_2VD)
   print $Amount9_1VD    (,111)
   print $Amount9_2VD    (,126)

   let $Code_Ins_Old = $Code_InsCmp

   alter-printer
   point-size =7.2
   font= 1

 END_Print_Data_VD:
#Debug Show '<- Print_Data_VD '
end-procedure

!*******************************************************************************************
begin-procedure Print_Attest_VD_Foot
#Debug Show '-> Print_Attest_VD_Foot '

let #Amount11_VD_1              =  0
let #Amount12_VD_1              =  0
let #Amount13_VD_1              =  0
let #Amount14_VD_1              =  0
let #Amount15_VD_1              =  0
let #Amount16_VD_1              =  0
let #Amount17_VD_1              =  0
let #Amount18_VD_1              =  0
let $ItIsExistData              = 'N'

begin-select
VD_1.GPCH_RP_AMOUNT11
VD_1.GPCH_RP_AMOUNT12
VD_1.GPCH_RP_AMOUNT13
VD_1.GPCH_RP_AMOUNT14
VD_1.GPCH_RP_AMOUNT15
VD_1.GPCH_RP_AMOUNT16
VD_1.GPCH_RP_AMOUNT17
VD_1.GPCH_RP_AMOUNT18

  let #Amount11_VD_1              =  #Amount11_VD_1 + &VD_1.GPCH_RP_AMOUNT11
  let #Amount12_VD_1              =  #Amount12_VD_1 + &VD_1.GPCH_RP_AMOUNT12
  let #Amount13_VD_1              =  #Amount13_VD_1 + &VD_1.GPCH_RP_AMOUNT13
  let #Amount14_VD_1              =  #Amount14_VD_1 + &VD_1.GPCH_RP_AMOUNT14
  let #Amount15_VD_1              =  #Amount15_VD_1 + &VD_1.GPCH_RP_AMOUNT15
  let #Amount16_VD_1              =  #Amount16_VD_1 + &VD_1.GPCH_RP_AMOUNT16
  let #Amount17_VD_1              =  #Amount17_VD_1 + &VD_1.GPCH_RP_AMOUNT17
  let #Amount18_VD_1              =  #Amount18_VD_1 + &VD_1.GPCH_RP_AMOUNT18
  let $ItIsExistData                      = 'Y'

FROM  PS_GPCH_RP_TX01 VD_1
WHERE VD_1.EMPLID       = $Empl_ID_VD
AND   VD_1.EMPL_RCD     = #Empl_RCD_VD
AND   VD_1.PAY_ENTITY   = $Ctl_PayEntity
AND   VD_1.PRD_END_DT   = $Slice_End_DT_VD
AND   VD_1.RSLT_SEG_NUM = #Rslt_Seg_Nr_VD
AND   VD_1.CAL_RUN_ID   = $Cal_RunID_VD
AND   VD_1.CAL_ID       = $Cal_ID_VD

end-select


   alter-printer
   font= 3
   point-size = 8

   do format-number(#Amount11_VD_1,$Amount11_VD_1,'9,999,999.99')
   do format-number(#Amount12_VD_1,$Amount12_VD_1,'9,999,999.99')
   do format-number(#Amount13_VD_1,$Amount13_VD_1,'9,999,999.99')
   do format-number(#Amount14_VD_1,$Amount14_VD_1,'9,999,999.99')
   do format-number(#Amount15_VD_1,$Amount15_VD_1,'9,999,999.99')
   do format-number(#Amount16_VD_1,$Amount16_VD_1,'9,999,999.99')
   do format-number(#Amount17_VD_1,$Amount17_VD_1,'9,999,999.99')
   do format-number(#Amount18_VD_1,$Amount18_VD_1,'9,999,999.99')


   if $ItIsExistData = 'Y'

      print $Amount11_VD_1  (65,11)      !51
      print $Amount12_VD_1  (65,26)
      print $Amount13_VD_1  (65,41)
      print $Amount14_VD_1  (65,56)
      print $Amount15_VD_1  (65,71)
      print $Amount16_VD_1  (65,86)
      print $Amount17_VD_1  (65,101)
      print $Amount18_VD_1  (65,115)

   end-if

     alter-printer
     font= 1
     point-size = 7.2


#Debug Show '<- Print_Attest_VD_Foot '
end-procedure
!*************************************************************************************
!      FRENCH BORDER CROSSER REPORT   Report A            !
!*************************************************************************************!
Begin-procedure BorderCrosserFrance_Report
#Debug Show '-> BorderCrosserFrance_Report  '

   alter-printer
   point-size = 9

   let $ExistdataBC = 'N'
   let $New_Canton  = 'N'


   if $Ctl_Village_CD <> ''
      let $Ctl_Village_Crit_BCR           = ' AND BCR.GPCH_TX_VILLAGE_CD  = ''' || $Ctl_Village_CD || ''' '
   else
      let $Ctl_Village_Crit_BCR           = ' '
   end-if

   let #Amount1_BCR_Line = 0
   let #Amount1_BCR_Page = 0
   let #Amount1_BCR_Cant = 0
   let #Amount1_BCR_Vill = 0

begin-select
BCR.CAL_RUN_ID
BCR.GP_PAYGROUP
BCR.CAL_ID
BCR.RSLT_SEG_NUM
BCR.SLICE_END_DT
BCR.PAY_ENTITY
BCR.COMPANY
BCR.PRD_END_DT
BCR.GPCH_AL_CPAY_ENDDT
BCR.GPCH_TX_VILLAGE_CD       () on-break  level = 1 print=never  PROCEDURE=NEW_PAGE
BCR.GPCH_TX_CANTON           () on-break  level = 1 print=never  PROCEDURE=Print_New_Page_BCR
BCR.EMPLID                   () on-break  level = 2 print=never  AFTER=Print_New_Line_BCR
BCR.EMPL_RCD                 () on-break  level = 2 print=never  AFTER=Print_New_Line_BCR
BCR.CITY                     () on-break  level = 2 print=never  AFTER=Print_New_Line_BCR
BCR.POSTAL
BCR.ACTION
BCR.GPCH_TX_TRF_CD
BCR.BEGIN_DT
BCR.END_DT
BCR.GPCH_RP_AMOUNT1
BCR.NATIONAL_ID
BCR.BIRTHDATE
BCR.NAME
BCR.SEG_BGN_DT
BCR.SEG_END_DT

  if $ExistdataBC <> 'Y' or rtrim($EmplID,' ') <> rtrim(&BCR.EMPLID,' ')
     let $Beg-Month = &BCR.SEG_BGN_DT
  end-if

  let $End-Month   = &BCR.SEG_END_DT
  let $ExistChange = 'N'

  if $ExistdataBC = 'Y' and rtrim($EmplID,' ') = rtrim(&BCR.EMPLID,' ')
     do GetDate_PlusDays($SegEndDt,1,$SegEndDtPlus1)
     do Format-DateTime($SegEndDtPlus1,$SegEndDtPlus1Cmp,{DEFCMP},'','')
     do Format-DateTime(&BCR.SEG_BGN_DT,$SegBgnDtCmp,{DEFCMP},'','')
     if $SegEndDtPlus1Cmp <> $SegBgnDtCmp
        do Check_For_Vill_Changes
        if $ExistChange = 'Y'
           let $End-Month = $SegEndDt
           do Print_New_Line_BCR
        end-if
     end-if
  end-if

  let $Empl_ID_BCR               =  rtrim(&BCR.EMPLID,' ')
  let $Cal_RunID_BCR             =  rtrim(&BCR.CAL_RUN_ID,' ')
  let #Empl_RCD_BCR              =  &BCR.EMPL_RCD
  let $GP_Pay_Gr_BCR             =  rtrim(&BCR.GP_PAYGROUP,' ')
  let $Cal_ID_BCR                =  rtrim(&BCR.CAL_ID,' ')
  let #Rslt_Seg_Nr_BCR           =  &BCR.RSLT_SEG_NUM
  let $Slice_End_DT_BCR          =  &BCR.SLICE_END_DT
  let $Pay_Entity_BCR            =  rtrim(&BCR.PAY_ENTITY,' ')
  let $Company_BCR               =  rtrim(&BCR.COMPANY,' ')
  let $PRD_E_DT_BCR              =  &BCR.PRD_END_DT
  let $Cpay_E_DT_BCR             =  &BCR.GPCH_AL_CPAY_ENDDT
  let $Canton_BCR                =  rtrim(&BCR.GPCH_TX_CANTON,' ')
  let $Postal_BCR                =  rtrim(&BCR.POSTAL,' ')
  let $Village_CD_BCR            =  rtrim(&BCR.GPCH_TX_VILLAGE_CD,' ')
  let $Action_BCR                =  rtrim(&BCR.ACTION,' ')
  let $Tariff_CD_BCR             =  rtrim(&BCR.GPCH_TX_TRF_CD,' ')
  let $B_DT_BCR                  =  &BCR.BEGIN_DT
  let $E_DT_BCR                  =  &BCR.END_DT
  let #Amount1_BCR               =  &BCR.GPCH_RP_AMOUNT1
  let $E_Name_BCR                =  rtrim(ltrim(&BCR.NAME,' '),' ')
  let $City_BCR                  =  rtrim(&BCR.CITY, ' ')
  let $SegBgnDt                  =  &BCR.SEG_BGN_DT
  let $SegEndDt                  =  &BCR.SEG_END_DT
  let $BirthDate_BCR             =  &BCR.BIRTHDATE

  let $CantonFAK = $Canton_BCR

  do Get_Fak_Tax_Data($Canton_BCR,$Ctl_PayEntity,$Ctl_End_Dt,
                      $Fak_Language,$Employer_Fak_Nbr,#Employer_Fak_Pct,
                      $Tax_Language,$Employer_StaxNr,#Staxb_PCTR,
                      #Employer_SI_Pct,$SI_AHV_MBR_ID,$SI_AHV_PROVCD,
                      $SI_KTG_MBR_ID,#SI_AHV_ADM_PC,#SI_TOT_AHV_PC,
                      #SI_TOT_ALV1PC,#SI_TOT_ALV2PC)


   if $language_cd = ''
      do Get-Language($ReportID, $Tax_Language)
   end-if


  let #Staxb_PCT         =  #Staxb_PCTR
  let #Staxb_PCT_BCR     =  #Staxb_PCTR

  let $N_Id_BCR          =  rtrim(ltrim(&BCR.NATIONAL_ID,' '),' ')
  let #Amount1_BCR_Line  = #Amount1_BCR_Line + &BCR.GPCH_RP_AMOUNT1
  let #Amount1_BCR_Page  = #Amount1_BCR_Page + &BCR.GPCH_RP_AMOUNT1
  let #Amount1_BCR_Cant  = #Amount1_BCR_Cant + &BCR.GPCH_RP_AMOUNT1
  let #Amount1_BCR_Vill  = #Amount1_BCR_Vill + &BCR.GPCH_RP_AMOUNT1
  let $Canton            = $Canton_BCR
  let $Village_CD        = $Village_CD_BCR

  do Get_Village_Name
  do Get_Canton_Name
  do Get_Company_Name  ! fill language array with correct company name
  let $EmplID      = $Empl_ID_BCR
  let $ExistdataBC = 'Y'

FROM  PS_GPCHTX011_VW BCR
WHERE BCR.PROCESS_INSTANCE = #prcs_process_instance
AND   BCR.COUNTRY_FROM     = 'FRA'
AND   BCR.GPCH_TX_CANTON in ('BE','BL','BS','JU','NE','SO','VD','VS' )
[$Ctl_Village_Crit_BCR]
ORDER BY BCR.GPCH_TX_CANTON,BCR.GPCH_TX_VILLAGE_CD,BCR.CITY,BCR.NATIONAL_ID,
      BCR.BIRTHDATE,BCR.EMPLID,BCR.EMPL_RCD ,BCR.PRD_END_DT,BCR.GPCH_AL_CPAY_ENDDT
End-select

   if $ExistdataBC = 'Y'
      do Print_New_Line_BCR
      let $New_Canton  = 'Y'
      let $New_Village = 'Y'
   end-if

#Debug Show '<- BorderCrosserFrance_Report  '
end-procedure
!*************************************************************************************
begin-procedure new_page
#Debug Show '-> new_page '

  let $New_Village = 'Y'
  if &BCR.GPCH_TX_CANTON = $Canton_BCR and $Village_CD_BCR   =  &BCR.GPCH_TX_VILLAGE_CD
        do Print_New_Line_BCR
  end-if

  if &BCR.GPCH_TX_CANTON <> $Canton_BCR and $Canton_BCR <> ''
        do Print_New_Line_BCR
        do Print_New_Page_BCR
  else
        do Print_New_Line_BCR
        new-page
  end-if

  let $New_Village      = 'N'
  let #Amount1_BCR_Vill = 0

#Debug Show '<- new_page '
end-procedure
!*************************************************************************************
begin-procedure Check_For_Vill_Changes
#Debug Show '-> Check_For_Vill_Changes  '

Begin-select
#ifdef ORACLE
/*+ INDEX(CHK PS_GPCH_RP_0001)*/
#endif
CHK.GPCH_TX_VILLAGE_CD
CHK.PRD_END_DT
CHK.GPCH_AL_CPAY_ENDDT
    if rtrim(&CHK.GPCH_TX_VILLAGE_CD,' ') = rtrim(&BCR.GPCH_TX_VILLAGE_CD,' ')
       let $ExistChange = 'Y'
       EXIT-SELECT
    end-if
FROM PS_GPCH_RP_0001 CHK
WHERE CHK.EMPLID       = &BCR.EMPLID
AND   CHK.PAY_ENTITY   = &BCR.PAY_ENTITY
AND   CHK.SEG_END_DT   > $SegEndDt
ORDER BY CHK.PRD_END_DT,CHK.GPCH_AL_CPAY_ENDDT
End-select

#Debug Show '<- Check_For_Vill_Changes  '
end-procedure Check_For_Vill_Changes
!*************************************************************************************
begin-procedure Print_New_Page_BCR
#Debug Show '-> Print_New_Page_BCR   '

  let $New_Canton = 'Y'
  new-page

  let #Amount1_BCR_Page = 0
  let #Amount1_BCR_Line = 0
  let #Amount1_BCR_Cant = 0
  let #Amount1_BCR_Vill = 0

#Debug Show '<- Print_New_Page_BCR   '
end-procedure
!*************************************************************************************
begin-procedure GetDate_PlusDays($Date1,#Days,:$Date2)
    do ConvertToComponents($Date1,$tmp_y,$tmp_m,$tmp_d)
    let $Stch = $tmp_y  || $tmp_m ||  $tmp_d || '0000'
    do Format-DateTime($Stch, $End_DT_1, {DEFCMP},'','native')

    let $date_in =  $tmp_y  || '-' || $tmp_m || '-' ||  $tmp_d
    do dtu-add-days($date_in, #Days, $End_DT_1)

    let $YY = substr($End_DT_1,1,4)
    let $MM = substr($End_DT_1,6,2)
    let $DD = substr($End_DT_1,9,2)
    let $Stch = $YY  || $MM ||  $DD || '0000'

    do Format-DateTime($Stch, $Date2, {DEFCMP},'','native')
end-procedure
!*********************************************************************************************
begin-procedure Get_Min_Max_Date
#Debug Show '-> Get_Min_Max_Date  '

   let $Begin_Mth_Date = ''
   let $End_Mth_Date   = ''

Begin-select DISTINCT
#ifdef ORACLE
/*+ INDEX(SI07B PS_GPCH_RP_0001)*/
#endif
SI07B.PRD_END_DT
   let $Begin_Mth_Date = rtrim(&SI07B.PRD_END_DT, ' ')
from PS_GPCH_RP_0001 SI07B
WHERE SI07B.EMPLID             = $Empl_ID_BCR
AND   SI07B.EMPL_RCD           = #Empl_RCD_BCR
AND   SI07B.PAY_ENTITY         = $Pay_Entity_BCR
AND   SI07B.COUNTRY_FROM       = 'FRA'
AND   SI07B.GPCH_TX_EXEMPT_TAX = 'Y'
AND   SI07B.GPCH_TX_VILLAGE_CD = $Village_CD_BCR
AND   SI07B.CITY               =  $City_BCR
#ifdef ORACLE
AND   SI07B.PRD_END_DT         = (SELECT /*+ INDEX(SI07C PS_GPCH_RP_0001)*/ MIN(SI07C.PRD_END_DT) FROM PS_GPCH_RP_0001 SI07C
#else
AND   SI07B.PRD_END_DT         = (SELECT MIN(SI07C.PRD_END_DT) FROM PS_GPCH_RP_0001 SI07C
#endif
                                  WHERE  SI07C.EMPLID             = SI07B.EMPLID
                                  AND    SI07C.EMPL_RCD           = SI07B.EMPL_RCD
                                  AND    SI07C.PAY_ENTITY         = SI07B.PAY_ENTITY
                                  AND    SI07C.COUNTRY_FROM       = SI07B.COUNTRY_FROM
                                  AND    SI07C.GPCH_TX_VILLAGE_CD = SI07B.GPCH_TX_VILLAGE_CD
                                  AND    SI07C.CITY               =  SI07B.CITY)
End-select

Begin-select DISTINCT
#ifdef ORACLE
/*+ INDEX(SI07B1 PS_GPCH_RP_0001)*/
#endif
SI07B1.PRD_END_DT
   let $End_Mth_Date = rtrim(&SI07B1.PRD_END_DT, ' ')
from PS_GPCH_RP_0001 SI07B1
WHERE SI07B1.EMPLID             = $Empl_ID_BCR
AND   SI07B1.EMPL_RCD           = #Empl_RCD_BCR
AND   SI07B1.PAY_ENTITY         = $Pay_Entity_BCR
AND   SI07B1.COUNTRY_FROM       = 'FRA'
AND   SI07B1.GPCH_TX_EXEMPT_TAX = 'Y'
AND   SI07B1.GPCH_TX_VILLAGE_CD = $Village_CD_BCR
AND   SI07B1.CITY               =  $City_BCR
#ifdef ORACLE
AND   SI07B1.PRD_END_DT         = (SELECT /*+ INDEX(SI07C1 PS_GPCH_RP_0001)*/ MAX(SI07C1.PRD_END_DT) FROM PS_GPCH_RP_0001 SI07C1
#else
AND   SI07B1.PRD_END_DT         = (SELECT MAX(SI07C1.PRD_END_DT) FROM PS_GPCH_RP_0001 SI07C1
#endif
                                   WHERE SI07C1.EMPLID             = SI07B1.EMPLID
                                   AND   SI07C1.EMPL_RCD           = SI07B1.EMPL_RCD
                                   AND   SI07C1.PAY_ENTITY         = SI07B1.PAY_ENTITY
                                   AND   SI07C1.COUNTRY_FROM       = SI07B1.COUNTRY_FROM
                                   AND   SI07C1.GPCH_TX_VILLAGE_CD = SI07B1.GPCH_TX_VILLAGE_CD
                                   AND   SI07C1.CITY               =  SI07B1.CITY)
End-select

#Debug Show '<- Get_Min_Max_Date  '
end-procedure Get_Min_Max_Date
!*************************************************************************************
begin-procedure Print_New_Line_BCR
#Debug Show '-> Print_New_Line_BCR   '

  let $Begin_Mth_Date  = $Beg-Month

  if $Begin_Mth_Date   = $Beg-Month    and
     $End_Mth_Date     = $End-Month    and !$Month_Old = $Month and
     $E_Name_BCR_Old   = $E_Name_BCR   and
     $Postal_BCR_Old   = $Postal_BCR   and
     $City_BCR_Old     = $City_BCR     and
     $Village_Name_Old = $Village_Name and
     #Amount1_BCR_Line = 0
     goto NoPrt
  end-if

  let $date_flg     = 'N'
  let $End_Mth_Date = $End-Month

  do ConvertToComponents($Begin_Mth_Date,$yy1B,$mm1B,$dd1B)
  do ConvertToComponents($End_Mth_Date  ,$yy1E,$mm1E,$dd1E)
  do Format-DateTime($BirthDate_BCR, $BirthDate_BCR1, {DEFDATE}, '', '')

  do Format-Number(#Amount1_BCR_Line,$Amount1_BCR_Line_1,'999,999,999,999.99')
  do Format-Number(#Empl_RCD_BCR,$EmplRcd,'888')
  let $EmplID_Rcd = $E_Name_BCR

  #ifdef Vertragsnummer
     || '-' || $EmplRcd
  #endif

  let $Month = $mm1B || ' / ' || $mm1E



  print $Month              (+2,{colA1})
  print $EmplID_Rcd         (,22,35)
  if $Canton_BCR = 'VD'
     print $BirthDate_BCR1  (,68)
  end-if
  print $Postal_BCR         (,84)
  print $City_BCR           (,110)
  print $Village_Name       (,140)
  print $Amount1_BCR_Line_1 (,160)


  let #Amount1_BCR_Line = 0
  let $Begin_Mth        = ' '
  let $Month_Old        = $Month
  let $E_Name_BCR_Old   = $E_Name_BCR
  let $Postal_BCR_Old   = $Postal_BCR
  let $City_BCR_Old     = $City_BCR
  let $Village_Name_Old = $Village_Name

  NoPrt:
  let $Beg-Month = &BCR.SEG_BGN_DT

#Debug Show '<- Print_New_Line_BCR   '
end-procedure
!************************************************************************************
!      Fribourg REPORT  : Report D            !
!*************************************************************************************!
begin-procedure Get_Report_FR
#Debug Show '-> Get_Report_FR '

   do Get-Language($ReportID, $Base_Language)
   let $EmplID      = ''
   let $IntEmplid   = ' '
   let $First_Row   = 'Y'
   let $Fr_Hire_Flg = 'N'  ! In case of a rehire to get the first hire dt of the month.

   do Print_Template_FR
   let #Row_Cnt = 41

begin-select
FR.EMPLID
FR.CAL_RUN_ID
FR.EMPL_RCD
FR.GP_PAYGROUP
FR.CAL_ID
FR.SEG_BGN_DT
FR.SEG_END_DT
FR.RSLT_SEG_NUM
FR.SLICE_END_DT
FR.PAY_ENTITY
FR.COMPANY
FR.PRD_END_DT
FR.GPCH_AL_CPAY_ENDDT
FR.CITY
FR.MAR_STATUS
FR.BIRTHDATE
FR.GPCH_TX_TRF_CD
FR.GPCH_RP_AMOUNT1
FR.GPCH_RP_AMOUNT2
FR.GPCH_RP_AMOUNT9
FR.GPCH_RP_AMOUNT14
FR.GPCH_RP_AMOUNT19
FR.GPCH_RP_AMOUNT20
FR.GPCH_RP_AMOUNT21
FR.GPCH_RP_AMOUNT22
FR.NATIONAL_ID
FR.GPCH_AH_NNSS
FR.GPCH_TX_CHRCH
FR.SEX
FR.HIRE_DT
FR.TERMINATION_DT

  let $Emplid_FR                =  &FR.EMPLID
  let $Empl_ID_FR               =  rtrim(&FR.EMPLID,' ')
  let #Empl_RCD_FR              =  &FR.EMPL_RCD

  !-------------------------------------------------------------------------------------------
  if  ($Empl_ID_FR <> $IntEmplid) AND ($First_Row = 'N')!To Execute these procedures once for each employee

      alter-printer
      font = 32
      point-size = 7.9

      do Format-DateTime($FR_SegBgn  , $FR_SegBgn    , {DEFDATE}, '', '')
      do Format-DateTime($FR_SegEnd  , $FR_SegEnd    , {DEFDATE}, '', '')
      do Format-DateTime($Issued_Date, $Issued_Date1 , {DEFDATE}, '', '')

      if $IntEmplid <> ' '
         print $FR_SegEnd          (25,108)
         print $flag_1             (24,2)
         print $flag_2             (25,2)
         print $flag_3             (26,2)
         print $flag_4             (27,2)
         print $Amount21_FR        (27,110)
         print $Amount22_FR        (67,115)
         print $Tot_Amt_Col1       (65,85)
         print $Tot_Amt_Col2       (65,110)
      end-if

      let #Amount21_FR              = 0  !&FR.GPCH_RP_AMOUNT21
      let #Amount22_FR              = 0  !&FR.GPCH_RP_AMOUNT22
      let #Tot_Amt_Col1             = 0
      let #Tot_Amt_Col2             = 0


      do Get_Signature($Emplid_FR,$Ctl_End_Dt,$language_cd,$Signature_Type,$Cpdescr,$HD_FOR,
                       $Other_Py,$Signature1,$Signature2,$SI_PHONE,
                       $PAYENT_DESCR,$JobSuper_name,$JobPhone_num)

      do Get-Emp-Address($IntEmplid,$Ctl_End_Dt,'HOME',$ADDLINE1,$ADDLINE2,$ADDLINE3,$ADDLINE31,
                      $ADDLINE4,$ADDLINE5,$ADDLINE6,$Full_Name,$FirstName,$LastName,$NAME_PREFIX,
                      $NAME_TITLE,$NAME_ROYAL_PREFIX,$NAME_ROYAL_SUFFIX,$Phone,$Email,$CITY,$STATE,$POSTAL)


      print $FR_SegBgn                (23,108)
      print $Employer_StaxNr_FR       (9,15)
      print $N_Id_FR                  (9,63)
      print $NNSS_Id_FR               (10,63)
      print $Ctl_Year                 (9,110)

      print $FR_birth_date            (14,107)
      print $Issued_Date1             (71,8)
      print $JobSuper_name1            (71,97)
      print 'X'                       (24,36)

      print $Rep_Descr                (13,2)
      print $Rep_Addr1                (14,2)
      if $Rep_Addr3 <> ''
      let $Rep_Addr2 = LTRIM(RTRIM($Rep_Addr2||' '||$Rep_Addr3,' '),' ')
      end-if
      print $Rep_Addr2                (15,2)
      print $Rep_Postal               (16,2)

      print $NAME_PREFIX_FR           (13,50)
      print $Full_Name                (14,50)
      print $ADDLINE2                 (15,50)
      print $ADDLINE3                 (16,50)
      print $ADDLINE31                (17,50)
      print $ADDLINE4                 (18,50)
      print $ADDLINE5                 (19,50)

      if $IntEmplid <> ' '
              new-page
      end-if

      do Print_Template_FR
      let #Row_Cnt = 41
      let $Fr_Hire_Flg = 'N'
      let $FR_SegBgn_F =  &FR.SEG_BGN_DT  ! To get first row of the employee as the begin date

  end-if
 !-------------------------------------------------------------------------------------

  let $N_Id_FR                  = rtrim(ltrim(&FR.NATIONAL_ID,' '),' ')
  let $NNSS_Id_FR               = rtrim(ltrim(&FR.GPCH_AH_NNSS,' '),' ')
  let $N_Id_FR                  = edit($N_Id_FR,'XXX.XX.XXX.XXX')
  let $NNSS_Id_FR               = substr($NNSS_Id_FR,1,3)||'.'||
                                        substr($NNSS_Id_FR,4,4)||'.'||
                                        substr($NNSS_Id_FR,8,4)||'.'||
                                        substr($NNSS_Id_FR,12,2)
  
  let $Tariff_CD_FR             = rtrim(&FR.GPCH_TX_TRF_CD,' ')
  let $Tariff_CD_FR_FLG         = substr($Tariff_CD_FR,1,1)
  let $FR_MAR_STATUS            = rtrim(&FR.MAR_STATUS,' ')
  let $FR_CITY                  = rtrim(&FR.CITY,' ')
  let $GPCH_TX_CHRCH            = rtrim(&FR.GPCH_TX_CHRCH,' ')
  let $Sex_FR                   = rtrim(&FR.SEX,' ')

  let $FR_HIRE_DT               = &FR.HIRE_DT
  let $FR_TERMINATION_DT        = &FR.TERMINATION_DT
  !let $FR_SegBgn                = &FR.SEG_BGN_DT
  !let $FR_SegEnd                = &FR.SEG_END_DT

      if $First_Row = 'Y'   ! To get first row of the employee as the begin date
         let $FR_SegBgn_F =  &FR.SEG_BGN_DT
      end-if

      do Format-DateTime(&FR.HIRE_DT        , $FR_HIRE_DT_Cmp        , {DEFCMP}, '', '')
      do Format-DateTime(&FR.TERMINATION_DT , $FR_TERMINATION_DT_Cmp , {DEFCMP}, '', '')
      do Format-DateTime($FR_SegBgn_F       , $FR_SegBgn_Cmp         , {DEFCMP}, '', '')
      do Format-DateTime(&FR.SEG_END_DT     , $FR_SegEnd_Cmp         , {DEFCMP}, '', '')

   !#Debug show 'FR_DATE ' $FR_HIRE_DT_Cmp ' , ' $FR_TERMINATION_DT_Cmp  ' , ' $FR_SegBgn_Cmp ' , ' $FR_SegEnd_Cmp

    if ($FR_HIRE_DT_Cmp >= $FR_SegBgn_Cmp )  and ($FR_HIRE_DT_Cmp <= $FR_SegEnd_Cmp) AND ($Fr_Hire_Flg = 'N')
!SI When reset $Fr_Hire_Flg to Y, the variable $FR_SegBgn will be overriten with the wrong value within the next Employeerow
!Therefore the next Statement will be comented out to ensure that the right Employee Hire Date is prited out
!      let  $Fr_Hire_Flg = 'Y'
       let  $FR_SegBgn   =  $FR_HIRE_DT
    else
       let  $FR_SegBgn   = $FR_SegBgn_F !Begin of the Year Date
    end-if

    if ($FR_TERMINATION_DT_Cmp >= $FR_SegBgn_Cmp )  and ($FR_TERMINATION_DT_Cmp <= $FR_SegEnd_Cmp) or ($FR_TERMINATION_DT_Cmp = '')
        let $FR_SegEnd = $FR_TERMINATION_DT
        if $FR_SegEnd = ''
           let $FR_SegEnd = &FR.SEG_END_DT
        end-if
    else
           let $FR_SegEnd = &FR.SEG_END_DT
    end-if

  ! convert the dates to yyyymmdd (CMP) format

  if $Sex_FR = 'M'
    let $NAME_PREFIX_FR = 'Monsieur / Herr'
  else
    let $NAME_PREFIX_FR = 'Madame / Frau'
  end-if

      let $flag_1 = ''
      let $flag_2 = ''
      let $flag_3 = ''
      let $flag_4 = ''

   evaluate $FR_MAR_STATUS
   when = 'S'
      let $flag_1 = 'X'
   break
   when = 'M'
      let $flag_2 = 'X'
   break
   when = 'W'
      let $flag_3 = 'X'
   break
   when = 'D'
      let $flag_4 = 'X'
   break
   when = 'E'
      let $flag_4 = 'X'
   break
   when-other
      let $flag_1 = ''
      let $flag_2 = ''
      let $flag_3 = ''
      let $flag_4 = ''
   break
   end-evaluate

   let $flag_A = ''
   let $flag_B = ''
   let $flag_C = ''
   let $flag_O = ''

   evaluate $Tariff_CD_FR_FLG
   when = 'A'
      let $flag_A = 'X'
   break
   when = 'B'
      let $flag_B = 'X'
   break
   when = 'C'
      let $flag_C = 'X'
   break
   when-other
      let $flag_O = 'X'
   break
   end-evaluate



  do Format-DateTime(&FR.BIRTHDATE , $FR_birth_date  , {DEFDATE}, '', '')
  do Format-DateTime(&FR.SEG_BGN_DT, $FR_SegBgn1     , {DEFDATE}, '', '')
  do Format-DateTime(&FR.SEG_END_DT, $FR_SegEnd1     , {DEFDATE}, '', '')

  do Format-DateTime(&FR.SEG_END_DT, $FR_SegEnd1_Cmp , {DEFCMP} , '', '')
  do Format-DateTime($FR_SegEnd    , $FR_SegEnd2_Cmp , {DEFCMP} , '', '')

  let $Column1 = $FR_SegBgn1 || ' ' || $FR_SegEnd1

  let #Amount20_FR              =  &FR.GPCH_RP_AMOUNT20
  let #Amount21_FR              =  #Amount21_FR        + &FR.GPCH_RP_AMOUNT21
!FMB 'freeze' yearly income as of last printed row
! let #Amount22_FR              =  &FR.GPCH_RP_AMOUNT22
  let #Amt_Col1                 =  &FR.GPCH_RP_AMOUNT1 + &FR.GPCH_RP_AMOUNT2
  let #Amt_Col2                 =  &FR.GPCH_RP_AMOUNT9 + &FR.GPCH_RP_AMOUNT14 + &FR.GPCH_RP_AMOUNT19
  let #Tot_Amt_Col1             =  #Tot_Amt_Col1       + #Amt_Col1
  let #Tot_Amt_Col2             =  #Tot_Amt_Col2       + #Amt_Col2

  do Format-Number(#Amount20_FR ,$Amount20_FR ,'B8')
  do format-number(#Amount21_FR ,$Amount21_FR ,'9,999')
!  do format-number(#Amount22_FR ,$Amount22_FR ,'B9,999,999,999.99mi')
  do format-number(#Amt_Col1    ,$Amt_Col1    ,'B9,999,999,999.99mi')
  do format-number(#Amt_Col2    ,$Amt_Col2    ,'B9,999,999,999.99mi')
  do format-number(#Tot_Amt_Col1,$Tot_Amt_Col1,'B9,999,999,999.99mi')
  do format-number(#Tot_Amt_Col2,$Tot_Amt_Col2,'B9,999,999,999.99mi')

   !   alter-printer
   !   font = 32
   !   point-size = 7.9

   if (#Amt_Col1 <> 0 OR #Amt_Col2 <> 0) AND $FR_SegEnd1_Cmp <= $FR_SegEnd2_Cmp ! Incase of termination dont print zero rows after the T date.

       !FMB 'freeze' yearly income as of last printed row

       let #Amount22_FR              =  &FR.GPCH_RP_AMOUNT22
       do format-number(#Amount22_FR ,$Amount22_FR ,'B9,999,999,999.99mi')

       print $Column1            (#Row_Cnt,3)
       print $FR_CITY            (#Row_Cnt,23)
       print $flag_1             (#Row_Cnt,50)
       print $flag_2             (#Row_Cnt,53)
       print $flag_3             (#Row_Cnt,56)
       print $flag_4             (#Row_Cnt,59)

       print $flag_A             (#Row_Cnt,67)
       print $flag_B             (#Row_Cnt,70)
       print $flag_C             (#Row_Cnt,73)
       print $flag_O             (#Row_Cnt,76)

       print $Amount20_FR        (#Row_Cnt,63)

       print $Amt_Col1           (#Row_Cnt,85)
       print $Amt_Col2           (#Row_Cnt,110)

       let #Row_Cnt = #Row_Cnt + 1

   end-if



   let $IntEmplid    = $Empl_ID_FR
   let #IntEmpl_Rcd  = #Empl_RCD_FR
   let $First_Row    = 'N'


from PS_GPCHTX011_VW FR
where  FR.PROCESS_INSTANCE = #prcs_process_instance
AND    FR.GPCH_TX_CANTON   = 'FR'
ORDER BY FR.EMPLID,FR.EMPL_RCD,FR.PRD_END_DT,FR.SLICE_END_DT
end-select

      alter-printer
      font = 32
      point-size = 7.9


      do Format-DateTime($FR_SegBgn   , $FR_SegBgn     , {DEFDATE}, '', '')
      do Format-DateTime($FR_SegEnd   , $FR_SegEnd     , {DEFDATE}, '', '')
      do Format-DateTime($Issued_Date , $Issued_Date1  , {DEFDATE}, '', '')

     if $IntEmplid <> ' '
         print $FR_SegEnd             (25,108)
         print $flag_1                (24,2)
         print $flag_2                (25,2)
         print $flag_3                (26,2)
         print $flag_4                (27,2)
         print $Amount21_FR           (27,110)
         print $Amount22_FR           (67,115)
         print $Tot_Amt_Col1          (65,85)
         print $Tot_Amt_Col2          (65,110)
      end-if

      let #Amount21_FR              = 0  !&FR.GPCH_RP_AMOUNT21
      let #Amount22_FR              = 0  !&FR.GPCH_RP_AMOUNT22
      let #Tot_Amt_Col1             = 0
      let #Tot_Amt_Col2             = 0

      do Get_Signature($Emplid_FR,$Ctl_End_Dt,$language_cd,$Signature_Type,$Cpdescr,$HD_FOR,
                       $Other_Py,$Signature1,$Signature2,$SI_PHONE,
                       $PAYENT_DESCR,$JobSuper_name,$JobPhone_num)

      do Get-Emp-Address($IntEmplid,$Ctl_End_Dt,'HOME',$ADDLINE1,$ADDLINE2,$ADDLINE3,$ADDLINE31,
                         $ADDLINE4,$ADDLINE5,$ADDLINE6,$Full_Name,$FirstName,$LastName,$NAME_PREFIX,
                         $NAME_TITLE,$NAME_ROYAL_PREFIX,$NAME_ROYAL_SUFFIX,$Phone,$Email,$CITY,$STATE,$POSTAL)


      print $FR_SegBgn                (23,108)
      print $Employer_StaxNr_FR          (9,15)
      print $N_Id_FR                  (9,63)
      print $NNSS_Id_FR                  (10,63)
      print $Ctl_Year                 (9,110)

      print $FR_birth_date            (14,107)
      print $Issued_Date1             (71,8)
      print $JobSuper_name1            (71,97)
      print 'X'                       (24,36)


      !print $PAYENTITY_DESCR          (13,2)
      !print $PADDLINE2                (14,2)
      !print $PADDLINE3                (15,2)
      !if $PADDLINE31 <> ''
      !print $PADDLINE31               (16,2)
      !end-if

      print $Rep_Descr                (13,2)
      print $Rep_Addr1                (14,2)
      if $Rep_Addr3 <> ''
      let $Rep_Addr2 = LTRIM(RTRIM($Rep_Addr2||' '||$Rep_Addr3,' '),' ')
      end-if
      print $Rep_Addr2                (15,2)
      print $Rep_Postal               (16,2)

      print $NAME_PREFIX_FR           (13,50)
      print $Full_Name                (14,50)
      print $ADDLINE2                 (15,50)
      print $ADDLINE3                 (16,50)
      print $ADDLINE31                (17,50)
      print $ADDLINE4                 (18,50)
      print $ADDLINE5                 (19,50)

#Debug Show '<- Get_Report_FR '
end-procedure

!*******************************************************************************************

begin-procedure Print_Template_FR
#Debug Show '-> Print_Template_FR  '

!if $IntEmplid <> ' '
!new-page
!end-if

      alter-printer
      font = 4
      point-size = 7.9

position (1,1)

print 'CANTON DE FRIBOURG'                        (1,1)
print 'Service cantonal des contributions'        (2,1)
print 'Secteur de l''impt  la source'           (3,1) bold

print 'KANTON FREIBURG'                           (1,111)
print 'Kantonale Steuerverwaltung'                (2,105)
print 'Abteilung Quellensteuer'                   (3,107) bold

      alter-printer
      font = 4
      point-size = 14

print 'CERTIFICAT DE SALAIRE'                     (1,50) bold
print 'LOHNAUSWEIS'                               (3,56) bold

      alter-printer
      font = 4
      point-size = 7.9

print 'EMPLOYEUR / ARBEITGEBER'                   (6,2) bold
print 'EMPLOY(E) / ARBEITNEHMER(IN)'             (6,50) bold
print 'ANNE / JAHR'                              (6,96) bold

graphic (7,1,40)  box 4 8
graphic (8,1,40) horz-line 8


graphic (7,49,40)  box 4 8
graphic (8,49,40) horz-line 8

graphic (7,96,31)  box 4 8 10



print 'No de contrle / Kontroll-Nr.'             (7,11)
print 'Numro AVS / AHV-Nummer'                   (7,58)
print 'Adresse'                                   (11,2)
print 'Adresse'                                   (11,50)



graphic (13,1,40)  box 1 0 5
graphic (15,1,40)  box 1 0 5
graphic (17,1,40)  box 1 0 5
graphic (19,1,40)  box 1 0 5


graphic (13,49,40)  box 1 0 5
graphic (15,49,40)  box 1 0 5
graphic (17,49,40)  box 1 0 5
graphic (19,49,40)  box 1 0 5

graphic (13,96,31)  box 2 8

graphic (17,96,31)  box 2 8


print 'Date de naissance / Geburtsdatum'          (12,97) bold
print 'Religion'                                  (16,97) bold

graphic (21,1,126)  box 10 8

print 'Etat civil / Zivilstand'                   (22,2) bold
print 'Genre d''activit / Art der Ttigkeit'     (22,36) bold
print 'Engagement'                                (22,80) bold
print 'Beschftigung'                             (23,80) bold
print 'du / vom'                                  (23,97)
print 'au / bis'                                  (25,97)

graphic (23,106,20) horz-line 8
graphic (25,106,20) horz-line 8

graphic (24,2,2)  box 1 1
graphic (25,2,2)  box 1 1
graphic (26,2,2)  box 1 1
graphic (27,2,2)  box 1 1


graphic (24,36,2)  box 1 1
graphic (25,36,2)  box 1 1
graphic (26,36,2)  box 1 1
graphic (27,36,2)  box 1 1
graphic (28,36,2)  box 1 1
graphic (29,36,2)  box 1 1

print '1 = Clibataire / Ledig'                   (24,5)
print '2 = Mari / Verheiratet'                   (25,5)
print '3 = Veuf / Verwitwet'                      (26,5)
print '4 = Divorc / Geschieden'                  (27,5)

print '1 = Salari / Lohnbezger'                 (24,39)
print '2 = Musicien-Sportif / Musiker-Sportler'   (25,39)
print '3 = Administrateur / Verwaltungsrat'       (26,39)
print '5 = Act. Accessoire / Nebenerwerb'         (27,39)
print '6 = Rentes / Renten'                       (28,39)
print '7 = Prest. en capital / Kapitalleistungen' (29,39)

graphic (27,106,20)  box 2 8 10
print 'Nombre de jours'                           (27,80) bold
print 'Anzahl Tage'                               (28,80) bold


graphic (32,1,126)  box 9 8


graphic (33,49,12) horz-line 8
graphic (33,66,12) horz-line 8

graphic (31,49,2) vert-line
graphic (31,61,2) vert-line
graphic (31,66,2) vert-line
graphic (31,78,2) vert-line


print 'Priodes de paie'                          (32,4)
print 'Lohnperioden'                              (33,5)

print 'Commune de domicile'                       (32,26)
print 'Wohngemeinde'                              (33,29)

print 'Etat civil'                                (32,52)
print 'Zivilstand'                                (33,51)

print 'Barme'                                    (32,69)
print 'Tarif'                                     (33,70)

print 'Revenu brut'                               (32,85)
print 'Bruttoeinkommen'                           (33,82)

print 'Taux'                                      (32,102)
print 'Satz'                                      (33,102)
print 'Impt retenu'                              (32,111)
print 'Abgez. Steuer'                             (33,111)



graphic (34,63,5) vert-line
graphic (35,59,4) vert-line
graphic (36,56,3) vert-line
graphic (37,53,2) vert-line
graphic (38,50,1) vert-line


graphic (35,67,4) vert-line
graphic (36,70,3) vert-line
graphic (37,73,2) vert-line
graphic (38,76,1) vert-line

print 'du/vom ...au/bis ...'                      (40,1)
print '1'                                         (40,50)
print '2'                                         (40,53)
print '3'                                         (40,56)
print '4'                                         (40,59)

print 'A'                                         (40,67)
print 'B'                                         (40,70)
print 'C'                                         (40,73)
print '%'                                         (40,103)

graphic (42,1,126)  box 1 0 5
graphic (44,1,126)  box 1 0 5
graphic (46,1,126)  box 1 0 5
graphic (48,1,126)  box 1 0 5
graphic (50,1,126)  box 1 0 5
graphic (52,1,126)  box 1 0 5
graphic (54,1,126)  box 1 0 5
graphic (56,1,126)  box 1 0 5
graphic (58,1,126)  box 1 0 5
graphic (60,1,126)  box 1 0 5
graphic (62,1,126)  box 1 0 5


      alter-printer
      font = 4
      point-size = 7.9

graphic (41,1,126)  box 23 8
graphic (64,1,126)  box 2 8

      alter-printer
      font = 4
      point-size = 12

print 'TOTAL'                                     (65,66)  bold

      alter-printer
      font = 4
      point-size = 7.9

graphic (31,21,32) vert-line
graphic (40,49,23) vert-line

graphic (40,52,23) vert-line
graphic (40,55,23) vert-line
graphic (40,58,23) vert-line
graphic (40,61,23) vert-line

graphic (40,66,23) vert-line
graphic (40,69,23) vert-line
graphic (40,72,23) vert-line
graphic (40,75,23) vert-line
graphic (40,78,25) vert-line

graphic (31,101,34) vert-line

graphic (31,107,34) vert-line

      alter-printer
      font = 4
      point-size = 7


print 'Nombre d''enfants/Anzahl Kinder'           (34,52)
print 'Div./Gesch'                                (35,51)
print 'Veuf/Verw.'                                (36,49)
print 'Mar./Verh.'                                (37,46)
print 'Cl./Ledig'                                (38,43)

print 'Seul/Allein'                               (35,67)
print 'Mar./Verh.'                                (36,70)
print 'Mar./Verh.'                                (37,73)
print 'autre/versch.'                             (38,76)

      alter-printer
      font = 4
      point-size = 7.9


print 'Le taux d''impt doit correspondre  un revenu annuel'         (67,1)   bold
print 'Revenu brut/Bruttoeinkommen X 360 jours/Tage'                  (67,70)  bold underline

print '='                                                             (67,113)  bold

print 'Der Steuersatz muss einem Jahreseinkommen entsprechen'         (68,1)  bold
print 'Nombre de jours/Anzahl Tage'                                   (68,75) bold


print 'Date:'                                                         (70,1)
print 'Datum:'                                                        (71,1)

print 'Timbre / Signature:'                                           (70,71)
print 'Stempel / Unterschrift:'                                      (71,71)

graphic                                                               (73,1,126)  box 6 8

print 'Remarque / Bemerkung'                                          (73,1)

      alter-printer
      font = 32
      point-size = 7.9

print 'NB: Une copie de ce formulaire doit tre remise  l''employ(e)'                (79,1) bold
print 'Eine Kopie dieses Formulars muss dem(der) Arbeitnehmer(in) ausgehndigt werden' (80,1) bold


!--------------------------------------------------------------------------------------------

#Debug Show '<- Print_Template_FR   '
end-procedure
!*************************************************************************************
!Tissen REPORT   Report E
!*************************************************************************************
begin-procedure Print_Template_TI
#DEBUG SHOW '-> Print_Template_TI '



      alter-printer
      font = 4
      point-size = 11


print 'TRATTENUTA DELL''IMPOSTA ALLA FONTE SULLE PRESTAZIONI VERSATE AI SALARIATI'  (1,8) bold

      alter-printer
      font = 4
      point-size = 12

 let $Header2_TI = 'ATTESTATO - RICEVUTA ANNO ' || $Ctl_Year

print $Header2_TI                                                           (4,) center bold


      alter-printer
      font = 4
      point-size = 10

graphic                               (7,5,120)  box 3 8

print ' 1.   Contribuente assoggettato all''imposta alla fonte'                       (8,5)
print 'No AVS: '                      (,70)  bold
print 'No RCS: '                     (9,70)  bold

print 'Cognome '                      (12,10)
print 'Domicilio Via/no '             (14,10)
print 'Luogo di lavoro: Comune '      (16,10)
print 'Data di nascita '              (18,10)
print 'Stato civile '                 (20,10)
print 'Cognome/nome del coniuge '     (22,10)

print 'Nome'                          (12,65)
print 'Localit'                      (14,65)
print 'Cantone'                       (16,65)
print 'Numero figli'                  (18,65)
print 'dal'                           (,85)
print 'dal'                           (20,65)
print 'lo stesso lavora in Svizerra'  (22,65)
print 'si'                            (22,100)
print 'no'                            (22,110)

print '.'                             (24,10,50)  fill

print ' '                             (24,105)

graphic                               (26,5,55)  box 3 8

print ' 2.   Trattenuta dell''imposta alla fonte'   (27,5)
print 'Periodo dell''assoggettamento dal'           (31,10)
print 'al'                                          (31,58)
print 'Numero giorni di lavoro'                     (33,10)

graphic                               (36,5,120)  box 3 8
graphic                               (39,5,120)  box 1 8
graphic                               (40,5,120)  box 1 8
graphic                               (41,5,120)  box 1 8
graphic                               (42,5,120)  box 1 8
graphic                               (43,5,120)  box 1 8

graphic (35,60,8) vert-line
graphic (35,80,8) vert-line
graphic (35,95,8) vert-line


print ' Prestazioni lorde assoggettate all''imposta alla' (36,5)
print ' fonte (contanti e natura) '                       (37,5)
print ' Fr.'                                              (38,5)


print 'Tabella'                                          (36,61)
print 'Aliquota'                                         (36,81)
print '%'                                                (38,81)
print 'Imposta trattenuta'                               (36,96)
print 'Fr.'                                              (38,96)

print 'Rimborso spese non incluse nelle prestazioni assoggettate all''imposta fr.' (46,10)

print 'Numero dei giorni di assenza in seguito a vacanze, malattia, infortunio o disoccupazione, per l'  (49,10)
print 'quali le indennit relative non sono state versate per il tramite del datore di lavoro e che non' (50,10)
print 'sono comprese nelle prestazioni succitate: giorni'                                                (51,10)

print 'Se sono state applicate piu tabelle e percentuali d''imposta durante il periodo di assoggettamento, si prega' (54,10)
print 'di indicare le singole prestazioni con i dati relativi'    (55,10)


graphic                               (58,5,120)  box 3 8

print ' 3.   Datore di lavoro'        (59,5)
print 'No controllo: '                (59,95) bold


print 'Nome o ragione sociale:'       (63,10)

print 'Via e no:'                     (65,10)
print 'Localit:'                     (65,60)
print 'Cantone:'                      (65,95)


print 'Data di rilascio dell''attestato al dipendente:' (69,10)
print 'Firma del datore di lavoro:'                     (69,95)
print '.'                             (72,10,60)  fill
print '.'                             (72,95,40)  fill

print 'Il contribuente che contesta la trattenuta d''imposta alla fonte pu richiedere all''Ufficio delle imposte alla fonte ' (76,5)
print 'una decisione in merito all''esistenza e all''estensione dell''assoggettamento. La relativa richiesta scritta deve '    (77,5)
print 'essere presentata e motivata entro il 31 marzo dell''anno che segue quello dell''assoggettamento.'                      (78,5)

print 'Avvertenza:'                   (81,5) bold underline
print 'per'                           (0,+3) bold
print 'i dimoranti e altri contribuenti con dimora fiscale nel Cantone,' (0,+2) bold underline
print 'la sostanza(capitali a'                                           (0,+5) bold
print 'risparmio) e tutti i redditi che non sono del lavoro (interessi di capitali, alimenti, ecc.) sono da' (82,5) bold
print 'dichiarare ordinariamente richiedendo il modulo per la dichiarazione d''imposta all''ufficio '        (83,5) bold
print 'circondariale di tassazione.'                                                                         (84,5) bold


#Debug Show '<- Print_Template_TI   '
end-procedure Print_Template_TI
!*************************************************************************************
begin-procedure Get_Report_TI
#Debug Show '-> Get_Report_TI '

   do Get-Language($ReportID, 'ITA')
   do Get_Fak_Tax_Data('TI',$Ctl_PayEntity,$Ctl_End_Dt,
                        $Fak_Language,$Employer_Fak_Nbr,#Employer_Fak_Pct,
                        $Tax_Language,$Employer_StaxNr,#Staxb_PCTR,
                        #Employer_SI_Pct,$SI_AHV_MBR_ID,$SI_AHV_PROVCD,
                        $SI_KTG_MBR_ID,#SI_AHV_ADM_PC,#SI_TOT_AHV_PC,
                        #SI_TOT_ALV1PC,#SI_TOT_ALV2PC)

   do Print_Template_TI
   let #Row_Cnt = 39
   let $Int_Emplid_TI        = ' '
   let $Int_Num_Child_Change = ' '
   let $Int_Mar_Stat_Change  = ' '
   let $Int_Tariff_CD_TI     = ' '

      alter-printer
      font = 32
      point-size = 11

begin-select
TI.EMPLID          ()   on-break print=never procedure=Print_NewEmployee_TI  level=1
TI.CAL_RUN_ID
TI.EMPL_RCD
TI.GP_PAYGROUP
TI.CAL_ID
TI.SEG_BGN_DT
TI.SEG_END_DT
TI.RSLT_SEG_NUM
TI.SLICE_END_DT
TI.PAY_ENTITY
TI.COMPANY
TI.PRD_END_DT
TI.GPCH_AL_CPAY_ENDDT
TI.MAR_STATUS
TI.BIRTHDATE
TI.GPCH_TX_TRF_CD
TI.SPOUSE_NAME
TI.GPCH_TX_SPOUSE_WL
TI.GPCH_RP_AMOUNT1
TI.GPCH_RP_AMOUNT2
TI.GPCH_RP_AMOUNT9
TI.GPCH_RP_AMOUNT14
TI.GPCH_RP_AMOUNT15
TI.GPCH_RP_AMOUNT19
TI.GPCH_RP_AMOUNT20
TI.GPCH_RP_AMOUNT21
TI.GPCH_RP_AMOUNT22
TI.GPCH_RP_AMOUNT26
TI.GPCH_RP_AMOUNT27
TI.NATIONAL_ID
TI.GPCH_AH_NNSS
TI.HIRE_DT
TI.TERMINATION_DT
TI.GPCH_TX_VILLAGE_CD
TI.GPCH_TX_CANTON


  let $EmplID_TI_brk            =  rtrim(&TI.EMPLID,' ')
  let $Tariff_CD_TI_brk         =  rtrim(&TI.GPCH_TX_TRF_CD,' ')

  print $EmplID_TI_brk    () on-break level = 1 After=Print_Emplid_TI Print=Never
  print $Tariff_CD_TI_brk () on-break level = 2 After=Print_TaxTariff_TI Print=Never

  !-------------------------------------------------------------------------------------------

  let $Emplid_TI                = &TI.EMPLID
  let $N_Id_TI                  = rtrim(ltrim(&TI.NATIONAL_ID,' '),' ')
  let $NNSS_Id_TI               = rtrim(ltrim(&TI.GPCH_AH_NNSS,' '),' ')
  let $N_Id_TI                  = edit($N_Id_TI,'XXX.XX.XXX.XXX')
  
 ! let $N_Id_TI                  = edit($N_Id_TI,'XXX.XX.XXX.XXX')
  
  let $NNSS_Id_TI               = substr($NNSS_Id_TI,1,3)||'.'||
                                        substr($NNSS_Id_TI,4,4)||'.'||
                                        substr($NNSS_Id_TI,8,4)||'.'||
                                        substr($NNSS_Id_TI,12,2)
                       
  let $Tariff_CD_TI             = rtrim(&TI.GPCH_TX_TRF_CD,' ')
  let $TI_MAR_STATUS            = rtrim(&TI.MAR_STATUS,' ')
  let $Canton                   = &TI.GPCH_TX_CANTON
  let $Village_CD               = &TI.GPCH_TX_VILLAGE_CD
      !FMB 20090422 Read Spouse_Name instead of taking from GPCH_RP_0001
      let $Spouse_enddt_TI = $Ctl_End_Dt
      do Get_Spouse_Name($Emplid_TI ,$Spouse_enddt_TI,$SPOUSE_NAME_TI)

  let $SPOUSE_WL_TI             = rtrim(&TI.GPCH_TX_SPOUSE_WL,' ')
  let $TI_SegEnd                = &TI.SEG_END_DT
  let $Num_Child_Change         = rtrim(&TI.EMPLID,' ') || to_char(&TI.GPCH_RP_AMOUNT20)
  let $Mar_Stat_Change          = rtrim(&TI.EMPLID,' ') || rtrim(&TI.MAR_STATUS,' ')

  do Get_Martial_Status_TI($TI_MAR_STATUS,$MarStat_TI)

  if $Int_Emplid_TI <> $Emplid_TI
     let $TI_SegBgn                = &TI.SEG_BGN_DT
     do Format-DateTime($TI_SegBgn    , $TI_SegBgn    , {DEFDATE}, '', '')
  end-if

  if $Int_Num_Child_Change <> $Num_Child_Change
     do Format-DateTime(&TI.SEG_BGN_DT  , $Num_Child_Change_Dt    , {DEFDATE}, '', '')
  end-if

  if $Int_Mar_Stat_Change  <> $Mar_Stat_Change
     do Format-DateTime(&TI.SEG_BGN_DT  , $Mar_Stat_Change_Dt    , {DEFDATE}, '', '')
  end-if

   if $Int_Tariff_CD_TI  <> $Tariff_CD_TI
     let $TI_SegBgn2                = &TI.SEG_BGN_DT
     do Format-DateTime($TI_SegBgn2    , $TI_SegBgn2    , {DEFDATE}, '', '')
  end-if

  do Format-DateTime(&TI.BIRTHDATE , $TI_birth_date  , {DEFDATE}, '', '')
  do Format-DateTime($TI_SegEnd    , $TI_SegEnd    , {DEFDATE}, '', '')
  do Format-DateTime($Issued_Date  , $Issued_Date1 , {DEFDATE}, '', '')

  let #Amount20_TI              =  &TI.GPCH_RP_AMOUNT20
  let #Amount15_TI              =  #Amount15_TI + &TI.GPCH_RP_AMOUNT15
  let #Amount21_TI              =  #Amount21_TI + &TI.GPCH_RP_AMOUNT21
  let #Amount26_TI              =  #Amount26_TI + &TI.GPCH_RP_AMOUNT26
  let #Amount27_TI              =  #Amount27_TI + &TI.GPCH_RP_AMOUNT27
  let #Amt_Col1_TI              =  #Amt_Col1_TI + &TI.GPCH_RP_AMOUNT1  + &TI.GPCH_RP_AMOUNT2
  let #Amt_Col2_TI              =  #Amt_Col2_TI + &TI.GPCH_RP_AMOUNT9  + &TI.GPCH_RP_AMOUNT14 + &TI.GPCH_RP_AMOUNT19

  If  #Amt_Col1_TI <> 0.00 
    let #Amount15_TI              =  (#Amt_Col2_TI / #Amt_Col1_TI) * 100
  else
    let  #Amount15_TI = 0
  End-if


  do Format-Number(#Amount20_TI ,$Amount20_TI ,'B8')
  do format-number(#Amount15_TI ,$Amount15_TI ,'999.99')
  do format-number(#Amount21_TI ,$Amount21_TI ,'9,999')
  do format-number(#Amount26_TI ,$Amount26_TI ,'B9,999,999,999.99mi')
  do format-number(#Amount27_TI ,$Amount27_TI ,'B9,999,999,999.99mi')
  do format-number(#Amt_Col1_TI ,$Amt_Col1_TI ,'B9,999,999,999.99mi')
  do format-number(#Amt_Col2_TI ,$Amt_Col2_TI ,'B9,999,999,999.99mi')

  let $Int_Emplid_TI        = $Emplid_TI
  let $Int_Num_Child_Change = $Num_Child_Change
  let $Int_Mar_Stat_Change  = $Mar_Stat_Change
  let $Int_Tariff_CD_TI     = $Tariff_CD_TI


from PS_GPCHTX011_VW TI
where  TI.PROCESS_INSTANCE = #prcs_process_instance
AND    TI.GPCH_TX_CANTON   = 'TI'
ORDER BY TI.EMPLID,TI.EMPL_RCD,TI.PRD_END_DT,TI.SLICE_END_DT,TI.GPCH_TX_TRF_CD
end-select

#Debug Show '<- Get_Report_TI '
end-procedure
!*******************************************************************************************
Begin-Procedure Print_Emplid_TI
#Debug Show '-> Print_Emplid_TI '

      print $TI_SegEnd          (31,62)
      print $Amount21_TI        (33,35)
      print $Amount26_TI        (46,110)
      print $Amount27_TI        (51,110)


      let #Amount21_TI              = 0
      let #Amount26_TI              = 0
      let #Amount27_TI              = 0

      do Get_Signature($Emplid_TI,$Ctl_End_Dt,$language_cd,$Signature_Type,$Cpdescr,$HD_FOR,
                       $Other_Py,$Signature1,$Signature2,$SI_PHONE,
                       $PAYENT_DESCR,$JobSuper_name,$JobPhone_num)

      do Get-Emp-Address($Emplid_TI,$Ctl_End_Dt,'HOME',$ADDLINE1,$ADDLINE2,$ADDLINE3,$ADDLINE31,
                      $ADDLINE4,$ADDLINE5,$ADDLINE6,$Full_Name,$FirstName,$LastName,$NAME_PREFIX,
                      $NAME_TITLE,$NAME_ROYAL_PREFIX,$NAME_ROYAL_SUFFIX,$Phone,$Email,$CITY,$STATE,$POSTAL)

      do Get_Village_Name
      do Get_Canton_Name

      print $N_Id_TI                  (8,80)
      print $NNSS_Id_TI               (8,99)

      print $FirstName                (12,40)
      print $LastName                 (12,80)

      print $ADDLINE2                 (14,40,15)
      print $ADDLINE3                 (14,80)

      print $Village_Name             (16,40)
      print $Canton_Name              (16,80)

      print $TI_birth_date            (18,40)

      print $Amount20_TI              (18,80)

      if rtrim($Amount20_TI,' ') <> ''
         print $Num_Child_Change_Dt   (18,90)
      end-if

      print $MarStat_TI               (20,40)

      if rtrim($MarStat_TI,' ') <> ''
         print $Mar_Stat_Change_Dt    (20,70)
      end-if

      if $SPOUSE_NAME_TI <> ''

      if $SPOUSE_WL_TI = 'Y'
         print 'X'                    (22,104)
      end-if

      if $SPOUSE_WL_TI = 'N'
         print 'X'                    (22,115)
      end-if

      end-if

      print $SPOUSE_NAME_TI           (24,10)

      print $TI_SegBgn                 (31,45)

      print $Employer_StaxNr           (59,110)

      print $Rep_Descr                (63,36)
      print $Rep_Addr1                (65,20)
      print $Rep_Postal               (65,70)
      if $Rep_Addr2 <> ''
      print $Rep_Addr2                (65,105)
      end-if

      print $Issued_Date1             (71,20)
      print $JobSuper_name1            (71,97)

#Debug Show '<- Print_Emplid_TI '
End-Procedure Print_Emplid_TI
!*******************************************************************************************
Begin-Procedure Print_TaxTariff_TI
#Debug Show '-> Print_TaxTariff_TI '

       alter-printer
       font = 32
       point-size = 9

       print $TI_SegBgn2         (#Row_Cnt,7)
       print $TI_SegEnd          (#Row_Cnt,18)
       print $Amt_Col1_TI        (#Row_Cnt,28)

       print $Tariff_CD_TI       (#Row_Cnt,62)
       print $Amount15_TI        (#Row_Cnt,82)
       print $Amt_Col2_TI        (#Row_Cnt,97)

       let #Amount15_TI = 0
       let #Amt_Col1_TI = 0
       let #Amt_Col2_TI = 0
       let #Row_Cnt     = #Row_Cnt + 1

       alter-printer
       font = 32
       point-size = 11

#Debug Show '<- Print_TaxTariff_TI '
End-Procedure Print_TaxTariff_TI

!*******************************************************************************************
Begin-Procedure Print_NewEmployee_TI
#Debug Show '-> Print_NewEmployee_TI '

      new-page
      do Print_Template_TI
      let #Row_Cnt = 39


#Debug Show '<- Print_NewEmployee_TI '
End-Procedure Print_NewEmployee_TI
!*******************************************************************************************
Begin-Procedure Get_Employee_XML_GE
#Debug Show '-> Get_Employee_XML_GE '
    
 do Get_Code_Activite_GE($Rep_Addr4,$CodeAct)
     
 do Formalix_Conversions
 do Formalix_Validation
     

  do Create_Employee_XML_GE
 
#Debug Show '<- Get_Employee_XML_GE '
End-Procedure Get_Employee_XML_GE
!*******************************************************************************************
Begin-Procedure Create_Employee_XML_GE
#Debug Show '-> Create_Employee_XML_GE '

    !<################Creation of the <infoContribuable> tag ###########
                      
   let $TypeContribule= '<typeContribuable>1</typeContribuable>'             ! Harcoded to 1
   !let $Confession = '<confession>0</confession>'                            ! Harcoded to 0
   let $NouveauNAVS13= ''
   let $numeroAVS = ''
   if $NNSS_IdQ <> '' 
     let $NouveauNAVS13='<nouveauNAVS13>'||$NNSS_IdT||'</nouveauNAVS13>'       ! New NNSS ID
   else
     let $numeroAVS= '<numeroAVS>'||$N_IdT||'</numeroAVS>'
   end-if
   let $NomPersonne='<nomPersonne>'||$LastName||'</nomPersonne>'             ! Last Name
   let $PrenomPersonne='<prenomPersonne>'||$FirstName||'</prenomPersonne>'   ! First Name
   let $DateNaissance='<dateNaissance>'||$Birth_DTQ1||'</dateNaissance>'     ! Birth Date
   let $Sexe = '<sexe>'||$Sex_Value_GE||'</sexe>'                            ! Sex
   let $EtatCivil ='<etatCivil>'||$Mar_Stat_Formalix_GE||'</etatCivil>'      ! Marital Status

   !<------------------Final Subtag <infoContribuable>  -------------------------    
     
   let $infoContribuable='<infoContribuable>'||$NouveauNAVS13||$numeroAVS||
                               $NomPersonne||$PrenomPersonne||$DateNaissance||$Sexe||$EtatCivil||'</infoContribuable>'
   !------------------------------------------------------------------------------->
   

  !################End of <infoContribuable> tag ##########################->
  
  
  
  
  
  !<- ################# Creation of the <Famille> Tag #####################->
  let $nomConjoint  = ''
  let $prenomConjoint = ''
  let $dateNaissanceEnfantInf25 =''
  let $conjointTravailleGE = ''
  let $conjointTravailleCH = ''
  let $conjointAvecRevenu  = ''
  
  if $SpouseFirstName_GE <> ''
    let $prenomConjoint= '<prenomConjoint>'||$SpouseFirstName_GE||'</prenomConjoint>'              !Spouse First Name
  end-if
  
  if  $SPOUSE_WLQ_GE = '2'
    let $conjointTravailleGE = '<conjointTravailleGE>'||'1'||'</conjointTravailleGE>'              !Conjoint travaille en GE
    let $conjointTravailleCH = '<conjointTravailleCH>'||'1'||'</conjointTravailleCH>'             !and thus p.d. in Switzerland
  End-IF
  if  $SPOUSE_WLQ_GE = '1'
     let $conjointTravailleCH = '<conjointTravailleCH>'||'1'||'</conjointTravailleCH>'   !Conjoint travaille en Suisse
     let $conjointTravailleGE = '<conjointTravailleGE>'||'0'||'</conjointTravailleGE>'    !but not in GE  
  End-IF
    if  $SPOUSE_WLQ_GE = '0' and ( $Mar_Stat_Formalix_GE='2' or $Mar_Stat_Formalix_GE='6' )
       let $conjointTravailleCH = '<conjointTravailleCH>'||'0'||'</conjointTravailleCH>'   !Spouse doesnt work in Switzerland
       let $conjointTravailleGE = '<conjointTravailleGE>'||'0'||'</conjointTravailleGE>'    !and not in GE         
    End-IF

  ! FMB 20140207 
  If $SPOUSE_WLQ_GE = '0'
     let $conjointAvecRevenu = '<conjointAvecRevenu>' || '0' || '</conjointAvecRevenu>'
  End-If
  If $SPOUSE_WLQ_GE = '1' or $SPOUSE_WLQ_GE = '2'
     let $conjointAvecRevenu = '<conjointAvecRevenu>' || '1' || '</conjointAvecRevenu>'
  End-If
  If $SPOUSE_WLQ_GE = '' and $SpouseFirstName_GE <> ''
     let $conjointAvecRevenu = '<conjointAvecRevenu>' || '2' || '</conjointAvecRevenu>'
  End-If


!Replaced part begin
!  if $SpouseFirstName_GE <> ''
!    let $prenomConjoint= '<prenomConjoint>'||$SpouseFirstName_GE||'</prenomConjoint>'              !Spouse First Name
!  end-if
!  
!  if  $SPOUSE_WLQ_GE = '2'
!     let $conjointTravailleGE = '<conjointTravailleGE>'||'1'||'</conjointTravailleGE>'              ! Hardcode 0
!  End-IF
!  if  $SPOUSE_WLQ_GE = '1'
!     let $conjointTravailleCH = '<conjointTravailleCH>'||'1'||'</conjointTravailleCH>'   !Conjoint travaille en Suisse
!  End-IF
!Replaced part end
!Wue 2011/08/24 end of changed part 

  let $nbrEnfantsInf25= '<nbrEnfantsInf25>'||$ChildCount||'</nbrEnfantsInf25>'                   !Number of children
  
  !Logic to create the Children Birthdae tags if they exist  
  
  if to_number($ChildCount) > 0
   if $Child1BDt <>''
    let $dateNaissanceEnfantInf25 = '<dateNaissanceEnfantInf25>'||$Child1BDt||'</dateNaissanceEnfantInf25>'  !Child Birthdates 
   end-if
   
   if $Child2BDt <>''
     let $dateNaissanceEnfantInf25 = $dateNaissanceEnfantInf25||'<dateNaissanceEnfantInf25>'||$Child2BDt||'</dateNaissanceEnfantInf25>'  !Child Birthdates 
   end-if
   if $Child3BDt <>''  
     let $dateNaissanceEnfantInf25 = $dateNaissanceEnfantInf25||'<dateNaissanceEnfantInf25>'||$Child3BDt||'</dateNaissanceEnfantInf25>'  !Child Birthdates 
    end-if
   if $Child4BDt <>''  
     let $dateNaissanceEnfantInf25 = $dateNaissanceEnfantInf25||'<dateNaissanceEnfantInf25>'||$Child4BDt||'</dateNaissanceEnfantInf25>'  !Child Birthdates 
   end-if
   if $Child5BDt <>''
     let $dateNaissanceEnfantInf25 = $dateNaissanceEnfantInf25||'<dateNaissanceEnfantInf25>'||$Child5BDt||'</dateNaissanceEnfantInf25>'  !Child Birthdates 
   end-if
  end-if
  
  If $MarStat_Common_Law <> '0'
  let $unionLibre='<unionLibre>'||$MarStat_Common_Law||'</unionLibre>'
  End-If
  
  !<------------------Final Subtag <famille>  -------------------------    
  ! 20140207  let $Famille ='<famille>'||$nomConjoint||$prenomConjoint||$conjointTravailleGE||$conjointTravailleCH||$nbrEnfantsInf25||
   let $Famille ='<famille>'||$nomConjoint||$prenomConjoint||$conjointAvecRevenu ||
                 $dateNaissanceEnfantInf25||$unionLibre||'</famille>'
  !------------------------------------------------------------------------------->
  
  !###################End of Famille Tag ###################################->
  
  
  
  
  
  !##########################Creation of the <adresseDomicile> tag################### 
  
    let $typeVoie= '<typeVoie>'||$Employee_Rue_GE||'</typeVoie>'
    let $liantVoie='<liantVoie>'||$Employee_Rue_GE||'</liantVoie>'
    let $voie ='<voie>'||$Employee_Rue_GE||'</voie>'
    let $Main_Voie = '<voie>'||$typeVoie||$liantVoie||$voie||'</voie>'
  
    let $numeroVoie='<numeroVoie>'||$Employee_No_GE||'</numeroVoie>'
    let $NPA2 ='<NPA>'||$NPA||'</NPA>'
    
    
    let $adresse = '<adresse>'||$Main_Voie||$numeroVoie||$NPA2||'</adresse>'
    
    
    let $localite = ''
    let $communePolitique =''
    let $Canton_xml =''
    let $PayCountry_xml =''
       let $localite = '<localite>'||$DomicileLocalite||'</localite>'
    if $Pays_Canton ='GE'
        
        let $communePolitique='<communePolitique>'||$Village_CD||'</communePolitique>'
    else 
      if $DomicileCanton <> ''
         let $Canton_xml = '<canton>'||$DomicileCanton||'</canton>'
      else
         let $PayCountry_xml = '<pays>'||$Country_2CHAR_CD||'</pays>'
      end-if
      
    end-if
    
    
  
    
    let $adresseDomicile = '<adresseDomicile>' ||$adresse||$localite||$Canton_xml||$PayCountry_xml||$communePolitique||'</adresseDomicile>'
  !############################End of the <adresseDomicile> tag ######################### ->
  
   
  !######################################Creation of the <retenuePrestationsImpots> tag   
   do Format-Number(#CH_LW_120_Val,$CH_LW_120_Val,'999999999999.99')
   do Format-Number(#Amount_LW_1311_12_Val,$Amount_LW_1311_12_Val,'999999999999')
   do Format-Number(#Amount_LW_1321_22_Val,$Amount_LW_1321_22_Val,'999999999999')
   do Format-Number(#CH_QS_F_Val,$CH_QS_F_Val_Val,'999999999999')
   
    let $tauxImposition ='<tauxImposition>'||$Amount15Q_1_FORLX||'</tauxImposition>'
    !let $raisonSocialeEmployeur='<raisonSocialeEmployeur>'||'N/A'||'</raisonSocialeEmployeur>'
    let $prestationsSoumisesImpot='<prestationsSoumisesImpot>'||$Amount1Q_1_FORLX||'</prestationsSoumisesImpot>'
    
    !<--------------------<retenueSalarie> --------------->
    !let $categorieProfessionnelle='<categorieProfessionnelle>'||'0'||'</categorieProfessionnelle>'
    !let $categorieProfessionnelle='<categorieProfessionnelle>'||'5'||'</categorieProfessionnelle>' 
    let $nbrJoursAbsence='<nbrJoursAbsence>'||to_char(#CH_TX_GE39_YTD_Val)||'</nbrJoursAbsence>'
    !let $nbrJourstravailEffectif='<nbrJourstravailEffectif>'||to_char(#CH_TX_GE31_YTD_Val)||'</nbrJourstravailEffectif>'
    let $nbrJourstravailEffectif='<nbrJourstravailEffectif>0</nbrJourstravailEffectif>'
    let $indemnitesDepart = '<indemnitesDepart>'||to_char(#CH_TX_GE34_YTD_Val)||'</indemnitesDepart>'
    If #CH_LW_30_Val <> 0.00
       do Format-Number(#CH_LW_30_Val,$CH_LW_30_Val,'888888888888')
       let $prestationsNonPeriodiques ='<prestationsNonPeriodiques>'||$CH_LW_30_Val||'</prestationsNonPeriodiques>'
    Else
       let $prestationsNonPeriodiques =''
    End-If
    let $allocationsFamiliales='<allocationsFamiliales>'||ltrim(to_char(#CH_LW_15006_Val),' ')||'</allocationsFamiliales>'
    let $fraisEffectifsNonInclus ='<fraisEffectifsNonInclus>'||ltrim($Amount_LW_1311_12_Val,' ')||'</fraisEffectifsNonInclus>'
    let $fraisForfaitairesNonInclus='<fraisForfaitairesNonInclus>'||ltrim($Amount_LW_1321_22_Val,' ')||'</fraisForfaitairesNonInclus>'
    
    do Get_ConformeFERGeneve_Value
    
    let $conformeFERGeneve ='<conformeFERGeneve>'||$ConferGen_value||'</conformeFERGeneve>'
    let #FTE_GE_XML = #FTE_GE_XML * 100
    do Format-Number(#FTE_GE_XML,$FTE_GE_XML_Val,'999.99')
    let $tauxActivite ='<tauxActivite>'||to_char(#FTE_GE_XML)||'</tauxActivite>'
    ! 20140207
    let $participationsEmployes= ' '
    If  #CH_QS_F_Val <> 0
    let $participationsEmployes='<participationsEmployes>'||ltrim($CH_QS_F_Val,' ')||'</participationsEmployes>'  
    End-If

    let $retenueSalarie = '<retenueSalarie>'||$categorieProfessionnelle||$nbrJoursAbsence||$nbrJourstravailEffectif||$indemnitesDepart||$prestationsNonPeriodiques||$allocationsFamiliales||
                       ! 20140207  $fraisEffectifsNonInclus||$fraisForfaitairesNonInclus||$conformeFERGeneve||$tauxActivite||'</retenueSalarie>'
                       $fraisEffectifsNonInclus||$fraisForfaitairesNonInclus||$tauxActivite||$participationsEmployes||'</retenueSalarie>'
    !<--------------------End of <retenueSalarie> --------------->
    
    let $impotsRetenus='<impotsRetenus>'||ltrim($CH_LW_120_Val,' ')||'</impotsRetenus>'
    !let $contributionEcclesiastique='<contributionEcclesiastique>'||'N/A'||'</contributionEcclesiastique>'
    let $contributionEcclesiastique=''
    let $retenuePrestationsImpots = '<retenuePrestationsImpots>'||$tauxImposition||$raisonSocialeEmployeur||$prestationsSoumisesImpot||$retenueSalarie||
                                    $impotsRetenus||$contributionEcclesiastique||'</retenuePrestationsImpots>'
  !#########################################End of the <retenuePrestationsImpots> tag 
  
    let $baremepreferentiel = ' '  
     IF $GrantCode <> ' '
      let $baremepreferentiel = '<baremepreferentiel>true</baremepreferentiel>'
     End-IF

    !Final XML for GPCH_EG_PERSON per employee
    let $DeclarationContribule='<declarationContribuable>'||$TypeContribule||$Confession||$infoContribuable
                                ! FMB 20140207 ||$Famille||$adresseDomicile||$assujettissementContribuable||$retenuePrestationsImpots||'</declarationContribuable>'
                                ||$Famille||$adresseDomicile||$baremepreferentiel ||$assujettissementContribuable||$retenuePrestationsImpots||'</declarationContribuable>'

                                
                        
   let $final_xml=$DeclarationContribule
 
   ! This logic assigns $EMPLID and #Empl_Rcd variables with current values for GE and then Reassigns the old values once the processing is done
      let $Temp_Emplid = $Emplid
      let #Temp_EmplRCD = #Empl_RCD
      let $Empl_Id = $Empl_IDQ
      let #Empl_RCD =#Empl_RCDQ

   !Insert the XML into the GPCH_EG_PERSON
   do Insert_Employee_Data_XML
   
      let $Empl_ID = $Temp_Emplid
      let #Empl_RCD = #Temp_EmplRCD
     
#Debug Show '<- Create_Employee_XML_GE '
End-Procedure Create_Employee_XML_GE
!*******************************************************************************************
Begin-Procedure Create_AssujettissementTag
#Debug Show '-> Create_AssujettissementTag '

 !####################Creation of the <assujettissementContribuable> tag ###############
   do Format-DateTime($AQ_Begin_Date, $AQ_Begin_Date2, {DEFDATE}, '', '')
   do Format-DateTime($AQ_End_Date  , $AQ_End_Date2  , {DEFDATE}, '', '')
   
  
   if rtrim($AQ_Begin_Date2 , ' ') = ''
      do Format-DateTime($Ctl_Start_Dt, $AQ_Begin_Date2, {DEFDATE}, '', '')
   end-if

   if rtrim($AQ_End_Date2 , ' ') = ''
      do Format-DateTime($Ctl_End_Dt  , $AQ_End_Date2  , {DEFDATE}, '', '')
   end-if
    
     let $debut_imposition='<debut_imposition>'||$AQ_Begin_Date2||'</debut_imposition>'
     let $fin_imposition = '<fin_imposition>'||$AQ_End_Date2||'</fin_imposition>'
     
     let $periodeImposition ='<periodeImposition>'||$debut_imposition||$fin_imposition||'</periodeImposition>'
     do Get_WorkLocation_Address
     !let $typeVoie1 ='<typeVoie>'||'n/a'||'</typeVoie>'
     let $typeVoie1 =''
     ! FMB 20090225
     let $typeVoie1 ='<typeVoie>'||$Work_Address||'</typeVoie>'
     let $liantVoie1='<liantVoie>'||$Work_Address||'</liantVoie>'
     let $voie1 ='<voie>'||$Work_Address||'</voie>'
     
     
     let $WrknumeroVoie='<numeroVoie>'||$Work_Address||'</numeroVoie>'
     let $WrkNPA= '<NPA>'||$Work_Postal||'</NPA>'
     let $Adresse1 = '<adresse><voie>'||$typeVoie1||$liantVoie1||$voie1||'</voie>'||$WrknumeroVoie||$WrkNPA||'</adresse>'
     
     
     if $Work_Country  = 'CHE'
       
         if $Work_State ='GE'
           
               let $localite_GE_xml = '<localite>'||$Work_City||'</localite>'
               let $communePolitique_GE_xml='<communePolitique>'||$Village_LQ||'</communePolitique>'
               let $Canton_GE_xml=''
         else 

              let $Canton_GE_xml='<canton>'||$Work_State||'</canton>'
              let $localite_GE_xml = ''
               let $communePolitique_GE_xml=''
         end-if
      end-if
        
     let $adresseTravail ='<adresseTravail>'||$Adresse1||$localite_GE_xml||$Canton_GE_xml||$communePolitique_GE_xml||'</adresseTravail>'

     let $baremeImposition = '<baremeImposition>'||$Bareme||'</baremeImposition>'
     
     !<-------------------------------------------------assujettissementContribuable
     
     let $assujettissementContribuable= $assujettissementContribuable ||'<assujettissementContribuable>'||$periodeImposition||$adresseTravail||
                                        $baremeImposition||'</assujettissementContribuable>'
     
  !######################################End of the <assujettissementContribuable> tag --------->


#Debug Show '<- Create_AssujettissementTag '
End-Procedure Create_AssujettissementTag
!*******************************************************************************************
Begin-Procedure Get_WorkLocation_Address
#Debug Show '-> Get_WorkLocation_Address '

begin-SELECT
LOC.ADDRESS1
LOC.STATE
LOC.CITY
LOC.COUNTRY
LOC.POSTAL

 let $Work_Address = ltrim(rtrim(&LOC.ADDRESS1,' '),' ')
 let $Work_State = ltrim(rtrim(&LOC.STATE,' '),' ')
 let $Work_City = ltrim(rtrim(&LOC.CITY,' '),' ')
 let $Work_Country = ltrim(rtrim(&LOC.COUNTRY,' '),' ')
 let $Work_Postal = ltrim(rtrim(&LOC.POSTAL,' '),' ')
 
 
from PS_LOCATION_TBL LOC 
where LOC.SETID = $loc_setid
     and LOC.LOCATION = $Wrk_Location_GE 
     and LOC.EFFDT =( Select MAX(B.EFFDT) from PS_LOCATION_TBL B 
            where B.SETID= $loc_setid and B.LOCATION=$Wrk_Location_GE and B.EFFDT <=$Ctl_End_Dt)

End-select


#Debug Show '<- Get_WorkLocation_Address '
End-Procedure Get_WorkLocation_Address
!*******************************************************************************************
Begin-Procedure Get_ConformeFERGeneve_Value
#Debug Show '-> Get_ConformeFERGeneve_Value '
    
let $ConferGen_value = '0'
begin-select 
'X'

    !Step Zero
    !Check If Company Message and CAnton Mapping exists
    do ConformeStep0

    !Step One .
    !Check the Message setup if Mapping exists
    if $Company_Mapping_GE='Y'
     do ConformeStep1
    
    end-if          
     !Step Two 
     ! Check for Employee ovveride
     do ConformeStep2
            

 from PS_GPCH_AL_CO_MSG 
 where COMPANY=$ptot_company 
 and EFFDT =(Select max(B.EFFDT) from PS_GPCH_AL_CO_MSG B 
                 where B.EFFDT <= $Ctl_End_Dt) 
 and (GPCH_TX_CANTON='GE' or GPCH_ALL_CANTONFLG='Y') 
 and GPCH_AL_MSG_NBR=1 and GPCH_RC_REPORTNAME='GPCHTX07'

end-select
 
#Debug Show '<- Get_ConformeFERGeneve_Value '
End-Procedure Get_ConformeFERGeneve_Value
!*******************************************************************************************
Begin-Procedure ConformeStep0
#Debug Show '-> ConformeStep0 '

let $Company_Mapping_GE = 'N'
begin-select
'Y'

  let $Company_Mapping_GE = 'Y'


from PS_GPCH_AL_CO_MSG CMAP
where CMAP.COMPANY=$ptot_company 
      and CMAP.GPCH_AL_MSG_NBR=1 
      and (CMAP.GPCH_TX_CANTON='GE' or CMAP.GPCH_ALL_CANTONFLG = 'Y') 
      and CMAP.EFFDT<=$Ctl_End_Dt


end-select



#Debug Show '<- ConformeStep0 '
End-Procedure ConformeStep0
!*******************************************************************************************

Begin-Procedure ConformeStep1
#Debug Show '-> ConformeStep1 '

begin-select 
MSGC.GPCH_AL_MSG_CHK 
      
  let $Chk_Msg = &MSGC.GPCH_AL_MSG_CHK
          
from PS_GPCH_AL_MSG_CAT MSGC     
where MSGC.GPCH_RC_REPORTNAME='GPCHTX07' 
      and MSGC.GPCH_AL_MSG_NBR = 1
      
end-select
          
          if $Chk_Msg = 'Y'
               let $ConferGen_value = '1' !sqh
          else 
               !Resolve Accu  
               if #CH_LW_15001_Val <> 0
                 let $ConferGen_value = '1'
               else 
                 let $ConferGen_value = '0'
               end-if   
          end-if
          
#Debug Show '<- ConformeStep1 '
End-Procedure ConformeStep1
!*******************************************************************************************
Begin-Procedure ConformeStep2
#Debug Show '-> ConformeStep2 '

  
begin-select
LWMSG.GPCH_AL_ACT_TYPE 
     
        let #Action_Type = &LWMSG.GPCH_AL_ACT_TYPE
        
           if #Action_Type = 2 
              let $ConferGen_value = '1'
           else 
             if #Action_Type = 1
              let $ConferGen_value = '0'
             end-if
           end-if
     
from PS_GPCH_TX_LAW_MSG LWMSG where EMPLID =$EMPL_IDQ 
and LWMSG.EFFDT=(select max(TXMSG.EFFDT) from PS_GPCH_TX_LAW_MSG TXMSG where TXMSG.EFFDT <= $Ctl_End_Dt and TXMSG.EMPLID = LWMSG.EMPLID and TXMSG.COMPANY =LWMSG.COMPANY and LWMSG.GPCH_AL_MSG_NBR=1) 
and LWMSG.COMPANY=$ptot_company
and LWMSG.GPCH_AL_MSG_NBR=1 

     
end-select

#Debug Show '<- ConformeStep2 '
End-Procedure ConformeStep2
!*******************************************************************************************
Begin-Procedure Get_2Char_Country_Code
#Debug Show '-> Get_2Char_Country_Code '

begin-select 
CY.COUNTRY_2CHAR 
       
 let $Country_2CHAR_CD = &CY.COUNTRY_2CHAR

from PS_COUNTRY_TBL CY
where CY.COUNTRY = $COUNTRY_GE
end-select

#Debug Show '<- Get_2Char_Country_Code '
End-Procedure Get_2Char_Country_Code
!*******************************************************************************************
Begin-Procedure Get_Muncipality_CodeFormalix
#Debug Show '-> Get_Muncipality_CodeFormalix '

 let $IsData='False'

 !if #Formalix_Flag=1
    !let $MunDescr =$City
    !lowercase $MunDescr
 !else
     let $MunDescr =$Rep_Addr2  
     lowercase $MunDescr
 !end-if

begin-select 
!PBC.GPCH_TX_VILLAGE_CD
PBC.MUNICIPALITYCD_CHE
  
    let $IsData  = 'True'
    !if #Formalix_Flag=1
        !Let $Residence_City=rtrim(&PBC.GPCH_TX_VILLAGE_CD,' ')
    !else
       !let $Cant_Muncipality = rtrim(&PBC.GPCH_TX_VILLAGE_CD,' ')
       let $Cant_Muncipality = rtrim(&PBC.MUNICIPALITYCD_cHE,' ')
    !end-if   
! FROM PS_GPCH_TX_VILLAGE PBC
FROM PS_POSTAL_CD_CHE PBC
! WHERE PBC.GPCH_TX_CANTON='GE' 
WHERE PBC.STATE='GE' 
! AND LOWER(DESCR) = $MunDescr
AND LOWER(DESCR1) = $MunDescr
end-select 

If $IsData <> 'True'
   !if #Formalix_Flag<>1
        let $CompanyErrorFlag = '1'
        let $FormalixError = 'Error:Invalid canton '||$MunDescr||' for GE'
   !else
       !let $FormalixError = 'Error:'||rtrim($Emplid_Q,' ')||' has Invalid City of residence '||$MunDescr||' for GE'
          
   !end-if
      let $ErrorFlag='1' 
   
   write 12 from $FormalixError
   
end-if   

#Debug Show '<- Get_Muncipality_CodeFormalix '
End-Procedure Get_Muncipality_CodeFormalix
!*******************************************************************************************
Begin-Procedure Get_Canton_Tariff_Formalix
#Debug Show '-> Get_Canton_Tariff_Formalix '
      
  let $Tariff_CDN =  substr($Tariff_CDQ,1,2)   

   evaluate $Tariff_CDN 

   when = 'A0'
    let $Bareme = '1'
   break
  when = 'B0'
    let $Bareme = '2'
   break
   when = 'B1'
    let $Bareme = '3'
   break
   when = 'B2'
    let $Bareme = '4'
   break
   when = 'B3'
    let $Bareme = '5'
   break
   when = 'B4'
    let $Bareme = '6'
   break
   when = 'B5'
    let $Bareme = '7'
   break
   when = 'A1'
    let $Bareme = '50'
   break
   when = 'A2'
    let $Bareme = '51'
   break
      when = 'A3'
    let $Bareme = '52'

   break
   when = 'A4'
    let $Bareme = '53'
   break
      when = 'A5'
    let $Bareme = '54'
   break
   when = 'C0'
    let $Bareme = '55'

   break
   when = 'C1'
    let $Bareme = '56'
   break
   when = 'C2'
    let $Bareme = '57'
   break
   when = 'C3'
    let $Bareme = '58'
   break
   when = 'C4'
    let $Bareme = '59'
   break
   when = 'C5'
    let $Bareme = '60'
   break
   when = 'H1'
    let $Bareme = '61'
   break 
   when = 'H2'
    let $Bareme = '62'
   break
   when = 'H3'
    let $Bareme = '63'
   break
   when = 'H4'
    let $Bareme = '64'
   break
   when = 'H5'
    let $Bareme = '65'
   break
   when-other
   let $ErrorFlag=1
   let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' Tariff '||$Bareme||' is Invalid for GE'
   write 12 from $FormalixError
   
   break
  end-evaluate
     
#Debug Show '<- Get_Canton_Tariff_Formalix '
End-Procedure Get_Canton_Tariff_Formalix
!*******************************************************************************************
Begin-Procedure Get_Child_Data_GE ! Procedure to get the Birthdates for the youngest five Children whose age is  of the employee
#Debug Show '-> Get_Child_Data_GE '
 let #Counter = 0



begin-select
CA1.BIRTHDATE

  let $Child_Birth_DT_GE  = &CA1.BIRTHDATE
  let $Emplid_Q_Formalix = ltrim(rtrim($Emplid_Q,' '),' ')
   let $Date1 = $B_DTQ
   let #diff=datediff($Date1, &CA1.BIRTHDATE,'year')
   
  
  do ConvertToComponents($Child_Birth_DT_GE  ,$ChildBdtyy,$ChildBdtmm,$ChildBdtdd)
  let $ChildBDate = $ChildBdtyy ||'-'||$ChildBdtmm ||'-'||$ChildBdtdd 
  
  If  #diff < 25 
  if(#Counter < 5)

         put $Child_Name_GE            into ChildData_GE(#Counter)ChildName
         put $ChildBdtyy               into ChildData_GE(#Counter)ChildBDt
    
        let #Counter= #Counter + 1
  else
     let #Counter= #Counter + 1 
  end-if
  End-If
  
FROM PS_GPCH_CA_DAT_VW CA1
 where CA1.EMPLID   = $Emplid_Q
 and ( CA1.DT_OF_DEATH is NULL  or CA1.DT_OF_DEATH > $Ctl_End_Dt )
 and CA1.EFFDT = (select max(CA11.EFFDT) from PS_GPCH_CA_DAT_VW CA11
                                  WHERE CA11.EMPLID     = CA1.EMPLID
                                  AND   CA11.EMPL_RCD   = CA1.EMPL_RCD
                                  AND   CA11.DEPENDENT_BENEF = CA1.DEPENDENT_BENEF
                                  AND   CA11.EFFDT <= $B_DTQ)

ORDER BY  CA1.BIRTHDATE Desc
end-select

#Debug Show '<- Get_Child_Data_GE '
End-Procedure Get_Child_Data_GE

!*******************************************************************************************

Begin-Procedure Get_Code_Activite_GE($Rep_Addr4,:$CodeAct)
#Debug Show '-> Get_Code_Activite_GE '
 let $Activite=$Rep_Addr4
 lowercase $Activite
 evaluate $Activite
   when = 'agriculture'
    let $CodeAct = '11'
   break
   when = 'levage'
    let $CodeAct = '11'
   break
   when = 'pche'
    let $CodeAct = '11'
   break
   when = 'autres'
    let $CodeAct = '12'
   break
   when = 'industries_manufacturieres'
    let $CodeAct = '21'
   break
   when = 'autres_industries'
    let $CodeAct = '22'
   break
   when = 'construction'
    let $CodeAct = '23'
   break
   when = 'commerce_reparation'
    let $CodeAct = '31'
   break
   when = 'hotellerie_et_restauration'
    let $CodeAct = '32'
   break
   when = 'transports_communications'
    let $CodeAct = '33'
   break
   when = 'financieres_assurances'
    let $CodeAct = '34'
   break
   when = 'immobilier__services'
    let $CodeAct = '35'
   break
   when = 'sante'
    let $CodeAct = '36'
   break
   when = 'autres_services'
    let $CodeAct = '37'
   break
   when-other
   let $FormalixError = 'Error:Code_Activite '||$Activite||' is invalid'
   write 12 from $FormalixError
   let $CompanyErrorFlag = '1'
   break
   end-evaluate

#Debug Show '<- Get_Code_Activite_GE '
End-Procedure Get_Code_Activite_GE
!*******************************************************************************************
Begin-Procedure Formalix_Validation
#Debug Show '-> Formalix_Validation '

     !Employer Validations    
           let #pos1= instr($Rep_Addr1,' ',0)
           if (#pos1 = 0)
              let $Employer_Rue_GE = rtrim(substr($Rep_Addr1,1,length($Rep_Addr1)),' ')
               
              let $Employer_No_GE  = ''
           else
           
             do Formalix_Sreet_Conversion($Rep_Addr1,$StreetName,$StreetNumber)
              
             let $Employer_Rue_GE = $StreetName
             let $Employer_No_GE  = $StreetNumber
           end-if
          

         
     !Validation For Employer. No CSV Will be Generated if the Employers details are Wrong
     
     if $Employer_StaxNr_GE = '' or $CodeAct= '' or $Rep_Descr = '' or $Employer_Rue_GE = '' or $Cant_Muncipality = '' or $Postal1='' or $Ctl_Year = '' or $Issued_Date1=''
           let $CompanyErrorFlag = '1'
           let $FormalixError = 'Error:Some Company Details are missing. Please rectify the company data '
              write 12 from $FormalixError

     end-if
     
     !Employee Validations
      ! Validation if AVS No of Employee if Empty  
           if $N_IdT ='' and $NNSS_IdT = ''
              let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' has no AVS Number'
              write 12 from $FormalixError
              let $ErrorFlag = '1'
           end-if     
   
      
       let #pos2= instr($ADDLINE2,' ',0)
           if (#pos2 = 0)
              let $Employee_Rue_GE = rtrim(substr($ADDLINE2,1,length($ADDLINE2)),' ')
              let $Employee_No_GE  = ''
           else
              do Formalix_Sreet_Conversion($ADDLINE2,$EmpStreetName,$EmpStreetNumber)
              let $Employee_Rue_GE = $EmpStreetName
              let $Employee_No_GE  = $EmpStreetNumber
           end-if
           
           
           if $Employee_Rue_GE = ''
              let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' has Street value empty in Home Address'
              write 12 from $FormalixError    
              let $ErrorFlag =1
                
           end-if
           
            !Validations if the Necessary variables are empty.
     if $LastName='' or $FirstName='' or $Birth_DTQ1=' '
     
         let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' has value for Name or Birth Date empty'
              write 12 from $FormalixError
              let $ErrorFlag = '1'
      
     end-if
     
     if $NPA = ''
       let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' has Postal code empty in Home Address'
              write 12 from $FormalixError
              let $ErrorFlag = '1'
      
     end-if
     
     if $Pays_Canton = ''
       let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' Home address does not have Canton Specified'
              write 12 from $FormalixError
              let $ErrorFlag = '1'
     end-if
      
     if $AQ_Begin_Date1= '' or $AQ_End_Date1 ='' or $Amount21Q_1_FORLX = ''
              let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' has invalid Tax Liability'
              write 12 from $FormalixError
              let $ErrorFlag = '1'
     end-if
     
     
     
#Debug Show '<- Formalix_Validation '
End-Procedure Formalix_Validation
!*******************************************************************************************
Begin-Procedure Formalix_Sreet_Conversion ($StreetAddress,:$StreetName,:$StreetNumber)
#Debug Show '-> Formalix_Sreet_Conversion '
!input : #pos1: Position where the first space occurred
!        $StreetAddress: The Ful Street address as provided by tools
!output: $StreetName: The Seperated street Name.
!        $StreetNumber: The seperated street Number. 

let $StreetNumber=''
let $Loop_flag='0'
let #LengthOfStr=length($StreetAddress)-1
let $StreetNumFlag = '0'
let $Checkstring =''
   
  while ($Checkstring<>' ')
             
              Extract $Checkstring from $StreetAddress #LengthOfStr 1
              let #LengthOfStr1 = #LengthOfStr -1
              Extract $Checkstring1 from $StreetAddress #LengthOfStr1 1 
              
              if($Checkstring = '0' or $Checkstring = '1' or $Checkstring = '2' or $Checkstring = '3' or $Checkstring = '4'
                 or $Checkstring = '5' or $Checkstring = '6' or $Checkstring = '7' or $Checkstring = '8' or $Checkstring = '9')
                 let $StreetNumFlag = '1'
                
              end-if
              let $StreetNumber = $CheckString ||$StreetNumber 
              let #LengthOfStr = #LengthOfStr - 1
  end-while
           
 if $StreetNumFlag='1'
      let #LengthOfStr = #LengthOfStr + 1
      Extract $StreetName from $StreetAddress 0 #LengthOfStr
      let $StreetNumber = ltrim(rtrim($StreetNumber,' '),' ')
 else
     
      let $StreetName = $StreetAddress
      let $StreetNumber = ''
 end-if     


#Debug Show '<- Formalix_Sreet_Conversion '
End-Procedure Formalix_Sreet_Conversion
!*******************************************************************************************
Begin-Procedure Formalix_Conversions
#Debug Show '-> Formalix_Conversions '
  

 let $Country_2CHAR_CD =''
 let $DomicileLocalite = ''
 let $DomicileCanton =''
 
If #RecordCount = 0
   let #Formalix_Flag=0 !This Flag is set to 0 if the company City conversion is Needed

   !Coverting the Employers address to Localite
  do Get_Muncipality_CodeFormalix
end-if
          
! Value Conversion for Sex
    if $Sex_GE = 'M'
           let $Sex_Value_GE= '1'   
    else
       if $Sex_GE = 'F'
           let $Sex_Value_GE='2'
       else 
           let $Sex_Value_GE='' !Incase the Sex of the Employee is set to Unknown     
           let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' does not have Sex specified'
              write 12 from $FormalixError
              let $ErrorFlag = '1'
       end-if
   end-if    

  ! Conversion for Concubinage 
       
   let $MarConcubinage_GE = '2'
   if $Mar_Stat_Formalix_GE ='1' and $MarStat_Common_Law = '1'
         let $MarConcubinage_GE = '1'
        
   end-if

 
  !Break up of the Spouse Name

   let #pos2     = instr($SPOUSE_NAMEQ ,',',0)
           if rtrim($SPOUSE_NAMEQ,' ') <> ''
              let $SpouseLastName_GE = rtrim(substr($SPOUSE_NAMEQ,1,#pos2 -1),' ')
              let $SpouseFirstName_GE  =ltrim(substr($SPOUSE_NAMEQ,#pos2+1,length($SPOUSE_NAMEQ)),' ')
              
           else
               let $SpouseLastName_GE = ''
              let $SpouseFirstName_GE  = ''
           end-if

           
  !Get Child data
  do Get_Child_Data_GE
 
  get $Child1BDt  from ChildData_GE(0)ChildBDt
  get $Child2BDt  from ChildData_GE(1)ChildBDt
  get $Child3BDt  from ChildData_GE(2)ChildBDt
  get $Child4BDt  from ChildData_GE(3)ChildBDt
  get $Child5BDt  from ChildData_GE(4)ChildBDt        
  
  !FMB 20070129 Child Allowance Amounts For Formalix as of CH_TX_CAGE_YTD
     
  
  
  !FMB 20081128
  let $DomicileLocalite = $City 

  !Conversion for Pays_Canton
  if $COUNTRY_GE  = 'CHE'
      let $Pays_Canton =$State
      let $Localite2 = ''
      !******************Code for Xml ******************
         if $Pays_Canton ='GE'
              let $DomicileLocalite = $City
              let $DomicileCanton =''
         else 
              let $DomicileLocalite = $City
              let $DomicileCanton =$State
         end-if
      !******************Code for Xml ******************
      
  else
      let $Localite2 = $City
      if $Localite2 = ''
          let $FormalixError =  'Error:'||rtrim($Emplid_Q,' ')||' has City field empty in Home address'
              write 12 from $FormalixError 
              let $ErrorFlag = '1'
      end-if
      if $COUNTRY_GE = 'FRA'
         let $Pays_Canton = 'FRA'
         
      else
         let $Pays_Canton = 'AUTRES'
      end-if
     
!******************Code for Xml ******************
    if $GPCH_EG_YEP_FLG ='Y'
       do Get_2Char_Country_Code
    end-if
!******************Code for Xml ******************
      
  end-if
 
  !Conversion for Localite
  
  let #VillageCode = to_number($Village_CD)
  let #Village_L = to_number($Village_LQ)
  let #PostalLoc= to_number($Postal_GE)

  
  if $Pays_Canton = 'GE'
       let #Formalix_Flag=1 !This Flag is set to 1 if the Employee Residence City conversion is Needed
   !Coverting the Employees City to Localite
       !do Get_Muncipality_CodeFormalix
        if (#VillageCode < 6600 or #VillageCode > 6645)
        
             let $FormalixError = 'Error:'||rtrim($Emplid_Q,' ')||' has City of Residence as '||$Village_CD||' which is not a valid City '
             write 12 from $FormalixError
             let $ErrorFlag = '1'
             
         else 
         let $Localite_Emp = substr ($Village_CD, 3,2)
         
       end-if
  
  else   
    let $Localite_Emp ='0'
  end-if      
  
  

  if (#Village_L < 6600 or #Village_L > 6645)
        let $FormalixError = 'Error:'||rtrim($Emplid_Q,' ')||' has Location of Occupation as '||$Village_LQ||' which is not a valid City '
        write 12 from $FormalixError
        let $ErrorFlag = '1'
  end-if
  
  !Get Employe Tariffs 
  do Get_Canton_Tariff_Formalix

  !Amount Conversions
 let $Amount21Q_1_FORLX= ltrim(rtrim($Amount21Q_1_FORLX,' '),' ')
 let $Amount14Q_1_FORLX= ltrim(rtrim($Amount14Q_1_FORLX,' '),' ')
 let $Amount15Q_1_FORLX= ltrim(rtrim($Amount15Q_1_FORLX,' '),' ')
 let $Tariff_CDQ_1_FORLX= ltrim(rtrim($Tariff_CDQ_1_FORLX,' '),' ') 
 let $Amount1Q_1_FORLX= ltrim(rtrim($Amount1Q_1_FORLX,' '),' ')
 let $Amount24Q_2_FORLX= ltrim(rtrim($Amount24Q_2_FORLX,' '),' ')
 let $Amount25Q_2_FORLX= ltrim(rtrim($Amount25Q_2_FORLX,' '),' ')
 let $Amount3Q_1_FORLX= ltrim(rtrim($Amount3Q_1_FORLX,' '),' ')
 let $Amount7Q_1_FORLX= ltrim(rtrim($Amount7Q_1_FORLX,' '),' ')
 let $Amount8Q_1_FORLX= ltrim(rtrim($Amount8Q_1_FORLX,' '),' ')
 
 #Debug Show '$Postal before reset for GE = ' $Postal
 Let $Postal = RTRIM(LTRIM($Postal,' '),' ')
 Let #Postal_LEN = length($Postal)
 If  #Postal_LEN > 4
   let #pos1  = instr($Postal,'-',1)
   If #pos1 > 1 and #pos1 < 5 
    let $Postal = substr($Postal,#pos1+1,#Postal_LEN-#pos1)
   End-If
 End-If

#Debug Show '$Postal after reset for GE = ' $Postal

#Debug Show '$Postal after reset for GE = ' $Postal

 let $NPA = $Postal

  #Debug Show '<- Formalix_Conversions '
End-Procedure Formalix_Conversions
!********************************************************************************************
Begin-Procedure Write-CSV-File
#Debug Show '-> Write-CSV-File '
 
     do FORMALIX-Record
     add 1 to #RecordCount  
      

#Debug Show '<- Write-CSV-File '
End-Procedure Write-CSV-File
!********************************************************************************************
begin-procedure FORMALIX-Record
   
   let $ErrorFlag = '0'
 
 ! Write Header
     do Get_Code_Activite_GE($Rep_Addr4,$CodeAct)
        
     do Formalix_Conversions
     do Formalix_Validation
     
     if $CompanyErrorFlag = '1' 
         goto EndFormalix 
         
     end-if  
     
     
     
If #RecordCount = 0
 let $X1 = 'Attestation_quittance.jar;01.04.2000;15.12.2005'
write 10 from $X1
! write Header for Company Data
 let $X2A = 'common/employeur/employ/no_identification;common/employeur/employ/code_act;common/employeur/employ/nom;common/adrsse_empl/adresse_employeur/rue;'
 let $X2B = 'common/adrsse_empl/adresse_employeur/no;common/adrsse_empl/adresse_employeur/CP;common/adrsse_empl/adresse_employeur/NPA;common/adrsse_empl/adresse_employeur/canton;'
 let $X2C = 'common/adrsse_empl/adresse_employeur/localiteemp;common/adrsse_empl/adresse_employeur/localite2;common/assuj_employ/assujetissement_employeur/annee;'
 let $X2D = 'common/assuj_employ/assujetissement_employeur/debut;common/assuj_employ/assujetissement_employeur/fin;common/assuj_employ/assujetissement_employeur/remise'
 let $X2 = $X2A || $X2B || $X2C || $X2D
write 10 from $X2
 
! write Company Data
  let $X3A = $Employer_StaxNr_GE || ';'||$CodeAct||';'||$Rep_Descr||';'||$Employer_Rue_GE||';'||$Employer_No_GE||';'||$PostBox||';'||$Postal1||';'
  let $X3B = 'GE'||';'||substr ($Cant_Muncipality,3,2)||';'||$Rep_Addr3||';'||$Ctl_Year||';'||'01.01.'|| $Ctl_Year||';'||'31.12.'|| $Ctl_Year||';'||$Issued_Date1
   
   let $X3 =$X3A || $X3B



write 10 from $X3

  

! write Company Employee Header
 let $X4A = 'contribuable/contrib/numero_avs;contribuable/contrib/nom;contribuable/contrib/prenom;contribuable/contrib/date_naissance;contribuable/contrib/sexe;contribuable/contrib/etat_civil;'
 let $X4B = 'contribuable/contrib/concubinage;contribuable/contrib/confession;contribuable/contrib/trouver_no_avs;famille/conjoint/nom;famille/conjoint/prenom;'
 let $X4C = 'famille/conjoint/travaille_suisse;famille/enfants/nb_enf;famille/enfants/naissance1;famille/enfants/naissance2;famille/enfants/naissance3;famille/enfants/naissance4;famille/enfants/naissance5;'
 let $X4D = 'domicile/adresse_domicile/rue;domicile/adresse_domicile/no;domicile/adresse_domicile/CP;domicile/adresse_domicile/NPA;domicile/adresse_domicile/pays_canton;'
 let $X4E = 'domicile/adresse_domicile/localite;domicile/adresse_domicile/localite2;activite_prof/type_travail/type_contribuable;activite_prof/type_travail/cat_prof;activite_prof/lieu_travail/localite;'
 let $X4F = 'assujetissement/periode/du;assujetissement/periode/au;assujetissement/assujet/nb_travail;assujetissement/assujet/nb_abs;assujetissement/assujet/taux;'
 let $X4G = 'assujetissement/assujet/bareme;retenue/prestations/soumises_impots;retenue/prestations/en_capital;retenue/prestations/allocations;retenue/prestations/frais;retenue/retenues/impots_retenus;'
 let $X4H = 'retenue/retenues/cont_eccl;retenue/retenues/retenue_tot'

 let $X4 = $X4A || $X4B || $X4C || $X4D || $X4E || $X4F || $X4G || $X4H
write 10 from $X4
end-if
   
     if $ErrorFlag ='1'   ! If the employee has an error Dont generate an Entry for that employee
        let $FormalixError = 'Error: No data populated in the CSV file for '||rtrim($Emplid_Q,' ')|| ' .Please rectify the errors for the employee.'
        write 12 from $FormalixError
        goto EndFormalix    
     end-if  
 
! write Employee Data
 let $X5A = $N_IdT || ';'||$LastName || ';'||$FirstName || ';'||$Birth_DTQ1|| ';'||$Sex_Value_GE|| ';'||$Mar_Stat_Formalix_GE||';'||$MarConcubinage_GE||';'||'0'||';'||';'||$SpouseLastName_GE||';'||$SpouseFirstName_GE||';'
 let $X5B = $SPOUSE_WLQ_GE||';'||$ChildCount|| ';'|| $Child1BDt ||';'||$Child2BDt ||';'|| $Child3BDt ||';'||$Child4BDt ||';'||$Child5BDt || ';'||$Employee_Rue_GE||';'||$Employee_No_GE|| ';'||$PostBox_GE||';'
 let $X5C = $NPA||';'||$Pays_Canton||';'||$Localite_Emp||';'|| $Localite2||';'||'1'||';'||'08'||';'||substr ($Village_LQ,3,2)||';'||$AQ_Begin_Date1||';'||$AQ_End_Date1||';'||$Amount21Q_1_FORLX||';'
 let $X5D = $Amount14Q_1_FORLX||';'||$Amount15Q_1_FORLX||';'||$Bareme||';'||$Amount1Q_1_FORLX||';'||$Amount24Q_2_FORLX||';'||$Amount25Q_2_FORLX||';'||$Amount3Q_1_FORLX||';'||$Amount7Q_1_FORLX||';'||$Amount8Q_1_FORLX
 let $X5 = $X5A || $X5B || $X5C || $X5D
 write 10 from $X5
 
 EndFormalix:

end-procedure
!*******************************************************************************************
Begin-Procedure Get_Spouse_Name($Empl_SP,$Sp_End_Dt,:$SPOUSE_NAME)
#Debug Show '-> Get_Spouse_Name '

let $SPOUSE_NAME = ''

begin-select  
B.NAME

 let $SPOUSE_NAME = &B.NAME
   
 FROM  PS_DEP_BEN_EFF A, PS_DEP_BEN_NAME B
  where A.EMPLID = $Empl_SP
    and A.RELATIONSHIP = 'SP'
    and A.EMPLID = B.EMPLID
    and A.DEPENDENT_BENEF = B.DEPENDENT_BENEF
    and A.EFFDT = ( select max(A1.EFFDT) from PS_DEP_BEN_EFF A1 
    where A.EMPLID = A1.EMPLID 
    and A.DEPENDENT_BENEF = A1.DEPENDENT_BENEF
    and A.EFFDT = A1.EFFDT
    and  A1.EFFDT <= $Sp_End_Dt  )

end-select

#Debug Show '<- Get_Spouse_Name '
End-Procedure Get_Spouse_Name 
!*******************************************************************************************


Begin-procedure Get_English_Strings($ReportID)
#Debug show 'Get_English_Strings -> '  $ReportID

evaluate $ReportID
          when = 'GPCHTX01'
               do Get_Eng_GPCHTX01
               break
          when = 'GPCHTX02'
               do Get_Eng_GPCHTX02
               break
          when = 'GPCHGLOB'
               do Get_Eng_GPCHGLOB
               break
          when = 'ALL'
               do Get_Eng_GPCHTX01
               do Get_Eng_GPCHTX02
               do Get_Eng_GPCHGLOB
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_English_Strings <- ' #_str_cnt
End-procedure Get_English_Strings
!****************************************************************************
Begin-procedure Get_German_Strings($ReportID)
#Debug show 'Get_German_Strings -> '  $ReportID

evaluate $ReportID
          when = 'GPCHTX01'
               do Get_Ger_GPCHTX01
               break
          when = 'GPCHTX02'
               do Get_Ger_GPCHTX02
               break
          when = 'GPCHGLOB'
               do Get_Ger_GPCHGLOB
               break
          when = 'ALL'
               do Get_Ger_GPCHTX01
               do Get_Ger_GPCHTX02
               do Get_Ger_GPCHGLOB
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_German_Strings <- ' #_str_cnt
End-procedure Get_German_Strings
!****************************************************************************
Begin-procedure Get_Italian_Strings($ReportID)
#Debug show 'Get_Italian_Strings -> '  $ReportID

 evaluate $ReportID
          when = 'GPCHTX01'
               do Get_Ita_GPCHTX01
               break
          when = 'GPCHTX02'
               do Get_Ita_GPCHTX02
               break
          when = 'GPCHGLOB'
               do Get_Ita_GPCHGLOB
               break
          when = 'ALL'
               do Get_Ita_GPCHTX01
               do Get_Ita_GPCHTX02
               do Get_Ita_GPCHGLOB
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_Italian_Strings <- ' #_str_cnt
End-procedure Get_Italian_Strings
!****************************************************************************
Begin-procedure Get_French_Strings($ReportID)
#Debug show 'Get_French_Strings -> '  $ReportID

evaluate $ReportID
          when = 'GPCHTX01'
               do Get_Fra_GPCHTX01
               break
          when = 'GPCHTX02'
               do Get_Fra_GPCHTX02
               break
          when = 'GPCHGLOB'
               do Get_Fra_GPCHGLOB
               break
          when = 'ALL'
               do Get_Fra_GPCHTX01
               do Get_Fra_GPCHTX02
               do Get_Fra_GPCHGLOB
               break
          when-other
               break
 end-evaluate

#Debug show 'Get_French_Strings <- ' #_str_cnt
End-procedure Get_French_Strings
!********************************************************************************
#include 'gpchut01.sqc'
#include 'gpchut02.sqc'
#include 'gpchut04.sqc'    ! get company informations
#include 'gpchut06.sqc'    ! get run control parameter values
#include 'gpchut07.sqc'    ! get log
#include 'gpchut11.sqc'    ! get Tax and Fak Values
#include 'gpchtx01.sqc'
#include 'curdttim.sqc'    ! get-current-datetime procedure
#include 'readxlat.sqc'    ! read-translate-table procedure
#include 'datetime.sqc'    ! routines for date and time formatting
#include 'validdt.sqc'     ! validate date routine
#include 'number.sqc'      ! routines to format numbers
#include 'stdapi.sqc'      ! routines to update run status
#include 'datemath.sqc'    ! function for date-calculation
#include 'sqrtrans.sqc'    ! sqr strings table procedures
#include 'gpchtx1s.sqc'    ! Get Strings Values for GPCHTX01
#include 'gpchtx2s.sqc'    ! Get Strings Values for GPCHTX02
#include 'gpchglbs.sqc'    ! Get Strings Values for GPCHGLOB